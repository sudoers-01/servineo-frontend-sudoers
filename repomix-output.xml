This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.github/workflows/lint.yml
.gitignore
.prettierignore
.prettierrc.json
components.json
eslint.config.mjs
LICENSE
messages/en.json
messages/es.json
next.config.ts
package.json
postcss.config.js
postcss.config.mjs
public/Albañileria.png
public/Calefaccion.png
public/Carpinteria.webp
public/Domotica.png
public/Electricistas.webp
public/en/Albañileria.png
public/en/Calefaccion.png
public/en/Carpinteria.webp
public/en/Cerrajeria.png
public/en/Domotica.png
public/en/Electricistas.webp
public/en/fallback-image.svg
public/en/file.svg
public/en/Fumigacion.png
public/en/herrami.jpg
public/en/marker-icon-2x.png
public/en/marker-icon.png
public/en/marker-shadow.png
public/en/Mecanica.png
public/en/Mudanzas.png
public/en/next.svg
public/en/Paneles Solares.png
public/en/Picsina.png
public/en/Pintura.webp
public/en/Plomeria.webp
public/en/Refrigeracion.png
public/en/reparadores.jpg
public/en/serviceStyles.ts
public/en/Soldadura.png
public/en/Tapiceria.png
public/en/Techos y Cubiertas.png
public/en/vercel.svg
public/en/videos/img/icon.png
public/en/videos/SERVINEO_TUTORIAL.mp4
public/en/Vidrieria.png
public/es/Albañileria.png
public/es/Calefaccion.png
public/es/Carpinteria.webp
public/es/Cerrajeria.png
public/es/Domotica.png
public/es/Electricistas.webp
public/es/fallback-image.svg
public/es/file.svg
public/es/fixerPremi.jpg
public/es/Fumigacion.png
public/es/herrami.jpg
public/es/imagen1.jpg
public/es/imagen2.jpg
public/es/img/advSearch.jpg
public/es/img/banner1.jpg
public/es/img/banner2.jpg
public/es/img/banner3.jpg
public/es/img/banner4.jpg
public/es/img/carpinteria.png
public/es/img/carpinteria1.jpg
public/es/img/carpinteria2.jpg
public/es/img/carpinteria3.jpg
public/es/img/electricista.png
public/es/img/icon.png
public/es/img/imgHowUseServineo/comunicacion.png
public/es/img/imgHowUseServineo/consejosFiltros.png
public/es/img/imgHowUseServineo/contacta.jpg
public/es/img/imgHowUseServineo/contrata.jpg
public/es/img/imgHowUseServineo/coordinar.jpg
public/es/img/imgHowUseServineo/navegarYBuscar.jpg
public/es/img/imgHowUseServineo/reseñas.png
public/es/img/limpieza.png
public/es/img/pintura.png
public/es/img/plomeria.png
public/es/img/whatsapplogoblanco.jpg
public/es/img/wst.png
public/es/reparadores.jpg
public/es/videos/SERVINEO_TUTORIAL.mp4
public/fallback-image.svg
public/file.svg
public/Fumigacion.png
public/Gasfiteria.png
public/globe.svg
public/icons/cuentas.png
public/icons/edit-config.png
public/icons/edit-pass.png
public/icons/logins.png
public/icons/marcador-de-posicion.png
public/icons/seguridad-config.png
public/imagen3.jpg
public/img/advSearch.jpg
public/img/carpinteria1.jpg
public/img/carpinteria2.jpg
public/img/carpinteria3.jpg
public/Impermeablilizacion.png
public/Instalacion CCTV.png
public/Jardineria.png
public/Lavado de alfombras.png
public/Limpieza.webp
public/window.svg
README.md
servineo-.code-workspace
src/app/[locale]/adminStatistic/ConditionalTopMenu.tsx
src/app/[locale]/adminStatistic/page.tsx
src/app/[locale]/adv-search/page.tsx
src/app/[locale]/ask-for-help/centro_de_ayuda/page.tsx
src/app/[locale]/ask-for-help/foro-usuario/[id]/page.tsx
src/app/[locale]/ask-for-help/foro-usuario/page.tsx
src/app/[locale]/ask-for-help/preguntas-frecuentes/page.tsx
src/app/[locale]/become-fixer/page.tsx
src/app/[locale]/calendar/page.tsx
src/app/[locale]/calendario.tsx
src/app/[locale]/completed-jobs/JobsGrid.tsx
src/app/[locale]/completed-jobs/page.tsx
src/app/[locale]/fixer-ratings-details/[fixerId]/components.tsx
src/app/[locale]/fixer-ratings-details/[fixerId]/loading.tsx
src/app/[locale]/fixer-ratings-details/[fixerId]/page.tsx
src/app/[locale]/fixer-ratings-details/[fixerId]/utils.ts
src/app/[locale]/fixer-ratings-details/layout.tsx
src/app/[locale]/fixer-ratings-details/theme.css
src/app/[locale]/fixer/[id]/FixerProfileContent.tsx
src/app/[locale]/fixer/[id]/page.tsx
src/app/[locale]/fixer/dashboard/page.tsx
src/app/[locale]/fixers/[id]/appointments/page.tsx
src/app/[locale]/fixers/[id]/comments/page.tsx
src/app/[locale]/fixers/[id]/jobs/page.tsx
src/app/[locale]/fixers/page.tsx
src/app/[locale]/howUseServineo/page.tsx
src/app/[locale]/info/about/page.tsx
src/app/[locale]/info/cookies/page.tsx
src/app/[locale]/info/join/page.tsx
src/app/[locale]/info/privacy/page.tsx
src/app/[locale]/info/reparador/page.tsx
src/app/[locale]/info/support/page.tsx
src/app/[locale]/info/terms/page.tsx
src/app/[locale]/info/testimonials/page.tsx
src/app/[locale]/job-offer-list/layout.tsx
src/app/[locale]/job-offer-list/page.tsx
src/app/[locale]/job-request/ModalFormMap/JobRequestForm.tsx
src/app/[locale]/job-request/ModalFormMap/JobRequestModal.tsx
src/app/[locale]/job-request/ModalFormMap/MapJobRequest.tsx
src/app/[locale]/job-request/page.tsx
src/app/[locale]/layout.tsx
src/app/[locale]/login/forgotpass/page.tsx
src/app/[locale]/login/forgotpass/resend/page.tsx
src/app/[locale]/login/forgotpass/verify/page.tsx
src/app/[locale]/login/page.tsx
src/app/[locale]/page.tsx
src/app/[locale]/payment/centro-de-pagos/page.tsx
src/app/[locale]/payment/components/AddCardModal.tsx
src/app/[locale]/payment/components/BackButton.tsx
src/app/[locale]/payment/components/CardList.tsx
src/app/[locale]/payment/components/PaymentDemoAdaptado.tsx
src/app/[locale]/payment/components/PaymentMethodCashFixer.tsx
src/app/[locale]/payment/components/PaymentMethodUI.tsx
src/app/[locale]/payment/cuenta-bancaria/CuentaBancariaClient.tsx
src/app/[locale]/payment/cuenta-bancaria/page.tsx
src/app/[locale]/payment/detalleFactura/[invoiceId]/page.tsx
src/app/[locale]/payment/facturas/page.tsx
src/app/[locale]/payment/FixerWallet/page.tsx
src/app/[locale]/payment/FixerWallet/recarga/AddCardModalFiver.tsx
src/app/[locale]/payment/FixerWallet/recarga/CardListFixer.tsx
src/app/[locale]/payment/FixerWallet/recarga/page.tsx
src/app/[locale]/payment/FixerWallet/recarga/RechargePageClient.tsx
src/app/[locale]/payment/FixerWallet/recarga/TransferBank.tsx
src/app/[locale]/payment/historial/page.tsx
src/app/[locale]/payment/pago-qr/page.tsx
src/app/[locale]/payment/Pagos-Fisico/page.tsx
src/app/[locale]/payment/qrwallet/page.tsx
src/app/[locale]/payment/qrwallet/QRPageClient.tsx
src/app/[locale]/payment/service/payment.ts
src/app/[locale]/payment/trabajos/LoadingFallback.tsx
src/app/[locale]/payment/trabajos/page.tsx
src/app/[locale]/payment/trabajos/TrabajosList.tsx
src/app/[locale]/por-que-servineo/page.tsx
src/app/[locale]/profile/[id]/components.tsx
src/app/[locale]/profile/[id]/fixer-profile.tsx
src/app/[locale]/profile/[id]/hooks/useProfile.ts
src/app/[locale]/profile/[id]/modal-window.tsx
src/app/[locale]/profile/[id]/page.tsx
src/app/[locale]/profile/[id]/theme.css
src/app/[locale]/profile/[id]/utils.ts
src/app/[locale]/promotions/[jobId]/page.tsx
src/app/[locale]/providers.tsx
src/app/[locale]/requested-jobs/[id]/page.tsx
src/app/[locale]/requesterEdit/buttonCS.tsx
src/app/[locale]/requesterEdit/cardCS.tsx
src/app/[locale]/requesterEdit/closeSession/page.tsx
src/app/[locale]/requesterEdit/dispositivosVinculados/dispositivosVinculados.tsx
src/app/[locale]/requesterEdit/layout.tsx
src/app/[locale]/requesterEdit/linkAccounts/page.tsx
src/app/[locale]/requesterEdit/linkAccounts/vinculoCuenta/vincularCorreo.tsx
src/app/[locale]/requesterEdit/linkAccounts/vinculoCuenta/vincularDiscord.tsx
src/app/[locale]/requesterEdit/linkAccounts/vinculoCuenta/vincularGithub.tsx
src/app/[locale]/requesterEdit/linkAccounts/vinculoCuenta/vincularGoogle.tsx
src/app/[locale]/requesterEdit/page.tsx
src/app/[locale]/requesterEdit/perfil/page.tsx
src/app/[locale]/requesterEdit/Seguridad/Authenticator/page.tsx
src/app/[locale]/requesterEdit/Seguridad/page.tsx
src/app/[locale]/requesters/page.tsx
src/app/[locale]/resultsAdvSearch/page.tsx
src/app/[locale]/servicios/[slug]/page.tsx
src/app/[locale]/servicios/data.ts
src/app/[locale]/servicios/page.tsx
src/app/[locale]/signUp/layout.tsx
src/app/[locale]/signUp/page.tsx
src/app/[locale]/signUp/registrar/Registrardecoder/generadorContrasena.ts
src/app/[locale]/signUp/registrar/Registrardecoder/getID.ts
src/app/[locale]/signUp/registrar/registrarFoto/page.tsx
src/app/[locale]/signUp/registrar/registrarTelefono/page.tsx
src/app/[locale]/signUp/registrar/registrarUbicacion/page.tsx
src/app/[locale]/signUp/registrar/registroServicios/page.tsx
src/app/[locale]/signUp/registrar/registroServicios/registroGoogle.tsx
src/app/[locale]/signUp/registrar/registroUbicacion/page.tsx
src/app/[locale]/signUp/registrar/telefono/page.tsx
src/app/[locale]/signUp/registrar/Terminosycondiciones/page.tsx
src/app/[locale]/sudoers/layout.tsx
src/app/[locale]/sudoers/page.tsx
src/app/[locale]/test/availabilityTestpage.tsx
src/app/[locale]/test/cancelTestpage.tsx
src/app/[locale]/test/page.tsx
src/app/[locale]/tests/page.tsx
src/app/[locale]/tracking-appointments/page.tsx
src/app/[locale]/user-admin/components/adminDashboard.tsx
src/app/[locale]/user-admin/components/adminLogin.tsx
src/app/[locale]/user-admin/components/chartsSection.tsx
src/app/[locale]/user-admin/components/metricCards.tsx
src/app/[locale]/user-admin/dashboard/page.tsx
src/app/[locale]/user-admin/lib/api.ts
src/app/[locale]/user-admin/lib/mockAuth.ts
src/app/[locale]/user-admin/page.tsx
src/app/[locale]/user-admin/styles/admin.module.css
src/app/[locale]/view-rate-jobs/page.tsx
src/app/[locale]/view-rate-jobs/utils.ts
src/app/components/fixers/ActivateOfferModal.tsx
src/app/components/fixers/AppointmentCard.tsx
src/app/components/fixers/AppointmentsList.tsx
src/app/components/fixers/CreatePromoModal.tsx
src/app/components/fixers/DetailsModal.tsx
src/app/components/fixers/JobsList.tsx
src/app/components/fixers/RegisterJobModal.tsx
src/app/components/fixers/RequestedJob.tsx
src/app/components/hooks/useComments.ts
src/app/components/hooks/useRegisterJob.ts
src/app/components/NotificationSystem.tsx
src/app/components/RateJobButton.jsx
src/app/components/RateJobModal.jsx
src/app/favicon.ico
src/app/fonts.ts
src/app/globals.css
src/app/lib/constants/sortOptions.ts
src/app/lib/contact-utils.ts
src/app/lib/hooks/useDevices.tsx
src/app/lib/hooks/usoAutentificacion.tsx
src/app/lib/job-description.ts
src/app/lib/mock-data.ts
src/app/lib/service/fixer-service.ts
src/app/lib/service/RegistrarDatosPersonalesconecionBackend.ts
src/app/lib/session.ts
src/app/lib/utils.ts
src/app/lib/utils/contexts/AppointmentsContext/AppoinmentsContext.tsx
src/app/lib/utils/contexts/DayliViewRequesterContext.tsx
src/app/lib/utils/contexts/UserRoleContext.tsx
src/app/lib/utils/distance.ts
src/app/lib/utils/getAppointmentsByDate.ts
src/app/lib/utils/getAppointmentsByHour.ts
src/app/lib/utils/getAppointmentsDisable.ts
src/app/lib/utils/getSchedulesCont.ts
src/app/lib/utils/getSixMonthAppointments.ts
src/app/lib/utils/translate/dictionary.ts
src/app/lib/utils/useDailyConts.ts
src/app/lib/utils/utilsDevices.ts
src/app/lib/validations/filter.validator.ts
src/app/lib/validations/fixer-schemas.ts
src/app/lib/validations/Job-offer-Schemas.ts
src/app/lib/validations/pagination.validator.ts
src/app/lib/validations/search.validator.ts
src/app/Mapa/FixerMaker.tsx
src/app/Mapa/LocationButton.tsx
src/app/Mapa/Map.tsx
src/app/Mapa/MapCircle.tsx
src/app/Mapa/MapEvents.tsx
src/app/Mapa/NoResults.tsx
src/app/Mapa/RecenterMap.tsx
src/app/Mapa/ResetMapButton.tsx
src/app/Mapa/serviceStyles.ts
src/app/Mapa/UserMaker.tsx
src/app/por-que-servineo/page.tsx
src/app/providers.tsx
src/app/redux/contants/dbValues.ts
src/app/redux/contants/index.ts
src/app/redux/contants/translations.ts
src/app/redux/features/adv-search/useAdvSearchLogic.ts
src/app/redux/features/adv-search/useSyncUrlParams.ts
src/app/redux/features/jobOffers/jobOffersHooks.ts
src/app/redux/features/jobOffers/navigation.ts
src/app/redux/features/jobOffers/parsers.ts
src/app/redux/features/jobOffers/selectors.ts
src/app/redux/features/jobOffers/session.ts
src/app/redux/features/jobOffers/storage.ts
src/app/redux/features/jobOffers/types.ts
src/app/redux/features/jobOffers/useImageCarousel.ts
src/app/redux/features/searchHistory/useSearchHistory.ts
src/app/redux/features/searchHistory/useSearchKeyboard.ts
src/app/redux/features/searchHistory/useSearchSuggestions.ts
src/app/redux/features/searchHistory/useSearchTouch.ts
src/app/redux/hooks.ts
src/app/redux/ReduxProvider.tsx
src/app/redux/services/activityApi.ts
src/app/redux/services/api.ts
src/app/redux/services/apiConfig.ts
src/app/redux/services/auth/registro.ts
src/app/redux/services/auth/registroDatos.ts
src/app/redux/services/baseApi.ts
src/app/redux/services/become.ts
src/app/redux/services/certifications.ts
src/app/redux/services/dashboardApi.ts
src/app/redux/services/editNumber.ts
src/app/redux/services/editPassword.ts
src/app/redux/services/experiencesApi.ts
src/app/redux/services/fixerApi.ts
src/app/redux/services/getLastChange.ts
src/app/redux/services/jobApi.ts
src/app/redux/services/jobOfferApi.ts
src/app/redux/services/jobOffersApi.ts
src/app/redux/services/loginApi.ts
src/app/redux/services/logoutService.ts
src/app/redux/services/portafolioApi.ts
src/app/redux/services/searchApi.ts
src/app/redux/services/searchHistoryApi.ts
src/app/redux/services/services/api.ts
src/app/redux/services/services/RegistrarDPconecionBackend.tsx
src/app/redux/services/services/registro.ts
src/app/redux/services/statisticsApi.ts
src/app/redux/services/trackingAppointmentsApi.ts
src/app/redux/services/twofactor.ts
src/app/redux/services/userApi.ts
src/app/redux/slice/filterSlice.ts
src/app/redux/slice/fixersByJobSlice.ts
src/app/redux/slice/fixerSlice.ts
src/app/redux/slice/jobOfert.ts
src/app/redux/slice/jobOffersSlice.ts
src/app/redux/slice/userSlice.ts
src/app/redux/store.ts
src/Components/Adv-search/ButtonAplicarBus.tsx
src/Components/Adv-search/ButtonLimpiarDatos.tsx
src/Components/Adv-search/CalendarComponent.tsx
src/Components/Adv-search/CalificacionEstrella.tsx
src/Components/Adv-search/ClearButton.tsx
src/Components/Adv-search/DateFilterSelector.tsx
src/Components/Adv-search/DropdownList.tsx
src/Components/Adv-search/HelpButton.tsx
src/Components/Adv-search/PriceRangeList.tsx
src/Components/Adv-search/ResultsCounter.tsx
src/Components/Adv-search/SearchCheckboxes.tsx
src/Components/appointments/forms/AppointmentDetails.tsx
src/Components/appointments/forms/AppointmentForm.tsx
src/Components/appointments/forms/AppointmentSummaryModal.tsx
src/Components/appointments/forms/CancelDaysAppointment.tsx
src/Components/appointments/forms/DayAvailabilityModal.tsx
src/Components/appointments/forms/DaySelectionModal.tsx
src/Components/appointments/forms/EditAppointmentForm.tsx
src/Components/appointments/forms/EditAppointmentLocation.tsx
src/Components/appointments/forms/LocationModal.tsx
src/Components/appointments/forms/ModeSelectionModal.tsx
src/Components/appointments/forms/modules/AvailabilityActions.tsx
src/Components/appointments/forms/modules/AvailabilityButton.tsx
src/Components/appointments/forms/modules/AvailabilityHeader.tsx
src/Components/appointments/forms/modules/CircularDayButton.tsx
src/Components/appointments/forms/modules/ClientSection.tsx
src/Components/appointments/forms/modules/DateTimeDisplaySection.tsx
src/Components/appointments/forms/modules/DateTimeSection.tsx
src/Components/appointments/forms/modules/DaySelectSection.tsx
src/Components/appointments/forms/modules/DescriptionSection.tsx
src/Components/appointments/forms/modules/EditAppointmentActions.tsx
src/Components/appointments/forms/modules/EditAppointmentHeader.tsx
src/Components/appointments/forms/modules/LocationSection.tsx
src/Components/appointments/forms/modules/MeetingLinkSection.tsx
src/Components/appointments/forms/modules/ModeSelectionActions.tsx
src/Components/appointments/forms/modules/SelectHourSection.tsx
src/Components/appointments/forms/modules/WeekDaysSection.tsx
src/Components/appointments/forms/popups/AlertPopup.tsx
src/Components/appointments/forms/popups/JustificationPopup.tsx
src/Components/appointments/forms/RescheduleForm.tsx
src/Components/appointments/forms/WeekAvailabilityModal.tsx
src/Components/ask_for_help/boton_whatsapp.tsx
src/Components/ask_for_help/contenedor.tsx
src/Components/ask_for_help/ErrorMessage.tsx
src/Components/ask_for_help/faq.service.ts
src/Components/ask_for_help/faq.types.ts
src/Components/ask_for_help/FAQCategoryFilter.tsx
src/Components/ask_for_help/FAQItem.tsx
src/Components/ask_for_help/FAQList.tsx
src/Components/ask_for_help/FAQSearch.tsx
src/Components/ask_for_help/forum.service.ts
src/Components/ask_for_help/forum.types.ts
src/Components/ask_for_help/FORUMCategoryFilter.tsx
src/Components/ask_for_help/FORUMCommentForm.tsx
src/Components/ask_for_help/FORUMCommetsList.tsx
src/Components/ask_for_help/FORUMCreateForm.tsx
src/Components/ask_for_help/FORUMSearch.tsx
src/Components/ask_for_help/FORUMThreadDetail.tsx
src/Components/ask_for_help/FORUMThreadList.tsx
src/Components/ask_for_help/useFAQ.ts
src/Components/atoms/button.tsx
src/Components/atoms/displayfield.tsx
src/Components/atoms/inputs.tsx
src/Components/atoms/select.tsx
src/Components/atoms/textArea.tsx
src/Components/calendar/day/.gitkeep
src/Components/calendar/day/DesktopDailyHours.tsx
src/Components/calendar/day/DesktopDailyView.tsx
src/Components/calendar/day/HourCell/HourCell.tsx
src/Components/calendar/DesktopCalendar.tsx
src/Components/calendar/Header/HeaderDesktop.tsx
src/Components/calendar/Header/HeaderSection.tsx
src/Components/calendar/mobile/.gitkeep
src/Components/calendar/mobile/DayCell/DayCell.tsx
src/Components/calendar/mobile/MobileCalendar.tsx
src/Components/calendar/mobile/MobileDayliView.tsx
src/Components/calendar/mobile/MobileHeader.tsx
src/Components/calendar/mobile/MobileMonthView.tsx
src/Components/calendar/mobile/MobileWeekView.tsx
src/Components/calendar/month/.gitkeep
src/Components/calendar/month/dateCell/DateCell.tsx
src/Components/calendar/month/DesktopMonthView/DesktopMonthView.tsx
src/Components/calendar/ui/ButtonCalendar.tsx
src/Components/calendar/ui/dialog.tsx
src/Components/calendar/ui/Hours.tsx
src/Components/calendar/week/.gitkeep
src/Components/calendar/week/DesktopWeekView.tsx
src/Components/Card.tsx
src/Components/Common/Accordion.tsx
src/Components/Common/Button.tsx
src/Components/Common/Input.tsx
src/Components/Common/Label.tsx
src/Components/Common/StatCard.tsx
src/Components/Common/TextHighlighter.ts
src/Components/Contact/Contact-card.tsx
src/Components/Contact/Contact-modal.tsx
src/Components/Contact/Quick-contact.tsx
src/Components/Contact/Whasapp-button.tsx
src/Components/FiltersPanel.tsx
src/Components/Fixer-profile.tsx
src/Components/fixer/dashboard/CertificationsSection.tsx
src/Components/fixer/dashboard/ExperienceSection.tsx
src/Components/fixer/dashboard/JobOffersSection.tsx
src/Components/fixer/dashboard/LocationSection.tsx
src/Components/fixer/dashboard/PortfolioSection.tsx
src/Components/fixer/Filter-eneable-wizard.tsx
src/Components/fixer/Fixer-grafic-card.tsx
src/Components/fixer/Fixer-register-form.tsx
src/Components/fixer/Fixer-statistics.tsx
src/Components/fixer/Pill-button.tsx
src/Components/fixer/Step-indicator.tsx
src/Components/fixer/steps/Ci-step.tsx
src/Components/fixer/steps/Experience-step.tsx
src/Components/fixer/steps/Location-step.tsx
src/Components/fixer/steps/Payment-step.tsx
src/Components/fixer/steps/Profile-photo-step.tsx
src/Components/fixer/steps/Services-step.tsx
src/Components/fixer/steps/Terms-step.tsx
src/Components/fixer/steps/Vehicle-step.tsx
src/Components/FixerCard.tsx
src/Components/Footer.tsx
src/Components/Header.tsx
src/Components/Home/CTA-section.tsx
src/Components/Home/Footer-section.tsx
src/Components/Home/Hero-section.tsx
src/Components/Home/HowItWorks-section.tsx
src/Components/Home/Inspiration-section.tsx
src/Components/Home/Map-section.tsx
src/Components/Home/MapSection.tsx
src/Components/Home/RecentOffer-secction.tsx
src/Components/Home/Searchbar-section.tsx
src/Components/Home/Services-section.tsx
src/Components/HowUseServineo/Accordion.tsx
src/Components/HowUseServineo/CategoriasP.tsx
src/Components/HowUseServineo/Consejos.tsx
src/Components/HowUseServineo/ConsejosCard.tsx
src/Components/HowUseServineo/PasoCards.tsx
src/Components/HowUseServineo/Pasos.tsx
src/Components/HowUseServineo/Title.tsx
src/Components/inspiration-section.tsx
src/Components/interface/Fixer_Interface.ts
src/Components/Job-offers/Filter/FilterButton.tsx
src/Components/Job-offers/Filter/FilterDrawer.tsx
src/Components/Job-offers/index.ts
src/Components/Job-offers/Job-offer-card.tsx
src/Components/Job-offers/Job-offer-form.tsx
src/Components/Job-offers/Job-offer-modal.tsx
src/Components/Job-offers/JobOfferCard.tsx
src/Components/Job-offers/JobOffersView.tsx
src/Components/Job-offers/maps/JobMarker.tsx
src/Components/Job-offers/maps/JobQuickInfo.tsx
src/Components/Job-offers/maps/JobTyleFilter.tsx
src/Components/Job-offers/maps/MapView.tsx
src/Components/Job-offers/Pagination/Paginacion.tsx
src/Components/Job-offers/Pagination/PaginationInfo.tsx
src/Components/Job-offers/Pagination/PaginationSelector.tsx
src/Components/Job-offers/Search/AdvancedSearchButton.tsx
src/Components/Job-offers/Search/ClearButton.tsx
src/Components/Job-offers/Search/InputOnlySearch.tsx
src/Components/Job-offers/Search/NoResultsMessage.tsx
src/Components/Job-offers/Search/SearchBar.tsx
src/Components/Job-offers/Search/SearchButton.tsx
src/Components/Job-offers/Search/SearchIcon.tsx
src/Components/Job-offers/Sort/SortCard.tsx
src/Components/Job-offers/ViewModeToggle.tsx
src/Components/JobFixerSection.tsx
src/Components/list/DatePicker/DatePicker.tsx
src/Components/list/MobileList.tsx
src/Components/login/ClientResend.tsx
src/Components/login/ClientVerify.tsx
src/Components/login/google/layout.tsx
src/Components/login/google/LoginGoogle.tsx
src/Components/login/Proveedores/layout.tsx
src/Components/login/Proveedores/LoginDiscord.tsx
src/Components/login/Proveedores/LoginGitHub.tsx
src/Components/login/Proveedores/LoginGoogle.tsx
src/Components/login/SeleccionMetodoModal.tsx
src/Components/maps/location/MapView.tsx
src/Components/Modal-confirmation.tsx
src/Components/Modal-notifications.tsx
src/Components/Modal.tsx
src/Components/Navigation/TopMenu.tsx
src/Components/payment/BackButton.tsx
src/Components/payment/CentroPagos.tsx
src/Components/payment/EarningsFilterModal.tsx
src/Components/payment/HistoryClient.tsx
src/Components/payment/InvoiceDetail.tsx
src/Components/payment/InvoiceList.tsx
src/Components/payment/PaymentMethodCashFixer.tsx
src/Components/payment/PaymentSuccessModal.tsx
src/Components/payment/PayWithQr.tsx
src/Components/payment/RecentEarningsModal.tsx
src/Components/payment/WalletDashboardClient.tsx
src/Components/Pill-button.tsx
src/Components/requester/auth/usoAutentificacion.tsx
src/Components/requester/Authenticator/AuthenticatorButton.tsx
src/Components/requester/Authenticator/AuthenticatorCodigoModal.tsx
src/Components/requester/Authenticator/AuthenticatorQrModal.tsx
src/Components/requester/Authenticator/AuthenticatorSesionModal.tsx
src/Components/requester/Authenticator/AuthenticatorTOTPModal.tsx
src/Components/requester/Authenticator/ConfirmDisableModal.tsx
src/Components/requester/Authenticator/RecoveryModal.tsx
src/Components/requester/Authenticator/VerifyTokenModal.tsx
src/Components/requester/botonRegistro/buttonDiscord.tsx
src/Components/requester/botonRegistro/buttonGithub.tsx
src/Components/requester/botonRegistro/buttonGoogle.tsx
src/Components/requester/botonRegistro/recaptcha.tsx
src/Components/requester/mapas/Mapa.tsx
src/Components/requester/mapas/MapaLeaflet.tsx
src/Components/requester/profile/UserProfileSummary.tsx
src/Components/requester/request/ChangePasswordForm.tsx
src/Components/requester/request/RequesterEditForm.tsx
src/Components/requester/telefono/RegistroTelefono.tsx
src/Components/ResultsAdvSearch/AppliedFilters.tsx
src/Components/SearchHeader.tsx
src/Components/SearchHighlight.tsx
src/Components/Shared/FilterBar.tsx
src/Components/Shared/ImageCarousel.tsx
src/Components/Shared/Navbar.tsx
src/Components/Shared/SearchBar.tsx
src/Components/Shared/SearchDropdown.tsx
src/Components/Shared/TranslationButton.tsx
src/Components/Statistics-panel/admin-map.tsx
src/Components/Statistics-panel/Chart-bar-Label.tsx
src/Components/Statistics-panel/Chart-pie-donut.tsx
src/Components/Statistics-panel/fixer-stats-table.tsx
src/Components/Statistics-panel/metrics-cards.tsx
src/Components/Tabs/Tabs.tsx
src/Components/Tabs/TabsContent.tsx
src/Components/Tabs/TabsList.tsx
src/Components/Tabs/TabsTrigger.tsx
src/Components/Tour/CustomTourComponents.tsx
src/Components/Tour/TourLogic.tsx
src/Components/Tour/TourProviderWrapper.tsx
src/Components/Tour/TourSteps.tsx
src/Components/ui/button.tsx
src/Components/ui/card.tsx
src/Components/ui/dropdown-menu.tsx
src/Components/ui/input.tsx
src/Components/ui/label.tsx
src/Components/ui/Message.tsx
src/Components/ui/pagination.tsx
src/Components/ui/SearchHighlight.tsx
src/config/api.ts
src/hooks/Appointments/useHourAppointments.ts
src/hooks/Appointments/useSixMonthsAppointments.ts
src/hooks/useAppointmentsDisable.ts
src/hooks/useCalendarNavigation.ts
src/hooks/useCalendarView.ts
src/hooks/useDailyAppointments.ts
src/hooks/useDayUtilities.ts
src/hooks/useFixerData.ts
src/hooks/useFixersByJob.ts
src/hooks/useHourAppointments.ts
src/hooks/useMessage.ts
src/hooks/User/useUserPermissions.ts
src/hooks/useSixMonthsAppointments.ts
src/hooks/useUserPermissions.ts
src/i18n/navigation.ts
src/i18n/request.ts
src/i18n/routing.ts
src/jsons/fixers.json
src/jsons/jobs.json
src/lib/useJobTypeAutoMatch.ts
src/lib/utils.ts
src/middleware.ts
src/services/appointments.ts
src/services/fixerService.ts
src/services/job-info-jobs.ts
src/services/job-info.ts
src/services/job-request.modal.ts
src/services/job-requests.ts
src/services/jobs.ts
src/services/promotions.ts
src/shared/ui/ModalComponent.tsx
src/types/fixer-component.ts
src/types/fixer-profile.ts
src/types/fixer.ts
src/types/job-offer.ts
src/types/job-request.ts
src/types/job.ts
src/types/jobOffers.ts
src/types/jobs.ts
src/types/leaflet.d.ts
src/types/promotion.ts
src/types/user.ts
src/utils/Appointments/getAppointmentsByHour.ts
src/utils/Appointments/getSixMonthAppointments.ts
src/utils/contexts/AppointmentsContext/AppoinmentsContext.tsx
src/utils/contexts/DayliViewRequesterContext.tsx
src/utils/contexts/UserRoleContext.tsx
src/utils/dateHelpers.ts
src/utils/generateSlots.ts
src/utils/getAppointmentsByDate.ts
src/utils/getAppointmentsDisable.ts
src/utils/getSchedulesCont.ts
src/utils/paymentapi.ts
src/utils/types.ts
src/utils/useDailyConts.ts
tailwind.config.js
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".github/workflows/lint.yml">
name: Lint

on:
  push:
    branches:
      - dev
      - main
  pull_request:
    branches:
      - dev
      - main

permissions:
  contents: read

jobs:
  lint:
    name: ESLint & Prettier
    runs-on: ubuntu-latest
    env:
      HUSKY: 0
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Run ESLint
        run: npm run lint

      - name: Run Prettier check
        run: npm run format

      - name: Run Prettier check
        run: npm run format:check
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# Lock files
package-lock.json

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env
.env.local
.env.example

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

.vscode
</file>

<file path=".prettierignore">
/dist
/node_modules
.env
coverage
</file>

<file path=".prettierrc.json">
{
  "semi": true,
  "singleQuote": true,
  "jsxSingleQuote": true,
  "trailingComma": "all",
  "printWidth": 100,
  "tabWidth": 2
}
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "src/app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "iconLibrary": "lucide",
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "registries": {}
}
</file>

<file path="eslint.config.mjs">
import { dirname } from 'path';
import { fileURLToPath } from 'url';
import { FlatCompat } from '@eslint/eslintrc';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  ...compat.extends('next/core-web-vitals', 'next/typescript'),
  {
    ignores: ['node_modules/**', '.next/**', 'out/**', 'build/**', 'next-env.d.ts'],
  },
];

export default eslintConfig;
</file>

<file path="LICENSE">
MIT License

Copyright (c) 2025 Servineo

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</file>

<file path="next.config.ts">
import type { NextConfig } from 'next';
import createNextIntlPlugin from 'next-intl/plugin';
import path from 'path';

const withNextIntl = createNextIntlPlugin('./src/i18n/request.ts');

const nextConfig: NextConfig = {
  // --- INICIO DE LOS CAMBIOS DE EMERGENCIA ---
  eslint: {
    // Ignora warnings y errores de linting para que pase el build
    ignoreDuringBuilds: true,
  },
  typescript: {
    // Ignora errores de tipos para que pase el build
    ignoreBuildErrors: true,
  },
  // --- FIN DE LOS CAMBIOS DE EMERGENCIA ---

  // Ensure Next resolves from this project, not parent directory
  turbopack: {
    root: __dirname,
  },
  outputFileTracingRoot: path.join(__dirname),
  images: {
    unoptimized: true,
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**',
      },
      {
        protocol: 'https',
        hostname: 'drive.google.com',
        pathname: '/**',
      },
      {
        protocol: 'https',
        hostname: 'mi-cdn.com',
        pathname: '/**',
      },
      {
        protocol: 'https',
        hostname: 'picsum.photos',
        pathname: '/**',
      },
      {
        protocol: 'https',
        hostname: 'drive.google.com',
        pathname: '/thumbnail',
      },
      // Google Drive - direct access
      {
        protocol: 'https',
        hostname: 'drive.google.com',
        pathname: '/uc',
      },
      // Google User Content (donde se sirven las imágenes)
      {
        protocol: 'https',
        hostname: 'lh3.googleusercontent.com',
      },
      {
        protocol: 'https',
        hostname: 'lh4.googleusercontent.com',
      },
      {
        protocol: 'https',
        hostname: 'lh5.googleusercontent.com',
      },
      {
        protocol: 'https',
        hostname: 'lh6.googleusercontent.com',
      },
    ],
  },
  eslint: {
    // Warning: This allows production builds to successfully complete even if
    // your project has ESLint errors.
    ignoreDuringBuilds: true,
  },
  /* config options here */
  async rewrites() {
    return [
      {
        source: '/api/:path*',
        destination: 'http://127.0.0.1:8000/api/:path*',
      },
    ];
  },
};

export default withNextIntl(nextConfig);
</file>

<file path="postcss.config.js">
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
};
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: ['@tailwindcss/postcss'],
};

export default config;
</file>

<file path="public/en/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/en/serviceStyles.ts">
// app/busqueda/config/serviceStyles.ts

export interface ServiceStyle {
  color: string; // color del borde del marcador y del texto del popup
  iconUrl: string; // imagen del ícono
}

// Estilos para cada servicio
export const serviceStyles: Record<string, ServiceStyle> = {
  plomería: { color: '#00C851', iconUrl: '/Plomeria.webp' },
  electricidad: { color: '#ffbb33', iconUrl: '/Electricistas.webp' },
  carpintería: { color: '#33b5e5', iconUrl: '/Carpinteria.webp' },
  pintura: { color: '#ff4444', iconUrl: '/Pintura.webp' },
  jardinería: { color: '#2BDDE0', iconUrl: '/Jardineria.png' },
  cerrajería: { color: '#aa66cc', iconUrl: '/Cerrajeria.png' },
  albañilería: { color: '#ff8800', iconUrl: '/Albañileria.png' },
  limpieza: { color: '#00bfa5', iconUrl: '/Limpieza.webp' },
  gasfitería: { color: '#0099cc', iconUrl: '/Gasfiteria.png' },
  otros: { color: '#2B31E0', iconUrl: '/avatar.png' },
};

// Función para obtener estilo de un servicio
export function getServiceStyle(service: string): ServiceStyle {
  return serviceStyles[service.toLowerCase()] || serviceStyles.otros;
}
</file>

<file path="public/en/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/fallback-image.svg">
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800" viewBox="0 0 1200 800" preserveAspectRatio="xMidYMid slice">
  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#1e3a8a"/>
      <stop offset="100%" stop-color="#0ea5e9"/>
    </linearGradient>
  </defs>
  <rect width="1200" height="800" fill="url(#bg)"/>
  <g fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="2">
    <rect x="120" y="140" width="960" height="520" rx="24"/>
    <path d="M160 600 L1040 600"/>
    <circle cx="240" cy="260" r="70"/>
    <path d="M360 540 L520 380 L640 500 L760 420 L940 560"/>
  </g>
  <g font-family="Inter, Arial, sans-serif" text-anchor="middle">
    <text x="600" y="360" font-size="64" fill="#ffffff" font-weight="700">Imagen no disponible</text>
    <text x="600" y="420" font-size="28" fill="rgba(255,255,255,0.9)">Mostrando imagen de respaldo</text>
  </g>
</svg>
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.

## Para obtener los datos del usuario tanto fixer como requester

utilizar el hook useSelector

const { user, loading } = useSelector((state: RootState) => state.user);
user es un usuario requester o fixer

export interface IUser {
\_id?: string;
id?: string;
name: string;
email: string;
url_photo?: string;
role: "requester" | "fixer" | "admin";

    authProviders?: Array<{
        provider: string;
        providerId: string;
        password?: string;
    }>;

    telefono?: string;

    ubicacion?: {
        lat?: number;
        lng?: number;
        direccion?: string;
        departamento?: string;
        pais?: string;
    };

    ci?: string;
    servicios?: string[];

    vehiculo?: {
        hasVehiculo?: boolean;
        tipoVehiculo?: string;
    };

    fixerProfile?: string;
    acceptTerms?: boolean;

    metodoPago?: {
        hasEfectivo?: boolean;
        qr?: boolean;
        tarjetaCredito?: boolean;
    };

    experience?: {
        descripcion?: string;
    };

    workLocation?: {
        lat?: number;
        lng?: number;
        direccion?: string;
        departamento?: string;
        pais?: string;
    };
    description?: string;
    createdAt?: string;
    updatedAt?: string;

}
</file>

<file path="servineo-.code-workspace">
{
  "folders": [
    {
      "path": "../../servineo-back/UserManagment-backend-",
    },
    {
      "path": ".",
    },
  ],
}
</file>

<file path="src/app/[locale]/ask-for-help/foro-usuario/[id]/page.tsx">
'use client';

import { useParams, useRouter } from 'next/navigation';
import React, { useEffect, useState, useCallback } from 'react';
import { getForumWithComments, addCommentToForum } from '@/Components/ask_for_help/forum.service';
import type { ForumWithComments } from '@/Components/ask_for_help/forum.types';
import { FORUMThreadDetail } from '@/Components/ask_for_help/FORUMThreadDetail';
import { FORUMCommentsList } from '@/Components/ask_for_help/FORUMCommetsList';
import { FORUMCommentForm } from '@/Components/ask_for_help/FORUMCommentForm';

export default function ForoDetallePage() {
  const router = useRouter();
  const params = useParams<{ id: string }>();
  const forumId = params.id;

  const [data, setData] = useState<ForumWithComments | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [newComment, setNewComment] = useState('');
  const [posting, setPosting] = useState(false);
  const [postError, setPostError] = useState<string | null>(null);

  const load = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const res = await getForumWithComments(forumId);
      setData(res);
    } catch (err: unknown) {
      let errorMessage = 'Error al cargar la publicación';
      if (err instanceof Error) {
        errorMessage = err.message;
      }
      setError(errorMessage);
    } finally {
      setLoading(false);
    }
  }, [forumId]);

  useEffect(() => {
    if (forumId) load();
  }, [forumId, load]);

  async function handleSend(e: React.FormEvent) {
    e.preventDefault();
    if (!newComment.trim() || !data) return;

    try {
      setPosting(true);
      setPostError(null);
      await addCommentToForum(forumId, newComment);
      setNewComment('');
      await load();
    } catch (err: unknown) {
      let errorMessage = 'Error al enviar el comentario';
      if (err instanceof Error) {
        errorMessage = err.message;
      }
      setPostError(errorMessage);
    } finally {
      setPosting(false);
    }
  }

  if (loading && !data) {
    return <p className='p-8 text-center'>Cargando...</p>;
  }

  if (error && !data) {
    return (
      <div className='p-8 text-center'>
        <p className='text-red-600 mb-4'>{error}</p>
        <button onClick={() => router.back()} className='px-4 py-2 border rounded-md'>
          Volver
        </button>
      </div>
    );
  }

  if (!data) return null;

  const { forum, comments } = data;

  return (
    <div className='min-h-screen bg-gray-50 py-8'>
      <div className='container mx-auto px-4 max-w-4xl'>
        {/* Detalle del hilo */}
        <FORUMThreadDetail forum={forum} onBack={() => router.back()} />

        {/* Comentarios + formulario */}
        <div className='bg-white rounded-xl shadow-lg p-6'>
          <h2 className='font-semibold mb-4'>Comentarios ({comments.length})</h2>

          <FORUMCommentsList comments={comments} />

          <FORUMCommentForm
            value={newComment}
            posting={posting}
            error={postError}
            onChange={setNewComment}
            onSubmit={handleSend}
          />
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/ask-for-help/foro-usuario/page.tsx">
'use client';

import React, { useEffect, useMemo, useState } from 'react';
import { useRouter } from 'next/navigation';
import { listForums, createForum } from '@/Components/ask_for_help/forum.service';
import type { ForumThread, ForumCategoria } from '@/Components/ask_for_help/forum.types';
import { FORUMSearch } from '@/Components/ask_for_help/FORUMSearch';
import {
  FORUMCategoryFilter,
  ForumCategoryFilterValue,
} from '@/Components/ask_for_help/FORUMCategoryFilter';
import { FORUMCreateForm } from '@/Components/ask_for_help/FORUMCreateForm';
import { FORUMThreadList } from '@/Components/ask_for_help/FORUMThreadList';

export default function ForoDeUsuariosPage() {
  const router = useRouter();

  const [query, setQuery] = useState('');
  const [categoriaFiltro, setCategoriaFiltro] = useState<ForumCategoryFilterValue>('todas');
  const [threads, setThreads] = useState<ForumThread[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [showCreateForm, setShowCreateForm] = useState(false);
  const [titulo, setTitulo] = useState('');
  const [descripcion, setDescripcion] = useState('');
  const [categoria, setCategoria] = useState<ForumCategoria | ''>('');
  const [creating, setCreating] = useState(false);
  const [createError, setCreateError] = useState<string | null>(null);

  async function loadForums() {
    try {
      setLoading(true);
      setError(null);
      const data = await listForums();
      setThreads(data);
    } catch (err: unknown) {
      let errorMessage = 'Error al cargar el foro';
      if (err instanceof Error) errorMessage = err.message;
      setError(errorMessage);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    loadForums();
  }, []);

  const filteredThreads = useMemo(() => {
    const q = query.trim().toLowerCase();
    return threads.filter((t) => {
      const coincideTexto =
        !q || t.titulo.toLowerCase().includes(q) || t.descripcion.toLowerCase().includes(q);

      const coincideCategoria = categoriaFiltro === 'todas' || t.categoria === categoriaFiltro;

      return coincideTexto && coincideCategoria;
    });
  }, [threads, query, categoriaFiltro]);

  async function handleCreate(e: React.FormEvent) {
    e.preventDefault();
    if (!titulo.trim() || !descripcion.trim()) {
      setCreateError('Completa el título y la descripción.');
      return;
    }
    if (!categoria) {
      setCreateError('Selecciona una categoría para tu publicación.');
      return;
    }

    try {
      setCreating(true);
      setCreateError(null);
      await createForum({ titulo, descripcion, categoria });
      setShowCreateForm(false);
      setTitulo('');
      setDescripcion('');
      setCategoria('');
      await loadForums();
    } catch (err: unknown) {
      let errorMessage = 'Error al crear la publicación';
      if (err instanceof Error) errorMessage = err.message;
      setCreateError(errorMessage);
    } finally {
      setCreating(false);
    }
  }

  return (
    <div className='min-h-screen bg-gray-50 py-8'>
      <div className='container mx-auto px-4 max-w-5xl'>
        <div className='bg-white rounded-xl shadow-lg p-8 mb-8 relative'>
          <button
            onClick={() => router.back()}
            className='absolute top-6 left-6 text-2xl text-gray-600 hover:text-gray-800 transition'
            aria-label='Volver atrás'
          >
            ←
          </button>

          <h1 className='text-4xl font-bold text-gray-900 mb-3 text-center'>Foro de Usuarios</h1>
          <p className='text-gray-600 text-lg text-center'>
            Comparte tus dudas y ayuda a otros usuarios.
          </p>
        </div>

        <div className='bg-white rounded-xl shadow-lg p-8'>
          {/* barra de búsqueda + filtros + botón crear */}
          <section className='mb-4'>
            <div className='flex flex-col sm:flex-row gap-3 items-stretch'>
              <FORUMSearch query={query} onChange={setQuery} />

              <button
                type='button'
                onClick={() => setShowCreateForm((v) => !v)}
                className='px-4 py-2 border border-blue-600 rounded-md text-sm bg-blue-600 text-white hover:bg-blue-700 transition'
              >
                {showCreateForm ? 'Cerrar formulario' : 'Crear publicación'}
              </button>
            </div>
          </section>

          {/* filtro por categoría tipo FAQ */}
          <FORUMCategoryFilter
            selectedCategory={categoriaFiltro}
            onCategoryChange={setCategoriaFiltro}
          />

          {/* formulario crear publicación */}
          <FORUMCreateForm
            show={showCreateForm}
            titulo={titulo}
            descripcion={descripcion}
            categoria={categoria}
            creating={creating}
            error={createError}
            onChangeTitulo={setTitulo}
            onChangeDescripcion={setDescripcion}
            onChangeCategoria={setCategoria}
            onSubmit={handleCreate}
          />

          <hr className='mb-6' />

          {/* listado */}
          <FORUMThreadList
            threads={filteredThreads}
            loading={loading}
            error={error}
            onOpenThread={(id) => router.push(`/ask-for-help/foro-usuario/${id}`)}
          />
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/calendar/page.tsx">
'use client';

import { useState, useCallback, useEffect, useRef, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { useTranslations } from 'next-intl';

import DesktopCalendar from '@/Components/calendar/DesktopCalendar';
import { UserRoleProvider } from '@/app/lib/utils/contexts/UserRoleContext';
import MobileCalendar from '@/Components/calendar/mobile/MobileCalendar';
import MobileList from '@/Components/list/MobileList';
import ModeSelectionModal from '@/Components/appointments/forms/ModeSelectionModal';
import { ModeSelectionModalHandles } from '@/Components/appointments/forms/ModeSelectionModal';
import CancelDaysAppointments from '@/Components/appointments/forms/CancelDaysAppointment';
import useDailyConts from '@/app/lib/utils/useDailyConts';
import useSixMonthsAppointments from '@/hooks/useSixMonthsAppointments';
import { AppointmentsProvider } from '@/app/lib/utils/contexts/AppointmentsContext/AppoinmentsContext';
import { AppointmentsStatusProvider } from '@/app/lib/utils/contexts/DayliViewRequesterContext';

export default function CalendarPage() {
  const t = useTranslations('CalendarPage');
  const router = useRouter();
  const modeModalRef = useRef<ModeSelectionModalHandles>(null);

  const [fixer_id, setFixerId] = useState<string>('');
  const [requester_id, setRequesterId] = useState<string>('');
  const [isLoading, setIsLoading] = useState(true);
  const [userRole, setUserRole] = useState<'requester' | 'fixer'>('requester');
  const [selectedDate, setSelectedDate] = useState<Date>(new Date());
  const [isCancelModalOpen, setIsCancelModalOpen] = useState(false);

  // Cargar datos de sessionStorage
  useEffect(() => {
    const storedFixerId = sessionStorage.getItem('fixer_id');
    const storedRequesterId = sessionStorage.getItem('requester_id');
    const storedRoleUser = sessionStorage.getItem('roluser');

    if (storedFixerId) {
      setFixerId(storedFixerId);
      setRequesterId(storedRequesterId || '');
      setUserRole(storedRoleUser === 'fixer' ? 'fixer' : 'requester');
      setIsLoading(false);
    } else {
      router.push('/');
    }
  }, [router]);

  const today = useMemo(() => {
    const d = new Date();
    d.setHours(0, 0, 0, 0);
    return d;
  }, []);

  const handleDataChange = (newDate: Date) => {
    setSelectedDate(newDate);
  };

  const switchRole = () => {
    setUserRole((prevRole) => (prevRole === 'requester' ? 'fixer' : 'requester'));
  };

  const handleOpenAvailabilityModal = () => {
    modeModalRef.current?.open();
  };

  const openCancelModal = () => {
    setIsCancelModalOpen(true);
  };

  const closeCancelModal = () => {
    setIsCancelModalOpen(false);
  };

  const {
    isHourBookedFixer,
    isHourBooked,
    isEnabled,
    isCanceled,
    refetch: refetchSixMonths,
    refetchHour,
    loading,
  } = useSixMonthsAppointments(fixer_id, today);

  const { getAppointmentsForDay, refetch: refetchConts } = useDailyConts({ date: today, fixer_id });

  const refetchAll = useCallback(() => {
    refetchSixMonths();
    refetchConts();
  }, [refetchSixMonths, refetchConts]);

  const providerValue = useMemo(
    () => ({
      isHourBookedFixer,
      isHourBooked,
      isEnabled,
      isCanceled,
      getAppointmentsForDay,
      refetchAll,
      refetchHour,
      loading,
    }),
    [
      isHourBookedFixer,
      isHourBooked,
      isEnabled,
      isCanceled,
      refetchAll,
      refetchHour,
      getAppointmentsForDay,
      loading,
    ],
  );

  // Mostrar loading mientras se cargan los datos de sessionStorage
  if (isLoading) {
    return (
      <div className='flex items-center justify-center min-h-screen'>
        <p>{t('loading')}</p>
      </div>
    );
  }

  return (
    <UserRoleProvider role={userRole} fixer_id={fixer_id} requester_id={requester_id}>
      <AppointmentsProvider
        isHourBookedFixer={providerValue.isHourBookedFixer}
        isHourBooked={providerValue.isHourBooked}
        isEnabled={providerValue.isEnabled}
        isCanceled={providerValue.isCanceled}
        getAppointmentsForDay={providerValue.getAppointmentsForDay}
        refetchAll={providerValue.refetchAll}
        refetchHour={providerValue.refetchHour}
        loading={providerValue.loading}
      >
        <AppointmentsStatusProvider
          fixerId={fixer_id}
          requesterId={requester_id}
          selectedDate={selectedDate}
        >
          <div className='flex flex-col bg-white min-h-screen'>
            <div className='flex flex-col md:flex-row md:items-center'>
              <div className='flex items-center'>
                <button
                  onClick={() => router.back()}
                  className='p-2 m-4 text-gray-600 hover:text-black hover:bg-gray-100 transition-colors self-start'
                >
                  <svg
                    xmlns='http://www.w3.org/2000/svg'
                    fill='none'
                    viewBox='0 0 24 24'
                    strokeWidth={1.5}
                    stroke='currentColor'
                    className='w-6 h-6'
                  >
                    <path
                      strokeLinecap='round'
                      strokeLinejoin='round'
                      d='M6 6l12 12M6 18L18 6'
                      strokeWidth={2}
                    />
                  </svg>
                </button>

                {userRole === 'fixer' && (
                  <h2 className='text-black p-4 text-xl text-center flex-1'>
                    {t('titles.myCalendar')}
                  </h2>
                )}
                {userRole === 'requester' && (
                  <h2 className='text-black p-4 text-xl text-center flex-1'>
                    {t('titles.fixerCalendar', { fixerName: 'Juan Carlos Peréz' })}
                  </h2>
                )}
              </div>

              <div className='flex flex-col md:hidden gap-2 px-4 pb-4'>
                {userRole === 'fixer' && (
                  <div className='flex gap-2'>
                    <button
                      className='flex-1 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors text-sm'
                      onClick={handleOpenAvailabilityModal}
                    >
                      {t('buttons.modifyAvailability')}
                    </button>
                    <button
                      className='flex-1 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-colors text-sm'
                      onClick={openCancelModal}
                    >
                      {t('buttons.cancelAppointments')}
                    </button>
                  </div>
                )}
                <button
                  onClick={switchRole}
                  className='w-full bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors cursor-pointer text-sm'
                >
                  {t('buttons.currentView', { role: userRole })}
                </button>
              </div>

              <div className='hidden md:flex md:items-center md:ml-auto md:mr-4 md:gap-4'>
                <button
                  onClick={switchRole}
                  className='bg-green-700 text-white px-6 py-2 rounded hover:bg-green-600 transition-colors cursor-pointer whitespace-nowrap'
                >
                  {t('buttons.currentView', { role: userRole })}
                </button>

                {userRole === 'fixer' && (
                  <div className='flex items-center gap-2'>
                    <button
                      className='bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors whitespace-nowrap'
                      onClick={handleOpenAvailabilityModal}
                    >
                      {t('buttons.modifyAvailability')}
                    </button>
                    <button
                      className='bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-colors whitespace-nowrap'
                      onClick={openCancelModal}
                    >
                      {t('buttons.cancelAppointments')}
                    </button>
                  </div>
                )}
              </div>
            </div>

            <div className='flex justify-center md:block'>
              <DesktopCalendar />
            </div>

            <div className='flex flex-col md:hidden justify-center gap-4'>
              <MobileCalendar selectedDate={selectedDate} onSelectDate={handleDataChange} />
              <div></div>
              <MobileList
                selectedDate={selectedDate}
                fixerId={fixer_id}
                requesterId={requester_id}
                onDateChange={handleDataChange}
              />
            </div>

            <ModeSelectionModal ref={modeModalRef} fixerId={fixer_id} />

            <CancelDaysAppointments
              isOpen={isCancelModalOpen}
              onClose={closeCancelModal}
              fixer_id={fixer_id}
            />
          </div>
        </AppointmentsStatusProvider>
      </AppointmentsProvider>
    </UserRoleProvider>
  );
}
</file>

<file path="src/app/[locale]/calendario.tsx">
'use client';

import Link from 'next/link';
import { useState, useEffect } from 'react';
import { useTranslations } from 'next-intl';

// Array de nombres para selección aleatoria
const availableNames = ['Diego Paredes', 'Franco Lopez'];

export default function Home() {
  const t = useTranslations('Calendar');
  const [randomName, setRandomName] = useState('John Doe');

  useEffect(() => {
    const randomIndex = Math.floor(Math.random() * availableNames.length);
    setRandomName(availableNames[randomIndex]);
  }, []);

  return (
    <div className='min-h-screen bg-white'>
      {/* Header Principal */}
      <div className='border-b border-gray-200 p-4 lg:p-6'>
        <div className='max-w-6xl mx-auto'>
          {/* Contenido del header - siempre visible */}
          <div className='flex items-center space-x-4 mb-4 lg:mb-0'>
            {/* Avatar/Imagen de perfil */}
            <div className='w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center'>
              <span className='text-gray-600 font-medium text-lg'>
                {randomName
                  .split(' ')
                  .map((n) => n[0])
                  .join('')}
              </span>
            </div>
            <div>
              <div className='text-2xl lg:text-3xl font-bold text-gray-800'>{randomName}</div>
              <div className='text-gray-500 text-sm lg:text-base'>({t('fixer')})</div>
            </div>
          </div>

          {/* Botón Ver Calendario - debajo en mobile, al lado en desktop */}
          <div className='lg:absolute lg:top-6 lg:right-6'>
            <Link
              href='/calendar'
              className='block lg:inline-block w-full lg:w-auto text-center bg-gray-800 hover:bg-gray-900 text-white px-6 py-3 rounded-lg font-medium transition-colors'
            >
              {t('viewCalendar')}
            </Link>
          </div>
        </div>
      </div>

      {/* Contenido principal */}
      <div className='p-4 lg:p-8'>
        <div className='max-w-4xl mx-auto'>
          {/* Sección 2.1 Net Admission */}
          <div className='mb-6 lg:mb-8'>
            <h2 className='text-xl lg:text-2xl font-bold text-gray-800 mb-6'>{t('profileInfo')}</h2>

            {/* Experiencia Previa */}
            <div className='bg-white rounded-lg border border-gray-200 p-4 lg:p-6 mb-4'>
              <h3 className='text-lg lg:text-xl font-bold text-gray-800 mb-3'>
                {t('previousExperience')}
              </h3>
              <div className='text-gray-600'>
                <p>{t('experienceDescription')}</p>
              </div>
            </div>

            {/* Reseñas */}
            <div className='bg-white rounded-lg border border-gray-200 p-4 lg:p-6'>
              <h3 className='text-lg lg:text-xl font-bold text-gray-800 mb-3'>{t('reviews')}</h3>
              <div className='text-gray-600'>
                <p>{t('reviewsDescription')}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/completed-jobs/JobsGrid.tsx">
'use client';
import React, { useEffect, useState } from 'react';
import { apiUrl } from '@/config/api';
import RateJobModal from '@/app/components/RateJobModal';

interface Job {
  id: string;
  name: string;
  date: string;
  status: string;
}

const JobsGrid = () => {
  const [jobs, setJobs] = useState<Job[]>([]);
  const [loading, setLoading] = useState(true);
  const [isModalOpen, setIsModalOpen] = useState(false);

  useEffect(() => {
    fetch(apiUrl('api/jobs/completed'))
      .then((res) => res.json())
      .then((data) => {
        setJobs(data);
      })
      .catch((err) => {
        console.error('Error fetching jobs:', err);
      })
      .finally(() => {
        setLoading(false);
      });
  }, []);

  if (loading) {
    return (
      <main className='h-screen flex items-center justify-center text-gray-500 bg-white'>
        Loading completed jobs...
      </main>
    );
  }

  return (
    <div className='flex flex-col items-center justify-center w-full min-h-screen bg-white py-8 px-4'>
      <h1 className='text-3xl font-handwritten text-center mb-8 text-black'>Servineo</h1>

      <div className='border rounded-lg p-3 inline-block mb-6'>
        <span className='italic font-semibold text-lg text-black'>Completed jobs grid</span>
      </div>

      {jobs.length === 0 ? (
        <div className='text-center text-gray-500 italic py-10 border rounded-lg w-full max-w-3xl'>
          No completed jobs found.
        </div>
      ) : (
        <div className='w-full max-w-3xl border rounded-lg p-4 bg-white shadow-inner overflow-y-auto max-h-[70vh] scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent'>
          <div className='flex flex-col gap-4'>
            {jobs.map((job) => (
              <div
                key={job.id}
                className='flex justify-between items-center border rounded-xl p-4 bg-white shadow-sm border-green-500'
              >
                <div className='flex-1 min-w-0'>
                  <p className='italic font-medium text-black truncate'>{job.name}</p>
                  <p className='italic text-sm text-gray-500 mt-1'>Date: {job.date}</p>
                </div>

                <div className='flex-shrink-0 mx-4 text-center'>
                  <p className='text-green-500 font-semibold capitalize'>{job.status}</p>
                </div>

                <div className='flex-shrink-0'>
                  <button
                    onClick={() => setIsModalOpen(true)}
                    className='border rounded-lg px-4 py-2 text-white bg-[#1AA7ED] hover:bg-[#178AC3] transition-colors'
                  >
                    Rate job
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
      <RateJobModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} />
    </div>
  );
};

export default JobsGrid;
</file>

<file path="src/app/[locale]/completed-jobs/page.tsx">
import React from 'react';
import JobsGrid from './JobsGrid';

const Page = () => {
  return (
    <div className='bg-white'>
      <JobsGrid />
    </div>
  );
};

export default Page;
</file>

<file path="src/app/[locale]/fixer-ratings-details/[fixerId]/components.tsx">
'use client';

import { useCallback, useEffect, useState } from 'react';
import { jsonFetcher, type FixerRating } from './utils';
import { apiUrl } from '@/config/api';

function useFixerRatings(fixerId: string, pollInterval: number = 5000) {
  const [ratings, setRatings] = useState<FixerRating[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  const url = fixerId ? apiUrl(`/api/ratings.details/${fixerId}`) : null;

  type RatingResponse = {
    _id: string;
    title?: string;
    rating: 1 | 2 | 3;
    comment?: string;
    createdAt: string;
  };

  const load = useCallback(async () => {
    if (!url) return;
    try {
      const data = await jsonFetcher<RatingResponse[]>(url);
      const mapped = data.map((d) => ({
        id: d._id,
        requester: d.title || 'Unknown',
        score: d.rating as 1 | 2 | 3,
        comment: d.comment || '',
        createdAt: d.createdAt,
      }));
      setRatings(mapped);
      setError(null);
    } catch (err) {
      setError(err as Error);
      setRatings([]);
    } finally {
      setIsLoading(false);
    }
  }, [url]);

  useEffect(() => {
    setIsLoading(true);
    load();
  }, [url, load]);

  useEffect(() => {
    const interval = setInterval(() => {
      load();
    }, pollInterval);

    return () => clearInterval(interval);
  }, [load, pollInterval]);

  return { ratings, isLoading, error, refresh: load };
}

export function StarRating({
  value,
  size = 18,
  srLabel,
}: {
  value: 1 | 2 | 3;
  size?: number;
  srLabel?: string;
}) {
  return (
    <div className='inline-flex gap-1' aria-label={srLabel ?? `${value} of 3 stars`}>
      {Array.from({ length: 3 }).map((_, i) => {
        const filled = i < value;
        return (
          <svg
            key={i}
            width={size}
            height={size}
            viewBox='0 0 24 24'
            role='img'
            aria-hidden='true'
            style={
              filled
                ? { fill: 'var(--highlight)' }
                : { fill: 'transparent', stroke: 'var(--highlight)' }
            }
          >
            <path d='M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z' />
          </svg>
        );
      })}
    </div>
  );
}

export function RatingDetailsList({ ratings, error }: { ratings: FixerRating[]; error?: string }) {
  const [expandedCommentId, setExpandedCommentId] = useState<string | null>(null);
  const [isMobile, setIsMobile] = useState(false);

  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth < 640);
    window.addEventListener('resize', handleResize);
    handleResize();
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  const commentLengthLimit = isMobile ? 100 : 200;
  const toggleComment = (id: string) => setExpandedCommentId((prev) => (prev === id ? null : id));

  if (error) {
    return (
      <div className='p-4 rounded-lg text-sm error-box'>
        ⚠️ Ocurrió un problema al cargar las calificaciones. Inténtalo nuevamente.
      </div>
    );
  }

  if (!ratings?.length) {
    return (
      <div
        className='p-6 text-sm border rounded-lg'
        style={{
          color: 'var(--text-muted)',
          background: 'var(--surface-card)',
          borderColor: 'var(--surface-border)',
        }}
      >
        Este FIXER no tiene calificaciones registradas.
      </div>
    );
  }

  const ordered = [...ratings].sort((a, b) => +new Date(b.createdAt) - +new Date(a.createdAt));

  return (
    <ul className='flex flex-col gap-4'>
      {ordered.map((r) => {
        const isLongComment = r.comment && r.comment.length > commentLengthLimit;
        return (
          <li
            key={r.id}
            className='flex items-start gap-4 p-4 rounded-xl hover:shadow-sm transition-shadow border'
            style={{ borderColor: 'var(--surface-border)', background: 'var(--surface-card)' }}
          >
            <div className='h-10 w-10 shrink-0 rounded-full bg- flex items-center justify-center overflow-hidden'>
              <span className='text-xs'>👤</span>
            </div>

            <div className='flex-1 min-w-0'>
              <div className='flex flex-wrap items-center justify-between gap-2'>
                <p className='font-medium truncate'>{r.requester}</p>
                <StarRating value={r.score} />
              </div>

              <p className='text-xs' style={{ color: 'var(--text-muted)' }}>
                {new Date(r.createdAt).toLocaleDateString()}
              </p>

              <p
                className={`text-sm mt-1 leading-6 ${expandedCommentId === r.id ? '' : 'line-clamp-2'}`}
                style={{ color: 'color-mix(in srgb, var(--foreground) 80%, transparent)' }}
              >
                {r.comment}
              </p>

              {isLongComment && (
                <button
                  className='mt-2 text-xs sm:hidden'
                  style={{ color: 'var(--primary)' }}
                  onClick={() => toggleComment(r.id)}
                  aria-expanded={expandedCommentId === r.id}
                >
                  {expandedCommentId === r.id ? 'See less' : 'See more'}
                </button>
              )}
            </div>
          </li>
        );
      })}
    </ul>
  );
}

export function ClientRatings({ fixerId }: { fixerId: string }) {
  const { ratings, isLoading, error } = useFixerRatings(fixerId);
  if (isLoading) return <div className='p-4 text-sm'>Loading...</div>;
  return <RatingDetailsList ratings={ratings} error={error?.message} />;
}
</file>

<file path="src/app/[locale]/fixer-ratings-details/[fixerId]/loading.tsx">
export default function Loading() {
  return (
    <div className='max-w-3xl mx-auto p-6 space-y-4' aria-busy='true' aria-live='polite'>
      <div className='flex items-center justify-between'>
        <div className='h-7 w-40 rounded-md bg-neutral-100 animate-pulse' />
        <div className='h-8 w-20 rounded-lg bg-neutral-100 animate-pulse' />
      </div>

      <div className='space-y-3'>
        {Array.from({ length: 4 }).map((_, i) => (
          <div
            key={i}
            className='flex items-start gap-4 p-4 rounded-xl border bg-white animate-pulse'
          >
            <div className='h-10 w-10 rounded-full bg-neutral-100' />
            <div className='flex-1 min-w-0 space-y-2'>
              <div className='flex items-center justify-between gap-2'>
                <div className='h-4 w-32 bg-neutral-100 rounded' />
                <div className='h-4 w-16 bg-neutral-100 rounded' />
              </div>
              <div className='h-3 w-24 bg-neutral-100 rounded' />
              <div className='h-4 w-full bg-neutral-100 rounded' />
              <div className='h-4 w-3/4 bg-neutral-100 rounded' />
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/fixer-ratings-details/[fixerId]/page.tsx">
import { mockRatings } from './utils';
import { ClientRatings, RatingDetailsList } from './components';

type Params = { fixerId: string };

export default async function RatingsPage({ params }: { params: Promise<Params> }) {
  const { fixerId } = await params;

  const useBackend = true;
  return (
    <main className='max-w-3xl mx-auto p-6 space-y-4' style={{ color: 'var(--foreground)' }}>
      <header className='flex items-center justify-between'>
        <h1 className='text-2xl font-semibold tracking-tight'>Rating Details</h1>
        <a
          href={`/profile/${fixerId}`}
          className='text-sm px-3 py-1.5 border rounded-lg transition-colors hover:bg-white/60'
          style={{ borderColor: 'var(--surface-border)' }}
          aria-label='Back to profile'
        >
          Back
        </a>
      </header>

      {useBackend ? (
        <ClientRatings fixerId={fixerId} />
      ) : (
        <RatingDetailsList ratings={mockRatings} />
      )}
    </main>
  );
}
</file>

<file path="src/app/[locale]/fixer-ratings-details/[fixerId]/utils.ts">
export type FixerRating = {
  id: string;
  requester: string;
  avatarUrl?: string;
  score: 1 | 2 | 3;
  comment?: string;
  createdAt: string;
};

export const mockRatings: FixerRating[] = [
  {
    id: 'r1',
    requester: 'Pedro Silvestre',
    score: 3,
    comment:
      'Buen trabajo y puntual. Recomiendo su trabajo ademas de lo mencionado es ordenado, limpio y respetuoso.',
    createdAt: '2025-10-07T13:20:00Z',
  },
  {
    id: 'r2',
    requester: 'Jesús Mamani',
    score: 3,
    comment: 'Excelente acabado.',
    createdAt: '2025-10-05T09:10:00Z',
  },
  {
    id: 'r3',
    requester: 'Silvia Cano',
    score: 2,
    comment: 'Cumplió pero tardó un poco.',
    createdAt: '2025-10-03T18:45:00Z',
  },
  {
    id: 'r4',
    requester: 'Álvaro Coca',
    score: 1,
    comment: 'Podría mejorar la limpieza.',
    createdAt: '2025-09-29T11:00:00Z',
  },
  {
    id: 'r5',
    requester: 'Andrea Chávez',
    score: 1,
    comment: 'Podría mejorar la limpieza.',
    createdAt: '2025-10-29T11:00:00Z',
  },
  {
    id: 'r6',
    requester: 'Saul Mamani',
    score: 2,
    comment: 'Podría mejorar la limpieza.',
    createdAt: '2025-11-29T11:00:00Z',
  },
];

export async function jsonFetcher<T = unknown>(input: RequestInfo, init?: RequestInit) {
  const res = await fetch(input, { ...init, cache: 'no-store' });
  if (!res.ok) {
    const text = await res.text();
    throw new Error(`HTTP ${res.status}: ${text}`);
  }
  return (await res.json()) as T;
}
</file>

<file path="src/app/[locale]/fixer-ratings-details/layout.tsx">
import type { ReactNode } from 'react';
import { Roboto } from 'next/font/google';
import './theme.css';

const roboto = Roboto({ subsets: ['latin'], weight: ['400', '500', '700'], display: 'swap' });

export default function FeatureLayout({ children }: { children: ReactNode }) {
  return <section className={roboto.className}>{children}</section>;
}
</file>

<file path="src/app/[locale]/fixer-ratings-details/theme.css">
:root {
  --background: #f9fafb;
  --foreground: #111827;

  --surface-card: #ffffff;
  --surface-border: #d1d5db;
  --text-muted: #64748b;

  --primary-light: #1aa7ed;
  --primary: #2b31e0;
  --primary-medium: #2b6ae0;

  --accent: #2bdde0;
  --accent-hover: #5e2be0;
  --highlight: #fbbf24;

  --success: #16a34a;
  --warning: #f59e0b;
  --error: #ef4444;
}

.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.transition-height {
  transition: max-height 0.3s ease-in-out;
}

.error-box {
  border: 1px solid var(--error);
  color: var(--error);
  background: color-mix(in srgb, var(--error) 10%, transparent);
}
</file>

<file path="src/app/[locale]/fixer/[id]/FixerProfileContent.tsx">
// 'use client';

// import { JobOfferCard } from "@/Components/Job-offers/Job-offer-card"
// import { MapPin, Star, Briefcase, MessageSquare, Share2 } from "lucide-react"
// import { useRouter } from "next/navigation"
// import { useState } from "react"
// import type { Fixer } from "@/app/lib/mock-data"
// import Image from "next/image"
// import FixerGraficCard from "@/Components/fixer/Fixer-grafic-card"

// interface FixerProfileContentProps {
//   fixer: Fixer;
// }

// export function FixerProfileContent({ fixer }: FixerProfileContentProps) {
//   const router = useRouter();
//   const [activeTab, setActiveTab] = useState('inicio');

//   // Función para convertir JobOffer a JobOfferData
//   const convertToJobOfferData = (offer: JobOffer): JobOfferData => {
//     return {
//       _id: offer.id,
//       title: offer.title,
//       description: offer.description,
//       city: offer.city,
//       category: offer.services?.[0] || 'otros',
//       tags: offer.tags || offer.services || [],
//       price: offer.price || 0,
//       photos: offer.photos || [],
//       allImages: offer.photos || [],
//       imagenUrl: offer.photos?.[0] || '',
//       fixerId: offer.fixerId || fixer.id,
//       fixerName: offer.fixerName || fixer.name,
//       fixerPhoto: offer.fixerPhoto || fixer.photo || '',
//       contactPhone: offer.whatsapp || fixer.whatsapp || fixer.phone || '',
//       rating: offer.rating || fixer.rating || 0,
//       completedJobs: offer.completedJobs || fixer.completedJobs || 0,
//       createdAt: offer.createdAt,
//       location: offer.location ? [offer.location.address] : undefined,
//     };
//   };

//   const handleOfferClick = (offer: JobOfferData) => {
//     router.push(`/offers/${offer._id}`);
//   };

//   const handleContact = () => {
//     if (fixer.whatsapp) {
//       window.open(`https://wa.me/${fixer.whatsapp}`, '_blank');
//     }
//   };

//   const renderTabContent = () => {
//     switch (activeTab) {
//       case 'servicios':
//         return renderServicesTab();
//       case 'reseñas':
//         return renderReviewsTab();
//       case 'fotos':
//         return renderPhotosTab();
//       default:
//         return renderHomeTab();
//     }
//   };

//   const renderHomeTab = () => (
//     <div className="space-y-6">
//       {/* About Section */}
//       <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
//         <h2 className="text-xl font-semibold text-gray-900 mb-4">Acerca de</h2>
//         <p className="text-gray-600 mb-6">
//           {fixer.bio || 'Este profesional aún no ha agregado una descripción.'}
//         </p>

//         <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
//           <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
//             <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
//               <Briefcase className="w-5 h-5 text-blue-600" />
//             </div>
//             <div>
//               <p className="text-sm font-medium text-gray-900">Experiencia</p>
//               <p className="text-sm text-gray-600">
//                 {new Date().getFullYear() - new Date(fixer.joinDate).getFullYear()} años
//               </p>
//             </div>
//           </div>
//         </div>
//       </div>

//       {/* Services */}
//       {fixer.services?.length > 0 && (
//         <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
//           <h2 className="text-xl font-semibold text-gray-900 mb-4">Servicios</h2>
//           <div className="flex flex-wrap gap-2">
//             {fixer.services.map((service, index) => (
//               <span
//                 key={index}
//                 className="px-3 py-2 bg-blue-50 text-blue-700 text-sm font-medium rounded-lg"
//               >
//                 {service}
//               </span>
//             ))}
//           </div>
//         </div>
//       )}

//       {/* Recent Jobs */}
//       {fixer.jobOffers?.length > 0 && (
//         <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
//           <div className="flex items-center justify-between mb-4">
//             <h2 className="text-xl font-semibold text-gray-900">Trabajos Recientes</h2>
//             <button
//               onClick={() => setActiveTab('servicios')}
//               className="text-blue-600 text-sm font-medium hover:underline"
//             >
//               Ver todos
//             </button>
//           </div>
//           <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
//             {fixer.jobOffers.slice(0, 2).map((offer) => (
//               <JobOfferCard
//                 key={offer.id}
//                 offer={convertToJobOfferData(offer)}
//                 viewMode="grid"
//                 onClick={handleOfferClick}
//               />
//             ))}
//           </div>
//         </div>
//       )}
//       <div className="mt-1">
//         <div className="bg-white rounded-3xl shadow-lg border border-gray-200/80 p-1">
//           <FixerGraficCard
//             completedJobs={fixer.completedJobs}
//             cancelledJobs={fixer.cancelledJobs ?? 0}
//             monthlyData={fixer.monthlyData}
//           />
//         </div>
//       </div>
//     </div>
//   );

//   const renderServicesTab = () => (
//     <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
//       <h2 className="text-2xl font-semibold text-gray-900 mb-6">Mis Servicios</h2>
//       <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
//         {fixer.services.map((service, index) => (
//           <div
//             key={index}
//             className="p-4 border border-gray-200 rounded-lg hover:shadow-md transition-shadow"
//           >
//             <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-3">
//               <Briefcase className="w-6 h-6 text-blue-600" />
//             </div>
//             <h3 className="text-lg font-semibold text-gray-900 mb-2">{service}</h3>
//             <p className="text-gray-600 text-sm">
//               Servicio profesional especializado en {service.toLowerCase()}.
//             </p>
//           </div>
//         ))}
//       </div>
//     </div>
//   );

//   const renderReviewsTab = () => (
//     <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
//       <div className="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
//         <div>
//           <h2 className="text-2xl font-semibold text-gray-900 mb-2">Reseñas</h2>
//           <div className="flex items-center">
//             <div className="flex items-center bg-amber-50 px-3 py-1 rounded-full mr-4">
//               <Star className="w-5 h-5 text-amber-400 fill-amber-400" />
//               <span className="ml-1 font-medium text-amber-700">
//                 {fixer.rating?.toFixed(1) || 'Nuevo'}
//               </span>
//             </div>
//             <span className="text-gray-600">{fixer.completedJobs || 0} trabajos realizados</span>
//           </div>
//         </div>
//         <button className="mt-4 md:mt-0 px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">
//           Escribir reseña
//         </button>
//       </div>

//       <div className="space-y-4">
//         {[1, 2, 3].map((_, i) => (
//           <div key={i} className="border border-gray-200 rounded-lg p-4">
//             <div className="flex items-center justify-between mb-3">
//               <div className="flex items-center">
//                 <div className="w-10 h-10 rounded-full bg-gray-200 mr-3 flex items-center justify-center">
//                   <span className="font-medium text-gray-600">C{i + 1}</span>
//                 </div>
//                 <div>
//                   <h4 className="font-medium text-gray-900">Cliente Satisfecho {i + 1}</h4>
//                   <div className="flex mt-1">
//                     {[1, 2, 3, 4, 5].map((star) => (
//                       <Star
//                         key={star}
//                         className={`w-4 h-4 ${star <= 5 ? 'text-amber-400 fill-amber-400' : 'text-gray-300'}`}
//                       />
//                     ))}
//                   </div>
//                 </div>
//               </div>
//               <span className="text-sm text-gray-500">
//                 Hace {i + 1} {i === 0 ? 'semana' : 'semanas'}
//               </span>
//             </div>
//             <p className="text-gray-700">
//               Excelente servicio, muy profesional y puntual. El trabajo quedó impecable.
//             </p>
//           </div>
//         ))}
//       </div>
//     </div>
//   );

//   const renderPhotosTab = () => (
//     <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
//       <h2 className="text-2xl font-semibold text-gray-900 mb-6">Galería de Trabajos</h2>

//       {fixer.jobOffers?.some((offer) => offer.photos?.length > 0) ? (
//         <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
//           {fixer.jobOffers.flatMap((offer) =>
//             offer.photos?.map((photo, i) => (
//               <div
//                 key={`${offer.id}-${i}`}
//                 className="aspect-square rounded-lg overflow-hidden group cursor-pointer"
//               >
//                 <Image
//                   src={photo || '/placeholder.svg'}
//                   alt={`Trabajo ${i + 1}`}
//                   width={200}
//                   height={200}
//                   className="w-full h-full object-cover group-hover:scale-105 transition-transform"
//                 />
//               </div>
//             )),
//           )}
//         </div>
//       ) : (
//         <div className="text-center py-12">
//           <div className="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-2xl flex items-center justify-center">
//             <Briefcase className="w-8 h-8 text-gray-400" />
//           </div>
//           <h3 className="text-lg font-medium text-gray-900 mb-2">Aún no hay fotos</h3>
//           <p className="text-gray-600 max-w-md mx-auto">
//             Este profesional aún no ha compartido fotos de sus trabajos.
//           </p>
//         </div>
//       )}
//     </div>
//   );
//   return (
//     <div className="bg-gray-50 min-h-screen">
//       {/* Profile Header */}
//       <div className="bg-gradient-to-r from-blue-600 to-blue-800 pt-16 pb-8 px-4 sm:px-6 lg:px-8">
//         <div className="max-w-4xl mx-auto">
//           <div className="flex flex-col md:flex-row items-start md:items-end gap-6">
//             <div className="relative -mt-16">
//               <div className="w-32 h-32 md:w-36 md:h-36 rounded-2xl border-4 border-white bg-white shadow-lg overflow-hidden">
//                 {fixer.photo ? (
//                   <Image
//                     src={fixer.photo}
//                     alt={fixer.name}
//                     width={144}
//                     height={144}
//                     className="w-full h-full object-cover"
//                   />
//                 ) : (
//                   <div className="w-full h-full bg-blue-100 flex items-center justify-center text-4xl font-bold text-blue-600">
//                     {fixer.name[0].toUpperCase()}
//                   </div>
//                 )}
//               </div>
//             </div>

//             <div className="flex-1 text-white">
//               <h1 className="text-2xl md:text-3xl font-bold mb-2">{fixer.name}</h1>
//               <div className="flex items-center gap-4 mb-4">
//                 <div className="flex items-center">
//                   <MapPin className="w-4 h-4 mr-1" />
//                   <span>{fixer.city}</span>
//                 </div>
//                 <div className="flex items-center">
//                   <Star className="w-4 h-4 text-yellow-400 fill-yellow-400 mr-1" />
//                   <span>{fixer.rating?.toFixed(1) || 'Nuevo'}</span>
//                   <span className="mx-1">•</span>
//                   <span>{fixer.completedJobs || 0} trabajos</span>
//                 </div>
//               </div>
//               <div className="flex gap-3">
//                 <button
//                   onClick={handleContact}
//                   className="flex items-center gap-2 px-6 py-2.5 bg-white text-blue-700 rounded-lg font-medium hover:bg-gray-100 transition-colors"
//                 >
//                   <MessageSquare className="w-5 h-5" />
//                   Contactar
//                 </button>
//                 <button className="p-2.5 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-colors">
//                   <Share2 className="w-5 h-5" />
//                 </button>
//               </div>
//             </div>
//           </div>
//         </div>
//       </div>

//       {/* Main Content */}
//       <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
//         {/* Tabs */}
//         <div className="flex border-b border-gray-200 mb-8">
//           {[
//             { id: 'inicio', label: 'Inicio' },
//             { id: 'servicios', label: 'Servicios' },
//             { id: 'reseñas', label: 'Reseñas' },
//             { id: 'fotos', label: 'Galería' },
//           ].map((tab) => (
//             <button
//               key={tab.id}
//               onClick={() => setActiveTab(tab.id)}
//               className={`px-4 py-3 text-sm font-medium ${
//                 activeTab === tab.id
//                   ? 'text-blue-600 border-b-2 border-blue-600'
//                   : 'text-gray-500 hover:text-gray-700'
//               }`}
//             >
//               {tab.label}
//             </button>
//           ))}
//         </div>

//         {/* Tab Content */}
//         <div>{renderTabContent()}</div>
//       </div>
//     </div>
//   );
// }
</file>

<file path="src/app/[locale]/fixer/[id]/page.tsx">
'use client';

import { useState } from 'react';
import Image from 'next/image';
import { MapPin, Star, MessageCircle, Share2, Flag, User } from 'lucide-react';
import { PillButton } from '@/Components/Pill-button';
import { CertificationsSection } from '@/Components/fixer/dashboard/CertificationsSection';
import { ExperienceSection } from '@/Components/fixer/dashboard/ExperienceSection';
import { PortfolioSection } from '@/Components/fixer/dashboard/PortfolioSection';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/Components/Tabs/Tabs';
import EstadisticasTrabajos from '@/Components/fixer/Fixer-statistics';
import { useParams } from 'next/navigation';
import { JobOffersSection } from '@/Components/fixer/dashboard/JobOffersSection';
import { useGetUserByIdQuery } from '@/app/redux/services/userApi';
import { LocationSection } from '@/Components/fixer/dashboard/LocationSection';

export default function FixerProfilePage() {
  const params = useParams<{ locale: string; id: string }>();

  const fixerId = params?.id;
  const { data: userData } = useGetUserByIdQuery(fixerId); // este sera el usuario que para los detalles de las cards
  console.log('User Data:', userData);
  const [activeTab, setActiveTab] = useState('resumen');

  return (
    <div className='min-h-screen bg-gray-50 pb-12'>
      {/* Profile Header */}
      <div className='bg-white border-b'>
        <div className='container mx-auto px-4 py-8'>
          <div className='flex flex-col md:flex-row gap-6 items-start'>
            {/* Avatar */}
            <div className='relative'>
              <div className='w-32 h-32 rounded-full overflow-hidden ring-4 ring-white shadow-lg bg-gray-200 flex items-center justify-center'>
                {userData ? (
                  <Image
                    src={userData?.url_photo || '/default-avatar.png'}
                    alt={userData?.name || 'Fixer'}
                    width={128}
                    height={128}
                    className='w-full h-full object-cover'
                  />
                ) : (
                  <User className='w-16 h-16 text-gray-400' />
                )}
              </div>
              {userData?.fixerProfile === 'completed' && (
                <div
                  className='absolute bottom-1 right-1 bg-blue-500 text-white p-1.5 rounded-full ring-2 ring-white'
                  title='Perfil Verificado'
                >
                  <Star className='w-4 h-4 fill-current' />
                </div>
              )}
            </div>

            {/* Info */}
            <div className='flex-1'>
              <div className='flex flex-col md:flex-row md:items-center justify-between gap-4'>
                <div>
                  <h1 className='text-3xl font-bold text-gray-900'>
                    {userData?.name || 'Cargando...'}
                  </h1>
                  <p className='text-lg text-gray-600 font-medium'>
                    {userData?.servicios?.join(', ') || 'Servicios Generales'}
                  </p>

                  <div className='flex items-center gap-4 mt-2 text-sm text-gray-500'>
                    <div className='flex items-center gap-1'>
                      <Star className='w-4 h-4 text-amber-400 fill-amber-400' />
                      <span className='font-semibold text-gray-900'>{'N/A'}</span>
                      <span>({'Sin calificaciones aún'})</span>
                    </div>
                    <div className='flex items-center gap-1'>
                      <MapPin className='w-4 h-4' />
                      <span>
                        {userData?.ubicacion?.departamento ||
                          userData?.workLocation?.direccion ||
                          'Bolivia'}
                      </span>
                    </div>
                  </div>

                  {userData?.telefono && (
                    <div className='mt-2 text-sm text-gray-600'>
                      <span className='font-semibold'>Teléfono:</span> {userData.telefono}
                    </div>
                  )}
                </div>

                <div className='flex gap-3'>
                  <PillButton
                    className='bg-primary text-white hover:bg-blue-800 flex items-center gap-2'
                    onClick={() => {
                      if (userData?.telefono) {
                        window.open(
                          `https://wa.me/${userData.telefono.replace(/\s+/g, '')}`,
                          '_blank',
                        );
                      }
                    }}
                  >
                    <MessageCircle className='w-4 h-4' />
                    Contactar
                  </PillButton>
                  <button className='p-2 text-gray-500 hover:bg-gray-100 rounded-full transition-colors'>
                    <Share2 className='w-5 h-5' />
                  </button>
                  <button className='p-2 text-gray-500 hover:bg-gray-100 rounded-full transition-colors'>
                    <Flag className='w-5 h-5' />
                  </button>
                </div>
              </div>

              {userData?.description && (
                <p className='mt-4 text-gray-600 max-w-2xl leading-relaxed'>
                  {userData.description}
                </p>
              )}

              {/* Información adicional */}
              <div className='mt-4 flex flex-wrap gap-4 text-sm'>
                {userData?.vehiculo?.hasVehiculo && (
                  <span className='px-3 py-1 bg-green-100 text-green-700 rounded-full'>
                    🚗 Vehículo propio
                  </span>
                )}
                {userData?.metodoPago?.hasEfectivo && (
                  <span className='px-3 py-1 bg-blue-100 text-blue-700 rounded-full'>
                    💵 Acepta efectivo
                  </span>
                )}
                {userData?.metodoPago?.qr && (
                  <span className='px-3 py-1 bg-purple-100 text-purple-700 rounded-full'>
                    📱 Acepta QR
                  </span>
                )}
                {userData?.metodoPago?.tarjetaCredito && (
                  <span className='px-3 py-1 bg-orange-100 text-orange-700 rounded-full'>
                    💳 Acepta tarjeta
                  </span>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className='container mx-auto px-4 py-8'>
        <Tabs value={activeTab} onValueChange={setActiveTab} className='space-y-6'>
          <TabsList className='bg-white p-1 rounded-xl border shadow-sm inline-flex'>
            <TabsTrigger value='resumen' className='px-6'>
              Resumen
            </TabsTrigger>
            <TabsTrigger value='ofertas' className='px-6'>
              Ofertas
            </TabsTrigger>
            <TabsTrigger value='experiencia' className='px-6'>
              Experiencia
            </TabsTrigger>
            <TabsTrigger value='certificaciones' className='px-6'>
              Certificaciones
            </TabsTrigger>
            <TabsTrigger value='portafolio' className='px-6'>
              Portafolio
            </TabsTrigger>
            <TabsTrigger value='ubicacion' className='px-6'>
              Ubicación
            </TabsTrigger>
            <TabsTrigger value='estadisticas' className='px-6'>
              Estadísticas
            </TabsTrigger>
          </TabsList>

          <TabsContent value='resumen' className='space-y-8'>
            <JobOffersSection effectiveeffectiveUserId={userData?._id as string} readOnly />
          </TabsContent>

          <TabsContent value='ofertas'>
            <JobOffersSection effectiveeffectiveUserId={userData?._id as string} readOnly />
          </TabsContent>

          <TabsContent value='experiencia'>
            <ExperienceSection fixerId={userData?._id as string} readOnly />
          </TabsContent>

          <TabsContent value='certificaciones'>
            <CertificationsSection fixerId={userData?._id as string} readOnly />
          </TabsContent>

          <TabsContent value='portafolio'>
            <PortfolioSection fixerId={userData?._id as string} readOnly />
          </TabsContent>
          <TabsContent value='ubicacion'>
            <LocationSection
              fixerId={userData?._id as string}
              currentLocation={{
                lat: userData?.workLocation?.lat ?? 0,
                lng: userData?.workLocation?.lng ?? 0,
                direccion: userData?.workLocation?.direccion || '',
              }}
              readOnly
            />
          </TabsContent>

          <TabsContent value='estadisticas'>
            <EstadisticasTrabajos />
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/fixer/dashboard/page.tsx">
'use client';

import { useState } from 'react';
import { useAppSelector } from '@/app/redux/hooks';
import { JobOffersSection } from '@/Components/fixer/dashboard/JobOffersSection';
import { CertificationsSection } from '@/Components/fixer/dashboard/CertificationsSection';
import { ExperienceSection } from '@/Components/fixer/dashboard/ExperienceSection';
import { PortfolioSection } from '@/Components/fixer/dashboard/PortfolioSection';
import {
  User,
  Briefcase,
  Award,
  Building2,
  Image as ImageIcon,
  MapPin,
  Phone,
  Mail,
  Edit2,
  Check,
  CreditCard,
  Car,
  IdCard,
  Wrench,
} from 'lucide-react';
import Image from 'next/image';
import { useRouter } from 'next/navigation';

import EstadisticasTrabajos from '@/Components/fixer/Fixer-statistics';
import { useUpdateDescriptionMutation } from '@/app/redux/services/userApi';
import { useEffect } from 'react';
import { z } from 'zod';
import { LocationSection } from '@/Components/fixer/dashboard/LocationSection';

// Schema de validación para la descripción
const descriptionSchema = z.object({
  description: z
    .string()
    .max(255, 'La descripción no puede tener más de 255 caracteres')
    .min(10, 'La descripción debe tener al menos 10 caracteres')
    .optional()
    .or(z.literal('')),
});

type Tab = 'offers' | 'certs' | 'experience' | 'portfolio' | 'location' | 'estadisticas';

export default function FixerDashboardPage() {
  const { user: reduxUser } = useAppSelector((state) => state.user);
  const user = reduxUser;
  const router = useRouter();
  const [activeTab, setActiveTab] = useState<Tab>('offers');

  // Estado para edición de descripción
  const [editingDescription, setEditingDescription] = useState(false);
  const [descriptionValue, setDescriptionValue] = useState('');
  const [descriptionError, setDescriptionError] = useState<string | null>(null);

  useEffect(() => {
    if (user) {
      setDescriptionValue(user?.description || '');
      // Si es la primera vez, forzamos que esté en edición
      if (!user?.description) {
        setEditingDescription(true);
      }
    }
  }, [user]);

  const [updateDescription] = useUpdateDescriptionMutation();

  if (!user) {
    return <div className='p-8 text-center'>Cargando perfil...</div>;
  }

  const handleSaveDescription = async () => {
    try {
      if (!user._id) return;

      // Validar con Zod
      const result = descriptionSchema.safeParse({ description: descriptionValue });

      if (!result.success) {
        // Mostrar el primer error de validación
        const firstError = result.error.issues[0];
        setDescriptionError(firstError.message);
        return;
      }

      // Limpiar error si la validación pasa
      setDescriptionError(null);

      await updateDescription({ id: user._id, description: descriptionValue });

      setEditingDescription(false);
    } catch (err) {
      console.error('Error actualizando descripción:', err);
      setDescriptionError('Error al guardar la descripción');
    }
  };

  // Obtener ubicación
  const location = user.ubicacion?.departamento || user.workLocation?.direccion || 'Bolivia';

  return (
    <div className='container mx-auto max-w-6xl p-4 space-y-6'>
      {/* Profile Header */}
      <div className='bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden'>
        <div className='h-32 bg-gradient-to-r from-blue-600 to-blue-400'></div>
        <div className='px-6 pb-6'>
          <div className='relative flex justify-between items-end -mt-12 mb-4'>
            <div className='relative'>
              <div className='h-24 w-24 rounded-full border-4 border-white bg-gray-200 overflow-hidden'>
                {user.url_photo ? (
                  <Image
                    src={user.url_photo}
                    alt={user.name}
                    fill
                    className='object-cover'
                    priority
                    sizes='96px'
                  />
                ) : (
                  <User className='h-full w-full p-4 text-gray-400' />
                )}
              </div>
              {user.fixerProfile === 'completed' && (
                <div
                  className='absolute bottom-0 right-0 h-6 w-6 bg-green-500 border-2 border-white rounded-full'
                  title='Perfil Completo'
                ></div>
              )}
            </div>
            <div className='flex gap-2'>
              {/* ⭐ NUEVO BOTÓN — AGREGADO EXACTAMENTE AQUÍ ⭐ */}
              <button
                onClick={() => router.push('/es/view-rate-jobs')}
                className='px-4 py-2 bg-primary hover:bg-blue-800 text-white rounded-full text-sm font-medium transition-colors'
              >
                Ver trabajos calificados
              </button>

              {!editingDescription ? (
                <button
                  onClick={() => setEditingDescription(true)}
                  className='px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full text-sm font-medium transition-colors flex items-center gap-1'
                >
                  <Edit2 className='h-4 w-4' />
                  Editar Perfil
                </button>
              ) : (
                <button
                  onClick={handleSaveDescription}
                  className='px-4 py-2 bg-primary hover:bg-blue-800 text-white rounded-full text-sm font-medium transition-colors flex items-center gap-1'
                >
                  <Check className='h-4 w-4' />
                  Guardar
                </button>
              )}
            </div>
          </div>

          <div>
            <h1 className='text-2xl font-bold text-gray-900'>{user.name}</h1>

            {/* Descripción o placeholder */}
            {!editingDescription ? (
              <p className='text-gray-600 font-medium mt-1'>
                {descriptionValue || (
                  <span className='text-gray-400 italic'>
                    Sin descripción. Haz clic en Editar Perfil para agregar una.
                  </span>
                )}
              </p>
            ) : (
              <div>
                <textarea
                  value={descriptionValue}
                  onChange={(e) => {
                    setDescriptionValue(e.target.value);
                    setDescriptionError(null); // Limpiar error al escribir
                  }}
                  placeholder='Describe tu experiencia y servicios...'
                  className={`border ${descriptionError ? 'border-red-500' : 'border-primary'} rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 ${descriptionError ? 'focus:ring-red-400' : 'focus:ring-blue-400'} focus:border-blue-500 w-full mt-2 resize-none`}
                  rows={3}
                  maxLength={255}
                />
                <div className='flex justify-between items-center mt-1'>
                  {descriptionError && <p className='text-red-500 text-xs'>{descriptionError}</p>}
                  <p
                    className={`text-xs ml-auto ${descriptionValue.length > 255 ? 'text-red-500' : 'text-gray-400'}`}
                  >
                    {descriptionValue.length}/255 caracteres
                  </p>
                </div>
              </div>
            )}

            {/* Información de contacto */}
            <div className='mt-4 flex flex-wrap gap-4 text-sm text-gray-600'>
              {user.email && (
                <div className='flex items-center gap-1.5'>
                  <Mail className='h-4 w-4 text-blue-600' />
                  <span>{user.email}</span>
                </div>
              )}
              {user.telefono && (
                <div className='flex items-center gap-1.5'>
                  <Phone className='h-4 w-4 text-blue-600' />
                  <span>{user.telefono}</span>
                </div>
              )}
              <div className='flex items-center gap-1.5'>
                <MapPin className='h-4 w-4 text-blue-600' />
                <span>{location}</span>
              </div>
              {user.ci && (
                <div className='flex items-center gap-1.5'>
                  <IdCard className='h-4 w-4 text-blue-600' />
                  <span>CI: {user.ci}</span>
                </div>
              )}
            </div>

            {/* Servicios */}
            {user.servicios && user.servicios.length > 0 && (
              <div className='mt-4'>
                <div className='flex items-center gap-2 mb-2'>
                  <Wrench className='h-4 w-4 text-blue-600' />
                  <span className='text-sm font-semibold text-gray-700'>Servicios:</span>
                </div>
                <div className='flex flex-wrap gap-2'>
                  {user.servicios.map((servicio, index) => (
                    <span
                      key={index}
                      className='px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-xs font-medium'
                    >
                      {servicio}
                    </span>
                  ))}
                </div>
              </div>
            )}

            {/* Métodos de pago y vehículo */}
            <div className='mt-4 flex flex-wrap gap-3'>
              {user.vehiculo?.hasVehiculo && (
                <span className='flex items-center gap-1.5 px-3 py-1.5 bg-green-50 text-green-700 rounded-full text-xs font-medium'>
                  <Car className='h-3.5 w-3.5' />
                  Vehículo propio
                </span>
              )}
              {user.metodoPago?.hasEfectivo && (
                <span className='flex items-center gap-1.5 px-3 py-1.5 bg-purple-50 text-purple-700 rounded-full text-xs font-medium'>
                  <CreditCard className='h-3.5 w-3.5' />
                  Efectivo
                </span>
              )}
              {user.metodoPago?.qr && (
                <span className='flex items-center gap-1.5 px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-full text-xs font-medium'>
                  <CreditCard className='h-3.5 w-3.5' />
                  QR
                </span>
              )}
              {user.metodoPago?.tarjetaCredito && (
                <span className='flex items-center gap-1.5 px-3 py-1.5 bg-orange-50 text-orange-700 rounded-full text-xs font-medium'>
                  <CreditCard className='h-3.5 w-3.5' />
                  Tarjeta
                </span>
              )}
            </div>
          </div>
        </div>
      </div>

      <div className='grid grid-cols-1 lg:grid-cols-4 gap-6'>
        {/* Sidebar Navigation */}
        <div className='lg:col-span-1 space-y-2'>
          <nav className='flex flex-col gap-1'>
            <button
              onClick={() => setActiveTab('offers')}
              className={`flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all ${
                activeTab === 'offers'
                  ? 'bg-blue-50 text-blue-700 shadow-sm'
                  : 'text-gray-600 hover:bg-gray-50'
              }`}
            >
              <Briefcase className='h-5 w-5' />
              Ofertas de Trabajo
            </button>
            <button
              onClick={() => setActiveTab('certs')}
              className={`flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all ${
                activeTab === 'certs'
                  ? 'bg-blue-50 text-blue-700 shadow-sm'
                  : 'text-gray-600 hover:bg-gray-50'
              }`}
            >
              <Award className='h-5 w-5' />
              Certificaciones
            </button>
            <button
              onClick={() => setActiveTab('experience')}
              className={`flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all ${
                activeTab === 'experience'
                  ? 'bg-blue-50 text-blue-700 shadow-sm'
                  : 'text-gray-600 hover:bg-gray-50'
              }`}
            >
              <Building2 className='h-5 w-5' />
              Experiencia
            </button>
            <button
              onClick={() => setActiveTab('portfolio')}
              className={`flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all ${
                activeTab === 'portfolio'
                  ? 'bg-blue-50 text-blue-700 shadow-sm'
                  : 'text-gray-600 hover:bg-gray-50'
              }`}
            >
              <ImageIcon className='h-5 w-5' />
              Portafolio
            </button>
            <button
              onClick={() => setActiveTab('location')}
              className={`flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all ${
                activeTab === 'location'
                  ? 'bg-blue-50 text-blue-700 shadow-sm'
                  : 'text-gray-600 hover:bg-gray-50'
              }`}
            >
              <MapPin className='h-5 w-5' />
              Ubicación
            </button>
            <button
              onClick={() => setActiveTab('estadisticas')}
              className={`flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all ${
                activeTab === 'estadisticas'
                  ? 'bg-blue-50 text-blue-700 shadow-sm'
                  : 'text-gray-600 hover:bg-gray-50'
              }`}
            >
              <Award className='h-5 w-5' />
              Estadísticas
            </button>
          </nav>
        </div>

        {/* Main Content */}
        <div className='lg:col-span-3'>
          <div className='bg-white rounded-2xl p-6 shadow-sm border border-gray-200 min-h-[500px]'>
            {activeTab === 'offers' && <JobOffersSection />}
            {activeTab === 'certs' && <CertificationsSection fixerId={user._id || user.id} />}
            {activeTab === 'experience' && <ExperienceSection fixerId={user._id || user.id} />}
            {activeTab === 'portfolio' && <PortfolioSection fixerId={user._id || user.id} />}
            {activeTab === 'estadisticas' && <EstadisticasTrabajos />}
            {activeTab === 'location' && (
              <LocationSection
                fixerId={user._id || user.id}
                currentLocation={{
                  lat: user.workLocation?.lat ?? 0,
                  lng: user.workLocation?.lng ?? 0,
                  direccion: user.workLocation?.direccion || '',
                }}
              />
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/fixers/[id]/appointments/page.tsx">
import React from 'react';
import { Roboto } from 'next/font/google';
import { getAppointmentsByFixerId } from '@/services/appointments';
import type { Appointment } from '@/services/appointments';
import AppointmentsList from '@/app/components/fixers/AppointmentsList';

const roboto = Roboto({ subsets: ['latin'], weight: ['400', '500', '700'] });

type PageProps = { params: Promise<{ id: string }> };

export default async function Page({ params }: PageProps) {
  const { id } = await params;
  let appointments: Appointment[] = [];

  try {
    appointments = await getAppointmentsByFixerId(id);
    if (process.env.NODE_ENV !== 'production') {
      console.debug(`[appointments/page] fixer ${id} -> ${appointments.length} appointments`);
    }
  } catch (err) {
    console.error('Failed to load appointments:', err);
  }

  return (
    <div className='min-h-screen bg-white'>
      <div className='mx-auto w-full max-w-5xl p-4 sm:p-6'>
        <h1
          className={`${roboto.className} text-2xl sm:text-3xl font-semibold text-gray-900 mb-4 text-center`}
        >
          Appointments
        </h1>
        <AppointmentsList appointments={appointments} />
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/fixers/[id]/comments/page.tsx">
'use client';

import { useState } from 'react';
import { useParams } from 'next/navigation';
import { useComments } from '@/app/components/hooks/useComments';

type FilterType = 'all' | 'positive' | 'negative';

export default function CommentsPage() {
  const params = useParams();
  const fixerId = params.id as string;
  const [filter, setFilter] = useState<FilterType>('all');
  const { data, loading, error } = useComments(fixerId, filter);

  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('es-ES', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
    });
  };

  const renderStars = (rating: number) => {
    return (
      <div className='flex gap-0.5'>
        {[1, 2, 3].map((star) => (
          <svg
            key={star}
            xmlns='http://www.w3.org/2000/svg'
            width='16'
            height='16'
            viewBox='0 0 24 24'
            fill={star <= rating ? '#FFA500' : 'none'}
            stroke='#FFA500'
            strokeWidth='2'
            strokeLinecap='round'
            strokeLinejoin='round'
          >
            <path d='M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z' />
          </svg>
        ))}
      </div>
    );
  };

  return (
    <div className='min-h-screen bg-gray-50 py-8 px-4'>
      <div className='max-w-4xl mx-auto'>
        <div className='flex justify-between items-center mb-6'>
          <h1 className='text-2xl font-bold text-gray-900'>Jobs Comments</h1>
          <div className='flex gap-2'>
            <button
              onClick={() => (filter === 'positive' ? setFilter('all') : setFilter('positive'))}
              className={`px-4 py-2 rounded-md text-sm font-medium transition-colors cursor-pointer ${
                filter === 'positive'
                  ? 'bg-green-500 text-white'
                  : 'bg-green-100 text-green-700 hover:bg-green-200'
              }`}
            >
              Positive
            </button>
            <button
              onClick={() => (filter === 'negative' ? setFilter('all') : setFilter('negative'))}
              className={`px-4 py-2 rounded-md text-sm font-medium transition-colors cursor-pointer ${
                filter === 'negative'
                  ? 'bg-red-500 text-white'
                  : 'bg-red-100 text-red-700 hover:bg-red-200'
              }`}
            >
              Negative
            </button>
          </div>
        </div>
        <div className='mb-4 flex gap-x-2 flex-row-reverse justify-between align-middle text-black'></div>
        {loading ? (
          <div className='flex justify-center items-center py-12'>
            <svg
              xmlns='http://www.w3.org/2000/svg'
              width='40'
              height='40'
              viewBox='0 0 24 24'
              fill='none'
              stroke='currentColor'
              strokeWidth='2'
              strokeLinecap='round'
              strokeLinejoin='round'
              className='animate-spin text-gray-600'
            >
              <path d='M21 12a9 9 0 1 1-6.219-8.56' />
            </svg>
          </div>
        ) : error ? (
          <div className='bg-red-50 border border-red-200 rounded-lg p-4 text-red-700'>
            Error loading comments: {error}
          </div>
        ) : data.length === 0 ? (
          <div className='bg-white border border-gray-200 rounded-lg p-8 text-center text-gray-500'>
            <p className='text-lg font-medium'>No tiene comentarios</p>
            <p className='text-sm mt-2'>Aún no hay comentarios para este fijador.</p>
          </div>
        ) : (
          <div className='space-y-4'>
            {data.map((comment) => (
              <div
                key={comment._id} // The color can be change here for negative or positive, I knew you would ask xdd
                className={`${filter === 'all' && 'bg-white'} ${filter === 'negative' ? 'bg-red-200' : 'bg-green-100'} border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow`}
              >
                <div className='flex justify-between items-start mb-3'>
                  <div>
                    <h3 className='font-semibold text-gray-900 text-sm'>
                      {comment.requesterName} - {comment.title}
                    </h3>
                    <p className='text-xs text-gray-500 mt-1'>
                      Date: {formatDate(comment.createdAt)}
                    </p>
                  </div>
                  {renderStars(comment.rating)}
                </div>
                <p className='text-sm text-gray-700 leading-relaxed'>{comment.comment}</p>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/fixers/[id]/jobs/page.tsx">
import React from 'react';
import { Roboto } from 'next/font/google';
import { getJobsByFixerId } from '@/services/jobs';
import type { Job } from '@/types/job';
import JobsList from '@/app/components/fixers/JobsList';

const roboto = Roboto({ subsets: ['latin'], weight: ['400', '500', '700'] });

type PageProps = { params: Promise<{ id: string }> };

export default async function Page({ params }: PageProps) {
  const { id } = await params;
  let jobs: Job[] = [];
  try {
    jobs = await getJobsByFixerId(id);
    if (process.env.NODE_ENV !== 'production') {
      console.debug(`[jobs/page] fixer ${id} -> ${jobs.length} jobs`);
    }
  } catch (err) {
    console.error('Failed to load jobs:', err);
  }

  return (
    <div className='min-h-screen bg-white'>
      <div className='mx-auto w-full max-w-5xl p-4 sm:p-6'>
        <h1
          className={`${roboto.className} text-2xl sm:text-3xl font-semibold text-gray-900 mb-4 text-center`}
        >
          Appointments
        </h1>
        <JobsList jobs={jobs} />
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/fixers/page.tsx">
import Link from 'next/link';

export default function FixersLanding() {
  return (
    <main className='min-h-screen bg-white flex items-center justify-center'>
      <div className='text-center space-y-8'>
        <h1 className='text-3xl sm:text-4xl font-semibold text-gray-900'>Fixers</h1>
        <div className='flex items-center justify-center gap-4'>
          <Link
            href='/fixers/68e87a9cdae3b73d8040102f/jobs'
            className='px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition'
          >
            View Jobs
          </Link>
          <Link
            href='/profile/68e87a9cdae3b73d8040102f'
            className='px-6 py-3 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition'
          >
            View Profile
          </Link>
          <Link
            href='/fixers/68e87a9cdae3b73d8040102f/appointments'
            className='px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition'
          >
            Appointments
          </Link>
        </div>
      </div>
    </main>
  );
}
</file>

<file path="src/app/[locale]/howUseServineo/page.tsx">
import React, { Suspense } from 'react';
import { Title } from '@/Components/HowUseServineo/Title';
import { Pasos } from '@/Components/HowUseServineo/Pasos';
import { Consejos } from '@/Components/HowUseServineo/Consejos';
import Accordion from '@/Components/HowUseServineo/Accordion';
import { CategoriasP } from '@/Components/HowUseServineo/CategoriasP';
export default function Page() {
  return (
    <Suspense fallback={<div className='p-6'>Cargando página...</div>}>
      <Title />
      <Pasos />
      <Consejos />
      <CategoriasP />
      <Accordion />
    </Suspense>
  );
}
</file>

<file path="src/app/[locale]/info/about/page.tsx">
'use client';
import Image from 'next/image';

export default function SobreNosotros() {
  return (
    <main className='bg-[var(--background)] text-[var(--foreground)] min-h-screen font-sans'>
      {/* HERO */}
      <section className='relative bg-[var(--primary)] text-white py-16 px-6 md:px-12 overflow-hidden'>
        <div className='absolute top-0 right-0 w-96 h-96 bg-white/5 rounded-full blur-3xl' />
        <div className='absolute bottom-0 left-0 w-64 h-64 bg-[var(--primary)]/20 rounded-full blur-2xl' />

        <div className='max-w-5xl mx-auto text-center relative z-10'>
          <h1 className='text-4xl md:text-5xl font-bold mb-4 leading-tight'>
            Conectamos personas con soluciones confiables
          </h1>
          <p className='text-lg md:text-xl opacity-90 max-w-3xl mx-auto'>
            En <span className='font-bold'>Servineo</span> combinamos tecnología, confianza y
            talento profesional para transformar la manera en que las personas contratan servicios
            en su hogar o negocio.
          </p>
        </div>
      </section>

      {/* QUE ES SERVINEO */}
      <section className='max-w-6xl mx-auto py-14 px-6 md:px-10'>
        <div className='text-center mb-10'>
          <h2 className='text-3xl font-bold text-[var(--primary)] mb-2'>¿Qué es Servineo?</h2>
          <div className='w-20 h-1 bg-[var(--primary)] mx-auto' />
        </div>

        <div className='grid md:grid-cols-2 gap-10 items-center'>
          <div>
            <p className='text-base text-gray-700 leading-relaxed mb-4'>
              Servineo es una plataforma digital creada para simplificar la búsqueda de servicios
              técnicos confiables. Conectamos a usuarios con
              <span className='font-semibold text-[var(--primary)]'>
                {' '}
                electricistas, plomeros, cerrajeros, carpinteros, pintores y más
              </span>
              , todos previamente evaluados para garantizar seguridad, puntualidad y calidad.
            </p>

            <p className='text-base text-gray-700 leading-relaxed mb-4'>
              Nuestra misión es eliminar la incertidumbre al contratar servicios. Ya no necesitas
              depender de recomendaciones informales ni asumir riesgos: con Servineo encuentras
              profesionales calificados en pocos minutos, con información clara, valoraciones reales
              y precios transparentes.
            </p>

            <p className='text-base text-gray-700 leading-relaxed'>
              Cada proveedor pasa por un proceso de verificación que valida identidad, experiencia y
              antecedentes, asegurando que cada servicio contratado cumpla nuestros estándares de
              excelencia.
            </p>
          </div>

          <div className='relative h-[340px]'>
            <Image
              src='/imagen1.jpg'
              alt='Red de profesionales Servineo'
              fill
              className='rounded-xl shadow-xl object-cover'
            />
          </div>
        </div>
      </section>

      {/* DIFERENCIADORES */}
      <section className='bg-gray-50 py-14 px-6 md:px-10 relative overflow-hidden'>
        <div className='absolute inset-0 opacity-5'>
          <div className='absolute top-10 left-10 w-40 h-40 border-4 border-[var(--primary)] rounded-full' />
          <div className='absolute bottom-20 right-20 w-32 h-32 border-4 border-[var(--primary)] rounded-lg rotate-45' />
          <div className='absolute top-1/2 left-1/3 w-24 h-24 bg-[var(--primary)] rounded-full' />
        </div>

        <div className='max-w-6xl mx-auto relative z-10'>
          <div className='text-center mb-12'>
            <h2 className='text-3xl font-bold text-[var(--primary)] mb-2'>
              Lo que nos hace diferentes
            </h2>
            <div className='w-20 h-1 bg-[var(--primary)] mx-auto' />
          </div>

          <div className='grid md:grid-cols-2 gap-8'>
            {/* CARD 1 */}
            <div className='bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border-l-4 border-[var(--primary)]'>
              <div className='flex items-start gap-4'>
                <div className='w-12 h-12 bg-[var(--primary)] rounded-lg flex items-center justify-center text-white text-xl'>
                  📅
                </div>

                <div>
                  <h3 className='text-xl font-bold text-[var(--primary)] mb-2'>
                    Agenda inteligente
                  </h3>
                  <p className='text-sm text-gray-700 leading-relaxed'>
                    Visualiza disponibilidad en tiempo real, agenda visitas sin llamadas
                    innecesarias y recibe confirmaciones automáticas para evitar retrasos o
                    cancelaciones inesperadas.
                  </p>
                </div>
              </div>
            </div>

            {/* CARD 2 */}
            <div className='bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border-l-4 border-[var(--primary)]'>
              <div className='flex items-start gap-4'>
                <div className='w-12 h-12 bg-[var(--primary)] rounded-lg flex items-center justify-center text-white text-xl'>
                  🎥
                </div>

                <div>
                  <h3 className='text-xl font-bold text-[var(--primary)] mb-2'>
                    Cotización por video
                  </h3>
                  <p className='text-sm text-gray-700 leading-relaxed'>
                    Envía un video breve mostrando el problema y recibe presupuestos personalizados
                    de profesionales interesados, ahorrando tiempo en visitas innecesarias.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* MISION */}
      <section className='max-w-6xl mx-auto py-14 px-6 md:px-10'>
        <div className='grid md:grid-cols-2 gap-10 items-center'>
          <div>
            <h2 className='text-2xl font-bold text-[var(--primary)] mb-3'>Nuestra Misión</h2>

            <p className='text-base text-gray-700 leading-relaxed mb-4'>
              Facilitar el acceso a servicios profesionales confiables mediante una plataforma
              segura, intuitiva y accesible para todos.
            </p>

            <p className='text-base text-gray-700 leading-relaxed'>
              Trabajamos continuamente para mejorar la experiencia tanto del cliente como del
              proveedor, impulsando una comunidad basada en respeto, responsabilidad y
              transparencia.
            </p>
          </div>

          <div className='relative h-[300px]'>
            <Image
              src='/imagen2.jpg'
              alt='Misión Servineo'
              fill
              className='rounded-xl shadow-xl object-cover'
            />
          </div>
        </div>
      </section>

      {/* VALORES */}
      <section className='bg-[var(--primary)] text-white py-14 px-6 md:px-10'>
        <div className='max-w-6xl mx-auto'>
          <div className='text-center mb-10'>
            <h2 className='text-3xl font-bold mb-2'>Nuestros Valores</h2>
            <div className='w-20 h-1 bg-white mx-auto' />
          </div>

          <div className='grid md:grid-cols-3 gap-8'>
            <div className='text-center bg-white/10 p-6 rounded-lg'>
              <h3 className='text-xl font-semibold mb-2'>Confianza</h3>
              <p className='text-white/90 text-sm leading-relaxed'>
                Seguridad y transparencia en cada interacción entre clientes y profesionales.
              </p>
            </div>

            <div className='text-center bg-white/10 p-6 rounded-lg'>
              <h3 className='text-xl font-semibold mb-2'>Calidad</h3>
              <p className='text-white/90 text-sm leading-relaxed'>
                Seleccionamos expertos comprometidos con la excelencia en cada servicio realizado.
              </p>
            </div>

            <div className='text-center bg-white/10 p-6 rounded-lg'>
              <h3 className='text-xl font-semibold mb-2'>Innovación</h3>
              <p className='text-white/90 text-sm leading-relaxed'>
                Utilizamos tecnología para simplificar, agilizar y optimizar la contratación de
                servicios.
              </p>
            </div>
          </div>
        </div>
      </section>
    </main>
  );
}
</file>

<file path="src/app/[locale]/info/cookies/page.tsx">
'use client';
import React, { JSX } from 'react';

// Tipos para el componente de sección de política
type PolicySectionProps = {
  title: string;
  content: string[];
  iconPath: string;
  gradient: string;
};

export default function CookiesPage(): JSX.Element {
  // Componente para una sección de política de cookies
  const PolicySection: React.FC<PolicySectionProps> = ({ title, content, iconPath, gradient }) => (
    <div className='bg-[var(--background)] rounded-xl shadow-md border border-[var(--primary)] overflow-hidden'>
      {/* Header de sección con gradiente */}
      <div className={`bg-gradient-to-r ${gradient} text-white p-4 flex items-center gap-3`}>
        <div className='w-10 h-10 bg-white/25 rounded-lg flex items-center justify-center flex-shrink-0'>
          <svg className='w-5 h-5' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
            <path strokeLinecap='round' strokeLinejoin='round' strokeWidth={2} d={iconPath} />
          </svg>
        </div>
        <h3 className='text-lg font-bold'>{title}</h3>
      </div>

      {/* Contenido de la sección */}
      <div className='p-5 text-sm text-[var(--foreground)] space-y-3'>
        {content.map((paragraph, index) => (
          <p key={index} className='leading-relaxed'>
            {paragraph}
          </p>
        ))}
      </div>
    </div>
  );

  const policySections = [
    {
      title: '1. ¿Qué son las Cookies?',
      gradient: 'from-[var(--primary)] to-[var(--primary)]',
      iconPath: 'M5 12h14M12 5l7 7-7 7',
      content: [
        'Las cookies son pequeños archivos de texto que se almacenan en tu dispositivo (ordenador, tablet, smartphone) cuando visitas Servineo. Permiten a la aplicación recordar tus acciones y preferencias durante un período de tiempo, facilitando la navegación y personalizando la experiencia.',
      ],
    },
    {
      title: '2. Tipos de Cookies que Utilizamos',
      gradient: 'from-[var(--primary)] to-[var(--primary)]',
      iconPath:
        'M9.75 17L9 20l-1 1h8l-1-1-3.75-3.75M3 17h18M5 17s2.5-1.5 7-1.5 7 1.5 7 1.5M4 12v3M20 12v3M5 10V8a7 7 0 0114 0v2',
      content: [
        'Utilizamos diferentes tipos de cookies para asegurar el correcto funcionamiento de nuestra plataforma de agendamiento y cotización de servicios:',
      ],
      details: [
        {
          subtitle: '2.1. Cookies Esenciales (Técnicas)',
          text: 'Son estrictamente necesarias para el funcionamiento de Servineo. Permiten el acceso a zonas seguras, mantener tu sesión activa y habilitar la funcionalidad de video inspección.',
        },
        {
          subtitle: '2.2. Cookies de Funcionalidad o Preferencia',
          text: 'Permiten recordar información para acceder al servicio con características personalizadas, como idioma o región de acceso.',
        },
        {
          subtitle: '2.3. Cookies de Rendimiento o Análisis',
          text: 'Nos ayudan a entender cómo interactúas con los calendarios y cotizaciones, permitiéndonos mejorar la experiencia de usuario.',
        },
        {
          subtitle: '2.4. Cookies de Publicidad Comportamental',
          text: 'Almacenan información sobre tus hábitos de navegación para ofrecerte publicidad de servicios relevantes.',
        },
      ],
    },
    {
      title: '3. Cookies de Terceros',
      gradient: 'from-[var(--primary)] to-[var(--primary)]',
      iconPath:
        'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z',
      content: [
        'Servineo utiliza servicios de terceros que pueden instalar sus propias cookies, como Google Analytics y redes sociales, para medición y analítica.',
      ],
    },
    {
      title: '4. Gestión de Cookies',
      gradient: 'from-[var(--primary)] to-[var(--primary)]',
      iconPath:
        'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35-.427.757-.427 1.838 0 2.573 1.543.94 3.31-.826 2.37-2.37a1.724 1.724 0 00-1.065-2.572M10 20l4-4m-4 0l4 4',
      content: [
        'Puedes aceptar, rechazar o revocar tu consentimiento sobre el uso de cookies en cualquier momento desde la configuración de tu navegador.',
        'Si deshabilitas las cookies esenciales, ciertas funciones como el agendamiento o el acceso a tu cuenta podrían dejar de funcionar correctamente.',
      ],
    },
  ];

  return (
    <div className='bg-[var(--background)] text-[var(--foreground)] min-h-screen'>
      {/* Hero Section */}
      <section className='relative bg-gradient-to-br from-[var(--primary)] to-[var(--primary)] text-white py-12 px-6 md:px-12 overflow-hidden'>
        <div className='absolute top-0 right-0 w-80 h-80 bg-white/10 rounded-full blur-3xl'></div>
        <div className='absolute bottom-0 left-0 w-60 h-60 bg-[var(--primary)]/25 rounded-full blur-2xl'></div>

        <div className='max-w-5xl mx-auto text-center relative z-10'>
          <div className='w-16 h-16 bg-white/25 rounded-full flex items-center justify-center mx-auto mb-4'>
            <svg className='w-8 h-8' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
              <path
                strokeLinecap='round'
                strokeLinejoin='round'
                strokeWidth={2}
                d='M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z'
              />
            </svg>
          </div>
          <h1 className='text-3xl md:text-4xl font-bold mb-3'>Política de Cookies de Servineo</h1>
          <p className='text-base opacity-90 max-w-2xl mx-auto'>
            Información detallada sobre cómo usamos cookies para mejorar tu experiencia.
          </p>
        </div>
      </section>

      {/* Contenido Principal */}
      <section className='max-w-6xl mx-auto py-10 px-6 md:px-10 space-y-8'>
        {/* Introducción */}
        <div className='bg-[var(--background)] p-6 rounded-xl shadow-md border-l-4 border-[var(--primary)]'>
          <h2 className='text-2xl font-bold text-[var(--primary)] mb-3'>Información General</h2>
          <p className='mb-3 leading-relaxed'>
            Esta política explica cómo Servineo utiliza las cookies y tecnologías similares. Al usar
            nuestra plataforma, acepta su uso según esta política.
          </p>
          <p className='leading-relaxed'>
            Nuestro objetivo es brindarle la mejor experiencia posible, optimizando las funciones
            mediante el uso responsable de cookies.
          </p>
        </div>

        {/* Secciones iteradas */}
        {policySections.map((section, index) => (
          <div key={index}>
            <PolicySection
              title={section.title}
              content={section.content}
              iconPath={section.iconPath}
              gradient={section.gradient}
            />
            {section.details && (
              <div className='ml-4 mt-4 space-y-3 p-4 bg-[var(--background)] rounded-xl border border-[var(--primary)]'>
                {section.details.map((detail, dIndex) => (
                  <div key={dIndex} className='text-sm text-[var(--foreground)]'>
                    <p className='font-semibold text-[var(--primary)]'>{detail.subtitle}:</p>
                    <p className='leading-relaxed pl-3 border-l-2 border-[var(--primary)] ml-1'>
                      {detail.text}
                    </p>
                  </div>
                ))}
              </div>
            )}
          </div>
        ))}
      </section>

      {/* CTA */}
      <section className='bg-gradient-to-r from-[var(--primary)] to-[var(--primary)] text-white text-center py-10 px-6 mt-10'>
        <div className='max-w-4xl mx-auto'>
          <h3 className='text-2xl font-bold mb-3'>Tu Privacidad es Importante</h3>
          <p className='text-base leading-relaxed mb-5 opacity-95'>
            Puedes cambiar tu configuración de cookies en cualquier momento. Al continuar navegando,
            aceptas nuestra política.
          </p>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="src/app/[locale]/info/join/page.tsx">
'use client';
import React from 'react';
// Importa íconos de Lucide React para un estilo más moderno
import { Phone, Mail, Zap, Clock, Calendar, Users, Cpu } from 'lucide-react';

export default function JoinPage() {
  // ===================================
  // CONFIGURACIÓN Y CONSTANTES
  // ===================================
  const CONTACT = {
    WHATSAPP_NUMBER: '59175139742',
    EMAIL: 'servineo.serviciostecnicos@gmail.com',
  };

  const WHATSAPP_MESSAGE = encodeURIComponent(
    'Hola Servineo, quisiera postularme para trabajar en soporte técnico.',
  );

  // ===================================
  // DATOS DE SECCIÓN
  // ===================================
  const benefits = [
    {
      title: 'Crecimiento Profesional',
      description:
        'Accede a una red de clientes en expansión y aumenta tus ingresos sin pagar publicidad.',
      icon: Users,
    },
    {
      title: 'Eficiencia Digital',
      description:
        'Usa herramientas inteligentes para cotizar y gestionar servicios desde tu móvil, sin papeleo.',
      icon: Zap,
    },
    {
      title: 'Control Total',
      description:
        'Agenda citas, organiza pedidos y controla tus pagos desde un panel de administración intuitivo.',
      icon: Calendar,
    },
    {
      title: 'Comunidad y Soporte',
      description:
        'Forma parte de una red de profesionales y recibe ayuda constante cuando la necesites.',
      icon: Clock,
    },
  ];

  // ===================================
  // COMPONENTES REUTILIZABLES
  // ===================================
  const CTAButtonWhatsapp = () => (
    <button
      onClick={() =>
        window.open(`wa.me{CONTACT.WHATSAPP_NUMBER}?text=${WHATSAPP_MESSAGE}`, '_blank')
      }
      className='bg-primary text-primary-foreground hover:bg-primary/90 transition duration-300 text-lg font-bold px-10 py-4 rounded-full shadow-lg hover:scale-105 flex items-center justify-center gap-3 w-full sm:w-auto'
    >
      <Phone className='w-5 h-5' />
      Postular por WhatsApp
    </button>
  );

  const CTAButtonEmail = () => (
    <a
      href={`mailto:${CONTACT.EMAIL}?subject=Postulacion a soporte tecnico&body=Hola Servineo,%0A%0AQuisiera postularme para formar parte del equipo de soporte tecnico.`}
      className='bg-background text-primary border-2 border-input text-lg font-bold px-10 py-4 rounded-full shadow-lg hover:bg-muted hover:scale-105 transition duration-300 flex items-center justify-center gap-3 w-full sm:w-auto'
    >
      <Mail className='w-5 h-5' />
      Postular por Email
    </a>
  );

  // ===================================
  // RENDERIZADO PRINCIPAL
  // ===================================
  return (
    <main className='min-h-screen bg-background text-foreground'>
      {/* HERO SECTION - Enfocado en atraer al profesional */}
      <section className='bg-primary text-primary-foreground text-center py-16 px-6'>
        <h1 className='text-5xl md:text-6xl font-extrabold mb-4'>
          Impulsa tu carrera técnica con <span className='text-background/50'>Servineo</span>
        </h1>

        <p className='text-lg max-w-3xl mx-auto opacity-90'>
          Estamos buscando técnicos comprometidos que quieran crecer y modernizar su forma de
          trabajar con nuestra plataforma líder en servicios.
        </p>

        <div className='mt-8 flex justify-center gap-6 flex-wrap'>
          <CTAButtonWhatsapp />
          <CTAButtonEmail />
        </div>
      </section>

      {/* BENEFICIOS SECTION - Más compacto */}
      <section className='py-12 px-6'>
        <h2 className='text-4xl font-bold text-center mb-10 text-primary'>Beneficios Clave</h2>

        <div className='grid gap-6 md:grid-cols-2 lg:grid-cols-4 max-w-6xl mx-auto'>
          {benefits.map((item) => (
            <div
              key={item.title}
              className='bg-card text-card-foreground rounded-2xl p-6 shadow-md hover:shadow-xl transition duration-300 transform hover:-translate-y-1'
            >
              <div className='w-12 h-12 flex items-center justify-center bg-primary text-primary-foreground rounded-xl mb-4 text-xl'>
                <item.icon className='w-6 h-6' />
              </div>
              <h3 className='text-xl font-bold mb-2 text-primary'>{item.title}</h3>
              <p className='text-sm text-muted-foreground'>{item.description}</p>
            </div>
          ))}
        </div>
      </section>

      {/* NUEVA SECCIÓN - Tecnología y Modernidad */}
      <section className='bg-muted py-12 px-6'>
        <div className='max-w-4xl mx-auto flex flex-col md:flex-row items-center gap-8'>
          <div className='md:w-1/2'>
            <Cpu className='w-24 h-24 text-primary mx-auto md:mx-0 mb-4' />
            <h2 className='text-3xl font-bold mb-4 text-primary'>Tecnología a tu Servicio</h2>
            <p className='text-foreground mb-4'>
              Olvídate de los métodos anticuados. Servineo utiliza tecnología de vanguardia para
              conectar a los técnicos con los clientes de manera eficiente y segura.
            </p>
            <ul className='list-disc list-inside text-muted-foreground space-y-2'>
              <li>Gestión de rutas optimizada.</li>
              <li>Notificaciones instantáneas de nuevos trabajos.</li>
              <li>Pagos seguros y transparentes.</li>
            </ul>
          </div>
          <div className='md:w-1/2'>
            {/* Aquí es donde pones la imagen */}
            <img
              src='/reparadores.jpg'
              alt='Técnicos de Servineo usando la plataforma'
              className='rounded-xl shadow-lg w-full object-cover h-64'
            />
          </div>
        </div>
      </section>

      {/* CTA FINAL SECTION - Compacto */}
      <section className='bg-primary text-primary-foreground py-16 text-center px-6'>
        <h2 className='text-4xl font-extrabold mb-4'>¿Listo para formar parte del equipo?</h2>

        <p className='text-lg opacity-90 max-w-2xl mx-auto mb-8'>
          Escríbenos ahora y comienza tu camino profesional en Servineo.
        </p>

        <div className='flex justify-center gap-6 flex-wrap'>
          <CTAButtonWhatsapp />
          <CTAButtonEmail />
        </div>
      </section>
    </main>
  );
}
</file>

<file path="src/app/[locale]/info/privacy/page.tsx">
'use client';
import React from 'react';

// Tipos para los subcomponentes
type SectionBlockProps = {
  index: string | number;
  title: string;
  gradient?: string;
  borderColor?: string;
  children?: React.ReactNode;
};

type InfoItemProps = {
  title: string;
  text: string;
};

export default function PrivacyPage() {
  return (
    <main className='bg-[var(--background)] text-[var(--foreground)] min-h-screen'>
      {/* HERO SECTION */}
      <section className='relative bg-[var(--primary)] text-white py-16 px-6 md:px-12 overflow-hidden shadow-lg'>
        <div className='absolute top-0 right-0 w-80 h-80 bg-[var(--primary)]/20 rounded-full blur-3xl'></div>
        <div className='absolute bottom-0 left-0 w-60 h-60 bg-[var(--primary)]/30 rounded-full blur-2xl'></div>

        <div className='max-w-4xl mx-auto text-center relative z-10'>
          <div className='w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-5'>
            <svg className='w-8 h-8' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
              <path
                strokeLinecap='round'
                strokeLinejoin='round'
                strokeWidth={2}
                d='M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z'
              />
            </svg>
          </div>
          <h1 className='text-4xl md:text-5xl font-extrabold mb-4'>Política de Privacidad</h1>
          <p className='text-base opacity-90 max-w-2xl mx-auto'>
            Tu privacidad es nuestra prioridad. Conoce cómo protegemos y manejamos tu información.
          </p>
          <p className='text-sm opacity-80 mt-2'>Última actualización: Octubre 2025</p>
        </div>
      </section>

      {/* INTRODUCCIÓN */}
      <section className='max-w-5xl mx-auto py-14 px-6 md:px-10'>
        <div className='mb-10 p-6 bg-[var(--light-gray)] border-l-4 border-[var(--primary)] rounded-r-xl shadow-sm'>
          <h2 className='text-2xl font-bold text-[var(--primary)] mb-3'>
            Compromiso con tu Privacidad
          </h2>
          <p className='text-sm leading-relaxed mb-2'>
            En <strong>Servineo</strong> nos tomamos muy en serio la protección de tu información
            personal. Esta política explica qué datos recopilamos, cómo los usamos y los derechos
            que tienes sobre ellos.
          </p>
          <p className='text-sm leading-relaxed'>
            Al usar nuestros servicios, aceptas las prácticas descritas en esta política de
            privacidad.
          </p>
        </div>

        {/* SECCIONES */}
        <div className='space-y-10'>
          {[
            {
              index: '1',
              title: 'Información que Recopilamos',
              content: (
                <>
                  <p>
                    Recopilamos diferentes tipos de información para brindarte nuestros servicios:
                  </p>
                  <ul className='space-y-3 mt-3 ml-2'>
                    <InfoItem
                      title='Información de Cuenta'
                      text='Nombre completo, correo electrónico, teléfono, dirección y fecha de nacimiento.'
                    />
                    <InfoItem
                      title='Información de Servicios'
                      text='Detalles de los servicios solicitados, direcciones, videos de inspección, cotizaciones y preferencias.'
                    />
                    <InfoItem
                      title='Información de Pago'
                      text='Datos procesados de forma segura por nuestros proveedores certificados.'
                    />
                    <InfoItem
                      title='Datos de Uso'
                      text='Información sobre el uso de la app, páginas visitadas, tiempo de uso, dispositivo y dirección IP.'
                    />
                  </ul>
                </>
              ),
            },
            {
              index: '2',
              title: 'Cómo Usamos tu Información',
              content: (
                <ul className='list-disc list-inside space-y-2 text-sm text-[var(--foreground)]'>
                  <li>
                    <strong>Proveer el servicio:</strong> conectar con profesionales verificados.
                  </li>
                  <li>
                    <strong>Procesar pagos:</strong> facilitar transacciones seguras.
                  </li>
                  <li>
                    <strong>Mejorar la plataforma:</strong> optimizar funciones y experiencia.
                  </li>
                  <li>
                    <strong>Comunicación:</strong> enviar confirmaciones y avisos.
                  </li>
                  <li>
                    <strong>Seguridad:</strong> prevenir fraude y proteger la comunidad.
                  </li>
                </ul>
              ),
            },
            {
              index: '3',
              title: 'Compartir Información',
              content: (
                <p>Compartimos tu información únicamente en las siguientes circunstancias:</p>
              ),
            },
            {
              index: '4',
              title: 'Seguridad de los Datos',
              content: (
                <div className='grid md:grid-cols-2 gap-3 mt-4'>
                  {[
                    'Encriptación SSL/TLS',
                    'Servidores Seguros',
                    'Autenticación de Dos Factores',
                    'Monitoreo Constante',
                  ].map((item, i) => (
                    <div
                      key={i}
                      className='flex items-center gap-2 bg-[var(--light-gray)] p-2 rounded-lg shadow-sm'
                    >
                      <svg
                        className='w-5 h-5 text-[var(--primary)]'
                        fill='none'
                        stroke='currentColor'
                        viewBox='0 0 24 24'
                      >
                        <path
                          strokeLinecap='round'
                          strokeLinejoin='round'
                          strokeWidth={2}
                          d='M9 12l2 2 4-4'
                        />
                      </svg>
                      <span className='text-sm'>{item}</span>
                    </div>
                  ))}
                </div>
              ),
            },
            {
              index: '5',
              title: 'Tus Derechos',
              content: (
                <ul className='space-y-2 text-sm'>
                  <li>→ Acceso a tu información personal.</li>
                  <li>→ Corrección o actualización de datos.</li>
                  <li>→ Eliminación de tu cuenta (derecho al olvido).</li>
                  <li>→ Portabilidad de datos.</li>
                  <li>→ Oposición a ciertos tratamientos.</li>
                  <li>→ Revocar consentimiento en cualquier momento.</li>
                </ul>
              ),
            },
          ].map((section, idx) => (
            <SectionBlock
              key={idx}
              index={section.index}
              title={section.title}
              borderColor='var(--primary)'
              gradient='from-[var(--primary)] to-[var(--primary)]'
            >
              {section.content}
            </SectionBlock>
          ))}
        </div>

        {/* CONTACTO */}
        <div className='mt-16 p-6 bg-[var(--light-gray)] rounded-xl border border-[var(--primary)] shadow-md'>
          <h3 className='text-lg font-bold text-[var(--primary)] mb-2'>
            Contacto sobre Privacidad
          </h3>
          <p className='text-sm mb-2'>
            Si tienes preguntas o deseas ejercer tus derechos, contáctanos:
          </p>
          <a
            href='mailto:servineo.serviciostecnicos@gmail.com'
            className='text-[var(--primary)] font-semibold hover:text-[var(--primary)] transition-colors'
          >
            servineo.serviciostecnicos@gmail.com
          </a>
        </div>
      </section>

      {/* FOOTER */}
      <footer className='bg-[var(--primary)] text-white text-center py-8'>
        <p className='text-sm font-medium'>
          Tu privacidad está protegida con nosotros. © Servineo 2025.
        </p>
      </footer>
    </main>
  );
}

/* Subcomponentes para limpieza */
function SectionBlock({ index, title, borderColor, children }: SectionBlockProps) {
  return (
    <div className='pl-5 border-l-4 rounded-lg bg-white p-5 shadow-sm' style={{ borderColor }}>
      <h3 className='text-lg font-bold text-[var(--primary)] mb-3 flex items-center gap-2'>
        <span
          className={`w-8 h-8 bg-[var(--primary)] rounded-full flex items-center justify-center text-white text-sm font-bold`}
        >
          {index}
        </span>
        {title}
      </h3>
      <div className='text-sm text-[var(--foreground)] leading-relaxed'>{children}</div>
    </div>
  );
}

function InfoItem({ title, text }: InfoItemProps) {
  return (
    <div className='bg-[var(--light-gray)] p-3 rounded-lg shadow-sm'>
      <h4 className='font-semibold text-[var(--primary)] text-sm mb-1'>{title}</h4>
      <p className='text-sm text-[var(--foreground)]/80'>{text}</p>
    </div>
  );
}
</file>

<file path="src/app/[locale]/info/reparador/page.tsx">
'use client';
import Image from 'next/image';
import { useState } from 'react';
import Link from 'next/link';

export default function ParaReparadores() {
  const [imgError, setImgError] = useState(false);

  return (
    <main className='bg-[var(--background)] text-[var(--foreground)] min-h-screen font-sans'>
      <section className='relative bg-[var(--primary)] text-white py-16 px-6 md:px-12 overflow-hidden'>
        <div className='absolute top-0 right-0 w-96 h-96 bg-white/5 rounded-full blur-3xl'></div>
        <div className='absolute bottom-0 left-0 w-64 h-64 bg-[var(--primary)]/20 rounded-full blur-2xl'></div>

        <div className='max-w-5xl mx-auto text-center relative z-10'>
          <h1 className='text-4xl md:text-5xl font-bold mb-4 leading-tight'>
            Ofrece tus servicios
          </h1>
          <p className='text-lg md:text-xl opacity-90 max-w-3xl mx-auto'>
            Conecta con clientes de manera confiable y profesional. Gestiona tus citas, agenda
            reparaciones y crece junto a nosotros.
          </p>
        </div>
      </section>

      <section className='max-w-6xl mx-auto py-12 px-6 md:px-10'>
        <div className='text-center mb-8'>
          <h2 className='text-3xl font-bold text-[var(--primary)] mb-2'>Beneficios</h2>
          <div className='w-20 h-1 bg-[var(--primary)] mx-auto'></div>
        </div>

        <div className='grid md:grid-cols-2 gap-8 items-center'>
          <div>
            <p className='text-base text-gray-700 leading-relaxed mb-4'>
              Servineo te permite recibir solicitudes de reparación directamente de clientes en tu
              área. Ya seas{' '}
              <span className='font-semibold text-[var(--primary)]'>
                electricista, plomero, carpintero, pintor
              </span>{' '}
              u otro especialista, podrás mostrar tus servicios y recibir más trabajos de calidad.
            </p>
            <p className='text-base text-gray-700 leading-relaxed'>
              Todos los reparadores registrados tienen la oportunidad de construir su reputación,
              recibir valoraciones confiables y crecer profesionalmente dentro de nuestra
              plataforma.
            </p>
          </div>
          <div className='relative h-[320px]'>
            <Image
              src={imgError ? '/fallback-image.svg' : '/reparadores.jpg'}
              alt='Reparadores en acción'
              fill
              className='rounded-xl shadow-xl object-cover'
              onError={() => setImgError(true)}
            />
          </div>
        </div>
      </section>

      <section className='bg-gray-50 py-12 px-6 md:px-10 relative overflow-hidden'>
        <div className='absolute inset-0 opacity-5'>
          <div className='absolute top-10 left-10 w-40 h-40 border-4 border-[var(--primary)] rounded-full'></div>
          <div className='absolute bottom-20 right-20 w-32 h-32 border-4 border-[var(--primary)] rounded-lg rotate-45'></div>
          <div className='absolute top-1/2 left-1/3 w-24 h-24 bg-[var(--primary)] rounded-full'></div>
        </div>

        <div className='max-w-6xl mx-auto relative z-10'>
          <div className='text-center mb-10'>
            <h2 className='text-3xl font-bold text-[var(--primary)] mb-2'>Cómo Funciona</h2>
            <div className='w-20 h-1 bg-[var(--primary)] mx-auto'></div>
          </div>

          <div className='grid md:grid-cols-2 gap-6'>
            <div className='bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border-l-4 border-[var(--primary)]'>
              <div className='flex items-start gap-4'>
                <div className='w-12 h-12 bg-[var(--primary)] rounded-lg flex items-center justify-center flex-shrink-0'>
                  <svg
                    className='w-6 h-6 text-white'
                    fill='none'
                    stroke='currentColor'
                    viewBox='0 0 24 24'
                  >
                    <path
                      strokeLinecap='round'
                      strokeLinejoin='round'
                      strokeWidth={2}
                      d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'
                    />
                  </svg>
                </div>
                <div>
                  <h3 className='text-xl font-bold text-[var(--primary)] mb-2'>Agenda Fácil</h3>
                  <p className='text-sm text-gray-700 leading-relaxed'>
                    Gestiona tus citas desde la plataforma, recibe solicitudes y organiza tus
                    reparaciones de manera sencilla.
                  </p>
                </div>
              </div>
            </div>

            <div className='bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border-l-4 border-[var(--primary)]'>
              <div className='flex items-start gap-4'>
                <div className='w-12 h-12 bg-[var(--primary)] rounded-lg flex items-center justify-center flex-shrink-0'>
                  <svg
                    className='w-6 h-6 text-white'
                    fill='none'
                    stroke='currentColor'
                    viewBox='0 0 24 24'
                  >
                    <path
                      strokeLinecap='round'
                      strokeLinejoin='round'
                      strokeWidth={2}
                      d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'
                    />
                  </svg>
                </div>
                <div>
                  <h3 className='text-xl font-bold text-[var(--primary)] mb-2'>
                    Cotizaciones Rápidas
                  </h3>
                  <p className='text-sm text-gray-700 leading-relaxed'>
                    Recibe solicitudes de clientes con videos o fotos de los trabajos y envía tu
                    presupuesto al instante.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section className='max-w-6xl mx-auto py-12 px-6 md:px-10 text-center'>
        <h2 className='text-3xl font-bold text-[var(--primary)] mb-4'>
          ¡Únete como reparador hoy!
        </h2>
        <p className='text-gray-700 mb-6'>
          Regístrate en Servineo y empieza a recibir trabajos de manera confiable y profesional.
        </p>
        <Link
          href='/signUp'
          className='inline-block bg-[var(--primary)] text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300'
        >
          Registrarse
        </Link>
      </section>
    </main>
  );
}
</file>

<file path="src/app/[locale]/info/support/page.tsx">
'use client';

export default function SupportPage() {
  const WHATSAPP_NUMBER = '59175139742';
  const SUPPORT_EMAIL = 'servineo.serviciostecnicos@gmail.com';

  const HELP_MESSAGE = encodeURIComponent('Hola Servineo, necesito ayuda por favor.');
  const faqs = [
    {
      category: 'Primeros pasos',
      color: 'from-[var(--primary)] to-[var(--primary)]',
      icon: (
        <path
          strokeLinecap='round'
          strokeLinejoin='round'
          strokeWidth={2}
          d='M13 10V3L4 14h7v7l9-11h-7z'
        />
      ),
      questions: [
        {
          q: '¿Cómo me registro en Servineo?',
          a: "Descarga la app o visita nuestra web, haz clic en 'Registrarse' e ingresa tu correo, nombre y crea una contraseña. Verifica tu email y listo, ya puedes buscar profesionales.",
        },
        {
          q: '¿Es gratuito usar Servineo?',
          a: 'Sí, registrarte y buscar profesionales es completamente gratuito. Solo pagas por los servicios que contrates directamente con los profesionales.',
        },
      ],
    },
    {
      category: 'Agendamiento',
      color: 'from-[var(--primary)] to-[var(--primary)]',
      icon: (
        <path
          strokeLinecap='round'
          strokeLinejoin='round'
          strokeWidth={2}
          d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'
        />
      ),
      questions: [
        {
          q: '¿Cómo funciona el calendario en tiempo real?',
          a: 'Cada profesional actualiza su disponibilidad en tiempo real. Tú ves las fechas y horas libres y eliges la que mejor te convenga. Es instantáneo y sin necesidad de llamadas.',
        },
        {
          q: '¿Puedo cancelar o reprogramar una cita?',
          a: 'Sí, puedes hacerlo desde la app. Te recomendamos hacerlo con al menos 24 horas de anticipación para evitar cargos. Revisa la política de cancelación de cada profesional.',
        },
        {
          q: '¿Qué pasa si el profesional no llega?',
          a: 'Contacta inmediatamente a nuestro equipo de soporte. Tomaremos medidas y te ayudaremos a encontrar un reemplazo o te reembolsaremos según corresponda.',
        },
      ],
    },
    {
      category: 'Video Inspección',
      color: 'from-[var(--primary)] to-[var(--primary)]',
      icon: (
        <path
          strokeLinecap='round'
          strokeLinejoin='round'
          strokeWidth={2}
          d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'
        />
      ),
      questions: [
        {
          q: '¿Cómo funciona la video inspección?',
          a: 'Graba un video corto (30-60 segundos) mostrando el problema o área de trabajo. Súbelo a la app y en minutos recibirás cotizaciones de profesionales interesados.',
        },
        {
          q: '¿Qué debo incluir en el video?',
          a: 'Muestra claramente el área afectada, el problema específico y cualquier detalle relevante. Buena iluminación y estabilidad ayudan a obtener cotizaciones más precisas.',
        },
        {
          q: '¿Cuánto tiempo toma recibir cotizaciones?',
          a: 'Normalmente recibes las primeras cotizaciones en 15-30 minutos. En horarios pico puede tomar hasta 2 horas. Te notificaremos cuando lleguen.',
        },
      ],
    },
    {
      category: 'Pagos y Seguridad',
      color: 'from-[var(--primary)] to-[var(--primary)]',
      icon: (
        <path
          strokeLinecap='round'
          strokeLinejoin='round'
          strokeWidth={2}
          d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'
        />
      ),
      questions: [
        {
          q: '¿Cómo pago por los servicios?',
          a: 'Puedes pagar con tarjeta de crédito/débito, transferencia bancaria o en efectivo al profesional. El pago a través de la app está protegido y solo se libera cuando confirmas que el servicio fue completado.',
        },
        {
          q: '¿Mis datos están seguros?',
          a: 'Absolutamente. Usamos encriptación de nivel bancario para proteger tu información. Nunca compartimos tus datos sin tu consentimiento.',
        },
        {
          q: '¿Qué pasa si no estoy satisfecho con el servicio?',
          a: 'Contáctanos dentro de las 48 horas. Evaluaremos tu caso y, si corresponde, mediaremos con el profesional o procesaremos un reembolso según nuestra política de garantía.',
        },
      ],
    },
    {
      category: 'Profesionales',
      color: 'from-[var(--primary)] to-[var(--primary)]',
      icon: (
        <path
          strokeLinecap='round'
          strokeLinejoin='round'
          strokeWidth={2}
          d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z'
        />
      ),
      questions: [
        {
          q: '¿Cómo se verifican los profesionales?',
          a: 'Verificamos identidad, antecedentes, certificaciones profesionales y realizamos entrevistas. Solo aceptamos profesionales con experiencia comprobada y buenas referencias.',
        },
        {
          q: '¿Puedo calificar al profesional?',
          a: 'Sí, después de cada servicio puedes dejar una calificación de 1-5 estrellas y un comentario. Esto ayuda a otros usuarios y mantiene la calidad de nuestra red.',
        },
        {
          q: '¿Qué hago si tengo un problema con un profesional?',
          a: 'Repórtalo inmediatamente a través de la app o contacta a soporte. Investigaremos y tomaremos las medidas necesarias para resolver la situación.',
        },
      ],
    },
  ];

  const contactOptions = [
    {
      title: 'Chat en Vivo',
      description: 'Atención directa por WhatsApp',
      icon: (
        <path
          strokeLinecap='round'
          strokeLinejoin='round'
          strokeWidth={2}
          d='M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z'
        />
      ),
      action: 'Iniciar Chat',
      link: `https://wa.me/${WHATSAPP_NUMBER}?text=${HELP_MESSAGE}`,
    },

    {
      title: 'Email',
      description: SUPPORT_EMAIL,
      icon: (
        <path
          strokeLinecap='round'
          strokeLinejoin='round'
          strokeWidth={2}
          d='M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z'
        />
      ),
      action: 'Enviar Email',
      link: `mailto:${SUPPORT_EMAIL}?subject=Solicitud de ayuda&body=Hola Servineo,%0A%0ANecesito ayuda con uno de sus servicios.`,
    },

    {
      title: 'WhatsApp',
      description: '+591 751 39742',
      icon: (
        <path
          strokeLinecap='round'
          strokeLinejoin='round'
          strokeWidth={2}
          d='M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z'
        />
      ),
      action: 'Abrir WhatsApp',
      link: `https://wa.me/${WHATSAPP_NUMBER}?text=${HELP_MESSAGE}`,
    },
  ];

  return (
    <main className='bg-[var(--background)] text-[var(--foreground)] min-h-screen'>
      {/* Hero */}
      <section className='relative bg-[var(--primary)] text-white py-12 px-6 md:px-12 overflow-hidden'>
        <div className='absolute top-0 right-0 w-80 h-80 bg-white/5 rounded-full blur-3xl'></div>
        <div className='absolute bottom-0 left-0 w-60 h-60 bg-[var(--primary)]/20 rounded-full blur-2xl'></div>
        <div className='max-w-5xl mx-auto text-center relative z-10'>
          <h1 className='text-3xl md:text-4xl font-bold mb-3'></h1>
          <h1 className='text-3xl md:text-4xl font-bold mb-3'></h1>

          <h1 className='text-3xl md:text-4xl font-bold mb-3'>Centro de Apoyo</h1>
          <p className='text-base opacity-90 max-w-2xl mx-auto'>
            Estamos aquí para ayudarte. Encuentra respuestas rápidas o contáctanos directamente.
          </p>
        </div>
      </section>

      {/* FAQs */}
      <section className='max-w-6xl mx-auto py-8 px-6 md:px-10 space-y-6'>
        {faqs.map((category, i) => (
          <div
            key={i}
            className='bg-[var(--background)] rounded-xl shadow-lg border border-[var(--light-gray)] overflow-hidden'
          >
            <div className='bg-[var(--primary)] text-white p-4 flex items-center gap-3'>
              <div className='w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center flex-shrink-0'>
                <svg className='w-5 h-5' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                  {category.icon}
                </svg>
              </div>
              <h3 className='text-lg font-bold'>{category.category}</h3>
            </div>
            <div className='divide-y divide-[var(--light-gray)]'>
              {category.questions.map((item, qIndex) => (
                <details key={qIndex} className='group'>
                  <summary className='flex items-center justify-between p-4 cursor-pointer hover:bg-[var(--light-gray)] transition-colors'>
                    <span className='font-semibold text-[var(--foreground)] text-sm pr-4'>
                      {item.q}
                    </span>
                    <svg
                      className='w-5 h-5 text-gray-400 flex-shrink-0 group-open:rotate-180 transition-transform'
                      fill='none'
                      stroke='currentColor'
                      viewBox='0 0 24 24'
                    >
                      <path
                        strokeLinecap='round'
                        strokeLinejoin='round'
                        strokeWidth={2}
                        d='M19 9l-7 7-7-7'
                      />
                    </svg>
                  </summary>
                  <div className='px-4 pb-4 pt-2'>
                    <p className='text-sm text-gray-600 leading-relaxed'>{item.a}</p>
                  </div>
                </details>
              ))}
            </div>
          </div>
        ))}
      </section>

      {/* Contact Options */}
      <section className='bg-[var(--light-gray)] py-10 px-6 md:px-10'>
        <div className='max-w-6xl mx-auto grid md:grid-cols-3 gap-5'>
          {contactOptions.map((option, i) => (
            <div
              key={i}
              className='bg-[var(--background)] p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300'
            >
              <div
                className={`w-12 h-12 bg-[var(--primary)] rounded-lg flex items-center justify-center mb-4`}
              >
                <svg
                  className='w-6 h-6 text-white'
                  fill='none'
                  stroke='currentColor'
                  viewBox='0 0 24 24'
                >
                  {option.icon}
                </svg>
              </div>
              <h3 className='font-bold text-[var(--foreground)] mb-2 text-base'>{option.title}</h3>
              <p className='text-sm text-gray-600 mb-4'>{option.description}</p>
              <a
                href={option.link}
                target='_blank'
                rel='noopener noreferrer'
                className='block w-full bg-[var(--primary)] text-white py-2 px-4 rounded-lg text-sm font-semibold text-center hover:shadow-lg transition-all duration-300'
              >
                {option.action}
              </a>
            </div>
          ))}
        </div>
      </section>

      {/* Horarios de atención */}
      <section className='max-w-4xl mx-auto py-8 px-6 md:px-10'>
        <div className='bg-[var(--background)] p-6 rounded-xl shadow-lg border-l-4 border-[var(--primary)]'>
          <div className='flex items-start gap-4'>
            <div className='w-12 h-12 bg-[var(--primary)] rounded-lg flex items-center justify-center flex-shrink-0'>
              <svg
                className='w-6 h-6 text-white'
                fill='none'
                stroke='currentColor'
                viewBox='0 0 24 24'
              >
                <path
                  strokeLinecap='round'
                  strokeLinejoin='round'
                  strokeWidth={2}
                  d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z'
                />
              </svg>
            </div>
            <div className='flex-1'>
              <h3 className='font-bold text-[var(--foreground)] mb-3 text-base'>
                Horarios de Atención
              </h3>
              <div className='grid md:grid-cols-2 gap-3 text-sm text-gray-700'>
                <div>
                  <p className='font-semibold text-[var(--primary)]'>Lunes a Viernes</p>
                  <p>8:00 AM - 8:00 PM</p>
                </div>
                <div>
                  <p className='font-semibold text-[var(--primary)]'>Sábados</p>
                  <p>9:00 AM - 6:00 PM</p>
                </div>
                <div>
                  <p className='font-semibold text-[var(--primary)]'>Domingos</p>
                  <p>10:00 AM - 4:00 PM</p>
                </div>
                <div>
                  <p className='font-semibold text-[var(--primary)]'>Chat en Vivo</p>
                  <p>24/7 disponible</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* CTA Final */}
      <section className='bg-[var(--primary)] text-white text-center py-10 px-6'>
        <div className='max-w-4xl mx-auto'>
          <h3 className='text-2xl font-bold mb-3'>¿Aún tienes dudas?</h3>
          <p className='text-base leading-relaxed mb-5 opacity-95'>
            Nuestro equipo está listo para ayudarte. No dudes en contactarnos.
          </p>
        </div>
      </section>
    </main>
  );
}
</file>

<file path="src/app/[locale]/info/terms/page.tsx">
'use client';
import React from 'react';

// Tipos para los subcomponentes
type SectionBlockProps = {
  index: string | number;
  title: string;
  borderColor?: string;
  children?: React.ReactNode;
};

export default function TermsPage() {
  return (
    <main className='bg-[var(--background)] text-[var(--foreground)] min-h-screen'>
      {/* HERO SECTION */}
      <section className='relative bg-[var(--primary)] text-white py-16 px-6 md:px-12 overflow-hidden shadow-lg'>
        <div className='absolute top-0 right-0 w-80 h-80 bg-[var(--primary)]/20 rounded-full blur-3xl'></div>
        <div className='absolute bottom-0 left-0 w-60 h-60 bg-[var(--primary)]/30 rounded-full blur-2xl'></div>

        <div className='max-w-4xl mx-auto text-center relative z-10'>
          <div className='w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-5'>
            <svg className='w-8 h-8' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
              <path
                strokeLinecap='round'
                strokeLinejoin='round'
                strokeWidth={2}
                d='M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z'
              />
            </svg>
          </div>
          <h1 className='text-4xl md:text-5xl font-extrabold mb-4'>Términos y Condiciones</h1>
          <p className='text-base opacity-90 max-w-2xl mx-auto'>
            Por favor, lee cuidadosamente estos términos antes de utilizar Servineo.
          </p>
          <p className='text-sm opacity-80 mt-2'>Última actualización: Octubre 2025</p>
        </div>
      </section>

      {/* CONTENIDO PRINCIPAL */}
      <section className='max-w-5xl mx-auto py-14 px-6 md:px-10'>
        <div className='mb-10 p-6 bg-[var(--light-gray)] border-l-4 border-[var(--primary)] rounded-r-xl shadow-sm'>
          <h2 className='text-2xl font-bold text-[var(--primary)] mb-3'>Bienvenido a Servineo</h2>
          <p className='text-sm leading-relaxed mb-2'>
            Al acceder y utilizar nuestra plataforma, aceptas estar sujeto a estos términos y
            condiciones.
          </p>
          <p className='text-sm leading-relaxed'>
            Si no estás de acuerdo con alguna parte de estos términos, no debes utilizar nuestros
            servicios.
          </p>
        </div>

        {/* TÉRMINOS INDIVIDUALES */}
        <div className='space-y-10'>
          {[
            {
              index: '1',
              title: 'Uso de la Plataforma',
              content: (
                <>
                  <p>
                    Servineo conecta usuarios con profesionales de servicios verificados. Al
                    utilizar la plataforma, te comprometes a:
                  </p>
                  <ul className='space-y-2 mt-3 ml-2 list-disc list-inside text-sm'>
                    <li>Proporcionar información veraz y actualizada</li>
                    <li>Usar el servicio únicamente para fines legales</li>
                    <li>No suplantar identidades ni crear perfiles falsos</li>
                    <li>Respetar a todos los usuarios y profesionales de la comunidad</li>
                  </ul>
                </>
              ),
            },
            {
              index: '2',
              title: 'Registro y Cuenta de Usuario',
              content: (
                <ul className='space-y-2 text-sm'>
                  <li>Mantener la confidencialidad de tus credenciales</li>
                  <li>Todas las actividades realizadas bajo tu cuenta</li>
                  <li>Notificarnos inmediatamente de cualquier uso no autorizado</li>
                  <li>Actualizar tu información de contacto cuando sea necesario</li>
                </ul>
              ),
            },
            {
              index: '3',
              title: 'Propiedad Intelectual',
              content: (
                <p>
                  Todo el contenido de Servineo, incluyendo textos, logos, gráficos y software, es
                  propiedad de la empresa o de terceros con licencia.
                </p>
              ),
            },
            {
              index: '4',
              title: 'Limitación de Responsabilidad',
              content: (
                <p>
                  Servineo no se hace responsable por daños directos o indirectos derivados del uso
                  de la plataforma.
                </p>
              ),
            },
            {
              index: '5',
              title: 'Modificaciones',
              content: (
                <p>
                  Podemos actualizar estos términos en cualquier momento. Te notificaremos de
                  cambios significativos.
                </p>
              ),
            },
          ].map((term, idx) => (
            <SectionBlock
              key={idx}
              index={term.index}
              title={term.title}
              borderColor='var(--primary)'
            >
              {term.content}
            </SectionBlock>
          ))}
        </div>

        {/* CONTACTO */}
        <div className='mt-16 p-6 bg-[var(--light-gray)] rounded-xl border border-[var(--primary)] shadow-md'>
          <h3 className='text-lg font-bold text-[var(--primary)] mb-2'>Contacto Legal</h3>
          <p className='text-sm mb-2'>Si tienes preguntas sobre estos términos, contáctanos:</p>
          <a
            href='mailto:servineo.serviciostecnicos@gmail.com'
            className='text-[var(--primary)] font-semibold hover:text-[var(--primary)] transition-colors'
          >
            servineo.serviciostecnicos@gmail.com
          </a>
        </div>
      </section>

      {/* FOOTER */}
      <footer className='bg-[var(--primary)] text-white text-center py-8'>
        <p className='text-sm font-medium'>
          Al usar Servineo confirmas que aceptas estos términos. © Servineo 2025
        </p>
      </footer>
    </main>
  );
}

/* COMPONENTES AUXILIARES */
function SectionBlock({ index, title, borderColor, children }: SectionBlockProps) {
  return (
    <div className='pl-5 border-l-4 rounded-lg bg-white p-5 shadow-sm' style={{ borderColor }}>
      <h3 className='text-lg font-bold text-[var(--primary)] mb-3 flex items-center gap-2'>
        <span className='w-8 h-8 bg-[var(--primary)] rounded-full flex items-center justify-center text-white text-sm font-bold'>
          {index}
        </span>
        {title}
      </h3>
      <div className='text-sm text-[var(--foreground)] leading-relaxed'>{children}</div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/info/testimonials/page.tsx">
'use client';
import React from 'react';

export default function TestimonialsPage() {
  const testimonials = [
    {
      name: 'María González',
      role: 'Cliente frecuente',
      service: 'Fontanería',
      rating: 5,
      text: 'Increíble experiencia. El fontanero llegó puntual, trabajó de manera profesional y el precio fue justo. La función del calendario en tiempo real me ahorró muchas llamadas.',
      avatar: 'MG',
    },
    {
      name: 'Carlos Rodríguez',
      role: 'Propietario de negocio',
      service: 'Electricidad',
      rating: 5,
      text: 'Necesitaba un electricista urgente para mi local. Con la video inspección obtuve 3 cotizaciones en menos de 2 horas. Elegí el mejor precio y quedó perfecto.',
      avatar: 'CR',
    },
    {
      name: 'Ana Martínez',
      role: 'Ama de casa',
      service: 'Carpintería',
      rating: 5,
      text: 'El carpintero que contraté a través de Servineo hizo un trabajo excepcional en mis muebles. Me encantó poder ver su disponibilidad antes de agendar.',
      avatar: 'AM',
    },
    {
      name: 'Roberto Silva',
      role: 'Ingeniero',
      service: 'Pintura',
      rating: 4,
      text: 'Plataforma muy intuitiva y profesionales confiables. Contraté un pintor para mi casa y el resultado superó mis expectativas. Definitivamente volveré a usar Servineo.',
      avatar: 'RS',
    },
    {
      name: 'Laura Fernández',
      role: 'Diseñadora',
      service: 'Plomería',
      rating: 5,
      text: 'La verificación de profesionales me dio mucha confianza. El plomero fue muy profesional y resolvió mi problema de fuga en pocas horas. ¡Excelente servicio!',
      avatar: 'LF',
    },
    {
      name: 'Jorge Mendoza',
      role: 'Empresario',
      service: 'Electricidad y Pintura',
      rating: 5,
      text: 'He usado Servineo varias veces para mi oficina. La calidad de los profesionales es consistente y el proceso de agendamiento es súper rápido. Muy recomendado.',
      avatar: 'JM',
    },
  ];

  return (
    <main className='bg-[var(--background)] text-[var(--foreground)] min-h-screen'>
      {/* HERO SECTION */}
      <section className='relative bg-[var(--primary)] text-white py-16 px-6 md:px-12 overflow-hidden shadow-lg'>
        <div className='absolute top-0 right-0 w-80 h-80 bg-[var(--primary)]/20 rounded-full blur-3xl'></div>
        <div className='absolute bottom-0 left-0 w-60 h-60 bg-[var(--primary)]/30 rounded-full blur-2xl'></div>

        <div className='max-w-5xl mx-auto text-center relative z-10'>
          <div className='w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-5'>
            <svg className='w-8 h-8' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
              <path
                strokeLinecap='round'
                strokeLinejoin='round'
                strokeWidth={2}
                d='M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z'
              />
            </svg>
          </div>
          <h1 className='text-4xl md:text-5xl font-extrabold mb-4'>
            Lo que dicen nuestros usuarios
          </h1>
          <p className='text-base opacity-90 max-w-2xl mx-auto'>
            Miles de personas confían en Servineo para conectar con profesionales verificados.
          </p>
        </div>
      </section>

      {/* Grid de testimonios */}
      <section className='max-w-6xl mx-auto py-14 px-6 md:px-10'>
        <div className='grid md:grid-cols-2 gap-6'>
          {testimonials.map((t, i) => (
            <div
              key={i}
              className='bg-[var(--background)] p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-[var(--light-gray)]'
            >
              <div className='flex items-start gap-4 mb-4'>
                <div className='w-12 h-12 bg-[var(--primary)] rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0'>
                  {t.avatar}
                </div>
                <div className='flex-1'>
                  <h3 className='font-bold text-[var(--foreground)] text-base'>{t.name}</h3>
                  <p className='text-xs text-[var(--primary)]'>{t.role}</p>
                  <div className='flex items-center gap-1 mt-1'>
                    {[...Array(t.rating)].map((_, i) => (
                      <svg
                        key={i}
                        className='w-4 h-4 text-yellow-400'
                        fill='currentColor'
                        viewBox='0 0 20 20'
                      >
                        <path d='M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z' />
                      </svg>
                    ))}
                  </div>
                </div>
                <div className='text-right'>
                  <span className='inline-block px-2 py-1 bg-[var(--light-gray)] text-[var(--primary)] text-xs rounded-full font-semibold'>
                    {t.service}
                  </span>
                </div>
              </div>
              <p className='text-sm text-[var(--foreground)] leading-relaxed italic'>
                {'"'}
                {t.text}
                {'"'}
              </p>
              <div className='mt-4 pt-3 border-t border-[var(--light-gray)] flex items-center gap-2 text-xs text-[var(--primary)]'>
                <svg className='w-4 h-4 text-green-500' fill='currentColor' viewBox='0 0 20 20'>
                  <path
                    fillRule='evenodd'
                    d='M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z'
                    clipRule='evenodd'
                  />
                </svg>
                <span>Cliente verificado</span>
              </div>
            </div>
          ))}
        </div>
      </section>

      {/* Call to Action */}
      <section className='bg-[var(--primary)] text-white text-center py-12 px-6'>
        <div className='max-w-4xl mx-auto'>
          <h3 className='text-2xl md:text-3xl font-bold mb-3'>
            ¿Listo para vivir tu propia experiencia?
          </h3>
          <p className='text-base leading-relaxed mb-5 opacity-95'>
            Únete a miles de usuarios satisfechos que ya confían en Servineo para encontrar los
            mejores profesionales verificados.
          </p>
          <button className='bg-white text-[var(--primary)] px-8 py-3 rounded-full font-bold text-base hover:bg-[var(--light-gray)] transition-colors duration-300 shadow-lg hover:shadow-xl'>
            Encuentra tu Profesional
          </button>
        </div>
      </section>
    </main>
  );
}
</file>

<file path="src/app/[locale]/job-offer-list/layout.tsx">
import React from 'react';

export const dynamic = 'force-dynamic';

export default function JobOfertLayout({ children }: { children: React.ReactNode }) {
  return <>{children}</>;
}
</file>

<file path="src/app/[locale]/job-request/ModalFormMap/JobRequestForm.tsx">
'use client';
import React, { useState, useCallback, useMemo, useEffect } from 'react';
import MapJobRequest from './MapJobRequest';
import { JobRequestData, Location, JobRequestFormProps } from '../../../../types/job-request';

const MapJobRequestMemo = React.memo(MapJobRequest);

const JobRequestForm: React.FC<JobRequestFormProps> = ({
  initialLocation,
  loading,
  onSubmit,
  onCancel,
  initialFormData,
}) => {
  const [formData, setFormData] = useState<JobRequestData>(
    initialFormData || {
      jobMotive: '',
      jobDescription: '',
      locationOption: 'keep',
      startTime: '',
      endTime: '',
      suggestedRate: '',
    },
  );

  const [newLocation, setNewLocation] = useState<Location | null>(null);
  const [timeError, setTimeError] = useState<string>('');
  const [fieldErrors, setFieldErrors] = useState<{ [key: string]: string }>({});

  const isFormValid = useMemo(() => {
    return (
      formData.jobMotive.trim() !== '' &&
      formData.jobDescription.trim() !== '' &&
      formData.startTime !== '' &&
      formData.endTime !== '' &&
      !timeError
    );
  }, [
    formData.jobMotive,
    formData.jobDescription,
    formData.startTime,
    formData.endTime,
    timeError,
  ]);

  const currentMapLocation = useMemo(() => {
    if (formData.locationOption === 'modify' && newLocation) {
      return newLocation;
    }
    return initialLocation || { lat: -16.5, lng: -68.15 };
  }, [formData.locationOption, newLocation, initialLocation]);

  const isMapEnabled = formData.locationOption === 'modify';

  const validateTimes = useCallback((start: string, end: string): string => {
    if (!start || !end) return '';

    const startTime = new Date(`2000-01-01T${start}`);
    const endTime = new Date(`2000-01-01T${end}`);

    const minTime = new Date(`2000-01-01T07:00`);
    const maxTime = new Date(`2000-01-01T21:00`);

    if (startTime < minTime || startTime > maxTime) {
      return 'La hora de inicio debe estar entre 7:00 y 21:00';
    }

    if (endTime < minTime || endTime > maxTime) {
      return 'La hora de fin debe estar entre 7:00 y 21:00';
    }

    if (endTime <= startTime) {
      return 'La hora de fin debe ser mayor a la hora de inicio';
    }

    const durationMs = endTime.getTime() - startTime.getTime();
    const durationHours = durationMs / (1000 * 60 * 60);

    if (durationHours < 2) {
      return 'La duración mínima del trabajo es de 2 horas';
    }

    if (durationHours > 8) {
      return 'La duración máxima del trabajo es de 8 horas';
    }

    return '';
  }, []);

  const validateTextOnly = (text: string): string => {
    return text.replace(/[0-9]/g, '');
  };

  const validateDependentFields = useCallback(
    (name: string) => {
      if (name === 'jobDescription' && !formData.jobMotive.trim()) {
        setFieldErrors((prev) => ({
          ...prev,
          jobDescription: 'Primero debe completar el motivo del trabajo',
        }));
      } else {
        setFieldErrors((prev) => ({
          ...prev,
          [name]: '',
        }));
      }
    },
    [formData.jobMotive],
  );

  const handleInputChange = useCallback(
    (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
      const { name, value } = e.target;
      let processedValue = value;

      if (name === 'jobMotive' || name === 'jobDescription') {
        processedValue = validateTextOnly(value);
        validateDependentFields(name);
      }

      setFormData((prev) => ({ ...prev, [name]: processedValue }));
    },
    [validateDependentFields],
  );

  const handleTextAreaFocus = () => {
    if (!formData.jobMotive.trim()) {
      setFieldErrors((prev) => ({
        ...prev,
        jobDescription: 'Primero debe completar el motivo del trabajo',
      }));
      document.getElementById('jobMotive')?.focus();
    }
  };

  useEffect(() => {
    if (formData.startTime && formData.endTime) {
      const error = validateTimes(formData.startTime, formData.endTime);
      setTimeError(error);
    } else {
      setTimeError('');
    }
  }, [formData.startTime, formData.endTime, validateTimes]);

  const handlePositionChange = useCallback((pos: Location) => {
    setNewLocation({ lat: pos.lat, lng: pos.lng });
  }, []);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    if (!formData.jobMotive.trim()) {
      setFieldErrors((prev) => ({ ...prev, jobMotive: 'Este campo es requerido' }));
      return;
    }

    if (!formData.jobDescription.trim()) {
      setFieldErrors((prev) => ({ ...prev, jobDescription: 'Este campo es requerido' }));
      return;
    }

    if (formData.startTime && formData.endTime) {
      const finalError = validateTimes(formData.startTime, formData.endTime);
      if (finalError) {
        setTimeError(finalError);
        return;
      }
    }

    if (!formData.startTime || !formData.endTime) {
      setTimeError('Debe ingresar tanto la hora de inicio como la de fin');
      return;
    }

    onSubmit(formData, newLocation);
  };

  return (
    <form onSubmit={handleSubmit} className='space-y-6'>
      <div>
        <label htmlFor='jobMotive' className='block text-sm font-medium text-gray-700 mb-2'>
          Motivo del trabajo:
        </label>
        <input
          type='text'
          id='jobMotive'
          name='jobMotive'
          value={formData.jobMotive}
          onChange={handleInputChange}
          placeholder='Ingrese el motivo del trabajo...'
          required
          disabled={loading}
          className={`w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 text-gray-900 placeholder-gray-500 ${
            fieldErrors.jobMotive ? 'border-red-500' : 'border-gray-300'
          }`}
        />
        {fieldErrors.jobMotive && (
          <p className='text-red-500 text-xs mt-1'>{fieldErrors.jobMotive}</p>
        )}
      </div>

      <div>
        <label htmlFor='jobDescription' className='block text-sm font-medium text-gray-700 mb-2'>
          Descripción del trabajo:
        </label>
        <textarea
          id='jobDescription'
          name='jobDescription'
          value={formData.jobDescription}
          onChange={handleInputChange}
          onFocus={handleTextAreaFocus}
          placeholder='Describa el trabajo a realizar...'
          required
          disabled={loading || !formData.jobMotive.trim()}
          rows={4}
          className={`w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 text-gray-900 placeholder-gray-500 resize-none ${
            fieldErrors.jobDescription ? 'border-red-500' : 'border-gray-300'
          }`}
        />
        {fieldErrors.jobDescription && (
          <p className='text-red-500 text-xs mt-1'>{fieldErrors.jobDescription}</p>
        )}
        {!formData.jobMotive.trim() && (
          <p className='text-gray-500 text-xs mt-1'>
            Complete primero el motivo del trabajo para habilitar este campo
          </p>
        )}
      </div>

      <fieldset className='border border-gray-300 rounded-md p-4'>
        <legend className='text-sm font-medium text-gray-700 px-2'>Ubicación del trabajo:</legend>
        <div className='space-y-3'>
          <label className='flex items-center'>
            <input
              type='radio'
              name='locationOption'
              value='keep'
              checked={formData.locationOption === 'keep'}
              onChange={handleInputChange}
              disabled={loading}
              className='mr-3'
            />
            <span className='text-sm text-gray-700 font-medium'>
              Mantener la ubicación guardada
            </span>
          </label>
          <label className='flex items-center'>
            <input
              type='radio'
              name='locationOption'
              value='modify'
              checked={formData.locationOption === 'modify'}
              onChange={handleInputChange}
              disabled={loading}
              className='mr-3'
            />
            <span className='text-sm text-gray-700 font-medium'>
              Modificar la ubicación del trabajo
            </span>
          </label>
        </div>
      </fieldset>

      <div>
        <label className='block text-sm font-medium text-gray-700 mb-2'>Mapa de ubicación:</label>
        {loading && !initialLocation ? (
          <div className='flex items-center justify-center h-48 bg-gray-100 rounded-md'>
            <p className='text-gray-500'>Cargando mapa...</p>
          </div>
        ) : (
          <MapJobRequestMemo
            isEnabled={isMapEnabled}
            initialLocationObject={currentMapLocation}
            onPositionChange={handlePositionChange}
          />
        )}
      </div>

      <div>
        <label className='block text-sm font-medium text-gray-700 mb-2'>Disponibilidad:</label>

        <div className='grid grid-cols-1 md:grid-cols-2 gap-4'>
          <div>
            <label htmlFor='startTime' className='block text-sm font-medium text-gray-700 mb-2'>
              De:
            </label>
            <input
              type='time'
              id='startTime'
              name='startTime'
              value={formData.startTime}
              onChange={handleInputChange}
              required
              disabled={loading}
              min='07:00'
              max='21:00'
              className='w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 text-gray-900'
            />
            <p className='text-xs text-gray-500 mt-1'>Entre 7:00 y 21:00</p>
          </div>

          <div>
            <label htmlFor='endTime' className='block text-sm font-medium text-gray-700 mb-2'>
              Hasta:
            </label>
            <input
              type='time'
              id='endTime'
              name='endTime'
              value={formData.endTime}
              onChange={handleInputChange}
              required
              disabled={loading}
              min='07:00'
              max='21:00'
              className='w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 text-gray-900'
            />
            <p className='text-xs text-gray-500 mt-1'>Entre 7:00 y 21:00</p>
          </div>
        </div>
      </div>

      {timeError && (
        <div className='bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded text-sm'>
          {timeError}
        </div>
      )}

      {formData.startTime && formData.endTime && !timeError && (
        <div className='bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded text-sm'>
          Duración: {calculateDuration(formData.startTime, formData.endTime)}
        </div>
      )}

      <div>
        <label htmlFor='suggestedRate' className='block text-sm font-medium text-gray-700 mb-2'>
          Tarifa sugerida (opcional):
        </label>
        <input
          type='number'
          id='suggestedRate'
          name='suggestedRate'
          value={formData.suggestedRate}
          onChange={handleInputChange}
          placeholder='Ingrese una tarifa en bs.'
          disabled={loading}
          className='w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 text-gray-900 placeholder-gray-500'
        />
      </div>

      <div className='flex justify-end space-x-3 pt-4'>
        <button
          type='button'
          onClick={onCancel}
          disabled={loading}
          className='px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50'
        >
          Cancelar
        </button>
        <button
          type='submit'
          disabled={loading || !!timeError || !isFormValid}
          className='px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50'
        >
          {loading ? 'Guardando...' : 'Guardar'}
        </button>
      </div>
    </form>
  );
};

function calculateDuration(startTime: string, endTime: string): string {
  const start = new Date(`2000-01-01T${startTime}`);
  const end = new Date(`2000-01-01T${endTime}`);
  const durationMs = end.getTime() - start.getTime();
  const hours = Math.floor(durationMs / (1000 * 60 * 60));
  const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));

  if (hours === 0) {
    return `${minutes} minutos`;
  } else if (minutes === 0) {
    return `${hours} horas`;
  } else {
    return `${hours} horas y ${minutes} minutos`;
  }
}

export default JobRequestForm;
</file>

<file path="src/app/[locale]/job-request/ModalFormMap/JobRequestModal.tsx">
'use client';
import React, { useState, useEffect } from 'react';
import JobRequestForm from './JobRequestForm';
import { getUserLocation, createJobRequest } from '../../../../services/job-request.modal';
import {
  UserLocation,
  CreateJobRequestPayload,
  JobRequest,
  Location,
  JobRequestData,
  JobRequestModalProps,
} from '../../../../types/job-request';

type TimeInput = { $date: string } | string;

const JobRequestModal: React.FC<JobRequestModalProps> = ({
  isOpen,
  onClose,
  onSubmit,
  fixerId,
  appointmentData,
  offerId,
}) => {
  const [initialLocation, setInitialLocation] = useState<Location | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [formData, setFormData] = useState<JobRequestData>({
    jobMotive: '',
    jobDescription: '',
    locationOption: 'keep',
    startTime: '',
    endTime: '',
    suggestedRate: '',
  });

  const [formInstanceKey, setFormInstanceKey] = useState(0);

  const extractTime = (timeInput: TimeInput): string => {
    const dateString = typeof timeInput === 'object' ? timeInput?.$date : timeInput;

    if (!dateString) return '';

    try {
      const date = new Date(dateString);
      if (Number.isNaN(date.getTime())) return '';

      return date.toLocaleTimeString('es-ES', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false,
      });
    } catch {
      return '';
    }
  };

  const getToken = (): string => {
    if (process.env.NODE_ENV === 'development') {
      return 'development-mock-token';
    }
    if (typeof window !== 'undefined') {
      return localStorage.getItem('auth-token') || 'fallback-mock-token';
    }
    return 'mock-token';
  };

  const getUserIdFromToken = (): string => {
    if (appointmentData) {
      return '68e87a9cdae3b73d8040102f';
    } else {
      return '68ec99ddf39c7c140f42fcfa';
    }
  };

  useEffect(() => {
    if (isOpen) {
      setFormInstanceKey((prev) => prev + 1);
    }
  }, [isOpen, appointmentData?._id]);

  useEffect(() => {
    if (isOpen) {
      const initializeModal = async () => {
        setLoading(true);
        setError('');

        try {
          const authToken = getToken();

          if (!appointmentData) {
            if (authToken) {
              const userLocation: UserLocation = await getUserLocation(authToken);
              const locationForMap: Location = {
                lat: parseFloat(userLocation.lat),
                lng: parseFloat(userLocation.lng),
              };
              setInitialLocation(locationForMap);
            }

            setFormData({
              jobMotive: '',
              jobDescription: '',
              locationOption: 'keep',
              startTime: '',
              endTime: '',
              suggestedRate: '',
            });
          } else {
            let userLocation: UserLocation;
            if (appointmentData.lat && appointmentData.lon) {
              userLocation = {
                lat: appointmentData.lat,
                lng: appointmentData.lon,
              };
            } else if (authToken) {
              userLocation = await getUserLocation(authToken);
            } else {
              userLocation = { lat: '-16.5000', lng: '-68.1500' };
            }

            const locationForMap: Location = {
              lat: parseFloat(userLocation.lat),
              lng: parseFloat(userLocation.lng),
            };
            setInitialLocation(locationForMap);

            const startTime = extractTime(appointmentData.starting_time);
            const endTime = extractTime(appointmentData.finishing_time);

            setFormData({
              jobMotive: appointmentData.appointment_description,
              jobDescription: appointmentData.appointment_description,
              locationOption: 'keep',
              startTime: startTime,
              endTime: endTime,
              suggestedRate: '',
            });
          }
        } catch (err: unknown) {
          setError(err instanceof Error ? err.message : 'Error desconocido');
        } finally {
          setLoading(false);
        }
      };

      initializeModal();
    } else {
      setFormData({
        jobMotive: '',
        jobDescription: '',
        locationOption: 'keep',
        startTime: '',
        endTime: '',
        suggestedRate: '',
      });
    }
  }, [isOpen, appointmentData]);

  const handleFormSubmit = async (formData: JobRequestData, newLocation: Location | null) => {
    const token = getToken();

    const currentUserId = getUserIdFromToken();

    setLoading(true);
    setError('');

    try {
      let finalLocation: { type: 'Point'; coordinates: [string, string] };
      if (formData.locationOption === 'modify' && newLocation) {
        finalLocation = {
          type: 'Point' as const,
          coordinates: [newLocation.lat.toString(), newLocation.lng.toString()] as [string, string],
        };
      } else if (initialLocation) {
        finalLocation = {
          type: 'Point' as const,
          coordinates: [initialLocation.lat.toString(), initialLocation.lng.toString()] as [
            string,
            string,
          ],
        };
      } else {
        throw new Error('No se ha definido una ubicación para el trabajo.');
      }

      let requesterId: string;
      let finalFixerId: string;

      if (!appointmentData) {
        requesterId = currentUserId;
        finalFixerId = fixerId;
      } else {
        requesterId = appointmentData.id_requester;
        finalFixerId = currentUserId;
      }

      if (!requesterId) {
        throw new Error('No se pudo determinar el ID del requester');
      }
      if (!finalFixerId) {
        throw new Error('No se pudo determinar el ID del fixer');
      }

      const payload: CreateJobRequestPayload = {
        title: formData.jobMotive,
        description: formData.jobDescription,
        location: finalLocation,
        startTime: formData.startTime,
        endTime: formData.endTime,
        price: formData.suggestedRate || '0',
        fixerId: finalFixerId,
        requesterId: requesterId,
        appointmentId: appointmentData?._id,
        offerId: offerId,
      };

      const data: JobRequest = await createJobRequest(payload, token);

      window.alert('✅ Trabajo creado exitosamente');

      onSubmit(data);
      onClose();
    } catch (err: unknown) {
      setError(err instanceof Error ? err.message : 'Error desconocido');
    } finally {
      setLoading(false);
    }
  };

  const handleOverlayClick = (e: React.MouseEvent) => {
    if (e.target === e.currentTarget) onClose();
  };

  if (!isOpen) return null;

  return (
    <div
      className='fixed inset-0 bg-white/10 backdrop-blur-sm flex items-center justify-center z-50 p-4'
      onClick={handleOverlayClick}
    >
      <div className='bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden'>
        <div className='bg-blue-600 text-white p-4'>
          <h2 className='text-xl font-bold text-center'>
            {appointmentData ? 'Crear Trabajo desde Cita' : 'Formulario de solicitud'}
          </h2>
        </div>

        <div className='p-6 overflow-y-auto max-h-[calc(90vh-80px)]'>
          {error && (
            <div className='bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4'>
              {error}
            </div>
          )}

          <JobRequestForm
            key={formInstanceKey}
            initialLocation={initialLocation}
            loading={loading}
            onSubmit={handleFormSubmit}
            onCancel={onClose}
            initialFormData={formData}
          />
        </div>
      </div>
    </div>
  );
};

export default JobRequestModal;
</file>

<file path="src/app/[locale]/job-request/ModalFormMap/MapJobRequest.tsx">
'use client';
import React, { useEffect, useRef, useMemo, useState, useCallback } from 'react';
import 'leaflet/dist/leaflet.css';
import { Location } from '../../../../types/job-request';

interface MapJobRequestProps {
  isEnabled: boolean;
  initialLocationObject: Location | null;
  onPositionChange: (position: Location) => void;
}

interface MapMouseEvent {
  latlng: {
    lat: number;
    lng: number;
  };
}

interface LeafletMap {
  setView: (center: [number, number], zoom: number) => void;
  on: (event: string, callback: (e: MapMouseEvent) => void) => void;
  off: (event: string, callback?: (e: MapMouseEvent) => void) => void;
  dragging: { enable: () => void; disable: () => void };
  touchZoom: { enable: () => void; disable: () => void };
  doubleClickZoom: { enable: () => void; disable: () => void };
  scrollWheelZoom: { enable: () => void; disable: () => void };
  boxZoom: { enable: () => void; disable: () => void };
  keyboard: { enable: () => void; disable: () => void };
  remove: () => void;
}

interface LeafletMarker {
  setLatLng: (latlng: [number, number]) => void;
  getLatLng: () => { lat: number; lng: number };
}

const MapJobRequest: React.FC<MapJobRequestProps> = ({
  isEnabled,
  initialLocationObject,
  onPositionChange,
}) => {
  const mapRef = useRef<HTMLDivElement>(null);
  const mapInstanceRef = useRef<LeafletMap | null>(null);
  const markerRef = useRef<LeafletMarker | null>(null);
  const [mapReady, setMapReady] = useState(false);

  const initialPosition = useMemo<[number, number]>(() => {
    if (!initialLocationObject) return [-16.5, -68.15];
    return [initialLocationObject.lat, initialLocationObject.lng];
  }, [initialLocationObject]);

  const handlePositionChange = useCallback(
    (position: Location) => {
      onPositionChange(position);
    },
    [onPositionChange],
  );

  const handleMapClick = useCallback(
    (e: MapMouseEvent) => {
      if (!isEnabled || !markerRef.current) return;

      const { lat, lng } = e.latlng;
      const newPosition: [number, number] = [lat, lng];

      markerRef.current.setLatLng(newPosition);

      handlePositionChange({
        lat: newPosition[0],
        lng: newPosition[1],
      });
    },
    [isEnabled, handlePositionChange],
  );

  const enableMap = useCallback(() => {
    const map = mapInstanceRef.current;

    if (map) {
      try {
        map.dragging.enable();
        map.touchZoom.enable();
        map.doubleClickZoom.enable();
        map.scrollWheelZoom.enable();
        map.boxZoom.enable();
        map.keyboard.enable();

        map.on('click', handleMapClick);

        if (mapRef.current) {
          mapRef.current.style.pointerEvents = 'auto';
          mapRef.current.style.opacity = '1';
          mapRef.current.style.cursor = 'crosshair';
        }
      } catch (error) {
        console.error('Error enabling map:', error);
      }
    }
  }, [handleMapClick]);

  const disableMap = useCallback(() => {
    const map = mapInstanceRef.current;

    if (map) {
      try {
        map.dragging.disable();
        map.touchZoom.disable();
        map.doubleClickZoom.disable();
        map.scrollWheelZoom.disable();
        map.boxZoom.disable();
        map.keyboard.disable();

        map.off('click', handleMapClick);

        if (mapRef.current) {
          mapRef.current.style.pointerEvents = 'none';
          mapRef.current.style.opacity = '0.6';
          mapRef.current.style.cursor = 'not-allowed';
        }
      } catch (error) {
        console.error('Error disabling map:', error);
      }
    }
  }, [handleMapClick]);

  useEffect(() => {
    if (typeof window === 'undefined' || !mapRef.current) return;

    let isMounted = true;

    const initMap = async () => {
      try {
        const L = await import('leaflet');

        if (!isMounted || !mapRef.current) return;

        L.Icon.Default.mergeOptions({
          iconRetinaUrl:
            'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
          iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
          shadowUrl:
            'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        });

        const map = L.map(mapRef.current).setView(initialPosition, 15);
        mapInstanceRef.current = map as unknown as LeafletMap;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors',
        }).addTo(map);

        const marker = L.marker(initialPosition, {
          draggable: false,
        }).addTo(map);
        markerRef.current = marker as unknown as LeafletMarker;

        if (isEnabled) {
          enableMap();
        } else {
          disableMap();
        }

        setMapReady(true);
      } catch (error) {
        console.error('Error initializing map:', error);
      }
    };

    const timer = setTimeout(() => {
      initMap();
    }, 100);

    return () => {
      isMounted = false;
      clearTimeout(timer);

      if (mapInstanceRef.current) {
        try {
          mapInstanceRef.current.off('click', handleMapClick);
          mapInstanceRef.current.remove();
        } catch (error) {
          console.error('Error cleaning up map:', error);
        }
        mapInstanceRef.current = null;
        markerRef.current = null;
      }
      setMapReady(false);
    };
  }, [enableMap, disableMap, handleMapClick, initialPosition, isEnabled]);

  useEffect(() => {
    if (!mapReady || !mapInstanceRef.current || !markerRef.current) return;

    try {
      markerRef.current.setLatLng(initialPosition);
      mapInstanceRef.current.setView(initialPosition, 15);
    } catch (error) {
      console.error('Error updating map position:', error);
    }
  }, [initialPosition, mapReady]);

  useEffect(() => {
    if (!mapReady || !mapInstanceRef.current) return;

    if (isEnabled) {
      enableMap();
    } else {
      disableMap();
    }
  }, [isEnabled, mapReady, enableMap, disableMap]);

  return (
    <div className='space-y-2'>
      <div ref={mapRef} className='h-64 w-full overflow-hidden rounded-md border border-gray-300' />
      {isEnabled && mapReady && (
        <p className='text-xs text-gray-600 text-center'>
          Haz click en cualquier lugar del mapa para colocar el marcador
        </p>
      )}
      {!mapReady && (
        <div className='flex h-64 items-center justify-center text-gray-500'>Cargando mapa...</div>
      )}
    </div>
  );
};

export default MapJobRequest;
</file>

<file path="src/app/[locale]/job-request/page.tsx">
'use client';
import JobRequestModal from './ModalFormMap/JobRequestModal';
import { useState } from 'react';

export default function JobRequestPage() {
  const [isMapModalOpen, setIsMapModalOpen] = useState(false);
  const fakeFixerId = '507f1f77bcf86cd799439011';
  const fakeOfferId = '691488a21fc4811a4400e6ac';
  return (
    <main className='min-h-screen bg-white flex items-center justify-center'>
      <div className='text-center space-y-8'>
        <h1 className='text-3xl sm:text-4xl font-semibold text-gray-900'>
          Detalle de oferta de trabajo
        </h1>
        <div className='flex items-center justify-center gap-4'>
          <button
            onClick={() => setIsMapModalOpen(true)}
            className='px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition'
          >
            Solicitar trabajo
          </button>
        </div>
      </div>
      <JobRequestModal
        isOpen={isMapModalOpen}
        onClose={() => setIsMapModalOpen(false)}
        onSubmit={(data) => console.log('Solicitud enviada:', data)}
        fixerId={fakeFixerId}
        offerId={fakeOfferId}
      />
    </main>
  );
}
</file>

<file path="src/app/[locale]/login/forgotpass/page.tsx">
'use client';
import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { useForm } from 'react-hook-form';
import { z } from 'zod';
import { zodResolver } from '@hookform/resolvers/zod';

// ✅ Validación con Zod
const forgotSchema = z.object({
  email: z
    .string()
    .min(1, 'El correo no puede estar vacío')
    .email('Debe ingresar un correo válido'),
});

type ForgotFormData = z.infer<typeof forgotSchema>;

const BASE_API = `${process.env.NEXT_PUBLIC_API_URL}/api/controlC`;

export default function RecuperacionCorreoPage() {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [serverError, setServerError] = useState<string | null>(null);

  // ✅ React Hook Form con Zod
  const {
    register,
    handleSubmit,
    formState: { errors },
    watch,
  } = useForm<ForgotFormData>({
    resolver: zodResolver(forgotSchema),
  });

  const email = watch('email');

  useEffect(() => {
    if (serverError) {
      const id = setTimeout(() => setServerError(null), 5000);
      return () => clearTimeout(id);
    }
  }, [serverError]);

  //  Lógica del envío (mantiene todo igual)
  const handleEnviar = async (data: ForgotFormData) => {
    setServerError(null);
    setLoading(true);

    const fallback = setTimeout(() => setServerError('Estamos tardando más de lo normal…'), 3000);

    try {
      const res = await fetch(`${BASE_API}/auth/forgot-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: data.email }),
      });
      const responseData = await res.json();

      if (res.ok && responseData.success) {
        if (typeof window !== 'undefined') {
          sessionStorage.setItem('servineo_last_email', data.email);
        }
        router.push('/login/forgotpass/resend');
      } else if (res.status === 404) {
        setServerError('El correo no está asociado a ninguna cuenta.');
      } else if (res.status === 429) {
        setServerError('Ya existe una solicitud en curso. Intenta nuevamente en 1 minuto.');
      } else {
        setServerError(responseData.message || 'Error al solicitar el enlace.');
      }
    } catch {
      setServerError('Error de conexión con el servidor.');
    } finally {
      clearTimeout(fallback);
      setLoading(false);
    }
  };

  const emailValid = !errors.email && !!email;

  return (
    <main className='relative min-h-screen flex items-center justify-center px-6 text-foreground'>
      {/* Fondo ultra sutil */}
      <div className='pointer-events-none absolute inset-0 -z-10'>
        <div className='absolute inset-0 bg-background' />
        <div className='absolute inset-0 bg-gradient-to-br from-primary/[0.03] via-transparent to-transparent' />
        <div className="absolute inset-0 opacity-[0.015] bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMCAwaDIwdjIwSDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTAgMGgyMHYyMEgweiIgZmlsbD0iIzAwMCIgZmlsbC1vcGFjaXR5PSIwLjA1IiBmaWxsLXJ1bGU9ImV2ZW5vZGQiLz48L3N2Zz4=')]" />
      </div>

      <div className='w-full max-w-sm bg-card/95 backdrop-blur-sm rounded-3xl shadow-lg p-8 border border-border/70'>
        <h1 className='text-2xl font-semibold mb-2 bg-gradient-to-r from-primary/80 to-primary/60 bg-clip-text text-transparent'>
          Recuperación de acceso
        </h1>
        <p className='text-sm text-muted-foreground mb-6'>
          Te enviaremos un correo electrónico con un enlace para ingresar a tu cuenta.
        </p>

        {/* ✅ Form con React Hook Form */}
        <form onSubmit={handleSubmit(handleEnviar)} className='flex flex-col gap-4'>
          <label htmlFor='email' className='text-sm font-medium text-foreground/80'>
            Correo electrónico
          </label>
          <input
            id='email'
            type='email'
            placeholder='Ingresa tu correo'
            {...register('email')}
            className={`w-full rounded-xl p-3.5 text-foreground bg-background border ${
              errors.email || serverError
                ? 'border-destructive focus:ring-destructive/30'
                : 'border-border focus:ring-primary/40 focus:border-primary/40'
            } focus:outline-none focus:ring-2 transition`}
            aria-invalid={!!errors.email || !!serverError}
            aria-describedby={errors.email ? 'email-error' : undefined}
            autoComplete='email'
          />

          {/* Errores de validación */}
          {errors.email && (
            <p
              id='email-error'
              role='status'
              aria-live='polite'
              className='text-sm text-destructive'
            >
              {errors.email.message}
            </p>
          )}

          {/* Errores del servidor */}
          {serverError && !errors.email && (
            <p
              id='server-error'
              role='status'
              aria-live='polite'
              className='text-sm text-destructive'
            >
              {serverError}
            </p>
          )}

          <button
            type='submit'
            disabled={!emailValid || loading}
            className={`w-full font-semibold rounded-xl p-3.5 mt-2 transition-all duration-300
              ${
                !emailValid || loading
                  ? 'bg-primary/30 text-primary-foreground/70 cursor-not-allowed shadow-none'
                  : 'bg-primary hover:bg-primary/90 text-primary-foreground shadow-sm hover:shadow'
              }`}
          >
            {loading ? 'Enviando...' : 'Enviar correo electrónico'}
          </button>
        </form>

        <div className='mt-6 text-center text-sm text-muted-foreground'>
          <Link href='/login' className='text-primary hover:underline font-medium'>
            Volver al inicio de sesión
          </Link>
        </div>
      </div>
    </main>
  );
}
</file>

<file path="src/app/[locale]/login/forgotpass/resend/page.tsx">
import { z } from 'zod';
import ClientView from '@/Components/login/ClientResend';

// ✅ Esquema de validación Zod para los searchParams
const SearchParamsSchema = z.object({
  email: z.string().email().optional(),
  token: z.string().min(1, 'Token inválido').optional(),
});

type SearchParams = Record<string, string | string[] | undefined>;

export default async function Page({ searchParams }: { searchParams: Promise<SearchParams> }) {
  const sp = await searchParams;

  // ✅ Validación segura con Zod
  const parsed = SearchParamsSchema.safeParse({
    email: typeof sp.email === 'string' ? sp.email : undefined,
    token: typeof sp.token === 'string' ? sp.token : undefined,
  });

  // Si algo no cumple con el esquema, se ignora el valor (sin romper la UI)
  const email = parsed.success ? parsed.data.email : undefined;
  const token = parsed.success ? parsed.data.token : undefined;

  return (
    <main className='relative min-h-screen flex items-center justify-center px-6 text-foreground'>
      {/* Fondo ultra sutil (idéntico al resto de pantallas) */}
      <div className='pointer-events-none absolute inset-0 -z-10'>
        <div className='absolute inset-0 bg-background' />
        <div className='absolute inset-0 bg-gradient-to-br from-primary/[0.03] via-transparent to-transparent' />
        <div className="absolute inset-0 opacity-[0.015] bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMCAwaDIwdjIwSDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTAgMGgyMHYyMEgweiIgZmlsbD0iIzAwMCIgZmlsbC1vcGFjaXR5PSIwLjA1IiBmaWxsLXJ1bGU9ImV2ZW5vZGQiLz48L3N2Zz4=')]" />
      </div>

      <div className='w-full max-w-md bg-card/95 backdrop-blur-sm rounded-3xl shadow-lg overflow-hidden border border-border/70'>
        {/* Header de confirmación */}
        <div className='bg-gradient-to-r from-primary to-primary/90 p-6'>
          <div className='flex items-center gap-3 text-primary-foreground'>
            <span className='inline-flex items-center justify-center w-10 h-10 rounded-full bg-primary-foreground/10 ring-1 ring-primary-foreground/25'>
              <svg
                className='w-6 h-6'
                viewBox='0 0 24 24'
                fill='none'
                stroke='currentColor'
                strokeWidth={2}
                strokeLinecap='round'
                strokeLinejoin='round'
                aria-hidden='true'
              >
                <path d='M20 6L9 17l-5-5' />
              </svg>
            </span>
            <div>
              <h1 className='text-xl font-semibold leading-6'>¡Enlace enviado!</h1>
              <p className='text-primary-foreground/90 text-sm'>
                {email ? (
                  <>
                    Revisa <span className='font-medium'>{maskEmail(email)}</span> para continuar.
                  </>
                ) : (
                  'Revisa tu correo registrado para continuar.'
                )}
              </p>
            </div>
          </div>
        </div>

        {/* Cuerpo (botón de reenviar) */}
        <div className='p-6'>
          <ClientView email={email} token={token} />
        </div>
      </div>
    </main>
  );
}

// ✅ Enmascara el correo de forma segura
function maskEmail(email: string) {
  const [user, domain] = email.split('@');
  if (!user || !domain) return email;
  if (user.length <= 2) return user[0] + '***@' + domain;
  return user.slice(0, 2) + '*****@' + domain;
}
</file>

<file path="src/app/[locale]/login/forgotpass/verify/page.tsx">
import { z } from 'zod';
import ClientVerify from '@/Components/login/ClientVerify';

const SearchParamsSchema = z.object({
  token: z.string().min(1, 'Token inválido').optional(),
});

type SearchParams = Record<string, string | string[] | undefined>;

export default async function VerifyPage({
  searchParams,
}: {
  searchParams: Promise<SearchParams>;
}) {
  const sp = await searchParams;

  // ✅ Validación segura con Zod
  const parsed = SearchParamsSchema.safeParse({
    token: typeof sp.token === 'string' ? sp.token : undefined,
  });

  const token = parsed.success ? parsed.data.token : undefined;

  return (
    <main className='relative min-h-screen flex items-center justify-center px-6 text-foreground'>
      {/* Fondo ultra sutil */}
      <div className='pointer-events-none absolute inset-0 -z-10'>
        <div className='absolute inset-0 bg-background' />
        <div className='absolute inset-0 bg-gradient-to-br from-primary/[0.03] via-transparent to-transparent' />
        <div className="absolute inset-0 opacity-[0.015] bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMCAwaDIwdjIwSDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTAgMGgyMHYyMEgweiIgZmlsbD0iIzAwMCIgZmlsbC1vcGFjaXR5PSIwLjA1IiBmaWxsLXJ1bGU9ImV2ZW5vZGQiLz48L3N2Zz4=')]" />
      </div>

      <div className='bg-card/95 backdrop-blur-sm rounded-3xl shadow-lg p-8 text-center max-w-sm w-full border border-border/70'>
        <h1 className='text-xl font-semibold mb-4 bg-gradient-to-r from-primary/80 to-primary/60 bg-clip-text text-transparent'>
          Verificación
        </h1>
        {/* Lógica de navegador en el componente cliente */}
        <ClientVerify token={token} />
      </div>
    </main>
  );
}
</file>

<file path="src/app/[locale]/login/page.tsx">
'use client';
import { useState, useEffect, useMemo } from 'react';
import { useForm } from 'react-hook-form';
import { z } from 'zod';
import { zodResolver } from '@hookform/resolvers/zod';
import { api, ApiResponse } from '@/app/redux/services/loginApi';
import { Eye, EyeOff } from 'lucide-react';
import LoginGoogle from '@/Components/login/Proveedores/LoginGoogle';
import { useRouter } from 'next/navigation';
import NotificationModal from '@/Components/Modal-notifications';
import { GoogleOAuthProvider } from '@react-oauth/google';
import { useTranslations } from 'next-intl';
import { useAppDispatch } from '@/app/redux/hooks';
import { setUser } from '@/app/redux/slice/userSlice';
import LoginGithub from '@/Components/login/Proveedores/LoginGitHub';
import LoginDiscord from '@/Components/login/Proveedores/LoginDiscord';
// Nuevos modales para 2FA / selección de método
import OpcionesLoginModal from '@/Components/login/SeleccionMetodoModal';
import AuthenticatorSesion from '@/Components/requester/Authenticator/AuthenticatorSesionModal';
import AuthenticatorTOTPModal from '@/Components/requester/Authenticator/AuthenticatorTOTPModal';
import CodigoRecuperacionModal from '@/Components/requester/Authenticator/AuthenticatorCodigoModal';

/* ----------------------------- Interfaces ----------------------------- */
interface LoginFormData {
  email: string;
  password: string;
}

interface BackendUser {
  name: string;
  id?: string;
  _id?: string;
  email?: string;
  picture?: string;
  url_photo?: string;
  displayName?: string;
  [key: string]: unknown;
  role?: string;
}

interface LoginResponse {
  token: string;
  user: BackendUser;
  message?: string;
  // propiedades opcionales que el backend puede devolver para MFA
  requires2FA?: boolean;
  mfaRequired?: boolean;
  mfaMethods?: string[];
  email?: string;
}

interface NotificationState {
  isOpen: boolean;
  type: 'success' | 'error' | 'info' | 'warning';
  title: string;
  message: string;
}

/* ------------------------------ Component ----------------------------- */
export default function LoginPage() {
  const t = useTranslations('Login');
  const [mostrarPass, setMostrarPass] = useState<boolean>(false);
  const [loading, setLoading] = useState<boolean>(false);
  const router = useRouter();
  const dispatch = useAppDispatch();

  // ✅ Schema de Zod usando useMemo para que no se recree en cada render
  const loginSchema = useMemo(
    () =>
      z.object({
        email: z.string().email(t('errors.invalidEmail')),
        password: z.string().min(6, t('errors.passwordMinLength')),
      }),
    [t],
  );

  const [notification, setNotification] = useState<NotificationState>({
    isOpen: false,
    type: 'info',
    title: '',
    message: '',
  });

  // Estado para los nuevos modales de autenticación/métodos
  const [modalActivo, setModalActivo] = useState<
    'none' | 'opciones' | 'sesion' | 'totp' | 'codigo'
  >('none');
  const [emailTOTP, setEmailTOTP] = useState('');

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<LoginFormData>({
    resolver: zodResolver(loginSchema),
  });

  const manejarLogin = async (data: LoginFormData): Promise<void> => {
    setLoading(true);
    try {
      const res: ApiResponse<LoginResponse> = await api.post('/login', data);

      if (res.success && res.data) {
        const datos = res.data;

        const normalizedUser = {
          ...datos.user,
          _id: (datos.user._id || datos.user.id) as string,
          id: (datos.user.id || datos.user._id) as string,
          name: (datos.user.name || datos.user.displayName || 'Usuario') as string,
          email: datos.user.email as string,
          url_photo: (datos.user.picture || datos.user.url_photo || null) as string | undefined,
          role: (datos.user.role || 'requester') as 'requester' | 'fixer' | 'admin',
        };
        // Detectar si el backend requiere MFA/2FA y abrir los modales correspondientes
        const needs2FA = Boolean(
          datos.requires2FA ||
          datos.mfaRequired ||
          (datos.mfaMethods && datos.mfaMethods.length > 0),
        );

        if (needs2FA) {
          const emailFor2FA = datos.email || datos.user?.email || data.email;
          setEmailTOTP(emailFor2FA ?? '');

          const methods = datos.mfaMethods || [];

          if (methods.includes('passwordless') || methods.includes('session')) {
            setModalActivo('sesion');
          } else if (
            methods.includes('totp') ||
            methods.includes('otp') ||
            methods.includes('totp_sms')
          ) {
            setModalActivo('totp');
          } else {
            setModalActivo('opciones');
          }

          setNotification({
            isOpen: true,
            type: 'info',
            title: 'Verificación adicional requerida',
            message: datos.message || 'Se requiere un paso adicional para verificar tu cuenta.',
          });

          // No guardar token/localStorage hasta completar el flujo de MFA
          return;
        }

        // Si no requiere 2FA, proceder normalmente
        if (datos.token) {
          localStorage.setItem('servineo_token', datos.token);
        }
        localStorage.setItem('servineo_user', JSON.stringify(normalizedUser));

        dispatch(setUser(normalizedUser));

        const mensajeExito = datos.message || t('success.welcome', { name: normalizedUser.name });

        setNotification({
          isOpen: true,
          type: 'success',
          title: t('success.title'),
          message: mensajeExito,
        });

        setTimeout(() => {
          window.location.href = '/';
        }, 1500);
      } else {
        const mensajeError =
          res.message ||
          (res.data as unknown as { message?: string })?.message ||
          (res as unknown as { error?: string })?.error ||
          t('errors.invalidCredentials');

        setNotification({
          isOpen: true,
          type: 'error',
          title: t('errors.loginError'),
          message: mensajeError,
        });
      }
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : t('errors.connectionError');
      setNotification({
        isOpen: true,
        type: 'error',
        title: t('errors.connectionErrorTitle'),
        message,
      });
    } finally {
      setLoading(false);
    }
  };

  const handleMensajeChange = (mensaje: string): void => {
    setNotification({
      isOpen: true,
      type: 'error',
      title: t('errors.googleError'),
      message: mensaje,
    });
  };

  useEffect(() => {
    const handleMessage = (event: MessageEvent) => {
      try {
        const apiUrl = process.env.NEXT_PUBLIC_API_URL;
        if (!apiUrl) return;

        const apiOrigin = new URL(apiUrl).origin;
        if (event.origin !== apiOrigin) return;

        const data = event.data || {};
        const { type, token, user, message } = data;

        if (type === 'GITHUB_AUTH_SUCCESS') {
          if (token && user) {
            localStorage.setItem('servineo_token', token);
            localStorage.setItem('servineo_user', JSON.stringify(user));

            const nombre = (user as { name?: string }).name || 'Usuario';

            setNotification({
              isOpen: true,
              type: 'success',
              title: 'Inicio de sesión exitoso',
              message: `¡Bienvenido, ${nombre}!`,
            });

            setTimeout(() => {
              window.location.href = '/';
            }, 1500);
          } else {
            setNotification({
              isOpen: true,
              type: 'error',
              title: 'Error al iniciar sesión',
              message: 'Respuesta inválida desde GitHub. Inténtalo nuevamente.',
            });
          }
        }

        if (type === 'GITHUB_AUTH_ERROR') {
          setNotification({
            isOpen: true,
            type: 'error',
            title: 'Error al iniciar sesión',
            message: message || 'No se pudo iniciar sesión con GitHub.',
          });
        }
      } catch (err) {
        console.error('Error procesando mensaje de GitHub:', err);
      }
    };

    window.addEventListener('message', handleMessage);
    return () => window.removeEventListener('message', handleMessage);
  }, []);

  // 🔹 Manejo de login con Discord (redirect a /login?provider=discord&code=...)
  useEffect(() => {
    if (typeof window === 'undefined') return;

    const search = window.location.search;
    const params = new URLSearchParams(search);
    const provider = params.get('provider');
    const code = params.get('code');
    const error = params.get('error');

    // Solo nos interesa cuando viene de Discord
    if (provider !== 'discord') return;

    if (error) {
      setNotification({
        isOpen: true,
        type: 'error',
        title: 'Error de autenticación',
        message: error,
      });
      window.history.replaceState({}, '', '/login');
      return;
    }

    if (!code) return;

    const loginDiscord = async () => {
      try {
        setLoading(true);

        const res: ApiResponse<LoginResponse> = await api.post('/login/discord', { code });

        if (res.success && res.data) {
          const datos = res.data;

          localStorage.setItem('servineo_token', datos.token);
          localStorage.setItem('servineo_user', JSON.stringify(datos.user));

          const mensajeExito = datos.message || `¡Bienvenido, ${datos.user.name}!`;

          setNotification({
            isOpen: true,
            type: 'success',
            title: 'Inicio de sesión exitoso',
            message: mensajeExito,
          });

          // limpiar parámetros de la URL
          window.history.replaceState({}, '', '/login');

          setTimeout(() => {
            window.location.href = '/';
          }, 1500);
        } else {
          const mensajeError =
            res.message ||
            (res.data as unknown as { message?: string })?.message ||
            (res as unknown as { error?: string })?.error ||
            'No se pudo iniciar sesión con Discord.';

          setNotification({
            isOpen: true,
            type: 'error',
            title: 'Error al iniciar sesión',
            message: mensajeError,
          });

          window.history.replaceState({}, '', '/login');
        }
      } catch (err: unknown) {
        console.error('[LOGIN] Error en loginDiscord:', err);
        const message = err instanceof Error ? err.message : 'No se pudo conectar con el servidor.';
        setNotification({
          isOpen: true,
          type: 'error',
          title: 'Error de conexión',
          message,
        });
      } finally {
        setLoading(false);
      }
    };

    loginDiscord();
  }, []);

  return (
    <GoogleOAuthProvider clientId={process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID!}>
      <main className='relative min-h-screen flex items-center justify-center px-6 text-foreground'>
        {/* Fondo ultra sutil */}
        <div className='pointer-events-none absolute inset-0 -z-10'>
          <div className='absolute inset-0 bg-background' />
          <div className='absolute inset-0 bg-gradient-to-br from-primary/5 via-transparent to-transparent' />
          <div className="absolute inset-0 opacity-[0.02] bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMCAwaDIwdjIwSDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTAgMGgyMHYyMEgweiIgZmlsbD0iIzAwMCIgZmlsbC1vcGFjaXR5PSIwLjA1IiBmaWxsLXJ1bGU9ImV2ZW5vZGQiLz48L3N2Zz4=')]" />
        </div>

        {/* Card de Login */}
        <div className='w-full max-w-sm bg-card/95 backdrop-blur-sm rounded-3xl shadow-lg p-10 border border-border/70'>
          <h1 className='text-3xl font-bold text-center mb-2 bg-gradient-to-r from-primary/80 to-primary/60 bg-clip-text text-transparent'>
            {t('title')} <span className='sr-only'>Servineo</span>
          </h1>
          <p className='text-center text-sm text-muted-foreground mb-8'>{t('mode')}</p>

          {/* Formulario */}
          <form onSubmit={handleSubmit(manejarLogin)} className='flex flex-col gap-5'>
            {/* Correo */}
            <div>
              <label className='block text-sm font-semibold text-foreground/80 mb-2'>
                {t('form.email.label')}*
              </label>
              <input
                type='email'
                placeholder={t('form.email.placeholder')}
                {...register('email')}
                className='w-full rounded-xl p-3.5 text-foreground bg-background border border-border
                           focus:outline-none focus:ring-2 focus:ring-primary/40 focus:border-primary/40 transition'
                autoComplete='email'
              />
              {errors.email && <p className='text-red-500 text-sm mt-1'>{errors.email.message}</p>}
            </div>

            {/* Contraseña */}
            <div>
              <label className='block text-sm font-semibold text-foreground/80 mb-2'>
                {t('form.password.label')}*
              </label>
              <div className='relative'>
                <input
                  type={mostrarPass ? 'text' : 'password'}
                  placeholder={t('form.password.placeholder')}
                  {...register('password')}
                  className='w-full rounded-xl p-3.5 pr-10 text-foreground bg-background border border-border
                             focus:outline-none focus:ring-2 focus:ring-primary/40 focus:border-primary/40 transition'
                  autoComplete='current-password'
                />
                <button
                  type='button'
                  onClick={() => setMostrarPass(!mostrarPass)}
                  className='absolute inset-y-0 right-3 flex items-center text-muted-foreground hover:text-primary/80 transition'
                  aria-label={mostrarPass ? t('aria.hidePassword') : t('aria.showPassword')}
                >
                  {mostrarPass ? <EyeOff size={20} /> : <Eye size={20} />}
                </button>
              </div>
              {errors.password && (
                <p className='text-red-500 text-sm mt-1'>{errors.password.message}</p>
              )}
            </div>

            {/* 🆕 UN SOLO BOTÓN que abre el modal de opciones */}
            <p className='text-center text-sm text-muted-foreground'>
              <button
                type='button'
                onClick={() => setModalActivo('opciones')}
                className='text-primary/90 hover:text-primary font-medium hover:underline transition'
              >
                {t('links.forgotPassword')}
              </button>
            </p>

            {/* Botón ingresar */}
            <button
              type='submit'
              disabled={loading}
              className='w-full rounded-xl p-3.5 mt-2 font-semibold text-primary-foreground
                         bg-primary/90 hover:bg-primary transition-all duration-300
                         shadow-sm hover:shadow disabled:opacity-60'
            >
              {loading ? t('buttons.loading') : t('buttons.login')}
            </button>
          </form>

          {/* Separador */}
          <div className='flex items-center my-8'>
            <div className='flex-1 h-px bg-border/70' />
            <span className='px-2 text-muted-foreground text-sm'>{t('separator')}</span>
            <div className='flex-1 h-px bg-border/70' />
          </div>

          {/* Botón Google */}
          <div className='flex flex-col items-center gap-3 mt-4'>
            <LoginGoogle onMensajeChange={handleMensajeChange} />

            {/* Botón GitHub */}
            <LoginGithub onMensajeChange={handleMensajeChange} />

            {/* Botón Discord */}
            <LoginDiscord onMensajeChange={handleMensajeChange} />
          </div>

          {/* Registro */}
          <p className='mt-8 text-center text-sm text-muted-foreground'>
            {t('links.noAccount')}{' '}
            <button
              onClick={() => router.push('../signUp')}
              className='text-primary/90 hover:text-primary font-medium underline-offset-2 hover:underline'
            >
              {t('links.register')}
            </button>
          </p>
        </div>

        {/* 🔔 Notificación personalizada */}
        <NotificationModal
          isOpen={notification.isOpen}
          onClose={() => setNotification({ ...notification, isOpen: false })}
          type={notification.type}
          title={notification.title}
          message={notification.message}
        />
        {/* 🆕 MODAL DE OPCIONES */}
        <OpcionesLoginModal
          showModal={modalActivo === 'opciones'}
          onClose={() => setModalActivo('none')}
          onSelectForgotPassword={() => router.push('/login/forgotpass')}
          onSelectPasswordless={() => setModalActivo('sesion')}
        />

        {/* Modal Sesión */}
        {modalActivo === 'sesion' && (
          <AuthenticatorSesion
            showModal={true}
            setShowModal={() => setModalActivo('none')}
            emailTOTP={emailTOTP}
            setEmailTOTP={setEmailTOTP}
            abrirTOTP={() => setModalActivo('totp')}
          />
        )}

        {/* Modal TOTP */}
        {modalActivo === 'totp' && (
          <AuthenticatorTOTPModal
            showModal={true}
            setShowModal={() => setModalActivo('none')}
            regresarSesionModal={() => setModalActivo('sesion')}
            email={emailTOTP}
            abrirModalCodigo={() => setModalActivo('codigo')}
          />
        )}

        {/* Modal Código de recuperación */}
        {modalActivo === 'codigo' && (
          <CodigoRecuperacionModal
            showModal={true}
            cerrarModal={() => setModalActivo('none')}
            volverATOTP={() => setModalActivo('totp')}
            email={emailTOTP}
          />
        )}
      </main>
    </GoogleOAuthProvider>
  );
}
</file>

<file path="src/app/[locale]/payment/centro-de-pagos/page.tsx">
'use client'; 

// src/app/payment/pages/centro-de-pagos/page.tsx

import { Suspense } from 'react';
import { Loader2 } from 'lucide-react';

// 1. Importa tu componente (asegúrate que la ruta sea correcta)
import CentroPagos from '../../../../Components/payment/CentroPagos';

// 2. Crea un componente de Carga (Fallback)
function LoadingFallback() {
  return (
    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
      <div className="text-center">
        <Loader2 className="animate-spin text-blue-600 mx-auto mb-4" size={48} />
        <p className="text-gray-600">Cargando Centro de Pagos...</p>
      </div>
    </div>
  );
}

// 3. Esta es tu nueva página (un Server Component)
export default function CentroDePagosPage() {
  return (
    // 4. Envuelve tu componente cliente en <Suspense>
    <Suspense fallback={<LoadingFallback />}>
      <CentroPagos />
    </Suspense>
  );
}
</file>

<file path="src/app/[locale]/payment/components/AddCardModal.tsx">
'use client';
import { useState, useEffect } from 'react';
import { CardElement, useStripe, useElements } from '@stripe/react-stripe-js';
import { motion, AnimatePresence } from 'framer-motion';

// --- INICIO DE LA CORRECCIÓN ---

// 1. Define un tipo para el payload de 'onCardAdded'
interface OnCardAddedPayload {
  payment: {
    _id: string;
    amount: number;
    card: { _id: string } | null;
  };
  cardSaved: boolean;
}

// 2. Define la interfaz para las props de ESTE modal (AddCardModal)
interface AddCardModalProps {
  userId: string;
  fixerId: string;
  jobId: string;
  amount: number;
  onClose: () => void;
  onCardAdded: (payload: OnCardAddedPayload) => void;
}
// --- FIN DE LA CORRECCIÓN ---


// 3. APLICA LA INTERFAZ Y DESESTRUCTURA LAS PROPS
export default function AddCardModal({
  userId,
  fixerId,
  jobId,
  amount,
  onClose,
  onCardAdded
}: AddCardModalProps) { // <-- ESTA LÍNEA ES LA CORRECTA

  const stripe = useStripe();
  const elements = useElements();
  const [saveCard, setSaveCard] = useState(false);
  const [loading, setLoading] = useState(false);
  const [errorMessage, setErrorMessage] = useState('');
  const [cardHolder, setCardHolder] = useState('');
  const [isValidHolder, setIsValidHolder] = useState(false);
  const [successMessage, setSuccessMessage] = useState('');


  const handleCardHolderChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    // Permite solo letras, tildes y espacios
    const cleanValue = value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '');
    setCardHolder(cleanValue);
    setIsValidHolder(/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]{3,50}$/.test(cleanValue.trim()));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!stripe || !elements) {
      setErrorMessage('Stripe aún no está listo, espera unos segundos.');
      return;
    }
    if (!isValidHolder) {
      setErrorMessage('Nombre de titular inválido.');
      return;
    }

    setLoading(true);
    setErrorMessage('');
    const cardElement = elements.getElement(CardElement);
    if (!cardElement) {
      setErrorMessage('No se pudo obtener la tarjeta. Recarga la página e inténtalo de nuevo.');
      setLoading(false);
      return;
    }

    try {
      const { error, paymentMethod } = await stripe.createPaymentMethod({
        type: 'card',
        card: cardElement,
        billing_details: { name: cardHolder },
      });
      if (error) throw new Error(error.message);

      let cardId = null;
      if (saveCard) {
        const cardRes = await fetch(`${process.env.NEXT_PUBLIC_BACKEND_URL}/api/cardscreate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId, // <-- Ahora 'userId' SÍ existe
            paymentMethodId: paymentMethod.id,
            saveCard,
            cardholderName: cardHolder,
          }),
        });
        const savedCard = await cardRes.json();
        if (!cardRes.ok) throw new Error(savedCard.error || 'Error al guardar la tarjeta');
        cardId = savedCard._id;
      }

      const paymentRes = await fetch(`${process.env.NEXT_PUBLIC_BACKEND_URL}/api/createpayment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          requesterId: userId, // <-- 'userId' SÍ existe
          fixerId,
          jobId,
          cardId: cardId || null,
          paymentMethodId: saveCard ? undefined : paymentMethod.id,
          amount,
        }),
      });
      const paymentData = await paymentRes.json();
      if (!paymentRes.ok) throw new Error(paymentData.error || 'Error al crear el pago');

      onCardAdded({
        payment: {
          _id: paymentData.payment._id,
          amount: paymentData.payment.amount,
          card: cardId ? { _id: cardId } : null,
        },
        cardSaved: saveCard,
      });

      cardElement.clear();
      setCardHolder('');
      setSuccessMessage(
        saveCard ? 'Pago realizado exitosamente y tarjeta guardada' : 'Pago realizado exitosamente',
      );

      setTimeout(() => {
        setSuccessMessage('');
        onClose();
      }, 2000);

    } catch (err: unknown) {
      console.error(err);
      if (err instanceof Error) {
        setErrorMessage(err.message);
      } else {
        setErrorMessage('Ocurrió un error inesperado.');
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-50">
      <motion.div
        initial={{ scale: 0.8, opacity: 0 }}
        animate={{ scale: 1, opacity: 1 }}
        exit={{ scale: 0.8, opacity: 0 }}
        className="bg-[#2B6AE0] text-black p-6 rounded-2xl shadow-2xl w-96 relative"
      >
        <h2 className="text-xl font-bold mb-3 text-center"> Agregar nueva tarjeta</h2>
        <p className="text-center mb-4 text-black">
          Monto a pagar: <strong className="text-[#2BDDE0]">{amount} BOB</strong>
        </p>

        {errorMessage && (
          <div className="bg-red-500/20 border border-red-500 text-red-300 p-2 mb-4 rounded-md text-sm text-center">
            {errorMessage}
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block mb-2 text-sm font-semibold text-black">
              Nombre de titular*
            </label>
            <input
              type="text"
              value={cardHolder}
              onChange={handleCardHolderChange}
              placeholder="Ej: Juan Pérez"
              className="w-full bg-[#E5E7EB] border-gray-200 rounded-xl px-3 py-2 text-black outline-none"
              required
            />
          </div>

          <div className="p-3 rounded-xl bg-[#E5E7EB] border text-black border-gray-700">
            <CardElement
              options={{
                hidePostalCode: true,
                style: {
                  base: {
                    fontSize: '16px',
                    color: '#000', // <-- texto negro
                    '::placeholder': { color: '#888' },
                  },
                  invalid: { color: '#ff6b6b' },
                },
              }}
            />
          </div>

          <label className="flex items-center gap-2 text-sm text-black mt-2">
            <input
              type="checkbox"
              checked={saveCard}
              onChange={(e) => setSaveCard(e.target.checked)}
              className="accent-blue-500"
            />
            Guardar tarjeta para futuros pagos
          </label>

          <div className="flex justify-between mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-4 py-2 bg-[#D1D5DB] hover:bg-[#2BDDE0] rounded-xl transition-all"
            >
              Cancelar
            </button>
            <button
              type="submit"
              disabled={!stripe || loading || !isValidHolder}
              className={`px-5 py-2 rounded-xl font-semibold transition-all ${!stripe || loading || !isValidHolder
                ? 'bg-[#D1D5DB] cursor-not-allowed'
                : 'bg-[#D1D5DB] hover:bg-[#2BDDE0]'
                }`}
            >
              {loading ? 'Procesando...' : 'Pagar'}
            </button>
          </div>
        </form>
      </motion.div>

      {/* Modal de éxito */}
      <AnimatePresence>
        {successMessage && (
          <motion.div
            initial={{ opacity: 0, y: -20 }}
            animate={{ opacity: 1, y: 0, transition: { duration: 0.8, ease: 'easeOut' } }}
            exit={{ opacity: 0, y: -20, transition: { duration: 0.6, ease: 'easeIn' } }}
            className="absolute top-10 bg-[#2BDDE0] text-white px-6 py-3 rounded-xl shadow-xl text-center"
          >
            {successMessage}
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}
</file>

<file path="src/app/[locale]/payment/components/BackButton.tsx">
"use client";
import { useRouter } from "next/navigation";

export default function BackButton({
  fallback = "/payments",
  className = "",
}: { fallback?: string; className?: string }) {
  const router = useRouter();
  const handleClick = () => {
    if (typeof window !== "undefined" && window.history.length <= 1) router.push(fallback);
    else router.back();
  };

  return (
    <button
      onClick={handleClick}
      className={`inline-flex items-center gap-2 px-4 py-3 rounded-xl bg-[#2B6AE0] text-white hover:bg-gray-800 text-sm shadow-lg ${className}`}
      aria-label="Volver"
    >
      <span aria-hidden>←</span> Volver
    </button>
  );
}
</file>

<file path="src/app/[locale]/payment/components/PaymentMethodCashFixer.tsx">
"use client";

import React, { useEffect, useMemo, useState } from "react";

// typescript: Definir props para el componente
interface PaymentMethodCashFixerProps {
  trabajo: { id: string; monto?: number } | null;
  onClose: (paymentCompleted?: boolean) => void;
  onBack: (opts?: { refresh?: boolean }) => void;
}

export default function PaymentMethodCashFixer({
  trabajo,
  onClose,
  onBack,
}: PaymentMethodCashFixerProps) {
  const [codigoIngresado, setCodigoIngresado] = useState("");
  const [loading, setLoading] = useState(true);
  const [patching, setPatching] = useState(false);
  const [mainMessage, setMainMessage] = useState<{
    type: 'error' | 'warning' | 'success' | 'info';
    text: string;
  } | null>(null);
  const [showSuccessModal, setShowSuccessModal] = useState(false);

  // Intentos/bloqueo
  const [remainingAttempts, setRemainingAttempts] = useState<number | null>(null);
  const [unlockAtISO, setUnlockAtISO] = useState<string | null>(null);
  const [now, setNow] = useState<number>(Date.now());
  const [wasLocked, setWasLocked] = useState(false);

  // Estados de código
  const [codeExpired, setCodeExpired] = useState(false);
  const [codeExpiresAt, setCodeExpiresAt] = useState<string | null>(null);

  // Summary
  const [summary, setSummary] = useState<{
    id: string;
    code?: string | null;
    status: "paid" | "pending" | "failed";
    amount: { total: number; currency: string };
  } | null>(null);

  // Countdown para desbloqueo
  const msLeft = useMemo(() => {
    if (!unlockAtISO) return 0;
    const unlockMs = new Date(unlockAtISO).getTime();
    return Math.max(0, unlockMs - now);
  }, [unlockAtISO, now]);

  // Countdown para expiración del código
  const msUntilExpiration = useMemo(() => {
    if (!codeExpiresAt) return 0;
    const expiresMs = new Date(codeExpiresAt).getTime();
    return Math.max(0, expiresMs - now);
  }, [codeExpiresAt, now]);

  useEffect(() => {
    if (!unlockAtISO && !codeExpiresAt) return;
    const t = setInterval(() => setNow(Date.now()), 1000);
    return () => clearInterval(t);
  }, [unlockAtISO, codeExpiresAt]);

  const minutesLeft = Math.floor(msLeft / 60000);
  const secondsLeft = Math.floor((msLeft % 60000) / 1000);

  const hoursUntilExpiration = Math.floor(msUntilExpiration / 3600000);
  const minutesUntilExpiration = Math.floor((msUntilExpiration % 3600000) / 60000);
  const secondsUntilExpiration = Math.floor((msUntilExpiration % 60000) / 1000);

  const locked = !!unlockAtISO && msLeft > 0;

  // Detectar cuando se desbloquea
  useEffect(() => {
    if (wasLocked && !locked && unlockAtISO) {
      console.log("🔓 Cuenta desbloqueada");
      setMainMessage({
        type: 'success',
        text: '🔓 El periodo de bloqueo de 10 minutos ha finalizado. Ya puedes intentar nuevamente.'
      });
      setUnlockAtISO(null);

      // Ocultar mensaje después de 5 segundos
      setTimeout(() => {
        setMainMessage(null);
      }, 5000);
    }

    if (locked) {
      setWasLocked(true);
    }
  }, [locked, unlockAtISO, wasLocked]);

  // Manejar cambio en el input del código
  const handleCodigoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value.toUpperCase();
    // Solo permitir letras y números, máximo 6 caracteres
    const filtered = value.replace(/[^A-Z0-9]/g, '').slice(0, 6);
    setCodigoIngresado(filtered);
  };

  // GET summary
  async function fetchSummary() {
    if (!trabajo?.id) {
      setMainMessage({ type: 'error', text: 'No hay paymentId para consultar.' });
      setLoading(false);
      return;
    }

    setMainMessage(null);
    setRemainingAttempts(null);
    setUnlockAtISO(null);
    setLoading(true);

    try {
      const res = await fetch(`/api/lab/payments/${trabajo.id}/summary`, {
        cache: "no-store",
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(text || `HTTP ${res.status}`);
      }

      const data = await res.json();
      console.log("📦 [FIXER] Backend response completo:", data);

      const d = data?.data ?? data;
      console.log("📋 [FIXER] Data parseada:", d);

      const total =
        typeof d?.total === "number"
          ? d.total
          : typeof d?.amount?.total === "number"
            ? d.amount.total
            : NaN;

      // Detectar código expirado
      const backendExpired = d?.codeExpired === true;
      const manualExpired = d?.codeExpiresAt && new Date(d.codeExpiresAt) < new Date();
      const isExpired = backendExpired || manualExpired;

      console.log("⏰ [FIXER] Verificación expiración en fetchSummary:", {
        backendExpired,
        codeExpiresAt: d?.codeExpiresAt,
        codeExpiresAtParsed: d?.codeExpiresAt ? new Date(d.codeExpiresAt).toLocaleString('es-BO') : null,
        now: new Date().toLocaleString('es-BO'),
        nowISO: new Date().toISOString(),
        manualExpired,
        isExpired
      });

      // Actualizar estado de expiración
      if (isExpired && !codeExpired) {
        console.log("🔴 [FIXER] CÓDIGO EXPIRADO detectado en fetchSummary");
        setCodeExpired(true);
        setMainMessage({
          type: 'warning',
          text: '⏱️ El código ha expirado. Solicite al cliente que genere un nuevo código desde su vista para continuar con el pago.'
        });
      } else if (!isExpired && codeExpired) {
        console.log("✅ [FIXER] Código renovado, limpiando estado de expiración");
        setCodeExpired(false);
        setMainMessage(null);
      }

      // Actualizar codeExpiresAt
      if (d?.codeExpiresAt) {
        setCodeExpiresAt(d.codeExpiresAt);
      }

      setSummary({
        id: String(d?.id ?? d?._id ?? trabajo.id),
        code: d?.code ?? null,
        status: (d?.status ?? "pending") as "paid" | "pending" | "failed",
        amount: {
          total,
          currency: d?.amount?.currency ?? d?.currency ?? "BOB",
        },
      });

    } catch (e: unknown | null) {
      console.error("❌ [FIXER] Error en fetchSummary:", e);
      setMainMessage({ type: 'error', text: e.message || 'No se pudo cargar el resumen' });
    } finally {
      setLoading(false);
    }
  }

  // Cargar summary al montar
  useEffect(() => {
    fetchSummary();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [trabajo?.id]);

  // Verificación automática de expiración cada segundo
  useEffect(() => {
    if (!codeExpiresAt || codeExpired) return;

    const checkExpiration = () => {
      const expiresMs = new Date(codeExpiresAt).getTime();
      const nowMs = Date.now();

      const secondsLeft = (expiresMs - nowMs) / 1000;

      console.log("⏰ [FIXER] Verificando expiración (auto-check):", {
        expiresAt: new Date(expiresMs).toLocaleString('es-BO'),
        expiresAtISO: new Date(expiresMs).toISOString(),
        now: new Date(nowMs).toLocaleString('es-BO'),
        nowISO: new Date(nowMs).toISOString(),
        secondsLeft: secondsLeft.toFixed(2),
        expired: nowMs >= expiresMs
      });

      if (nowMs >= expiresMs && !codeExpired) {
        console.log("🔴 [FIXER] CÓDIGO EXPIRADO detectado por auto-check");
        setCodeExpired(true);
        setMainMessage({
          type: 'warning',
          text: '⏱️ El código ha expirado. Solicite al cliente que genere un nuevo código desde su vista para continuar con el pago.'
        });
      }
    };

    checkExpiration();
    const interval = setInterval(checkExpiration, 1000);
    return () => clearInterval(interval);
  }, [codeExpiresAt, codeExpired]);

  // Confirmar pago
  const handleContinuar = async () => {
    if (!summary) return;

    const provided = codigoIngresado.trim();
    if (!provided) {
      setMainMessage({ type: 'error', text: 'Por favor, ingrese el código de 6 caracteres.' });
      return;
    }

    if (provided.length !== 6) {
      setMainMessage({ type: 'error', text: 'El código debe tener exactamente 6 caracteres.' });
      return;
    }

    setMainMessage(null);
    setRemainingAttempts(null);
    setUnlockAtISO(null);
    setPatching(true);

    try {
      const res = await fetch(`/api/lab/payments/${summary.id}/confirm`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: provided }),
      });

      const responseData = await res.json();

      // ✅ Código correcto - Mostrar modal de éxito
      if (res.ok) {
        console.log("✅ [FIXER] Pago confirmado exitosamente");
        setShowSuccessModal(true);
        await fetchSummary();
        setCodigoIngresado("");
        return;
      }

      // ❌ Manejo de errores según código de estado

      // 429 - Bloqueado por demasiados intentos
      if (res.status === 429) {
        if (responseData.unlocksAt) {
          setUnlockAtISO(responseData.unlocksAt);
        } else if (responseData.waitMinutes) {
          const unlockDate = new Date(Date.now() + responseData.waitMinutes * 60000);
          setUnlockAtISO(unlockDate.toISOString());
        }

        const errorMsg = '🔒 Has superado el número máximo de intentos (3). La cuenta está bloqueada temporalmente por 10 minutos.';
        setMainMessage({ type: 'error', text: errorMsg });
        return;
      }

      // 401 - Código inválido con intentos restantes
      if (res.status === 401) {
        const attempts = responseData.remainingAttempts;
        if (typeof attempts === "number") {
          setRemainingAttempts(attempts);
          setMainMessage({
            type: 'error',
            text: `❌ Código inválido. Te quedan ${attempts} intento${attempts !== 1 ? 's' : ''}.`
          });
        } else {
          setMainMessage({ type: 'error', text: '❌ Código inválido.' });
        }
        return;
      }

      // 410 - Código expirado
      if (res.status === 410) {
        setCodeExpired(true);
        setMainMessage({
          type: 'warning',
          text: '⏱️ El código ha expirado. Solicite al cliente que genere un nuevo código.'
        });
        return;
      }

      // 400 - Bad Request
      if (res.status === 400) {
        setMainMessage({ type: 'error', text: responseData.error || 'Solicitud inválida' });
        return;
      }

      // 404 - No encontrado
      if (res.status === 404) {
        setMainMessage({ type: 'error', text: 'Pago no encontrado' });
        return;
      }

      // 409 - Conflicto (ya procesado)
      if (res.status === 409) {
        setMainMessage({ type: 'error', text: 'El pago ya fue procesado' });
        return;
      }

      // Otros errores
      setMainMessage({
        type: 'error',
        text: responseData.error || responseData.message || `Error ${res.status}`
      });

    } catch (e: unknown | null) {
      setMainMessage({ type: 'error', text: e.message || 'Error al confirmar el pago' });
    } finally {
      setPatching(false);
    }
  };

  const handleVolver = () => {
    onBack({ refresh: true });
  };

  const handleCloseSuccessModal = () => {
    setShowSuccessModal(false);
    onClose(true);
  };

  // Modal de éxito
  if (showSuccessModal) {
    return (
      <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div className="bg-black rounded-lg shadow-2xl p-8 max-w-md w-full mx-4 text-center">
          <div className="mb-4">
            {/* Éxito: #16A34A */}
            <div className="inline-flex items-center justify-center w-16 h-16 bg-[#16A34A] rounded-full mb-4">
              <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
              </svg>
            </div>
          </div>
          <h2 className="text-2xl font-bold text-white mb-2">
            ✓ Código correcto! Pago confirmado
          </h2>
          {/* Primary (Main Blue): #2B31E0 */}
          <button
            onClick={handleCloseSuccessModal}
            className="mt-6 px-8 py-3 bg-[#2B31E0] hover:bg-[#2B6AE0] text-white text-lg font-semibold rounded transition-colors w-full"
          >
            OK
          </button>
        </div>
      </div>
    );
  }

  // Loading state
  if (loading) {
    return (
      <Overlay>
        <Box>
          <div className="flex flex-col items-center">
            {/* Primary (Main Blue): #2B31E0 */}
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#2B31E0] mb-4"></div>
            {/* Texto principal (oscuro): #111827 */}
            <p className="text-[#111827]">Cargando datos del pago…</p>
          </div>
        </Box>
      </Overlay>
    );
  }

  if (mainMessage && !summary) {
    return (
      <Overlay>
        <Box>
          {/* Error: #EF4444 */}
          <div className="text-[#EF4444] font-medium text-lg mb-2">Error</div>
          {/* Texto principal (oscuro): #111827 */}
          <div className="text-[#111827] text-sm mb-4">{mainMessage.text}</div>
          <div className="flex justify-end gap-3">
            <button
              onClick={handleVolver}
              // Neutros: #E5E7EB, #D1D5DB
              className="px-4 py-2 rounded-md border border-[#D1D5DB] hover:bg-[#E5E7EB]"
            >
              Volver
            </button>
            {/* CTA Secundario: Accent (Turquesa brillante) #2BDDE0 */}
            <button
              onClick={() => onClose()}
              className="px-4 py-2 rounded-md bg-[#2BDDE0] text-[#111827] hover:bg-[#5E2BE0]"
            >
              Cerrar
            </button>
          </div>
        </Box>
      </Overlay>
    );
  }

  if (!summary) return null;

  return (
    <Overlay>
      {/* Fondo claro (principal): #F9FAFB */}
      <div className="bg-[#F9FAFB] w-full max-w-2xl mx-4 rounded-lg shadow-xl ">
        {/* Primary (Main Blue): #2B31E0, Texto: #F9FAFB */}
        <div className="bg-[#2B31E0] text-[#F9FAFB] px-6 py-4 flex items-center justify-between rounded-t-lg ">
          <h1 className="text-xl font-semibold ">Método de pago Efectivo — Vista FIXER</h1>
          <button
            onClick={() => onClose()}
            className="hover:bg-[#2B6AE0] px-3 py-1 rounded text-xl transition-colors"
          >
            ✕
          </button>
        </div>
 
        {/* Content */}
        <div className="px-8 py-12">
          {/* Texto principal (oscuro): #111827 */}
          <div className="text-center mb-12">
            <h2 className="text-2xl font-bold text-[#111827]">Confirmación del pago recibido</h2>
          </div>

          {/* Mensaje principal unificado */}
          {mainMessage && (
            <div className="mb-6 max-w-xl mx-auto">
              {/* Aplicando colores de estado del estándar */}
              <div className={`border-l-4 p-4 rounded ${
                mainMessage.type === 'error' ? 'bg-red-50 border-[#EF4444]' :
                mainMessage.type === 'warning' ? 'bg-amber-50 border-[#F59E0B]' :
                mainMessage.type === 'success' ? 'bg-green-50 border-[#16A34A]' :
                'bg-blue-50 border-[#759AE0]' // Highlight para 'info'
                }`}>
                <div className="flex items-start">
                  <div className="flex-shrink-0">
                    <svg className={`h-5 w-5 mt-0.5 ${
                      mainMessage.type === 'error' ? 'text-[#EF4444]' :
                      mainMessage.type === 'warning' ? 'text-[#F59E0B]' :
                      mainMessage.type === 'success' ? 'text-[#16A34A]' :
                      'text-[#759AE0]' // Highlight para 'info'
                      }`} viewBox="0 0 20 20" fill="currentColor">
                      {mainMessage.type === 'success' ? (
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                      ) : mainMessage.type === 'error' ? (
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                      ) : (
                        <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                      )}
                    </svg>
                  </div>
                  <div className="ml-3 flex-1">
                    <p className={`text-sm font-medium ${
                      mainMessage.type === 'error' ? 'text-red-800' :
                      mainMessage.type === 'warning' ? 'text-amber-800' :
                      mainMessage.type === 'success' ? 'text-green-800' :
                      'text-blue-800'
                      }`}>
                      {mainMessage.text}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Contador de bloqueo */}
          {locked && (
            <div className="mb-6 max-w-xl mx-auto">
              {/* Error: #EF4444 */}
              <div className="bg-red-50 border border-[#EF4444] rounded p-3">
                <p className="text-red-700 text-sm font-medium text-center">
                  🔒 Cuenta bloqueada. Intenta en:{" "}
                  <b className="text-lg">
                    {minutesLeft > 0 ? `${minutesLeft}m ` : ""}
                    {secondsLeft}s
                  </b>
                </p>
              </div>
            </div>
          )}

          {/* Info de tiempo restante hasta expiración */}
          {!codeExpired && codeExpiresAt && msUntilExpiration > 0 && (
            <div className="mb-6 max-w-xl mx-auto">
              {/* Highlight: #759AE0 */}
              <div className="bg-blue-50 border border-[#759AE0] rounded p-3">
                <p className="text-blue-700 text-sm text-center">
                  ⏰ Código válido por: <b>
                    {hoursUntilExpiration > 0 && `${hoursUntilExpiration}h `}
                    {minutesUntilExpiration}m {secondsUntilExpiration}s
                  </b>
                </p>
              </div>
            </div>
          )}

          <div className="space-y-6 max-w-xl mx-auto">
            {/* Código (editable) */}
            <RowInput
              label="Código de Trabajo"
              value={codigoIngresado}
              onChange={handleCodigoChange}
              placeholder="CODIGO"
              disabled={locked || patching || codeExpired}
              maxLength={6}
            />

            {/* Monto */}
            <ReadOnly
              label="Monto a Cobrar"
              value={`${summary.amount.total} ${summary.amount.currency}`}
            />

            {/* Estado */}
            <ReadOnly
              label="Estado"
              value={
                summary.status === 'paid' ? 'CONFIRMADO' :
                  summary.status === 'failed' ? 'ERROR' :
                    'PENDIENTE'
              }
            />
          </div>

          {/* Botones */}
          <div className="flex justify-center gap-6 mt-12">
            <button
              onClick={handleContinuar}
              disabled={!codigoIngresado || patching || locked || codeExpired}
              className={`px-12 py-3 text-lg font-semibold rounded-md transition-colors ${
                !codigoIngresado || patching || locked || codeExpired
                  // Neutros (deshabilitado): #D1D5DB, #64748B
                  ? "bg-[#D1D5DB] text-[#64748B] cursor-not-allowed"
                  // Primary (Main Blue): #2B31E0, Hover: #2B6AE0, Texto: #F9FAFB
                  : "bg-[#2B31E0] hover:bg-[#2B6AE0] text-[#F9FAFB]"
                }`}
            >
              {patching ? "Confirmando…" : locked ? "Bloqueado" : codeExpired ? "Código Expirado" : "Confirmar Pago Recibido"}
            </button>
            <button
              onClick={handleVolver}
              disabled={patching}
              // CTA Secundario: Accent (Turquesa brillante) #2BDDE0
              className="px-12 py-3 bg-[#2BDDE0] text-[#111827] text-lg font-semibold rounded-md hover:bg-[#5E2BE0] transition-colors disabled:opacity-60"
            >
              Volver
            </button>
          </div>

          {/* Hint */}
          <div className="mt-6 text-center text-sm text-gray-500">
            {/* Neutro: #64748B */}
            ID pago: <span className="font-mono text-[#64748B]">{summary.id}</span>
          </div>
        </div>
      </div>
    </Overlay>
  );
}

/* ---------- helpers UI ---------- */

function Overlay({ children }: { children: React.ReactNode }) {
  return (
    // Overlay semitransparente
    <div className="fixed inset-0 bg-[rgba(0,0,0,0.5)] flex items-center justify-center z-50">
      {children}
    </div>
  );
}

function Box({ children }: { children: React.ReactNode }) {
  return (
    // Fondo claro (principal): #F9FAFB
    <div className="bg-[#F9FAFB] rounded-lg shadow-xl px-8 py-6 max-w-md">
      {children}
    </div>
  );
}

// typescript: Definir props para RowInput
interface RowInputProps {
  label: string;
  value: string;
  onChange: (e: React.ChangeEvent<HTMLInputElement>) => void;
  placeholder?: string;
  disabled?: boolean;
  maxLength?: number;
}

function RowInput(props: RowInputProps) {
  const { label, value, onChange, placeholder, disabled, maxLength } = props;
  return (
    <div className="flex items-center gap-6">
      {/* Texto principal (oscuro): #111827 */}
      <label className="text-lg font-semibold text-[#111827] w-48 text-left">
        {label}
      </label>
      <input
        type="text"
        value={value}
        onChange={onChange}
        placeholder={placeholder}
        disabled={disabled}
        maxLength={maxLength}
        // Highlight: #759AE0, Neutros: #E5E7EB
        className="flex-1 px-4 py-3 bg-white disabled:bg-[#E5E7EB] border-2 border-[#759AE0] rounded-md text-[#111827] text-lg focus:outline-none focus:ring-2 focus:ring-[#759AE0] disabled:cursor-not-allowed uppercase"
      />
    </div>
  );
}

// typescript: Definir props para ReadOnly
interface ReadOnlyProps {
  label: string;
  value: string;
}

function ReadOnly({ label, value }: ReadOnlyProps) {
  return (
    <div className="flex items-center gap-6">
      {/* Texto principal (oscuro): #111827 */}
      <label className="text-lg font-semibold text-[#111827] w-48 text-left">
        {label}
      </label>
      {/* Neutros: #E5E7EB, #D1D5DB, #111827 */}
      <input
        type="text"
        value={value}
        readOnly
        className="flex-1 px-4 py-3 bg-[#E5E7EB] border border-[#D1D5DB] rounded-md text-[#111827] text-lg"
      />
    </div>
  );
}
</file>

<file path="src/app/[locale]/payment/cuenta-bancaria/page.tsx">
import { Suspense } from 'react';
import CuentaBancariaClient from './CuentaBancariaClient';

export default function CuentaBancariaPage() {
  return (
    // 🟢 SOLUCIÓN: Envolvemos el componente cliente en Suspense.
    // Esto le dice a Next.js: "Renderiza este fallback mientras esperas 
    // a que los parámetros de la URL (searchParams) estén disponibles en el cliente".
    <Suspense 
      fallback={
        <div className="min-h-screen bg-blue-600 flex items-center justify-center">
          <div className="text-white text-lg font-medium animate-pulse">
            Cargando información bancaria...
          </div>
        </div>
      }
    >
      <CuentaBancariaClient />
    </Suspense>
  );
}
</file>

<file path="src/app/[locale]/payment/detalleFactura/[invoiceId]/page.tsx">
'use client';

import React, { useEffect, useState } from 'react';
import InvoiceDetail, { InvoiceDetailData } from '../../../../../Components/payment/InvoiceDetail';
import { useParams } from 'next/navigation';

const API_URL = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000';

// Función auxiliar para obtener el ID del usuario
const getRequesterId = () => {
     const userJson = typeof window !== 'undefined' ? localStorage.getItem('servineo_user') : null;
     if (userJson) {
     try {
     const userData = JSON.parse(userJson);
     return userData.id;
     } catch (e) {
     console.error("Error al parsear datos de usuario:", e);
     return null;
 }
 }
 return null;
};

const InvoiceDetailPage: React.FC = () => {
 const params = useParams();
 const invoiceId = params?.invoiceId as string;
 const [invoiceData, setInvoiceData] = useState<InvoiceDetailData | null>(null);
 const [loading, setLoading] = useState(true);
  
  // 1. NUEVO ESTADO: Controla si la descarga está prohibida por el Backend
  const [isDownloadForbidden, setIsDownloadForbidden] = useState(false); 

     useEffect(() => {
     if (!invoiceId) return;

     const requesterId = getRequesterId(); 

     if (!requesterId) {
     console.error("No se encontró el ID del usuario. Acceso denegado.");
     setLoading(false);
     return;
     }

     const fetchInvoice = async () => {

     try {
        const res = await fetch(`${API_URL}/api/v1/invoices/${invoiceId}?requesterId=${requesterId}`); 
        
        // 🔑 2. MANEJO DE RESPUESTA 403 (PROHIBIDO) DESDE EL BACKEND
        if (res.status === 403) {
            console.warn("Descarga Única: Acceso a datos denegado por el servidor.");
            setIsDownloadForbidden(true); // Se establece el estado de prohibición
            setLoading(false); 
            // Salimos de la función sin intentar parsear JSON ni establecer invoiceData
            return;
        }
        
        if (!res.ok) throw new Error(`Error ${res.status}`);
        
        const { data } = await res.json();
        setInvoiceData(data);
        
     } catch (err) {
     console.error('Error de red al consultar backend:', err);
     setInvoiceData(null);
     } finally {
     setLoading(false);
     }
     };

     fetchInvoice();
     }, [invoiceId]);

     if (loading) {
     return (
     <main className="min-h-screen flex justify-center items-center">
     <p className="text-gray-500">Cargando factura...</p>
     </main>
     );
 }
  
  // Si la descarga está prohibida, seguimos y renderizamos InvoiceDetail para mostrar la advertencia
  // Si no hay datos Y NO está prohibida, mostramos 404/Error.
     if (!invoiceData && !isDownloadForbidden) {
    return (
     <main className="min-h-screen flex flex-col justify-center items-center text-center bg-gray-50 p-4 sm:p-8">
     <h1 className="text-5xl font-bold text-red-600 mb-4">404</h1>
         <p className="text-xl font-semibold text-gray-800">Factura no encontrada o Acceso Denegado</p>
     <p className="mt-2 text-gray-600">ID: {invoiceId}</p>
    <button
         onClick={() => window.history.back()}
     className="mt-6 px-4 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition"
    >
     Volver
    </button>
        </main>
    );
 }

  return (
    <main className="min-h-screen bg-gray-50 p-4 sm:p-8">
     <InvoiceDetail 
          // 🔑 3. PASAR EL ESTADO AL COMPONENTE HIJO
          invoice={invoiceData!} // Usamos ! porque si isDownloadForbidden es true, no hay datos de factura
          isDownloadForbidden={isDownloadForbidden} 
      />
   </main>
 );
};

export default InvoiceDetailPage;
</file>

<file path="src/app/[locale]/payment/facturas/page.tsx">
//src/app/facturas/page.tsx
//src/app/facturas/page.tsx
'use client';

import React from 'react';
// La ruta de importación necesita subir un nivel para llegar a 'app'
// facturas -> app -> payment/components
import InvoiceList from '../../../../Components/payment/InvoiceList'; 

// Esta es la página renderizada en la ruta base /facturas
const InvoicesPage: React.FC = () => {
  return (
    <div className="flex justify-center w-full min-h-screen bg-gray-50">
      <InvoiceList />
    </div>
  );
};

export default InvoicesPage;
</file>

<file path="src/app/[locale]/payment/FixerWallet/page.tsx">
//src/app/payment/FixerWallet/page.tsx
import { Suspense } from 'react';
import { Loader2 } from 'lucide-react';
import WalletDashboardClient from '../../../../Components/payment/WalletDashboardClient'; // Importa el archivo que renombraste

// Un componente simple de carga que se mostrará mientras se leen los datos del cliente
function LoadingFallback() {
  return (
    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
      <div className="text-center">
        <Loader2 className="animate-spin text-blue-600 mx-auto mb-4" size={48} />
        <p className="text-gray-600">Cargando Billetera...</p>
      </div>
    </div>
  );
}

// Esta es tu nueva página. Es un Server Component por defecto.
export default function FixerWalletPage() {
  return (
    // Suspense "pausa" el renderizado del componente cliente
    // y muestra el 'fallback' en su lugar.
    <Suspense fallback={<LoadingFallback />}>
      <WalletDashboardClient />
    </Suspense>
  );
}
</file>

<file path="src/app/[locale]/payment/FixerWallet/recarga/AddCardModalFiver.tsx">
'use client';
import { useState } from 'react';
import { CardElement, useStripe, useElements } from '@stripe/react-stripe-js';
import { motion, AnimatePresence } from 'framer-motion';
import { useRouter } from 'next/navigation'; // <-- importar router

interface OnCardAddedPayloadFixer {
  cardSaved: boolean;
  cardId?: string;
}

interface AddCardModalFixerProps {
  userId: string;
  amount: number;
  onClose: () => void;
  onCardAdded: (payload: OnCardAddedPayloadFixer) => void;
}

export default function AddCardModalFixer({
  userId,
  amount,
  onClose,
  onCardAdded,
}: AddCardModalFixerProps) {
  const stripe = useStripe();
  const elements = useElements();
  const router = useRouter(); // <-- inicializar router
  const [saveCard, setSaveCard] = useState(false);
  const [loading, setLoading] = useState(false);
  const [errorMessage, setErrorMessage] = useState('');
  const [cardHolder, setCardHolder] = useState('');
  const [isValidHolder, setIsValidHolder] = useState(false);
  const [successMessage, setSuccessMessage] = useState('');

  const handleCardHolderChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    const cleanValue = value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '');
    setCardHolder(cleanValue);
    setIsValidHolder(/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]{3,50}$/.test(cleanValue.trim()));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!stripe || !elements) return setErrorMessage('Stripe aún no está listo.');
    if (!isValidHolder) return setErrorMessage('Nombre de titular inválido.');

    setLoading(true);
    setErrorMessage('');

    const cardElement = elements.getElement(CardElement);
    if (!cardElement) {
      setLoading(false);
      return setErrorMessage('No se pudo obtener la tarjeta.');
    }

    try {
      const { error, paymentMethod } = await stripe.createPaymentMethod({
        type: 'card',
        card: cardElement,
        billing_details: { name: cardHolder },
      });
      if (error) throw new Error(error.message);

      let cardId: string | null = null;
      if (saveCard) {
        const cardRes = await fetch(`${process.env.NEXT_PUBLIC_BACKEND_URL}/api/cardscreate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId,
            paymentMethodId: paymentMethod.id,
            saveCard,
            cardholderName: cardHolder,
          }),
        });
        const cardData = await cardRes.json();
        if (!cardRes.ok) throw new Error(cardData.error || 'Error al guardar la tarjeta');
        cardId = cardData._id;
      }

      // Actualizar recarga en wallet
      const walletRes = await fetch(`${process.env.NEXT_PUBLIC_BACKEND_URL}/api/wallet/update`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId,
          amount,
        }),
      });
      const walletData = await walletRes.json();
      if (!walletRes.ok) throw new Error(walletData.error || 'Error al actualizar wallet');

      onCardAdded({
        cardSaved: saveCard,
        cardId: cardId || undefined,
      });

      cardElement.clear();
      setCardHolder('');
      setSuccessMessage(saveCard ? 'Tarjeta guardada y recarga completada' : 'Recarga completada');

      setTimeout(() => {
        setSuccessMessage('');
        onClose();
        router.push(`/payment/FixerWallet?fixerId=${userId}`); // <-- backticks para interpolación
      }, 2000);
    } catch (err: unknown) {
      console.error(err);
      setErrorMessage(err instanceof Error ? err.message : 'Ocurrió un error inesperado.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-50">
      <motion.div
        initial={{ scale: 0.8, opacity: 0 }}
        animate={{ scale: 1, opacity: 1 }}
        exit={{ scale: 0.8, opacity: 0 }}
        className="bg-[#2B6AE0] text-black p-6 rounded-2xl shadow-2xl w-96 relative"
      >
        <h2 className="text-xl font-bold mb-3 text-center">Agregar nueva tarjeta</h2>
        <p className="text-center mb-4 text-black">
          Monto a recargar: <strong className="text-[#2BDDE0]">{amount} BOB</strong>
        </p>

        {errorMessage && (
          <div className="bg-red-500/20 border border-red-500 text-red-300 p-2 mb-4 rounded-md text-sm text-center">
            {errorMessage}
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block mb-2 text-sm font-semibold text-black">
              Nombre de titular*
            </label>
            <input
              type="text"
              value={cardHolder}
              onChange={handleCardHolderChange}
              placeholder="Ej: Juan Pérez"
              className="w-full bg-[#E5E7EB] border-gray-200 rounded-xl px-3 py-2 text-black outline-none"
              required
            />
          </div>

          <div className="p-3 rounded-xl bg-[#E5E7EB] border text-black border-gray-700">
            <CardElement
              options={{
                hidePostalCode: true,
                style: {
                  base: { fontSize: '16px', color: '#000', '::placeholder': { color: '#888' } },
                  invalid: { color: '#ff6b6b' },
                },
              }}
            />
          </div>

          <label className="flex items-center gap-2 text-sm text-black mt-2">
            <input
              type="checkbox"
              checked={saveCard}
              onChange={(e) => setSaveCard(e.target.checked)}
              className="accent-blue-500"
            />
            Guardar tarjeta para futuros pagos
          </label>

          <div className="flex justify-between mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-4 py-2 bg-[#D1D5DB] hover:bg-[#2BDDE0] rounded-xl transition-all"
            >
              Cancelar
            </button>
            <button
              type="submit"
              disabled={!stripe || loading || !isValidHolder}
              className={`px-5 py-2 rounded-xl font-semibold transition-all ${!stripe || loading || !isValidHolder ? 'bg-[#D1D5DB] cursor-not-allowed' : 'bg-[#D1D5DB] hover:bg-[#2BDDE0]'
                }`}
            >
              {loading ? 'Procesando...' : 'Recargar'}
            </button>
          </div>
        </form>
      </motion.div>

      <AnimatePresence>
        {successMessage && (
          <motion.div
            initial={{ opacity: 0, y: -20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -20 }}
            className="absolute top-10 bg-[#2BDDE0] text-white px-6 py-3 rounded-xl shadow-xl text-center"
          >
            {successMessage}
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}
</file>

<file path="src/app/[locale]/payment/FixerWallet/recarga/CardListFixer.tsx">
'use client';
import { useEffect, useState } from 'react';
import AddCardModalFixer from './AddCardModalFiver';

import { motion, AnimatePresence } from 'framer-motion';

interface CardListFixerProps {
 fixerId: string;
 amount: number;
 onRechargeSuccess: () => void;
    // 🔑 NUEVO: Token de reCAPTCHA para seguridad
    recaptchaToken: string | null; 
}

interface Card {
 _id: string;
 brand?: string;
 last4: string;
 expMonth: string | number;
 expYear: string | number;
 cardholderName?: string;
 isDefault?: boolean;
}

export default function CardListFixer({ fixerId, amount, onRechargeSuccess, recaptchaToken }: CardListFixerProps) {
 const [cards, setCards] = useState<Card[]>([]);
 const [showModal, setShowModal] = useState(false);
 const [processingCardId, setProcessingCardId] = useState<string | null>(null);
 const [successMessage, setSuccessMessage] = useState('');
 const [confirmModal, setConfirmModal] = useState<Card | null>(null);

 //const BACKEND_URL_DEPLOYADO = process.env.BACKEND_URL;

 const fetchCards = async () => {
 try {
 const res = await fetch(`${process.env.NEXT_PUBLIC_BACKEND_URL}/api/cards?userId=${fixerId}`);
 if (!res.ok) throw new Error('Error fetching cards');
 const data = await res.json();
 setCards(data);
 } catch (err) {
 console.error('Error obteniendo tarjetas:', err);
 }
 };

 useEffect(() => {
 fetchCards();
 }, []);

 const confirmRecharge = (card: Card) => setConfirmModal(card);

 const handleRecharge = async (card: Card) => {
 if (processingCardId) return;
        
        // 🚨 PREVENCIÓN: Si no hay token, no continuar (debería venir del modal anterior)
        if (!recaptchaToken) {
            alert('Error de seguridad: Falta la verificación reCAPTCHA. Intenta nuevamente.');
            return;
        }

        setProcessingCardId(card._id);
        setConfirmModal(null);

        try {
            console.log(`💳 Recargando ${amount} BOB a la wallet del fixer ${fixerId} con token reCAPTCHA.`);

            // 🔑 CRÍTICO: Incluir el recaptchaToken en el cuerpo de la solicitud
            const res = await fetch(`${process.env.NEXT_PUBLIC_BACKEND_URL}/api/wallet/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    amount, 
                    userId: fixerId,
                    cardId: card._id, // Asumiendo que necesitas el ID de la tarjeta para cargarla en el backend
                    recaptchaToken // 🔑 Token incluido aquí
                }), 
            });


 const data = await res.json();
 if (!res.ok) throw new Error(data.error || 'Error al recargar wallet');
 showSuccessModal(`💰 Recarga exitosa: +${amount} BOB (nuevo balance: ${data.wallet.balance} BOB)`);
 onRechargeSuccess?.();
        } catch (err) {
            console.error(err);
            alert('Error al recargar la wallet. Asegúrate de que tu monto sea válido y la tarjeta tenga fondos.');
        } finally {
            setProcessingCardId(null);
        }
    };

    const showSuccessModal = (msg: string) => {
        setSuccessMessage(msg);
        setTimeout(() => setSuccessMessage(''), 2500);
    };

    return (
 <div className="min-h-screen bg-[#D1D5DB] p-10 text-black relative">
 <div className="flex justify-between items-center gap-3 mb-10">
 <h1 className="text-3xl font-extrabold">Mis Tarjetas Guardadas</h1>
 <motion.button
 whileTap={{ scale: 0.95 }}
 onClick={() => setShowModal(true)}
 className="px-6 py-3 bg-[#2B6AE0] rounded-xl shadow-lg hover:bg-[#2BDDE0] transition-all font-semibold flex items-center gap-2"
 >
 Agregar➕
 </motion.button>
 </div>

 {cards.length === 0 ? (
 <p className="text-center text-gray-400">No tienes tarjetas guardadas.</p>
 ) : (
 <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10">
 {cards.map((card, index) => (
 <motion.div
 key={card._id}
 initial={{ opacity: 0, y: 20 }}
 animate={{ opacity: 1, y: 0 }}
 transition={{ delay: index * 0.1 }}
 whileHover={{ scale: 1.03 }}
 className="relative rounded-2xl shadow-2xl p-6 bg-[#1AA7ED] text-black"
 >
 <div className="flex justify-between items-center mb-6">
 <p className="text-lg font-semibold uppercase">{card.brand}</p>
 <img
 src={
 card.brand?.toLowerCase() === 'visa'
 ? 'https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg'
 : card.brand?.toLowerCase() === 'mastercard'
 ? 'https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg'
 : 'https://upload.wikimedia.org/wikipedia/commons/f/fd/Generic-credit-card-icon.svg'
 }
 alt="brand"
 className="h-6 w-auto"
 />
 </div>

 <div className="text-2xl tracking-widest font-mono mb-4">
 **** **** **** {card.last4}
 </div>

 <div className="flex justify-between text-sm opacity-90">
 <div>
 <p className="uppercase">Expira</p>
 <p className="font-semibold">{card.expMonth}/{card.expYear}</p>
 </div>
 <div className="text-right">
 <p className="uppercase">Titular</p>
 <p className="font-semibold truncate w-32">{card.cardholderName || 'usuario'}</p>
 </div>
 </div>

 <motion.button
                                whileTap={{ scale: 0.95 }}
                                onClick={() => confirmRecharge(card)}
                                disabled={processingCardId === card._id}
                                className={`mt-6 w-full py-2 rounded-xl font-bold text-white shadow-lg ${processingCardId === card._id
                                        ? 'bg-[#2B6AE0] cursor-not-allowed'
                                        : 'bg-[#2B6AE0] hover:bg-[#2BDDE0]'
                                    }`}
                            >
                                {processingCardId === card._id ? 'Procesando...' : `Recargar ${amount} BOB`}
                            </motion.button>
                        </motion.div>
                    ))}
                </div>
            )}

            {showModal && (
                <AddCardModalFixer
                    userId={fixerId}
                    amount={amount}
                    recaptchaToken={recaptchaToken} // 🔑 CRÍTICO: Pasa el token al modal de añadir
                    onClose={() => setShowModal(false)}
                    onCardAdded={() => fetchCards()}
                />
            )}

            {/* Confirmación */}
            <AnimatePresence>
                {confirmModal && (
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="fixed inset-0 flex justify-center items-center bg-black/60 backdrop-blur-sm z-50"
                    >
                        <motion.div
                            initial={{ scale: 0.8 }}
                            animate={{ scale: 1 }}
                            className="bg-[#2B6AE0] p-8 rounded-2xl shadow-2xl text-center max-w-sm w-full"
                        >
                            <h2 className="text-xl font-bold mb-4">⚠️ Confirmar Recarga</h2>
                            <p className="text-black mb-6">
                                ¿Deseas recargar{' '}
                                <span className="font-bold text-[#2BDDE0]">{amount} BOB</span>{' '}
                                a tu wallet con la tarjeta terminada en{' '}
                                <span className="font-bold">{confirmModal.last4}</span>?
                            </p>
                            <div className="flex justify-center gap-4">
                                <button
                                    onClick={() => setConfirmModal(null)}
                                    className="px-5 py-2 bg-[#D1D5DB] rounded-xl hover:bg-[#2BDDE0]"
                                >
                                    Cancelar
                                </button>
                                <button
                                    onClick={() => handleRecharge(confirmModal)}
                                    className="px-5 py-2 bg-[#D1D5DB] rounded-xl hover:bg-[#2BDDE0] font-semibold"
                                >
                                    Confirmar
                                </button>
                            </div>
                        </motion.div>
                    </motion.div>
                )}
            </AnimatePresence>

            {/* Éxito */}
            <AnimatePresence>
                {successMessage && (
                    <motion.div
                        initial={{ opacity: 0, scale: 0.8 }}
                        animate={{ opacity: 1, scale: 1 }}
                        exit={{ opacity: 0, scale: 0.8 }}
                        className="fixed inset-0 flex justify-center items-center bg-black/40 backdrop-blur-sm z-50"
                    >
                        <div className="bg-[#2B6AE0] text-black px-10 py-6 rounded-2xl shadow-xl text-center">
                            <h2 className="text-xl font-bold mb-3">¡Recarga Exitosa!</h2>
                            <p>{successMessage}</p>
                        </div>
                    </motion.div>
                )}
            </AnimatePresence>
        </div>
    );
}
</file>

<file path="src/app/[locale]/payment/FixerWallet/recarga/page.tsx">
import { Suspense } from 'react';
import { Loader2 } from 'lucide-react';
import RechargePageClient from './RechargePageClient'; // Importa el archivo que renombraste

// Un componente simple de carga
function LoadingFallback() {
  return (
    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
      <div className="text-center">
        <Loader2 className="animate-spin text-blue-600 mx-auto mb-4" size={48} />
        <p className="text-gray-600">Cargando página de recarga...</p>
      </div>
    </div>
  );
}

// Esta es tu nueva página.
export default function RechargePage() {
  return (
    <Suspense fallback={<LoadingFallback />}>
      <RechargePageClient userid={"6928d79bba289c48b60798ad"}/>
    </Suspense>
  );
}
</file>

<file path="src/app/[locale]/payment/historial/page.tsx">
import { Suspense } from 'react';
import HistoryPageClient from '../../../../Components/payment/HistoryClient'; // 1. Importa tu componente
import { Loader2 } from 'lucide-react';

// Componente simple de carga (puedes personalizarlo)
function LoadingFallback() {
  return (
    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
      <div className="text-center">
        <Loader2 className="animate-spin text-blue-600 mx-auto mb-4" size={48} />
        <p className="text-gray-600">Cargando historial...</p>
      </div>
    </div>
  );
}

// 2. Esta es tu nueva página. Es un Server Component.
export default function FixerWalletHistoryPage() {
  return (
    // 3. Envuelve tu componente de cliente en Suspense
    <Suspense fallback={<LoadingFallback />}>
      <HistoryPageClient />
    </Suspense>
  );
}
</file>

<file path="src/app/[locale]/payment/pago-qr/page.tsx">
import PayWithQr from "@/Components/payment/PayWithQr";

export default function PagoQrPage() {
  return <PayWithQr />;
}
</file>

<file path="src/app/[locale]/payment/qrwallet/page.tsx">
// src/app/payment/qr/page.tsx

import { Suspense } from 'react';
import { Loader2 } from 'lucide-react';

// 1. Importa el componente cliente que acabas de renombrar
import QRPageClient from '../qrwallet/QRPageClient'; 

// 2. Un componente de carga (puedes personalizarlo)
function LoadingFallback() {
  return (
    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
      <div className="text-center">
        <Loader2 className="animate-spin text-blue-600 mx-auto mb-4" size={48} />
        <p className="text-gray-600">Generando código QR...</p>
      </div>
    </div>
  );
}

// 3. Esta es tu nueva página (un Server Component)
export default function QRPage() {
  return (
    // 4. Envuelve tu componente cliente en <Suspense>
    <Suspense fallback={<LoadingFallback />}>
      <QRPageClient />
    </Suspense>
  );
}
</file>

<file path="src/app/[locale]/payment/qrwallet/QRPageClient.tsx">
"use client";

import { useEffect, useState } from "react";
import { useSearchParams } from "next/navigation";
import BackButton from "../components/BackButton";

//tipos simples
type PaymentStatus = "pending" | "under_review" | "confirmed" | "rejected" | "expired";
type Intent = {
  _id: string;
  bookingId: string;
  providerId: string;
  amountExpected: number;
  currency: string;
  paymentReference: string;
  status: PaymentStatus;
  deadlineAt?: string;
  createdAt?: string;
};
type PaymentMethod = { qrImageUrl?: string; accountDisplay?: string };

// Lee la URL del backend de tu .env.local
//const BACKEND_URL_DEPLOYADO = process.env.BACKEND_URL;

export default function PaymentsPage() {
  const searchParams = useSearchParams();
  
  //estado que llamamos desde el backend
  const [intent, setIntent] = useState<Intent | null>(null);
  const [method, setMethod] = useState<PaymentMethod | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Obtener trabajoId de la URL para mostrarlo
  const trabajoId = searchParams.get("trabajoId") || "—";
  const montoDemo = Number(searchParams.get("amount")) || 150;
  const currencyDemo = searchParams.get("currency") || "BOB";

  //para la demo se usa valores fijos para recuperar el QR (igual que el original)
  const bookingId = "TEST-BOOKING-1";
  const providerId = "prov_123";
  const amount = 150; //monto en BOB
  const currency = "BOB";
  

  useEffect(() => {
    (async () => {
      try {
        setLoading(true);
        setError(null);

        // [LOG B] payload que envías al backend
        const payload = { bookingId, providerId, amount, currency };
        console.log("→ POST /api/payments/intent payload =", payload);

        const res = await fetch(`${process.env.NEXT_PUBLIC_BACKEND_URL}/api/payments/intent`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ bookingId, providerId, amount, currency }),
        });

        // [LOG C] status de la respuesta
        console.log("← status", res.status);

        const data = await res.json();

        // [LOG D] cuerpo de la respuesta
        console.log("← body", data);

        if (!res.ok) throw new Error(data?.message || data?.error || "Error al crear intent");
        setIntent(data.intent);
        setMethod(data.paymentMethod || null);
        if (data.error === "NO_QR") setError("El proveedor no tiene QR configurado.");
      } catch (e: unknown) {
        setError(e.message || "Error de red");
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  // [LOG A] — esto sale en la consola del navegador (DevTools > Console)
  //console.log("API_BASE =", BACKEND_URL_DEPLOYADO);

  // Helper para formatear moneda (lo usamos en subtotal/comisión/total)
  const money = (n: number) =>
    n.toLocaleString("es-BO", { style: "currency", currency: currencyDemo });

  //agregado
  const [imgSrc, setImgSrc] = useState<string | null>(null);

  const toDriveThumb = (url: string) => {
    const m = url.match(/id=([^&]+)/);
    return m ? `https://drive.google.com/thumbnail?id=${m[1]}&sz=w512` : url;
  };

  const fallbackQR = `https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodeURIComponent("Servineo QR")}`;

  useEffect(() => {
    if (method?.qrImageUrl) {
      setImgSrc(method.qrImageUrl); // primero intentamos con uc?export=view
    }
  }, [method]);

  //fin agregado
  
  return (
  <div className="min-h-screen bg-white">
    {/* Barra superior */}
    <header className="bg-[#2B6AE0]">
      <div className="max-w-5xl px-6 py-6">
        <h1 className="text-4xl md:text-5xl font-semibold text-white">
          Recarga de Saldo
        </h1>
      </div>
    </header>

    <BackButton
      fallback="/payments"
      className="fixed bottom-4 right-4 z-50"
    />

    <main className="max-w-5xl mx-auto p-4 md:p-6">
      {loading && <p>Cargando…</p>}
      {error && <p className="text-red-600 mb-3">{error}</p>}

      {/* GRID RESPONSIVO */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        {/* COLUMNA IZQUIERDA */}
        <section className="md:-ml-25">
          <h2 className="text-3xl md:text-4xl font-semibold mb-3 text-black"></h2>

          <div className="my-2 min-h-2">
            <hr className="border-t-2 border-[#2B6AE0]" />
          </div>

          <dl className="space-y-6 text-black">

            {/* Destinatario */}
            <div className="flex flex-col md:flex-row md:items-center gap-1 min-h-12">
              <dt className="text-xl md:text-2xl font-medium md:w-[160px]">
                Destinatario:
              </dt>
              <dd className="text-xl md:text-2xl absolute left-[250px]">
                {method?.accountDisplay || "—"}
              </dd>
            </div>

            {/* Número de Transacción */}
            <div className="relative min-h-10">
                <dt className="text-2xl font-medium inline-block w-[240px] text-left whitespace-nowrap">
                  N° de Transacción:
                </dt>
                <dd className="text-2xl leading-tight absolute top-0 left-[250px]">
                  {intent?.paymentReference || "—"}
                </dd>
              </div>

            {/* Total */}
            <div className="relative min-h-12">
                <dt className="text-2xl font-semibold inline-block w-[160px] text-left">
                  Total:
                </dt>
                <dd className="text-2xl font-semibold leading-tight absolute top-0 left-[250px]">
                  {money(montoDemo)}
                </dd>
              </div>

            <div className="my-2">
              <hr className="border-t-2 border-[#2B6AE0]" />
            </div>

            <div className="my-9">
              <hr className="border-t-2 border-[#2B6AE0]" />
            </div>

            {/* Estado */}
            <div className="relative min-h-8 mt-6">
                <dt className="text-2xl font-medium inline-block w-[160px] text-left">
                  Estado:
                </dt>
                <dd className="text-2xl leading-tight absolute top-0 left-0 translate-x-[250px]">
                  {intent?.status ? intent.status.toUpperCase() : "—"}
                </dd>
              </div>

            <div className="my-7">
              <hr className="border-t-2 border-[#2B6AE0]" />
            </div>
          </dl>
        </section>

        {/* COLUMNA DERECHA */}
        <aside className="bg-[#759AE0] rounded-xl p-5 w-full md:w-[420px] md:ml-24 md:self-start">
          <h3 className="text-xl md:text-2xl font-semibold text-gray-900 mb-4 text-center">
            Escanea el código QR
          </h3>

          <div className="h-56 md:h-64 w-full rounded-lg bg-gray-200 flex items-center justify-center md:justify-self-end">
            {imgSrc ? (
              <img
                src={imgSrc}
                alt="QR de pago"
                className="max-h-full object-contain"
                referrerPolicy="no-referrer"
                onError={() => {
                  if (imgSrc.includes("drive.google.com") && !imgSrc.includes("/thumbnail")) {
                    setImgSrc(toDriveThumb(imgSrc));
                  } else {
                    setImgSrc(fallbackQR);
                  }
                }}
              />
            ) : (
              <img
                src={fallbackQR}
                alt="QR de pago (fallback)"
                className="max-h-full object-contain"
              />
            )}
          </div>
        </aside>

      </div>
    </main>
  </div>
);

}
</file>

<file path="src/app/[locale]/payment/trabajos/LoadingFallback.tsx">
import { Loader2 } from "lucide-react";
export default function LoadingFallback() {
  return (
    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
      <div className="text-center">
        <Loader2 className="animate-spin text-blue-600 mx-auto mb-4" size={48} />
        <p className="text-gray-600">Cargando Trabajos...</p>
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/payment/trabajos/page.tsx">
"use client";
import LoadingFallback from "./LoadingFallback";
import { Suspense } from "react";
import TrabajosList from "./TrabajosList";

export default function TrabajosRequester() {
  // Simulamos un usuario (puedes reemplazarlo con el real)
  const userId = "692b9c15e90a42ddc83350c5";

  return (
    <Suspense fallback={<LoadingFallback />}>
      <TrabajosList userId={userId} />
    </Suspense>
  );
}
</file>

<file path="src/app/[locale]/por-que-servineo/page.tsx">
'use client';

import Image from 'next/image';
import Link from 'next/link';
import { MapPin, User, Calendar, ShieldCheck } from 'lucide-react';
import { Check, X } from 'lucide-react';
import { useEffect, useLayoutEffect, useRef, useState } from 'react';

function useInViewMultiple(count: number, options?: IntersectionObserverInit) {
  const refs = useRef<(HTMLDivElement | null)[]>(Array(count).fill(null));
  const [inViewStates, setInViewStates] = useState<boolean[]>(Array(count).fill(false));

  useEffect(() => {
    refs.current.forEach((el, index) => {
      if (!el) return;

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              setInViewStates((prev) => {
                const newState = [...prev];
                newState[index] = true;
                return newState;
              });
              observer.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.25, ...options },
      );

      observer.observe(el);
    });
  }, [count, options]);

  return { refs, inViewStates };
}

export default function WhyServineoPage() {
  const fallbackSrc = '/fallback-image.svg';

  const banners = [
    {
      id: 1,
      title: 'Descubre quiénes están cerca de ti',
      description:
        'Explora tu ciudad desde el mapa interactivo de Servineo y descubre a los fixers disponibles cerca de ti. Podrás ver fácilmente su ubicación y acceder a su información con un solo clic. Así, Servineo te conecta de forma rápida y sencilla con los profesionales que realmente están a tu alcance.',
      image: '/es/img/banner1.jpg',
      alt: 'Mapa de la ciudad con marcadores que muestran fixers cerca del usuario',
      icon: (
        <MapPin className='inline-block w-6 h-6 mr-2 text-[var(--primary)]' aria-hidden='true' />
      ),
      button: { text: 'Explorar mapa', link: '/' },
    },
    {
      id: 2,
      title: 'Conócelos en detalle',
      description:
        'En Servineo, cada fixer cuenta con un perfil completo que muestra su experiencia, especialidades y disponibilidad. Explora sus trayectorias, conoce sus habilidades y elige con confianza al profesional que mejor se adapte a tus necesidades. Todo lo que necesitas saber para encontrar al fixer ideal, en un solo lugar.',
      image: '/es/img/banner2.jpg',
      alt: 'Perfil de un profesional mostrando su información y experiencia',
      icon: <User className='inline-block w-6 h-6 mr-2 text-[var(--primary)]' aria-hidden='true' />,
    },
    {
      id: 3,
      title: 'Agenda tu cita con facilidad',
      description:
        'Con Servineo, agendar un servicio es rápido y sin complicaciones. Elige al profesional que necesites, coordina los detalles por WhatsApp y confirma tu cita en el horario que prefieras. Todo desde una plataforma práctica que conecta fácilmente a quienes ofrecen y quienes buscan un servicio.',
      image: '/es/img/banner3.jpg',
      alt: 'Persona agendando una cita de servicio desde su dispositivo',
      icon: (
        <Calendar className='inline-block w-6 h-6 mr-2 text-[var(--primary)]' aria-hidden='true' />
      ),
      button: { text: 'Agendar ahora', link: '/' },
    },
    {
      id: 4,
      title: 'Confía en la calidad y seguridad del servicio',
      description:
        'En Servineo, la confianza es lo primero. Por eso, cada fixer pasa por un proceso de registro que valida su compromiso, responsabilidad y cumplimiento de nuestras políticas. Así, garantizamos que cada servicio dentro de la plataforma sea seguro, transparente y de calidad, brindándote la tranquilidad de contratar a profesionales en los que realmente puedes confiar.',
      image: '/es/img/banner4.jpg',
      alt: 'Profesional estrechando la mano de un cliente en señal de confianza',
      icon: (
        <ShieldCheck
          className='inline-block w-6 h-6 mr-2 text-[var(--primary)]'
          aria-hidden='true'
        />
      ),
    },
  ];

  // Mapa para saber qué imágenes fallaron y usar fallback
  const [failedMap, setFailedMap] = useState<Record<number, boolean>>({});

  const STORAGE_KEY = 'whyServineoScroll';

  // Guardar scroll mientras el usuario navega
  useEffect(() => {
    if (typeof window === 'undefined') return;
    const handleScroll = () => {
      sessionStorage.setItem(STORAGE_KEY, String(window.scrollY));
    };
    window.addEventListener('scroll', handleScroll);

    return () => {
      window.removeEventListener('scroll', handleScroll);
    };
  }, []);

  // Restaurar scroll después de renderizar y cargar imágenes
  useLayoutEffect(() => {
    if (typeof window === 'undefined') return;

    const restoreScroll = () => {
      const saved = sessionStorage.getItem(STORAGE_KEY);
      if (saved) {
        const y = parseInt(saved, 10);
        if (!Number.isNaN(y)) {
          window.scrollTo({ top: y, left: 0, behavior: 'auto' });
        }
      }
    };

    // Restaurar al montar
    restoreScroll();

    // Restaurar al volver con atrás/adelante
    const handlePopState = () => {
      const retry = () => {
        restoreScroll();
        if (window.scrollY < 1) setTimeout(retry, 50);
      };
      retry();
    };

    window.addEventListener('popstate', handlePopState);

    return () => {
      window.removeEventListener('popstate', handlePopState);
    };
  }, []);

  const { refs, inViewStates } = useInViewMultiple(banners.length);

  return (
    <main className='min-h-screen bg-[var(--background)] text-[var(--foreground)]'>
      {/* Hero / Introducción */}
      <section className='max-w-5xl mx-auto px-6 py-24 text-center'>
        <h1 className='text-5xl md:text-6xl font-extrabold text-[var(--primary)] mb-8 leading-tight'>
          ¿Por qué Servineo?
        </h1>
        <p className='text-lg md:text-xl leading-relaxed text-gray-700 max-w-3xl mx-auto'>
          En Servineo, creemos que encontrar ayuda profesional no debería ser complicado. Por eso,
          creamos una plataforma que te conecta con expertos de confianza, especializados en
          carpintería, plomería, electricidad y mucho más. Servineo transforma la manera de
          contratar servicios: rápida, clara y hecha para simplificar tu día a día.
        </p>
      </section>

      {/* Banners */}
      {banners.map((banner, index) => (
        <section
          key={banner.id}
          ref={(el: HTMLDivElement | null) => {
            refs.current[index] = el;
          }}
          className={`py-12 lg:py-20 relative flex flex-col-reverse md:flex-row items-start max-w-6xl mx-auto px-4 sm:px-6 md:px-8 gap-12 sm:gap-8 transition-all duration-700 ease-out
            ${inViewStates[index] ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-6 sm:translate-y-8'}`}
        >
          {/* Texto */}
          <div className='md:w-1/2 text-center md:text-left z-20'>
            <h2 className='text-2xl sm:text-2xl md:text-3xl font-semibold text-black mb-4 flex items-center justify-center md:justify-start'>
              {banner.icon}
              {banner.title}
            </h2>
            <p className='text-base sm:text-lg md:text-lg leading-relaxed mb-4'>
              {banner.description}
            </p>
            {banner.button && (
              <Link
                href={banner.button.link}
                className='inline-block bg-[var(--primary)] hover:bg-[var(--secondary)] text-white rounded-full px-6 py-3 shadow-md transition-all duration-300 transform hover:scale-105 mt-4'
              >
                {banner.button.text}
              </Link>
            )}
          </div>

          {/* Imagen */}
          <div className='md:w-1/2 relative z-10 flex justify-center md:justify-end'>
            <div
              className='hidden xl:block absolute rounded-3xl shadow-lg
                top-0 right-0 w-5/6 sm:w-4/5 h-5/6 sm:h-4/5 translate-x-6 sm:translate-x-14 -translate-y-4 sm:-translate-y-6
                bg-[var(--primary)] z-0'
              aria-hidden='true'
            />
            <div className='relative rounded-3xl shadow-lg overflow-hidden w-full md:w-[90%] z-10 group bg-gray-100'>
              <Image
                src={failedMap[index] ? fallbackSrc : banner.image}
                alt={banner.alt}
                width={800}
                height={520}
                className='w-full h-auto object-cover block transition duration-500 group-hover:scale-105 group-hover:shadow-2xl group-hover:brightness-95'
                onError={() => {
                  setFailedMap((prev) => ({ ...prev, [index]: true }));
                }}
              />
            </div>
          </div>
        </section>
      ))}
      {/* Tabla comparativa */}
      <section className='max-w-6xl mx-auto px-6 py-24 bg-[var(--background)] text-[var(--foreground)]'>
        {/* Subtítulo */}
        <h2 className='text-3xl md:text-4xl font-extrabold text-black mb-4 text-center'>
          ¿Qué hace a Servineo diferente?
        </h2>
        {/* Descripción */}
        <p className='text-base sm:text-lg md:text-lg leading-relaxed text-center text-gray-700 mb-12 max-w-3xl mx-auto'>
          Compara las principales plataformas de servicios y descubre por qué Servineo ofrece mayor
          seguridad, confianza y facilidad para agendar tus servicios.
        </p>

        <div className='overflow-x-auto relative'>
          <table className='min-w-full border border-gray-200 rounded-2xl shadow-md overflow-hidden'>
            <thead className='bg-[var(--primary)] text-white'>
              <tr>
                <th className='p-4 text-center text-xl'>Criterio</th>
                <th className='p-4 text-center text-xl'>Servineo</th>
                <th className='p-4 text-center text-xl'>
                  <a
                    href='https://www.facebook.com/marketplace'
                    target='_blank'
                    rel='noopener noreferrer'
                    className="relative inline-block text-white after:content-[''] after:absolute after:left-0 after:bottom-0 after:w-0 after:h-[2px] after:bg-white hover:after:w-full after:transition-all after:duration-300"
                  >
                    Facebook Marketplace
                  </a>
                </th>
                <th className='p-4 text-center text-xl'>
                  <a
                    href='https://bookaapp.com/services'
                    target='_blank'
                    rel='noopener noreferrer'
                    className="relative inline-block text-white after:content-[''] after:absolute after:left-0 after:bottom-0 after:w-0 after:h-[2px] after:bg-white hover:after:w-full after:transition-all after:duration-300"
                  >
                    Foreign apps
                  </a>
                </th>
              </tr>
            </thead>
            <tbody className='bg-white'>
              {/* Verificación de usuarios */}
              <tr className='border-b border-gray-200 hover:bg-gray-50 transition-colors'>
                <td className='p-4 text-center'>Verificación de usuarios</td>
                <td className='p-4 bg-blue-50 rounded-lg shadow-sm text-center'>
                  Perfiles reales y verificados
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Sin verificación obligatoria
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Validación básica
                  </span>
                </td>
              </tr>

              {/* Reserva de citas */}
              <tr className='border-b border-gray-200 hover:bg-gray-50 transition-colors'>
                <td className='p-4 text-center'>Reserva de citas</td>
                <td className='p-4 bg-blue-50 rounded-lg shadow-sm text-center relative group cursor-pointer'>
                  <Check className='mx-auto text-green-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Reserva en segundos desde la plataforma
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Sin sistema de reservas
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <Check className='mx-auto text-green-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Disponible, pero poco ágil
                  </span>
                </td>
              </tr>

              {/* Seguridad y confianza */}
              <tr className='border-b border-gray-200 hover:bg-gray-50 transition-colors'>
                <td className='p-4 text-center'>Seguridad y confianza</td>
                <td className='p-4 bg-blue-50 rounded-lg shadow-sm text-center relative group cursor-pointer'>
                  <Check className='mx-auto text-green-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Opiniones reales y control de calidad
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Alto riesgo de fraudes
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Moderada, depende del país
                  </span>
                </td>
              </tr>

              {/* Información del profesional */}
              <tr className='border-b border-gray-200 hover:bg-gray-50 transition-colors'>
                <td className='p-4 text-center'>Información del profesional</td>
                <td className='p-4 bg-blue-50 rounded-lg shadow-sm text-center'>
                  Perfiles con fotos, habilidades y disponibilidad
                </td>
                <td className='p-4 text-center'>Información limitada</td>
                <td className='p-4 text-center'>Datos básicos</td>
              </tr>

              {/* Atención al cliente */}
              <tr className='border-b border-gray-200 hover:bg-gray-50 transition-colors'>
                <td className='p-4 text-center'>Atención al cliente</td>
                <td className='p-4 bg-blue-50 rounded-lg shadow-sm text-center relative group cursor-pointer'>
                  <Check className='mx-auto text-green-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Soporte directo por WhatsApp o correo
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Sin atención personalizada
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Limitada
                  </span>
                </td>
              </tr>

              {/* Diseño enfocado en servicios */}
              <tr className='border-b border-gray-200 hover:bg-gray-50 transition-colors'>
                <td className='p-4 text-center'>Diseño enfocado en servicios</td>
                <td className='p-4 bg-blue-50 rounded-lg shadow-sm text-center relative group cursor-pointer'>
                  <Check className='mx-auto text-green-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Hecho para conectar profesionales y clientes
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Enfocado en ventas generales
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Orientado a experiencias
                  </span>
                </td>
              </tr>

              {/* Costo de uso */}
              <tr className='hover:bg-gray-50 transition-colors'>
                <td className='p-4 text-center'>Costo de uso</td>
                <td className='p-4 bg-blue-50 rounded-lg shadow-sm text-center'>
                  Gratis y transparente
                </td>
                <td className='p-4 text-center'>Gratis, pero sin soporte</td>
                <td className='p-4 text-center'>Costos variables</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
      {/* Sección de llamada a la acción */}
      {/* Sección de llamada a la acción centrada */}
      <section className='w-full bg-[var(--primary)] text-white py-16 px-6 flex flex-col items-center text-center'>
        <h2 className='text-3xl md:text-4xl font-extrabold mb-4'>
          ¡Conecta con los mejores profesionales en segundos!
        </h2>
        <p className='text-lg md:text-xl leading-relaxed max-w-3xl mb-8'>
          Con Servineo, encontrar ayuda confiable nunca fue tan rápido y seguro. Dale el impulso que
          tu día necesita y empieza a disfrutar de servicios profesionales a tu alcance.
        </p>
        <button
          onClick={() => (window.location.href = '/')}
          className='bg-white text-[var(--primary)] font-semibold rounded-full px-8 py-4 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105'
        >
          ¡Prueba Servineo ahora!
        </button>
      </section>
    </main>
  );
}
</file>

<file path="src/app/[locale]/profile/[id]/components.tsx">
'use client';

import { useCallback, useEffect, useState } from 'react';
import { jsonFetcher, type FixerRating } from './utils';
import { apiUrl } from '@/config/api';
import { DetailsModal } from '@/app/components/fixers/DetailsModal';

function useFixerRatings(fixerId: string, pollInterval: number = 2000) {
  const [ratings, setRatings] = useState<FixerRating[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  const url = fixerId ? apiUrl(`/api/ratings.details/${fixerId}`) : null;

  type RatingResponse = {
    _id: string;
    title?: string;
    rating: 1 | 2 | 3;
    comment?: string;
    createdAt: string;
  };

  const load = useCallback(async () => {
    if (!url) return;
    try {
      const data = await jsonFetcher<RatingResponse[]>(url);
      const mapped = data.map((d) => ({
        id: d._id,
        requester: d.title || 'Unknown',
        score: d.rating as 1 | 2 | 3,
        comment: d.comment || '',
        createdAt: d.createdAt,
      }));
      setRatings(mapped);
      setError(null);
    } catch (err) {
      setError(err as Error);
      setRatings([]);
    } finally {
      setIsLoading(false);
    }
  }, [url]);

  useEffect(() => {
    setIsLoading(true);
    load();
  }, [url, load]);

  useEffect(() => {
    const interval = setInterval(() => {
      load();
    }, pollInterval);

    return () => clearInterval(interval);
  }, [load, pollInterval]);

  return { ratings, isLoading, error, refresh: load };
}

export function StarRating({
  value,
  size = 18,
  srLabel,
}: {
  value: 1 | 2 | 3;
  size?: number;
  srLabel?: string;
}) {
  return (
    <div className='inline-flex gap-1' aria-label={srLabel ?? `${value} of 3 stars`}>
      {Array.from({ length: 3 }).map((_, i) => {
        const filled = i < value;
        return (
          <svg
            key={i}
            width={size}
            height={size}
            viewBox='0 0 24 24'
            role='img'
            aria-hidden='true'
            style={
              filled
                ? { fill: 'var(--highlight)' }
                : { fill: 'transparent', stroke: 'var(--highlight)' }
            }
          >
            <path d='M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z' />
          </svg>
        );
      })}
    </div>
  );
}

export function RatingDetailsList({
  ratings,
  error,
  fixerId,
}: {
  ratings: FixerRating[];
  error?: string;
  fixerId: string;
}) {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedRatingId, setSelectedRatingId] = useState<string | null>(null);
  const [expandedCommentId, setExpandedCommentId] = useState<string | null>(null);
  const [isMobile, setIsMobile] = useState(false);

  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth < 640);
    window.addEventListener('resize', handleResize);
    handleResize();
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  const commentLengthLimit = isMobile ? 100 : 200;
  const toggleComment = (id: string) => setExpandedCommentId((prev) => (prev === id ? null : id));

  if (error) {
    return (
      <div className='p-4 rounded-lg text-sm error-box'>
        ⚠️ Ocurrió un problema al cargar las calificaciones. Inténtalo nuevamente.
      </div>
    );
  }

  if (!ratings?.length) {
    return (
      <div
        className='p-6 text-sm border rounded-lg'
        style={{
          color: 'var(--text-muted)',
          background: 'var(--surface-card)',
          borderColor: 'var(--surface-border)',
        }}
      >
        Este FIXER no tiene calificaciones registradas.
      </div>
    );
  }

  const ordered = [...ratings].sort((a, b) => +new Date(b.createdAt) - +new Date(a.createdAt));

  return (
    <>
      <DetailsModal
        isOpen={isModalOpen}
        onClose={() => {
          setIsModalOpen(false);
          setSelectedRatingId(null);
        }}
        onAccept={() => {
          setIsModalOpen(false);
          setSelectedRatingId(null);
        }}
        dataId={selectedRatingId || ''}
        fixerId={fixerId}
      />
      <ul className='flex flex-col gap-4'>
        {ordered.map((r) => {
          const isLongComment = r.comment && r.comment.length > commentLengthLimit;
          return (
            <li
              key={r.id}
              className='flex items-start gap-4 p-4 rounded-xl transition-colors border cursor-pointer hover:!bg-gray-200'
              style={{ borderColor: 'var(--surface-border)', background: 'var(--surface-card)' }}
              onClick={() => {
                setSelectedRatingId(r.id);
                setIsModalOpen(true);
              }}
            >
              <div className='h-10 w-10 shrink-0 rounded-full bg-neutral-200 flex items-center justify-center overflow-hidden'>
                <span className='text-xs'>👤</span>
              </div>

              <div className='flex-1 min-w-0'>
                <div className='flex flex-wrap items-center justify-between gap-2'>
                  <p className='font-medium truncate'>{r.requester}</p>
                  <StarRating value={r.score} />
                </div>

                <p className='text-xs' style={{ color: 'var(--text-muted)' }}>
                  {new Date(r.createdAt).toLocaleDateString()}
                </p>

                <p
                  className={`text-sm mt-1 leading-6 ${expandedCommentId === r.id ? '' : 'line-clamp-2'}`}
                  style={{ color: 'color-mix(in srgb, var(--foreground) 80%, transparent)' }}
                >
                  {r.comment}
                </p>

                {isLongComment && (
                  <button
                    className='mt-2 text-xs sm:hidden'
                    style={{ color: 'var(--primary)' }}
                    onClick={() => toggleComment(r.id)}
                    aria-expanded={expandedCommentId === r.id}
                  >
                    {expandedCommentId === r.id ? 'See less' : 'See more'}
                  </button>
                )}
              </div>
            </li>
          );
        })}
      </ul>
    </>
  );
}

export function ClientRatings({ fixerId }: { fixerId: string }) {
  const { ratings, isLoading, error } = useFixerRatings(fixerId);
  if (isLoading) return <div className='p-4 text-sm'>Loading...</div>;
  return <RatingDetailsList ratings={ratings} error={error?.message} fixerId={fixerId} />;
}
</file>

<file path="src/app/[locale]/profile/[id]/fixer-profile.tsx">
'use client';
import { useRouter } from 'next/navigation';
import { useProfile } from './hooks/useProfile';
import Image from 'next/image';

type FixerProfileProps = {
  userId: string;
};

export default function FixerProfile({ userId }: FixerProfileProps) {
  const { data, errors } = useProfile(userId);
  const router = useRouter();

  const calculatePercentages = () => {
    if (!data) return { 1: 0, 2: 0, 3: 0 };
    const total = data.rating_count || 0;
    if (total === 0) return { 1: 0, 2: 0, 3: 0 };

    const p3 = Math.floor((data.ratings[3] / total) * 100);
    const p2 = Math.floor((data.ratings[2] / total) * 100);
    const p1 = Math.floor((data.ratings[1] / total) * 100);

    const percentages = [p3, p2, p1];
    const sum = percentages.reduce((acc, v) => acc + v, 0);
    const diff = 100 - sum;
    // Ajustar el último para sumar 100%
    percentages[percentages.length - 1] += diff;

    return { 3: percentages[0], 2: percentages[1], 1: percentages[2] };
  };

  const displayPercentages = calculatePercentages();

  return (
    <div className='w-full bg-white rounded-2xl shadow-lg border border-gray-200 text-black p-8'>
      {data ? (
        <>
          <h2 className='text-lg font-semibold uppercase tracking-wide mb-4'>Perfil del Fixer</h2>
          <div className='md:flex md:flex-row-reverse justify-between w-full'>
            <div className='flex flex-col items-center'>
              {!data.photo_url ? (
                <div className='w-24 h-24 rounded-full bg-gray-100 border-2 border-gray-300 flex items-center justify-center mb-4'>
                  <svg
                    xmlns='http://www.w3.org/2000/svg'
                    width='24'
                    height='24'
                    viewBox='0 0 24 24'
                    fill='none'
                    stroke='currentColor'
                    strokeWidth='2'
                    strokeLinecap='round'
                    strokeLinejoin='round'
                    className='lucide lucide-user-icon lucide-user'
                  >
                    <path d='M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2' />
                    <circle cx='12' cy='7' r='4' />
                  </svg>
                </div>
              ) : (
                <Image
                  src={data.photo_url}
                  alt={data.name}
                  width={96}
                  height={96}
                  className='w-24 h-24 rounded-full object-cover'
                  priority
                />
              )}

              <div className='flex gap-2 mb-4'>
                {[1, 2, 3].map((star) => (
                  <svg
                    key={star}
                    xmlns='http://www.w3.org/2000/svg'
                    width='20'
                    height='20'
                    viewBox='0 0 24 24'
                    fill='none'
                    stroke='currentColor'
                    strokeWidth='2'
                    strokeLinecap='round'
                    strokeLinejoin='round'
                    className='lucide lucide-star-icon lucide-star w-6 h-6'
                  >
                    <path d='M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z' />
                  </svg>
                ))}
              </div>

              <button
                className='px-4 py-2 text-xs font-medium bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors'
                onClick={() => router.push(`/fixer-ratings-details/${userId}`)}
              >
                VER DETALLES DE CALIFICACIONES
              </button>
            </div>

            <div className='mb-3 md:mr-5 md:w-[60%] mt-3'>
              <div className='flex items-baseline gap-2'>
                <span className='md:text-sm font-medium text-xs'>Nombre:</span>
                <span className='md:text-base font-semibold text-sm'>{data?.name}</span>
              </div>
              <div className='flex items-baseline gap-2'>
                <span className='md:text-sm font-medium text-xs'>Rol:</span>
                <span className='md:text-base font-semibold text-sm'>{data?.role}</span>
              </div>

              <div className='flex flex-col justify-center items-center md:block mt-4'>
                <h3 className='text-sm font-semibold mb-1'>
                  {`CALIFICACIONES `} {data && <span>({data?.rating_count})</span>}
                </h3>

                <div className='flex items-center gap-1 mb-4'>
                  {[1, 2, 3].map((star) =>
                    data?.average_rating && data.average_rating >= star ? (
                      <svg
                        key={star}
                        xmlns='http://www.w3.org/2000/svg'
                        width='20'
                        height='20'
                        viewBox='0 0 24 24'
                        fill='none'
                        stroke='currentColor'
                        strokeWidth='2'
                        strokeLinecap='round'
                        strokeLinejoin='round'
                        className='lucide lucide-star-icon lucide-star w-5 h-5 fill-amber-400 text-amber-400'
                      >
                        <path d='M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z' />
                      </svg>
                    ) : (
                      <svg
                        key={star}
                        xmlns='http://www.w3.org/2000/svg'
                        width='20'
                        height='20'
                        viewBox='0 0 24 24'
                        fill='none'
                        stroke='currentColor'
                        strokeWidth='2'
                        strokeLinecap='round'
                        strokeLinejoin='round'
                        className='lucide lucide-star-icon lucide-star w-5 h-5'
                      >
                        <path d='M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z' />
                      </svg>
                    ),
                  )}
                </div>
              </div>

              <div className='space-y-3'>
                {[3, 2, 1].map((rating) => (
                  <div key={rating} className='flex items-center gap-3'>
                    <span className='text-xs w-20'>
                      {rating} {rating === 1 ? 'ESTRELLA' : 'ESTRELLAS'}
                    </span>
                    <div className='flex-1 h-2 bg-gray-200 rounded-full overflow-hidden'>
                      <div
                        className='h-full bg-black rounded-full transition-all duration-300'
                        style={{
                          width: `${displayPercentages[rating as 1 | 2 | 3]}%`,
                        }}
                      />
                    </div>
                    <span className='text-xs font-medium w-8'>
                      {displayPercentages[rating as 1 | 2 | 3]}%
                    </span>
                  </div>
                ))}
              </div>

              <div className='mt-4 pt-1'>
                <p className='text-xs '>
                  PROMEDIO DE CALIFICACIONES
                  {data && (
                    <span className='font-bold '>{` ${Number(data?.average_rating.toFixed(2))}`}</span>
                  )}
                </p>
              </div>
            </div>
          </div>

          <div className='md:flex md:justify-end mt-6'>
            <button
              onClick={() => router.back()}
              className='w-full md:w-32 py-3 px-6 cursor-pointer bg-black text-white font-medium rounded-lg hover:bg-black/90 transition-colors'
            >
              Aceptar
            </button>
          </div>
        </>
      ) : errors ? (
        <div className='flex items-center justify-center'>
          <div className='bg-white border rounded-xl p-8 max-w-sm shadow-sm'>
            <h2 className='text-xl font-semibold text-red-600 mb-2'>Error</h2>
            <p className='text-gray-700 mb-6'>{errors}</p>
            <button
              onClick={() => router.back()}
              className='cursor-pointer w-full bg-red-500 text-white py-2 rounded hover:bg-red-600 transition'
            >
              OK
            </button>
          </div>
        </div>
      ) : (
        <div className='flex items-center justify-center py-10'>
          <svg
            xmlns='http://www.w3.org/2000/svg'
            width='35'
            height='35'
            viewBox='0 0 24 24'
            fill='none'
            stroke='currentColor'
            strokeWidth='2'
            strokeLinecap='round'
            strokeLinejoin='round'
            className='lucide lucide-loader-circle-icon lucide-loader-circle animate-spin '
          >
            <path d='M21 12a9 9 0 1 1-6.219-8.56' />
          </svg>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/app/[locale]/profile/[id]/hooks/useProfile.ts">
import { useState, useEffect } from 'react';
import { apiUrl } from '@/config/api';
type ProfileData = {
  name: string;
  photo_url: string;
  role: string;
  ratings: {
    1: number;
    2: number;
    3: number;
  };
  average_rating: number;
  rating_count: number;
};
export const useProfile = (userId: string | undefined) => {
  const [data, setData] = useState<ProfileData | null>(null);
  const [errors, setErrors] = useState<string | null>(null);

  useEffect(() => {
    if (!userId) {
      setErrors('There is no user ID provided');
      return;
    }

    const fetchData = async () => {
      try {
        const url = apiUrl(`api/profile/${userId}`);
        const response = await fetch(url, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
          cache: 'no-store',
        });
        if (!response.ok) {
          const status = response.status;
          const bodyText = await response.text().catch(() => '');
          let message = 'Unknown error';
          switch (status) {
            case 400:
              message = 'Invalid ID';
              break;
            case 422:
              message = 'Invalid ID format';
              break;
            case 404:
              message = 'User not found';
              break;
            case 500:
              message = 'Server error';
              break;
            default:
              message = bodyText || `Error ${status}`;
          }
          setErrors(message);
          return;
        }
        const result = await response.json();
        setData(result);
      } catch (error) {
        console.error('Crash: Error fetching profile data:', error);
        setErrors('Network error');
      }
    };

    fetchData();
  }, [userId]);

  return { data, errors };
};
</file>

<file path="src/app/[locale]/profile/[id]/modal-window.tsx">
type ModalProps = {
  isOpen: boolean;
  onClose: () => void;
  children: React.ReactNode;
};

export default function Modal({ isOpen, onClose, children }: ModalProps) {
  return (
    <>
      {isOpen && (
        <>
          <div
            className='fixed inset-0 bg-black/50 backdrop-blur-sm z-40 h-screen'
            onClick={onClose}
          />
          <div className='fixed z-50 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-transparent rounded-2xl shadow-lg'>
            {children}
          </div>
        </>
      )}
    </>
  );
}
</file>

<file path="src/app/[locale]/profile/[id]/page.tsx">
'use client';
import { useParams } from 'next/navigation';
import FixerProfile from './fixer-profile';
import { ClientRatings } from './components';
import './theme.css';

export default function ProfilePage() {
  const { id } = useParams();

  if (!id) {
    return (
      <div className='flex items-center justify-center min-h-screen bg-gray-100'>
        <div className='bg-white p-6 rounded-lg shadow'>ID de usuario no proporcionado.</div>
      </div>
    );
  }

  return (
    <div className='min-h-screen bg-gray-100 flex flex-col'>
      <header className='bg-white border-b border-gray-300 w-full fixed top-0 left-0 z-50'>
        <div className='px-6 py-4'>
          <h1 className='text-xl font-semibold text-gray-900'>Servineo</h1>
        </div>
      </header>

      <main className='flex-grow pt-20 px-6 pb-12'>
        <div className='max-w-4xl mx-auto space-y-8'>
          <FixerProfile userId={id as string} />

          <section
            aria-labelledby='ratings-heading'
            className='bg-white rounded-2xl border border-gray-200 p-6 shadow-sm'
          >
            <div className='flex items-center justify-between mb-4'>
              <h2 id='ratings-heading' className='text-2xl font-semibold tracking-tight'>
                Rating Details
              </h2>
            </div>

            <div>
              <ClientRatings fixerId={id as string} />
            </div>
          </section>
        </div>
      </main>
    </div>
  );
}
</file>

<file path="src/app/[locale]/profile/[id]/theme.css">
:root {
  --background: #f9fafb;
  --foreground: #111827;

  --surface-card: #ffffff;
  --surface-border: #d1d5db;
  --text-muted: #64748b;

  --primary-light: #1aa7ed;
  --primary: #2b31e0;
  --primary-medium: #2b6ae0;

  --accent: #2bdde0;
  --accent-hover: #5e2be0;
  --highlight: #fbbf24;

  --success: #16a34a;
  --warning: #f59e0b;
  --error: #ef4444;
}

.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.transition-height {
  transition: max-height 0.3s ease-in-out;
}

.error-box {
  border: 1px solid var(--error);
  color: var(--error);
  background: color-mix(in srgb, var(--error) 10%, transparent);
}
</file>

<file path="src/app/[locale]/profile/[id]/utils.ts">
export type FixerRating = {
  id: string;
  requester: string;
  avatarUrl?: string;
  score: 1 | 2 | 3;
  comment?: string;
  createdAt: string;
};

export const mockRatings: FixerRating[] = [
  {
    id: 'r1',
    requester: 'Pedro Silvestre',
    score: 3,
    comment:
      'Buen trabajo y puntual. Recomiendo su trabajo ademas de lo mencionado es ordenado, limpio y respetuoso.',
    createdAt: '2025-10-07T13:20:00Z',
  },
  {
    id: 'r2',
    requester: 'Jesús Mamani',
    score: 3,
    comment: 'Excelente acabado.',
    createdAt: '2025-10-05T09:10:00Z',
  },
  {
    id: 'r3',
    requester: 'Silvia Cano',
    score: 2,
    comment: 'Cumplió pero tardó un poco.',
    createdAt: '2025-10-03T18:45:00Z',
  },
  {
    id: 'r4',
    requester: 'Álvaro Coca',
    score: 1,
    comment: 'Podría mejorar la limpieza.',
    createdAt: '2025-09-29T11:00:00Z',
  },
  {
    id: 'r5',
    requester: 'Andrea Chávez',
    score: 1,
    comment: 'Podría mejorar la limpieza.',
    createdAt: '2025-10-29T11:00:00Z',
  },
  {
    id: 'r6',
    requester: 'Saul Mamani',
    score: 2,
    comment: 'Podría mejorar la limpieza.',
    createdAt: '2025-11-29T11:00:00Z',
  },
];

export async function jsonFetcher<T = unknown>(input: RequestInfo, init?: RequestInit) {
  const res = await fetch(input, { ...init, cache: 'no-store' });
  if (!res.ok) {
    const text = await res.text();
    throw new Error(`HTTP ${res.status}: ${text}`);
  }
  return (await res.json()) as T;
}
</file>

<file path="src/app/[locale]/promotions/[jobId]/page.tsx">
'use client';

import { useEffect, useState, useCallback } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { getPromotionsByOfferId, deletePromotion, updatePromotion } from '@/services/promotions';
import { getJobInfo } from '@/services/job-info';
import { Promotion } from '@/types/promotion';
import CreatePromoModal from '@/app/components/fixers/CreatePromoModal';

export default function JobPromotionsPage() {
  const params = useParams();
  const router = useRouter();
  const jobId = params.jobId as string;

  const [promotions, setPromotions] = useState<Promotion[]>([]);
  const [jobTitle, setJobTitle] = useState<string>('Detalle del Trabajo');
  const [loading, setLoading] = useState(true);

  const [selectedIds, setSelectedIds] = useState<string[]>([]);
  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [editingPromotion, setEditingPromotion] = useState<Promotion | null>(null);

  const loadData = useCallback(async () => {
    setLoading(true);
    try {
      try {
        const jobData = await getJobInfo(jobId);
        if (jobData?.title) setJobTitle(jobData.title);
      } catch (e) {
        console.warn('No se pudo cargar info del trabajo.', e);
      }

      const promosData = await getPromotionsByOfferId(jobId);
      setPromotions(Array.isArray(promosData) ? promosData : []);
    } catch (error) {
      console.error('Error general:', error);
    } finally {
      setLoading(false);
    }
  }, [jobId]);

  useEffect(() => {
    if (jobId) loadData();
  }, [jobId, loadData]);

  const toggleSelection = (id: string) => {
    setSelectedIds((prev) =>
      prev.includes(id) ? prev.filter((item) => item !== id) : [...prev, id],
    );
  };

  const handleEditPromotion = async (promotion: {
    title: string;
    description: string;
    offerId: string;
    fixerId: string;
    price: string;
  }) => {
    if (!editingPromotion) return;

    try {
      const result = await updatePromotion(editingPromotion._id, {
        title: promotion.title,
        description: promotion.description,
      });

      if (result) {
        await loadData();
        setIsEditModalOpen(false);
        setEditingPromotion(null);
      } else {
        alert('Error al actualizar la promoción');
      }
    } catch (error) {
      console.error('Error updating promotion:', error);
      alert('Error al actualizar la promoción');
    }
  };

  const handleDeleteConfirm = async () => {
    setIsDeleting(true);
    try {
      const deletePromises = selectedIds.map((id) => deletePromotion(id));
      await Promise.all(deletePromises);

      await loadData();
      setSelectedIds([]);
      setIsDeleteModalOpen(false);
    } catch (error) {
      alert('Hubo un error al eliminar algunas promociones');
      console.error('Error deleting promotions:', error);
    } finally {
      setIsDeleting(false);
    }
  };

  const selectedPromosTitles = promotions
    .filter((p) => selectedIds.includes(p._id))
    .map((p) => p.title);

  return (
    <div className='min-h-screen bg-white text-black font-sans relative'>
      <div className='max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 pb-24'>
        {' '}
        {/* pb-24 para espacio del botón fijo */}
        <div className='flex items-center justify-between mb-8 border-b border-gray-200 pb-4'>
          <button
            onClick={() => router.back()}
            className='px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors shadow-sm'
          >
            Volver
          </button>

          <h1 className='text-lg sm:text-2xl font-bold text-gray-900 text-center flex-1 px-2 truncate'>
            Promotions - {loading ? '...' : jobTitle}
          </h1>
          <div className='w-[70px] hidden sm:block'></div>
        </div>
        {loading ? (
          <div className='flex flex-col items-center justify-center py-20'>
            <div className='animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600'></div>
          </div>
        ) : promotions.length === 0 ? (
          <div className='text-center py-20 bg-gray-50 rounded-2xl border border-dashed border-gray-300'>
            <p className='text-gray-500'>No promotions found for this job.</p>
          </div>
        ) : (
          <div className='space-y-3'>
            {promotions.map((promo) => {
              const isSelected = selectedIds.includes(promo._id);
              return (
                <div
                  key={promo._id}
                  className={`
                    group flex items-center justify-between p-4 rounded-xl border transition-all duration-200
                    ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-white hover:border-gray-400'}
                  `}
                >
                  <div
                    onClick={() => toggleSelection(promo._id)}
                    className='flex-1 min-w-0 pr-4 cursor-pointer'
                  >
                    <h3 className='text-base font-bold text-gray-900'>{promo.title}</h3>
                    <p className='text-sm text-gray-600 line-clamp-1'>{promo.description}</p>
                  </div>

                  <div className='flex items-center gap-2 shrink-0'>
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        setEditingPromotion(promo);
                        setIsEditModalOpen(true);
                      }}
                      className='px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors'
                    >
                      Editar
                    </button>

                    <div
                      onClick={() => toggleSelection(promo._id)}
                      className={`
                        w-6 h-6 rounded-md border-2 flex items-center justify-center transition-colors cursor-pointer
                        ${isSelected ? 'bg-black border-black' : 'bg-white border-gray-400'}
                      `}
                    >
                      {isSelected && (
                        <svg
                          width='14'
                          height='14'
                          viewBox='0 0 24 24'
                          fill='none'
                          stroke='white'
                          strokeWidth='4'
                          strokeLinecap='round'
                          strokeLinejoin='round'
                        >
                          <polyline points='20 6 9 17 4 12'></polyline>
                        </svg>
                      )}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}
        <div className='fixed bottom-8 left-0 right-0 px-4 flex justify-center z-10'>
          <button
            onClick={() => setIsDeleteModalOpen(true)}
            disabled={selectedIds.length === 0}
            className={`
              px-8 py-3 rounded-lg font-medium shadow-lg transition-all transform
              ${
                selectedIds.length === 0
                  ? 'bg-blue-300 text-white cursor-not-allowed'
                  : 'bg-blue-600 text-white hover:bg-blue-700 hover:scale-105'
              }
            `}
          >
            Remove selected promos
          </button>
        </div>
      </div>

      <CreatePromoModal
        isOpen={isEditModalOpen}
        onClose={() => {
          setIsEditModalOpen(false);
          setEditingPromotion(null);
        }}
        onSave={handleEditPromotion}
        id={jobId}
        fixerId={editingPromotion?.fixerId || ''}
        initialTitle={editingPromotion?.title}
        initialDescription={editingPromotion?.description}
        isEditMode={true}
      />

      {isDeleteModalOpen && (
        <div className='fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4'>
          <div className='bg-white rounded-2xl shadow-xl w-full max-w-md p-6 relative animate-fadeIn'>
            <button
              onClick={() => setIsDeleteModalOpen(false)}
              className='absolute top-4 right-4 text-gray-400 hover:text-gray-600'
            >
              <svg
                width='24'
                height='24'
                viewBox='0 0 24 24'
                fill='none'
                stroke='currentColor'
                strokeWidth='2'
                strokeLinecap='round'
                strokeLinejoin='round'
              >
                <line x1='18' y1='6' x2='6' y2='18'></line>
                <line x1='6' y1='6' x2='18' y2='18'></line>
              </svg>
            </button>

            <h3 className='text-lg font-semibold text-center mb-4 text-gray-900'>
              Are you sure to remove this promo/s?
            </h3>

            <div className='bg-gray-50 rounded-lg p-4 mb-6 max-h-40 overflow-y-auto border border-gray-100'>
              <ul className='text-center space-y-1'>
                {selectedPromosTitles.map((title, index) => (
                  <li key={index} className='text-sm text-gray-700 font-medium'>
                    {title}
                  </li>
                ))}
              </ul>
            </div>

            <div className='flex justify-center'>
              <button
                onClick={handleDeleteConfirm}
                disabled={isDeleting}
                className='bg-blue-600 text-white px-8 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-70'
              >
                {isDeleting ? 'Deleting...' : 'Accept'}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
//conclitos resueltos
</file>

<file path="src/app/[locale]/providers.tsx">
'use client';

import { Provider } from 'react-redux';
import { store } from '../redux/store';

export function Providers({ children }: { children: React.ReactNode }) {
  return <Provider store={store}>{children}</Provider>;
}
</file>

<file path="src/app/[locale]/requested-jobs/[id]/page.tsx">
'use client';
import { useParams } from 'next/navigation';
import { apiUrl } from '@/config/api';
import { useEffect, useState } from 'react';
import RegisterJobModal from '@/app/components/fixers/RegisterJobModal';

interface Job {
  id: string;
  client: string;
  description: string;
  schedule: string;
}

export default function JobDetailsPage() {
  const { id } = useParams();
  const [job, setJob] = useState<Job | null>(null);
  const [loading, setLoading] = useState(true);
  const [isModalOpen, setIsModalOpen] = useState(false);

  useEffect(() => {
    if (!id) {
      setJob({ id: '', client: '', description: '', schedule: '' });
      setLoading(false);
      return;
    }

    const fetchJob = async () => {
      try {
        const res = await fetch(apiUrl(`api/requested-jobs/${id}`));
        if (!res.ok) throw new Error('Job not found');
        const data = await res.json();

        setJob({
          id: data._id ?? '',
          client: data.title ?? '',
          description: data.description ?? '',
          schedule: data.createdAt ? new Date(data.createdAt).toLocaleTimeString() : '',
        });
      } catch (error) {
        console.error('Error fetching job:', error);
        setJob({ id: '', client: '', description: '', schedule: '' });
      } finally {
        setLoading(false);
      }
    };

    fetchJob();
  }, [id]);

  if (loading) {
    return (
      <main className='h-screen flex items-center justify-center text-gray-500 bg-white'>
        Loading job details...
      </main>
    );
  }

  return (
    <main className='min-h-screen bg-gray-50 flex flex-col'>
      <header className='w-full bg-white shadow-sm p-4 flex justify-between items-center border-b'>
        <h1 className='text-2xl font-semibold text-gray-800'>Servineo</h1>
      </header>

      <section className='flex-1 p-6'>
        <h2 className='text-lg font-semibold text-gray-700 mb-4 border-b pb-2'>
          Appointment Details
        </h2>

        <div className='flex items-center mb-6'>
          <div className='w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center text-white mr-3'>
            👤
          </div>
          <p className='font-medium text-gray-700 text-lg'>{job?.client}</p>
        </div>

        <div className='mb-6'>
          <p className='font-semibold text-gray-700 mb-1'>Description:</p>
          <p className='text-gray-600'>{job?.description}</p>
        </div>

        <div className='mb-12'>
          <p className='font-semibold text-gray-700 mb-1'>Scheduled appointment time:</p>
          <p className='text-gray-600'>{job?.schedule}</p>
        </div>
      </section>

      <footer className='w-full bg-white border-t p-4 flex justify-end'>
        <button
          onClick={() => setIsModalOpen(true)}
          className='bg-blue-600 text-white font-medium px-6 py-2 rounded-lg hover:bg-blue-700'
        >
          Register job
        </button>
      </footer>

      <RegisterJobModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        id={job?.id ?? ''}
      />
    </main>
  );
}
</file>

<file path="src/app/[locale]/requesterEdit/buttonCS.tsx">
import * as React from 'react';
import { Slot } from '@radix-ui/react-slot';
import { cva, type VariantProps } from 'class-variance-authority';
import { cn } from '@/app/lib/utils/utilsDevices';

const buttonVariants = cva(
  'inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0',
  {
    variants: {
      variant: {
        default: 'bg-primary text-primary-foreground shadow hover:bg-primary/90',
        destructive: 'bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90',
        outline:
          'border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground',
        secondary: 'bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80',
        ghost: 'hover:bg-accent hover:text-accent-foreground',
        link: 'text-primary underline-offset-4 hover:underline',
      },
      size: {
        default: 'h-9 px-4 py-2',
        sm: 'h-8 rounded-md px-3 text-xs',
        lg: 'h-10 rounded-md px-8',
        icon: 'h-9 w-9',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  },
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>, VariantProps<typeof buttonVariants> {
  asChild?: boolean;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : 'button';
    return (
      <Comp ref={ref} className={cn(buttonVariants({ variant, size, className }))} {...props} />
    );
  },
);

Button.displayName = 'Button';

export { Button, buttonVariants };
</file>

<file path="src/app/[locale]/requesterEdit/cardCS.tsx">
import * as React from 'react';

import { cn } from '@/app/lib/utils/utilsDevices';

const Card = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div
      ref={ref}
      className={cn('rounded-xl border bg-card text-card-foreground shadow', className)}
      {...props}
    />
  ),
);
Card.displayName = 'Card';

const CardHeader = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn('flex flex-col space-y-1.5 p-6', className)} {...props} />
  ),
);
CardHeader.displayName = 'CardHeader';

const CardTitle = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div
      ref={ref}
      className={cn('font-semibold leading-none tracking-tight', className)}
      {...props}
    />
  ),
);
CardTitle.displayName = 'CardTitle';

const CardDescription = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn('text-sm text-muted-foreground', className)} {...props} />
  ),
);
CardDescription.displayName = 'CardDescription';

const CardContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn('p-6 pt-0', className)} {...props} />
  ),
);
CardContent.displayName = 'CardContent';

const CardFooter = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn('flex items-center p-6 pt-0', className)} {...props} />
  ),
);
CardFooter.displayName = 'CardFooter';

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent };
</file>

<file path="src/app/[locale]/requesterEdit/closeSession/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useDevices } from '@/app/lib/hooks/useDevices';
import { Button } from '../buttonCS';
//import { Card, CardContent } from "../cardCS";
import { ArrowLeft, Laptop, Monitor, Smartphone, AlertCircle } from 'lucide-react';
import { useTranslations } from "next-intl";

export default function CloseSessionPage() {
  const t = useTranslations('CloseSessionPage');
  const router = useRouter();
  const [userId, setUserId] = useState<string>('');
  const [showConfirmation, setShowConfirmation] = useState(false);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);

  const { sessions, loading, error, currentDeviceId, fetchSessions, closeAllOtherSessions } =
    useDevices(userId);

  useEffect(() => {
    const storedUserId = localStorage.getItem('userId') || localStorage.getItem('user_id');
    if (storedUserId) setUserId(storedUserId);
  }, []);

  useEffect(() => {
    if (userId) {
      fetchSessions();
      const interval = setInterval(() => fetchSessions(), 30000);
      return () => clearInterval(interval);
    }
  }, [userId, fetchSessions]);

  const handleCloseAllSessions = async () => {
    const result = await closeAllOtherSessions();
    setShowConfirmation(false);

    if (result.success) {
      setSuccessMessage(result.message);
      setTimeout(() => setSuccessMessage(null), 5000);
    }
  };

  const getDeviceIcon = (deviceType: string) => {
    const type = deviceType.toLowerCase();
    if (type.includes('mobile') || type.includes('android'))
      return <Smartphone size={24} className="text-gray-700" />;
    if (type.includes('tablet') || type.includes('ipad'))
      return <Monitor size={24} className="text-gray-700" />;
    return <Laptop size={24} className="text-gray-700" />;
  };

  const activeSessions = sessions.filter((s) => s.isActive);
  const otherSessions = activeSessions.filter((s) => s.deviceId !== currentDeviceId);

  /*  if (!userId) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="bg-white border border-gray-200 rounded-2xl shadow-md p-8 text-center">
          <h2 className="text-2xl font-semibold text-gray-900 mb-4">
            Sesión no detectada
          </h2>
          <p className="text-gray-500">
            Por favor, inicia sesión para ver tus dispositivos activos.
          </p>
        </div>
      </div>
    );
  }*/

  if (loading && activeSessions.length === 0) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-50">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
          <p className="text-gray-600">{t('loading')}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="w-full max-w-4xl bg-white border border-gray-200 rounded-2xl shadow-md p-8 mx-auto my-10">
      <button
        onClick={() => router.push('/requesterEdit/')}
        className="flex items-center text-gray-600 hover:text-gray-800 mb-6"
      >
        <ArrowLeft className="w-5 h-5 mr-2" /> Volver
      </button>

      <h1 className="text-2xl font-semibold text-gray-900 mb-3 text-center">
        {t('title')}
      </h1>
      <p className="text-gray-600 mb-8 text-center">
        {t('description')}
      </p>

      {successMessage && (
        <div className="mb-6 bg-green-50 border border-green-200 text-green-800 rounded-xl p-4 text-center">
          <AlertCircle className="w-5 h-5 inline mr-2 text-green-600" />
          {successMessage}
        </div>
      )}

      {error && (
        <div className="mb-6 bg-red-50 border border-red-200 text-red-700 rounded-xl p-4 text-center">
          <AlertCircle className="w-5 h-5 inline mr-2 text-red-600" />
          {error}
        </div>
      )}

      {activeSessions.length >= 3 && (
        <div className="mb-6 bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-xl p-4 text-center">
          <AlertCircle className="w-5 h-5 inline mr-2 text-yellow-600" />
           {t('warnings.deviceLimit')}
        </div>
      )}

      <div className="bg-blue-50 border-l-4 border-blue-400 rounded-xl p-4 mb-8">
        <p className="text-blue-800 text-sm">
          <strong>{t('important')}:</strong> {t('warnings.closeSessionsWarning')}
        </p>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
        <div className="bg-gray-50 border border-gray-200 rounded-xl p-4 text-center">
          <p className="text-sm text-gray-500">{t('stats.activeSessions')}</p>
          <p className="text-2xl font-semibold text-gray-900">
            {activeSessions.length}
          </p>
        </div>
        <div className="bg-gray-50 border border-gray-200 rounded-xl p-4 text-center">
          <p className="text-sm text-gray-500">{t('stats.otherDevices')}</p>
          <p className="text-2xl font-semibold text-gray-900">
            {otherSessions.length}
          </p>
        </div>
        <div className="bg-gray-50 border border-gray-200 rounded-xl p-4 text-center">
          <p className="text-sm text-gray-500">{t('stats.currentDevice')}</p>
          <p className="text-2xl font-semibold text-green-600">✓</p>
        </div>
      </div>

      {otherSessions.length > 0 && (
        <Button
          onClick={() => setShowConfirmation(true)}
          disabled={loading}
          className="w-full bg-red-500 text-white hover:bg-red-600 font-medium rounded-xl py-3 mb-8"
        >
          {loading
            ? t('buttons.closingSessions') : t('buttons.closeOtherSessions')}
        </Button>
      )}

      {otherSessions.length === 0 && activeSessions.length > 0 && (
        <div className="bg-gray-50 border border-gray-200 rounded-xl p-4 text-center mb-8">
          <p className="text-gray-600">
            {t('noOtherSessions')}
          </p>
        </div>
      )}

      <section>
        <h2 className="text-lg font-semibold text-gray-800 mb-4">
          {t('activeSessions.title',{ count: activeSessions.length })}
        </h2>

        {activeSessions.length === 0 ? (
          <div className="text-center py-8 text-gray-500">
            {t('activeSessions.noDevices')}
          </div>
        ) : (
          <div className="space-y-3">
            {activeSessions.map((session) => (
              <div
                key={session._id}
                className={`flex items-center justify-between border rounded-2xl px-4 py-3 shadow-sm transition ${
                  session.deviceId === currentDeviceId
                    ? 'bg-green-50 border-green-300'
                    : 'bg-white border-gray-200 hover:bg-gray-50'
                }`}
              >
                <div className="flex items-center gap-3">
                  {getDeviceIcon(session.deviceType)}
                  <div>
                    <p className="text-sm font-semibold text-gray-800 flex items-center gap-2">
                      {session.deviceName}
                      {session.deviceId === currentDeviceId && (
                        <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">
                          {t('activeSessions.thisDevice')}
                        </span>
                      )}
                    </p>
                    <p className="text-xs text-gray-600">
                      {session.browser} • {session.deviceType}
                    </p>
                    <p className="text-xs text-gray-500">IP: {session.ipAddress}</p>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </section>

      {showConfirmation && (
        <div className="fixed inset-0 flex items-center justify-center bg-black/40 z-50">
          <div className="bg-white border border-gray-200 rounded-2xl shadow-lg p-6 w-80 text-center">
            <h2 className="text-lg font-semibold text-gray-900 mb-2">
              {t('confirmation.title')}
            </h2>
            <p className="text-gray-600 mb-4 text-sm">
              {t('confirmation.message', { 
                count: otherSessions.length,
                sessions: otherSessions.length === 1 ? 
                  t('confirmation.sessionSingular') : 
                  t('confirmation.sessionPlural')
              })}
            </p>
            <div className="flex justify-around">
              <Button
                onClick={() => setShowConfirmation(false)}
                className="bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-lg"
                disabled={loading}
              >
                {t('confirmation.cancel')}
              </Button>
              <Button
                onClick={handleCloseAllSessions}
                className="bg-red-500 text-white hover:bg-red-600 rounded-lg"
                disabled={loading}
              >
                {loading ? t('confirmation.closing') : t('confirmation.confirm')}
              </Button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/app/[locale]/requesterEdit/dispositivosVinculados/dispositivosVinculados.tsx">
'use client';
import { useState, useEffect, useCallback } from 'react';
import { Laptop, Smartphone, Monitor } from 'lucide-react';
import { useRouter } from 'next/navigation';
import { UAParser } from 'ua-parser-js';
import { toast } from 'sonner';
import { useAuth } from '@/app/lib/hooks/usoAutentificacion';

interface Dispositivo {
  _id: string;
  userId: string;
  os: string;
  type: string;
  userAgent: string;
  lastLogin: string;
}

export default function DispositivosVinculados() {
  const router = useRouter();
  const { user, logout, loading } = useAuth();

  const [dispositivos, setDispositivos] = useState<Dispositivo[]>([]);
  const [cargandoDispositivos, setCargandoDispositivos] = useState(true);
  const [modalVisible, setModalVisible] = useState<string | null>(null);
  const [modalCerrarTodas, setModalCerrarTodas] = useState(false);

  const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';

  const detectarDispositivo = () => {
    const parser = new UAParser();
    const result = parser.getResult();
    const os = result.os.name || 'Desconocido';
    let type = 'desktop';
    if (result.device.type === 'mobile') type = 'mobile';
    if (result.device.type === 'tablet') type = 'tablet';
    return { os, type };
  };

  const obtenerDispositivos = useCallback(async () => {
    if (!user) return;
    try {
      setCargandoDispositivos(true);
      const res = await fetch(`${API_URL}/devices/${user.id}`);
      if (!res.ok) throw new Error('Error en la respuesta del backend');
      const data = await res.json();
      setDispositivos(data);
    } catch (err) {
      console.error(err);
      toast.error('No se pudieron cargar los dispositivos.');
    } finally {
      setCargandoDispositivos(false);
    }
  }, [user, API_URL]);

  const registrarDispositivo = useCallback(async () => {
    if (!user) return;
    const { os, type } = detectarDispositivo();
    console.log("Registrando dispositivo:", { 
    userId: user.id, 
    userAgent: navigator.userAgent 
  });
    try {
      const res = await fetch(`${API_URL}/devices/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId: user.id,
          os,
          type,
          userAgent: navigator.userAgent,
        }),
      });
      const data = await res.json();
      console.log("Respuesta del backend:", data);

      if (!res.ok) return toast.error(data.message || 'Error al registrar dispositivo');
      obtenerDispositivos();
    } catch (err) {
      console.error(err);
      toast.error('Error al registrar dispositivo');
    }
  }, [user, API_URL, obtenerDispositivos]);

  const cerrarSesionDispositivo = async (_id: string) => {
    try {
      await fetch(`${API_URL}/devices/${_id}`, { method: 'DELETE' });
      toast.success('Sesión cerrada correctamente ✓');
      setModalVisible(null);

      const dispositivoActual = dispositivos.find(d => d.userAgent === navigator.userAgent);
      if (dispositivoActual?._id === _id) {
        logout?.();
        router.push('/login');
      } else {
        obtenerDispositivos();
      }
    } catch (err) {
      console.error(err);
      toast.error('No se pudo cerrar la sesión.');
    }
  };

  const cerrarTodasSesiones = async () => {
    try {
      const userAgent = navigator.userAgent;
      const dispositivoActual = dispositivos.find(d => d.userAgent === navigator.userAgent);
      if (!dispositivoActual) return toast.error('No se pudo identificar el dispositivo actual');

      await fetch(`${API_URL}/devices/all/${user?.id}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ except: dispositivoActual._id }),
      });

      toast.success('Todas las sesiones cerradas excepto esta ✓');
      setModalCerrarTodas(false);
      obtenerDispositivos();
    } catch (err) {
      console.error(err);
      toast.error('No se pudieron cerrar las sesiones.');
    }
  };

  useEffect(() => {
    if (user) {
      registrarDispositivo();
      obtenerDispositivos();
    }
  }, [user, registrarDispositivo, obtenerDispositivos]);

  if (loading) return <p className="text-center mt-10">Cargando usuario...</p>;
  if (!user) return <p className="text-center mt-10">No hay usuario autenticado</p>;

  const iconoPorTipo = (type: string) => {
    switch (type) {
      case 'mobile':
        return <Smartphone size={28} />;
      case 'tablet':
        return <Monitor size={28} />;
      default:
        return <Laptop size={28} />;
    }
  };

  //if (cargandoDispositivos) return <p className='text-center text-gray-500'>Cargando dispositivos...</p>;
  //if (!dispositivos.length) return <p className='text-center text-gray-500'>No hay dispositivos vinculados</p>;

return (
  <div className='space-y-4 w-full'>

    {/* BOTÓN ARRIBA, CENTRADO */}
    <div className="flex justify-center mb-4">
      <button
        onClick={() => setModalCerrarTodas(true)}
        className="px-4 py-2 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 transition"
      >
        Cerrar sesión en todos los dispositivos
      </button>
    </div>

    {dispositivos.map(dispositivo => (
      <div key={dispositivo._id} className='flex items-center justify-between p-4 bg-gray-100 rounded-lg shadow'>
        <div className='flex items-center space-x-3'>
          {iconoPorTipo(dispositivo.type)}
          <div>
            <p className='font-medium'>{dispositivo.os}</p>
            <p className='text-xs text-gray-500'>
              Último acceso: {new Date(dispositivo.lastLogin).toLocaleString()}
            </p>
          </div>
        </div>

        <button
          onClick={() => setModalVisible(dispositivo._id)}
          className='px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600'
        >
          Cerrar sesión
        </button>

        {modalVisible === dispositivo._id && (
          <div className='fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm z-[9999]'>
            <div className='bg-white p-6 rounded-lg shadow-lg w-80 text-center'>
              <p className='mb-4'>¿Deseas cerrar sesión en este dispositivo?</p>
              <div className='flex justify-around'>
                <button
                  onClick={() => setModalVisible(null)}
                  className='px-4 py-2 bg-gray-300 rounded hover:bg-gray-400'
                >
                  Cancelar
                </button>
                <button
                  onClick={() => cerrarSesionDispositivo(dispositivo._id)}
                  className='px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600'
                >
                  Aceptar
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    ))}

    {modalCerrarTodas && (
      <div className='fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm z-[9999]'>
        <div className='bg-white p-6 rounded-lg shadow-lg w-80 text-center'>
          <p className='mb-4 font-semibold'>
            ¿Seguro que quieres cerrar todas las sesiones excepto esta?
          </p>
          <div className='flex justify-around'>
            <button
              onClick={() => setModalCerrarTodas(false)}
              className='px-4 py-2 bg-gray-300 rounded hover:bg-gray-400'
            >
              Cancelar
            </button>
            <button
              onClick={cerrarTodasSesiones}
              className='px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600'
            >
              Sí, cerrar
            </button>
          </div>
        </div>
      </div>
    )}
  </div>
);
}
</file>

<file path="src/app/[locale]/requesterEdit/layout.tsx">
'use client';

import { GoogleOAuthProvider } from '@react-oauth/google';
import { AuthProvider } from '../../lib/hooks/usoAutentificacion';

const GOOGLE_CLIENT_ID = '830637764593-g8v6upkgq190ivcshbur0na84glb74m0.apps.googleusercontent.com';

export default function HU7Layout({ children }: { children: React.ReactNode }) {
  return (
    <GoogleOAuthProvider clientId={GOOGLE_CLIENT_ID}>
      <AuthProvider>{children}</AuthProvider>
    </GoogleOAuthProvider>
  );
}
</file>

<file path="src/app/[locale]/requesterEdit/linkAccounts/page.tsx">
'use client';

import React, { useEffect, useState } from 'react';
import { Mail } from 'lucide-react';
import { FaGithub, FaDiscord } from 'react-icons/fa';
import { FcGoogle } from 'react-icons/fc';
import {
  obtenerMetodosCliente,
  desvincularMetodo,
  AuthProvider,
} from '@/app/redux/services/services/api';
import VincularCorreo from './vinculoCuenta/vincularCorreo';
import VincularGoogle from './vinculoCuenta/vincularGoogle';
import VincularGithub from './vinculoCuenta/vincularGithub';
import VincularDiscord from './vinculoCuenta/vincularDiscord';
import { useTranslations } from 'next-intl';

interface Props {
  token?: string;
}

const ALL_PROVIDERS_META = [
  { provider: 'google', name: 'Google' },
  { provider: 'github', name: 'GitHub' },
  { provider: 'email', name: 'Correo Electrónico' },
  { provider: 'discord', name: 'Discord' },
] as const;

interface FullAuthProvider extends AuthProvider {
  isLinked: boolean;
  name: string;
  providerId?: string;
  email?: string;
}

export default function AccountLoginSettings({ token = '' }: Props) {
  const t = useTranslations('AccountLoginSettings');
  const [methods, setMethods] = useState<FullAuthProvider[]>([]);

  const buildFullMethodsList = (linkedMethodsFromAPI: AuthProvider[]): FullAuthProvider[] => {
    const linkedMethodsMap = new Map<string, AuthProvider>(
      linkedMethodsFromAPI.map((m) => [m.provider, m]),
    );

    return ALL_PROVIDERS_META.map((p) => {
      const linkedData = linkedMethodsMap.get(p.provider);
      return {
        provider: p.provider,
        name: p.name,
        isLinked: !!linkedData,
        email: linkedData?.email,
        providerId: linkedData?.providerId,
        token: linkedData?.token,
      };
    });
  };

  useEffect(() => {
    async function fetchMethods() {
      try {
        const linkedMethodsFromAPI = await obtenerMetodosCliente();
        const fullList = buildFullMethodsList(linkedMethodsFromAPI);
        setMethods(fullList);
      } catch (err) {
        console.error('Error al cargar métodos:', err);
      }
    }
    fetchMethods();
  }, [token]);

  const linkedMethods = methods.filter((m) => m.isLinked);
  const availableMethods = methods.filter((m) => !m.isLinked);

  const handleLink = async (provider: string) => {
    try {
      const updatedLinkedMethods = await obtenerMetodosCliente();
      const fullList = buildFullMethodsList(updatedLinkedMethods);
      setMethods(fullList);
    } catch (err) {
      console.error(err);
      alert(
        t('errors.linkError', {
          provider,
          error: err instanceof Error ? err.message : t('errors.unknown'),
        }),
      );
    }
  };

  const handleUnlink = async (provider: string) => {
    if (linkedMethods.length <= 1) {
      alert(t('errors.minimumMethods'));
      return;
    }
    if (window.confirm(t('confirmUnlink', { provider }))) {
      try {
        const updatedLinkedMethods = await desvincularMetodo(provider);
        const fullList = buildFullMethodsList(updatedLinkedMethods);
        setMethods(fullList);
      } catch (err) {
        console.error(err);
        alert(
          t('errors.unlinkError', {
            provider,
            error: err instanceof Error ? err.message : t('errors.unknown'),
          }),
        );
      }
    }
  };

  return (
    <div className="
      w-full 
      max-w-3xl 
      bg-white 
      border 
      border-gray-200 
      rounded-2xl 
      shadow-md 
      p-8 
      mx-auto 
      text-left 
      [&_*]:text-left 
      [&_h1]:text-left 
      [&_h2]:text-left 
      [&_p]:text-left 
      [&_span]:text-left 
      [&_div]:text-left 
      [&_button]:text-left
    ">
      <h1 className="text-2xl font-semibold text-gray-900 mb-6">{t('title')}</h1>

      {/* Métodos vinculados */}
      <section className="mb-10">
        <h2 className="text-lg font-semibold text-gray-800 mb-3">
          {t('linkedAccounts.title', { count: linkedMethods.length })}
        </h2>

        <div className="space-y-3">
          {linkedMethods.map((method) => (
            <div
              key={method.provider}
              className="w-full flex items-center gap-3 bg-white border border-gray-200 rounded-2xl px-4 py-3 shadow-sm hover:bg-gray-50 transition"
            >
              {/* Icono */}
              <div className="flex-shrink-0">
                {method.provider === 'google' && <FcGoogle size={30} />}
                {method.provider === 'github' && <FaGithub size={30} className="text-gray-800" />}
                {method.provider === 'email' && <Mail size={28} className="text-gray-800" />}
                {method.provider === 'discord' && (
                  <FaDiscord size={30} className="text-[#5865F2]" />
                )}
              </div>

              {/* Texto */}
              <div className="flex-1 min-w-0 flex flex-col">
                <span className="text-sm font-semibold text-gray-800 flex items-center gap-2 truncate">
                  {method.name}
                  <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">
                    Activo
                  </span>
                </span>
                {method.providerId && (
                  <span className="text-xs text-gray-500 truncate">{method.providerId}</span>
                )}
              </div>

              {/* Botón de Desvincular */}
              <button
                onClick={() => handleUnlink(method.provider)}
                disabled={linkedMethods.length <= 1}
                className={`flex items-center justify-center gap-2 text-sm font-medium px-4 py-2 rounded-xl transition disabled:opacity-60 ${
                  linkedMethods.length <= 1
                    ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                    : 'bg-red-50 text-red-600 hover:bg-red-100'
                }`}
              >
                {t('buttons.unlink')}
              </button>
            </div>
          ))}
        </div>
      </section>

      {/* Métodos disponibles */}
      <section>
        <h2 className="text-lg font-semibold text-gray-800 mb-3">
          {t('availableMethods.title', { count: availableMethods.length })}
        </h2>

        {availableMethods.length === 0 ? (
          <p className="text-gray-400 py-4">{t('availableMethods.allLinked')}</p>
        ) : (
          <div className="space-y-3">
            {availableMethods.map((method) => {
              if (method.provider === 'google') {
                return (
                  <VincularGoogle
                    key="google"
                    tokenUsuario={token}
                    onLinked={() => handleLink('google')}
                  />
                );
              }

              if (method.provider === 'github') {
                return <VincularGithub key="github" onLinked={() => handleLink('github')} />;
              }

              if (method.provider === 'discord') {
                return <VincularDiscord key="discord" onLinked={() => handleLink('discord')} />;
              }

              if (method.provider === 'email') {
                return (
                  <VincularCorreo
                    key="email"
                    token={token}
                    onLinked={(client) => {
                      if (!client) return;
                      const fullList = buildFullMethodsList(client.authProviders);
                      setMethods(fullList);
                    }}
                  />
                );
              }

              return null;
            })}
          </div>
        )}
      </section>
    </div>
  );
}
</file>

<file path="src/app/[locale]/requesterEdit/linkAccounts/vinculoCuenta/vincularCorreo.tsx">
'use client';

import { useState } from 'react';
import { Mail, Eye, EyeOff } from 'lucide-react';
import { toast } from 'sonner';
import { vincularCorreoContrasena, Client } from '@/app/redux/services/services/api';
import { z } from 'zod';
import { useTranslations } from 'next-intl';

const schema = (t: (key: string) => string) =>
  z
    .object({
      email: z.string().email(t('errors.invalidEmail')),
      password: z
        .string()
        .min(8, t('errors.passwordMinLength'))
        .regex(/[A-Z]/, t('errors.passwordUppercase'))
        .regex(/[a-z]/, t('errors.passwordLowercase'))
        .regex(/[0-9]/, t('errors.passwordNumber'))
        .regex(/[^A-Za-z0-9]/, t('errors.passwordSymbol')),
      repeatPassword: z.string(),
    })
    .refine((data) => data.password === data.repeatPassword, {
      message: t('errors.passwordsDoNotMatch'),
      path: ['repeatPassword'],
    });

interface VincularCorreoProps {
  token: string;
  onLinked?: (client?: Client) => void;
}

export default function VincularCorreo({ token, onLinked }: VincularCorreoProps) {
  const t = useTranslations('VincularCorreo');
  const [mostrarFormulario, setMostrarFormulario] = useState(false);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [repeatPassword, setRepeatPassword] = useState('');
  const [mostrarPassword, setMostrarPassword] = useState(false);
  const [mostrarRepeatPassword, setMostrarRepeatPassword] = useState(false);
  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState(false);
  const [errors, setErrors] = useState<Record<string, string>>({});

  const schemaValidation = schema(t);

  // Validar dinámicamente al escribir
  const validarCampo = (campo: string, valor: string) => {
    const data = { email, password, repeatPassword, [campo]: valor };
    const result = schemaValidation.safeParse(data);

    if (!result.success) {
      const issues = result.error.issues.filter((i) => i.path[0] === campo);
      if (issues.length > 0) {
        setErrors((prev) => ({ ...prev, [campo]: issues[0].message }));
      } else {
        setErrors((prev) => {
          const newErrors = { ...prev };
          delete newErrors[campo];
          return newErrors;
        });
      }
    } else {
      setErrors({});
    }
  };

  const handleVincular = async () => {
    const result = schemaValidation.safeParse({ email, password, repeatPassword });

    if (!result.success) {
      const formattedErrors: Record<string, string> = {};
      result.error.issues.forEach((issue) => {
        formattedErrors[issue.path[0] as string] = issue.message;
      });
      setErrors(formattedErrors);
      toast.error(t('toasts.formErrors'));
      return;
    }

    setLoading(true);
    const response = await vincularCorreoContrasena(token, email, password);
    setSuccess(response.success);

    if (response.success) {
      toast.success(response.message);
      onLinked?.(response.client);
      setMostrarFormulario(false);
      setEmail('');
      setPassword('');
      setRepeatPassword('');
      setErrors({});
    } else {
      toast.error(response.message);
    }

    setLoading(false);
  };

  return (
    <div className='w-full bg-white border border-gray-200 rounded-2xl px-4 py-3 shadow-sm hover:bg-gray-50 transition'>
      <div className='flex items-center justify-between'>
        <div className='flex items-center gap-3 align-middle'>
          <Mail size={28} className='text-gray-800' />
          <div className='flex flex-col'>
            <span className='text-sm font-semibold text-gray-800'>{t('title')}</span>
            <span className='text-xs text-gray-500'>{t('subtitle')}</span>
          </div>
        </div>

        <button
          onClick={() => setMostrarFormulario((prev) => !prev)}
          className='flex items-center justify-center gap-2 bg-blue-600 text-white text-sm px-4 py-2 rounded-xl hover:bg-blue-700 transition disabled:opacity-60'
        >
          {mostrarFormulario ? t('buttons.cancel') : t('buttons.link')}
        </button>
      </div>

      {mostrarFormulario && (
        <div className='mt-4 border-t border-gray-200 pt-4'>
          {/* Correo */}
          <div className='mb-3'>
            <input
              type='email'
              placeholder={t('form.email.placeholder')}
              value={email}
              onChange={(e) => {
                setEmail(e.target.value);
                validarCampo('email', e.target.value);
              }}
              className={`border rounded-lg px-3 py-2 w-full text-gray-900 focus:ring-2 focus:ring-blue-500 outline-none ${
                errors.email ? 'border-red-500' : ''
              }`}
            />
            {errors.email && <p className='text-red-600 text-xs mt-1'>{errors.email}</p>}
          </div>

          {/* Contraseña */}
          <div className='relative mb-3'>
            <input
              type={mostrarPassword ? 'text' : 'password'}
              placeholder={t('form.password.placeholder')}
              value={password}
              onChange={(e) => {
                setPassword(e.target.value);
                validarCampo('password', e.target.value);
              }}
              className={`border rounded-lg px-3 py-2 w-full text-gray-900 focus:ring-2 focus:ring-blue-500 outline-none pr-10 ${
                errors.password ? 'border-red-500' : ''
              }`}
            />
            <button
              type='button'
              onClick={() => setMostrarPassword(!mostrarPassword)}
              className='absolute right-3 top-2.5 text-gray-500 hover:text-gray-700'
            >
              {mostrarPassword ? <EyeOff size={18} /> : <Eye size={18} />}
            </button>
            {errors.password && <p className='text-red-600 text-xs mt-1'>{errors.password}</p>}
          </div>

          {/* Repetir contraseña */}
          <div className='relative mb-3'>
            <input
              type={mostrarRepeatPassword ? 'text' : 'password'}
              placeholder={t('form.repeatPassword.placeholder')}
              value={repeatPassword}
              onChange={(e) => {
                setRepeatPassword(e.target.value);
                validarCampo('repeatPassword', e.target.value);
              }}
              className={`border rounded-lg px-3 py-2 w-full text-gray-900 focus:ring-2 focus:ring-blue-500 outline-none pr-10 ${
                errors.repeatPassword ? 'border-red-500' : ''
              }`}
            />
            <button
              type='button'
              onClick={() => setMostrarRepeatPassword(!mostrarRepeatPassword)}
              className='absolute right-3 top-2.5 text-gray-500 hover:text-gray-700'
            >
              {mostrarRepeatPassword ? <EyeOff size={18} /> : <Eye size={18} />}
            </button>
            {errors.repeatPassword && (
              <p className='text-red-600 text-xs mt-1'>{errors.repeatPassword}</p>
            )}
          </div>

          {/* Botón confirmar */}
          <button
            onClick={handleVincular}
            disabled={loading}
            className='w-full flex items-center justify-center gap-2 bg-blue-600 text-white text-sm px-4 py-2 rounded-xl hover:bg-blue-700 transition disabled:opacity-60'
          >
            {loading ? t('buttons.linking') : t('buttons.confirm')}
          </button>

          {success && (
            <p className='mt-3 text-sm text-green-600 font-medium'>{t('success.message')}</p>
          )}
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/app/[locale]/requesterEdit/linkAccounts/vinculoCuenta/vincularDiscord.tsx">
'use client';

import { useState } from 'react';
import { FaDiscord } from 'react-icons/fa';
import { Loader2 } from 'lucide-react';
import { vincularDiscord, Client } from '@/app/redux/services/services/api';
import { useTranslations } from 'next-intl';

interface VincularDiscordProps {
  onLinked?: (client?: Client) => void;
}

export default function VincularDiscord({ onLinked }: VincularDiscordProps) {
  const t = useTranslations('VincularDiscord');
  const [loading, setLoading] = useState(false);

  const handleVincularDiscord = () => {
    const token = localStorage.getItem('servineo_token');
    if (!token) {
      return;
    }

    setLoading(true);

    vincularDiscord(
      token,

      (client) => {
        onLinked?.(client);
        setLoading(false);
      },
    );
  };

  return (
    <div className='w-full flex items-center justify-between bg-white border border-gray-200 rounded-2xl px-4 py-3 shadow-sm hover:bg-gray-50 transition'>
      <div className='flex items-center gap-3'>
        <FaDiscord size={30} className='text-[#5865F2]' />
        <div className='flex flex-col'>
          <span className='text-sm font-semibold text-gray-800'>{t('title')}</span>
          <span className='text-xs text-gray-500'>{t('subtitle')}</span>
        </div>
      </div>

      <button
        onClick={handleVincularDiscord}
        disabled={loading}
        className='flex items-center justify-center gap-2 bg-blue-600 text-white text-sm px-4 py-2 rounded-xl hover:bg-blue-700 transition disabled:opacity-60'
      >
        {loading ? (
          <>
            <Loader2 className='w-4 h-4 animate-spin' /> {t('buttons.linking')}
          </>
        ) : (
          t('buttons.link')
        )}
      </button>
    </div>
  );
}
</file>

<file path="src/app/[locale]/requesterEdit/linkAccounts/vinculoCuenta/vincularGithub.tsx">
'use client';

import { useState } from 'react';
import { FaGithub } from 'react-icons/fa';
import { toast } from 'sonner';
import { Loader2 } from 'lucide-react';
import { vincularGitHub, Client } from '@/app/redux/services/services/api';
import { useTranslations } from 'next-intl';

interface VincularGithubProps {
  onLinked?: (client?: Client) => void;
}

export default function VincularGithub({ onLinked }: VincularGithubProps) {
  const t = useTranslations('VincularGithub');
  const [loading, setLoading] = useState(false);

  const handleVincularGitHub = () => {
    const token = localStorage.getItem('servineo_token');
    if (!token) {
      toast.error(t('errors.noSession'));
      return;
    }

    setLoading(true);

    vincularGitHub(
      token,
      (client) => {
        toast.success(t('success.message'));
        setLoading(false);
        onLinked?.(client);
      },
      (msg) => {
        toast.error(msg);
        setLoading(false);
      },
    );
  };

  return (
    <div className='w-full flex items-center justify-between bg-white border border-gray-200 rounded-2xl px-4 py-3 shadow-sm hover:bg-gray-50 transition'>
      <div className='flex items-center gap-3'>
        <FaGithub size={30} className='text-gray-800' />
        <div className='flex flex-col'>
          <span className='text-sm font-semibold text-gray-800'>{t('title')}</span>
          <span className='text-xs text-gray-500'>{t('subtitle')}</span>
        </div>
      </div>
      <div>
        <button
          onClick={handleVincularGitHub}
          disabled={loading}
          className='flex items-center justify-center gap-2 bg-blue-600 text-white text-sm px-4 py-2 rounded-xl hover:bg-blue-700 transition disabled:opacity-60'
        >
          {loading ? (
            <>
              <Loader2 className='w-4 h-4 animate-spin' /> {t('buttons.linking')}
            </>
          ) : (
            t('buttons.link')
          )}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/requesterEdit/linkAccounts/vinculoCuenta/vincularGoogle.tsx">
'use client';

import { useState } from 'react';
import { FcGoogle } from 'react-icons/fc';
import { CredentialResponse, GoogleLogin } from '@react-oauth/google';
import { toast } from 'sonner';
import { Loader2 } from 'lucide-react';
import { vincularGoogle, Client } from '@/app/redux/services/services/api';
import { useTranslations } from 'next-intl';

interface VincularGoogleProps {
  onLinked?: (client?: Client) => void;
  tokenUsuario?: string;
}

export default function VincularGoogle({ onLinked, tokenUsuario }: VincularGoogleProps) {
  const t = useTranslations('VincularGoogle');
  const [loading, setLoading] = useState(false);

  const handleLoginSuccess = async (credentialResponse: CredentialResponse) => {
    const tokenGoogle = credentialResponse?.credential;
    if (!tokenGoogle) return console.error(t('errors.emptyToken'));

    if (!tokenUsuario) {
      toast.error(t('errors.noSession'));
      return;
    }

    setLoading(true);

    const result = await vincularGoogle(tokenUsuario, tokenGoogle);

    if (result.success) {
      toast.success(result.message);
      onLinked?.(result.client);
    } else {
      toast.error(result.message);
    }

    setLoading(false);
  };

  return (
    <div className='w-full flex items-center justify-between bg-white border border-gray-200 rounded-2xl px-4 py-3 shadow-sm hover:bg-gray-50 transition'>
      <div className='flex items-center gap-3'>
        <FcGoogle size={30} />
        <div className='flex flex-col'>
          <span className='text-sm font-semibold text-gray-800'>{t('title')}</span>
          <span className='text-xs text-gray-500'>{t('subtitle')}</span>
        </div>
      </div>

      <div className='relative'>
        <button
          disabled={loading}
          className='flex items-center justify-center gap-2 bg-blue-600 text-white text-sm px-4 py-2 rounded-xl hover:bg-blue-700 transition disabled:opacity-60'
        >
          {loading ? (
            <>
              <Loader2 className='w-4 h-4 animate-spin' /> {t('buttons.linking')}
            </>
          ) : (
            t('buttons.link')
          )}
        </button>

        <div className='absolute inset-0 opacity-0 cursor-pointer'>
          <GoogleLogin
            onSuccess={handleLoginSuccess}
            onError={() => toast.error(t('errors.loginError'))}
          />
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/requesterEdit/perfil/page.tsx">
'use client';

import React, { useEffect, useState, useRef } from 'react';
import UserProfileSummary from '@/Components/requester/profile/UserProfileSummary';
import { Bell, BellOff, ShieldCheck, User2, Info } from 'lucide-react';
import { useRouter } from '@/i18n/navigation';
import { useSelector, useDispatch } from 'react-redux';
import { setUser } from '@/app/redux/slice/userSlice';
import { IUser } from '@/types/user';

interface RootState {
  user: {
    user: IUser | null;
    isAuthenticated: boolean;
    loading: boolean;
  };
}

export default function MiPerfilPage() {
  const router = useRouter();
  const dispatch = useDispatch();
  const { user: reduxUser } = useSelector((state: RootState) => state.user);
  const [refresh, setRefresh] = useState(0);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  const [userData, setUserData] = useState<IUser | null>(null);
  const userDataFromStorageRef = useRef(false);

  /* ======================================================
               ✏️ EDICIÓN INLINE DEL PERFIL
  ====================================================== */
  const [editName, setEditName] = useState('');
  const [editLastName, setEditLastName] = useState('');
  const [editEmail, setEditEmail] = useState('');
  const [editPhotoFile, setEditPhotoFile] = useState<File | null>(null);
  const [savingInline, setSavingInline] = useState(false);
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);

  function safeParse(json: string | null) {
    if (!json) return null;
    try {
      const parsed = JSON.parse(json);
      return typeof parsed === 'object' ? parsed : null;
    } catch {
      return null;
    }
  }
  const loadUserFromStorage = () => {
    const raw = localStorage.getItem('servineo_user');
    const parsed = safeParse(raw);
    if (parsed) {
      const user = parsed as IUser;
      setUserData(user);
      // Sync with Redux
      if (!reduxUser || reduxUser._id !== user._id || reduxUser.id !== user.id) {
        dispatch(setUser(user));
      }
      userDataFromStorageRef.current = true;
      return user;
    }
    userDataFromStorageRef.current = false;
    return null;
  };

  const updateEditableFields = (data: IUser & { firstName?: string; lastName?: string }) => {
    if (!data || hasUnsavedChanges) return;
    if (data.firstName !== undefined || data.lastName !== undefined) {
      setEditName(data.firstName ?? '');
      setEditLastName(data.lastName ?? '');
      setEditEmail(data.email ?? '');
      return;
    }
    if (editName || editLastName) return;

    const full = (data.name || '').trim().replace(/\s+/g, ' ');
    const parts = full.split(' ').filter((p) => p.length > 0);

    if (parts.length === 0) {
      setEditName('');
      setEditLastName('');
    } else if (parts.length === 1) {
      setEditName(parts[0]);
      setEditLastName('');
    } else if (parts.length === 2) {
      setEditName(parts[0]);
      setEditLastName(parts[1]);
    } else if (parts.length === 3) {
      setEditName(parts[0] + ' ' + parts[1]);
      setEditLastName(parts[2]);
    } else if (parts.length === 4) {
      setEditName(parts[0] + ' ' + parts[1]);
      setEditLastName(parts[2] + ' ' + parts[3]);
    } else {
      const apellidos = parts.slice(-2).join(' ');
      const nombres = parts.slice(0, -2).join(' ');
      setEditName(nombres);
      setEditLastName(apellidos);
    }

    setEditEmail(data.email ?? '');
  };

  useEffect(() => {
    const loaded = loadUserFromStorage();

    if (loaded) {
      updateEditableFields(loaded);
    }
  }, []);

  useEffect(() => {
    const handler = () => {
      const loaded = loadUserFromStorage();
      if (loaded) {
        updateEditableFields(loaded);
      }
      setRefresh(Date.now());
    };

    window.addEventListener('servineo_user_updated', handler);
    window.addEventListener('storage', handler);

    const handleFocus = () => {
      const loaded = loadUserFromStorage();
      if (loaded) {
        updateEditableFields(loaded);
      }
    };
    window.addEventListener('focus', handleFocus);

    const handleVisibilityChange = () => {
      if (!document.hidden) {
        const loaded = loadUserFromStorage();
        if (loaded) {
          updateEditableFields(loaded);
        }
      }
    };
    document.addEventListener('visibilitychange', handleVisibilityChange);

    return () => {
      window.removeEventListener('servineo_user_updated', handler);
      window.removeEventListener('storage', handler);
      window.removeEventListener('focus', handleFocus);
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, [hasUnsavedChanges]);

  useEffect(() => {
    const raw = localStorage.getItem('servineo_user');
    const parsed = safeParse(raw);

    if (parsed) {
      const user = parsed as IUser;
      setUserData(user);
      userDataFromStorageRef.current = true;

      // Sync with Redux if different
      if (!reduxUser || reduxUser._id !== user._id || reduxUser.id !== user.id) {
        dispatch(setUser(user));
      }
    } else if (reduxUser) {
      // Use Redux user as fallback
      setUserData(reduxUser);
      userDataFromStorageRef.current = false;
    }
  }, [reduxUser, dispatch]);

  /* ======================================================
                     🔔 NOTIFICACIONES
  ====================================================== */
  const [notifications, setNotifications] = useState(true);

  useEffect(() => {
    const saved = localStorage.getItem('servineo_notifications');
    if (saved === 'true' || saved === 'false') {
      setNotifications(saved === 'true');
    }
  }, []);

  function toggleNotifications() {
    setNotifications((prev) => {
      const next = !prev;
      localStorage.setItem('servineo_notifications', next.toString());
      return next;
    });
  }

  /* ======================================================
               ✏️ EDICIÓN INLINE DEL PERFIL
  ====================================================== */
  useEffect(() => {
    if (hasUnsavedChanges) return;
    if (editName || editLastName) return;

    const raw = localStorage.getItem('servineo_user');
    const parsed = safeParse(raw);

    if (parsed) {
      const parsedName = parsed.name || '';
      const currentFullName = `${editName.trim()} ${editLastName.trim()}`.trim();

      if (parsedName !== currentFullName || (parsed.email || '') !== editEmail) {
        updateEditableFields(parsed as IUser);
      }
    } else if (userData && !userDataFromStorageRef.current) {
      const userDataName = userData.name || '';
      const currentFullName = `${editName.trim()} ${editLastName.trim()}`.trim();

      if (userDataName !== currentFullName || (userData.email || '') !== editEmail) {
        updateEditableFields(userData);
      }
    }
  }, [userData, hasUnsavedChanges, editName, editLastName, editEmail]);

  const handlePhotoUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) setEditPhotoFile(file);
  };

  async function saveProfileInline() {
    try {
      const token = localStorage.getItem('servineo_token');
      if (!token) {
        alert('No autenticado. Por favor, inicia sesión nuevamente.');
        router.push('/login');
        return;
      }

      // Validate we have user data
      if (!userData && !reduxUser) {
        alert('No se encontraron datos del usuario. Por favor, recarga la página.');
        return;
      }

      setSavingInline(true);

      let base64Photo: string | null = null;
      if (editPhotoFile) {
        base64Photo = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result as string);
          reader.readAsDataURL(editPhotoFile);
        });
      }

      const fullName = `${editName.trim()} ${editLastName.trim()}`.replace(/\s+/g, ' ').trim();

      function isValidEmail(email: string) {
        if (!email) return false;
        const regex = /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;
        return regex.test(email);
      }

      if (!isValidEmail(editEmail.trim())) {
        alert('⚠️ Correo inválido. Debe tener un formato válido (ejemplo: usuario@dominio.com)');
        setSavingInline(false);
        return;
      }

      // Only send photo if it's a new file or if we have a base64 string
      const photoToSend = editPhotoFile
        ? base64Photo
        : (userData?.photo ?? userData?.picture ?? userData?.url_photo ?? null);

      // Build payload - ensure all required fields are present
      const payload: {
        name: string;
        email: string;
        photo?: string | null;
      } = {
        name: fullName,
        email: editEmail.trim(),
      };

      // Only include photo if we have one to send and it's not empty
      if (
        photoToSend &&
        photoToSend.trim() !== '' &&
        photoToSend !== 'null' &&
        photoToSend !== 'undefined'
      ) {
        payload.photo = photoToSend;
      }

      console.log('📤 Enviando actualización de perfil:', {
        name: payload.name,
        email: payload.email,
        hasPhoto: !!payload.photo,
        photoLength: payload.photo?.length || 0,
      });

      const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/controlC/usuario/update`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(payload),
        credentials: 'include',
      });

      if (!res.ok) {
        let errorData;
        try {
          const text = await res.text();
          errorData = text ? JSON.parse(text) : { message: 'Error al actualizar' };
        } catch {
          errorData = { message: `Error ${res.status}: No se pudo actualizar el perfil` };
        }
        console.error('Error al actualizar perfil:', errorData);
        throw new Error(
          errorData.message ||
            errorData.error ||
            `Error ${res.status}: No se pudo actualizar el perfil`,
        );
      }

      const data = await res.json();

      const currentUser: IUser | null = userData || reduxUser;
      const newUser: IUser = {
        ...(currentUser || {}),
        ...(data.user || {}),
        _id: data.user?._id ?? currentUser?._id,
        id: data.user?.id ?? currentUser?.id,
        name: payload.name,
        email: payload.email,
        role: data.user?.role ?? currentUser?.role ?? 'requester',
        photo: payload.photo ?? data.user?.photo ?? currentUser?.photo ?? null,
        picture: payload.photo ?? data.user?.picture ?? currentUser?.picture ?? null,
        url_photo: payload.photo ?? data.user?.url_photo ?? currentUser?.url_photo ?? null,
      };
      // Save to localStorage
      localStorage.setItem('servineo_user', JSON.stringify(newUser));

      // Update Redux
      dispatch(setUser(newUser));

      // Update local state
      setUserData(newUser);
      setHasUnsavedChanges(false);
      setEditPhotoFile(null);

      // Notify other components
      window.dispatchEvent(new Event('servineo_user_updated'));

      if (typeof window !== 'undefined' && window.dispatchEvent) {
        window.dispatchEvent(
          new StorageEvent('storage', {
            key: 'servineo_user',
            newValue: JSON.stringify(newUser),
            storageArea: localStorage,
          }),
        );
      }

      alert('Los cambios se han guardado correctamente');
    } catch (error) {
      const errorMessage =
        error instanceof Error ? error.message : 'No se pudo actualizar el perfil.';
      console.error('Error al guardar perfil:', error);
      alert(errorMessage);
    } finally {
      setSavingInline(false);
    }
  }

  /* ======================================================
         ⚠️ DETECTAR CAMBIOS SIN GUARDAR
  ====================================================== */
  useEffect(() => {
    if (!userData) return;
    const fullName = `${editName.trim()} ${editLastName.trim()}`.replace(/\s+/g, ' ').trim();

    const initialName = userData.name ?? '';
    const initialEmail = userData.email ?? '';
    const nameChanged = fullName !== initialName;
    const emailChanged = editEmail.trim() !== initialEmail;
    const photoChanged = !!editPhotoFile;

    setHasUnsavedChanges(nameChanged || emailChanged || photoChanged);
  }, [editName, editLastName, editEmail, editPhotoFile, userData]);

  useEffect(() => {
    const handleBeforeUnload = (e: BeforeUnloadEvent) => {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
      }
    };

    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [hasUnsavedChanges]);

  /* ======================================================
                  🗑️ ELIMINAR CUENTA
  ====================================================== */
  async function handleDeleteAccount() {
    try {
      const token = localStorage.getItem('servineo_token');
      if (!token) return alert('Usuario no autenticado');

      const res = await fetch(
        `${process.env.NEXT_PUBLIC_API_URL}/api/controlC/usuario/delete-account`,
        {
          method: 'DELETE',
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
          credentials: 'include',
        },
      );

      const data = await res.json();
      if (!data.success) {
        alert(data.message || 'No se pudo eliminar la cuenta');
        return;
      }

      // Clear storage
      localStorage.removeItem('servineo_token');
      localStorage.removeItem('servineo_user');

      // Clear Redux
      dispatch(setUser(null));

      alert('Tu cuenta ha sido eliminada');
      window.location.href = '/login';
    } catch (error) {
      console.error('Error eliminando cuenta:', error);
      alert('Error eliminando la cuenta');
    }
  }

  /* ======================================================
                           UI
  ====================================================== */
  return (
    <main className='min-h-screen bg-gradient-to-br from-[#F5F8FF] to-[#E9EEFA] py-10 px-4 font-roboto'>
      <div className='max-w-6xl mx-auto'>
        <h1 className='text-4xl font-bold mb-10 text-[#16203A] tracking-tight'>Mi perfil</h1>

        <div className='grid grid-cols-1 lg:grid-cols-3 gap-10'>
          {/* ===================== LADO IZQUIERDO ===================== */}
          <div className='lg:col-span-1'>
            <UserProfileSummary key={refresh} />
          </div>

          {/* ===================== LADO DERECHO ===================== */}
          <div className='lg:col-span-2'>
            <div className='backdrop-blur-md bg-white/60 p-8 rounded-3xl shadow-xl border border-white/40'>
              {/* =================== 🧾 EDITAR PERFIL =================== */}
              <div className='bg-white rounded-2xl p-7 shadow-md border border-gray-100 mb-10'>
                <div className='flex items-center gap-3 mb-4'>
                  <User2 className='text-primary min-w-[24px] min-h-[24px]' size={24} />
                  <h3 className='text-2xl font-semibold text-[#16203A]'>Editar perfil</h3>
                </div>

                <p className='text-sm text-gray-500 mb-8'>
                  Actualiza tu foto, nombre y correo de manera sencilla.
                </p>

                {/* FOTO */}
                <div className='flex items-center gap-6 mb-8'>
                  <div className='relative group'>
                    <img
                      src={
                        editPhotoFile
                          ? URL.createObjectURL(editPhotoFile)
                          : userData?.photo?.trim() ||
                            userData?.picture?.trim() ||
                            userData?.url_photo?.trim() ||
                            '/icons/marcador-de-posicion.png'
                      }
                      className='w-28 h-28 rounded-full object-cover shadow-lg border-2 border-white'
                    />

                    <div className='absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300 cursor-pointer'>
                      <span className='text-white text-xs font-medium tracking-wide'>
                        Cambiar foto
                      </span>
                    </div>

                    <input
                      type='file'
                      accept='image/*'
                      className='absolute inset-0 opacity-0 cursor-pointer'
                      onChange={handlePhotoUpload}
                    />
                  </div>

                  <div>
                    <p className='font-medium text-gray-700'>Foto de perfil</p>
                    <p className='text-xs text-gray-400'>Formatos PNG o JPG, máx 5 MB</p>
                  </div>
                </div>

                {/* FORMULARIO */}
                <div className='grid grid-cols-1 md:grid-cols-2 gap-5'>
                  <div>
                    <label className='text-sm font-semibold text-[#16203A]'>Nombre</label>
                    <input
                      className='mt-1 p-3 border rounded-xl w-full bg-gray-50 focus:ring-2 focus:ring-primary focus:border-primary transition'
                      value={editName}
                      onChange={(e) => setEditName(e.target.value)}
                    />
                  </div>

                  <div>
                    <label className='text-sm font-semibold text-[#16203A]'>Apellido</label>
                    <input
                      className='mt-1 p-3 border rounded-xl w-full bg-gray-50 focus:ring-2 focus:ring-primary transition'
                      value={editLastName}
                      onChange={(e) => setEditLastName(e.target.value)}
                    />
                  </div>
                </div>

                <div className='mt-5'>
                  <label className='text-sm font-semibold text-[#16203A]'>Correo electrónico</label>
                  <input
                    className='mt-1 p-3 border rounded-xl w-full bg-gray-100 text-gray-600 focus:ring-2 focus:ring-primary transition'
                    value={editEmail}
                    onChange={(e) => setEditEmail(e.target.value)}
                  />
                </div>

                {/* BOTÓN GUARDAR */}
                <button
                  onClick={saveProfileInline}
                  disabled={savingInline}
                  className='mt-7 w-full py-3 bg-primary hover:bg-primary/90 text-white font-medium rounded-xl shadow-lg transition tracking-wide'
                >
                  {savingInline ? 'Guardando…' : 'Guardar cambios'}
                </button>
              </div>

              {/* =================== 🔔 NOTIFICACIONES =================== */}
              <div className='p-7 bg-white rounded-2xl border shadow-md mb-10'>
                <div className='flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4'>
                  <div className='flex items-center gap-4'>
                    <Bell className='text-primary' size={22} />
                    <div>
                      <h3 className='text-lg font-semibold'>Notificaciones</h3>
                      <p className='text-sm text-gray-500'>
                        Activa o desactiva alertas importantes.
                      </p>
                    </div>
                  </div>

                  <button
                    onClick={toggleNotifications}
                    className={`self-start sm:self-auto flex items-center gap-2 px-5 py-2.5 rounded-full shadow text-sm font-medium transition ${
                      notifications ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'
                    }`}
                  >
                    {notifications ? <Bell size={18} /> : <BellOff size={18} />}
                    {notifications ? 'Activadas' : 'Desactivadas'}
                  </button>
                </div>
              </div>

              {/* ===================== 🛡️ SEGURIDAD ===================== */}
              <div className='p-7 bg-white rounded-2xl border shadow mb-10'>
                <div className='flex items-center gap-3 mb-2'>
                  <ShieldCheck className='text-primary min-w-[22px] min-h-[22px]' size={22} />
                  <h3 className='font-semibold text-lg'>Seguridad de la cuenta</h3>
                </div>
                <p className='text-sm text-gray-600'>Tu cuenta está protegida correctamente.</p>
              </div>

              {/* =================== ℹ️ INFORMACIÓN EXTRA =================== */}
              <div className='p-5 bg-white rounded-2xl border shadow mb-10 flex gap-4'>
                <Info className='text-primary min-w-[22px] min-h-[22px]' size={22} />
                <div>
                  <h3 className='font-semibold text-lg'>Configuraciones avanzadas</h3>
                  <p className='text-sm text-gray-600'>
                    Para cambiar <b>teléfono, dirección o contraseña</b>, entra en{' '}
                    <b>Configuración</b>.
                  </p>
                </div>
              </div>

              {/* ===================== 🎛️ BOTONES FINALES ===================== */}
              <div className='flex flex-col sm:flex-row gap-4 sm:gap-3'>
                <button
                  onClick={() => {
                    if (
                      hasUnsavedChanges &&
                      !confirm('Tienes cambios sin guardar. ¿Seguro que quieres salir?')
                    )
                      return;
                    router.push('/requesterEdit?section=perfil');
                  }}
                  className='px-6 py-2.5 bg-white border text-primary rounded-full shadow hover:bg-gray-50 transition'
                >
                  Configuración
                </button>

                <button
                  onClick={() => {
                    if (
                      hasUnsavedChanges &&
                      !confirm('Tienes cambios sin guardar. ¿Seguro que quieres salir?')
                    )
                      return;
                    router.push('/');
                  }}
                  className='px-6 py-2.5 bg-primary text-white rounded-full shadow hover:bg-primary/90 transition'
                >
                  Volver al inicio
                </button>

                <button
                  onClick={() => {
                    if (
                      hasUnsavedChanges &&
                      !confirm('Tienes cambios sin guardar. ¿Deseas continuar?')
                    )
                      return;
                    setShowDeleteConfirm(true);
                  }}
                  className='px-6 py-2.5 bg-primary text-white rounded-full shadow hover:bg-primary/90 transition font-medium'
                >
                  Eliminar cuenta
                </button>

                {/* ===================== ❌ MODAL ELIMINAR ===================== */}
                {showDeleteConfirm && (
                  <div className='fixed inset-0 bg-black/50 flex items-center justify-center z-[1000]'>
                    <div className='bg-white/90 backdrop-blur-md p-6 rounded-3xl shadow-xl border border-white/40 w-80 text-center'>
                      <h3 className='text-lg font-semibold text-[#16203A] mb-3'>
                        ¿Está seguro de eliminar su cuenta?
                      </h3>

                      <p className='text-gray-600 mb-6 text-sm'>
                        Esta acción eliminará su cuenta de manera permanente.
                      </p>

                      <div className='flex justify-between gap-3'>
                        <button
                          onClick={() => setShowDeleteConfirm(false)}
                          className='flex-1 py-2.5 rounded-full bg-white border text-primary shadow hover:bg-gray-50 transition font-medium'
                        >
                          Cancelar
                        </button>

                        <button
                          onClick={handleDeleteAccount}
                          className='flex-1 py-2.5 rounded-full bg-primary text-white shadow hover:bg-primary/90 transition font-medium'
                        >
                          Eliminar
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  );
}
</file>

<file path="src/app/[locale]/requesterEdit/Seguridad/Authenticator/page.tsx">
'use client';

import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';

// Componentes modales
import AuthenticatorQrModal from '../../../../../Components/requester/Authenticator/AuthenticatorQrModal';
import VerifyTokenModal from '../../../../../Components/requester/Authenticator/VerifyTokenModal';
import RecoveryModal from '../../../../../Components/requester/Authenticator/RecoveryModal';
import ConfirmDisableModal from '../../../../../Components/requester/Authenticator/ConfirmDisableModal';

// Servicio 2FA
import { generateQr, verifyToken, disable2fa } from '../../../../redux/services/twofactor';

export default function AuthenticatorPage() {
  const router = useRouter();

  // Modales
  const [qrOpen, setQrOpen] = useState(false);
  const [verifyOpen, setVerifyOpen] = useState(false);
  const [recoveryOpen, setRecoveryOpen] = useState(false);
  const [disableModalOpen, setDisableModalOpen] = useState(false);

  // Datos y estados
  const [qrDataUrl, setQrDataUrl] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);
  const [regenLoading, setRegenLoading] = useState(false);
  const [disableLoading, setDisableLoading] = useState(false);
  const [recoveryCodes, setRecoveryCodes] = useState<string[] | null>(null);

  // Estado local que marca si el usuario ya configuró 2FA
  const [configured, setConfigured] = useState<boolean>(false);
  const [configuredAt, setConfiguredAt] = useState<string | null>(null);

  useEffect(() => {
    const flag = localStorage.getItem('servineo_twofactor_configured');
    const dateStr = localStorage.getItem('servineo_twofactor_configured_at');
    if (flag === 'true') {
      setConfigured(true);
      if (dateStr) setConfiguredAt(dateStr);
    }
  }, []);

  // Paso 1: Generar QR
  const handleConfigure = async () => {
    setLoading(true);
    setQrDataUrl(null);
    setQrOpen(true);
    try {
      const data = await generateQr();
      setQrDataUrl(data.qrDataUrl ?? null);
    } catch (err) {
      console.error('Error al generar QR', err);
      const errorMessage = err instanceof Error ? err.message : 'Error generando QR. Reintenta.';
      alert(errorMessage);
      setQrOpen(false);
    } finally {
      setLoading(false);
    }
  };

  // Regenerar QR
  const handleRegenerateQr = async () => {
    setRegenLoading(true);
    try {
      const data = await generateQr();
      setQrDataUrl(data.qrDataUrl ?? null);
    } catch (err) {
      console.error('Error al regenerar QR', err);
      const errorMessage =
        err instanceof Error ? err.message : 'No se pudo regenerar el código. Intenta de nuevo.';
      alert(errorMessage);
    } finally {
      setRegenLoading(false);
    }
  };

  const handleNextFromQr = () => {
    setQrOpen(false);
    setVerifyOpen(true);
  };

  // Paso 2: Verificar código de 6 dígitos
  const handleVerify = async (token: string) => {
    setLoading(true);
    try {
      const res = await verifyToken(token);
      setRecoveryCodes(res.recoveryCodes || []);
      setVerifyOpen(false);
      setRecoveryOpen(true);

      setConfigured(true);
      const now = new Date().toISOString().slice(0, 10);
      setConfiguredAt(now);
      localStorage.setItem('servineo_twofactor_configured', 'true');
      localStorage.setItem('servineo_twofactor_configured_at', now);
    } finally {
      setLoading(false);
    }
  };

  // Confirmar códigos de recuperación
  const handleRecoveryConfirm = () => {
    setRecoveryOpen(false);
    setRecoveryCodes(null);
  };

  // Desactivar 2FA
  const handleDisableConfirm = async () => {
    setDisableLoading(true);
    try {
      await disable2fa();
      localStorage.removeItem('servineo_twofactor_configured');
      localStorage.removeItem('servineo_twofactor_configured_at');
      setConfigured(false);
      setConfiguredAt(null);
      setRecoveryCodes(null);
    } catch (err) {
      console.error('Error desactivando 2FA', err);
      const errorMessage = err instanceof Error ? err.message : 'Error al desactivar 2FA';
      alert(errorMessage);
    } finally {
      setDisableLoading(false);
    }
  };

  return (
    <div className='min-h-[70vh]'>
      <div className='max-w-6xl mx-auto px-6'>
        {/* Back + Title */}
        <div className='flex items-center gap-4 py-6'>
          <button
            onClick={() => router.back()}
            aria-label='Volver'
            className='p-2 rounded-full hover:bg-gray-100'
          >
            <svg
              className='w-6 h-6 text-gray-700'
              fill='none'
              viewBox='0 0 24 24'
              stroke='currentColor'
            >
              <path
                strokeWidth={2}
                strokeLinecap='round'
                strokeLinejoin='round'
                d='M15 19l-7-7 7-7'
              />
            </svg>
          </button>

          <div>
            <h1 className='text-xl font-semibold'>Aplicación authenticator</h1>
            <p className='text-sm text-gray-600'>
              En vez de esperar a que lleguen mensajes de texto, puedes obtener códigos de
              verificación desde una aplicación de autenticación.
            </p>
          </div>
        </div>

        {/* Body */}
        <div className='mt-6 bg-white p-8 rounded border border-gray-100 shadow-sm'>
          <div className='text-center max-w-3xl mx-auto'>
            {/* Texto de descarga (solo si no está configurado) */}
            {!configured && (
              <p className='text-sm text-gray-700 mb-6'>
                Primero, descarga Google Authenticator desde{' '}
                <a
                  href='https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2'
                  target='_blank'
                  rel='noopener noreferrer'
                  onClick={(e) => e.stopPropagation()}
                  className='text-blue-600 underline hover:text-blue-800'
                >
                  Google Play Store
                </a>{' '}
                o desde{' '}
                <a
                  href='https://apps.apple.com/es/app/google-authenticator/id388497605'
                  target='_blank'
                  rel='noopener noreferrer'
                  onClick={(e) => e.stopPropagation()}
                  className='text-blue-600 underline hover:text-blue-800'
                >
                  App Store
                </a>
                .
              </p>
            )}

            {/* Card de estado activo o botón configurar */}
            {configured ? (
              <div className='max-w-2xl w-full mx-auto p-4 md:p-5 rounded-2xl border border-emerald-100 bg-emerald-50/60 flex items-center justify-between gap-4 shadow-sm transition-all duration-200 hover:shadow-md hover:-translate-y-0.5 hover:scale-[1.01]'>
                <div className='flex items-center gap-4'>
                  {/* Icono QR */}
                  <div className='w-14 h-14 flex items-center justify-center rounded-2xl bg-white border border-gray-200 shadow-sm'>
                    <div className='w-9 h-9 rounded-xl bg-gradient-to-br from-gray-100 via-gray-200 to-gray-300 flex items-center justify-center border border-gray-300'>
                      <svg
                        className='w-6 h-6 text-gray-700'
                        viewBox='0 0 24 24'
                        fill='none'
                        stroke='currentColor'
                      >
                        <rect x='3' y='3' width='7' height='7' strokeWidth='1.5' />
                        <rect x='14' y='3' width='7' height='7' strokeWidth='1.5' />
                        <rect x='3' y='14' width='7' height='7' strokeWidth='1.5' />
                        <path
                          strokeWidth='1.5'
                          strokeLinecap='round'
                          d='M14 14h3v3M17 17h4M17 14h4M14 17h3'
                        />
                      </svg>
                    </div>
                  </div>

                  {/* Texto */}
                  <div className='flex-1 text-left space-y-1'>
                    <div className='flex items-center gap-2 flex-wrap'>
                      <span className='font-semibold text-gray-900'>
                        Autenticación en dos pasos
                      </span>
                      <span className='inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-emerald-100 text-emerald-700 border border-emerald-200'>
                        Activa
                      </span>
                    </div>
                    <p className='text-xs text-gray-600'>
                      Aplicación: <span className='font-medium'>Google Authenticator</span>
                    </p>
                    <p className='text-[11px] text-gray-500 font-semibold'>
                      Agregada el: <span className='font-semibold'>{configuredAt ?? '-'}</span>
                    </p>
                  </div>
                </div>

                {/* Botón papelera */}
                <button
                  title='Desactivar autenticación en dos pasos'
                  onClick={() => setDisableModalOpen(true)}
                  className='inline-flex items-center justify-center w-10 h-10 rounded-full border border-red-200 bg-white text-red-600 shadow-sm transition-all duration-200 hover:bg-red-50 hover:border-red-300 hover:shadow-md hover:-translate-y-0.5 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-200 cursor-pointer'
                >
                  <svg className='w-4 h-4' viewBox='0 0 24 24' fill='none' stroke='currentColor'>
                    <path
                      strokeWidth='1.7'
                      strokeLinecap='round'
                      strokeLinejoin='round'
                      d='M4 6h16M10 11v6M14 11v6M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2'
                    />
                  </svg>
                </button>
              </div>
            ) : (
              <div className='flex justify-center'>
                <button
                  onClick={handleConfigure}
                  className='inline-flex items-center gap-2 px-5 py-2 rounded-md border border-indigo-200 hover:border-indigo-300 bg-white text-gray-800 shadow-sm hover:shadow-md transition-all'
                  disabled={loading}
                >
                  <span className='w-5 h-5 inline-flex items-center justify-center text-indigo-600'>
                    <svg className='w-4 h-4' viewBox='0 0 24 24' fill='none' stroke='currentColor'>
                      <path
                        strokeWidth='1.5'
                        strokeLinecap='round'
                        strokeLinejoin='round'
                        d='M12 8v4l2 2'
                      />
                      <circle cx='12' cy='12' r='10' strokeWidth='1.5' />
                    </svg>
                  </span>
                  <span className='text-sm font-medium'>Configurar autenticador</span>
                </button>
              </div>
            )}

            {/* Recovery codes (si acaban de generarse) */}
            {recoveryCodes && recoveryCodes.length > 0 && !recoveryOpen && (
              <div className='mt-6 max-w-3xl mx-auto transition-opacity duration-300'>
                <div className='p-4 border rounded bg-yellow-50'>
                  <h3 className='font-semibold mb-2'>Códigos de recuperación (guárdalos ahora)</h3>
                  <p className='text-sm text-gray-600 mb-2'>
                    Se muestran una sola vez. Úsalos si pierdes acceso a tu app de autenticación.
                  </p>
                  <ul className='list-disc ml-6'>
                    {recoveryCodes.map((c) => (
                      <li key={c} className='font-mono'>
                        {c}
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Modales */}
        <AuthenticatorQrModal
          open={qrOpen}
          onClose={() => setQrOpen(false)}
          qrDataUrl={qrDataUrl}
          onNext={handleNextFromQr}
          loading={loading}
          onRegenerate={handleRegenerateQr}
          regenerating={regenLoading}
        />

        <VerifyTokenModal
          open={verifyOpen}
          onClose={() => setVerifyOpen(false)}
          onVerify={handleVerify}
          loading={loading}
        />

        <RecoveryModal
          open={recoveryOpen}
          codes={recoveryCodes}
          onClose={() => setRecoveryOpen(false)}
          onConfirm={handleRecoveryConfirm}
        />

        <ConfirmDisableModal
          open={disableModalOpen}
          onCancel={() => setDisableModalOpen(false)}
          onConfirm={handleDisableConfirm}
          onFinish={() => setRecoveryCodes(null)}
          loading={disableLoading}
        />
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/requesterEdit/Seguridad/page.tsx">
'use client';

import { useRouter } from 'next/navigation';
import Image from 'next/image';

export default function SeguridadPage() {
  const router = useRouter();

  return (
    <div className='max-w-4xl w-full'>
      <h2 className='text-xl font-semibold text-center mb-2'>Seguridad</h2>
      <p className='text-sm text-center text-gray-600 mb-8'>
        Opciones y recomendaciones que te ayudan a proteger tu cuenta
      </p>

      {/* ✅ Usamos grid para 2 columnas */}
      <div className='grid grid-cols-1 sm:grid-cols-2 gap-6 justify-items-center'>
        {/* Card 1: Cambiar contraseña */}
        <button
          onClick={() => router.push('/controlC/HU8')}
          className='flex items-center gap-3 px-6 py-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300 ease-out bg-white text-gray-800 cursor-pointer min-w-[220px]'
        >
          <div className='p-2 rounded-md bg-blue-50'>
            <Image
              src='/icons/edit-pass.png'
              alt='Cambiar contraseña'
              width={32}
              height={32}
              className='w-8 h-8 object-contain'
            />
          </div>
          <span className='font-medium'>Cambiar contraseña</span>
        </button>

        {/* Card 2: Dispositivos vinculados */}
        <button
          onClick={() => router.push('/controlC/Configuracion/Seguridad/Inicios')}
          className='flex items-center gap-3 px-6 py-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300 ease-out bg-white text-gray-800 cursor-pointer min-w-[220px]'
        >
          <div className='p-2 rounded-md bg-blue-50'>
            <Image
              src='/icons/logins.png'
              alt='Dispositivos vinculados'
              width={24}
              height={24}
              className='w-6 h-6 object-contain'
            />
          </div>
          <span className='font-medium'>Inicios de sesión</span>
        </button>

        {/* 🆕 Card 3: Authenticator */}
        <button
          onClick={() => {
            router.push('/requesterEdit/Seguridad/Authenticator');
          }}
          className='flex items-center gap-3 px-6 py-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300 ease-out bg-white text-gray-800 cursor-pointer min-w-[220px]'
        >
          <div className='p-2 rounded-md bg-blue-50'>
            <Image
              src='/icons/appauth.png'
              alt='Authenticator'
              width={24}
              height={24}
              className='w-6 h-6 object-contain'
            />
          </div>
          <span className='font-medium'>Authenticator</span>
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/requesters/page.tsx">
import Link from 'next/link';

export default function RequestersLanding() {
  return (
    <main className='min-h-screen bg-white flex items-center justify-center'>
      <div className='text-center space-y-8'>
        <h1 className='text-3xl sm:text-4xl font-semibold text-gray-900'>Requesters</h1>
        <div className='flex items-center justify-center gap-4'>
          <Link
            href='/completed-jobs'
            className='px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition'
          >
            View Completed Jobs
          </Link>
          <Link
            href='/profile/68e87a9cdae3b73d8040102f'
            className='px-6 py-3 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition'
          >
            View Profile
          </Link>
          <Link
            href='/job-request'
            className='px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition'
          >
            Job Request
          </Link>
        </div>
        <div>
          <Link
            href='/view-rate-jobs'
            className='px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition inline-block'
          >
            View Rated Jobs
          </Link>
        </div>
      </div>
    </main>
  );
}
</file>

<file path="src/app/[locale]/resultsAdvSearch/page.tsx">
// src/app/[locale]/resultsAdvSearch/page.tsx
'use client';
import React, { Suspense, useState } from 'react';
import { useTranslations } from 'next-intl';
import AppliedFilters from '@/Components/ResultsAdvSearch/AppliedFilters';
import { Paginacion, PaginationInfo, PaginationSelector } from '@/Components/Job-offers';
import { JobOffersView, type ViewMode } from '@/Components/Job-offers/JobOffersView';
import { ViewModeToggle } from '@/Components/Job-offers/ViewModeToggle';
import { JobOfferModal } from '@/Components/Job-offers/Job-offer-modal';
import { useAppDispatch, useAppSelector } from '@/app/redux/hooks';
import { setRegistrosPorPagina, setPaginaActual } from '@/app/redux/slice/jobOfert';
import {
  useSyncUrlParams,
  useInitialUrlParams,
  useAppliedFilters,
  useJobOffers,
} from '@/app/redux/features/jobOffers/jobOffersHooks';
import type { JobOfferData, AdaptedJobOffer } from '@/types/jobOffers';
import { adaptOfferToModalFormat } from '@/types/jobOffers';

function ResultsAdvSearchPageContent() {
  const t = useTranslations('resultsAdvSearch');
  const dispatch = useAppDispatch();
  const { appliedParams } = useAppliedFilters();
  const [viewMode, setViewMode] = useState<ViewMode>('list');
  const [selectedOffer, setSelectedOffer] = useState<AdaptedJobOffer | null>(null);
  const [isModalOpen, setIsModalOpen] = useState(false);

  // Inicializar la página a partir de los query params (viene de AdvSearch)
  useInitialUrlParams();
  const { offers } = useJobOffers();

  // Leer estado compartido de jobOffers
  const { loading, paginaActual, registrosPorPagina, totalRegistros } = useAppSelector(
    (s) => s.jobOfert,
  );

  const handlePageChange = (newPage: number) => {
    dispatch(setPaginaActual(newPage));
  };

  const handleRegistrosChange = (valor: number) => {
    dispatch(setRegistrosPorPagina(valor));
  };

  const handleCardClick = (offer: JobOfferData) => {
    const adaptedOffer = adaptOfferToModalFormat(offer);
    setSelectedOffer(adaptedOffer);
    setIsModalOpen(true);
  };

  // Mantener sincronizada la URL con el estado (página, limit, filtros, etc.)
  useSyncUrlParams();

  return (
    <>
      <main className='pt-20 lg:pt-24 px-4 sm:px-6 md:px-12 lg:px-24 pb-12'>
        <h1 className='text-center text-xl sm:text-2xl md:text-3xl font-bold mb-8 mt-4'>
          {t('pageTitle')}
        </h1>

        <AppliedFilters params={appliedParams ?? {}} />
        <div className='flex w-full max-w-5xl mx-auto mt-4 px-4 mb-2 items-center justify-between'>
          {/* Left side */}
          <div className='flex items-center gap-4'>
            <PaginationSelector
              registrosPorPagina={registrosPorPagina}
              onChange={handleRegistrosChange}
            />
          </div>

          {/* Right side */}
          <div className='flex items-center gap-3'>
            {/* Mobile toggle */}
            <ViewModeToggle
              viewMode={viewMode}
              onChange={setViewMode}
              variant='mobile'
              className='flex lg:hidden'
            />

            {/* Desktop toggle */}
            <ViewModeToggle
              viewMode={viewMode}
              onChange={setViewMode}
              variant='desktop'
              className='hidden lg:flex'
            />
          </div>
        </div>

        <div className='flex justify-center my-4'>
          <PaginationInfo
            paginaActual={paginaActual}
            registrosPorPagina={registrosPorPagina}
            totalRegistros={totalRegistros}
          />
        </div>

        {/* Cards de resultados (reutilizadas) */}
        <div className='w-full max-w-5xl mx-auto'>
          {!loading && offers && offers.length > 0 ? (
            <JobOffersView offers={offers} viewMode={viewMode} onOfferClick={handleCardClick} />
          ) : !loading ? (
            <div className='text-gray-500 text-center'>{t('noResults')}</div>
          ) : (
            <div className='text-blue-500 text-center mb-4 p-3 bg-blue-100 rounded'>
              {t('loading')}
            </div>
          )}
        </div>

        {/* Paginación inferior (reutilizada) */}
        {!loading && offers && offers.length > 0 && (
          <div className='mt-8 mb-24 flex justify-center'>
            <Paginacion
              paginaActual={paginaActual}
              registrosPorPagina={registrosPorPagina}
              totalRegistros={totalRegistros}
              onChange={handlePageChange}
            />
          </div>
        )}
      </main>

      <JobOfferModal
        offer={selectedOffer}
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
      />
    </>
  );
}

export default function ResultsAdvSearchPage() {
  const t = useTranslations('AdvSearch');

  return (
    <Suspense
      fallback={
        <div className='pt-20 lg:pt-24 px-4 flex justify-center items-center min-h-screen'>
          <div className='text-blue-500 text-center p-3 bg-blue-100 rounded'>
            {t('loadingFallback')}
          </div>
        </div>
      }
    >
      <ResultsAdvSearchPageContent />
    </Suspense>
  );
}
</file>

<file path="src/app/[locale]/servicios/[slug]/page.tsx">
import { services } from '../data';
import Link from 'next/link';
import Image from 'next/image';

export default async function ServicioDetalle({ params }: { params: { slug: string } }) {
  const { slug } = params;
  const service = services.find((s) => s.slug === slug);

  if (!service) {
    return (
      <div className='min-h-screen pt-16 px-4'>
        <div className='max-w-3xl mx-auto text-center'>
          <h1 className='text-3xl font-bold mb-4'>Servicio no encontrado</h1>
          <p className='text-gray-600 mb-6'>El servicio solicitado no existe o ha sido removido.</p>
          <Link href='/servicios' className='text-blue-600 hover:underline'>
            Volver a Servicios
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className='min-h-screen bg-white pt-16'>
      <section className='w-full py-12 px-4 bg-gradient-to-b from-primary to-blue-800 text-white'>
        <div className='max-w-5xl mx-auto md:grid md:grid-cols-2 md:items-center md:gap-8'>
          <div>
            <div className='flex items-center gap-4'>
              <div className='text-5xl'>{service.icon}</div>
              <h1 className='text-4xl md:text-5xl font-bold'>{service.name}</h1>
            </div>
            <p className='mt-4 text-lg opacity-90 max-w-3xl'>{service.description}</p>
          </div>
          <div className='mt-8 md:mt-0 flex justify-center'>
            <div className='relative w-[280px] h-[180px] sm:w-[360px] sm:h-[220px] md:w-[420px] md:h-[260px] rounded-xl overflow-hidden shadow-lg'>
              <Image
                src={service.image || 'assets/fallback-image.svg'}
                alt={`Imagen ilustrativa de ${service.name}`}
                fill
                className='object-cover'
                sizes='(max-width: 768px) 360px, 420px'
                priority
              />
            </div>
          </div>
        </div>
      </section>
      <section className='w-full py-12 px-4'>
        <div className='max-w-5xl mx-auto space-y-10'>
          <div className='bg-white p-6 rounded-xl shadow-md border border-gray-100'>
            <h2 className='text-2xl font-semibold mb-4'>Resumen</h2>
            <p className='text-gray-700 mb-4'>
              Este servicio tiene una demanda aproximada del {service.demand}% en la plataforma.
            </p>
            <div className='w-full bg-gray-200 rounded-full h-2 mb-6'>
              <div
                className='bg-blue-600 h-2 rounded-full'
                style={{ width: `${service.demand}%` }}
              />
            </div>
            <div className='flex gap-3'>
              <Link
                href='/servicios'
                className='bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg'
              >
                Volver a servicios
              </Link>
              <Link
                href={`/buscar?servicio=${service.slug}`}
                className='border border-blue-600 text-blue-600 hover:bg-blue-50 font-semibold py-2 px-6 rounded-lg'
              >
                Buscar fixers para {service.name}
              </Link>
            </div>
          </div>

          <div className='bg-white p-6 rounded-xl shadow-md border border-gray-100'>
            <h2 className='text-2xl font-semibold mb-4'>Qué incluye</h2>
            <ul className='list-disc list-inside text-gray-700 space-y-2'>
              <li>Diagnóstico y asesoramiento inicial</li>
              <li>Mano de obra calificada</li>
              <li>Uso de herramientas adecuadas</li>
              <li>Limpieza básica del área de trabajo</li>
              <li>Garantía mínima de 30 días en la mano de obra</li>
            </ul>
          </div>

          <div className='bg-white p-6 rounded-xl shadow-md border border-gray-100'>
            <h2 className='text-2xl font-semibold mb-4'>Proceso típico</h2>
            <ol className='list-decimal list-inside text-gray-700 space-y-2'>
              <li>Solicitud y descripción del trabajo</li>
              <li>Evaluación y presupuesto estimado</li>
              <li>Ejecución del servicio</li>
              <li>Verificación y pruebas</li>
              <li>Cierre y recomendaciones de mantenimiento</li>
            </ol>
          </div>

          <div className='bg-white p-6 rounded-xl shadow-md border border-gray-100'>
            <h2 className='text-2xl font-semibold mb-4'>Precios orientativos</h2>
            <p className='text-gray-700 mb-3'>
              Los precios pueden variar según alcance y materiales:
            </p>
            <div className='grid grid-cols-1 sm:grid-cols-2 gap-4'>
              <div className='border rounded-lg p-4'>
                <p className='font-semibold'>Trabajo básico</p>
                <p className='text-sm text-gray-600'>Desde Bs. 80 a Bs. 150</p>
              </div>
              <div className='border rounded-lg p-4'>
                <p className='font-semibold'>Trabajo estándar</p>
                <p className='text-sm text-gray-600'>Desde Bs. 150 a Bs. 350</p>
              </div>
              <div className='border rounded-lg p-4'>
                <p className='font-semibold'>Trabajo complejo</p>
                <p className='text-sm text-gray-600'>Desde Bs. 350 a Bs. 800+</p>
              </div>
            </div>
          </div>

          <div className='bg-white p-6 rounded-xl shadow-md border border-gray-100'>
            <h2 className='text-2xl font-semibold mb-4'>Preguntas frecuentes</h2>
            <div className='space-y-4'>
              <details className='border rounded-lg p-4'>
                <summary className='cursor-pointer font-medium'>
                  ¿Cuál es el tiempo de respuesta?
                </summary>
                <p className='mt-2 text-gray-700'>
                  Usualmente dentro de 24 horas, dependiendo de la demanda.
                </p>
              </details>
              <details className='border rounded-lg p-4'>
                <summary className='cursor-pointer font-medium'>
                  ¿Los materiales están incluidos?
                </summary>
                <p className='mt-2 text-gray-700'>
                  Depende del servicio; se puede cotizar con o sin materiales.
                </p>
              </details>
              <details className='border rounded-lg p-4'>
                <summary className='cursor-pointer font-medium'>¿Ofrecen garantía?</summary>
                <p className='mt-2 text-gray-700'>Garantía mínima de 30 días en la mano de obra.</p>
              </details>
            </div>
          </div>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="src/app/[locale]/servicios/data.ts">
export type Service = {
  name: string;
  icon: string;
  description: string;
  demand: number;
  slug: string;
  image?: string;
};

export const services: Service[] = [
  {
    name: 'Plomería',
    icon: ' 🔧 ',
    description: 'Instalaciones, reparaciones y mantenimiento',
    demand: 95,
    slug: 'plomeria',
    image: '/Plomeria.webp',
  },
  {
    name: 'Electricidad',
    icon: ' ⚡ ',
    description: 'Instalaciones eléctricas y reparaciones',
    demand: 90,
    slug: 'electricidad',
    image: '/Electricistas.webp',
  },
  {
    name: 'Carpintería',
    icon: ' 🔨 ',
    description: 'Muebles, puertas y trabajos en madera',
    demand: 85,
    slug: 'carpinteria',
    image: '/Carpinteria.webp',
  },
  {
    name: 'Pintura',
    icon: ' 🎨 ',
    description: 'Pintura interior y exterior',
    demand: 80,
    slug: 'pintura',
    image: '/Pintura.webp',
  },
  {
    name: 'Limpieza',
    icon: '🧽',
    description: 'Limpieza residencial y comercial',
    demand: 88,
    slug: 'limpieza',
    image: '/Limpieza.webp',
  },
  {
    name: 'Jardinería',
    icon: ' 🌱 ',
    description: 'Mantenimiento y diseño de jardines',
    demand: 75,
    slug: 'jardineria',
    image: '/Jardineria.png',
  },
  {
    name: 'Albañilería',
    icon: '🧱',
    description: 'Construcción y reparaciones de albañilería',
    demand: 82,
    slug: 'albanileria',
    image: '/Albañileria.png',
  },
  {
    name: 'Cerrajería',
    icon: ' 🔑 ',
    description: 'Apertura de puertas y cambio de cerraduras',
    demand: 78,
    slug: 'cerrajeria',
    image: '/Cerrajeria.png',
  },
  {
    name: 'Gasfitería',
    icon: ' 💧 ',
    description: 'Instalación y reparación de tuberías de gas',
    demand: 70,
    slug: 'gasfiteria',
    image: '/Gasfiteria.png',
  },
  {
    name: 'Vidriería',
    icon: '🪟',
    description: 'Instalación y reparación de vidrios',
    demand: 72,
    slug: 'vidrieria',
    image: '/Vidrieria.png',
  },
  {
    name: 'Soldadura',
    icon: ' 🛠 ️',
    description: 'Trabajos de soldadura y metal',
    demand: 76,
    slug: 'soldadura',
    image: '/Soldadura.png',
  },
  {
    name: 'Mecánica',
    icon: ' 🚗 ',
    description: 'Mecánica ligera y mantenimiento',
    demand: 76,
    slug: 'mecanica',
    image: '/Mecanica.png',
  },
  {
    name: 'Refrigeración',
    icon: ' ❄️ ',
    description: 'Instalación y reparación de aire acondicionado',
    demand: 74,
    slug: 'refrigeracion',
    image: '/Refrigeracion.png',
  },
  {
    name: 'Techos y Cubiertas',
    icon: ' 🏠 ',
    description: 'Instalación y mantenimiento de techos',
    demand: 68,
    slug: 'techos',
    image: '/Techos y Cubiertas.png',
  },
  {
    name: 'Tapicería',
    icon: '🪑',
    description: 'Tapizado y restauración de muebles',
    demand: 66,
    slug: 'tapiceria',
    image: '/Tapiceria.png',
  },
  {
    name: 'Instalación CCTV',
    icon: ' 📷 ',
    description: 'Instalación y configuración de cámaras de seguridad',
    demand: 73,
    slug: 'cctv',
    image: '/Instalacion CCTV.png',
  },
  {
    name: 'Piscinas',
    icon: ' 🏊 ',
    description: 'Mantenimiento y limpieza de piscinas',
    demand: 65,
    slug: 'piscinas',
    image: '/Picsina.png',
  },
  {
    name: 'Mudanzas',
    icon: ' 🚚 ',
    description: 'Transporte y mudanza de bienes',
    demand: 77,
    slug: 'mudanzas',
    image: '/Mudanzas.png',
  },
  {
    name: 'Fumigación',
    icon: '🦟',
    description: 'Control de plagas y fumigación',
    demand: 69,
    slug: 'fumigacion',
    image: '/Fumigacion.png',
  },
  {
    name: 'Calefacción',
    icon: ' 🔥 ',
    description: 'Instalación y reparación de calefacción',
    demand: 71,
    slug: 'calefaccion',
    image: '/Calefaccion.png',
  },
  {
    name: 'Paneles Solares',
    icon: ' ☀️ ',
    description: 'Instalación de sistemas solares',
    demand: 67,
    slug: 'paneles-solares',
    image: '/Paneles Solares.png',
  },
  {
    name: 'Impermeabilización',
    icon: ' 💦 ',
    description: 'Sellado y protección contra humedad',
    demand: 64,
    slug: 'impermeabilizacion',
    image: '/Impermeablilizacion.png',
  },
  {
    name: 'Domótica',
    icon: ' 🏡 ',
    description: 'Automatización del hogar y smart devices',
    demand: 62,
    slug: 'domotica',
    image: '/Domotica.png',
  },
  {
    name: 'Lavado de alfombras',
    icon: '🧼',
    description: 'Lavado profundo y desinfección de alfombras',
    demand: 60,
    slug: 'lavado-alfombras',
    image: '/Lavado de alfombras.png',
  },
];
</file>

<file path="src/app/[locale]/servicios/page.tsx">
import ServicesSection from '@/Components/Home/Services-section';

export default function Page() {
  return (
    <ServicesSection
      showHero={true}
      showAllServices={true}
      showCTA={false}
      title='Todos Nuestros Servicios'
      subtitle='Explora la gama completa de soluciones que ofrecemos para tu hogar'
    />
  );
}
</file>

<file path="src/app/[locale]/signUp/layout.tsx">
'use client';

import { GoogleOAuthProvider } from '@react-oauth/google';
import { AuthProvider } from '@/Components/requester/auth/usoAutentificacion';

export default function SignUpLayout({ children }: { children: React.ReactNode }) {
  return (
    <AuthProvider>
      <GoogleOAuthProvider clientId={process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID!}>
        {children}
      </GoogleOAuthProvider>
    </AuthProvider>
  );
}
</file>

<file path="src/app/[locale]/signUp/registrar/Registrardecoder/generadorContrasena.ts">
export interface PasswordOptions {
  length?: number;
  lower?: boolean;
  upper?: boolean;
  numbers?: boolean;
  symbols?: boolean;
  avoidAmbiguous?: boolean;
}

export function generarContrasena(options: PasswordOptions = {}): string {
  const {
    length = 16,
    lower = true,
    upper = true,
    numbers = true,
    symbols = true,
    avoidAmbiguous = true,
  } = options;

  const lowerChars = 'abcdefghijklmnopqrstuvwxyz';
  const upperChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const numberChars = '0123456789';
  const symbolChars = '!@#$%^&*()-_=+[]{};:,.<>?';

  let charset = '';
  if (lower) charset += lowerChars;
  if (upper) charset += upperChars;
  if (numbers) charset += numberChars;
  if (symbols) charset += symbolChars;

  if (avoidAmbiguous) {
    charset = charset.replace(/[O0Il1]/g, '');
  }

  if (charset.length === 0) {
    throw new Error('Debe incluirse al menos un conjunto de caracteres.');
  }

  const array = new Uint32Array(length);
  window.crypto.getRandomValues(array);

  let password = '';
  for (let i = 0; i < length; i++) {
    password += charset[array[i] % charset.length];
  }

  return password;
}
</file>

<file path="src/app/[locale]/signUp/registrar/Registrardecoder/getID.ts">
import { jwtDecode } from 'jwt-decode';

interface DecodedToken {
  id: string;
  email: string;
  name: string;
  iat?: number;
  exp?: number;
}

export function getUserIdFromToken(): string | null {
  try {
    const token = localStorage.getItem('servineo_token');
    if (!token) return null;

    const decoded = jwtDecode<DecodedToken>(token);
    return decoded.id;
  } catch (error) {
    console.error('Error decodificando token:', error);
    return null;
  }
}
</file>

<file path="src/app/[locale]/signUp/registrar/registrarTelefono/page.tsx">
'use client';

import dynamic from 'next/dynamic';

const RegistroTelefono = dynamic(() => import('@/Components/requester/telefono/RegistroTelefono'), {
  ssr: false,
});

export default function PageTelefono() {
  return (
    <div className='w-full min-h-screen flex flex-col items-center justify-center bg-gradient-to-b from-white to-blue-50'>
      <RegistroTelefono />
    </div>
  );
}
</file>

<file path="src/app/[locale]/signUp/registrar/registrarUbicacion/page.tsx">
'use client';
import dynamic from 'next/dynamic';

const MapaLeaflet = dynamic(() => import('@/Components/requester/mapas/Mapa'), { ssr: false });

export default function PageUbicacion() {
  return (
    <div className='w-full min-h-screen flex flex-col items-center justify-center bg-gray-50'>
      <MapaLeaflet />
    </div>
  );
}
</file>

<file path="src/app/[locale]/signUp/registrar/registroServicios/page.tsx">
'use client';

import { useState, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { Eye, EyeOff, Loader2 } from 'lucide-react';
import { z } from 'zod';
import { useTranslations } from 'next-intl';
import { enviarRegistroManual } from '@/app/redux/services/auth/registro';
import { generarContrasena } from '../Registrardecoder/generadorContrasena';

interface RegistroFormProps {
  onNotify?: (notification: {
    type: 'success' | 'error' | 'info' | 'warning';
    title: string;
    message: string;
  }) => void;
  captchaValid: boolean; // <-- NUEVO
}

const nameRegex = /^[A-Za-záéíóúÁÉÍÓÚñÑ\s]+$/;

type RegistroSchema = {
  nombre: string;
  apellido: string;
  email: string;
  password: string;
  confirmarPassword: string;
};

export default function RegistroForm({ onNotify, captchaValid }: RegistroFormProps) {
  const t = useTranslations('RegistroForm');
  const router = useRouter();

  // Schema con traducciones usando useMemo
  const registroSchema = useMemo(
    () =>
      z
        .object({
          nombre: z
            .string()
            .min(3, t('validation.nombre.min'))
            .max(50, t('validation.nombre.max'))
            .regex(nameRegex, t('validation.nombre.regex')),
          apellido: z
            .string()
            .min(3, t('validation.apellido.min'))
            .max(50, t('validation.apellido.max'))
            .regex(nameRegex, t('validation.apellido.regex')),
          email: z.string().email(t('validation.email.invalid')),
          password: z.string().min(8, t('validation.password.min')),
          confirmarPassword: z.string(),
        })
        .refine((data) => data.password === data.confirmarPassword, {
          message: t('validation.confirmarPassword.match'),
          path: ['confirmarPassword'],
        }),
    [t],
  );

  const [formData, setFormData] = useState<RegistroSchema>({
    nombre: '',
    apellido: '',
    email: '',
    password: '',
    confirmarPassword: '',
  });
  const [errors, setErrors] = useState<Partial<Record<keyof RegistroSchema, string>>>({});
  const [mostrarPassword, setMostrarPassword] = useState(false);
  const [mostrarConfirmarPassword, setMostrarConfirmarPassword] = useState(false);
  const [mostrarTooltip, setMostrarTooltip] = useState(false);
  const [cargando, setCargando] = useState(false);

  /* --------------------------- HANDLERS --------------------------- */

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));
    setErrors((prev) => ({ ...prev, [name]: undefined }));
  };

  const handleGenerarContrasena = () => {
    const nueva = generarContrasena({
      length: 12,
      symbols: true,
      avoidAmbiguous: true,
    });

    setFormData((prev) => ({
      ...prev,
      password: nueva,
      confirmarPassword: nueva,
    }));

    setMostrarTooltip(false);
    setMostrarPassword(true);
    navigator.clipboard.writeText(nueva);

    onNotify?.({
      type: 'info',
      title: t('notifications.passwordGenerated.title'),
      message: t('notifications.passwordGenerated.message'),
    });
  };

  /* --------------------------- SUBMIT --------------------------- */

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!captchaValid) {
      onNotify?.({
        type: 'warning',
        title: 'Completa la verificación',
        message: 'Debes completar el captcha antes de continuar.',
      });
      return;
    }

    const validation = registroSchema.safeParse(formData);

    if (!validation.success) {
      const fieldErrors: Partial<Record<keyof RegistroSchema, string>> = {};

      validation.error.issues.forEach((err: z.ZodIssue) => {
        const field = err.path[0] as keyof RegistroSchema;
        fieldErrors[field] = err.message;
      });

      setErrors(fieldErrors);

      onNotify?.({
        type: 'warning',
        title: t('notifications.validationError.title'),
        message: t('notifications.validationError.message'),
      });

      return;
    }

    setCargando(true);
    const nombreCompleto = `${formData.nombre.trim()} ${formData.apellido.trim()}`;

    try {
      const data = await enviarRegistroManual(nombreCompleto, formData.email, formData.password);

      if (data.success) {
        if (data.token) localStorage.setItem('servineo_token', data.token);

        onNotify?.({
          type: 'success',
          title: t('notifications.success.title'),
          message: t('notifications.success.message', { name: nombreCompleto }),
        });

        sessionStorage.setItem(
          'toastMessage',
          t('notifications.success.toast', { name: nombreCompleto }),
        );
        router.push('/signUp/registrar/registrarFoto');
      } else {
        onNotify?.({
          type: 'error',
          title: t('notifications.error.title'),
          message: data.message || t('notifications.error.message'),
        });
      }
    } finally {
      setCargando(false);
    }
  };

  /* --------------------------- UI --------------------------- */

  return (
    <form onSubmit={handleSubmit} className='flex flex-col gap-4'>
      {/* Nombre y Apellido */}
      <div className='flex gap-2'>
        <div className='flex-1 min-w-0'>
          <label className='block text-sm font-semibold text-gray-600 mb-2'>
            {t('fields.nombre.label')}*
          </label>
          <input
            name='nombre'
            value={formData.nombre}
            onChange={handleChange}
            placeholder={t('fields.nombre.placeholder')}
            className={`w-full border rounded-xl p-2.5 text-gray-800 focus:outline-none focus:ring-2 transition ${
              errors.nombre
                ? 'border-red-500 focus:ring-red-400'
                : 'border-gray-300 focus:ring-servineo-400'
            }`}
          />
          {errors.nombre && <p className='text-red-500 text-xs mt-1'>{errors.nombre}</p>}
        </div>

        <div className='flex-1 min-w-0'>
          <label className='block text-sm font-semibold text-gray-600 mb-2'>
            {t('fields.apellido.label')}*
          </label>
          <input
            name='apellido'
            value={formData.apellido}
            onChange={handleChange}
            placeholder={t('fields.apellido.placeholder')}
            className={`w-full border rounded-xl p-2.5 text-gray-800 focus:outline-none focus:ring-2 transition ${
              errors.apellido
                ? 'border-red-500 focus:ring-red-400'
                : 'border-gray-300 focus:ring-servineo-400'
            }`}
          />
          {errors.apellido && <p className='text-red-500 text-xs mt-1'>{errors.apellido}</p>}
        </div>
      </div>

      {/* Correo */}
      <div>
        <label className='block text-sm font-semibold text-gray-600 mb-2'>
          {t('fields.email.label')}*
        </label>
        <input
          name='email'
          type='email'
          value={formData.email}
          onChange={handleChange}
          placeholder={t('fields.email.placeholder')}
          className={`w-full border rounded-xl p-2.5 text-gray-800 focus:outline-none focus:ring-2 transition ${
            errors.email
              ? 'border-red-500 focus:ring-red-400'
              : 'border-gray-300 focus:ring-servineo-400'
          }`}
        />
        {errors.email && <p className='text-red-500 text-xs mt-1'>{errors.email}</p>}
      </div>

      {/* Contraseña */}
      <div>
        <label className='block text-sm font-semibold text-gray-600 mb-2'>
          {t('fields.password.label')}*
        </label>
        <div className='relative'>
          <input
            name='password'
            type={mostrarPassword ? 'text' : 'password'}
            value={formData.password}
            onChange={handleChange}
            placeholder={t('fields.password.placeholder')}
            className={`w-full border rounded-xl p-2.5 text-gray-800 focus:outline-none focus:ring-2 transition ${
              errors.password
                ? 'border-red-500 focus:ring-red-400'
                : 'border-gray-300 focus:ring-servineo-400'
            }`}
          />
          <button
            type='button'
            onClick={() => setMostrarPassword(!mostrarPassword)}
            className='absolute inset-y-0 right-3 flex items-center text-gray-500 hover:text-gray-700'
            aria-label={mostrarPassword ? t('aria.hidePassword') : t('aria.showPassword')}
          >
            {mostrarPassword ? <EyeOff size={18} /> : <Eye size={18} />}
          </button>
        </div>
        {errors.password && <p className='text-red-500 text-xs mt-1'>{errors.password}</p>}

        <div className='relative'>
          <button
            type='button'
            onClick={handleGenerarContrasena}
            onMouseEnter={() => setMostrarTooltip(true)}
            onMouseLeave={() => setMostrarTooltip(false)}
            className='text-sm text-servineo-500 hover:underline mt-1'
          >
            {t('buttons.generatePassword')}
          </button>

          {mostrarTooltip && (
            <div className='absolute top-full left-0 mt-1 bg-gray-100 border border-gray-300 text-gray-700 text-xs px-3 py-2 rounded-lg shadow-md animate-fade-in z-10'>
              {t('tooltips.passwordCopy')}
            </div>
          )}
        </div>
      </div>

      {/* Confirmar contraseña */}
      <div>
        <label className='block text-sm font-semibold text-gray-600 mb-2'>
          {t('fields.confirmarPassword.label')}*
        </label>
        <div className='relative'>
          <input
            name='confirmarPassword'
            type={mostrarConfirmarPassword ? 'text' : 'password'}
            value={formData.confirmarPassword}
            onChange={handleChange}
            placeholder={t('fields.confirmarPassword.placeholder')}
            className={`w-full border rounded-xl p-2.5 text-gray-800 focus:outline-none focus:ring-2 transition ${
              errors.confirmarPassword
                ? 'border-red-500 focus:ring-red-400'
                : 'border-gray-300 focus:ring-servineo-400'
            }`}
          />
          <button
            type='button'
            onClick={() => setMostrarConfirmarPassword(!mostrarConfirmarPassword)}
            className='absolute inset-y-0 right-3 flex items-center text-gray-500 hover:text-gray-700'
            aria-label={mostrarConfirmarPassword ? t('aria.hidePassword') : t('aria.showPassword')}
          >
            {mostrarConfirmarPassword ? <EyeOff size={18} /> : <Eye size={18} />}
          </button>
        </div>
        {errors.confirmarPassword && (
          <p className='text-red-500 text-xs mt-1'>{errors.confirmarPassword}</p>
        )}
      </div>

      {/* Submit */}
      <button
        type='submit'
        disabled={cargando}
        className={`w-full flex items-center justify-center gap-2
      ${!captchaValid ? 'bg-primary/60 cursor-not-allowed' : 'bg-primary/90 hover:bg-primary'}
       ${cargando ? 'opacity-60 cursor-not-allowed' : ''}
       text-white font-semibold rounded-xl p-2.5 mt-2 transition-all duration-300
       shadow-md hover:shadow-lg`}
      >
        {cargando ? (
          <>
            <Loader2 className='animate-spin w-5 h-5' />
            {t('buttons.submitting')}
          </>
        ) : (
          t('buttons.submit')
        )}
      </button>
    </form>
  );
}
</file>

<file path="src/app/[locale]/signUp/registrar/registroServicios/registroGoogle.tsx">
'use client';

import { useRouter } from 'next/navigation';
import { useAuth } from '@/Components/requester/auth/usoAutentificacion';
import { CredentialResponse } from '@react-oauth/google';
import GoogleButton from '@/Components/requester/botonRegistro/buttonGoogle';
import { enviarTokenGoogle, GoogleAuthResponse } from '@/app/redux/services/auth/registro';

interface RegistroGoogleProps {
  onSuccessClose?: () => void;
  onNotify?: (notification: {
    type: 'success' | 'error' | 'info' | 'warning';
    title: string;
    message: string;
  }) => void;

  captchaValid: boolean;
}

export default function RegistroGoogle({
  onSuccessClose,
  onNotify,
  captchaValid,
}: RegistroGoogleProps) {
  const router = useRouter();
  const { setUser } = useAuth();

  const handleLoginSuccess = async (credentialResponse: CredentialResponse) => {
    if (!captchaValid) {
      onNotify?.({
        type: 'warning',
        title: 'Completa la verificación',
        message: 'Debes confirmar que no eres un robot antes de continuar.',
      });
      return;
    }
    const token = credentialResponse?.credential;
    if (!token) {
      onNotify?.({
        type: 'error',
        title: 'Token no recibido',
        message: 'No se recibió el token de Google.',
      });
      return;
    }

    try {
      const data: GoogleAuthResponse = await enviarTokenGoogle(token);
      console.log('Respuesta del backend:', data);

      if (data.status === 'error') {
        onNotify?.({
          type: 'error',
          title: 'Error',
          message: data.message || 'Error al autenticar con Google.',
        });
        return;
      }

      if (data.firstTime) {
        onNotify?.({
          type: 'info',
          title: 'Bienvenido',
          message: 'Primera vez en Servineo. Completa tu perfil para continuar.',
        });

        sessionStorage.setItem('google_token_temp', token);
        if (onSuccessClose) onSuccessClose();

        setTimeout(() => router.push('/signUp/registrar/registroUbicacion'), 2500);
        return;
      }

      if (data.token) localStorage.setItem('servineo_token', data.token);
      if (data.user) {
        localStorage.setItem('servineo_user', JSON.stringify(data.user));
        setUser(data.user);
      }

      onNotify?.({
        type: 'success',
        title: 'Inicio de sesión exitoso',
        message: `Bienvenido nuevamente, ${data.user?.name || 'usuario'}`,
      });

      if (onSuccessClose) onSuccessClose();
      setTimeout(() => (window.location.href = '/'), 2000);
    } catch (error: unknown) {
      console.error('Error al enviar el token al backend:', error);

      const errorMessage =
        error instanceof Error
          ? error.message
          : 'No se pudo conectar con el servidor. Intenta nuevamente.';

      onNotify?.({
        type: 'error',
        title: 'Error de conexión',
        message: errorMessage,
      });
    }
  };

  return (
    <div className='flex justify-center'>
      <GoogleButton
        onLoginSuccess={handleLoginSuccess}
        disabled={!captchaValid}
        onDisabledClick={() =>
          onNotify?.({
            type: 'warning',
            title: 'Verificación requerida',
            message: 'Debes completar el captcha antes de continuar.',
          })
        }
      />
    </div>
  );
}
</file>

<file path="src/app/[locale]/signUp/registrar/registroUbicacion/page.tsx">
'use client';

import dynamic from 'next/dynamic';

const MapaLeaflet = dynamic(() => import('@/Components/requester/mapas/MapaLeaflet'), {
  ssr: false,
});

export default function PageUbicacion() {
  return (
    <div className='w-full min-h-screen flex flex-col items-center justify-center bg-gray-50'>
      <MapaLeaflet />
    </div>
  );
}
</file>

<file path="src/app/[locale]/signUp/registrar/telefono/page.tsx">
'use client';

import dynamic from 'next/dynamic';

const RegistroTelefono = dynamic(() => import('@/Components/requester/telefono/RegistroTelefono'), {
  ssr: false,
});

export default function PageTelefono() {
  return (
    <div className='w-full min-h-screen flex flex-col items-center justify-center bg-gray-50'>
      <RegistroTelefono />
    </div>
  );
}
</file>

<file path="src/app/[locale]/signUp/registrar/Terminosycondiciones/page.tsx">
'use client';
import React from 'react';
import { useTranslations } from 'next-intl';

export default function TerminosPage() {
  const t = useTranslations('TerminosPage');

  return (
    <main className='max-w-4xl mx-auto p-6 md:p-12'>
      <h1 className='text-3xl font-bold mb-6 text-center'>{t('title')}</h1>

      <section className='mb-6'>
        <h2 className='text-xl font-semibold mb-2'>{t('section1.title')}</h2>
        <p>{t('section1.content')}</p>
      </section>

      <section className='mb-6'>
        <h2 className='text-xl font-semibold mb-2'>{t('section2.title')}</h2>
        <p>{t('section2.content1')}</p>
        <p>{t('section2.content2')}</p>
      </section>

      <section className='mb-6'>
        <h2 className='text-xl font-semibold mb-2'>{t('section3.title')}</h2>
        <p>{t('section3.content')}</p>
      </section>

      <section className='mb-6'>
        <h2 className='text-xl font-semibold mb-2'>{t('section4.title')}</h2>
        <p>{t('section4.content')}</p>
      </section>

      <section className='mb-6'>
        <h2 className='text-xl font-semibold mb-2'>{t('section5.title')}</h2>
        <p>{t('section5.content')}</p>
      </section>

      <section className='mb-6'>
        <h2 className='text-xl font-semibold mb-2'>{t('section6.title')}</h2>
        <p>{t('section6.content')}</p>
      </section>

      <section className='mb-6'>
        <h2 className='text-xl font-semibold mb-2'>{t('section7.title')}</h2>
        <p>{t('section7.content')}</p>
      </section>

      <section className='mb-6'>
        <h2 className='text-xl font-semibold mb-2'>{t('section8.title')}</h2>
        <p>
          {t('section8.content')}{' '}
          <a href='mailto:XXXXXXXX#@gmail.com' className='text-blue-600 hover:underline'>
            XXXXXXXX#@gmail.com
          </a>
        </p>
      </section>
    </main>
  );
}
</file>

<file path="src/app/[locale]/sudoers/layout.tsx">
import type { Metadata } from 'next';
import { Geist, Geist_Mono } from 'next/font/google';
import '../../globals.css';

const geistSans = Geist({
  variable: '--font-geist-sans',
  subsets: ['latin'],
});

const geistMono = Geist_Mono({
  variable: '--font-geist-mono',
  subsets: ['latin'],
});

export const metadata: Metadata = {
  title: 'Servineo',
  description: 'Find trusted local handymen for all your home repair needs.',
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang='en'>
      <body className={`${geistSans.variable} ${geistMono.variable} antialiased`}>{children}</body>
    </html>
  );
}
</file>

<file path="src/app/[locale]/sudoers/page.tsx">
import Link from 'next/link';

export default function Home() {
  return (
    <main className='min-h-screen bg-white flex items-center justify-center'>
      <div className='text-center space-y-8'>
        <h1 className='text-3xl sm:text-4xl font-semibold text-gray-900'>Servineo</h1>
        <div className='flex items-center justify-center gap-4'>
          <Link
            href='/fixers'
            className='px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition'
          >
            Fixers
          </Link>
          <Link
            href='/requesters'
            className='px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition'
          >
            Requesters
          </Link>
          <Link
            href='/tests'
            className='px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition'
          >
            Tests
          </Link>
        </div>
      </div>
    </main>
  );
}
</file>

<file path="src/app/[locale]/test/cancelTestpage.tsx">
'use client';
import { useState } from 'react';
import { Button } from '../../componentsLorem/atoms/button'; // Ajusta la ruta según tu estructura'
import CancelDaysAppointments from '../../componentsLorem/appointments/forms/CancelDaysAppointment';

export default function TestPage() {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [loading, setLoading] = useState(false);

    const handleConfirmCancel = async (selectedDays: string[]) => {
        setLoading(true);
        console.log('Días seleccionados para cancelar:', selectedDays);

        // Simular llamada API
        await new Promise(resolve => setTimeout(resolve, 2000));

        setLoading(false);
        setIsModalOpen(false);
        alert(`Se cancelarán citas en ${selectedDays.length} días`);
    };

    return (
        <div className="p-8">
            <h1 className="text-2xl font-bold mb-6">Página de Testing</h1>

            <Button
                onClick={() => setIsModalOpen(true)}
                variant="primary"
            >
                Abrir Modal de Cancelación
            </Button>

            <CancelDaysAppointments
                isOpen={isModalOpen}
                onClose={() => setIsModalOpen(false)}
                loading={loading}
            />
        </div>
    );
}
</file>

<file path="src/app/[locale]/test/page.tsx">
"use client";
import { useState, useEffect } from "react";
import { getSixMonthAppointments, Appointment } from '../../../utils/Appointments/getSixMonthAppointments';
import useSixMonthsAppointments from '../../../hooks/Appointments/useSixMonthsAppointments';

import useDailyConts from "../../../utils/useDailyConts";
const fixer_id = "68e87a9cdae3b73d8040102f";
const requester_id = "68ec99ddf39c7c140f42fcfa";
const today = new Date().toISOString().split('T')[0];

const todidi = new Date();
const todi = new Date(2025, 11, 9);
console.log(todi);
export default function CalendarPage() {
    const [appointments, setAppointments] = useState<Appointment[]>([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);



    const fetchAppointments = async () => {
        setLoading(true);
        setError(null);
        try {
            const data = await getSixMonthAppointments(fixer_id, today);
            setAppointments(data);
            console.log('✅ Datos recibidos:', data);
        } catch (err) {
            setError('Error al cargar');
            console.error('❌ Error:', err);
        } finally {
            setLoading(false);
        }
    };

    // 👇 ESTO ES LO QUE LE FALTABA
    useEffect(() => {
        fetchAppointments();
    }, []); // Se ejecuta una vez al montar el componente
    const { isHourBooked } = useSixMonthsAppointments(fixer_id, todi);

    return (
        <div className="text-black" >
            <h2> Test de getSixMonthAppointments</h2>

            <button onClick={fetchAppointments} disabled={loading}>
                {loading ? 'Cargando...' : 'Recargar datos'}
            </button>

            {error && <p style={{ color: 'red' }}>Error: {error}</p>}

            <div>
                <h3>Resultados:</h3>
                <p>Total de citas: {appointments.length}</p>

                {loading && <p>⏳ Cargando...</p>}

                {!loading && appointments.length === 0 && (
                    <p>⚠️ No hay citas</p>
                )}

                {appointments.length > 0 && (
                    <pre style={{ background: '#f5f5f5', padding: '10px', overflow: 'auto' }}>
                        {JSON.stringify(appointments, null, 2)}
                    </pre>
                )}
            </div>
        </div>
    );
}
</file>

<file path="src/app/[locale]/tests/page.tsx">
'use client';
import { useState } from 'react';
import ActivateOfferModal from '@/app/components/fixers/ActivateOfferModal';

export default function RequestersLanding() {
  const offerId = '68eedc4ddf120f15a959ace8';
  const [isActive, setIsActive] = useState(true);
  const [open, setOpen] = useState(false);

  const handleConfirm = (newStatus: boolean, offerId: string) => {
    setIsActive(newStatus);
    setOpen(false);
    console.log(`Oferta ${offerId} actualizada a ${newStatus ? 'active' : 'inactive'}`);
  };

  return (
    <main className='min-h-screen bg-white flex items-center justify-center'>
      <div className='text-center space-y-8'>
        <button
          onClick={() => setOpen(true)}
          className='px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition'
        >
          {isActive ? 'Desactivar oferta' : 'Activar oferta'}
        </button>
      </div>

      <ActivateOfferModal
        open={open}
        isActive={isActive}
        offerId={offerId}
        onConfirm={handleConfirm}
        onClose={() => setOpen(false)}
      />
    </main>
  );
}
</file>

<file path="src/app/[locale]/user-admin/components/adminDashboard.tsx">
'use client';
import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import styles from '../styles/admin.module.css';
import { adminAPI } from '../lib/api';
import ChartsSection from './chartsSection';

interface UserStatsData {
  totalUsers: number;
  usersByRole: {
    requester: number;
    fixer: number;
    visitor: number;
    admin: number;
  };
  timestamp: string;
  note?: string;
  source?: string;
}

export default function AdminDashboard() {
  const [userStats, setUserStats] = useState<UserStatsData | null>(null);
  const [loading, setLoading] = useState(true);
  const [statsLoading, setStatsLoading] = useState(true);
  const [lastUpdated, setLastUpdated] = useState<string>('');
  const router = useRouter();

  useEffect(() => {
    const checkAuthAndLoadData = async () => {
      const token = localStorage.getItem('adminToken');
      const adminData = localStorage.getItem('adminUser');

      if (!token || !adminData) {
        router.push('/es/user-admin');
        return;
      }

      try {
        // Verificar token
        const authCheck = await adminAPI.verifyToken(token);
        if (!authCheck.valid) {
          localStorage.removeItem('adminToken');
          localStorage.removeItem('adminUser');
          router.push('/es/user-admin');
          return;
        }

        // Cargar estadísticas REALES de usuarios
        console.log('🔄 Cargando estadísticas REALES...');
        const statsResponse = await adminAPI.getUserStats(token);
        
        if (statsResponse.success && statsResponse.data) {
          setUserStats(statsResponse.data);
          setLastUpdated(new Date(statsResponse.data.timestamp).toLocaleTimeString());
          console.log('✅ Datos REALES cargados:', statsResponse.data);
        }
        
      } catch (error) {
        console.error('❌ Error cargando datos:', error);
        
        // Datos de respaldo (los reales que ya conocemos)
        setUserStats({
          totalUsers: 152,
          usersByRole: {
            requester: 110,
            fixer: 41,
            visitor: 0,
            admin: 1
          },
          timestamp: new Date().toISOString(),
          note: 'Datos en caché (error de conexión)'
        });
      } finally {
        setLoading(false);
        setStatsLoading(false);
      }
    };

    checkAuthAndLoadData();
  }, [router]);

  const handleLogout = () => {
    localStorage.removeItem('adminToken');
    localStorage.removeItem('adminUser');
    router.push('/es/user-admin');
  };

  const handleRefreshStats = async () => {
    const token = localStorage.getItem('adminToken');
    if (!token) return;

    setStatsLoading(true);
    try {
      console.log('🔄 Actualizando estadísticas...');
      const statsResponse = await adminAPI.getUserStats(token);
      
      if (statsResponse.success && statsResponse.data) {
        setUserStats(statsResponse.data);
        setLastUpdated(new Date(statsResponse.data.timestamp).toLocaleTimeString());
        console.log('✅ Estadísticas actualizadas:', statsResponse.data);
      }
    } catch (error) {
      console.error('❌ Error actualizando:', error);
    } finally {
      setStatsLoading(false);
    }
  };

  if (loading) {
    return (
      <div className={styles.dashboard}>
        <div className={styles.loading}>Loading dashboard...</div>
      </div>
    );
  }

  return (
    <div className={styles.dashboard}>
      <header className={styles.dashboardHeader}>
        <h1 className={styles.dashboardTitle}>SERVINEO</h1>
        <div className={styles.adminInfo}>
          <span>Welcome, Admin</span>
          <button onClick={handleLogout} className={styles.logoutButton}>
            Logout
          </button>
        </div>
      </header>

      {/* 📊 ESTADÍSTICAS REALES DE USUARIOS */}
      <div className={styles.metricsSection}>
        <div className={styles.sectionHeader}>
          <h2>👥 Estadísticas de Usuarios</h2>
          <div className={styles.headerActions}>
            {lastUpdated && (
              <span className={styles.lastUpdated}>
                Actualizado: {lastUpdated}
              </span>
            )}
            <button 
              onClick={handleRefreshStats} 
              className={styles.refreshButton}
              disabled={statsLoading}
            >
              {statsLoading ? 'Actualizando...' : '🔄 Actualizar'}
            </button>
          </div>
        </div>
        
        <div className={styles.metricsGrid}>
          <div className={styles.metricCard}>
            <h3>Total de Usuarios</h3>
            <div className={styles.metricValue}>
              {statsLoading ? (
                <span className={styles.loadingText}>Cargando...</span>
              ) : (
                userStats?.totalUsers?.toLocaleString() || '0'
              )}
            </div>
            <div className={styles.metricDescription}>
              Usuarios registrados en el sistema
            </div>
          </div>
        </div>

        {/* DISTRIBUCIÓN POR ROL */}
        <div className={styles.distributionSection}>
          <h3>📋 Distribución por Rol</h3>
          <div className={styles.distributionGrid}>
            <div className={`${styles.roleCard} ${styles.requesterCard}`}>
              <div className={styles.roleHeader}>
                <span className={styles.roleIcon}>👤</span>
                <span className={styles.roleName}>Requesters</span>
              </div>
              <div className={styles.roleCount}>
                {userStats?.usersByRole?.requester || 0}
              </div>
              <div className={styles.rolePercentage}>
                {userStats?.totalUsers 
                  ? `${Math.round(((userStats.usersByRole?.requester || 0) / userStats.totalUsers) * 100)}%` 
                  : '0%'}
              </div>
            </div>

            <div className={`${styles.roleCard} ${styles.fixerCard}`}>
              <div className={styles.roleHeader}>
                <span className={styles.roleIcon}>🛠️</span>
                <span className={styles.roleName}>Fixers</span>
              </div>
              <div className={styles.roleCount}>
                {userStats?.usersByRole?.fixer || 0}
              </div>
              <div className={styles.rolePercentage}>
                {userStats?.totalUsers 
                  ? `${Math.round(((userStats.usersByRole?.fixer || 0) / userStats.totalUsers) * 100)}%` 
                  : '0%'}
              </div>
            </div>

            <div className={`${styles.roleCard} ${styles.visitorCard}`}>
              <div className={styles.roleHeader}>
                <span className={styles.roleIcon}>👁️</span>
                <span className={styles.roleName}>Visitors</span>
              </div>
              <div className={styles.roleCount}>
                {userStats?.usersByRole?.visitor || 0}
              </div>
              <div className={styles.rolePercentage}>
                {userStats?.totalUsers 
                  ? `${Math.round(((userStats.usersByRole?.visitor || 0) / userStats.totalUsers) * 100)}%` 
                  : '0%'}
              </div>
            </div>

            <div className={`${styles.roleCard} ${styles.adminCard}`}>
              <div className={styles.roleHeader}>
                <span className={styles.roleIcon}>⚡</span>
                <span className={styles.roleName}>Admins</span>
              </div>
              <div className={styles.roleCount}>
                {userStats?.usersByRole?.admin || 0}
              </div>
              <div className={styles.rolePercentage}>
                {userStats?.totalUsers 
                  ? `${Math.round(((userStats.usersByRole?.admin || 0) / userStats.totalUsers) * 100)}%` 
                  : '0%'}
              </div>
            </div>
          </div>
        </div>

        {/* NOTA INFORMATIVA */}
        {userStats?.note && (
          <div className={styles.infoNote}>
            <div className={styles.infoIcon}>ℹ️</div>
            <div className={styles.infoContent}>
              <p>{userStats.note}</p>
              {userStats.source && <small>Fuente: {userStats.source}</small>}
            </div>
          </div>
        )}
      </div>

      {/* 🔗 MÓDULOS EXTERNOS */}
      <div className={styles.externalModulesSection}>
        <h3>🔧 Módulos Administrativos</h3>
        <p className={styles.sectionSubtitle}>Accede a las herramientas específicas del sistema</p>

        <div className={styles.modulesGrid}>
          <button
            onClick={() =>
              window.open(
                'https://servineo-frontend-bytes-bandidos.vercel.app/es/adminStatistic',
                '_self',
              )
            }
            className={styles.moduleButton}
          >
            <div className={styles.moduleIcon}>📊</div>
            <div className={styles.moduleContent}>
              <h4>Estadísticas Avanzadas</h4>
              <p>Métricas detalladas y análisis del sistema</p>
              <div className={styles.moduleMeta}>
                <span className={styles.moduleStatus}>Disponible</span>
                <span className={styles.moduleTeam}>Grupo Analytics</span>
              </div>
            </div>
            <div className={styles.moduleArrow}>→</div>
          </button>

          <button
            onClick={() =>
              window.open(
                'https://servineo-frontend-bytes-bandidos.vercel.app/es/tracking-appointments',
                '_self',
              )
            }
            className={styles.moduleButton}
          >
            <div className={styles.moduleIcon}>📍</div>
            <div className={styles.moduleContent}>
              <h4>Seguimiento de Citas</h4>
              <p>Monitoreo y gestión de appointments activos</p>
              <div className={styles.moduleMeta}>
                <span className={styles.moduleStatus}>Disponible</span>
                <span className={styles.moduleTeam}>Grupo Tracking</span>
              </div>
            </div>
            <div className={styles.moduleArrow}>→</div>
          </button>
        </div>
      </div>

      {/* 📈 GRÁFICO DE SESIONES */}
      <div className={styles.chartsSection}>
        <h3>📈 Registro de Sesiones</h3>
        <p className={styles.sectionSubtitle}>Análisis de inicios y finalizaciones de sesión</p>
        <ChartsSection />
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/user-admin/dashboard/page.tsx">
import AdminDashboard from '../components/adminDashboard';

export default function DashboardPage() {
  return <AdminDashboard />;
}
</file>

<file path="src/app/[locale]/user-admin/lib/api.ts">
// lib/api.ts - SOLO lo necesario
const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';

export const adminAPI = {
  // Login normal
  login: async (credentials: { email: string; password: string }) => {
    const response = await fetch(`${API_BASE}/api/admin/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(credentials),
    });
    return response.json();
  },

  // Login con Google
  loginWithGoogle: async (credential: string) => {
    const response = await fetch(`${API_BASE}/api/admin/login/google`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ credential }),
    });
    return response.json();
  },

  // Verificar token
  verifyToken: async (token: string) => {
    const response = await fetch(`${API_BASE}/api/admin/verify`, {
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });
    return response.json();
  },


  // NUEVO: Obtener estadísticas REALES de usuarios
  getUserStats: async (token: string) => {
    console.log('📊 Obteniendo estadísticas REALES de usuarios...');
    
    try {
      const response = await fetch(`${API_BASE}/api/admin/user-stats`, {
        headers: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const data = await response.json();
      console.log('✅ Estadísticas REALES recibidas:', data);
      return data;
    } catch (error) {
      console.error('❌ Error obteniendo estadísticas REALES:', error);
      
      // Fallback a los datos reales que ya conocemos
      return {
        success: true,
        data: {
          totalUsers: 152,
          usersByRole: {
            requester: 110,
            fixer: 41,
            visitor: 0,
            admin: 1
          },
          timestamp: new Date().toISOString(),
          note: 'Datos de respaldo (conexión fallida)'
        }
      };
    }
  },


  // SOLO gráficos de sesiones (lo que funciona)
  getSessionStartChart: async (token: string, date: string, endDate?: string) => {
    const params = new URLSearchParams({ date });
    if (endDate) params.append('enddate', endDate);

    const response = await fetch(`${API_BASE}/api/admin/chart/session/start?${params}`, {
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });
    return response.json();
  },

  getSessionEndChart: async (token: string, date: string, endDate?: string) => {
    const params = new URLSearchParams({ date });
    if (endDate) params.append('enddate', endDate);

    const response = await fetch(`${API_BASE}/api/admin/chart/session/end?${params}`, {
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });
    return response.json();
  },
};
</file>

<file path="src/app/[locale]/user-admin/lib/mockAuth.ts">
// SIMULACION DE BACKEND

export const mockAuth = {
  // Simular login de admin
  adminLogin: async (email: string, password: string) => {
    // Simular delay de red
    await new Promise((resolve) => setTimeout(resolve, 1000));

    // Credenciales hardcodeadas para desarrollo
    if (email === 'admin@servineo.com' && password === 'admin123') {
      return {
        success: true,
        token: 'mock-admin-token-12345',
        admin: {
          id: 1,
          name: 'Administrador',
          email: email,
          role: 'admin',
        },
      };
    } else {
      return {
        success: false,
        message: 'Credenciales incorrectas',
      };
    }
  },

  // Verificar token de admin
  verifyAdminToken: async (token: string) => {
    await new Promise((resolve) => setTimeout(resolve, 500));

    if (token === 'mock-admin-token-12345') {
      return {
        valid: true,
        admin: {
          id: 1,
          name: 'Administrador',
          role: 'admin',
        },
      };
    }
    return { valid: false };
  },

  // Obtener métricas para el dashboard
  getAdminMetrics: async () => {
    await new Promise((resolve) => setTimeout(resolve, 800));

    return {
      metrics: {
        totalUsers: 16772,
        activeJobs: 2367,
        revenue: 45600,
        totalSessions: 16772,
        searches: 2367,
        topSearch: 456,
        sessionStats: {
          requester: 8234,
          fixer: 5189,
          visitor: 3349,
        },
        popularSearches: [
          { term: 'Plomeria', count: 456 },
          { term: 'Electricista', count: 389 },
          { term: 'Carpinteria', count: 267 },
        ],
      },
    };
  },
};
</file>

<file path="src/app/[locale]/user-admin/page.tsx">
import AdminLogin from './components/adminLogin';

export default function AdminLoginPage() {
  return <AdminLogin />;
}
</file>

<file path="src/app/[locale]/user-admin/styles/admin.module.css">
/* ===== LOGIN STYLES ===== */
.adminLoginContainer {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 2rem;
}

.loginHeader {
  text-align: center;
  margin-bottom: 2rem;
  color: white;
}

.logo {
  font-size: 2.5rem;
  font-weight: bold;
  margin-bottom: 0.5rem;
}

.subtitle {
  font-size: 1rem;
  opacity: 0.8;
  margin-bottom: 0.5rem;
}

.welcome {
  font-size: 1.5rem;
  font-weight: 600;
}

.loginForm {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  width: 100%;
  max-width: 400px;
}

.inputGroup {
  margin-bottom: 1.5rem;
}

.inputGroup label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: #333;
}

.inputGroup input {
  width: 100%;
  padding: 0.75rem;
  border: 2px solid #e1e5e9;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.3s;
}

.inputGroup input:focus {
  outline: none;
  border-color: #667eea;
}

.loginButton {
  width: 100%;
  padding: 0.75rem;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s;
  margin-bottom: 1rem;
}

.loginButton:hover:not(:disabled) {
  background: #5a6fd8;
}

.loginButton:disabled {
  background: #ccc;
  cursor: not-allowed;
}

/* Google Button */
.googleButton {
  width: 100%;
  padding: 0.75rem;
  background: white;
  color: #333;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  transition: all 0.3s;
}

.googleButton:hover:not(:disabled) {
  background: #f8f9fa;
  border-color: #ccc;
}

.googleButton:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

/* Divider */
.divider {
  display: flex;
  align-items: center;
  margin: 1.5rem 0;
  color: #666;
}

.divider::before,
.divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: #ddd;
}

.divider span {
  padding: 0 1rem;
  font-size: 0.9rem;
}

/* ===== DASHBOARD STYLES ===== */
.dashboard {
  padding: 2rem;
  max-width: 1200px;
  margin: 0 auto;
  min-height: 100vh;
  background: #f8f9fa;
}

.dashboardHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid #e9ecef;
}

.dashboardTitle {
  font-size: 1.8rem;
  color: #0070f3;
  margin: 0;
}

.adminInfo {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.adminInfo span {
  color: #666;
  font-weight: 500;
}

.logoutButton {
  padding: 0.5rem 1.5rem;
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  transition: background 0.3s;
}

.logoutButton:hover {
  background: #c82333;
}

/* ===== CHARTS SECTION ===== */
.chartsSection {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.chartsSection h3 {
  margin: 0 0 0.5rem 0;
  color: #333;
  font-size: 1.25rem;
}

.sectionSubtitle {
  color: #666;
  margin-bottom: 1.5rem;
  font-size: 0.9rem;
}

.chartsHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.dateControls {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.dateControls input {
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 0.9rem;
}

.dateControls button {
  padding: 0.5rem 1rem;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
}

.dateControls button:hover {
  background: #5a6fd8;
}

.chartsGrid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 1.5rem;
  margin-top: 1rem;
}

.chartCard {
  background: #f8f9fa;
  padding: 1rem;
  border-radius: 8px;
  border-left: 4px solid #667eea;
}

.chartCard h4 {
  margin: 0 0 1rem 0;
  color: #333;
  font-size: 1rem;
}

.chartData {
  max-height: 300px;
  overflow-y: auto;
  padding-right: 0.5rem;
}

.chartBar {
  display: flex;
  align-items: center;
  margin-bottom: 0.5rem;
  gap: 0.5rem;
}

.barLabel {
  min-width: 60px;
  font-size: 0.85rem;
  color: #666;
}

.barValue {
  background: #667eea;
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  transition: width 0.3s;
  min-width: 40px;
  text-align: center;
  font-weight: 500;
  font-size: 0.85rem;
}

.chartStats {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid #ddd;
  text-align: right;
  font-weight: 500;
  color: #333;
  font-size: 0.9rem;
}

/* ===== EXTERNAL MODULES ===== */
.externalModulesSection {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  margin: 2rem 0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.externalModulesSection h3 {
  margin: 0 0 0.5rem 0;
  color: #333;
  font-size: 1.25rem;
}

.modulesGrid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1rem;
}

.moduleButton {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  padding: 1.25rem;
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 10px;
  cursor: pointer;
  text-align: left;
  width: 100%;
  transition: all 0.3s ease;
  border: none;
}

.moduleButton:hover {
  background: #e9ecef;
  border-color: #0070f3;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 112, 243, 0.1);
}

.moduleIcon {
  font-size: 2rem;
  margin-top: 0.25rem;
}

.moduleContent {
  flex: 1;
}

.moduleContent h4 {
  margin: 0 0 0.5rem 0;
  color: #333;
  font-size: 1.1rem;
  font-weight: 600;
}

.moduleContent p {
  margin: 0 0 0.75rem 0;
  color: #666;
  font-size: 0.875rem;
  line-height: 1.4;
}

.moduleMeta {
  display: flex;
  gap: 1rem;
  font-size: 0.8rem;
}

.moduleStatus {
  background: #d4edda;
  color: #155724;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-weight: 500;
}

.moduleTeam {
  color: #6c757d;
}

.moduleArrow {
  color: #0070f3;
  font-size: 1.5rem;
  align-self: center;
  opacity: 0.7;
  transition: all 0.3s;
}

.moduleButton:hover .moduleArrow {
  opacity: 1;
  transform: translateX(5px);
}

/* ===== LOADING STATES ===== */
.loading {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 200px;
  font-size: 1.2rem;
  color: #666;
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 768px) {
  .dashboard {
    padding: 1rem;
  }
  
  .dashboardHeader {
    flex-direction: column;
    gap: 1rem;
    text-align: center;
  }
  
  .chartsGrid {
    grid-template-columns: 1fr;
  }
  
  .modulesGrid {
    grid-template-columns: 1fr;
  }
  
  .chartsHeader {
    flex-direction: column;
    gap: 1rem;
    align-items: flex-start;
  }
  
  .dateControls {
    width: 100%;
    justify-content: space-between;
  }
  
  .adminLoginContainer {
    padding: 1rem;
  }
  
  .loginForm {
    padding: 1.5rem;
  }
}


/* Sección de métricas */
.metricsSection {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.sectionHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid #f0f0f0;
}

.sectionHeader h2 {
  margin: 0;
  color: #333;
  font-size: 1.5rem;
}

.headerActions {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.lastUpdated {
  font-size: 0.85rem;
  color: #666;
  background: #f8f9fa;
  padding: 0.4rem 0.8rem;
  border-radius: 20px;
}

.refreshButton {
  padding: 0.4rem 1rem;
  background: #0070f3;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: background 0.3s;
}

.refreshButton:hover:not(:disabled) {
  background: #0056cc;
}

.refreshButton:disabled {
  background: #ccc;
  cursor: not-allowed;
}

/* Tarjeta de métrica principal */
.metricsGrid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.metricCard {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 1.5rem;
  border-radius: 12px;
  text-align: center;
}

.metricCard h3 {
  margin: 0 0 1rem 0;
  font-size: 1rem;
  font-weight: 500;
  opacity: 0.9;
}

.metricValue {
  font-size: 3rem;
  font-weight: bold;
  margin-bottom: 0.5rem;
}

.loadingText {
  font-size: 1.5rem;
  font-weight: normal;
  opacity: 0.8;
}

.metricDescription {
  font-size: 0.9rem;
  opacity: 0.8;
}

/* Distribución por rol */
.distributionSection {
  margin-top: 2rem;
}

.distributionSection h3 {
  margin: 0 0 1.5rem 0;
  color: #333;
  font-size: 1.25rem;
}

.distributionGrid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.roleCard {
  background: white;
  padding: 1.25rem;
  border-radius: 10px;
  border: 2px solid #e9ecef;
  transition: all 0.3s ease;
}

.roleCard:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.requesterCard {
  border-top: 4px solid #0070f3;
}

.fixerCard {
  border-top: 4px solid #28a745;
}

.visitorCard {
  border-top: 4px solid #ffc107;
}

.adminCard {
  border-top: 4px solid #dc3545;
}

.roleHeader {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.roleIcon {
  font-size: 1.5rem;
}

.roleName {
  font-weight: 600;
  color: #333;
  font-size: 1rem;
}

.roleCount {
  font-size: 2rem;
  font-weight: bold;
  color: #333;
  margin-bottom: 0.5rem;
}

.rolePercentage {
  font-size: 0.9rem;
  font-weight: 600;
  color: #666;
  background: #f8f9fa;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  display: inline-block;
}

/* Nota informativa mejorada */
.infoNote {
  display: flex;
  gap: 1rem;
  padding: 1rem;
  background: #e7f3ff;
  border: 1px solid #b3d7ff;
  border-radius: 8px;
  margin-top: 1.5rem;
}

.infoIcon {
  font-size: 1.2rem;
  color: #0070f3;
  flex-shrink: 0;
}

.infoContent p {
  margin: 0 0 0.25rem 0;
  color: #0066cc;
  font-size: 0.9rem;
}

.infoContent small {
  color: #666;
  font-size: 0.8rem;
}

/* Responsive */
@media (max-width: 768px) {
  .sectionHeader {
    flex-direction: column;
    gap: 1rem;
    text-align: center;
  }
  
  .headerActions {
    flex-direction: column;
    width: 100%;
  }
  
  .distributionGrid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .metricsGrid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px) {
  .distributionGrid {
    grid-template-columns: 1fr;
  }
  
  .metricValue {
    font-size: 2.5rem;
  }
}
</file>

<file path="src/app/[locale]/view-rate-jobs/page.tsx">
'use client';

import { useEffect, useRef, useState, useCallback } from 'react';
import { createPortal } from 'react-dom';
import { Roboto } from 'next/font/google';
import type { RatedJob } from './utils';
import { apiFetch } from '../../../config/api'; // corrige la ruta según tu estructura
import Link from 'next/link';
import { useAppSelector } from '@/app/redux/hooks';

const roboto = Roboto({
  subsets: ['latin'],
  weight: ['400', '500', '700'],
  display: 'swap',
});

function StarRating({
  value,
  size = 38,
  srLabel,
}: {
  value: 0 | 1 | 2 | 3;
  size?: number;
  srLabel?: string;
}) {
  return (
    <div className='inline-flex gap-1' aria-label={srLabel ?? `${value} de 3 estrellas`}>
      {Array.from({ length: 3 }).map((_, i) => {
        const filled = i < value;
        return (
          <svg
            key={i}
            width={size}
            height={size}
            viewBox='0 0 24 24'
            role='img'
            aria-hidden='true'
            className={filled ? 'drop-shadow-sm' : 'opacity-60'}
          >
            <path
              d='M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'
              style={
                filled
                  ? { fill: '#facc15' } // yellow
                  : { fill: 'transparent', stroke: '#cbd5e1', strokeWidth: 1.5 }
              }
            />
          </svg>
        );
      })}
    </div>
  );
}

function GenericDropdown({
  label,
  options,
  align = 'right',
  disabled = false,
  onSelect,
  selectedKey,
}: {
  label: string;
  options: { key: string; label: string }[];
  align?: 'right' | 'left';
  disabled?: boolean;
  onSelect?: (key: string) => void;
  selectedKey?: string;
}) {
  const [open, setOpen] = useState(false);
  const [coords, setCoords] = useState<{ left: number; top: number; width: number } | null>(null);
  const btnRef = useRef<HTMLButtonElement | null>(null);

  const displayLabel = label;

  function updateCoords() {
    if (!btnRef.current) return;
    const rect = btnRef.current.getBoundingClientRect();
    setCoords({
      left: rect.left + window.scrollX,
      top: rect.bottom + window.scrollY,
      width: rect.width,
    });
  }

  useEffect(() => {
    if (!open) return;
    updateCoords();

    function onDocClick(e: MouseEvent) {
      if (btnRef.current && !btnRef.current.contains(e.target as Node)) {
        setOpen(false);
      }
    }
    function onKey(e: KeyboardEvent) {
      if (e.key === 'Escape') setOpen(false);
    }

    window.addEventListener('resize', updateCoords);
    window.addEventListener('scroll', updateCoords, true);
    document.addEventListener('click', onDocClick);
    document.addEventListener('keydown', onKey);

    return () => {
      window.removeEventListener('resize', updateCoords);
      window.removeEventListener('scroll', updateCoords, true);
      document.removeEventListener('click', onDocClick);
      document.removeEventListener('keydown', onKey);
    };
  }, [open]);

  function toggle() {
    if (disabled) return; // prevent opening when disabled
    if (!btnRef.current) return setOpen((v) => !v);
    const rect = btnRef.current.getBoundingClientRect();
    setCoords({
      left: rect.left + window.scrollX,
      top: rect.bottom + window.scrollY,
      width: rect.width,
    });
    setOpen((v) => !v);
  }

  return (
    <>
      <div className='inline-block'>
        <button
          ref={btnRef}
          type='button'
          onClick={toggle}
          disabled={disabled}
          className={`px-3 py-2 rounded-lg border shadow-sm text-sm flex items-center gap-2 border-gray-200 ${disabled ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white'} `}
          aria-haspopup='menu'
          aria-expanded={open}
          aria-disabled={disabled}
        >
          {displayLabel}
          {disabled && <span className='sr-only'>(deshabilitado)</span>}
          <svg
            className='w-3 h-3 ml-1 text-blue-600'
            viewBox='0 0 10 6'
            fill='currentColor'
            xmlns='http://www.w3.org/2000/svg'
            aria-hidden
          >
            <path d='M1 1l4 4 4-4' />
          </svg>
        </button>
      </div>

      {open &&
        coords &&
        typeof document !== 'undefined' &&
        createPortal(
          <div
            role='menu'
            style={{
              position: 'absolute',
              left: align === 'right' ? coords.left : coords.left,
              top: coords.top,
              width: coords.width,
              zIndex: 99999,
            }}
            className='rounded-xl border bg-white opacity-100 shadow-lg border-gray-200 text-gray-800 pointer-events-auto'
          >
            {options.map((opt) => (
              <button
                key={opt.key}
                onClick={() => {
                  setOpen(false);
                  onSelect?.(opt.key);
                }}
                className={`w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${
                  opt.key === selectedKey ? 'bg-blue-50 text-blue-600 font-medium' : 'text-gray-800'
                }`}
              >
                {opt.label}
              </button>
            ))}
          </div>,
          document.body,
        )}
    </>
  );
}

function RatedJobsList({ jobs, userId }: { jobs: RatedJob[]; userId?: string }) {
  return (
    <section className='space-y-6 relative w-full'>
      <div className='relative max-h-[65vh] overflow-y-auto pr-1'>
        {jobs.length === 0 ? (
          <div className='flex items-center justify-center min-h-[220px]'>
            <p className='text-sm text-gray-500'>No hay trabajos calificados aún</p>
          </div>
        ) : (
          <ul className='flex flex-col gap-4'>
            {jobs.map((job) => (
              <li
                key={job.id}
                className='
    flex items-center justify-between gap-4 p-4 rounded-xl border bg-white 
    border-gray-200 w-full shadow-[0_6px_8px_rgba(0,0,0,0.06)]
    transition-all duration-200 transform
    hover:-translate-y-1 hover:shadow-[0_12px_16px_rgba(0,0,0,0.15)]
  '
              >
                <div className='min-w-0'>
                  <p className='font-medium truncate text-gray-800'>{job.title}</p>
                  <p className='text-xs text-gray-500'>
                    Date: {new Date(job.dateISO).toLocaleDateString()}
                  </p>
                </div>

                <StarRating value={job.rating ?? 0} />
              </li>
            ))}
          </ul>
        )}
      </div>

      <div className='w-full flex justify-end mt-4'>
        <Link
          href={userId ? `/fixers/${userId}/comments` : '#'}
          className={`px-5 py-2 rounded-lg text-white text-sm font-medium shadow transition ${
            userId
              ? 'bg-blue-600 hover:bg-blue-700 cursor-pointer'
              : 'bg-gray-400 cursor-not-allowed'
          }`}
        >
          Ir a los comentarios
        </Link>
      </div>
    </section>
  );
}

export default function RatedJobsPage() {
  const { user } = useAppSelector((state) => state.user);
  const userId = user?._id || user?.id;

  const [jobs, setJobs] = useState<RatedJob[]>([]);
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState<boolean>(false);
  const [slowLoading, setSlowLoading] = useState<boolean>(false);
  const [currentSort, setCurrentSort] = useState<string>('recent');

  const fetchJobs = useCallback(
    async (sortParam: string) => {
      if (!userId) {
        setError('Usuario no autenticado');
        return;
      }

      const slowTimer: ReturnType<typeof setTimeout> = setTimeout(() => {
        setSlowLoading(true);
      }, 2000);

      setLoading(true);
      setError(null);

      try {
        const result = await apiFetch<{ data?: RatedJob[] }>(
          `api/rated-jobs/user/${userId}?sortBy=${sortParam}`,
        );
        setJobs(result.data ?? []);
      } catch (err) {
        console.warn('Error fetching jobs:', err);
        setError('Sin conexión. Intenta de nuevo más tarde');
      } finally {
        setLoading(false);
        clearTimeout(slowTimer);
        setSlowLoading(false);
      }
    },
    [userId],
  );

  useEffect(() => {
    if (userId) {
      fetchJobs('recent');
    }
  }, [userId, fetchJobs]);

  const handleRatingSort = (key: string) => {
    setCurrentSort(key);
    fetchJobs(key);
  };

  const handleDateSort = (key: string) => {
    setCurrentSort(key);
    fetchJobs(key);
  };

  const disableDropdowns = !!error || (jobs.length === 0 && !loading);

  return (
    <main className={`min-h-screen bg-white text-gray-700 ${roboto.className}`}>
      <div className='max-w-3xl mx-auto p-6 space-y-6'>
        <header className='flex flex-col items-center w-full'>
          <h1 className='text-2xl font-semibold tracking-tight text-center'>
            Lista de trabajos calificados
          </h1>
          <div className='mt-3 flex items-center gap-4 w-full justify-end'>
            <div className='flex items-center mr-2 min-h-[32px]'>
              {loading && (
                <div className='flex items-center gap-2'>
                  <svg
                    className='animate-spin h-5 w-5 text-blue-600'
                    viewBox='0 0 24 24'
                    aria-hidden
                  >
                    <circle
                      cx='12'
                      cy='12'
                      r='10'
                      strokeWidth='4'
                      stroke='#3b82f6'
                      strokeOpacity='0.25'
                      fill='none'
                    />
                    <path
                      d='M22 12a10 10 0 0 1-10 10'
                      strokeWidth='4'
                      stroke='#3b82f6'
                      strokeLinecap='round'
                      fill='none'
                    />
                  </svg>
                  <span className='text-sm text-gray-500'>Procesando...</span>
                </div>
              )}
              {slowLoading && !error && (
                <div className='flex items-center gap-2'>
                  <svg
                    className='animate-spin h-5 w-5 text-yellow-500'
                    viewBox='0 0 24 24'
                    aria-hidden
                  >
                    <circle
                      cx='12'
                      cy='12'
                      r='10'
                      strokeWidth='4'
                      stroke='#eab308'
                      strokeOpacity='0.25'
                      fill='none'
                    />
                    <path
                      d='M22 12a10 10 0 0 1-10 10'
                      strokeWidth='4'
                      stroke='#eab308'
                      strokeLinecap='round'
                      fill='none'
                    />
                  </svg>
                  <span className='text-sm text-gray-500'>Cargando trabajos calificados...</span>
                </div>
              )}
              {error && (
                <p className='text-sm text-red-600'>Sin conexión. Intenta de nuevo más tarde</p>
              )}
            </div>

            <GenericDropdown
              label='Ordenar por calificación'
              disabled={disableDropdowns}
              onSelect={handleRatingSort}
              selectedKey={
                ['rating_asc', 'rating_desc'].includes(currentSort) ? currentSort : undefined
              }
              options={[
                { key: 'rating_desc', label: 'Descendente' },
                { key: 'rating_asc', label: 'Ascendente' },
              ]}
            />

            <GenericDropdown
              label='Ordenar por fecha'
              disabled={disableDropdowns}
              onSelect={handleDateSort}
              selectedKey={['recent', 'oldest'].includes(currentSort) ? currentSort : undefined}
              options={[
                { key: 'recent', label: 'Mas reciente' },
                { key: 'oldest', label: 'Mas antiguo' },
              ]}
            />
          </div>
        </header>

        <RatedJobsList jobs={jobs} userId={userId} />
      </div>
    </main>
  );
}
</file>

<file path="src/app/[locale]/view-rate-jobs/utils.ts">
export type RatedJob = {
  id: string;
  title: string;
  dateISO: string;
  rating: 0 | 1 | 2 | 3 | null;
};
</file>

<file path="src/app/components/fixers/ActivateOfferModal.tsx">
'use client';
import React, { useState } from 'react';

interface Props {
  open: boolean;
  isActive: boolean;
  offerId: string;
  onConfirm: (newStatus: boolean, offerId: string) => void;
  onClose: () => void;
}

export default function ActivateOfferModal({ open, isActive, offerId, onConfirm, onClose }: Props) {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  if (!open) return null;

  const nextStatus = !isActive;

  const handleClick = async () => {
    setLoading(true);
    setError(null);

    try {
      const resp = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/offers/${offerId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ state: nextStatus ? 'active' : 'inactive' }),
      });

      const data = await resp.json();

      if (!resp.ok) {
        setError(data.error || 'Error desconocido');
        setLoading(false);
        return;
      }

      onConfirm(nextStatus, offerId);
      setLoading(false);
    } catch (err) {
      console.error(err);
      setError('No se pudo conectar con el servidor.');
      setLoading(false);
    }
  };

  return (
    <div className='fixed inset-0 flex items-center justify-center bg-black/40 z-50'>
      <div className='bg-white rounded-xl p-6 shadow-lg w-80'>
        <h2 className='text-black font-semibold mb-4'>
          {nextStatus ? 'Activar oferta' : 'Desactivar oferta'}
        </h2>

        <p className='text-gray-800 mb-4'>
          ¿Estás seguro de que quieres {nextStatus ? 'activar' : 'desactivar'} esta oferta?
        </p>

        {error && <div className='mb-4 text-sm text-red-700 bg-red-100 p-2 rounded'>{error}</div>}

        <div className='flex justify-end gap-3'>
          <button
            className='px-4 py-2 rounded-lg bg-black hover:bg-gray-300'
            onClick={onClose}
            disabled={loading}
          >
            Cancelar
          </button>

          <button
            className={`px-4 py-2 rounded-lg text-white ${
              nextStatus ? 'bg-blue-600 hover:bg-blue-700' : 'bg-red-600 hover:bg-red-700'
            }`}
            onClick={handleClick}
            disabled={loading}
          >
            {loading ? 'Procesando...' : nextStatus ? 'Activar' : 'Desactivar'}
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/app/components/fixers/AppointmentCard.tsx">
'use client';
import React from 'react';
import { Appointment } from '@/services/appointments';

interface AppointmentCardProps {
  appointment: Appointment;
  onCreateJob: () => void;
}

type TimeInput = { $date: string } | string;

export default function AppointmentCard({ appointment, onCreateJob }: AppointmentCardProps) {
  const handleCreateJob = () => {
    onCreateJob();
  };

  return (
    <div className='border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow bg-white'>
      <div className='flex justify-between items-start'>
        <div className='flex-1'>
          <h3 className='font-semibold text-gray-900 text-lg'>
            {appointment.current_requester_name}
          </h3>
          <p className='text-gray-600 mt-1'>{appointment.appointment_description}</p>
          <div className='mt-2 text-sm text-gray-500'>
            <p>📅 {formatDate(appointment.starting_time)}</p>
            <p>
              🕒 {formatTime(appointment.starting_time)} - {formatTime(appointment.finishing_time)}
            </p>
            <p>📍 {appointment.display_name_location || 'Ubicación no especificada'}</p>
            <p>📞 {appointment.current_requester_phone}</p>
            <div className='mt-1'>
              <span
                className={`inline-block px-2 py-1 rounded text-xs ${
                  appointment.schedule_state === 'booked'
                    ? 'bg-green-100 text-green-800'
                    : 'bg-gray-100 text-gray-800'
                }`}
              >
                {appointment.schedule_state}
              </span>
              <span
                className={`ml-2 inline-block px-2 py-1 rounded text-xs ${
                  appointment.appointment_type === 'virtual'
                    ? 'bg-purple-100 text-purple-800'
                    : 'bg-blue-100 text-blue-800'
                }`}
              >
                {appointment.appointment_type === 'virtual' ? 'Virtual' : 'Presencial'}
              </span>
            </div>
            {appointment.appointment_type === 'virtual' && appointment.link_id && (
              <p className='mt-1'>
                🔗{' '}
                <a
                  href={appointment.link_id}
                  target='_blank'
                  rel='noopener noreferrer'
                  className='text-blue-600 hover:underline'
                >
                  Link de reunión
                </a>
              </p>
            )}
          </div>
        </div>

        <div className='flex flex-col gap-2 ml-4'>
          <button
            onClick={handleCreateJob}
            className='px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium'
          >
            Create Job
          </button>
        </div>
      </div>
    </div>
  );
}

function formatDate(timeInput: TimeInput): string {
  const dateString = typeof timeInput === 'object' ? timeInput?.$date : timeInput;

  if (!dateString) return 'Fecha no disponible';

  try {
    const date = new Date(dateString);
    if (Number.isNaN(date.getTime())) return 'Fecha inválida';

    return date.toLocaleDateString('es-ES', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  } catch {
    return 'Fecha no disponible';
  }
}

function formatTime(timeInput: TimeInput): string {
  const dateString = typeof timeInput === 'object' ? timeInput?.$date : timeInput;

  if (!dateString) return 'Hora no disponible';

  try {
    const date = new Date(dateString);
    if (Number.isNaN(date.getTime())) return 'Hora inválida';

    return date.toLocaleTimeString('es-ES', {
      hour: '2-digit',
      minute: '2-digit',
    });
  } catch {
    return 'Hora no disponible';
  }
}
</file>

<file path="src/app/components/fixers/AppointmentsList.tsx">
'use client';
import React, { useState } from 'react';
import { Appointment } from '@/services/appointments';
import AppointmentCard from './AppointmentCard';
import JobRequestModal from '../../[locale]/job-request/ModalFormMap/JobRequestModal';

export default function AppointmentsList({ appointments }: { appointments: Appointment[] }) {
  const [isJobModalOpen, setIsJobModalOpen] = useState<boolean>(false);
  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null);

  if (!appointments || appointments.length === 0) {
    return (
      <div className='rounded-xl border border-dashed border-gray-300 p-8 text-center text-gray-500'>
        No appointments yet.
      </div>
    );
  }

  return (
    <div className='space-y-3'>
      <JobRequestModal
        isOpen={isJobModalOpen}
        onClose={() => {
          setIsJobModalOpen(false);
          setSelectedAppointment(null);
        }}
        onSubmit={() => {
          setIsJobModalOpen(false);
          setSelectedAppointment(null);
        }}
        fixerId={selectedAppointment?.id_fixer || ''}
        appointmentData={selectedAppointment || undefined}
      />

      {appointments.map((appointment) => (
        <AppointmentCard
          key={appointment._id}
          appointment={appointment}
          onCreateJob={() => {
            setSelectedAppointment(appointment);
            setIsJobModalOpen(true);
          }}
        />
      ))}
    </div>
  );
}
</file>

<file path="src/app/components/fixers/CreatePromoModal.tsx">
import { useState, useEffect } from 'react';
import Modal from '@/app/[locale]/profile/[id]/modal-window';
import { CreatePromotion } from '@/types/promotion';

interface CreatePromoModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (data: CreatePromotion) => Promise<void>;
  id: string;
  fixerId: string;
  initialTitle?: string;
  initialDescription?: string;
  isEditMode?: boolean;
}

const CreatePromoModal = ({
  isOpen,
  onClose,
  onSave,
  id,
  fixerId,
  initialTitle = '',
  initialDescription = '',
  isEditMode = false,
}: CreatePromoModalProps) => {
  const [title, setTitle] = useState<string>(initialTitle);
  const [description, setDescription] = useState<string>(initialDescription);
  const [errors, setErrors] = useState<{ title?: string; description?: string }>({});
  const [isSubmitting, setIsSubmitting] = useState(false);

  useEffect(() => {
    if (isOpen) {
      setTitle(initialTitle);
      setDescription(initialDescription);
      setErrors({});
    }
  }, [isOpen, initialTitle, initialDescription]);

  const validateForm = (): boolean => {
    const newErrors: { title?: string; description?: string } = {};

    if (!title.trim()) {
      newErrors.title = 'Title cannot be empty';
    } else if (title.length > 30) {
      newErrors.title = 'Title cannot exceed 30 characters';
    }

    if (!description.trim()) {
      newErrors.description = 'Description cannot be empty';
    } else if (description.length > 100) {
      newErrors.description = 'Description cannot exceed 100 characters';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSave = async () => {
    if (!validateForm()) {
      return;
    }

    setIsSubmitting(true);
    try {
      await onSave({ title, description, offerId: id, fixerId, price: '0' });
      setTitle('');
      setDescription('');
      setErrors({});
      onClose();
    } catch (error) {
      console.error('Error creating promotion:', error);
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleClose = () => {
    setTitle('');
    setDescription('');
    setErrors({});
    onClose();
  };

  const handleTitleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setTitle(value);
    if (errors.title) {
      setErrors({ ...errors, title: undefined });
    }
  };

  const handleDescriptionChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    const value = e.target.value;
    setDescription(value);
    if (errors.description) {
      setErrors({ ...errors, description: undefined });
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={handleClose}>
      <div className='flex flex-col gap-6 relative bg-white p-12 rounded-4xl shadow-lg'>
        <button
          className='absolute top-8 right-8 text-gray-600 hover:text-gray-800 cursor-pointer'
          onClick={handleClose}
        >
          x
        </button>

        <div className='flex flex-col gap-4 w-[500px] max-w-full'>
          <div className='flex flex-col gap-2'>
            <div className='flex justify-between items-center'>
              <label htmlFor='promo-title' className='font-bold text-sm text-gray-800'>
                Promo title:
              </label>
              <span className={`text-xs ${title.length > 30 ? 'text-red-500' : 'text-gray-500'}`}>
                {title.length}/30
              </span>
            </div>
            <input
              id='promo-title'
              type='text'
              value={title}
              autoComplete='off'
              onChange={handleTitleChange}
              className={`border text-black border-gray-300 rounded-xl p-3 focus:outline-none focus:ring-2 ${
                errors.title ? 'border-red-500 focus:ring-red-500' : 'focus:ring-blue-500'
              }`}
              maxLength={31}
            />
            {errors.title && <span className='text-xs text-red-500'>{errors.title}</span>}
          </div>

          <div className='flex flex-col gap-2'>
            <div className='flex justify-between items-center'>
              <label htmlFor='promo-description' className='font-bold text-sm text-gray-800'>
                Promo description:
              </label>
              <span
                className={`text-xs ${description.length > 100 ? 'text-red-500' : 'text-gray-500'}`}
              >
                {description.length}/100
              </span>
            </div>
            <textarea
              id='promo-description'
              value={description}
              autoComplete='off'
              onChange={handleDescriptionChange}
              className={`border text-black border-gray-300 rounded-xl p-3 h-32 resize-none focus:outline-none focus:ring-2 ${
                errors.description ? 'border-red-500 focus:ring-red-500' : 'focus:ring-blue-500'
              }`}
              maxLength={101}
            />
            {errors.description && (
              <span className='text-xs text-red-500'>{errors.description}</span>
            )}
          </div>
        </div>

        <button
          className='bg-blue-600 hover:bg-blue-700 p-3 text-white rounded-lg font-medium transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed'
          onClick={handleSave}
          disabled={isSubmitting}
        >
          {isSubmitting ? 'Saving...' : isEditMode ? 'Update promo' : 'Save promo'}
        </button>
      </div>
    </Modal>
  );
};

export default CreatePromoModal;
</file>

<file path="src/app/components/fixers/DetailsModal.tsx">
import { getJobForFixerInfo } from '@/services/job-info';
import { ModalComponent } from '@/shared/ui/ModalComponent';
import { JobDetails } from '@/types/job';
import { useEffect, useState } from 'react';

interface ReviewModalProps {
  isOpen: boolean;
  onClose: () => void;
  onAccept: () => void;
  dataId: string;
  fixerId: string;
}

export const DetailsModal = ({ isOpen, onClose, onAccept, dataId, fixerId }: ReviewModalProps) => {
  const [data, setData] = useState<JobDetails | null>(null);

  useEffect(() => {
    if (!dataId || !fixerId) return;

    const fetchJobDetails = async () => {
      try {
        const response = await getJobForFixerInfo(dataId, fixerId);
        setData({
          title: response.title,
          date: response.createdAt ? new Date(response.createdAt).toLocaleDateString() : '',
          rating: response.rating,
          description: response.description,
          serviceType: response.type ?? '',
          comment: response.comment,
        });
      } catch (error) {
        console.error('Error fetching job details:', error);
      }
    };
    fetchJobDetails();
  }, [dataId, fixerId]);

  return (
    <ModalComponent isOpen={isOpen} onClose={onClose} Accept={onAccept}>
      <div className='flex flex-col gap-4 w-[500px] max-w-[90%] text-left bg-white rounded-xl p-6'>
        <div className='flex justify-between items-start'>
          <div>
            <h2 className='text-lg font-semibold text-gray-800'>{data?.title}</h2>
            <p className='text-sm text-gray-400'>Date: {data?.date}</p>
          </div>
          <div className='flex gap-1'>
            {Array.from({ length: 3 }).map((_, i) => (
              <span
                key={i}
                className={`${i < (data?.rating ?? 0) ? 'text-yellow-400' : 'text-gray-300'} text-xl`}
              >
                ★
              </span>
            ))}
          </div>
        </div>

        <div className='text-sm text-gray-700 leading-relaxed'>
          <p className='font-semibold mb-1'>Descripción</p>
          <p>{data?.description}</p>
        </div>

        <div className='text-sm text-gray-700'>
          <p className='font-semibold mb-1'>Tipo de servicio:</p>
          <p>{data?.serviceType}</p>
        </div>

        <div className='text-sm text-gray-700'>
          <p className='font-semibold mb-1'>Comentario:</p>
          <p>{data?.comment}</p>
        </div>
      </div>
    </ModalComponent>
  );
};
</file>

<file path="src/app/components/fixers/JobsList.tsx">
'use client';

import React from 'react';
import { useRouter } from 'next/navigation';
import { Job } from '@/types/job';
import RequestedJob from './RequestedJob';
import RegisterJobModal from './RegisterJobModal';
import CreatePromoModal from './CreatePromoModal';
import { useState } from 'react';
import { createPromotion } from '@/services/promotions';

export default function JobsList({ jobs }: { jobs: Job[] }) {
  const router = useRouter();
  const [isRegisterModalOpen, setIsRegisterModalOpen] = useState<boolean>(false);
  const [isCreatePromoModalOpen, setIsCreatePromoModalOpen] = useState<boolean>(false);
  const [idJob, setIdJob] = useState<string>('');
  const [fixerId, setFixerId] = useState<string>('');

  const onSavePromo = async (promotion: {
    title: string;
    description: string;
    offerId: string;
    fixerId: string;
    price: string;
  }) => {
    const result = await createPromotion({
      title: promotion.title,
      description: promotion.description,
      offerId: promotion.offerId,
      price: promotion.price,
      fixerId: promotion.fixerId,
    });

    if (result) {
      // Refresh the job list to show updated data
      router.refresh();
    }
  };

  if (!jobs || jobs.length === 0) {
    return (
      <div className='rounded-xl border border-dashed border-gray-300 p-8 text-center text-gray-500'>
        No appointments yet.
      </div>
    );
  }
  return (
    <div className='space-y-3'>
      <RegisterJobModal
        isOpen={isRegisterModalOpen}
        onClose={() => setIsRegisterModalOpen(false)}
        id={idJob}
      />
      <CreatePromoModal
        isOpen={isCreatePromoModalOpen}
        onClose={() => setIsCreatePromoModalOpen(false)}
        onSave={onSavePromo}
        id={idJob}
        fixerId={fixerId}
      />

      {jobs.map((job) => (
        <RequestedJob
          key={job._id}
          name={job.requesterId || 'Requester'}
          jobTitle={job.title}
          schedule={formatSchedule(job.createdAt)}
          state={job.status}
          onAppointmentDetails={() => router.push(`/requested-jobs/${job._id}`)}
          onRegisterJob={() => {
            setIsRegisterModalOpen(true);
            setIdJob(job._id);
          }}
          onViewPromos={() => {
            router.push(`/promotions/${job._id}`);
          }}
          onCreatePromo={() => {
            setIsCreatePromoModalOpen(true);
            setIdJob(job._id);
            setFixerId(job.fixerId);
          }}
        />
      ))}
    </div>
  );
}

function formatSchedule(createdAt: string) {
  const d = new Date(createdAt);
  if (Number.isNaN(d.getTime())) return '';
  const time = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  return `${d.toLocaleDateString()} ${time}`;
}
</file>

<file path="src/app/components/fixers/RegisterJobModal.tsx">
import Modal from '../../[locale]/profile/[id]/modal-window';
import { useRegisterJob } from '../hooks/useRegisterJob';
import { useState, useEffect } from 'react';

type RegisterJobModalProps = {
  isOpen: boolean;
  onClose: () => void;
  id: string;
};

const kilometers = 3;
const distance = 3.53 * kilometers;
const center = -0.0792 * kilometers ** 3 + 0.8576 * kilometers ** 2 - 4.0616 * kilometers + 7.2885;

export default function RegisterJobModal({ isOpen, onClose, id }: RegisterJobModalProps) {
  const { data } = useRegisterJob(id);
  const [userLocation, setUserLocation] = useState<{ lat: number; lng: number } | null>(null);
  const [locationError, setLocationError] = useState<string | null>(null);
  const [isSaving, setIsSaving] = useState(false);

  useEffect(() => {
    if (isOpen && 'geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          setUserLocation({
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          });
          setLocationError(null);
        },
        (error) => {
          console.error('Error getting location:', error);
          setLocationError(error.message);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0,
        },
      );
    } else if (isOpen) {
      setLocationError('Geolocation is not supported by your browser');
    }
  }, [isOpen]);

  const handleSave = async () => {
    if (!userLocation) {
      alert('Cannot save: User location not available');
      return;
    }

    setIsSaving(true);
  };
  return (
    <Modal isOpen={isOpen} onClose={onClose}>
      <div className='w-[40rem] h-[30rem] bg-white py-4 border-2 rounded-2xl border-gray-900 text-black'>
        <div className='overflow-y-auto h-[27rem] font-sans px-8'>
          <h2 className='text-2xl font-bold text-center mb-4'>Registration</h2>

          <div className='mb-4'>
            <p className='text-sm font-semibold mb-1'>Detail:</p>
            <p className='text-sm'>{`Title: ${data?.title}`}</p>
          </div>

          <div className='mb-4'>
            <p className='text-sm font-semibold mb-1'>Description:</p>
            <p className='text-sm'>{data?.description}</p>
          </div>

          <div className='mb-4'>
            <p className='text-sm font-semibold'>
              Date: <span className='font-normal'>{data?.createdAt}</span>
            </p>
          </div>

          <div className='mb-4'>
            <p className='text-sm font-semibold mb-2'>Location:</p>
            <div className='w-full h-48 bg-blue-50 rounded-2xl border-2 border-gray-900 overflow-hidden relative flex justify-center'>
              <div
                style={{
                  width: `${distance}rem`,
                  height: `${distance}rem`,
                  transform: `translateY(${center}rem)`,
                }}
                className='absolute border border-black rounded-full bg-transparent flex justify-center items-center pointer-events-none z-10'
              ></div>
              <iframe
                src={`https://www.google.com/maps?q=${data?.UbicacionOriginal === 'DESCONOCIDO' ? data.UbicacionOriginal : '-17.389889414299798, -66.22317583795535'}&z=13&output=embed`}
                width='100%'
                height='100%'
                style={{ border: 0, pointerEvents: 'auto' }}
                loading='lazy'
                referrerPolicy='no-referrer-when-downgrade'
                allowFullScreen
              ></iframe>
            </div>
          </div>

          <div className='mb-4'>
            <p className='text-sm font-semibold'>{`Estado: ${data?.status}`}</p>
          </div>
          {locationError && (
            <div className='mb-4'>
              <p className='text-sm font-semibold text-red-600'>{`Location Error: ${locationError}`}</p>
            </div>
          )}

          <div className='flex justify-end gap-3'>
            <button
              onClick={onClose}
              className='px-5 py-2 text-sm font-medium bg-white border border-gray-900 rounded-md hover:bg-gray-50 transition-colors'
            >
              Cerrar
            </button>
            <button
              onClick={handleSave}
              disabled={!userLocation || isSaving}
              className='px-5 py-2 text-sm font-medium bg-black text-white border border-gray-900 rounded-md hover:bg-gray-800 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed'
            >
              {isSaving ? 'Saving...' : 'Guardar'}
            </button>
          </div>
        </div>
      </div>
    </Modal>
  );
}
</file>

<file path="src/app/components/fixers/RequestedJob.tsx">
'use client';

import React, { useEffect, useRef, useState } from 'react';

export default function RequestedJob({
  name = '',
  jobTitle = '',
  schedule = '',
  state = '',
  onAppointmentDetails,
  onRegisterJob,
  onViewPromos,
  onCreatePromo,
  className = '',
}: {
  name: string;
  jobTitle: string;
  schedule: string;
  state: string;
  onAppointmentDetails?: () => void;
  onRegisterJob?: () => void;
  onViewPromos?: () => void;
  onCreatePromo?: () => void;
  className?: string;
}) {
  const [open, setOpen] = useState(false);
  const menuRef = useRef<HTMLDivElement | null>(null);

  useEffect(() => {
    function handleClickOutside(e: MouseEvent) {
      if (menuRef.current && !menuRef.current.contains(e.target as Node)) {
        setOpen(false);
      }
    }
    function handleEsc(e: KeyboardEvent) {
      if (e.key === 'Escape') setOpen(false);
    }

    document.addEventListener('mousedown', handleClickOutside);
    document.addEventListener('keydown', handleEsc);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
      document.removeEventListener('keydown', handleEsc);
    };
  }, []);

  const normalized = String(state || '').toLowerCase();
  const badge = getStateBadgeClasses(normalized);

  const handleAppointment = () => {
    onAppointmentDetails?.();
    setOpen(false);
  };

  const handleRegister = () => {
    onRegisterJob?.();
    setOpen(false);
  };

  const handleViewPromos = () => {
    onViewPromos?.();
    setOpen(false);
  };
  const handleCreatePromo = () => {
    onCreatePromo?.();
    setOpen(false);
  };

  return (
    <div
      className={`w-full bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-shadow px-4 py-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4 ${className}`}
    >
      <div className='flex-1 min-w-0'>
        <div className='inline-flex items-center max-w-full'>
          <span className='truncate inline-flex items-center px-2.5 py-0.5 rounded-lg border border-gray-300 text-gray-700 text-sm font-medium'>
            {name}
          </span>
        </div>
        <div className='mt-1 flex items-center gap-2 text-gray-700 min-w-0'>
          <span className='font-medium truncate'>{jobTitle}</span>
          <span className='text-gray-400' aria-hidden>
            •
          </span>
          <span className='text-sm text-gray-500 whitespace-nowrap shrink-0'>{schedule}</span>
        </div>
      </div>
      <div
        className='flex items-center gap-3 shrink-0 w-full sm:w-auto justify-between sm:justify-end'
        ref={menuRef}
      >
        <div className='flex items-center gap-2 text-gray-500'>
          <span className='text-sm'>State</span>
          <span
            className={`text-xs font-medium px-2.5 py-1 rounded-full border ${badge} w-28 sm:w-32 truncate whitespace-nowrap text-center`}
          >
            {capitalizeFirst(normalized || 'unknown')}
          </span>
        </div>

        <div className='relative'>
          <button
            type='button'
            aria-haspopup='menu'
            aria-expanded={open}
            onClick={() => setOpen((v) => !v)}
            className='inline-flex h-8 w-8 items-center justify-center rounded-md border border-gray-200 bg-white text-gray-600 hover:bg-gray-50 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500'
          >
            <span className='sr-only'>Open menu</span>
            <KebabIcon />
          </button>

          {open && (
            <div
              role='menu'
              className='absolute right-0 mt-2 w-48 origin-top-right rounded-lg border border-gray-200 bg-white shadow-lg focus:outline-none z-20'
            >
              <button
                role='menuitem'
                onClick={handleAppointment}
                className='w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50'
              >
                Appointment details
              </button>
              <div className='h-px bg-gray-100' />
              <button
                role='menuitem'
                onClick={handleRegister}
                className='w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50'
              >
                Register job
              </button>
              <div className='h-px bg-gray-100' />
              <button
                role='menuitem'
                onClick={handleViewPromos}
                className='w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50'
              >
                View promos
              </button>
              <div className='h-px bg-gray-100' />
              <button
                role='menuitem'
                onClick={handleCreatePromo}
                className='w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50'
              >
                Create promo
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

function capitalizeFirst(s: string) {
  if (!s) return s;
  return s.charAt(0).toUpperCase() + s.slice(1);
}

function getStateBadgeClasses(state: string) {
  switch (state) {
    case 'accepted':
      return 'bg-emerald-50 text-emerald-700 border-emerald-200';
    case 'pending':
      return 'bg-amber-50 text-amber-700 border-amber-200';
    case 'rejected':
      return 'bg-rose-50 text-rose-700 border-rose-200';
    case 'completed':
      return 'bg-blue-50 text-blue-700 border-blue-200';
    default:
      return 'bg-gray-50 text-gray-700 border-gray-200';
  }
}

function KebabIcon(props: React.SVGProps<SVGSVGElement>) {
  return (
    <svg
      width='16'
      height='16'
      viewBox='0 0 24 24'
      fill='none'
      xmlns='http://www.w3.org/2000/svg'
      aria-hidden
      {...props}
    >
      <path
        d='M12 6a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm0 7.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm0 7.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z'
        className='fill-current'
      />
    </svg>
  );
}
</file>

<file path="src/app/components/hooks/useComments.ts">
import { apiUrl } from '@/config/api';
import { useState, useEffect } from 'react';

type Comment = {
  _id: string;
  title: string;
  createdAt: string;
  rating: number;
  comment: string;
  requesterName: string;
};

type FilterType = 'all' | 'positive' | 'negative';

export const useComments = (fixerId: string, filter: FilterType = 'all') => {
  const [data, setData] = useState<Comment[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchComments = async () => {
      setLoading(true);
      setError(null);

      try {
        let endpoint = `api/comments/${fixerId}`;

        if (filter === 'positive') {
          endpoint = `api/comments/${fixerId}/positive`;
        } else if (filter === 'negative') {
          endpoint = `api/comments/${fixerId}/negative`;
        }

        const url = apiUrl(endpoint);
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        if (!response.ok) {
          throw new Error(`Error: ${response.status}`);
        }

        const result = await response.json();
        setData(result);
      } catch (err) {
        console.error('Error fetching comments:', err);
        setError(err instanceof Error ? err.message : 'Unknown error');
      } finally {
        setLoading(false);
      }
    };

    fetchComments();
  }, [fixerId, filter]);

  return { data, loading, error };
};
</file>

<file path="src/app/components/hooks/useRegisterJob.ts">
import { apiUrl } from '@/config/api';
import { useState, useEffect } from 'react';

type Job = {
  _id: string;
  title: string;
  description: string;
  createdAt: string;
  Ubicacion: string;
  UbicacionOriginal: string;
  status: string;
};
export const useRegisterJob = (jobId: string) => {
  const [data, setData] = useState<Job | null>(null);
  useEffect(() => {
    const fetchJobData = async (id: string) => {
      try {
        const url = apiUrl(`api/job-info/${id}`);
        console.log('url', url);
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        });
        const data = await response.json();
        setData({ ...data, createdAt: data.createdAt.split('T')[0] });
        return data;
      } catch (err) {
        console.error('Error fetching job data:', err);
      }
    };
    fetchJobData(jobId);
  }, [jobId]);

  return { data };
};
</file>

<file path="src/app/components/RateJobButton.jsx">
'use client';
import { useState } from 'react';
import RateJobModal from './RateJobModal';

export default function RateJobButton() {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <>
      <button
        onClick={() => setIsOpen(true)}
        className='bg-[#2BDDE0] hover:bg-[#5E2BE0] text-white font-medium py-2 px-4 rounded-md transition'
      >
        Rate Job
      </button>

      <RateJobModal isOpen={isOpen} onClose={() => setIsOpen(false)} />
    </>
  );
}
</file>

<file path="src/app/components/RateJobModal.jsx">
'use client';
import { useState } from 'react';

export default function RateJobModal({ isOpen, onClose }) {
  // -----------------------------
  // 🔹 Estados para estrellas y comentario
  // -----------------------------
  const [selectedStars, setSelectedStars] = useState(0);
  const [comment, setComment] = useState('');

  // -----------------------------
  // 🔹 1. Función que limpia los datos del formulario
  // -----------------------------
  const resetForm = () => {
    setSelectedStars(0); // Reinicia estrellas
    setComment(''); // Limpia el comentario
  };

  // -----------------------------
  // 🔹 2. Función para cerrar y limpiar
  // -----------------------------
  const handleClose = () => {
    if (selectedStars > 0 || comment.trim() !== '') {
      const confirmClose = window.confirm(
        'No has enviado tu review. ¿Seguro que quieres cerrar? Los datos se perderán.',
      );
      if (!confirmClose) return;
    }

    resetForm();
    onClose();
  };

  // -----------------------------
  // 🔹 3. Función de envío (Submit)
  // -----------------------------
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (comment.length < 10) return;

    console.log('💬 Review enviada:', {
      estrellas: selectedStars,
      comentario: comment,
    });

    resetForm(); // Limpia datos después de enviar
    onClose(); // Cierra el modal
  };

  // -----------------------------
  // 🔹 4. Si el modal no está abierto, no renderizar
  // -----------------------------
  if (!isOpen) return null;

  // -----------------------------
  // 🔹 5. Estructura visual del modal
  // -----------------------------
  return (
    <div className='fixed inset-0 bg-black/40 flex justify-center items-center z-50'>
      <div className='bg-white rounded-2xl shadow-lg p-6 w-96'>
        <h2 className='text-xl font-bold text-[#2B31E0] mb-4'>Rate Job</h2>

        {/* ⭐ Sección de estrellas */}
        <div className='flex justify-center mb-4'>
          {[1, 2, 3].map((num) => (
            <span
              key={num}
              onClick={() => setSelectedStars(num)}
              className={`cursor-pointer text-4xl mx-1 ${
                num <= selectedStars ? 'text-yellow-400' : 'text-gray-300'
              }`}
            >
              ★
            </span>
          ))}
        </div>

        {/* Etiquetas */}
        <div className='flex justify-between text-sm text-gray-500 mb-4'>
          <span>Terrible</span>
          <span>Excelente</span>
        </div>

        {/* 📝 Campo de comentario */}
        <textarea
          className='w-full border rounded-md p-2 mb-3 text-gray-700'
          placeholder='Escribe tu comentario (mínimo 10 caracteres)'
          value={comment}
          onChange={(e) => setComment(e.target.value)}
        ></textarea>

        {/* 🔘 Botones */}
        <div className='flex justify-end space-x-2'>
          {/* Botón Cancelar */}
          <button
            onClick={handleClose}
            className='px-3 py-2 rounded-md bg-gray-200 hover:bg-gray-300 text-gray-700'
          >
            Cancelar
          </button>

          {/* Botón Enviar */}
          <button
            onClick={handleSubmit}
            disabled={comment.length < 10}
            className={`px-4 py-2 rounded-md text-white font-medium transition ${
              comment.length < 10
                ? 'bg-gray-400 cursor-not-allowed'
                : 'bg-[#2B31E0] hover:bg-[#2B6AE0]'
            }`}
          >
            Submit Review
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/app/fonts.ts">
import { Roboto } from 'next/font/google';

export const roboto = Roboto({
  weight: ['300', '400', '500', '700'],
  subsets: ['latin'],
  display: 'swap',
  variable: '--font-roboto',
});
</file>

<file path="src/app/globals.css">
@import 'tailwindcss';

@custom-variant dark (&:is(.dark *));

:root {
  --background: oklch(0.99 0 0);
  --foreground: oklch(0.145 0 0);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.145 0 0);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.145 0 0);
  /* Updated primary colors to blue tones */
  --primary: oklch(0.55 0.18 250);
  --primary-foreground: oklch(0.99 0 0);
  --secondary: oklch(0.95 0.02 250);
  --secondary-foreground: oklch(0.145 0 0);
  --muted: oklch(0.96 0.01 250);
  --muted-foreground: oklch(0.5 0.02 250);
  --accent: oklch(0.92 0.03 250);
  --accent-foreground: oklch(0.145 0 0);
  --destructive: oklch(0.577 0.245 27.325);
  --destructive-foreground: oklch(0.99 0 0);
  --border: oklch(0.92 0.01 250);
  --input: oklch(0.92 0.01 250);
  --ring: oklch(0.55 0.18 250);
  --chart-1: oklch(0.55 0.18 250);
  --chart-2: oklch(0.6 0.15 220);
  --chart-3: oklch(0.65 0.12 200);
  --chart-4: oklch(0.5 0.2 270);
  --chart-5: oklch(0.45 0.22 240);
  --radius: 0.75rem;
  --sidebar: oklch(0.985 0 0);
  --sidebar-foreground: oklch(0.145 0 0);
  --sidebar-primary: oklch(0.55 0.18 250);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.95 0.02 250);
  --sidebar-accent-foreground: oklch(0.145 0 0);
  --sidebar-border: oklch(0.92 0.01 250);
  --sidebar-ring: oklch(0.55 0.18 250);
}

.dark {
  --background: oklch(0.145 0 0);
  --foreground: oklch(0.985 0 0);
  --card: oklch(0.18 0 0);
  --card-foreground: oklch(0.985 0 0);
  --popover: oklch(0.18 0 0);
  --popover-foreground: oklch(0.985 0 0);

  --primary: oklch(0.65 0.18 250);
  --primary-foreground: oklch(0.99 0 0);
  --secondary: oklch(0.25 0.02 250);
  --secondary-foreground: oklch(0.985 0 0);
  --muted: oklch(0.25 0.02 250);
  --muted-foreground: oklch(0.65 0.05 250);
  --accent: oklch(0.28 0.03 250);
  --accent-foreground: oklch(0.985 0 0);
  --destructive: oklch(0.5 0.2 27.325);
  --destructive-foreground: oklch(0.99 0 0);
  --border: oklch(0.25 0.02 250);
  --input: oklch(0.25 0.02 250);
  --ring: oklch(0.65 0.18 250);
  --chart-1: oklch(0.65 0.18 250);
  --chart-2: oklch(0.7 0.15 220);
  --chart-3: oklch(0.75 0.12 200);
  --chart-4: oklch(0.6 0.2 270);
  --chart-5: oklch(0.55 0.22 240);
  --sidebar: oklch(0.18 0 0);
  --sidebar-foreground: oklch(0.985 0 0);
  --sidebar-primary: oklch(0.65 0.18 250);
  --sidebar-primary-foreground: oklch(0.99 0 0);
  --sidebar-accent: oklch(0.25 0.02 250);
  --sidebar-accent-foreground: oklch(0.985 0 0);
  --sidebar-border: oklch(0.25 0.02 250);
  --sidebar-ring: oklch(0.65 0.18 250);
}

@theme inline {
  --font-sans: var(--font-roboto), 'Roboto', system-ui, -apple-system, sans-serif;
  --font-mono: 'Geist Mono', 'Geist Mono Fallback';
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --color-card: var(--card);
  --color-card-foreground: var(--card-foreground);
  --color-popover: var(--popover);
  --color-popover-foreground: var(--popover-foreground);

  --color-primary: #2b6ae0;
  --color-primary-foreground: var(--primary-foreground);
  --color-secondary: var(--secondary);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-muted: var(--muted);
  --color-muted-foreground: var(--muted-foreground);
  --color-accent: var(--accent);
  --color-accent-foreground: var(--accent-foreground);
  --color-destructive: var(--destructive);
  --color-destructive-foreground: var(--destructive-foreground);
  --color-border: var(--border);
  --color-input: var(--input);
  --color-ring: var(--ring);
  --color-chart-1: var(--chart-1);
  --color-chart-2: var(--chart-2);
  --color-chart-3: var(--chart-3);
  --color-chart-4: var(--chart-4);
  --color-chart-5: var(--chart-5);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --color-sidebar: var(--sidebar);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-ring: var(--sidebar-ring);
}

/* Map Styles */
.map-tiles {
  filter: saturate(1.05) contrast(1.05) brightness(1.02);
}

/* Map Marker Styles */
.custom-offer-marker {
  filter: drop-shadow(0 4px 6px rgba(59, 130, 246, 0.1));
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.custom-offer-marker:hover {
  filter: drop-shadow(0 8px 12px rgba(59, 130, 246, 0.15));
  transform: translateY(-4px);
}

/* Animation Keyframes */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fadeInUp {
  animation: fadeInUp 0.5s ease-out forwards;
}

.custom-user-marker {
  filter: drop-shadow(0 0 15px rgba(59, 130, 246, 0.7));
}

/* Leaflet Popup Styles */
.leaflet-popup-content-wrapper {
  background: rgba(15, 23, 42, 0.95);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 12px;
  box-shadow:
    0 0 30px rgba(59, 130, 246, 0.3),
    0 0 60px rgba(96, 165, 250, 0.2);
  color: white;
}

.leaflet-popup-tip {
  background: rgba(15, 23, 42, 0.95);
  border: 1px solid rgba(59, 130, 246, 0.3);
}

.leaflet-popup-content {
  margin: 0;
  color: white;
}

/* Animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes pulse {
  0%,
  100% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.05);
    opacity: 0.8;
  }
}

@keyframes float {
  0%,
  100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-10px);
  }
}

.animate-fadeInUp {
  animation: fadeInUp 0.5s ease-out forwards;
}

.animate-slideInLeft {
  animation: slideInLeft 0.5s ease-out forwards;
}

.animate-pulse {
  animation: pulse 2s infinite;
}

.animate-float {
  animation: float 3s ease-in-out infinite;
}

/* Glass Effect */
.glass {
  background: rgba(15, 23, 42, 0.6);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(59, 130, 246, 0.3);
}

/* animación */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* contenedor pequeño del menú (scoped) */
.profileMenu {
  position: fixed;
  top: 70px;
  right: 20px;
  background: #fff;
  color: #000;
  border-radius: 12px;
  box-shadow: 0 2px 18px rgba(0, 0, 0, 0.15);
  width: 280px;
  padding: 12px;
  display: none;
  flex-direction: column;
  gap: 8px;
  z-index: 9999; /* alto para que aparezca encima */
  max-height: calc(100vh - 120px);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
  touch-action: pan-y;
}

/* cuando está abierto lo mostramos */
.show {
  display: flex;
  animation: fadeIn 0.18s ease;
}

/* header del menú */
.menuHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* botón de cerrar */
.closeBtn {
  cursor: pointer;
  font-size: 18px;
  font-weight: bold;
}

/* preview foto */
.profilePreview {
  width: 82px;
  height: 82px;
  border-radius: 50%;
  object-fit: cover;
  margin: 8px auto;
  border: 3px solid #fff;
  background: #f0f0f0;
}

/* items */
.menuItem {
  padding: 10px;
  border-radius: 8px;
  cursor: pointer;
  text-align: left;
  font-weight: 600;
  transition: all 0.15s ease;
  border: 1px solid #d0d4e6;
  background: #f8f9ff;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
}

.menuItem:hover {
  background: #2b6af0;
  color: #fff;
  border-color: #2b6af0;
  box-shadow: 0 2px 6px rgba(43, 106, 240, 0.25);
}

/* botones especiales */
.logoutBtn {
  /* aplicamos la misma base que .menuItem, pero lo distinguimos */
}

/* responsivo: si quieres mover posición en móvil */
@media (max-width: 480px) {
  .profileMenu {
    width: 94%;
    right: 3%;
    top: 88px;
  }
}

.shadow-neu-inner {
  box-shadow:
    8px 8px 16px rgba(0, 0, 0, 0.08),
    -8px -8px 16px rgba(255, 255, 255, 0.9);
}

.menuLabel {
  text-align: left;
  font-weight: 600;
}

/* ============================================
   CARRUSEL DE INSPIRACIÓN - INICIO
   ============================================ */

.carrusel-container {
  position: relative;
  width: 100%;
  height: 600px;
  overflow: hidden;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.carrusel-slide {
  opacity: 0;
  position: absolute;
  width: 100%;
  height: 100%;
  transition: opacity 1s ease-in-out;
}

.carrusel-slide.active {
  opacity: 1;
}

.carrusel-image {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.carrusel-skeleton {
  position: absolute;
  inset: 0;
  background: linear-gradient(
    90deg,
    rgba(255, 255, 255, 0.06) 25%,
    rgba(255, 255, 255, 0.12) 50%,
    rgba(255, 255, 255, 0.06) 75%
  );
  background-size: 200% 100%;
  animation: carrusel-shimmer 1.6s infinite;
  z-index: 1;
}

@keyframes carrusel-shimmer {
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0;
  }
}

.carrusel-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.7) 100%);
  z-index: 2;
}

.carrusel-content {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  z-index: 3;
  color: white;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: flex-start;
  width: 100%;
  height: 100%;
  padding: 40px 40px;
}

.carrusel-category {
  background-color: var(--color-primary);
  color: white;
  padding: 8px 20px;
  border-radius: 25px;
  font-size: 0.9rem;
  font-weight: 600;
  display: inline-block;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  align-self: flex-start;
  margin-bottom: auto;
}

.carrusel-text-group {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-top: auto;
  padding-bottom: 50px;
}

.carrusel-title {
  font-size: 3rem;
  font-weight: 800;
  margin: 0 0 15px 0;
  line-height: 1.1;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}

.carrusel-subtitle {
  font-size: 1.3rem;
  font-weight: 400;
  margin: 0;
  opacity: 0.9;
  line-height: 1.4;
}

.carrusel-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background-color: rgba(255, 255, 255, 0.9);
  border: none;
  padding: 12px;
  cursor: pointer;
  z-index: 4;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-size: 18px;
  font-weight: bold;
  color: #333;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.carrusel-arrow:hover {
  background-color: rgba(255, 255, 255, 1);
  transform: translateY(-50%) scale(1.1);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.carrusel-arrow-left {
  left: 30px;
}

.carrusel-arrow-right {
  right: 30px;
}

.carrusel-dots {
  position: absolute;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 12px;
  z-index: 4;
}

.carrusel-dot {
  width: 14px;
  height: 14px;
  background-color: rgba(255, 255, 255, 0.4);
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.carrusel-dot:hover {
  background-color: rgba(255, 255, 255, 0.7);
  transform: scale(1.2);
}

.carrusel-dot.active {
  background-color: white;
  border-color: rgba(255, 255, 255, 0.8);
  transform: scale(1.3);
}

/* Responsive Design */
@media (max-width: 1024px) {
  .carrusel-content {
    padding: 30px 30px;
  }

  .carrusel-title {
    font-size: 2.5rem;
  }

  .carrusel-text-group {
    padding-bottom: 45px;
  }
}

@media (max-width: 768px) {
  .carrusel-container {
    height: 500px;
    border-radius: 8px;
  }

  .carrusel-content {
    padding: 20px 20px;
  }

  .carrusel-text-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding-bottom: 40px;
  }

  .carrusel-title {
    font-size: 1.8rem;
    margin: 0;
    line-height: 1.2;
  }

  .carrusel-subtitle {
    font-size: 1rem;
    margin: 0;
  }

  .carrusel-category {
    font-size: 0.75rem;
    padding: 5px 12px;
    margin-bottom: 0;
  }

  .carrusel-arrow {
    width: 45px;
    height: 45px;
    font-size: 16px;
  }

  .carrusel-arrow-left {
    left: 20px;
  }

  .carrusel-arrow-right {
    right: 20px;
  }

  .carrusel-dot {
    width: 12px;
    height: 12px;
  }
}

@media (max-width: 480px) {
  .carrusel-container {
    height: 400px;
    border-radius: 6px;
  }

  .carrusel-content {
    padding: 15px 15px;
  }

  .carrusel-text-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    width: 100%;
    padding-bottom: 35px;
  }

  .carrusel-title {
    font-size: 1.3rem;
    line-height: 1.2;
    margin: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .carrusel-subtitle {
    font-size: 0.85rem;
    margin: 0;
  }

  .carrusel-category {
    font-size: 0.65rem;
    padding: 4px 10px;
    margin-bottom: 0;
    flex-shrink: 0;
  }

  .carrusel-arrow {
    width: 40px;
    height: 40px;
    font-size: 14px;
  }

  .carrusel-arrow-left {
    left: 8px;
  }

  .carrusel-arrow-right {
    right: 8px;
  }

  .carrusel-dots {
    bottom: 10px;
    gap: 6px;
  }

  .carrusel-dot {
    width: 9px;
    height: 9px;
  }
}

/* ============================================
   CARRUSEL DE INSPIRACIÓN - FIN
   ============================================ */

/* Footer*/
.footerLink {
  position: relative;
  display: inline-block;
  color: white;
  font-weight: 500;
  text-decoration: none;
  padding: 4px 6px;
  border-radius: 4px;
  transition:
    color 0.3s ease,
    transform 0.3s ease;
}

.footerLink::after {
  content: '';
  position: absolute;
  left: 0;
  bottom: -3px;
  width: 100%;
  height: 2px;
  background-color: #1aa7ed;
  transform: scaleX(0);
  transform-origin: center;
  transition: transform 0.3s ease;
  border-radius: 2px;
}

.footerLink:hover {
  color: #a3d9ff;
  transform: scale(1.06);
}

.footerLink:hover::after {
  transform: scaleX(1);
}

.footerLink:focus-visible {
  outline: 2px solid #1aa7ed;
  outline-offset: 3px;
}

.footerTitle {
  position: relative;
  display: inline-block;
  padding-bottom: 10px;
  color: #1aa7ed;
}

.footerTitle::after {
  content: '';
  position: absolute;
  left: 0;
  bottom: 0;
  width: 95%;
  height: 3px;
  background-color: #1aa7ed;
  border-radius: 2px;
}

/* ============================================
   ESTILOS PARA REACTOUR (GUÍA INTERACTIVA)
   ============================================ */

/* 1. Suavizar movimiento y reducir opacidad */
.reactour__mask {
  transition: all 0.4s ease-out !important;
  opacity: 0.3 !important;
}

.reactour__helper {
  transition: all 0.4s ease-out !important;
  box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3) !important;
}

/* 2. Estilizar los puntos de navegación (dots) */
div[data-tour-elem='controls'] button[data-tour-elem='dot'] {
  background-color: #e2e8f0 !important;
  border: none !important;
  width: 7px !important;
  height: 7px !important;
  margin: 0 3px !important;
  border-radius: 50% !important;
  transition: all 0.3s ease !important;
  box-shadow: none !important;
  padding: 0 !important;
  min-width: 7px !important;
  flex-shrink: 0 !important;
}

/* Estilo del punto activo */
div[data-tour-elem='controls'] button[data-tour-elem='dot'][data-active='true'] {
  background-color: #2b6ae0 !important;
  transform: scale(1.2);
}

/* 3. Centrar los puntos entre los botones CON ESPACIO */
div[data-tour-elem='navigation'] {
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  flex: 1 !important;
  margin: 0 12px !important; /* Más margen para separar de los botones */
  min-width: 0 !important; /* Permitir que se contraiga si es necesario */
}

/* 4. Mejorar el contenedor de controles */
div[data-tour-elem='controls'] {
  display: flex !important;
  align-items: center !important;
  justify-content: space-between !important;
  gap: 12px !important; /* Espacio entre elementos */
  width: 100% !important;
}

/* 5. Asegurar el popover encima de todo */
div[data-tour-elem='popover'] {
  z-index: 100000 !important;
  box-shadow:
    0 20px 25px -5px rgb(0 0 0 / 0.1),
    0 8px 10px -6px rgb(0 0 0 / 0.1) !important;
}

/* 6. Asegurar visibilidad del elemento destacado */
[data-tour-elem='badge'] {
  background-color: white !important;
  box-shadow: 0 0 0 4px rgba(43, 106, 224, 0.4) !important;
}

/* 7. Ajustar el contenido del popover */
div[data-tour-elem='popover'] > div:first-child {
  max-width: 100% !important;
  word-wrap: break-word !important;
}
</file>

<file path="src/app/lib/contact-utils.ts">
// Generate a WhatsApp message with context
export function generateWhatsAppMessage(
  fixerName: string,
  service?: string,
  customMessage?: string,
): string {
  if (customMessage) return customMessage;

  const base = `Hola ${fixerName}`;
  const serviceText = service
    ? `, vi tu oferta de ${service.toLowerCase()}`
    : ', encontré tu perfil';
  const ending = ' y me interesaría trabajar contigo.';

  return base + serviceText + ending;
}

// Format phone number for display
export function formatPhoneNumber(phone: string): string {
  const cleaned = phone.replace(/\D/g, '');
  if (cleaned.length === 0) return phone;

  // Bolivian format: +591 XXXX XXXX
  if (cleaned.startsWith('591')) {
    return `+${cleaned.slice(0, 3)} ${cleaned.slice(3, 7)} ${cleaned.slice(7)}`;
  }

  // Default format
  return phone;
}

// Validate phone number
export function isValidPhoneNumber(phone: string): boolean {
  const cleaned = phone.replace(/\D/g, '');
  return cleaned.length >= 8 && cleaned.length <= 15;
}

// Generate contact sharing URL
export function generateShareURL(baseURL: string, fixerName: string): string {
  const encodedName = encodeURIComponent(fixerName);
  return `${baseURL}?fixer=${encodedName}`;
}
</file>

<file path="src/app/lib/hooks/useDevices.tsx">
'use client';
import { useState, useEffect, useCallback } from 'react';

export interface Session {
  _id: string;
  deviceId: string;
  deviceName: string;
  deviceType: string;
  browser: string;
  ipAddress: string;
  isActive: boolean;
}

export function useDevices(userId?: string) {
  const [sessions, setSessions] = useState<Session[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [currentDeviceId, setCurrentDeviceId] = useState('');

  const fetchSessions = useCallback(async () => {
    if (!userId) return;
    try {
      setLoading(true);
      const res = await fetch(`http://localhost:8000/api/controlC/${userId}`);
      const data = await res.json();

      if (res.ok) {
        setSessions(data.devices || []);
        setCurrentDeviceId(data.currentDeviceId || '');
      } else {
        setError(data.message || 'Error al obtener las sesiones.');
      }
    } catch {
      setError('Error de conexión con el servidor.');
    } finally {
      setLoading(false);
    }
  }, [userId]);

  const closeAllOtherSessions = useCallback(async () => {
    if (!userId || !currentDeviceId) return { success: false, message: 'Datos insuficientes' };

    try {
      const res = await fetch(`http://localhost:8000/api/controlC/${userId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ currentDeviceId }),
      });

      const data = await res.json();
      if (res.ok) {
        setSessions((prev) => prev.filter((s) => s.deviceId === currentDeviceId));
        return {
          success: true,
          message: data.message || 'Sesiones cerradas correctamente',
        };
      } else {
        return {
          success: false,
          message: data.message || 'Error al cerrar sesiones',
        };
      }
    } catch {
      return { success: false, message: 'Error al conectar con el servidor' };
    }
  }, [userId, currentDeviceId]);

  useEffect(() => {
    if (userId) fetchSessions();
  }, [userId, fetchSessions]);

  return {
    sessions,
    loading,
    error,
    currentDeviceId,
    fetchSessions,
    closeAllOtherSessions,
  };
}
</file>

<file path="src/app/lib/hooks/usoAutentificacion.tsx">
'use client';

import { createContext, useContext, useState, useEffect } from 'react';
import { verificarSesionBackend, User } from '../../redux/services/services/registro';
import { useRouter } from 'next/navigation';
import { useAppDispatch } from '@/app/redux/hooks';
import { setUser as setReduxUser, logout as logoutRedux } from '@/app/redux/slice/userSlice';

interface AuthContextType {
  user: User | null;
  setUser: React.Dispatch<React.SetStateAction<User | null>>;
  logout: () => void;
  loading: boolean;
}

const AuthContext = createContext<AuthContextType | null>(null);

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const router = useRouter();
  const dispatch = useAppDispatch();

  useEffect(() => {
    try {
      const storedUser = localStorage.getItem('servineo_user');
      if (storedUser) {
        setUser(JSON.parse(storedUser));
      }
    } catch (e) {
      console.error('Error leyendo usuario:', e);
      localStorage.removeItem('servineo_user');
    }

    const token = localStorage.getItem('servineo_token');
    if (!token) {
      setLoading(false);
      return;
    }

    verificarSesionBackend(token)
      .then((data) => {
        if (data.valid && data.user) {
          setUser((prev) => {
            const newUser = { ...prev, ...data.user };
            localStorage.setItem('servineo_user', JSON.stringify(newUser));
            return newUser;
          });
        } else {
          localStorage.removeItem('servineo_token');
          localStorage.removeItem('servineo_user');
          setUser(null);
        }
      })
      .catch(() => {
        localStorage.removeItem('servineo_token');
        localStorage.removeItem('servineo_user');
        setUser(null);
      })
      .finally(() => setLoading(false));
  }, []);

  useEffect(() => {
    if (user) {
      // Ensure _id exists
      const userWithId = { ...user, _id: user.id };
      localStorage.setItem('servineo_user', JSON.stringify(userWithId));
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      dispatch(setReduxUser(userWithId as any)); // Sync with Redux
    }
  }, [user, dispatch]);

  const logout = () => {
    localStorage.removeItem('servineo_token');
    localStorage.removeItem('servineo_user');
    setUser(null);
    dispatch(logoutRedux());
    router.push('/');
  };

  return (
    <AuthContext.Provider value={{ user, setUser, logout, loading }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth(): AuthContextType {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth debe usarse dentro de un AuthProvider');
  }
  return context;
}
</file>

<file path="src/app/lib/job-description.ts">
// Predefined description templates by service type
export const descriptionTemplates: Record<string, string[]> = {
  Plomería: [
    'Reparación e instalación de sistemas de agua. Presupuesto sin compromiso.',
    'Especialista en plomería residencial y comercial. Trabajo garantizado.',
    'Instalación de tuberías, grifería y reparaciones de emergencia 24/7.',
  ],
  Electricidad: [
    'Instalaciones eléctricas seguras y certificadas. Trabajos residenciales y comerciales.',
    'Reparación de sistemas eléctricos y mantenimiento preventivo profesional.',
    'Especialista en instalaciones modernas, cableado y tableros eléctricos.',
  ],
  Carpintería: [
    'Fabricación de muebles a medida con materiales de calidad premium.',
    'Carpintería fina: puertas, ventanas, cocinas integrales y restauración.',
    'Diseño y construcción de muebles personalizados con acabados profesionales.',
  ],
  Pintura: [
    'Pintura interior y exterior con acabados de primera calidad.',
    'Preparación de superficies y pintura profesional con garantía.',
    'Especialista en pinturas decorativas, esmaltes y acabados especiales.',
  ],
  Albañilería: [
    'Construcción y remodelación de espacios. Trabajos de precisión y calidad.',
    'Levantamiento de muros, pisos y acabados en construcción residencial.',
    'Especialista en ampliaciones, remodelaciones y construcciones desde cero.',
  ],
  Jardinería: [
    'Diseño y mantenimiento de jardines con plantas de calidad.',
    'Poda, limpieza y paisajismo profesional para espacios exteriores.',
    'Especialista en jardines verticales, riego automático y plantas ornamentales.',
  ],
  Limpieza: [
    'Servicios de limpieza profesional para hogares y comercios.',
    'Limpieza profunda, sanitización y mantenimiento regular disponible.',
    'Especialista en limpieza de alfombras, tapizados y espacios comerciales.',
  ],
  'Reparación de electrodomésticos': [
    'Reparación experta de lavadoras, refrigeradores y otros electrodomésticos.',
    'Diagnóstico y reparación de electrodomésticos con repuestos originales.',
    'Servicio técnico profesional para todos los electrodomésticos con garantía.',
  ],
  'Instalación de pisos': [
    'Instalación profesional de cerámica, porcelánato y pisos flotantes.',
    'Especialista en colocación de pisos con materiales de importación.',
    'Instalación de pisos con preparación de superficie y acabados perfectos.',
  ],
  Techado: [
    'Reparación e instalación de techos con materiales resistentes.',
    'Especialista en impermeabilización y construcción de techos modernos.',
    'Techado seguro y resistente con garantía y mantenimiento preventivo.',
  ],
};

// Common phrases that work well in job descriptions
export const descriptionPhrases = {
  opening: [
    'Especialista en',
    'Profesional experto en',
    'Servicio de calidad en',
    'Experto certificado en',
  ],
  quality: [
    'Trabajos de primera calidad',
    'Acabados profesionales',
    'Garantía en nuestro trabajo',
    'Máxima calidad garantizada',
  ],
  availability: [
    'Disponibilidad inmediata',
    'Presupuesto sin compromiso',
    'Trabajo garantizado',
    'Disponible 24/7',
  ],
};

// Generate a suggestion based on selected services
export function generateDescriptionSuggestion(services: string[]): string {
  if (services.length === 0) return '';

  const mainService = services[0];
  const templates = descriptionTemplates[mainService] || [];

  if (templates.length === 0) return '';

  // Return a random template
  return templates[Math.floor(Math.random() * templates.length)];
}

// Check if description is professional enough
export function getDescriptionQuality(description: string): {
  score: number;
  feedback: string[];
} {
  const feedback: string[] = [];
  let score = 50; // Base score

  if (description.length < 20) {
    feedback.push('Muy corta. Agrega más detalles sobre tu trabajo.');
  } else if (description.length > 80) {
    score += 15;
  } else {
    score += 10;
  }

  const lowercaseDesc = description.toLowerCase();

  // Check for professionalism
  const professionalTerms = [
    'especialista',
    'profesional',
    'garantía',
    'calidad',
    'certificado',
    'experto',
  ];
  const hasProTerms = professionalTerms.filter((term) => lowercaseDesc.includes(term)).length;

  if (hasProTerms === 0) {
    feedback.push(
      "Agrega palabras como 'profesional', 'especialista' o 'garantía' para sonar más profesional.",
    );
  } else if (hasProTerms >= 2) {
    score += 20;
  } else {
    score += 10;
  }

  // Check for service/benefit mention
  if (lowercaseDesc.includes('trabajo') || lowercaseDesc.includes('servicio')) {
    score += 10;
  }

  // Check for availability/speed
  if (lowercaseDesc.includes('disponible') || lowercaseDesc.includes('rápido')) {
    score += 10;
  }

  // Cap score at 100
  score = Math.min(100, score);

  return { score, feedback };
}
</file>

<file path="src/app/lib/mock-data.ts">
export interface JobOffer {
  id: string;
  fixerId: string;
  fixerName: string;
  fixerPhoto?: string;
  title: string;
  description: string;
  tags: string[];
  whatsapp: string;
  photos: string[];
  services: string[];
  price: number;
  createdAt: Date;
  city: string;
  rating?: number;
  completedJobs?: number;
  location: {
    lat: number;
    lng: number;
    address: string;
  };
}

export interface Fixer {
  id: string;
  name: string;
  email?: string;
  phone: string;
  photo?: string;
  city: string;
  rating?: number;
  completedJobs: number;
  services: string[];
  bio?: string;
  joinDate: string;
  location?: {
    lat: number;
    lng: number;
    address?: string;
  } | null;
  jobOffers: JobOffer[];
  paymentMethods: string[];
  whatsapp?: string;
  cancelledJobs?: number;
  monthlyData?: { month: string; completados: number; cancelados: number }[];
}

export type JobOfferBackend = {
  _id?: string;
  id?: string;
  title: string;
  description: string;
  city: string;
  services: string[];
  photos: string[];
  price: number;
  fixerId: string;
  fixerName: string;
  whatsapp: string;
  location: {
    lat: number;
    lng: number;
    address: string;
  };
  createdAt: string;
  tags?: string[];
  fixerPhoto?: string;
  rating?: number;
  completedJobs?: number;
};

// Mock de ubicación del usuario
export const userLocation = {
  lat: -17.394,
  lng: -66.1474,
  address: 'UMSS, Cochabamba, Bolivia',
};

// Mock de servicios disponibles
export const availableServices = [
  'Plomería',
  'Electricidad',
  'Carpintería',
  'Pintura',
  'Albañilería',
  'Jardinería',
  'Limpieza',
  'Reparación de electrodomésticos',
  'Instalación de pisos',
  'Techado',
];

// Mock de FIXER actual (simulando usuario logueado)
export const currentFixer: Fixer = {
  id: 'fixer-001',
  name: 'Juan Carlos Pérez',
  email: 'juan.perez@example.com',
  phone: '59170341618',
  whatsapp: '59170341618',
  photo: '/img/avatars/fixer-001.jpg',
  city: 'Cochabamba',
  rating: 4.8,
  completedJobs: 124,
  services: ['Plomería', 'Electricidad', 'Carpintería'],
  bio: 'Soy un técnico con más de 5 años de experiencia en trabajos de electricidad y plomería. Me apasiona mi trabajo y siempre busco la satisfacción del cliente.',
  joinDate: '2022-01-15',
  jobOffers: [],
  paymentMethods: ['Efectivo', 'Transferencia', 'QR'],
};

// Mock de ofertas de trabajo
let _mockJobOffers: JobOffer[] = [
  {
    id: 'offer-001',
    fixerId: 'fixer-001',
    fixerName: 'Juan Carlos Pérez',
    fixerPhoto: '/img/avatars/fixer-001.jpg',
    title: 'Servicios de Plomería y Electricidad',
    description:
      'Especialista en reparaciones de plomería e instalaciones eléctricas. Soluciones rápidas y garantizadas.',
    tags: ['Plomería', 'Electricidad', 'Reparaciones'],
    whatsapp: '59170341618',
    photos: ['/img/carpinteria1.jpg', '/img/carpinteria2.jpg', '/img/carpinteria3.jpg'],
    services: ['Plomería', 'Electricidad'],
    price: 150,
    rating: 4.8,
    completedJobs: 124,
    createdAt: new Date('2025-01-15'),
    city: 'Cochabamba',
    location: {
      lat: -17.3935,
      lng: -66.1468,
      address: 'Av. Oquendo #234, Cochabamba',
    },
  },
  {
    id: 'offer-002',
    fixerId: 'fixer-001',
    fixerName: 'Juan Carlos Pérez',
    fixerPhoto: '/img/avatars/fixer-001.jpg',
    title: 'Servicios de Plomería y Electricidad',
    description:
      'Especialista en reparaciones de plomería e instalaciones eléctricas. Soluciones rápidas y garantizadas.',
    tags: ['Plomería', 'Electricidad', 'Reparaciones'],
    whatsapp: '59170341618',
    photos: ['/img/carpinteria1.jpg', '/img/carpinteria2.jpg', '/img/carpinteria3.jpg'],
    services: ['Plomería', 'Electricidad'],
    price: 150,
    rating: 4.8,
    completedJobs: 124,
    createdAt: new Date('2025-01-15'),
    city: 'Cochabamba',
    location: {
      lat: -17.3935,
      lng: -66.1468,
      address: 'Av. Oquendo #234, Cochabamba',
    },
  },
  {
    id: 'offer-003',
    fixerId: 'fixer-001',
    fixerName: 'Juan Carlos Pérez',
    fixerPhoto: '/img/avatars/fixer-001.jpg',
    title: 'Servicios de Plomería y Electricidad',
    description:
      'Especialista en reparaciones de plomería e instalaciones eléctricas. Soluciones rápidas y garantizadas.',
    tags: ['Plomería', 'Electricidad', 'Reparaciones'],
    whatsapp: '59170341618',
    photos: ['/img/carpinteria1.jpg', '/img/carpinteria2.jpg', '/img/carpinteria3.jpg'],
    services: ['Plomería', 'Electricidad'],
    price: 150,
    rating: 4.8,
    completedJobs: 124,
    createdAt: new Date('2025-01-15'),
    city: 'Cochabamba',
    location: {
      lat: -17.3935,
      lng: -66.1468,
      address: 'Av. Oquendo #234, Cochabamba',
    },
  },
  {
    id: 'offer-004',
    fixerId: 'fixer-001',
    fixerName: 'Juan Carlos Pérez',
    fixerPhoto: '/img/avatars/fixer-001.jpg',
    title: 'Servicios de Plomería y Electricidad',
    description:
      'Especialista en reparaciones de plomería e instalaciones eléctricas. Soluciones rápidas y garantizadas.',
    tags: ['Plomería', 'Electricidad', 'Reparaciones'],
    whatsapp: '59170341618',
    photos: ['/img/carpinteria1.jpg', '/img/carpinteria2.jpg', '/img/carpinteria3.jpg'],
    services: ['Plomería', 'Electricidad'],
    price: 150,
    rating: 4.8,
    completedJobs: 124,
    createdAt: new Date('2025-01-15'),
    city: 'Cochabamba',
    location: {
      lat: -17.3935,
      lng: -66.1468,
      address: 'Av. Oquendo #234, Cochabamba',
    },
  },
  {
    id: 'offer-005',
    fixerId: 'fixer-001',
    fixerName: 'Juan Carlos Pérez',
    fixerPhoto: '/img/avatars/fixer-001.jpg',
    title: 'Servicios de Plomería y Electricidad',
    description:
      'Especialista en reparaciones de plomería e instalaciones eléctricas. Soluciones rápidas y garantizadas.',
    tags: ['Plomería', 'Electricidad', 'Reparaciones'],
    whatsapp: '59170341618',
    photos: ['/img/carpinteria1.jpg', '/img/carpinteria2.jpg', '/img/carpinteria3.jpg'],
    services: ['Plomería', 'Electricidad'],
    price: 150,
    rating: 4.8,
    completedJobs: 124,
    createdAt: new Date('2025-01-15'),
    city: 'Cochabamba',
    location: {
      lat: -17.3935,
      lng: -66.1468,
      address: 'Av. Oquendo #234, Cochabamba',
    },
  },
  {
    id: 'offer-006',
    fixerId: 'fixer-001',
    fixerName: 'Juan Carlos Pérez',
    fixerPhoto: '/img/avatars/fixer-001.jpg',
    title: 'Servicios de Plomería y Electricidad',
    description:
      'Especialista en reparaciones de plomería e instalaciones eléctricas. Soluciones rápidas y garantizadas.',
    tags: ['Plomería', 'Electricidad', 'Reparaciones'],
    whatsapp: '59170341618',
    photos: ['/img/carpinteria1.jpg', '/img/carpinteria2.jpg', '/img/carpinteria3.jpg'],
    services: ['Plomería', 'Electricidad'],
    price: 150,
    rating: 4.8,
    completedJobs: 124,
    createdAt: new Date('2025-01-15'),
    city: 'Cochabamba',
    location: {
      lat: -17.3935,
      lng: -66.1468,
      address: 'Av. Oquendo #234, Cochabamba',
    },
  },
  {
    id: 'offer-007',
    fixerId: 'fixer-001',
    fixerName: 'Juan Carlos Pérez',
    fixerPhoto: '/img/avatars/fixer-001.jpg',
    title: 'Servicios de Plomería y Electricidad',
    description:
      'Especialista en reparaciones de plomería e instalaciones eléctricas. Soluciones rápidas y garantizadas.',
    tags: ['Plomería', 'Electricidad', 'Reparaciones'],
    whatsapp: '59170341618',
    photos: ['/img/carpinteria1.jpg', '/img/carpinteria2.jpg', '/img/carpinteria3.jpg'],
    services: ['Plomería', 'Electricidad'],
    price: 150,
    rating: 4.8,
    completedJobs: 124,
    createdAt: new Date('2025-01-15'),
    city: 'Cochabamba',
    location: {
      lat: -17.3935,
      lng: -66.1468,
      address: 'Av. Oquendo #234, Cochabamba',
    },
  },
  {
    id: 'offer-008',
    fixerId: 'fixer-001',
    fixerName: 'Juan Carlos Pérez',
    fixerPhoto: '/img/avatars/fixer-001.jpg',
    title: 'Servicios de Plomería y Electricidad',
    description:
      'Especialista en reparaciones de plomería e instalaciones eléctricas. Soluciones rápidas y garantizadas.',
    tags: ['Plomería', 'Electricidad', 'Reparaciones'],
    whatsapp: '59170341618',
    photos: ['/img/carpinteria1.jpg', '/img/carpinteria2.jpg', '/img/carpinteria3.jpg'],
    services: ['Plomería', 'Electricidad'],
    price: 150,
    rating: 4.8,
    completedJobs: 124,
    createdAt: new Date('2025-01-15'),
    city: 'Cochabamba',
    location: {
      lat: -17.3935,
      lng: -66.1468,
      address: 'Av. Oquendo #234, Cochabamba',
    },
  },
];

// Mock de fixers
export const mockFixers: Fixer[] = [
  {
    id: '68e87a9cdae3b73d8040102f',
    name: 'Juan Carlos Pérez',
    email: 'juan.perez@example.com',
    phone: '59170341618',
    whatsapp: '59170341618',
    photo: '/img/avatars/fixer-001.jpg',
    city: 'Cochabamba',
    rating: 4.8,
    completedJobs: 124,
    services: ['Plomería', 'Electricidad', 'Carpintería'],
    bio: 'Soy un técnico con más de 5 años de experiencia...',
    joinDate: '2022-01-15',
    paymentMethods: ['Efectivo', 'Transferencia', 'QR'],
    jobOffers: [
      {
        id: 'offer-001',
        fixerId: '68e87a9cdae3b73d8040102f',
        fixerName: 'Juan Carlos Pérez',
        fixerPhoto: '/img/avatars/fixer-001.jpg',
        title: 'Servicios de Plomería',
        description: 'Reparación de fugas y tuberías',
        price: 150,
        city: 'Cochabamba',
        photos: ['/img/plomeria1.jpg'],
        rating: 4.8,
        completedJobs: 124,
        tags: ['Plomería', 'Reparación', 'Urgente'],
        whatsapp: '59170341618',
        services: ['Plomería'],
        createdAt: new Date('2024-01-15'),
        location: {
          lat: -17.3935,
          lng: -66.1468,
          address: 'Cochabamba, Bolivia',
        },
      },
      {
        id: 'offer-002',
        fixerId: '68e87a9cdae3b73d8040102f',
        fixerName: 'Juan Carlos Pérez',
        fixerPhoto: '/img/avatars/fixer-001.jpg',
        title: 'Instalación Eléctrica',
        description: 'Instalación y reparación de circuitos eléctricos',
        price: 200,
        city: 'Cochabamba',
        photos: ['/img/electricidad1.jpg'],
        rating: 4.8,
        completedJobs: 124,
        tags: ['Electricidad', 'Instalación'],
        whatsapp: '59170341618',
        services: ['Electricidad'],
        createdAt: new Date('2024-01-10'),
        location: {
          lat: -17.3935,
          lng: -66.1468,
          address: 'Cochabamba, Bolivia',
        },
      },
    ],
  },
];

// Actualizar las ofertas de trabajo con datos de los fixers
_mockJobOffers = _mockJobOffers.map((offer) => {
  const fixer = mockFixers.find((f) => f.id === offer.fixerId);
  return {
    ...offer,
    fixerPhoto: fixer?.photo,
    rating: fixer?.rating,
    completedJobs: fixer?.completedJobs,
  };
});

// Funciones mock para manejar ofertas
export const mockJobOfferService = {
  getOffers: () => _mockJobOffers,

  addOffer: (offer: Omit<JobOffer, 'id' | 'createdAt'>) => {
    const newOffer: JobOffer = {
      ...offer,
      id: `offer-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      createdAt: new Date(),
    };
    _mockJobOffers = [newOffer, ..._mockJobOffers];
    return newOffer;
  },

  updateOffer: (offerId: string, updates: Partial<JobOffer>) => {
    _mockJobOffers = _mockJobOffers.map((o) => (o.id === offerId ? { ...o, ...updates } : o));
    return _mockJobOffers.find((o) => o.id === offerId);
  },

  deleteOffer: (offerId: string) => {
    _mockJobOffers = _mockJobOffers.filter((o) => o.id !== offerId);
  },

  getMyOffers: (fixerId: string) => {
    return _mockJobOffers.filter((o) => o.fixerId === fixerId);
  },
};

// Exportar también como mockJobOffers para compatibilidad
export const mockJobOffers = _mockJobOffers;
</file>

<file path="src/app/lib/service/fixer-service.ts">
const MOCK_TAKEN_CIS = new Set(['1234567', 'ABC-890', '9001002']);

export const fixerService = {
  checkCIAvailability: async (ci: string): Promise<boolean> => {
    // Simular llamada a API
    await new Promise((resolve) => setTimeout(resolve, 300));
    return !MOCK_TAKEN_CIS.has(ci.trim());
  },

  registerFixer: async (): Promise<{ success: boolean; fixerId?: string }> => {
    // Simular llamada a API
    await new Promise((resolve) => setTimeout(resolve, 900));
    return {
      success: true,
      fixerId: `fixer-${Date.now()}`,
    };
  },

  uploadProfilePhoto: async (file: File): Promise<string> => {
    await new Promise((resolve) => setTimeout(resolve, 500));
    return URL.createObjectURL(file);
  },

  uploadExperienceMedia: async (file: File): Promise<string> => {
    await new Promise((resolve) => setTimeout(resolve, 500));
    return URL.createObjectURL(file);
  },
};
</file>

<file path="src/app/lib/service/RegistrarDatosPersonalesconecionBackend.ts">
const BASE_URL = `${process.env.NEXT_PUBLIC_API_URL}/api/controlC`;

export interface User {
  email: string;
  name?: string;
  picture?: string;
}

export interface RegistroResponse {
  success: boolean;
  message?: string;
  token?: string;
  user?: User;
}

export interface UbicacionResponse {
  success: boolean;
  message?: string;
}

export async function enviarRegistroManual(
  name: string,
  email: string,
  password: string,
): Promise<RegistroResponse> {
  const url = `${BASE_URL}/registro/manual`;

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password }),
    });

    const contentType = res.headers.get('content-type');

    if (contentType?.includes('text/html')) {
      const textError = await res.text();
      throw new Error(
        `Error ${res.status}: La API no respondió con JSON. Respuesta: ${textError.slice(0, 120)}`,
      );
    }

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({}));
      throw new Error(errorData.message || `Error del servidor: ${res.status}`);
    }

    return (await res.json()) as RegistroResponse;
  } catch (error) {
    console.error('Error al registrar manualmente:', error);
    throw error;
  }
}

export async function enviarUbicacion(
  lat: number,
  lng: number,
  direccion: string | null,
  departamento: string | null,
  pais: string | null,
): Promise<UbicacionResponse> {
  const url = `${BASE_URL}/ubicacion`;

  try {
    const token = localStorage.getItem('servineo_token');
    if (!token) throw new Error('No se encontró el token de autenticación.');

    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ lat, lng, direccion, departamento, pais }),
    });

    const contentType = res.headers.get('content-type');

    if (contentType?.includes('text/html')) {
      const textError = await res.text();
      throw new Error(
        `Error ${res.status}: La API no respondió con JSON. Respuesta: ${textError.slice(0, 120)}`,
      );
    }

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({}));
      throw new Error(errorData.message || `Error del servidor: ${res.status}`);
    }

    return (await res.json()) as UbicacionResponse;
  } catch (error) {
    console.error('Error al enviar la ubicación:', error);
    throw error;
  }
}

export interface FotoResponse {
  success: boolean;
  message?: string;
  user?: {
    name: string;
    email: string;
    picture?: string;
  };
}

export async function enviarFotoPerfil(usuarioId: string, archivo: File): Promise<FotoResponse> {
  const fileToBase64 = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result as string);
      reader.onerror = (error) => reject(error);
    });
  };

  const base64Foto = await fileToBase64(archivo);
  const url = `${BASE_URL}/fotoPerfil/usuarios/foto`;

  const res = await fetch(url, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ usuarioId, fotoPerfil: base64Foto }),
  });

  const data = await res.json();

  if (!res.ok) {
    return { success: false, message: data.message || 'Error al subir la foto' };
  }

  if (data.user) {
    localStorage.setItem('servineo_user', JSON.stringify(data.user));
  }

  return data;
}
</file>

<file path="src/app/lib/session.ts">
// lib/session.ts
export function getSessionId(): string | null {
  if (typeof window === 'undefined') return null;
  try {
    const sid = localStorage.getItem('sessionId');
    return sid;
  } catch (e) {
    console.warn('No se pudo leer sessionId de localStorage', e);
    return null;
  }
}

export function setSessionId(id: string): void {
  if (typeof window === 'undefined') return;
  try {
    const current = localStorage.getItem('sessionId');
    if (current && current !== id) {
      console.warn('⚠️ SessionId está cambiando!', {
        anterior: current,
        nuevo: id,
      });
    }
    localStorage.setItem('sessionId', id);
  } catch (e) {
    console.warn('No se pudo guardar sessionId en localStorage', e);
  }
}

export function ensureSessionId(): string {
  if (typeof window === 'undefined') return '';

  let sid = null;
  try {
    sid = localStorage.getItem('sessionId');
  } catch (e) {
    console.error('Error leyendo sessionId:', e);
  }

  if (!sid) {
    // Generar nuevo sessionId
    sid =
      typeof crypto !== 'undefined' && crypto.randomUUID
        ? crypto.randomUUID()
        : `sid-${Date.now()}-${Math.floor(Math.random() * 10000)}`;

    try {
      localStorage.setItem('sessionId', sid);
    } catch (e) {
      console.warn('No se pudo persistir sessionId en localStorage', e);
    }
  }

  return sid;
}
</file>

<file path="src/app/lib/utils.ts">
import { clsx, type ClassValue } from 'clsx';
import { twMerge } from 'tailwind-merge';

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
</file>

<file path="src/app/lib/utils/contexts/AppointmentsContext/AppoinmentsContext.tsx">
'use client';
import React, { createContext, useContext, useMemo, ReactNode } from 'react';

interface AppointmentsContextType {
  isHourBookedFixer: (date: Date, hour: number) => boolean;
  isHourBooked: (date: Date, hour: number, requester_id: string) => 'self' | 'other' | 'notBooked';
  isEnabled: (date: Date, hour: number) => boolean;
  isCanceled: (
    date: Date,
    hour: number,
    requester_id: string,
  ) => 'fixer' | 'requester' | 'otherFixer' | 'otherRequester' | 'notCancel';
  getAppointmentsForDay: (
    day: number,
    month: number,
    year: number,
  ) => 'full' | 'partial' | 'available' | 'disabled';
  loading: boolean;
  refetchAll: () => void;
  refetchHour: (date: Date, hour: number) => void;
}

const AppointmentsContext = createContext<AppointmentsContextType | null>(null);

export function useAppointmentsContext() {
  const context = useContext(AppointmentsContext);
  if (!context) {
    throw new Error('useAppointmentsContext must be within AppointmentsProvider');
  }
  return context;
}

interface AppointmentsProviderProps {
  children: ReactNode;
  isHourBookedFixer: (date: Date, hour: number) => boolean;
  isHourBooked: (date: Date, hour: number, requester_id: string) => 'self' | 'other' | 'notBooked';
  isEnabled: (date: Date, hour: number) => boolean;
  isCanceled: (
    date: Date,
    hour: number,
    requester_id: string,
  ) => 'fixer' | 'requester' | 'otherFixer' | 'otherRequester' | 'notCancel';
  getAppointmentsForDay: (
    day: number,
    month: number,
    year: number,
  ) => 'full' | 'partial' | 'available' | 'disabled';
  loading: boolean;
  refetchAll: () => void;
  refetchHour: (date: Date, hour: number) => void;
}

export function AppointmentsProvider({
  children,
  isHourBookedFixer,
  isHourBooked,
  isEnabled,
  isCanceled,
  getAppointmentsForDay,
  loading,
  refetchAll,
  refetchHour,
}: AppointmentsProviderProps) {
  const value = useMemo(
    () => ({
      isHourBookedFixer,
      isHourBooked,
      isEnabled,
      isCanceled,
      getAppointmentsForDay,
      loading,
      refetchAll,
      refetchHour,
    }),
    [
      isHourBookedFixer,
      isHourBooked,
      isEnabled,
      isCanceled,
      getAppointmentsForDay,
      loading,
      refetchAll,
      refetchHour,
    ],
  );

  return <AppointmentsContext.Provider value={value}>{children}</AppointmentsContext.Provider>;
}
</file>

<file path="src/app/lib/utils/contexts/DayliViewRequesterContext.tsx">
'use client';
import React, { createContext, useContext, useEffect, useState } from 'react';

type Ctx = {
  loading: boolean;
  isHourBooked: (date: Date, hour: number) => boolean;
  isOccupiedByOther: (date: Date, hour: number) => boolean;
  isDisabled: (date: Date, hour: number) => boolean;
  isCancelledByFixer: (date: Date, hour: number) => boolean;
  isCancelledByRequester: (date: Date, hour: number) => boolean;
};

const CtxObj = createContext<Ctx | null>(null);

export function useDailyAppointments(): Ctx {
  const ctx = useContext(CtxObj);
  if (!ctx) throw new Error('useAppointmentsContext must be within AppointmentsStatusProvider');
  return ctx;
}

const API_BASE = 'https://servineo-backend-lorem.onrender.com';
const pad2 = (n: number) => String(n).padStart(2, '0');
const ymdLocal = (d: Date) => `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
const sameLocalDay = (a: Date, b: Date) =>
  a.getFullYear() === b.getFullYear() &&
  a.getMonth() === b.getMonth() &&
  a.getDate() === b.getDate();

async function getJSON<T>(url: string, signal?: AbortSignal): Promise<T | null> {
  const r = await fetch(url, { headers: { Accept: 'application/json' }, signal });
  if (!r.ok) return null;
  return r.json().catch(() => null);
}

type RowDay = { starting_hour: number; schedule_state: string };
type CancelFixerResp = { cancelled_schedules_fixer?: Array<{ starting_hour: number }> };
type CancelRequesterResp = { cancelled_schedules_requester?: Array<{ starting_hour: number }> };

export interface ProviderProps {
  fixerId: string;
  requesterId: string;
  selectedDate: Date;
  children: React.ReactNode;
}

export function AppointmentsStatusProvider({
  fixerId,
  requesterId,
  selectedDate,
  children,
}: ProviderProps) {
  const [loading, setLoading] = useState(false);
  const [bookedMine, setBookedMine] = useState<Set<number>>(new Set());
  const [occupiedOthers, setOccupiedOthers] = useState<Set<number>>(new Set());
  const [cancelByFixer, setCancelByFixer] = useState<Set<number>>(new Set());
  const [cancelByRequester, setCancelByRequester] = useState<Set<number>>(new Set());

  useEffect(() => {
    let alive = true;
    const ac = new AbortController();

    async function load() {
      setLoading(true);
      try {
        const ymd = ymdLocal(selectedDate);
        const uBooked = new URL(
          `${API_BASE}/api/crud_read/schedules/get_by_fixer_current_requester_day`,
        );
        uBooked.searchParams.set('fixer_id', fixerId);
        uBooked.searchParams.set('requester_id', requesterId);
        uBooked.searchParams.set('searched_date', ymd);

        const uOccupied = new URL(
          `${API_BASE}/api/crud_read/schedules/get_by_fixer_other_requesters_day`,
        );
        uOccupied.searchParams.set('fixer_id', fixerId);
        uOccupied.searchParams.set('requester_id', requesterId);
        uOccupied.searchParams.set('searched_date', ymd);

        const uCFixer = new URL(
          `${API_BASE}/api/crud_read/schedules/get_cancelled_appointments_by_fixer_date`,
        );
        uCFixer.searchParams.set('fixer_id', fixerId);
        uCFixer.searchParams.set('requester_id', requesterId);
        uCFixer.searchParams.set('searched_date', ymd);

        const uCReq = new URL(
          `${API_BASE}/api/crud_read/schedules/get_cancelled_appointments_by_requester_date`,
        );
        uCReq.searchParams.set('fixer_id', fixerId);
        uCReq.searchParams.set('requester_id', requesterId);
        uCReq.searchParams.set('searched_date', ymd);

        const [rBooked, rOccupied, rCFixer, rCReq] = await Promise.all([
          getJSON<RowDay[]>(uBooked.toString(), ac.signal),
          getJSON<RowDay[]>(uOccupied.toString(), ac.signal),
          getJSON<CancelFixerResp>(uCFixer.toString(), ac.signal),
          getJSON<CancelRequesterResp>(uCReq.toString(), ac.signal),
        ]);

        if (!alive) return;

        setBookedMine(new Set((rBooked ?? []).map((x) => Number(x.starting_hour))));
        setOccupiedOthers(new Set((rOccupied ?? []).map((x) => Number(x.starting_hour))));
        setCancelByFixer(
          new Set((rCFixer?.cancelled_schedules_fixer ?? []).map((x) => Number(x.starting_hour))),
        );
        setCancelByRequester(
          new Set((rCReq?.cancelled_schedules_requester ?? []).map((x) => Number(x.starting_hour))),
        );
      } catch (err) {
        if (err instanceof Error && err.name === 'AbortError') {
          console.log('Requested aborted.');
          return;
        }
        console.error('Error loading appointments: ', err);
      } finally {
        if (alive) setLoading(false);
      }
    }

    load();
    return () => {
      alive = false;
      ac.abort();
    };
  }, [fixerId, requesterId, selectedDate]);

  const sameDay = (d: Date) => sameLocalDay(d, selectedDate);

  function isCancelledByFixer(date: Date, hour: number) {
    return sameDay(date) && cancelByFixer.has(hour);
  }
  function isCancelledByRequester(date: Date, hour: number) {
    return sameDay(date) && cancelByRequester.has(hour);
  }
  function isOccupiedByOther(date: Date, hour: number) {
    return sameDay(date) && occupiedOthers.has(hour);
  }
  function isHourBooked(date: Date, hour: number) {
    if (!sameDay(date)) return false;
    if (cancelByRequester.has(hour)) return false;
    if (cancelByFixer.has(hour)) return false;
    return bookedMine.has(hour);
  }
  function isDisabled(date: Date, hour: number) {
    if (!sameDay(date)) return true;
    if (occupiedOthers.has(hour)) return true;
    if (cancelByFixer.has(hour)) return true;
    return false;
  }

  const value: Ctx = {
    loading,
    isHourBooked,
    isOccupiedByOther,
    isDisabled,
    isCancelledByFixer,
    isCancelledByRequester,
  };

  return <CtxObj.Provider value={value}>{children}</CtxObj.Provider>;
}
</file>

<file path="src/app/lib/utils/contexts/UserRoleContext.tsx">
'use client';

import { createContext, useContext, ReactNode } from 'react';

export type UserRole = 'fixer' | 'requester';

interface UserRoleContextType {
  role: UserRole;
  fixer_id: string;
  requester_id: string;
  currentUser_id: string;
  isFixer: boolean;
  isRequester: boolean;
}
const UserRoleContext = createContext<UserRoleContextType | undefined>(undefined);

interface UserRoleProviderProps {
  children: ReactNode;
  role: UserRole;
  fixer_id: string;
  requester_id: string;
}

export function UserRoleProvider({
  children,
  role,
  fixer_id,
  requester_id,
}: UserRoleProviderProps) {
  const currentUser_id = role === 'fixer' ? fixer_id : requester_id;

  return (
    <UserRoleContext.Provider
      value={{
        role,
        fixer_id,
        requester_id,
        currentUser_id,
        isFixer: role === 'fixer',
        isRequester: role === 'requester',
      }}
    >
      {children}
    </UserRoleContext.Provider>
  );
}

export function useUserRole() {
  const context = useContext(UserRoleContext);
  if (!context) {
    throw new Error('useUserRole must be used within UserRoleProvider');
  }
  return context;
}
</file>

<file path="src/app/lib/utils/distance.ts">
export function distanceKm([lat1, lng1]: [number, number], [lat2, lng2]: [number, number]) {
  const R = 6371; // km
  const dLat = ((lat2 - lat1) * Math.PI) / 180;
  const dLng = ((lng2 - lng1) * Math.PI) / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos((lat1 * Math.PI) / 180) * Math.cos((lat2 * Math.PI) / 180) * Math.sin(dLng / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}
</file>

<file path="src/app/lib/utils/getAppointmentsByDate.ts">
//refactorizar este archivo para que redux en lugar de axios maneje el estado de las citas
import axios from 'axios';

export interface Appointment {
  cancelled_fixer: boolean;
  _id: string;
  id_fixer: string;
  id_requester: string;
  selected_date: string;
  current_requester_name: string;
  appointment_type: string;
  appointment_description: string;
  link_id: string;
  current_requester_phone: string;
  starting_time: string;
  finishing_time: string;
  schedule_state: string;
  display_name_location: string;
  lat: string;
  lon: string;
  active: boolean;
  reprogram_reason: string;
  createdAt: string;
  updatedAt: string;
  __v: number;
}

interface ApiResponse {
  success: boolean;
  message: string;
  accessed_appointments: Appointment[];
}

export async function getAppointmentsByDate(fixerId: string, date: string): Promise<Appointment[]> {
  try {
    const response = await axios.get<ApiResponse>(
      'https://servineo-backend-lorem.onrender.com/api/crud_read/appointments/get_appointments_date',
      {
        params: {
          id_fixer: fixerId,
          selected_date: date,
        },
      },
    );

    if (response.data.success && response.data.accessed_appointments) {
      return response.data.accessed_appointments;
    } else {
      console.log('No se encontraron citas ');
      return [];
    }
  } catch (error) {
    if (axios.isAxiosError(error)) {
      console.error('Error de Axios:', {
        message: error.message,
        status: error.response?.status,
        data: error.response?.data,
      });
    } else {
      console.error('Error desconocido:', error);
    }
    return [];
  }
}
</file>

<file path="src/app/lib/utils/getAppointmentsByHour.ts">
import axios from 'axios';
export interface Appointment {
  _id: string;
  id_fixer: string;
  id_requester: string;
  selected_date: string;
  current_requester_name: string;
  appointment_type: string;
  appointment_description: string;
  link_id: string;
  current_requester_phone: string;
  starting_time: string;
  finishing_time: string;
  schedule_state: string;
  display_name_location: string;
  lat: string;
  lon: string;
  cancelled_fixer: boolean;
  active: boolean;
  reprogram_reason: string;
  createdAt: string;
  updatedAt: string;
  __v: number;
}
interface ApiResponse {
  succeed: boolean;
  message: string;
  data: Appointment[];
}

export async function getAppointmentsByHour(
  fixer_id: string,
  date: string,
  hour: number,
): Promise<Appointment[]> {
  try {
    const response = await axios.get<ApiResponse>(
      'https://servineo-backend-lorem.onrender.com/api/crud_read/appointments/get_appointment_by_fixer_hour',
      {
        params: {
          fixer_id,
          date,
          hour,
        },
      },
    );

    if (response.data.message && response.data.data) {
      return response.data.data;
    } else {
      console.log('No se encontraron citas ');
      return [];
    }
  } catch (error) {
    if (axios.isAxiosError(error)) {
      console.error('Error de Axios:', {
        message: error.message,
        status: error.response?.status,
        data: error.response?.data,
      });
    } else {
      console.error('Error desconocido:', error);
    }
    return [];
  }
}
</file>

<file path="src/app/lib/utils/getAppointmentsDisable.ts">
import axios from 'axios';

export interface Days {
  lunes: number[];
  martes: number[];
  miercoles: number[];
  jueves: number[];
  viernes: number[];
  sabado: number[];
  domingo: number[];
}

interface ApiAvailability {
  message: string;
  availability: Days;
}

export async function getAppointmentsDisable(fixerId: string): Promise<Days> {
  try {
    const res = await axios.get<ApiAvailability>(
      'https://servineo-backend-lorem.onrender.com/api/crud_read/appointments/get_fixer_availability',
      {
        params: {
          fixer_id: fixerId,
        },
      },
    );

    if (res.data && res.data.availability) {
      return res.data.availability;
    } else {
      console.log('No se encontró disponibilidad');
      return {
        lunes: [],
        martes: [],
        miercoles: [],
        jueves: [],
        viernes: [],
        sabado: [],
        domingo: [],
      };
    }
  } catch (error) {
    if (axios.isAxiosError(error)) {
      console.error('Error de Axios:', {
        message: error.message,
        status: error.response?.status,
        data: error.response?.data,
      });
    } else {
      console.error('Error desconocido:', error);
    }
    return {
      lunes: [],
      martes: [],
      miercoles: [],
      jueves: [],
      viernes: [],
      sabado: [],
      domingo: [],
    };
  }
}
</file>

<file path="src/app/lib/utils/getSchedulesCont.ts">
import axios from 'axios';

interface AppointmentsResponse {
  message: string;
  number_of_appointments: Record<string, Record<string, number>>;
}

export async function getSchedulesCont(
  fixer_id: string,
  month: number,
  year: number,
): Promise<Record<string, Record<string, number>>> {
  try {
    const response = await axios.get<AppointmentsResponse>(
      'https://servineo-backend-lorem.onrender.com/api/crud_read/schedules/get_number_of_appointments',
      {
        params: {
          fixer_id,
          month,
          year,
        },
      },
    );

    const data = response.data;
    const appointments = data.number_of_appointments;

    if (!appointments || typeof appointments !== 'object') {
      console.warn('No se encontraron appointments en la respuesta:', data);
      return {};
    }

    return appointments;
  } catch (error) {
    console.error('Error al obtener contador de schedules:', error);
    return {};
  }
}
</file>

<file path="src/app/lib/utils/getSixMonthAppointments.ts">
// utilizar redux toolkit para manejar el estado de las citas
// referencia: getAppointmentsByDate.ts y getAppointmentsByHour.ts
import axios from 'axios';

export interface Appointment {
  _id: string;
  id_fixer: string;
  id_requester: string;
  selected_date: string;
  current_requester_name: string;
  appointment_type: string;
  appointment_description: string;
  link_id: string;
  current_requester_phone: string;
  starting_time: string;
  finishing_time: string;
  schedule_state: string;
  display_name_location: string;
  lat: string;
  lon: string;
  cancelled_fixer: boolean;
  active: boolean;
  reprogram_reason: string;
  createdAt: string;
  updatedAt: string;
  __v: number;
}

interface ApiResponse {
  message: string;
  appointments: Appointment[];
}

export async function getSixMonthAppointments(
  fixerId: string,
  date: string,
): Promise<Appointment[]> {
  try {
    const response = await axios.get<ApiResponse>(
      'https://servineo-backend-lorem.onrender.com/api/crud_read/schedules/get_six_months_appointments',
      {
        params: {
          fixer_id: fixerId,
          date: date,
        },
      },
    );

    if (response.data.message && response.data.appointments) {
      return response.data.appointments;
    } else {
      console.log('No se encontraron citas ');
      return [];
    }
  } catch (error) {
    if (axios.isAxiosError(error)) {
      console.error('Error de Axios:', {
        message: error.message,
        status: error.response?.status,
        data: error.response?.data,
      });
    } else {
      console.error('Error desconocido:', error);
    }
    return [];
  }
}
</file>

<file path="src/app/lib/utils/useDailyConts.ts">
import { getSchedulesCont } from './getSchedulesCont';
import { useState, useCallback, useEffect, useRef } from 'react';
import { getAppointmentsDisable, Days } from './getAppointmentsDisable';

interface useDailyContsProps {
  date: Date;
  fixer_id: string;
}

export type DayOfWeek = keyof Days;

const DAY_MAP: { [key: number]: DayOfWeek } = {
  0: 'domingo',
  1: 'lunes',
  2: 'martes',
  3: 'miercoles',
  4: 'jueves',
  5: 'viernes',
  6: 'sabado',
};

export default function useDailyConts({ date, fixer_id }: useDailyContsProps) {
  const [count, setCount] = useState<Record<string, Record<string, number>> | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [appointmentsDis, setAppointmentsDis] = useState<Days>({
    lunes: [],
    martes: [],
    miercoles: [],
    jueves: [],
    viernes: [],
    sabado: [],
    domingo: [],
  });

  const hasFetched = useRef(false);
  const [refreshTrigger, setRefreshTrigger] = useState(0);

  const month = date.getMonth() + 1;
  const year = date.getFullYear();

  useEffect(() => {
    if (hasFetched.current && refreshTrigger === 0) {
      return;
    }

    async function fetchData() {
      if (!fixer_id || fixer_id === '' || fixer_id === 'undefined') {
        console.warn('fixer_id no válido:', fixer_id);
        setLoading(false);
        return;
      }

      setLoading(true);
      setError(null);

      try {
        const [countData, disabledData] = await Promise.all([
          getSchedulesCont(fixer_id, month, year),
          getAppointmentsDisable(fixer_id),
        ]);

        setCount(countData);
        setAppointmentsDis(disabledData);
        setError(null);
        hasFetched.current = true;
      } catch (err) {
        console.error('Error fetching schedules:', err);
        setError('Error al cargar los datos');
        setCount(null);
        setAppointmentsDis({
          lunes: [],
          martes: [],
          miercoles: [],
          jueves: [],
          viernes: [],
          sabado: [],
          domingo: [],
        });
      } finally {
        setLoading(false);
      }
    }

    fetchData();
  }, [fixer_id, month, year, refreshTrigger]);

  const refetch = useCallback(() => {
    setRefreshTrigger((prev) => prev + 1);
  }, []);

  const getAppointmentsForDay = useCallback(
    (
      day: number,
      monthParam: number,
      yearParam: number,
    ): 'full' | 'partial' | 'available' | 'disabled' => {
      const date = new Date(yearParam, monthParam, day);
      const dayOfWeek = date.getDay();
      const dayName = DAY_MAP[dayOfWeek];

      const max = appointmentsDis[dayName].length;

      if (!count) return 'available';

      const monthStr = String(monthParam + 1).padStart(2, '0');
      const format1 = `${monthStr}-${yearParam}`;
      const monthData = count[format1];

      if (!monthData) return 'available';

      const appointmentsCont = monthData[String(day)];

      if (max === 0) {
        return 'disabled';
      } else if (appointmentsCont === undefined || appointmentsCont === 0) {
        return 'available';
      } else if (appointmentsCont >= max) {
        return 'full';
      }

      return 'partial';
    },
    [count, appointmentsDis],
  );

  return {
    count,
    loading,
    error,
    refetch,
    getAppointmentsForDay,
  };
}
</file>

<file path="src/app/lib/utils/utilsDevices.ts">
import { clsx, type ClassValue } from 'clsx';
import { twMerge } from 'tailwind-merge';
import { formatDistanceToNow } from 'date-fns';
import { es } from 'date-fns/locale';

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
export { formatDistanceToNow };
export function formatTimeAgo(date: Date | string) {
  return formatDistanceToNow(new Date(date), { addSuffix: true, locale: es });
}
</file>

<file path="src/app/lib/validations/filter.validator.ts">
// src/validators/filter.validator.ts
import { z } from 'zod';

const RangeEnum = z.enum([
  'De (A-C)',
  'De (D-F)',
  'De (G-I)',
  'De (J-L)',
  'De (M-Ñ)',
  'De (O-Q)',
  'De (R-T)',
  'De (U-W)',
  'De (X-Z)',
]);

const nameRangeArray = z.array(RangeEnum).default([]);

const cityRegex = /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ\s-]+$/;
const cityString = z.string().trim().regex(cityRegex, { message: 'Ciudad inválida.' });
const cityArray = z.array(cityString).default([]);

const categoryItem = z
  .string()
  .trim()
  .regex(/^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ0-9\s-]+$/, {
    message: 'Categoría inválida.',
  });

const FilterSchema = z.object({
  range: nameRangeArray,
  city: cityArray,
  category: z.array(categoryItem).default([]),
});

export function validateFilters(filters: unknown) {
  const result = FilterSchema.safeParse(filters);
  if (!result.success) {
    const firstError = result.error.issues[0]?.message ?? 'Error de validación filters';
    return { isValid: false, error: firstError, data: null };
  }
  return { isValid: true, data: result.data };
}
</file>

<file path="src/app/lib/validations/fixer-schemas.ts">
import { z } from 'zod';

// Schema para el registro inicial
const nameRegex = /^[A-Za-záéíóúÁÉÍÓÚñÑ\s]+$/;
const phoneRegex = /^\+?[\d\s\-()]{8,}$/;

export const initialRegistrationSchema = z.object({
  name: z
    .string()
    .min(3, 'El nombre debe tener al menos 3 caracteres')
    .max(40, 'El nombre no puede tener más de 30 caracteres')
    .regex(nameRegex, 'El nombre solo puede contener letras y espacios')
    .transform((value) => value.trim()),
  email: z
    .string()
    .email('Email inválido')
    .transform((value) => value.toLowerCase()),
  phone: z
    .string()
    .regex(phoneRegex, 'Formato de teléfono inválido. Debe incluir al menos 8 dígitos')
    .refine((value) => {
      // Contar solo los dígitos (excluyendo +, - y espacios)
      const digitCount = value.replace(/\D/g, '').length;
      return digitCount <= 12;
    }, 'El número de teléfono no puede tener más de 10 dígitos')
    .transform((value) => value.trim()),
});

export const ciSchema = z.object({
  ci: z
    .string()
    .min(1, 'CI es requerido')
    .regex(/^[0-9-]+$/, 'CI debe contener solo números y guiones'),
});

// Schema para ubicación
export const locationSchema = z.object({
  lat: z.number().min(-90).max(90),
  lng: z.number().min(-180).max(180),
  direccion: z.string().optional(),
  departamento: z.string().optional(),
  pais: z.string().optional(),
});

// Schema para servicios
export const serviceSchema = z.object({
  id: z.string(),
  name: z.string().min(1, 'El nombre del servicio es requerido'),
  custom: z.boolean().optional(),
});

export const servicesStepSchema = z.object({
  selectedServiceIds: z.array(z.string()).min(1, 'Seleccione al menos un servicio'),
});

// Schema para métodos de pago
export const paymentMethodSchema = z.enum(['cash', 'qr', 'card']);

export const paymentStepSchema = z.object({
  payments: z.array(paymentMethodSchema).min(1, 'Seleccione al menos un método de pago'),
  accountInfo: z.string().optional(),
});

// Schema para experiencias
export const experienceSchema = z.object({
  descripcion: z.string().max(500, 'Máximo 500 caracteres').optional(),
});

// Schema para vehículo
export const vehicleSchema = z.object({
  hasVehiculo: z.boolean(),
  tipoVehiculo: z.enum(['motorcycle', 'car', 'van', 'truck']).optional(),
});

// Schema para términos
export const termsSchema = z.object({
  termsAccepted: z
    .boolean()
    .refine((val) => val === true, 'Debe aceptar los términos y condiciones'),
});

// Schema para foto de perfil
export const profilePhotoSchema = z.object({
  photoUrl: z.string().url('URL de foto inválida').optional(),
});

// Schema completo del perfil de FIXER alineado con IUser
export const fixerProfileSchema = z
  .object({
    ci: z.string().regex(/^[0-9-]+$/, 'CI debe contener solo números y guiones'),
    workLocation: locationSchema,
    servicios: z.array(z.string()).min(1, 'Seleccione al menos un servicio'),
    metodoPago: z.object({
      hasEfectivo: z.boolean().optional(),
      qr: z.boolean().optional(),
      tarjetaCredito: z.boolean().optional(),
    }),
    vehiculo: z.object({
      hasVehiculo: z.boolean(),
      tipoVehiculo: z.string().optional(),
    }),
    experience: z.object({
      descripcion: z.string().optional(),
    }),
    acceptTerms: z.boolean(),
    url_photo: z.string().url().optional(),
    // Campos auxiliares para el formulario que no van directo al modelo pero ayudan a validar
    accountInfo: z.string().optional(), // Para QR/Tarjeta
  })
  .refine(
    (data) => {
      const needsAccount = data.metodoPago.qr || data.metodoPago.tarjetaCredito;
      return !needsAccount || (data.accountInfo && data.accountInfo.trim().length > 0);
    },
    {
      message: 'Debe proporcionar información de cuenta para pagos QR o tarjeta',
      path: ['accountInfo'],
    },
  )
  .refine(
    (data) => {
      return !data.vehiculo.hasVehiculo || data.vehiculo.tipoVehiculo;
    },
    {
      message: 'Debe seleccionar el tipo de vehículo',
      path: ['vehiculo', 'tipoVehiculo'],
    },
  );

export type InitialRegistrationData = z.infer<typeof initialRegistrationSchema>;
export type CIData = z.infer<typeof ciSchema>;
export type LocationData = z.infer<typeof locationSchema>;
export type ServiceData = z.infer<typeof serviceSchema>;
export type PaymentMethodType = z.infer<typeof paymentMethodSchema>;
export type ExperienceData = z.infer<typeof experienceSchema>;
export type VehicleData = z.infer<typeof vehicleSchema>;
export type FixerProfileData = z.infer<typeof fixerProfileSchema>;
</file>

<file path="src/app/lib/validations/pagination.validator.ts">
// src/validators/pagination.validator.ts
import { z } from 'zod';

// Límites permitidos específicamente para JobOfert
const JOBOFERT_ALLOWED_LIMITS: number[] = [10, 20, 50, 100];

const PaginationSchema = z.object({
  page: z.number().int().min(1, { message: 'La página mínima es 1.' }).default(1),
  limit: z
    .number()
    .int()
    .refine((n) => JOBOFERT_ALLOWED_LIMITS.includes(n), {
      message: `Límite no permitido. Valores permitidos: ${JOBOFERT_ALLOWED_LIMITS.join(', ')}.`,
    })
    .default(10),
});

export function validatePagination(page: number, limit: number) {
  const result = PaginationSchema.safeParse({ page, limit });

  if (!result.success) {
    const firstError = result.error.issues[0]?.message ?? 'Error de validación pagination';
    return { isValid: false, error: firstError, data: null };
  }

  return { isValid: true, data: result.data };
}
export function sanitizePage(page: number, totalPages: number = 1): number {
  if (!page || isNaN(page)) return 1; // Si no hay número
  if (page < 1) return 1; // Negativos -> 1
  if (page > totalPages) return totalPages; // Si pasa límite -> última página
  return page; // Si es válido, se mantiene
}
export function sanitizeLimit(limit: number): number {
  const DEFAULT = 10;
  if (JOBOFERT_ALLOWED_LIMITS.includes(limit)) return limit;
  return DEFAULT;
}

export { PaginationSchema, JOBOFERT_ALLOWED_LIMITS };
</file>

<file path="src/app/lib/validations/search.validator.ts">
// src/validators/search.validator.ts
import { z } from 'zod';

const SearchSchema = z
  .string()
  .trim()
  .min(2, { message: 'Introduce al menos 2 caracteres para buscar.' })
  .max(100, { message: 'Límite máximo de 100 caracteres.' })
  .regex(
    /^[A-Za-z0-9ÁáÀàÂâÄäÃãÅåĀāĂăǍǎȦȧÉéÈèÊêËëĒēĔĕĚěĖėÍíÌìÎîÏïĨĩĪīĬĭǏǐÓóÒòÔôÖöÕõŌōŎŏǑǒȮȯÚúÙùÛûÜüŨũŮůŪūŬŭǓǔU̇u̇ñÑ,_. -]+$/,
    {
      message:
        'Búsqueda inválida. Solo se permiten letras, números y los caracteres "," "_" "." y "-".',
    },
  );

export function validateSearch(search: string) {
  if (typeof search !== 'string') {
    return { isValid: false, error: 'Entrada inválida.', data: null };
  }

  const result = SearchSchema.safeParse(search);
  if (!result.success) {
    const firstError = result.error.issues[0]?.message ?? 'Error de validación search';
    return { isValid: false, error: firstError, data: null };
  }

  return { isValid: true, error: undefined, data: result.data };
}
</file>

<file path="src/app/Mapa/LocationButton.tsx">
'use client';
import { useState } from 'react';

interface LocationButtonProps {
  onLocationFound: (lat: number, lng: number) => void;
}

export default function LocationButton({ onLocationFound }: LocationButtonProps) {
  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  const [showMsg, setShowMsg] = useState(false);

  const handleClick = () => {
    setErrorMsg(null);
    setShowMsg(false);

    if (!navigator.geolocation) {
      showMessage('❌ Tu navegador no soporta geolocalización.');
      return;
    }

    setLoading(true);

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        onLocationFound(latitude, longitude);
        setLoading(false);
      },
      (error) => {
        setLoading(false);
        switch (error.code) {
          case error.PERMISSION_DENIED:
            showMessage('🚫 Permiso denegado para acceder a la ubicación.');
            break;
          case error.POSITION_UNAVAILABLE:
            showMessage('⚠️ No se pudo obtener tu ubicación. Intenta nuevamente.');
            break;
          case error.TIMEOUT:
            showMessage('⏳ La solicitud de ubicación ha tardado demasiado.');
            break;
          default:
            showMessage('❌ Ocurrió un error al obtener la ubicación.');
        }
      },
    );
  };

  const showMessage = (msg: string) => {
    setErrorMsg(msg);
    setShowMsg(true);
    setTimeout(() => setShowMsg(false), 4000); // desaparece después de 4 segundos
  };

  return (
    <div className='flex items-start gap-3 relative'>
      {/* Botón de ubicación */}
      <button
        onClick={handleClick}
        disabled={loading}
        className={`flex items-center gap-2 px-4 py-2
          bg-white rounded-full shadow-lg border border-gray-200
          text-[#2B6AE0] font-medium
          transition duration-300 transform
          hover:shadow-2xl hover:bg-[#3FD6D6]/20 hover:scale-105 active:scale-95
          ${loading ? 'opacity-60 cursor-not-allowed' : ''}`}
        title='Centrar en mi ubicación'
      >
        {loading ? (
          <span>📡 Obteniendo ubicación...</span>
        ) : (
          <>
            <svg
              xmlns='http://www.w3.org/2000/svg'
              className='h-5 w-5 text-[#2B6AE0]'
              fill='none'
              viewBox='0 0 24 24'
              stroke='currentColor'
              strokeWidth={2}
            >
              <path
                strokeLinecap='round'
                strokeLinejoin='round'
                d='M12 11c1.104 0 2-.896 2-2s-.896-2-2-2-2 .896-2 2 .896 2 2 2z'
              />
              <path
                strokeLinecap='round'
                strokeLinejoin='round'
                d='M12 2C8.134 2 5 5.134 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.866-3.134-7-7-7z'
              />
            </svg>
            Tu ubicación
          </>
        )}
      </button>

      {/* Mensaje al lado del botón con animación suave */}
      {errorMsg && (
        <div
          className={`flex items-center gap-2 px-4 py-3 rounded-xl shadow-md bg-[#4B3FE8] text-white text-sm break-words max-w-md
          transition-all duration-500 ease-in-out
          ${showMsg ? 'opacity-100 translate-x-0 translate-y-0' : 'opacity-0 -translate-x-6 -translate-y-2'}`}
        >
          {/* Icono map-pin tachado */}
          <svg
            xmlns='http://www.w3.org/2000/svg'
            className='h-6 w-6 text-[#FF6B6B] transform rotate-180'
            fill='none'
            viewBox='0 0 24 24'
            stroke='currentColor'
            strokeWidth={2}
          >
            <path
              strokeLinecap='round'
              strokeLinejoin='round'
              d='M15 10.5c0 1.657-1.343 3-3 3s-3-1.343-3-3 1.343-3 3-3 3 1.343 3 3z'
            />
            <path
              strokeLinecap='round'
              strokeLinejoin='round'
              d='M19.428 15.341C17.53 19.78 12 22 12 22s-5.53-2.22-7.428-6.659C3.12 11.61 12 2 12 2s8.88 9.61 7.428 13.341z'
            />
            <line x1='3' y1='3' x2='21' y2='21' stroke='red' strokeWidth={2} />
          </svg>

          <span>{errorMsg}</span>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/app/Mapa/Map.tsx">
'use client';

import { useState, useEffect, useRef, useMemo } from 'react';
import { MapContainer, TileLayer, Popup, useMap } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import L from 'leaflet';
import { Fixer } from '@/Components/interface/Fixer_Interface';
import { Map as LeafletMapType } from 'leaflet';

import RecenterMap from './RecenterMap';
import UserMarker from './UserMaker';
import FixerMarker from './FixerMaker';
import MapEvents from './MapEvents';
import MapCircle from './MapCircle';
import LocationButton from './LocationButton';
import ResetMapButton from './ResetMapButton';
import { distanceKm } from '@/app/lib/utils/distance';

const defaultPosition: [number, number] = [-17.39381, -66.15693];

function MapResizeHandler() {
  const map = useMap();
  useEffect(() => {
    const handleResize = () => {
      setTimeout(() => {
        map.invalidateSize();
      }, 150);
    };
    window.addEventListener('resize', handleResize);
    const timer = setTimeout(() => {
      map.invalidateSize();
    }, 300);
    return () => {
      window.removeEventListener('resize', handleResize);
      clearTimeout(timer);
    };
  }, [map]);
  return null;
}

export default function Map() {
  const [fixers, setFixers] = useState<Fixer[]>([]);
  const [pinPosition, setPinPosition] = useState<[number, number]>(defaultPosition);
  const [mapCenter, setMapCenter] = useState<[number, number]>(defaultPosition);
  const [zoom, setZoom] = useState(14);

  // Estado independiente para el círculo
  const [circleCenter, setCircleCenter] = useState<[number, number]>(pinPosition);

  // Mantenerlo actualizado cuando cambie pinPosition
  useEffect(() => {
    setCircleCenter(pinPosition);
  }, [pinPosition]);

  const [loading, setLoading] = useState(true);
  const mapRef = useRef<LeafletMapType | null>(null);
  const [mapKey, setMapKey] = useState(0);

  useEffect(() => {
    import('@/jsons/fixers.json')
      .then((module) => setFixers(module.default))
      .catch(() => alert('No se pudieron cargar los fixers 😢'))
      .finally(() => setLoading(false));
  }, []);

  useEffect(() => {
    const savedPin = localStorage.getItem('pinPosition');
    const savedCenter = localStorage.getItem('mapCenter');
    const savedZoom = localStorage.getItem('mapZoom');

    if (savedPin) setPinPosition(JSON.parse(savedPin));
    if (savedCenter) setMapCenter(JSON.parse(savedCenter));
    if (savedZoom) setZoom(Number(savedZoom));
  }, []);

  const savePin = (pos: [number, number]) => {
    localStorage.setItem('pinPosition', JSON.stringify(pos));
  };

  const saveView = (center: [number, number], zoomLevel: number) => {
    localStorage.setItem('mapCenter', JSON.stringify(center));
    localStorage.setItem('mapZoom', zoomLevel.toString());
  };

  const handleClick = (pos: L.LatLngExpression) => {
    const [lat, lng] = Array.isArray(pos) ? pos : [pos.lat, pos.lng];
    setPinPosition([lat, lng]);
    savePin([lat, lng]);
  };

  const handleMove = (center: L.LatLngExpression) => {
    const [lat, lng] = Array.isArray(center) ? center : [center.lat, center.lng];
    setMapCenter([lat, lng]);
    saveView([lat, lng], zoom);
  };

  const handleZoom = (newZoom: number) => {
    setZoom(newZoom);
    saveView(mapCenter, newZoom);
  };

  const nearbyFixers = fixers.filter(
    (f) => f.available && distanceKm(pinPosition, [f.lat, f.lng]) <= 5,
  );

  const handleReset = () => {
    const plaza: [number, number] = defaultPosition;
    setPinPosition(plaza);
    setMapCenter(plaza);
    setZoom(14);
    localStorage.removeItem('pinPosition');
    localStorage.removeItem('mapCenter');
    localStorage.removeItem('mapZoom');
  };
  // ====== Memoizar el círculo ======
  const memoizedCircle = useMemo(() => {
    return <MapCircle center={pinPosition} radius={5000} />;
  }, [pinPosition]);
  const initialMap = useMemo(
    () => ({
      center: mapCenter,
      zoom: zoom,
    }),
    [mapCenter, zoom], // <- ahora depende de ellos
  );

  useEffect(() => {
    const handleResize = () => {
      setMapKey((prev) => prev + 1);
    };
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  if (loading) return <div>Cargando mapa...</div>;

  return (
    <div className='relative z-0' style={{ height: '60vh', width: '100%', marginTop: '10px' }}>
      <ResetMapButton onReset={handleReset} isOnline={navigator.onLine} />

      <MapContainer
        center={initialMap.center}
        zoom={initialMap.zoom}
        scrollWheelZoom
        style={{ height: '100%', width: '100%' }}
        ref={mapRef}
      >
        <TileLayer
          url='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
          attribution='© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        />

        <MapResizeHandler />
        <RecenterMap position={pinPosition} />

        <UserMarker position={pinPosition} />
        <MapCircle center={circleCenter} radius={5000} />

        {nearbyFixers.map((f) => (
          <FixerMarker key={f.id} fixer={f} />
        ))}

        <MapEvents onClick={handleClick} onMove={handleMove} onZoom={handleZoom} />

        {nearbyFixers.length === 0 && (
          <Popup position={pinPosition} closeButton={false} autoPan={true}>
            <div className='text-black px-4 py-2 rounded-lg font-semibold text-center shadow-md min-w-[180px]'>
              ⚠️ No se encontraron fixers cercanos
            </div>
          </Popup>
        )}
      </MapContainer>

      <LocationButton
        onLocationFound={(lat, lng) => {
          const newPos: [number, number] = [lat, lng];
          setPinPosition(newPos);
          setCircleCenter(newPos); // <--- agregar esto
          savePin(newPos);
          setMapCenter(newPos);
          setZoom(15);
          saveView(newPos, 15);
        }}
      />
    </div>
  );
}
</file>

<file path="src/app/Mapa/MapCircle.tsx">
'use client';

import { Circle } from 'react-leaflet';

interface MapCircleProps {
  center: [number, number];
  radius?: number;
}

export default function MapCircle({ center, radius = 5000 }: MapCircleProps) {
  return (
    <Circle center={center} radius={radius} pathOptions={{ color: 'blue', fillOpacity: 0.1 }} />
  );
}
</file>

<file path="src/app/Mapa/MapEvents.tsx">
'use client';

import { useMapEvents } from 'react-leaflet';
import { LatLngExpression } from 'leaflet';
import { useState, useEffect } from 'react';

interface MapEventsProps {
  onClick?: (pos: LatLngExpression) => void;
  onMove?: (pos: LatLngExpression) => void;
  onZoom?: (zoom: number) => void;
}

export default function MapEvents({ onClick, onMove, onZoom }: MapEventsProps) {
  const [isOnline, setIsOnline] = useState(true);
  const [showMessage, setShowMessage] = useState(false);

  const map = useMapEvents({});

  const showOfflineMessage = () => {
    setShowMessage(true);
    setTimeout(() => setShowMessage(false), 3000);
  };

  // Escuchar cambios de conexión
  useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  // Habilitar/deshabilitar interacción del mapa según conexión
  useEffect(() => {
    if (!map) return;

    if (!isOnline) {
      map.dragging.disable();
      map.scrollWheelZoom.disable();
      map.touchZoom.disable();
      map.doubleClickZoom.disable();
      map.boxZoom.disable();
      map.keyboard.disable();
    } else {
      map.dragging.enable();
      map.scrollWheelZoom.enable();
      map.touchZoom.enable();
      map.doubleClickZoom.enable();
      map.boxZoom.enable();
      map.keyboard.enable();
    }
  }, [isOnline, map]);

  // Bloquear botones + y - del zoom cuando no hay conexión
  useEffect(() => {
    if (!map) return;

    const handleZoomStart = () => {
      if (!isOnline) {
        showOfflineMessage();
        map.setZoom(map.getZoom()); // mantener zoom
      }
    };

    map.on('zoomstart', handleZoomStart);

    return () => {
      map.off('zoomstart', handleZoomStart);
    };
  }, [isOnline, map]);

  // Manejar eventos del mapa
  useMapEvents({
    click: (e) => {
      if (!isOnline) {
        showOfflineMessage();
        return;
      }
      if (onClick) onClick([e.latlng.lat, e.latlng.lng]);
    },
    moveend: (e) => {
      if (!isOnline) {
        showOfflineMessage();
        e.target.setView(e.target.getCenter()); // mantener vista
        return;
      }
      if (onMove) onMove(e.target.getCenter());
    },
    zoomend: (e) => {
      if (!isOnline) {
        showOfflineMessage();
        e.target.setZoom(e.target.getZoom()); // mantener zoom
        return;
      }
      if (onZoom) onZoom(e.target.getZoom());
    },
  });

  return (
    <>
      {showMessage && (
        <div
          className='absolute top-4 left-1/2 -translate-x-1/2 z-[1000] text-white font-bold px-6 py-3 rounded-xl shadow-lg text-center transition-all duration-700 ease-in-out'
          style={{
            pointerEvents: 'none',
            backgroundColor: '#E74C3C',
            transform: showMessage ? 'translateY(0)' : 'translateY(-20px)',
            opacity: showMessage ? 1 : 0,
          }}
        >
          ⚠️ Sin conexión..
        </div>
      )}
    </>
  );
}
</file>

<file path="src/app/Mapa/NoResults.tsx">
'use client';

import { Popup } from 'react-leaflet';

interface NoResultsProps {
  show: boolean;
  position: [number, number];
}

export default function NoResults({ show, position }: NoResultsProps) {
  //const map = useMap();

  if (!show) return null;

  return (
    <Popup
      position={position}
      autoPan={true}
      closeButton={false}
      className='
        bg-white px-6 py-3 rounded-full shadow-2xl
        border border-gray-200 font-semibold text-gray-800 text-center
      '
    >
      ⚠️ Sin resultados de fixers cercanos
    </Popup>
  );
}
</file>

<file path="src/app/Mapa/RecenterMap.tsx">
'use client';

import { useEffect, useState, useRef } from 'react';
import { useMap, Circle } from 'react-leaflet';

interface RecenterMapProps {
  position: [number, number];
}

export default function RecenterMap({ position }: RecenterMapProps) {
  const map = useMap();
  const [showPulse, setShowPulse] = useState(false);
  const prevPosition = useRef<[number, number] | null>(null);
  const isFirstRender = useRef(true);

  useEffect(() => {
    if (!position) return;

    // Evitar el primer render
    if (isFirstRender.current) {
      isFirstRender.current = false;
      prevPosition.current = position;
      return;
    }

    // Si la posición no cambió, salir
    if (
      prevPosition.current &&
      position[0] === prevPosition.current[0] &&
      position[1] === prevPosition.current[1]
    ) {
      return;
    }

    prevPosition.current = position;

    // ===== DETECTAR MÓVIL =====
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);

    if (isMobile) {
      map.setView(position, map.getZoom()); // móvil: sin animación
    } else {
      map.flyTo(position, map.getZoom(), { animate: true, duration: 0.8, easeLinearity: 0.3 }); // web: animación
    }

    setShowPulse(true);
    const timer = setTimeout(() => setShowPulse(false), 1200);

    return () => clearTimeout(timer);
  }, [position, map]);

  return (
    <>
      {showPulse && (
        <Circle
          center={position}
          radius={50}
          pathOptions={{ color: '#3b82f6', fillColor: '#3b82f6', fillOpacity: 0.2, weight: 0 }}
        />
      )}
    </>
  );
}
</file>

<file path="src/app/Mapa/UserMaker.tsx">
'use client';

import { Marker, Popup } from 'react-leaflet';
import L from 'leaflet';

interface UserMarkerProps {
  position: [number, number];
}

export default function UserMarker({ position }: UserMarkerProps) {
  return (
    <Marker
      position={position}
      icon={L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/64/64113.png',
        iconSize: [40, 40],
      })}
    >
      <Popup>
        <span className='text-black font-bold'>📍 Estás aquí</span>
      </Popup>
    </Marker>
  );
}
</file>

<file path="src/app/por-que-servineo/page.tsx">
'use client';

import Link from 'next/link';
import { MapPin, User, Calendar, ShieldCheck } from 'lucide-react';
import { Check, X } from 'lucide-react';
import { useEffect, useLayoutEffect, useRef, useState } from 'react';

function useInViewMultiple(count: number, options?: IntersectionObserverInit) {
  const refs = useRef<(HTMLDivElement | null)[]>(Array(count).fill(null));
  const [inViewStates, setInViewStates] = useState<boolean[]>(Array(count).fill(false));

  useEffect(() => {
    refs.current.forEach((el, index) => {
      if (!el) return;

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              setInViewStates((prev) => {
                const newState = [...prev];
                newState[index] = true;
                return newState;
              });
              observer.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.25, ...options },
      );

      observer.observe(el);
    });
  }, [count, options]);

  return { refs, inViewStates };
}

export default function WhyServineoPage() {
  const banners = [
    {
      id: 1,
      title: 'Descubre quiénes están cerca de ti',
      description:
        'Explora tu ciudad desde el mapa interactivo de Servineo y descubre a los fixers disponibles cerca de ti. Podrás ver fácilmente su ubicación y acceder a su información con un solo clic. Así, Servineo te conecta de forma rápida y sencilla con los profesionales que realmente están a tu alcance.',
      image: '/img/imgWhyServineo/banner1.png',
      alt: 'Mapa de la ciudad con marcadores que muestran fixers cerca del usuario',
      icon: (
        <MapPin className='inline-block w-6 h-6 mr-2 text-[var(--primary)]' aria-hidden='true' />
      ),
      button: { text: 'Explorar mapa', link: '/' },
    },
    {
      id: 2,
      title: 'Conócelos en detalle',
      description:
        'En Servineo, cada fixer cuenta con un perfil completo que muestra su experiencia, especialidades y disponibilidad. Explora sus trayectorias, conoce sus habilidades y elige con confianza al profesional que mejor se adapte a tus necesidades. Todo lo que necesitas saber para encontrar al fixer ideal, en un solo lugar.',
      image: '/img/imgWhyServineo/banner2.png',
      alt: 'Perfil de un profesional mostrando su información y experiencia',
      icon: <User className='inline-block w-6 h-6 mr-2 text-[var(--primary)]' aria-hidden='true' />,
    },
    {
      id: 3,
      title: 'Agenda tu cita con facilidad',
      description:
        'Con Servineo, agendar un servicio es rápido y sin complicaciones. Elige al profesional que necesites, coordina los detalles por WhatsApp y confirma tu cita en el horario que prefieras. Todo desde una plataforma práctica que conecta fácilmente a quienes ofrecen y quienes buscan un servicio.',
      image: '/img/imgWhyServineo/banner3.png',
      alt: 'Persona agendando una cita de servicio desde su dispositivo',
      icon: (
        <Calendar className='inline-block w-6 h-6 mr-2 text-[var(--primary)]' aria-hidden='true' />
      ),
      button: { text: 'Agendar ahora', link: '/' },
    },
    {
      id: 4,
      title: 'Confía en la calidad y seguridad del servicio',
      description:
        'En Servineo, la confianza es lo primero. Por eso, cada fixer pasa por un proceso de registro que valida su compromiso, responsabilidad y cumplimiento de nuestras políticas. Así, garantizamos que cada servicio dentro de la plataforma sea seguro, transparente y de calidad, brindándote la tranquilidad de contratar a profesionales en los que realmente puedes confiar.',
      image: '/img/imgWhyServineo/banner4.png',
      alt: 'Profesional estrechando la mano de un cliente en señal de confianza',
      icon: (
        <ShieldCheck
          className='inline-block w-6 h-6 mr-2 text-[var(--primary)]'
          aria-hidden='true'
        />
      ),
    },
  ];

  const STORAGE_KEY = 'whyServineoScroll';

  // Guardar scroll
  useEffect(() => {
    if (typeof window === 'undefined') return;
    const handleScroll = () => {
      sessionStorage.setItem(STORAGE_KEY, String(window.scrollY));
    };
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  // Restaurar scroll
  useLayoutEffect(() => {
    if (typeof window === 'undefined') return;

    const restoreScroll = () => {
      const saved = sessionStorage.getItem(STORAGE_KEY);
      if (saved) {
        const y = parseInt(saved, 10);
        if (!Number.isNaN(y)) window.scrollTo({ top: y, left: 0, behavior: 'auto' });
      }
    };

    restoreScroll();

    const handlePopState = () => {
      const retry = () => {
        restoreScroll();
        if (window.scrollY < 1) setTimeout(retry, 50);
      };
      retry();
    };

    window.addEventListener('popstate', handlePopState);
    return () => window.removeEventListener('popstate', handlePopState);
  }, []);

  const { refs, inViewStates } = useInViewMultiple(banners.length);

  return (
    <main className='min-h-screen bg-[var(--background)] text-[var(--foreground)]'>
      {/* Hero */}
      <section className='max-w-5xl mx-auto px-6 py-24 text-center'>
        <h1 className='text-5xl md:text-6xl font-extrabold text-[var(--primary)] mb-8 leading-tight'>
          ¿Por qué Servineo?
        </h1>
        <p className='text-lg md:text-xl leading-relaxed text-gray-700 max-w-3xl mx-auto'>
          En Servineo, creemos que encontrar ayuda profesional no debería ser complicado. Por eso,
          creamos una plataforma que te conecta con expertos de confianza, especializados en
          carpintería, plomería, electricidad y mucho más. Servineo transforma la manera de
          contratar servicios: rápida, clara y hecha para simplificar tu día a día.
        </p>
      </section>

      {/* Banners */}
      {banners.map((banner, index) => (
        <section
          key={banner.id}
          ref={(el: HTMLDivElement | null) => {
            refs.current[index] = el;
          }}
          className={`py-12 lg:py-20 relative flex flex-col-reverse md:flex-row items-start max-w-6xl mx-auto px-4 sm:px-6 md:px-8 gap-12 sm:gap-8 transition-all duration-700 ease-out
            ${inViewStates[index] ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-6 sm:translate-y-8'}`}
        >
          {/* Texto */}
          <div className='md:w-1/2 text-center md:text-left z-20'>
            <h2 className='text-2xl sm:text-2xl md:text-3xl font-semibold text-black mb-4 flex items-center justify-center md:justify-start'>
              {banner.icon}
              {banner.title}
            </h2>
            <p className='text-base sm:text-lg md:text-lg leading-relaxed mb-4'>
              {banner.description}
            </p>
            {banner.button && (
              <Link
                href={banner.button.link}
                className='inline-block bg-[var(--primary)] hover:bg-[var(--secondary)] text-white rounded-full px-6 py-3 shadow-md transition-all duration-300 transform hover:scale-105 mt-4'
              >
                {banner.button.text}
              </Link>
            )}
          </div>

          {/* Imagen - CAMBIO PRINCIPAL AQUÍ */}
          <div className='md:w-1/2 relative z-10 flex justify-center md:justify-end'>
            <div
              className='hidden xl:block absolute rounded-3xl shadow-lg
                top-0 right-0 w-5/6 sm:w-4/5 h-5/6 sm:h-4/5 translate-x-6 sm:translate-x-14 -translate-y-4 sm:-translate-y-6
                bg-[var(--primary)] z-0'
              aria-hidden='true'
            />
            <div className='relative rounded-3xl shadow-lg overflow-hidden w-full md:w-[90%] z-10 group bg-gray-100'>
              {/* USANDO <img> NATIVO EN LUGAR DE <Image /> */}
              <img
                src={banner.image}
                alt={banner.alt}
                className='w-full h-auto object-cover block transition duration-500 group-hover:scale-105 group-hover:shadow-2xl group-hover:brightness-95'
                loading='lazy'
                decoding='async'
              />
            </div>
          </div>
        </section>
      ))}
      {/* Tabla comparativa */}
      <section className='max-w-6xl mx-auto px-6 py-24 bg-[var(--background)] text-[var(--foreground)]'>
        {/* Subtítulo */}
        <h2 className='text-3xl md:text-4xl font-extrabold text-black mb-4 text-center'>
          ¿Qué hace a Servineo diferente?
        </h2>
        {/* Descripción */}
        <p className='text-base sm:text-lg md:text-lg leading-relaxed text-center text-gray-700 mb-12 max-w-3xl mx-auto'>
          Compara las principales plataformas de servicios y descubre por qué Servineo ofrece mayor
          seguridad, confianza y facilidad para agendar tus servicios.
        </p>

        <div className='overflow-x-auto relative'>
          <table className='min-w-full border border-gray-200 rounded-2xl shadow-md overflow-hidden'>
            <thead className='bg-[var(--primary)] text-white'>
              <tr>
                <th className='p-4 text-center text-xl'>Criterio</th>
                <th className='p-4 text-center text-xl'>Servineo</th>
                <th className='p-4 text-center text-xl'>
                  <a
                    href='https://www.facebook.com/marketplace'
                    target='_blank'
                    rel='noopener noreferrer'
                    className="relative inline-block text-white after:content-[''] after:absolute after:left-0 after:bottom-0 after:w-0 after:h-[2px] after:bg-white hover:after:w-full after:transition-all after:duration-300"
                  >
                    Facebook Marketplace
                  </a>
                </th>
                <th className='p-4 text-center text-xl'>
                  <a
                    href='https://bookaapp.com/services'
                    target='_blank'
                    rel='noopener noreferrer'
                    className="relative inline-block text-white after:content-[''] after:absolute after:left-0 after:bottom-0 after:w-0 after:h-[2px] after:bg-white hover:after:w-full after:transition-all after:duration-300"
                  >
                    Foreign apps
                  </a>
                </th>
              </tr>
            </thead>
            <tbody className='bg-white'>
              {/* Verificación de usuarios */}
              <tr className='border-b border-gray-200 hover:bg-gray-50 transition-colors'>
                <td className='p-4 text-center'>Verificación de usuarios</td>
                <td className='p-4 bg-blue-50 rounded-lg shadow-sm text-center'>
                  Perfiles reales y verificados
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Sin verificación obligatoria
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Validación básica
                  </span>
                </td>
              </tr>

              {/* Reserva de citas */}
              <tr className='border-b border-gray-200 hover:bg-gray-50 transition-colors'>
                <td className='p-4 text-center'>Reserva de citas</td>
                <td className='p-4 bg-blue-50 rounded-lg shadow-sm text-center relative group cursor-pointer'>
                  <Check className='mx-auto text-green-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Reserva en segundos desde la plataforma
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Sin sistema de reservas
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <Check className='mx-auto text-green-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Disponible, pero poco ágil
                  </span>
                </td>
              </tr>

              {/* Seguridad y confianza */}
              <tr className='border-b border-gray-200 hover:bg-gray-50 transition-colors'>
                <td className='p-4 text-center'>Seguridad y confianza</td>
                <td className='p-4 bg-blue-50 rounded-lg shadow-sm text-center relative group cursor-pointer'>
                  <Check className='mx-auto text-green-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Opiniones reales y control de calidad
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Alto riesgo de fraudes
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Moderada, depende del país
                  </span>
                </td>
              </tr>

              {/* Información del profesional */}
              <tr className='border-b border-gray-200 hover:bg-gray-50 transition-colors'>
                <td className='p-4 text-center'>Información del profesional</td>
                <td className='p-4 bg-blue-50 rounded-lg shadow-sm text-center'>
                  Perfiles con fotos, habilidades y disponibilidad
                </td>
                <td className='p-4 text-center'>Información limitada</td>
                <td className='p-4 text-center'>Datos básicos</td>
              </tr>

              {/* Atención al cliente */}
              <tr className='border-b border-gray-200 hover:bg-gray-50 transition-colors'>
                <td className='p-4 text-center'>Atención al cliente</td>
                <td className='p-4 bg-blue-50 rounded-lg shadow-sm text-center relative group cursor-pointer'>
                  <Check className='mx-auto text-green-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Soporte directo por WhatsApp o correo
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Sin atención personalizada
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Limitada
                  </span>
                </td>
              </tr>

              {/* Diseño enfocado en servicios */}
              <tr className='border-b border-gray-200 hover:bg-gray-50 transition-colors'>
                <td className='p-4 text-center'>Diseño enfocado en servicios</td>
                <td className='p-4 bg-blue-50 rounded-lg shadow-sm text-center relative group cursor-pointer'>
                  <Check className='mx-auto text-green-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Hecho para conectar profesionales y clientes
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Enfocado en ventas generales
                  </span>
                </td>
                <td className='p-4 text-center relative group cursor-pointer'>
                  <X className='mx-auto text-red-600' />
                  <span className='absolute left-1/2 -translate-x-1/2 -top-10 hidden group-hover:block bg-white text-black text-base rounded-lg shadow-lg px-3 py-1 max-w-xs break-words transition-all'>
                    Orientado a experiencias
                  </span>
                </td>
              </tr>

              {/* Costo de uso */}
              <tr className='hover:bg-gray-50 transition-colors'>
                <td className='p-4 text-center'>Costo de uso</td>
                <td className='p-4 bg-blue-50 rounded-lg shadow-sm text-center'>
                  Gratis y transparente
                </td>
                <td className='p-4 text-center'>Gratis, pero sin soporte</td>
                <td className='p-4 text-center'>Costos variables</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
      {/* Sección de llamada a la acción */}
      <section className='w-full bg-[var(--primary)] text-white py-16 px-6 flex flex-col items-center text-center'>
        <h2 className='text-3xl md:text-4xl font-extrabold mb-4'>
          ¡Conecta con los mejores profesionales en segundos!
        </h2>
        <p className='text-lg md:text-xl leading-relaxed max-w-3xl mb-8'>
          Con Servineo, encontrar ayuda confiable nunca fue tan rápido y seguro. Dale el impulso que
          tu día necesita y empieza a disfrutar de servicios profesionales a tu alcance.
        </p>
        <button
          onClick={() => (window.location.href = '/')}
          className='bg-white text-[var(--primary)] font-semibold rounded-full px-8 py-4 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105'
        >
          ¡Prueba Servineo ahora!
        </button>
      </section>
    </main>
  );
}
</file>

<file path="src/app/providers.tsx">
'use client';

import { Provider } from 'react-redux';
import { store } from './redux/store';
import { TourProviderWrapper } from '@/Components/Tour/TourProviderWrapper';

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <Provider store={store}>
      <TourProviderWrapper>{children}</TourProviderWrapper>
    </Provider>
  );
}
</file>

<file path="src/app/redux/contants/dbValues.ts">
/**
 * Valores que se envían al backend (en español)
 * Estos son los valores tal como están en la base de datos
 */
export const DB_VALUES = {
  ranges: [
    'De (A-C)',
    'De (D-F)',
    'De (G-I)',
    'De (J-L)',
    'De (M-Ñ)',
    'De (O-Q)',
    'De (R-T)',
    'De (U-W)',
    'De (X-Z)',
  ] as const,

  cities: [
    'Beni',
    'Chuquisaca',
    'Cochabamba',
    'La Paz',
    'Oruro',
    'Pando',
    'Potosí',
    'Santa Cruz',
    'Tarija',
  ] as const,

  jobTypes: [
    'Albañil',
    'Carpintero',
    'Cerrajero',
    'Decorador',
    'Electricista',
    'Fontanero',
    'Fumigador',
    'Instalador',
    'Jardinero',
    'Limpiador',
    'Mecánico',
    'Montador',
    'Pintor',
    'Pulidor',
    'Soldador',
    'Techador',
    'Vidriero',
    'Yesero',
  ] as const,

  categories: [
    'Todos',
    'Albañil',
    'Carpintero',
    'Cerrajero',
    'Decorador',
    'Electricista',
    'Fontanero',
    'Fumigador',
    'Instalador',
    'Jardinero',
    'Limpiador',
    'Mecánico',
    'Montador',
    'Pintor',
    'Pulidor',
    'Soldador',
    'Techador',
    'Vidriero',
    'Yesero',
  ] as const,
} as const;

// Tipos derivados para TypeScript
export type RangeValue = (typeof DB_VALUES.ranges)[number];
export type CityValue = (typeof DB_VALUES.cities)[number];
export type JobTypeValue = (typeof DB_VALUES.jobTypes)[number];
export type CategoryValue = (typeof DB_VALUES.categories)[number];
</file>

<file path="src/app/redux/contants/index.ts">
/**
 * Punto de entrada único para todas las constantes
 */
export * from './dbValues';
export * from './translations';

// Helper function para traducir valores DB
import { DB_TO_TRANSLATION_KEY, TranslatableValue, TranslationKey } from './translations';

export function getTranslationKey(dbValue: TranslatableValue): TranslationKey | null {
  return DB_TO_TRANSLATION_KEY[dbValue] ?? null;
}
</file>

<file path="src/app/redux/contants/translations.ts">
/**
 * Mapeo de valores de BD a keys de traducción
 * Usado para componentes que necesitan traducir valores del backend
 */
export const DB_TO_TRANSLATION_KEY = {
  // Rangos de nombres
  'De (A-C)': 'fixerName.ranges.ac',
  'De (D-F)': 'fixerName.ranges.df',
  'De (G-I)': 'fixerName.ranges.gi',
  'De (J-L)': 'fixerName.ranges.jl',
  'De (M-Ñ)': 'fixerName.ranges.mn',
  'De (O-Q)': 'fixerName.ranges.oq',
  'De (R-T)': 'fixerName.ranges.rt',
  'De (U-W)': 'fixerName.ranges.uw',
  'De (X-Z)': 'fixerName.ranges.xz',

  // Ciudades
  Beni: 'city.options.beni',
  Chuquisaca: 'city.options.chuquisaca',
  Cochabamba: 'city.options.cochabamba',
  'La Paz': 'city.options.laPaz',
  Oruro: 'city.options.oruro',
  Pando: 'city.options.pando',
  Potosí: 'city.options.potosi',
  'Santa Cruz': 'city.options.santaCruz',
  Tarija: 'city.options.tarija',

  // Tipos de trabajo
  Albañil: 'jobType.options.mason',
  Carpintero: 'jobType.options.carpenter',
  Cerrajero: 'jobType.options.locksmith',
  Decorador: 'jobType.options.decorator',
  Electricista: 'jobType.options.electrician',
  Fontanero: 'jobType.options.plumber',
  Fumigador: 'jobType.options.fumigator',
  Instalador: 'jobType.options.installer',
  Jardinero: 'jobType.options.gardener',
  Limpiador: 'jobType.options.cleaner',
  Mecánico: 'jobType.options.mechanic',
  Montador: 'jobType.options.assembler',
  Pintor: 'jobType.options.painter',
  Pulidor: 'jobType.options.polisher',
  Soldador: 'jobType.options.welder',
  Techador: 'jobType.options.roofer',
  Vidriero: 'jobType.options.glazier',
  Yesero: 'jobType.options.plasterer',

  // Categorías (para UI)
  Todos: 'Categories.Todos',
} as const;

export type TranslatableValue = keyof typeof DB_TO_TRANSLATION_KEY;
export type TranslationKey = (typeof DB_TO_TRANSLATION_KEY)[TranslatableValue];
</file>

<file path="src/app/redux/features/adv-search/useAdvSearchLogic.ts">
import { useEffect, useRef, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useAppSelector } from '@/app/redux/hooks';
import { useLazyGetOffersQuery } from '@/app/redux/services/jobOffersApi';
import { parsePriceRange } from '@/app/redux/features/jobOffers/parsers';

interface FilterStateLocal {
  range: string[];
  city: string[];
  category: string[];
  tags: string[];
  priceRanges: string[];
  minPrice: number | null;
  maxPrice: number | null;
}

type UpdateParams = {
  newRanges?: string[];
  newCity?: string[];
  newJobs?: string[];
  newCategories?: string[];
  newPriceRanges?: string[];
  newSearchQuery?: string;
  newPriceKey?: string;
  newTitleOnly?: boolean;
  newExactWords?: boolean;
};

/**
 * Hook principal para la lógica de Advanced Search
 * Maneja todo el estado local y la interacción con RTK Query
 */
export default function useAdvSearchLogic() {
  const [searchQuery, setSearchQuery] = useState('');
  const [titleOnly, setTitleOnlyState] = useState(false);
  const [exactWords, setExactWords] = useState(false);

  const [openSections, setOpenSections] = useState<{ [key: string]: boolean }>({
    fixer: false,
    ciudad: false,
    trabajo: false,
    categorias: false,
    precio: false,
  });

  const [selectedRanges, setSelectedRanges] = useState<string[]>([]);
  const [selectedCity, setSelectedCity] = useState<string[]>([]);
  const [selectedJobs, setSelectedJobs] = useState<string[]>([]);
  const [selectedCategories, setSelectedCategories] = useState<string[]>([]);
  const [selectedPriceRanges, setSelectedPriceRanges] = useState<string[]>([]);
  const [selectedTags, setSelectedTags] = useState<string[]>([]);
  const [selectedPriceKey, setSelectedPriceKey] = useState<string>('');
  const [resultsCount, setResultsCount] = useState<number | null>(null);

  // Date filter state: 'recent' | 'oldest' | 'specific'
  const [selectedDateFilter, setSelectedDateFilter] = useState<string>('specific');
  const [selectedSpecificDate, setSelectedSpecificDate] = useState<Date | null>(null);
  const [selectedRating, setSelectedRating] = useState<number | null>(null);

  const totalRegistros = useAppSelector((s) => s.jobOfert.totalRegistros);
  const storeLoading = useAppSelector((s) => s.jobOfert.loading);
  const router = useRouter();
  const skipSyncRef = useRef<boolean | null>(null);
  const [clearSignal, setClearSignal] = useState<number>(0);

  // ✅ RTK Query: lazy query para el contador de resultados
  const [triggerGetOffers, { data: offersData, isLoading: isQueryLoading }] =
    useLazyGetOffersQuery();

  const toggleSection = (section: string) => {
    setOpenSections((prev) => ({ ...prev, [section]: !prev[section] }));
  };

  const updateSearchOnStateChange = ({
    newRanges = selectedRanges,
    newCity = selectedCity,
    newJobs = selectedJobs,
    newCategories = selectedCategories,
    newPriceRanges = selectedPriceRanges,
    newSearchQuery = searchQuery,
    newPriceKey = selectedPriceKey,
  }: UpdateParams = {}) => {
    if (
      !newSearchQuery &&
      newRanges.length === 0 &&
      newCity.length === 0 &&
      newJobs.length === 0 &&
      newCategories.length === 0 &&
      newPriceRanges.length === 0
    ) {
      setResultsCount(0);
      return;
    }

    const { minPrice, maxPrice } = parsePriceRange(newPriceKey ?? '');

    const currentFilters: FilterStateLocal = {
      range: newRanges,
      city: newCity,
      category: newJobs,
      tags: newCategories,
      priceRanges: newPriceRanges,
      minPrice,
      maxPrice,
    };

    // local optimistic state update
    setResultsCount(null);

    return currentFilters;
  };

  const handleRangeChange = (range: string) => {
    setSelectedRanges((prev) => {
      const newRanges = prev.includes(range) ? prev.filter((r) => r !== range) : [...prev, range];
      updateSearchOnStateChange({ newRanges });
      return newRanges;
    });
  };

  const handleCityChange = (city: string) => {
    setSelectedCity((prev) => {
      const newCity = prev.includes(city) ? prev.filter((c) => c !== city) : [...prev, city];
      updateSearchOnStateChange({ newCity });
      return newCity;
    });
  };

  const handleJobChange = (job: string) => {
    setSelectedJobs((prev) => {
      const newJobs = prev.includes(job) ? prev.filter((j) => j !== job) : [...prev, job];
      updateSearchOnStateChange({ newJobs });
      return newJobs;
    });
  };

  const handleDropdownChange = (filters: { categories: string[] }) => {
    const newTags = Array.isArray(filters.categories) ? filters.categories : [];
    setSelectedTags(newTags);
    updateSearchOnStateChange({ newCategories: newTags });
  };

  const handlePriceRangeChange = (filters: { priceRanges: string[]; priceKey?: string }) => {
    const newPriceRanges = Array.isArray(filters.priceRanges) ? filters.priceRanges : [];
    setSelectedPriceRanges(newPriceRanges);
    if (filters.priceKey && typeof filters.priceKey === 'string') {
      setSelectedPriceKey(filters.priceKey);
      updateSearchOnStateChange({ newPriceRanges, newPriceKey: filters.priceKey });
    } else {
      setSelectedPriceKey('');
      updateSearchOnStateChange({ newPriceRanges, newPriceKey: '' });
    }
  };

  const fetchGlobalTotal = () => {
    // ✅ RTK Query: trigger query para obtener el total global
    triggerGetOffers({
      search: '',
      filters: { range: [], city: [], category: [], tags: [], minPrice: null, maxPrice: null },
      sortBy: 'recent',
      page: 1,
      limit: 1,
    });
  };

  // On mount: restore state from URL if present
  useEffect(() => {
    if (typeof window === 'undefined') return;
    const sp = new URLSearchParams(window.location.search);
    if (!sp.toString()) return;

    if (skipSyncRef) skipSyncRef.current = true;

    const search = sp.get('search');
    if (search != null) setSearchQuery(search);
    const titleOnlyP = sp.get('titleOnly');
    if (titleOnlyP != null) setTitleOnlyState(titleOnlyP === 'true');
    const exactP = sp.get('exact');
    if (exactP != null) setExactWords(exactP === 'true');

    const ranges = sp.getAll('range');
    if (ranges.length) setSelectedRanges(ranges);

    const cityRaw = sp.get('city');
    if (cityRaw != null) {
      const cities = cityRaw
        .split(',')
        .map((s) => s.trim())
        .filter(Boolean);
      if (cities.length) setSelectedCity(cities);
    }

    const categoriesFromAll = sp.getAll('category') || [];
    let urlCategory: string[] = [];
    if (categoriesFromAll.length) {
      urlCategory = categoriesFromAll
        .flatMap((s) => (typeof s === 'string' ? s.split(',') : []))
        .map((s) => s.trim())
        .filter(Boolean);
    } else {
      const cat = sp.get('category');
      if (cat != null)
        urlCategory = cat
          .split(',')
          .map((s) => s.trim())
          .filter(Boolean);
    }
    if (urlCategory.length) setSelectedJobs(urlCategory);

    const tagsFromAll = sp.getAll('tags') || [];
    let urlTags: string[] = [];
    if (tagsFromAll.length) {
      urlTags = tagsFromAll
        .flatMap((s) => (typeof s === 'string' ? s.split(',') : []))
        .map((s) => s.trim())
        .filter(Boolean);
    } else {
      const t = sp.get('tags');
      if (t != null)
        urlTags = t
          .split(',')
          .map((s) => s.trim())
          .filter(Boolean);
    }
    if (urlTags.length) setSelectedTags(urlTags);

    const min = sp.get('minPrice');
    const max = sp.get('maxPrice');
    if (min || max) setSelectedPriceKey(`${min ?? ''}${min && max ? ' - ' : ''}${max ?? ''}`);

    const sort = sp.get('sortBy') ?? sp.get('sort');
    if (sort === 'recent') setSelectedDateFilter('recent');
    else if (sort === 'oldest') setSelectedDateFilter('oldest');
    else {
      const date = sp.get('date');
      if (date) {
        setSelectedDateFilter('specific');
        const d = new Date(date);
        if (!Number.isNaN(d.getTime())) setSelectedSpecificDate(d);
      }
    }

    const rating = sp.get('rating');
    if (rating != null) {
      const r = Number(rating);
      if (!Number.isNaN(r)) {
        // Limitar el rating entre 1 y 5
        const clampedRating = Math.min(5, Math.max(1, r));
        setSelectedRating(clampedRating);
      }
    }

    const shouldOpenFixer = ranges.length > 0;
    const shouldOpenCiudad = !!cityRaw;
    const shouldOpenTrabajo = !!(urlCategory && urlCategory.length);
    const shouldOpenCategorias = !!(urlTags && urlTags.length);
    const shouldOpenPrecio = !!(min || max);

    setOpenSections((prev) => ({
      ...prev,
      fixer: shouldOpenFixer || prev.fixer,
      ciudad: shouldOpenCiudad || prev.ciudad,
      trabajo: shouldOpenTrabajo || prev.trabajo,
      categorias: shouldOpenCategorias || prev.categorias,
      precio: shouldOpenPrecio || prev.precio,
    }));
  }, []);

  const handleSearch = (query: string) => {
    setSearchQuery(query);
    skipSyncRef.current = true;
    const params = new URLSearchParams();
    if (query.trim()) params.set('search', query.trim());
    if (titleOnly) params.set('titleOnly', 'true');
    if (exactWords) params.set('exact', 'true');
    selectedRanges.forEach((r) => params.append('range', r));
    if (selectedCity.length) params.set('city', selectedCity.join(','));
    if (selectedJobs.length) params.set('category', selectedJobs.join(','));
    if (selectedTags.length) params.set('tags', selectedTags.join(','));
    const { minPrice, maxPrice } = parsePriceRange(selectedPriceKey);

    if (selectedDateFilter === 'recent') {
      params.set('sortBy', 'recent');
    } else if (selectedDateFilter === 'oldest') {
      params.set('sortBy', 'oldest');
    } else if (selectedDateFilter === 'specific' && selectedSpecificDate) {
      const y = selectedSpecificDate.getFullYear();
      const m = String(selectedSpecificDate.getMonth() + 1).padStart(2, '0');
      const d = String(selectedSpecificDate.getDate()).padStart(2, '0');
      params.set('date', `${y}-${m}-${d}`);
    }
    if (minPrice != null) params.set('minPrice', String(minPrice));
    if (maxPrice != null) params.set('maxPrice', String(maxPrice));
    // Limitar el rating entre 1 y 5 al hacer búsqueda
    if (selectedRating != null) {
      const clampedRating = Math.min(5, Math.max(1, selectedRating));
      params.set('rating', String(clampedRating));
    }
    params.set('page', '1');
    params.set('limit', '10');

    if (typeof window !== 'undefined') {
      try {
        window.sessionStorage.setItem('fromAdv', 'true');
      } catch {
        // ignore
      }
      params.set('fromAdv', 'true');

      try {
        const state = {
          search: searchQuery,
          titleOnly,
          exact: exactWords,
          selectedRanges,
          selectedCity,
          selectedJobs,
          selectedTags,
          selectedPriceKey,
          selectedDateFilter,
          selectedSpecificDate: selectedSpecificDate ? selectedSpecificDate.toISOString() : null,
          selectedRating,
        };
        window.sessionStorage.setItem('advSearch_state', JSON.stringify(state));
      } catch {
        // ignore
      }

      window.location.href = `/resultsAdvSearch?${params.toString()}`;
    } else {
      params.set('fromAdv', 'true');
      router.push(`/resultsAdvSearch?${params.toString()}`);
    }
  };

  // ✅ Initial fetch: global total usando RTK Query
  useEffect(() => {
    triggerGetOffers({
      search: '',
      filters: { range: [], city: [], category: [], tags: [], minPrice: null, maxPrice: null },
      sortBy: 'recent',
      page: 1,
      limit: 1,
    });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // ✅ Debounced fetch cuando cambian los filtros usando RTK Query
  useEffect(() => {
    const { minPrice, maxPrice } = parsePriceRange(selectedPriceKey);
    const apiFilters = {
      range: selectedRanges,
      city: selectedCity,
      category: selectedJobs,
      tags: selectedTags,
      minPrice,
      maxPrice,
    };

    let dateParam: string | undefined = undefined;
    let sortParam = 'recent';
    if (selectedDateFilter === 'recent') sortParam = 'recent';
    else if (selectedDateFilter === 'oldest') sortParam = 'oldest';
    else if (selectedDateFilter === 'specific' && selectedSpecificDate) {
      const y = selectedSpecificDate.getFullYear();
      const m = String(selectedSpecificDate.getMonth() + 1).padStart(2, '0');
      const d = String(selectedSpecificDate.getDate()).padStart(2, '0');
      dateParam = `${y}-${m}-${d}`;
    }

    const t = window.setTimeout(() => {
      triggerGetOffers({
        search: searchQuery ?? '',
        filters: apiFilters,
        sortBy: sortParam,
        date: dateParam,
        rating: selectedRating ?? undefined,
        page: 1,
        limit: 1,
        titleOnly: titleOnly ?? false,
        exact: exactWords ?? false,
      });
    }, 150);

    return () => clearTimeout(t);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [
    searchQuery,
    selectedRanges,
    selectedCity,
    selectedJobs,
    selectedTags,
    selectedPriceRanges,
    selectedPriceKey,
    titleOnly,
    exactWords,
    selectedDateFilter,
    selectedSpecificDate,
    selectedRating,
  ]);

  // ✅ Actualizar resultsCount cuando llega la respuesta de RTK Query
  useEffect(() => {
    if (offersData) {
      setResultsCount(offersData.total);
    }
  }, [offersData]);

  return {
    // state
    searchQuery,
    titleOnly,
    exactWords,
    openSections,
    selectedRanges,
    selectedCity,
    selectedJobs,
    selectedCategories,
    selectedPriceRanges,
    selectedTags,
    selectedPriceKey,
    resultsCount,
    loading: isQueryLoading,
    totalRegistros,
    storeLoading,
    clearSignal,
    skipSyncRef,
    // setters / handlers
    setSearchQuery,
    setTitleOnly: setTitleOnlyState,
    setExactWords,
    toggleSection,
    handleRangeChange,
    handleCityChange,
    handleJobChange,
    handleDropdownChange,
    handlePriceRangeChange,
    handleSearch,
    setClearSignal,
    updateSearchOnStateChange,
    // expose specific setters used by page clear action
    setSelectedRanges,
    setSelectedCity,
    setSelectedJobs,
    setSelectedCategories,
    setSelectedPriceRanges,
    setSelectedPriceKey,
    setResultsCount,
    // date filter API
    selectedDateFilter,
    setSelectedDateFilter,
    selectedSpecificDate,
    setSelectedSpecificDate,
    // rating
    selectedRating,
    setSelectedRating,
    fetchGlobalTotal,
  };
}
</file>

<file path="src/app/redux/features/adv-search/useSyncUrlParams.ts">
// src/app/AdvSearch/hooks/useSyncUrlParamsAdv.ts
import { useEffect } from 'react';
import { useRouter } from 'next/navigation';

import { MutableRefObject } from 'react';

interface Params {
  search?: string;
  filters?: {
    range?: string[];
    city?: string[];
    category?: string[];
    tags?: string[];
    minPrice?: number | null;
    maxPrice?: number | null;
  };
  titleOnly?: boolean;
  exact?: boolean;
  date?: string | null;
  rating?: number | null;
  sortBy?: string | null;
  page?: number;
  limit?: number;
  // optional ref to temporarily skip syncing (set true before navigation)
  skipSyncRef?: MutableRefObject<boolean | null>;
}

export const useSyncUrlParamsAdv = (p: Params) => {
  const router = useRouter();
  // Destructure once so we can use stable primitives in deps
  const { search, filters, titleOnly, exact, date, sortBy, page, limit, skipSyncRef } = p;
  // rating is declared on Params; use it directly to avoid `any` casts
  const rating: number | null | undefined = p.rating;

  // Extract nested filter properties to satisfy exhaustive-deps
  const filterRange = filters?.range;
  const filterCity = filters?.city;
  const filterCategory = filters?.category;
  const filterTags = filters?.tags;
  const filterMinPrice = filters?.minPrice;
  const filterMaxPrice = filters?.maxPrice;

  useEffect(() => {
    // If parent signals skipping sync (e.g. about to navigate), consume the flag and skip one run
    if (skipSyncRef && skipSyncRef.current) {
      // reset flag and skip this sync to avoid overriding navigation
      skipSyncRef.current = false;
      return;
    }

    const hasAny = !!(
      (search && search.trim() !== '') ||
      titleOnly ||
      exact ||
      (date && date.trim() !== '') ||
      (sortBy && sortBy.trim() !== '') ||
      rating != null ||
      (filterRange && filterRange.length) ||
      filterCity ||
      (filterCategory && filterCategory.length) ||
      (filterTags && filterTags.length) ||
      filterMinPrice != null ||
      filterMaxPrice != null
    );

    const params = new URLSearchParams();
    if (search && search.trim()) params.set('search', search.trim());
    if (titleOnly) params.set('titleOnly', 'true');
    if (exact) params.set('exact', 'true');
    filterRange?.forEach((r) => params.append('range', r));
    if (filterCity && filterCity.length) params.set('city', filterCity.join(','));
    if (filterCategory && filterCategory.length) params.set('category', filterCategory.join(','));
    if (filterTags && filterTags.length) params.set('tags', filterTags.join(','));
    if (filterMinPrice != null) params.set('minPrice', String(filterMinPrice));
    if (filterMaxPrice != null) params.set('maxPrice', String(filterMaxPrice));
    if (date) params.set('date', date);
    if (rating != null) params.set('rating', String(rating));
    if (sortBy) params.set('sort', sortBy);
    if (page != null) params.set('page', String(page));
    if (limit != null) params.set('limit', String(limit));

    const qs = params.toString();
    // Use relative query update like job-offer: replace only the search part (keeps pathname)
    const targetSearch = qs ? `?${qs}` : '';

    // If nothing is active, ensure the search is cleared
    if (!hasAny) {
      if (typeof window !== 'undefined' && window.location.search === '') return;
      router.replace(targetSearch, { scroll: false });
      if (typeof window !== 'undefined' && window.location.search !== targetSearch) {
        try {
          window.history.replaceState(null, '', window.location.pathname + targetSearch);
        } catch {
          /* noop */
        }
      }
      return;
    }

    // Avoid replacing if search already matches target (prevents unnecessary navigation)
    if (typeof window !== 'undefined' && window.location.search === targetSearch) return;

    // update Next router and ensure browser address bar shows the search
    router.replace(targetSearch, { scroll: false });
    if (typeof window !== 'undefined' && window.location.search !== targetSearch) {
      try {
        window.history.replaceState(null, '', window.location.pathname + targetSearch);
      } catch {
        /* noop */
      }
    }
  }, [
    search,
    titleOnly,
    exact,
    date,
    sortBy,
    page,
    limit,
    rating,
    router,
    skipSyncRef,
    filterRange,
    filterCity,
    filterCategory,
    filterTags,
    filterMinPrice,
    filterMaxPrice,
  ]);
};
export default useSyncUrlParamsAdv;
</file>

<file path="src/app/redux/features/jobOffers/jobOffersHooks.ts">
import { useEffect, useRef, useState } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useAppDispatch, useAppSelector } from '@/app/redux/hooks';
import { useGetOffersQuery } from '@/app/redux/services/jobOffersApi';
import { FetchBaseQueryError } from '@reduxjs/toolkit/query';
import {
  setSearch,
  setFilters,
  setSortBy,
  setDate,
  setRating,
  setPaginaActual,
  setRegistrosPorPagina,
  setTitleOnly,
  setExact,
  updatePagination,
  //restoreSavedState,
  resetFilters,
  enablePersistence,
  setError,
} from '@/app/redux/slice/jobOfert';
import { selectSearchParams, selectJobOffersState } from './selectors';
import { parseUrlToFilters, filtersToUrlParams, parseAppliedParams } from './parsers';
// import { restoreFromStorage } from './storage';
import {
  isFromAdvSearch,
  clearAdvSearchMark,
  saveAppliedFilters,
  getAppliedFilters,
  clearAppliedFilters,
} from './session';
import { ParamsMap } from './types';
import { JOBOFERT_ALLOWED_LIMITS } from '@/app/lib/validations/pagination.validator';
import { sanitizePage } from '@/app/lib/validations/pagination.validator'; //

/**
 * Hook principal que combina RTK Query con el slice de Redux
 */
export function useJobOffers() {
  const dispatch = useAppDispatch();
  const params = useAppSelector(selectSearchParams);
  const [skipQuery, setSkipQuery] = useState(false);
  const errorTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const shouldClearErrorRef = useRef(true);

  // ✅ Validar límite inválido (ANTES de la query)
  useEffect(() => {
    if (!JOBOFERT_ALLOWED_LIMITS.includes(params.limit)) {
      dispatch(
        setError(`Límite no permitido. Valores permitidos: ${JOBOFERT_ALLOWED_LIMITS.join(', ')}`),
      );
      setSkipQuery(true);
      shouldClearErrorRef.current = false;

      errorTimeoutRef.current = setTimeout(() => {
        dispatch(setRegistrosPorPagina(10));
        setSkipQuery(false);
        shouldClearErrorRef.current = true;
      }, 2500);

      return () => {
        if (errorTimeoutRef.current) clearTimeout(errorTimeoutRef.current);
      };
    }
  }, [params.limit, dispatch]);

  const { data, error, isLoading, isFetching } = useGetOffersQuery(
    {
      search: params.search,
      filters: params.filters,
      sortBy: params.sortBy,
      date: params.date || undefined,
      rating: params.rating || undefined,
      page: params.page,
      limit: params.limit,
      titleOnly: params.titleOnly,
      exact: params.exact,
    },
    {
      skip: skipQuery,
    },
  );

  // Validar página < 1 (DESPUÉS de declarar data)
  useEffect(() => {
    if (!data) return;

    const totalPages = Math.ceil(data.total / params.limit) || 1;
    const correctedPage = sanitizePage(params.page, totalPages);

    if (correctedPage !== params.page) {
      dispatch(setPaginaActual(correctedPage));
    }
  }, [params.page, params.limit, data, dispatch]);

  // Capturar error 400 del backend
  useEffect(() => {
    if (error && 'status' in error) {
      const fetchError = error as FetchBaseQueryError;

      if (fetchError.status === 400 && fetchError.data && typeof fetchError.data === 'object') {
        const message = (fetchError.data as { message?: string }).message;

        if (message) {
          dispatch(setError(message));
          shouldClearErrorRef.current = false;

          errorTimeoutRef.current = setTimeout(() => {
            dispatch(setPaginaActual(1));
            shouldClearErrorRef.current = true;
          }, 2500);

          return () => {
            if (errorTimeoutRef.current) clearTimeout(errorTimeoutRef.current);
          };
        }
      }
    }
  }, [error, dispatch]);

  // ✅ Actualizar paginación
  useEffect(() => {
    if (data) {
      const totalPages = Math.ceil(data.total / params.limit) || 1;

      dispatch(
        updatePagination({
          total: data.total,
          page: params.page,
          limit: params.limit,
          totalPages,
          isInitialSearch: params.page === 1,
        }),
      );

      if (shouldClearErrorRef.current) {
        dispatch(setError(null));
      }
    }

    return () => {
      if (errorTimeoutRef.current) clearTimeout(errorTimeoutRef.current);
    };
  }, [data, dispatch, params.page, params.limit]);

  return {
    offers: data?.data || [],
    total: data?.total || 0,
    isLoading: isLoading || isFetching,
  };
}

/**
 * Hook para inicializar desde URL en el primer render
 */
export function useInitialUrlParams() {
  const searchParams = useSearchParams();
  const dispatch = useAppDispatch();
  const hasInitialized = useRef(false);

  useEffect(() => {
    if (hasInitialized.current) return;
    hasInitialized.current = true;

    if ([...searchParams.keys()].length > 0) {
      const parsed = parseUrlToFilters(searchParams);

      dispatch(setSearch(parsed.search));
      dispatch(setFilters(parsed.filters));
      dispatch(setSortBy(parsed.sortBy));
      dispatch(setDate(parsed.date));
      dispatch(setRating(parsed.rating));
      dispatch(setTitleOnly(parsed.titleOnly));
      dispatch(setExact(parsed.exact));
      dispatch(setRegistrosPorPagina(parsed.limit));
      dispatch(setPaginaActual(parsed.page));
      dispatch(enablePersistence());
    } else {
      // const restored = restoreFromStorage();

      // 🔧 MIGRACIÓN: Convertir city de string a string[]
      // const migratedState = {
      //   ...restored,
      //   filters: {
      // ...restored.filters,
      // city: (() => {
      // const cityValue = restored.filters.city;
      // Si es string, convertir a array
      // if (typeof cityValue === 'string') {
      //   return cityValue ? [cityValue] : [];
      // }
      // Si ya es array, usar tal cual
      // if (Array.isArray(cityValue)) {
      //   return cityValue;
      // }
      // Fallback
      //     return [];
      //   })(),
      // },
      // };

      // dispatch(restoreSavedState(migratedState));
      dispatch(enablePersistence());
    }
  }, [searchParams, dispatch]);
}

/**
 * Hook para sincronizar Redux state con URL
 */
export function useSyncUrlParams() {
  const router = useRouter();
  const params = useAppSelector(selectSearchParams);
  const prevParamsRef = useRef<string>('');

  useEffect(() => {
    const currentParams = JSON.stringify(params);

    if (currentParams === prevParamsRef.current) return;
    prevParamsRef.current = currentParams;

    const urlParams = filtersToUrlParams({
      search: params.search,
      filters: params.filters,
      sortBy: params.sortBy,
      date: params.date,
      rating: params.rating,
      page: params.page,
      limit: params.limit,
      titleOnly: params.titleOnly,
      exact: params.exact,
    });

    const queryString = urlParams.toString();
    const target = queryString ? `?${queryString}` : '';

    router.replace(target, { scroll: false });
  }, [params, router]);
}

/**
 * Hook para manejar el reset de filtros
 */
export function useResetFilters() {
  const dispatch = useAppDispatch();

  const handleReset = () => {
    dispatch(resetFilters());
    setTimeout(() => {
      dispatch(enablePersistence());
    }, 0);
  };

  return handleReset;
}

/**
 * Hook para obtener el estado completo de jobOffers
 */
export function useJobOffersState() {
  return useAppSelector(selectJobOffersState);
}

/**
 * Hook para manejar Applied Filters en ResultsAdvSearch
 */
export function useAppliedFilters() {
  const [showAppliedFilters, setShowAppliedFilters] = useState<boolean>(false);
  const [appliedParams, setAppliedParams] = useState<ParamsMap | null>(null);
  const dispatch = useAppDispatch();

  useEffect(() => {
    if (typeof window === 'undefined') return;

    try {
      if (isFromAdvSearch()) {
        const sp = new URLSearchParams(window.location.search);
        const params = parseAppliedParams(sp);

        setAppliedParams(params);
        setShowAppliedFilters(true);
        saveAppliedFilters(params);
        clearAdvSearchMark();
      } else {
        const saved = getAppliedFilters();
        if (saved) {
          setAppliedParams(saved);
          setShowAppliedFilters(true);
        }
      }
    } catch (error) {
      console.error('Error loading applied filters:', error);
    }
  }, []);

  const handleClearApplied = () => {
    setShowAppliedFilters(false);
    setAppliedParams(null);
    dispatch(resetFilters());
    clearAppliedFilters();

    if (typeof window !== 'undefined') {
      window.location.href = '/job-offer-list';
    }
  };

  return {
    showAppliedFilters,
    appliedParams,
    handleClearApplied,
  };
}
</file>

<file path="src/app/redux/features/jobOffers/navigation.ts">
import { filtersToUrlParams } from './parsers';
import { markFromAdvSearch, saveAdvSearchState, type AdvSearchState } from './session';
import { FilterState } from './types';

/**
 * Navegación desde AdvSearch a ResultsAdvSearch
 */
export function navigateToResults(params: {
  search: string;
  filters: FilterState;
  sortBy: string;
  date?: string | null;
  rating?: number | null;
  titleOnly?: boolean;
  exact?: boolean;
  // Estado completo de AdvSearch para persistir
  advSearchState?: AdvSearchState;
}) {
  const urlParams = filtersToUrlParams({
    search: params.search,
    filters: params.filters,
    sortBy: params.sortBy,
    date: params.date,
    rating: params.rating,
    titleOnly: params.titleOnly,
    exact: params.exact,
    page: 1,
    limit: 10,
  });

  // Marcar que viene de búsqueda avanzada
  markFromAdvSearch();

  // Agregar flag a URL
  urlParams.set('fromAdv', 'true');

  // Persistir estado de AdvSearch si se proporciona
  if (params.advSearchState) {
    saveAdvSearchState(params.advSearchState);
  }

  // Navegar
  if (typeof window !== 'undefined') {
    window.location.href = `/resultsAdvSearch?${urlParams.toString()}`;
  }
}

/**
 * Navegación limpia a JobOffer (sin parámetros)
 */
export function navigateToJobOfferClean() {
  if (typeof window !== 'undefined') {
    window.location.href = '/job-offer-list';
  }
}

/**
 * Navegación a JobOffer con parámetros
 */
export function navigateToJobOffer(params: {
  search?: string;
  filters?: FilterState;
  sortBy?: string;
  date?: string | null;
  rating?: number | null;
  page?: number;
  limit?: number;
  titleOnly?: boolean;
  exact?: boolean;
}) {
  const urlParams = filtersToUrlParams(params);
  const queryString = urlParams.toString();
  const target = queryString ? `/job-offer?${queryString}` : '/job-offer';

  if (typeof window !== 'undefined') {
    window.location.href = target;
  }
}

/**
 * Actualizar URL sin navegación completa
 */
export function updateUrlParams(params: {
  search?: string;
  filters?: FilterState;
  sortBy?: string;
  date?: string | null;
  rating?: number | null;
  page?: number;
  limit?: number;
  titleOnly?: boolean;
  exact?: boolean;
}) {
  if (typeof window === 'undefined') return;

  const urlParams = filtersToUrlParams(params);
  const queryString = urlParams.toString();
  const targetSearch = queryString ? `?${queryString}` : '';

  // Solo actualizar si es diferente
  if (window.location.search !== targetSearch) {
    try {
      window.history.replaceState(null, '', window.location.pathname + targetSearch);
    } catch (error) {
      console.error('Error updating URL:', error);
    }
  }
}
</file>

<file path="src/app/redux/features/jobOffers/parsers.ts">
import { FilterState, ParamsMap } from './types';

/**
 * Parsear rango de precio desde string
 */
export function parsePriceRange(key: string): { minPrice: number | null; maxPrice: number | null } {
  if (!key) return { minPrice: null, maxPrice: null };
  const normalized = key.replace(/[$€£,]/g, '').trim();
  const lowerLabel = normalized.toLowerCase();
  const matches = normalized.match(/-?\d+(?:\.\d+)?/g) || [];

  // Detect "Menos de" (less than) => max = number
  if (/(^|\s)menos(\s|$)|menos\s+de|^<\s*/i.test(lowerLabel)) {
    if (matches[0]) return { minPrice: null, maxPrice: Number(matches[0]) };
    return { minPrice: null, maxPrice: null };
  }

  // Detect "Más de" (greater than) => min = number
  if (/(^|\s)m(a|á)s(\s|$)|m(a|á)s\s+de|^>\s*/i.test(lowerLabel)) {
    if (matches[0]) return { minPrice: Number(matches[0]), maxPrice: null };
    return { minPrice: null, maxPrice: null };
  }

  // Range with two numbers
  if (matches.length >= 2) return { minPrice: Number(matches[0]), maxPrice: Number(matches[1]) };

  // Single number without qualifiers -> treat as min (>=)
  if (matches.length === 1) return { minPrice: Number(matches[0]), maxPrice: null };

  return { minPrice: null, maxPrice: null };
}

/**
 * Parsear parámetros de URL a filtros
 */
export function parseUrlToFilters(searchParams: URLSearchParams): {
  search: string;
  filters: FilterState;
  sortBy: string;
  page: number;
  limit: number;
  titleOnly: boolean;
  exact: boolean;
  date: string | null;
  rating: number | null;
} {
  const search = searchParams.get('search') || '';
  const ranges = searchParams.getAll('range');
  const cityRaw = searchParams.get('city') || '';
  const city = cityRaw ? cityRaw.split(',').filter(Boolean) : [];
  const categoryRaw = searchParams.get('category') || '';
  const category = categoryRaw ? categoryRaw.split(',').filter(Boolean) : [];

  const tagsRaw = searchParams.get('tags') || '';
  const tags = tagsRaw ? tagsRaw.split(',').filter(Boolean) : [];

  const minPriceRaw = searchParams.get('minPrice');
  const maxPriceRaw = searchParams.get('maxPrice');
  const minPrice = minPriceRaw != null ? Number(minPriceRaw) : null;
  const maxPrice = maxPriceRaw != null ? Number(maxPriceRaw) : null;

  const page = parseInt(searchParams.get('page') || '1', 10) || 1;
  const limit = parseInt(searchParams.get('limit') || '10', 10) || 10;

  const sortBy = searchParams.get('sort') || searchParams.get('sortBy') || 'recent';

  const titleOnly = searchParams.get('titleOnly') === 'true';
  const exact = searchParams.get('exact') === 'true' || searchParams.get('exactWords') === 'true';

  const date = searchParams.get('date') || null;

  const ratingRaw = searchParams.get('rating');
  const rating =
    ratingRaw != null ? (Number.isNaN(Number(ratingRaw)) ? null : Number(ratingRaw)) : null;

  // ✅ NUEVO: Detectar si la categoría fue automarcada desde búsqueda
  const isAutoSelectedCategory = search.trim() !== '' && category.length > 0;
  // ✅ NUEVO: Detectar si la ciudad fue automarcada desde búsqueda
  const isAutoSelectedCity = search.trim() !== '' && city.length > 0;

  return {
    search,
    filters: {
      range: ranges,
      city,
      category,
      tags,
      minPrice,
      maxPrice,
      isAutoSelectedCategory, // ✅ Agregado
      isAutoSelectedCity, // ✅ Agregado
    },
    sortBy,
    page,
    limit,
    titleOnly,
    exact,
    date,
    rating,
  };
}

/**
 * Parsear parámetros aplicados desde URL (para AppliedFilters)
 */
export function parseAppliedParams(searchParams: URLSearchParams): ParamsMap {
  const params: ParamsMap = {};

  const keys = [
    'search',
    'titleOnly',
    'exact',
    'tags',
    'category',
    'city',
    'minPrice',
    'maxPrice',
    'range',
    'date',
    'sortBy',
    'rating',
  ];

  keys.forEach((k) => {
    // Special-case `range`: it may appear multiple times in the query string
    if (k === 'range') {
      const all = searchParams.getAll('range') || [];
      if (all.length) {
        params[k] = all.filter(Boolean);
      }
      return;
    }

    const val = searchParams.get(k);
    if (val == null) return;

    if (k === 'tags' || k === 'category') {
      // these are encoded as a single, comma-separated value by AdvSearch
      params[k] = val.split(',').filter(Boolean);
    } else if (k === 'titleOnly' || k === 'exact') {
      params[k] = val === 'true';
    } else if (k === 'minPrice' || k === 'maxPrice') {
      const n = Number(val);
      params[k] = Number.isNaN(n) ? null : n;
    } else if (k === 'date') {
      // keep raw date string (YYYY-MM-DD) => display handled by AppliedFilters
      params[k] = val;
    } else if (k === 'rating') {
      const r = Number(val);
      params[k] = Number.isNaN(r) ? null : r;
    } else {
      params[k] = val;
    }
  });

  return params;
}

/**
 * Convertir filtros a URLSearchParams
 */
export function filtersToUrlParams(params: {
  search?: string;
  filters?: FilterState;
  sortBy?: string;
  page?: number;
  limit?: number;
  titleOnly?: boolean;
  exact?: boolean;
  date?: string | null;
  rating?: number | null;
  totalRegistros?: number;
  totalPages?: number;
}): URLSearchParams {
  const urlParams = new URLSearchParams();

  if (params.search?.trim()) urlParams.set('search', params.search.trim());
  if (params.titleOnly) urlParams.set('titleOnly', 'true');
  if (params.exact) urlParams.set('exact', 'true');

  if (params.filters?.range?.length) {
    params.filters.range.forEach((r) => urlParams.append('range', r));
  }
  if (params.filters?.city?.length) {
    urlParams.set('city', params.filters.city.join(','));
  }
  if (params.filters?.category?.length) {
    urlParams.set('category', params.filters.category.join(','));
  }
  if (params.filters?.tags?.length) {
    urlParams.set('tags', params.filters.tags.join(','));
  }
  if (params.filters?.minPrice != null) {
    urlParams.set('minPrice', String(params.filters.minPrice));
  }
  if (params.filters?.maxPrice != null) {
    urlParams.set('maxPrice', String(params.filters.maxPrice));
  }

  if (params.sortBy) urlParams.set('sort', params.sortBy);
  if (params.date) urlParams.set('date', params.date);
  if (params.rating != null) urlParams.set('rating', String(params.rating));
  if (params.page != null) urlParams.set('page', String(params.page));
  if (params.limit != null) urlParams.set('limit', String(params.limit));
  if (params.totalRegistros != null) urlParams.set('total', String(params.totalRegistros));
  if (params.totalPages != null) urlParams.set('totalPages', String(params.totalPages));
  return urlParams;
}

/**
 * Formatear fecha para display
 */
export function formatDateForDisplay(dateStr: string | null): string {
  if (!dateStr) return '';
  try {
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return dateStr;
    return date.toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  } catch {
    return dateStr;
  }
}

/**
 * Formatear fecha a YYYY-MM-DD
 */
export function formatDateToISO(date: Date | null): string | null {
  if (!date) return null;
  try {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  } catch {
    return null;
  }
}
</file>

<file path="src/app/redux/features/jobOffers/selectors.ts">
// src\app\redux\hook\jobOffersSelectors.ts
import { JobOffersState, PaginationState } from './types';
import { createSelector } from '@reduxjs/toolkit';

type RootState = { jobOfert: JobOffersState };

export const selectPaginationByKey = (
  state: RootState,
  key: string = 'offers',
): PaginationState => {
  return (
    state.jobOfert.paginaciones[key] ?? {
      paginaActual: 1,
      registrosPorPagina: 10,
      totalRegistros: 0,
      totalPages: 0,
    }
  );
};

export const selectJobOffersState = (state: RootState) => state.jobOfert;

export const selectFilters = (state: RootState) => state.jobOfert.filters;

export const selectSearch = (state: RootState) => state.jobOfert.search;

export const selectSortBy = (state: RootState) => state.jobOfert.sortBy;

export const selectPaginaActual = (state: RootState) => state.jobOfert.paginaActual;

export const selectRegistrosPorPagina = (state: RootState) => state.jobOfert.registrosPorPagina;

export const selectTotalRegistros = (state: RootState) => state.jobOfert.totalRegistros;

export const selectTotalPages = (state: RootState) => state.jobOfert.totalPages;

export const selectDate = (state: RootState) => state.jobOfert.date;

export const selectRating = (state: RootState) => state.jobOfert.rating;

export const selectTitleOnly = (state: RootState) => state.jobOfert.titleOnly;

export const selectExact = (state: RootState) => state.jobOfert.exact;

export const selectLoading = (state: RootState) => state.jobOfert.loading;

export const selectError = (state: RootState) => state.jobOfert.error;

export const selectShouldPersist = (state: RootState) => state.jobOfert.shouldPersist;

// Selector compuesto para obtener todos los parámetros de búsqueda
export const selectSearchParams = createSelector(
  [
    (state: RootState) => state.jobOfert.search,
    (state: RootState) => state.jobOfert.filters,
    (state: RootState) => state.jobOfert.sortBy,
    (state: RootState) => state.jobOfert.date,
    (state: RootState) => state.jobOfert.rating,
    (state: RootState) => state.jobOfert.paginaActual,
    (state: RootState) => state.jobOfert.registrosPorPagina,
    (state: RootState) => state.jobOfert.titleOnly,
    (state: RootState) => state.jobOfert.exact,
  ],
  (search, filters, sortBy, date, rating, page, limit, titleOnly, exact) => ({
    search,
    filters,
    sortBy,
    date,
    rating,
    page,
    limit,
    titleOnly,
    exact,
  }),
);
</file>

<file path="src/app/redux/features/jobOffers/session.ts">
import { ParamsMap, FilterState } from './types';

export const SESSION_KEYS = {
  FROM_ADV: 'fromAdv',
  APPLIED_FILTERS: 'appliedFilters',
  ADV_SEARCH_STATE: 'advSearch_state',
} as const;

// Define el tipo para el estado de AdvSearch
export interface AdvSearchState {
  search: string;
  filters: FilterState;
  sortBy: string;
  date?: string | null;
  rating?: number | null;
  titleOnly?: boolean;
  exact?: boolean;
  // Agrega aquí otras propiedades adicionales si las necesitas
}

/**
 * Helper para leer sessionStorage de forma segura
 */
export const getSessionValue = <T>(key: string, defaultValue: T): T => {
  if (typeof window === 'undefined') return defaultValue;
  try {
    const item = window.sessionStorage.getItem(key);
    return item ? (JSON.parse(item) as T) : defaultValue;
  } catch (error) {
    console.error(`Error reading sessionStorage key "${key}":`, error);
    return defaultValue;
  }
};

/**
 * Helper para guardar en sessionStorage
 */
export const saveToSession = <T>(key: string, value: T): void => {
  if (typeof window !== 'undefined') {
    try {
      sessionStorage.setItem(key, JSON.stringify(value));
    } catch (error) {
      console.error(`Error saving to sessionStorage key "${key}":`, error);
    }
  }
};

/**
 * Helper para eliminar de sessionStorage
 */
export const removeFromSession = (key: string): void => {
  if (typeof window !== 'undefined') {
    try {
      sessionStorage.removeItem(key);
    } catch (error) {
      console.error(`Error removing from sessionStorage key "${key}":`, error);
    }
  }
};

/**
 * Marcar que viene de búsqueda avanzada
 */
export const markFromAdvSearch = (): void => {
  saveToSession(SESSION_KEYS.FROM_ADV, 'true');
};

/**
 * Verificar si viene de búsqueda avanzada
 */
export const isFromAdvSearch = (): boolean => {
  if (typeof window === 'undefined') return false;
  try {
    const fromStorage = window.sessionStorage.getItem(SESSION_KEYS.FROM_ADV);
    const sp = new URLSearchParams(window.location.search);
    const fromUrl = sp.get('fromAdv');
    return fromStorage === 'true' || fromUrl === 'true';
  } catch {
    return false;
  }
};

/**
 * Limpiar marca de búsqueda avanzada
 */
export const clearAdvSearchMark = (): void => {
  removeFromSession(SESSION_KEYS.FROM_ADV);
};

/**
 * Guardar filtros aplicados
 */
export const saveAppliedFilters = (params: ParamsMap): void => {
  saveToSession(SESSION_KEYS.APPLIED_FILTERS, params);
};

/**
 * Obtener filtros aplicados
 */
export const getAppliedFilters = (): ParamsMap | null => {
  return getSessionValue<ParamsMap | null>(SESSION_KEYS.APPLIED_FILTERS, null);
};

/**
 * Limpiar filtros aplicados
 */
export const clearAppliedFilters = (): void => {
  removeFromSession(SESSION_KEYS.APPLIED_FILTERS);
};

/**
 * Guardar estado completo de AdvSearch
 */
export const saveAdvSearchState = (state: AdvSearchState): void => {
  saveToSession(SESSION_KEYS.ADV_SEARCH_STATE, state);
};

/**
 * Obtener estado de AdvSearch
 */
export const getAdvSearchState = (): AdvSearchState | null => {
  return getSessionValue<AdvSearchState | null>(SESSION_KEYS.ADV_SEARCH_STATE, null);
};

/**
 * Limpiar estado de AdvSearch
 */
export const clearAdvSearchState = (): void => {
  removeFromSession(SESSION_KEYS.ADV_SEARCH_STATE);
};
</file>

<file path="src/app/redux/features/jobOffers/storage.ts">
export const STORAGE_KEYS = {
  PAGE: 'jobOffers_paginaActual',
  PAGE_SIZE: 'jobOffers_registrosPorPagina',
  SEARCH: 'jobOffers_search',
  FILTERS: 'jobOffers_filters',
  SORT: 'jobOffers_sortBy',
  TITLE_ONLY: 'jobOffers_titleOnly',
  EXACT: 'jobOffers_exact',
  DATE: 'jobOffers_date',
  RATING: 'jobOffers_rating',
  TOTAL_REGISTROS: 'jobOffers_totalRegistros',
  TOTAL_PAGES: 'jobOffers_totalPages',
  PRESERVED_TOTAL: 'jobOffers_preservedTotal',
} as const;

/**
 * Helper para leer localStorage de forma segura
 */ /*
export const getStoredValue = <T>(key: string, defaultValue: T): T => {
  if (typeof window === 'undefined') return defaultValue;
  try {
    const item = window.localStorage.getItem(key);
    return item ? (JSON.parse(item) as T) : defaultValue;
  } catch (error) {
    console.error(`Error reading localStorage key "${key}":`, error);
    return defaultValue;
  }
};*/

/**
 * Helper para guardar en localStorage
 */ /*
export const saveToStorage = <T>(key: string, value: T): void => {
  if (typeof window !== 'undefined') {
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch (error) {
      console.error(`Error saving to localStorage key "${key}":`, error);
    }
  }
};*/

/**
 * Helper para limpiar TODO el localStorage relacionado
 */ /*
export const clearJobOffersStorage = (): void => {
  if (typeof window !== 'undefined') {
    try {
      Object.values(STORAGE_KEYS).forEach((key) => {
        localStorage.removeItem(key);
      });
    } catch (error) {
      console.error('Error clearing localStorage:', error);
    }
  }
};*/

/**
 * Restaurar todo el estado desde localStorage
 */ /*
export const restoreFromStorage = () => {
  return {
    search: getStoredValue(STORAGE_KEYS.SEARCH, ''),
    filters: getStoredValue(STORAGE_KEYS.FILTERS, { range: [], city: '', category: [] }),
    sortBy: getStoredValue(STORAGE_KEYS.SORT, 'recent'),
    paginaActual: getStoredValue(STORAGE_KEYS.PAGE, 1),
    registrosPorPagina: getStoredValue(STORAGE_KEYS.PAGE_SIZE, 10),
    titleOnly: getStoredValue(STORAGE_KEYS.TITLE_ONLY, false),
    exact: getStoredValue(STORAGE_KEYS.EXACT, false),
    date: getStoredValue(STORAGE_KEYS.DATE, null),
    rating: getStoredValue(STORAGE_KEYS.RATING, null),
    totalRegistros: getStoredValue(STORAGE_KEYS.TOTAL_REGISTROS, 0),
    totalPages: getStoredValue(STORAGE_KEYS.TOTAL_PAGES, 0),
    preservedTotalRegistros: getStoredValue(STORAGE_KEYS.PRESERVED_TOTAL, 0),
  };
};*/
/*
export const saveCountsToStorage = (counts: {
  totalRegistros: number;
  totalPages: number;
  preservedTotalRegistros: number;
}): void => {
  saveToStorage(STORAGE_KEYS.TOTAL_REGISTROS, counts.totalRegistros);
  saveToStorage(STORAGE_KEYS.TOTAL_PAGES, counts.totalPages);
  saveToStorage(STORAGE_KEYS.PRESERVED_TOTAL, counts.preservedTotalRegistros);
};*/
</file>

<file path="src/app/redux/features/jobOffers/types.ts">
export interface OfferData {
  _id: string;
  fixerId: string;
  fixerName: string;
  title: string;
  description: string;
  category: string;
  tags: string[];
  price: number;
  city: string;
  contactPhone: string;
  createdAt: string;
  rating?: number;
  photos?: string[];
  imagenUrl?: string;
  allImages?: string[];
  status?: boolean;
}

export interface FilterState {
  range: string[];
  city: string[];
  category: string[];
  tags?: string[];
  minPrice?: number | null;
  maxPrice?: number | null;
  isAutoSelectedCategory?: boolean;
  isAutoSelectedCity?: boolean;
}

export interface PaginationState {
  paginaActual: number;
  registrosPorPagina: number;
  totalRegistros: number;
  totalPages: number;
}

export interface JobOffersState {
  loading: boolean;
  error: string | null;
  filters: FilterState;
  sortBy: string;
  search: string;
  date?: string | null;
  rating?: number | null;
  titleOnly?: boolean;
  exact?: boolean;
  paginaActual: number;
  registrosPorPagina: number;
  totalRegistros: number;
  preservedTotalRegistros: number;
  totalPages: number;
  paginaciones: Record<string, PaginationState>;
  shouldPersist: boolean;
}

export interface OfferResponse {
  total: number;
  count: number;
  data: OfferData[];
  currentPage?: number;
}

export interface OfferFilters {
  range?: string[];
  city?: string[];
  category?: string[];
  tags?: string[];
  minPrice?: number | null;
  maxPrice?: number | null;
}

export interface OfferParams {
  search?: string;
  filters?: OfferFilters;
  sortBy?: string;
  date?: string;
  rating?: number;
  page?: number;
  limit?: number;
  titleOnly?: boolean;
  exact?: boolean;
  isInitialSearch?: boolean;
}

export type FilterParamValue = string | string[] | number | boolean | null;
export type ParamsMap = Record<string, FilterParamValue>;
</file>

<file path="src/app/redux/features/jobOffers/useImageCarousel.ts">
// src/hooks/useImageCarousel.ts
import { useState, useEffect, useRef, useCallback } from 'react';

export const useImageCarousel = (id: string, totalImages: number) => {
  const [isHovered, setIsHovered] = useState(false);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isVisible, setIsVisible] = useState(false);
  const elementRef = useRef<HTMLDivElement | null>(null);

  const intervalRef = useRef<NodeJS.Timeout | null>(null);
  const isActiveRef = useRef(false);

  // Estados para touch/swipe
  const touchStartX = useRef<number>(0);
  const touchEndX = useRef<number>(0);
  const [isTouching, setIsTouching] = useState(false);

  const clearCurrentInterval = useCallback(() => {
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
      intervalRef.current = null;
      isActiveRef.current = false;
    }
  }, []);

  const startCarousel = useCallback(() => {
    if (totalImages <= 1) return;

    if (isActiveRef.current) return;

    clearCurrentInterval();

    isActiveRef.current = true;
    intervalRef.current = setInterval(() => {
      setCurrentIndex((prev) => (prev + 1) % totalImages);
    }, 2000);
  }, [totalImages, clearCurrentInterval]);

  const handleMouseEnter = useCallback(() => {
    setIsHovered(true);
    startCarousel();
  }, [startCarousel]);

  const handleMouseLeave = useCallback(() => {
    setIsHovered(false);
    clearCurrentInterval();
    setCurrentIndex(0);
  }, [clearCurrentInterval]);

  const handlePrevImage = useCallback(
    (e: React.MouseEvent | React.TouchEvent) => {
      e.stopPropagation();
      clearCurrentInterval();
      setCurrentIndex((prev) => (prev - 1 + totalImages) % totalImages);
    },
    [totalImages, clearCurrentInterval],
  );

  const handleNextImage = useCallback(
    (e: React.MouseEvent | React.TouchEvent) => {
      e.stopPropagation();
      clearCurrentInterval();
      setCurrentIndex((prev) => (prev + 1) % totalImages);
    },
    [totalImages, clearCurrentInterval],
  );

  // Touch handlers para swipe
  const handleTouchStart = useCallback(
    (e: React.TouchEvent) => {
      touchStartX.current = e.touches[0].clientX;
      setIsTouching(true);
      clearCurrentInterval();
    },
    [clearCurrentInterval],
  );

  const handleTouchMove = useCallback((e: React.TouchEvent) => {
    touchEndX.current = e.touches[0].clientX;
  }, []);

  const handleTouchEnd = useCallback(() => {
    setIsTouching(false);
    const swipeThreshold = 50;
    const diff = touchStartX.current - touchEndX.current;

    if (Math.abs(diff) > swipeThreshold) {
      if (diff > 0) {
        setCurrentIndex((prev) => (prev + 1) % totalImages);
      } else {
        setCurrentIndex((prev) => (prev - 1 + totalImages) % totalImages);
      }
    }
  }, [totalImages]);

  useEffect(() => {
    // Solo activar en mobile
    const isMobile = window.innerWidth < 1024;
    if (!isMobile || !elementRef.current || totalImages <= 1) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const visible = entry.isIntersecting && entry.intersectionRatio > 0.5;
          setIsVisible(visible);

          if (visible) {
            startCarousel();
          } else {
            clearCurrentInterval();
            setCurrentIndex(0);
          }
        });
      },
      {
        threshold: [0, 0.5, 1],
        rootMargin: '-10% 0px -10% 0px',
      },
    );

    observer.observe(elementRef.current);

    return () => {
      observer.disconnect();
      clearCurrentInterval();
    };
  }, [startCarousel, clearCurrentInterval, totalImages]);

  useEffect(() => {
    return () => {
      clearCurrentInterval();
    };
  }, [clearCurrentInterval]);

  return {
    currentIndex,
    isHovered,
    isTouching,
    isVisible,
    elementRef,
    handleMouseEnter,
    handleMouseLeave,
    handlePrevImage,
    handleNextImage,
    handleTouchStart,
    handleTouchMove,
    handleTouchEnd,
  };
};
</file>

<file path="src/app/redux/features/searchHistory/useSearchHistory.ts">
// src/app/redux/features/searchHistory/useSearchHistory.ts
import { useState, useEffect, useCallback, useRef } from 'react';
import {
  useGetSearchHistoryQuery,
  useDeleteSearchHistoryMutation,
  useClearSearchHistoryMutation,
} from '@/app/redux/services/searchHistoryApi';

const HISTORY_KEY = 'job_search_history_v1';
const MAX_HISTORY_ITEMS = 10;

interface UseSearchHistoryOptions {
  useBackend?: boolean;
  maxItems?: number;
  storageKey?: string;
}

interface UseSearchHistoryReturn {
  history: string[];
  addToHistory: (query: string) => void;
  removeFromHistory: (item: string) => Promise<void>;
  clearHistory: () => Promise<void>;
  isLoading: boolean;
  error: string | null;
}

export function useSearchHistory(options: UseSearchHistoryOptions = {}): UseSearchHistoryReturn {
  const { useBackend = false, maxItems = MAX_HISTORY_ITEMS, storageKey = HISTORY_KEY } = options;

  const [history, setHistory] = useState<string[]>([]);
  const [localError, setLocalError] = useState<string | null>(null);
  const hasInitialized = useRef(false);
  const lastBackendData = useRef<string[] | undefined>(undefined);

  const {
    data: backendHistory,
    isLoading: isLoadingHistory,
    error: historyError,
    refetch: refetchHistory,
  } = useGetSearchHistoryQuery('', {
    skip: !useBackend,
  });

  const [deleteHistoryItem, { isLoading: isDeleting }] = useDeleteSearchHistoryMutation();
  const [clearHistoryMutation, { isLoading: isClearing }] = useClearSearchHistoryMutation();

  const isLoading = isLoadingHistory || isDeleting || isClearing;
  const error = localError || (historyError ? 'Error al cargar historial' : null);

  // ===== LOCAL STORAGE =====
  const loadFromLocalStorage = useCallback(() => {
    try {
      const raw = localStorage.getItem(storageKey);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch (error) {
      console.error('Error loading search history from localStorage:', error);
      return [];
    }
  }, [storageKey]);

  const persistToLocalStorage = useCallback(
    (items: string[]) => {
      try {
        localStorage.setItem(storageKey, JSON.stringify(items));
      } catch (error) {
        console.error('Error saving search history to localStorage:', error);
      }
    },
    [storageKey],
  );

  // ===== INITIALIZE =====
  useEffect(() => {
    if (hasInitialized.current) return;

    // SIEMPRE cargar desde localStorage primero
    const localHistory = loadFromLocalStorage();

    if (localHistory.length > 0) {
      setHistory(localHistory);
    }

    hasInitialized.current = true;
  }, [loadFromLocalStorage]);

  // ===== SYNC BACKEND =====
  useEffect(() => {
    if (!useBackend) return;

    // No hacer nada si aún no hemos inicializado
    if (!hasInitialized.current) return;

    // No hacer nada si el backend no ha devuelto datos aún
    if (backendHistory === undefined) return;

    // Evitar re-procesar los mismos datos del backend
    if (lastBackendData.current === backendHistory) {
      return;
    }

    lastBackendData.current = backendHistory;

    // Si el backend tiene datos, usarlos
    if (backendHistory.length > 0) {
      setHistory(backendHistory);
      persistToLocalStorage(backendHistory);
    }
  }, [useBackend, backendHistory, persistToLocalStorage]);

  // ===== ADD =====
  const addToHistory = useCallback(
    (query: string) => {
      const trimmed = query.trim();
      if (!trimmed) return;

      setHistory((prev) => {
        const filtered = prev.filter((item) => item !== trimmed);
        const updated = [trimmed, ...filtered].slice(0, maxItems);
        persistToLocalStorage(updated);
        return updated;
      });

      if (useBackend) {
        setTimeout(() => {
          refetchHistory();
        }, 500);
      }
    },
    [maxItems, persistToLocalStorage, useBackend, refetchHistory],
  );

  // ===== REMOVE (CORREGIDO) =====
  const removeFromHistory = useCallback(
    async (item: string) => {
      setLocalError(null);

      let previousHistory: string[] = [];

      try {
        setHistory((prev) => {
          previousHistory = prev;
          const updated = prev.filter((h) => h !== item);
          persistToLocalStorage(updated);
          return updated;
        });

        if (useBackend) {
          const result = await deleteHistoryItem(item).unwrap();

          if (!result.success) {
            throw new Error('Backend deletion failed');
          }

          const shouldContain = previousHistory.filter((h) => h !== item);
          const backendReturned = result.updatedHistory;

          if (backendReturned.length === 0 && shouldContain.length > 0) {
            lastBackendData.current = shouldContain;
            setHistory(shouldContain);
            persistToLocalStorage(shouldContain);
            return;
          }

          lastBackendData.current = backendReturned;
          setHistory(backendReturned);
          persistToLocalStorage(backendReturned);
        }
      } catch (err) {
        console.error('Remove from history error:', err);
        setLocalError('Error al eliminar del historial');

        // Rollback: restaurar estado anterior
        setHistory(previousHistory);
        persistToLocalStorage(previousHistory);
      }
    },
    [useBackend, deleteHistoryItem, persistToLocalStorage],
  );

  // ===== CLEAR (CORREGIDO) =====
  const clearHistory = useCallback(async () => {
    setLocalError(null);

    let previousHistory: string[] = [];

    try {
      setHistory((prev) => {
        previousHistory = prev;
        persistToLocalStorage([]);
        return [];
      });

      if (useBackend) {
        const result = await clearHistoryMutation().unwrap();

        if (!result.success) {
          throw new Error('Backend clear failed');
        }
        lastBackendData.current = result.updatedHistory;
        setHistory(result.updatedHistory);
        persistToLocalStorage(result.updatedHistory);
      }
    } catch (err) {
      console.error('Clear history error:', err);
      setLocalError('Error al limpiar historial');

      // Rollback: restaurar estado anterior
      setHistory(previousHistory);
      persistToLocalStorage(previousHistory);
    }
  }, [useBackend, clearHistoryMutation, persistToLocalStorage]);

  return {
    history,
    addToHistory,
    removeFromHistory,
    clearHistory,
    isLoading,
    error,
  };
}
</file>

<file path="src/app/redux/features/searchHistory/useSearchKeyboard.ts">
// src/app/redux/features/searchHistory/useSearchKeyboard.ts
import { useCallback } from 'react';

interface UseSearchKeyboardOptions {
  isOpen: boolean;
  highlighted: number;
  combinedItems: string[];
  onSelect: (item: string) => void;
  onSearch: () => void;
  onClose: () => void;
  setHighlighted: React.Dispatch<React.SetStateAction<number>>;
  setPreviewValue?: (value: string | null) => void;
  enablePreview?: boolean;
}

/**
 * Hook para manejar la navegación por teclado en el search
 * Soporta: Enter, ArrowUp, ArrowDown, Escape
 */
export function useSearchKeyboard(options: UseSearchKeyboardOptions) {
  const {
    isOpen,
    highlighted,
    combinedItems,
    onSelect,
    onSearch,
    onClose,
    setHighlighted,
    setPreviewValue,
    enablePreview = true,
  } = options;

  const handleKeyDown = useCallback(
    (e: React.KeyboardEvent<HTMLInputElement>) => {
      // ENTER
      if (e.key === 'Enter') {
        e.preventDefault();

        // Si hay un item resaltado, seleccionarlo
        if (isOpen && highlighted >= 0 && highlighted < combinedItems.length) {
          const item = combinedItems[highlighted];
          onSelect(item);
          return;
        }

        // Si no, hacer búsqueda normal
        onSearch();
        return;
      }

      // ARROW DOWN
      if (e.key === 'ArrowDown') {
        e.preventDefault();

        setHighlighted((prev) => {
          const max = combinedItems.length - 1;
          const next = prev < max ? prev + 1 : 0;

          // Preview en desktop
          if (enablePreview && setPreviewValue && combinedItems[next]) {
            setPreviewValue(combinedItems[next]);
          }

          return next;
        });
        return;
      }

      // ARROW UP
      if (e.key === 'ArrowUp') {
        e.preventDefault();

        setHighlighted((prev) => {
          const max = combinedItems.length - 1;
          const next = prev > 0 ? prev - 1 : Math.max(0, max);

          // Preview en desktop
          if (enablePreview && setPreviewValue && combinedItems[next]) {
            setPreviewValue(combinedItems[next]);
          }

          return next;
        });
        return;
      }

      // ESCAPE
      if (e.key === 'Escape') {
        e.preventDefault();
        onClose();
        if (setPreviewValue) {
          setPreviewValue(null);
        }
        return;
      }
    },
    [
      isOpen,
      highlighted,
      combinedItems,
      onSelect,
      onSearch,
      onClose,
      setHighlighted,
      setPreviewValue,
      enablePreview,
    ],
  );

  return { handleKeyDown };
}
</file>

<file path="src/app/redux/features/searchHistory/useSearchSuggestions.ts">
// src/app/redux/features/searchHistory/useSearchSuggestions.ts
import { useState, useEffect, useRef } from 'react';
import { useLazyGetSearchSuggestionsQuery } from '@/app/redux/services/searchHistoryApi';
import {
  translateSuggestions,
  translateWithDictionary,
} from '@/app/lib/utils/translate/dictionary';

interface UseSearchSuggestionsOptions {
  enabled?: boolean;
  minLength?: number;
  debounceMs?: number;
  maxResults?: number;
  language?: string;
}

interface UseSearchSuggestionsReturn {
  suggestions: string[];
  isLoading: boolean;
  error: string | null;
}

export function useSearchSuggestions(
  query: string,
  options: UseSearchSuggestionsOptions = {},
): UseSearchSuggestionsReturn {
  const {
    enabled = true,
    minLength = 1,
    debounceMs = 300,
    maxResults = 6,
    language = 'es',
  } = options;

  const [suggestions, setSuggestions] = useState<string[]>([]);
  const [localError, setLocalError] = useState<string | null>(null);

  // RTK Query lazy query
  const [trigger, { data, isLoading, error }] = useLazyGetSearchSuggestionsQuery();

  // Timer para debounce
  const debounceTimerRef = useRef<NodeJS.Timeout | null>(null);

  // ===== EFFECT CON DEBOUNCE =====
  useEffect(() => {
    // Limpiar timer anterior
    if (debounceTimerRef.current) {
      clearTimeout(debounceTimerRef.current);
    }

    // Resetear si no está habilitado
    if (!enabled) {
      setSuggestions([]);
      setLocalError(null);
      return;
    }

    const trimmed = query.trim();

    // No buscar si no cumple longitud mínima
    if (trimmed.length < minLength) {
      setSuggestions([]);
      setLocalError(null);
      return;
    }

    // Configurar nuevo timer con debounce
    debounceTimerRef.current = setTimeout(() => {
      let queryToSearch = trimmed;
      if (language === 'en') {
        queryToSearch = translateWithDictionary(trimmed, 'es');
      }
      trigger({ query: queryToSearch, limit: maxResults })
        .unwrap()
        .then((results) => {
          let processedResults = results;
          if (language === 'en' && results.length > 0) {
            console.log('✅ Translating suggestions to English');
            processedResults = translateSuggestions(results, 'en');
          }
          setSuggestions(processedResults.slice(0, maxResults));
          setLocalError(null);
        })
        .catch((err) => {
          console.error('Error fetching suggestions:', err);
          setLocalError('Error al cargar sugerencias');
          setSuggestions([]);
        });
    }, debounceMs);

    // Cleanup
    return () => {
      if (debounceTimerRef.current) {
        clearTimeout(debounceTimerRef.current);
      }
    };
  }, [query, enabled, minLength, debounceMs, maxResults, trigger, language]);

  // Actualizar sugerencias cuando cambian los datos
  useEffect(() => {
    if (data) {
      let processedData = data;
      if (language === 'en' && data.length > 0) {
        processedData = translateSuggestions(data, 'en');
      }
      setSuggestions(processedData.slice(0, maxResults));
    }
  }, [data, maxResults, language]);

  return {
    suggestions,
    isLoading,
    error: localError || (error ? 'Error al cargar sugerencias' : null),
  };
}
</file>

<file path="src/app/redux/features/searchHistory/useSearchTouch.ts">
// src/app/redux/features/searchHistory/useSearchTouch.ts
import { useRef, useCallback } from 'react';

interface UseSearchTouchReturn {
  handleTouchStart: (item: string) => () => void;
  handleTouchEnd: () => void;
  handlePointerDown: (item: string) => (e: React.PointerEvent) => void;
  handlePointerUp: () => void;
  clearTouchTimer: () => void;
}

/**
 * Hook para manejar gestos de pulsación larga (long press) en móvil
 * Soporta tanto touch como pointer events
 */
export function useSearchTouch(
  onLongPress: (item: string) => void,
  longPressDelay: number = 600,
): UseSearchTouchReturn {
  const touchTimerRef = useRef<number | null>(null);

  const clearTouchTimer = useCallback(() => {
    if (touchTimerRef.current) {
      window.clearTimeout(touchTimerRef.current);
      touchTimerRef.current = null;
    }
  }, []);

  const handleTouchStart = useCallback(
    (item: string) => () => {
      clearTouchTimer();
      touchTimerRef.current = window.setTimeout(() => {
        onLongPress(item);
      }, longPressDelay);
    },
    [onLongPress, longPressDelay, clearTouchTimer],
  );

  const handleTouchEnd = useCallback(() => {
    clearTouchTimer();
  }, [clearTouchTimer]);

  const handlePointerDown = useCallback(
    (item: string) => (e: React.PointerEvent) => {
      // Solo activar en eventos no-mouse (touch, pen)
      if (e.pointerType === 'mouse') return;

      clearTouchTimer();
      touchTimerRef.current = window.setTimeout(() => {
        onLongPress(item);
      }, longPressDelay);
    },
    [onLongPress, longPressDelay, clearTouchTimer],
  );

  const handlePointerUp = useCallback(() => {
    clearTouchTimer();
  }, [clearTouchTimer]);

  return {
    handleTouchStart,
    handleTouchEnd,
    handlePointerDown,
    handlePointerUp,
    clearTouchTimer,
  };
}
</file>

<file path="src/app/redux/hooks.ts">
import { useDispatch, useSelector } from 'react-redux';
import type { RootState, AppDispatch } from './store';

export const useAppDispatch = useDispatch.withTypes<AppDispatch>();
export const useAppSelector = useSelector.withTypes<RootState>();
</file>

<file path="src/app/redux/ReduxProvider.tsx">
'use client';

import { Provider } from 'react-redux';
import { store } from './store';

export function ReduxProvider({ children }: { children: React.ReactNode }) {
  return <Provider store={store}>{children}</Provider>;
}
</file>

<file path="src/app/redux/services/activityApi.ts">
import { baseApi } from './baseApi';

export interface ActivityData {
  userId: string;
  date: string;
  role: string;
  type: string;
  metadata: {
    button: string;
    jobTitle: string;
    jobId: string;
  };
  timestamp: string;
}

export const activityApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    logClick: builder.mutation<void, ActivityData>({
      query: (activityData) => ({
        url: '/ActivityReviews',
        method: 'POST',
        body: activityData,
      }),
      invalidatesTags: ['Requester'],
    }),
  }),
});

export const { useLogClickMutation } = activityApi;
</file>

<file path="src/app/redux/services/api.ts">
const BASE_URL = `${process.env.NEXT_PUBLIC_API_URL}/api/controlC`;

export interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
  message?: string;
}

/**
 * Helper: Convierte cualquier tipo de error (unknown) a un string seguro.
 * Esto evita usar 'any' dentro de la clase y maneja casos donde el error no es una instancia de Error.
 */
function getErrorMessage(error: unknown): string {
  if (error instanceof Error) return error.message;
  return String(error);
}

class ApiClient {
  private baseUrl: string;
  private timeout: number;

  constructor(baseUrl: string, timeout = 10000) {
    this.baseUrl = baseUrl;
    this.timeout = timeout;
  }

  private async request<T>(url: string, options: RequestInit): Promise<ApiResponse<T>> {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), this.timeout);

    try {
      const response = await fetch(`${this.baseUrl}${url}`, {
        ...options,
        signal: controller.signal,
        headers: {
          'Content-Type': 'application/json',
          ...(options.headers || {}),
        },
      });

      // Intentamos parsear la respuesta
      const data = await response.json();

      return {
        success: response.ok,
        data,
        message: data.message,
        // Si la respuesta no es OK, intentamos capturar el mensaje de error del backend
        error: !response.ok ? data.message || 'Error en la petición' : undefined,
      };
    } catch (error) {
      // 1. El 'catch' recibe el error (TS infiere unknown)
      // 2. 'getErrorMessage' lo transforma a string limpio inmediatamente
      return { success: false, error: getErrorMessage(error) };
    } finally {
      clearTimeout(id);
    }
  }

  get<T>(url: string) {
    return this.request<T>(url, { method: 'GET' });
  }

  post<T>(url: string, body: unknown) {
    return this.request<T>(url, {
      method: 'POST',
      body: JSON.stringify(body),
    });
  }
}

export const api = new ApiClient(BASE_URL);
</file>

<file path="src/app/redux/services/apiConfig.ts">
// Configuración de la API
export const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000/api';

// Log para debugging (solo en desarrollo)
if (typeof window !== 'undefined' && process.env.NODE_ENV === 'development') {
  console.log('🔗 API URL configurada:', API_URL);
  console.log('🔗 NEXT_PUBLIC_API_URL:', process.env.NEXT_PUBLIC_API_URL);
}
</file>

<file path="src/app/redux/services/auth/registro.ts">
const BASE_URL = `${process.env.NEXT_PUBLIC_API_URL}/api/signUp`;

export interface User {
  id: string;
  email: string;
  name?: string;
  picture?: string;
}

export interface GoogleAuthResponse {
  status: 'ok' | 'firstTime' | 'exists' | 'error';
  firstTime?: boolean;
  token?: string;
  user?: User;
  message?: string;
}

export interface UbicacionResponse {
  success: boolean;
  message?: string;
}

export interface TelefonoResponse {
  success: boolean;
  message?: string;
  error?: string;
}

export async function enviarTokenGoogle(token: string): Promise<GoogleAuthResponse> {
  try {
    const res = await fetch(`${BASE_URL}/google/auth`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token }),
    });

    if (!res.ok) throw new Error(`Error ${res.status}: ${res.statusText}`);
    return await res.json();
  } catch (error) {
    console.error('Error al conectar con el backend:', error);
    throw error;
  }
}

export async function verificarSesionBackend(token: string) {
  try {
    const res = await fetch(`${BASE_URL}/google/verify`, {
      method: 'GET',
      headers: { Authorization: `Bearer ${token}` },
    });

    if (!res.ok) throw new Error('Token inválido o expirado');
    return await res.json();
  } catch (error) {
    console.error('Error al verificar la sesión:', error);
    throw error;
  }
}

export async function enviarUbicacion(
  lat: number,
  lng: number,
  direccion: string | null,
  departamento: string | null,
  pais: string | null,
): Promise<UbicacionResponse> {
  const token = localStorage.getItem('servineo_token');
  try {
    const res = await fetch(`${BASE_URL}/registrar/ubicacion`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ lat, lng, direccion, departamento, pais }),
    });

    if (!res.ok) throw new Error(`Error ${res.status}: ${res.statusText}`);
    return await res.json();
  } catch (error) {
    console.error('Error al enviar la ubicación al backend:', error);
    throw error;
  }
}

//telefono
export async function enviarTelefono(telefono: string): Promise<TelefonoResponse> {
  const token = localStorage.getItem('servineo_token');
  try {
    const res = await fetch(`${BASE_URL}/registrar/telefono`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ telefono }),
    });

    const data = await res.json();

    if (!res.ok) {
      // Lanzar error con el mensaje del servidor
      throw new Error(`Error ${res.status}: ${data.error || res.statusText}`);
    }

    return data;
  } catch (error) {
    console.error('Error al enviar el teléfono al backend:', error);
    throw error;
  }
}

export interface RegistroResponse {
  success: boolean;
  message?: string;
  token?: string;
  user?: User;
}

export async function enviarRegistroManual(
  name: string,
  email: string,
  password: string,
): Promise<RegistroResponse> {
  try {
    const res = await fetch(`${BASE_URL}/registro/manual`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password }),
    });

    if (!res.ok) {
      const errorData = await res.json();
      throw new Error(errorData.message || `Error ${res.status}`);
    }

    return await res.json();
  } catch (error) {
    console.error('Error al registrar manualmente:', error);
    throw error;
  }
}
</file>

<file path="src/app/redux/services/auth/registroDatos.ts">
const BASE_URL = `${process.env.NEXT_PUBLIC_API_URL}/api/controlC`;

export interface User {
  email: string;
  name?: string;
  picture?: string;
}

export interface RegistroResponse {
  success: boolean;
  message?: string;
  token?: string;
  user?: User;
}

export interface UbicacionResponse {
  success: boolean;
  message?: string;
}

export async function enviarRegistroManual(
  name: string,
  email: string,
  password: string,
): Promise<RegistroResponse> {
  const url = `${BASE_URL}/registro/manual`;

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password }),
    });

    const contentType = res.headers.get('content-type');

    if (contentType?.includes('text/html')) {
      const textError = await res.text();
      throw new Error(
        `Error ${res.status}: La API no respondió con JSON. Respuesta: ${textError.slice(0, 120)}`,
      );
    }

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({}));
      throw new Error(errorData.message || `Error del servidor: ${res.status}`);
    }

    return (await res.json()) as RegistroResponse;
  } catch (error) {
    console.error('Error al registrar manualmente:', error);
    throw error;
  }
}

export async function enviarUbicacion(
  lat: number,
  lng: number,
  direccion: string | null,
  departamento: string | null,
  pais: string | null,
): Promise<UbicacionResponse> {
  const url = `${BASE_URL}/ubicacion`;

  try {
    const token = localStorage.getItem('servineo_token');
    if (!token) throw new Error('No se encontró el token de autenticación.');

    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ lat, lng, direccion, departamento, pais }),
    });

    const contentType = res.headers.get('content-type');

    if (contentType?.includes('text/html')) {
      const textError = await res.text();
      throw new Error(
        `Error ${res.status}: La API no respondió con JSON. Respuesta: ${textError.slice(0, 120)}`,
      );
    }

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({}));
      throw new Error(errorData.message || `Error del servidor: ${res.status}`);
    }

    return (await res.json()) as UbicacionResponse;
  } catch (error) {
    console.error('Error al enviar la ubicación:', error);
    throw error;
  }
}

export interface FotoResponse {
  success: boolean;
  message?: string;
  user?: {
    name: string;
    email: string;
    picture?: string;
  };
}

export async function enviarFotoPerfil(usuarioId: string, archivo: File): Promise<FotoResponse> {
  const fileToBase64 = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result as string);
      reader.onerror = (error) => reject(error);
    });
  };

  const base64Foto = await fileToBase64(archivo);
  const url = `${BASE_URL}/fotoPerfil/usuarios/foto`;

  const res = await fetch(url, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ usuarioId, fotoPerfil: base64Foto }),
  });

  const data = await res.json();

  if (!res.ok) {
    return { success: false, message: data.message || 'Error al subir la foto' };
  }

  if (data.user) {
    localStorage.setItem('servineo_user', JSON.stringify(data.user));
  }

  return data;
}
</file>

<file path="src/app/redux/services/baseApi.ts">
// src/app/redux/services/baseApi.ts
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react';

// Force /api to use Next.js proxy
const API_URL = process.env.NEXT_PUBLIC_API_URL + '/api';

// Log para debugging (solo en desarrollo)
if (typeof window !== 'undefined' && process.env.NODE_ENV === 'development') {
  console.log('🔗 API URL configurada:', API_URL);
}

export const baseQuery = fetchBaseQuery({
  baseUrl: API_URL,
  prepareHeaders: (headers) => {
    //const token = localStorage.getItem('servineo_token');
    // if (token) {
    //   headers.set('authorization', `Bearer ${token}`);
    // }
    // //  headers.set('Content-Type', 'application/json');
    return headers;
  },
  credentials: 'include',
});

export interface ApiError {
  status: number;
  data: {
    message: string;
    errors?: Record<string, string[]>;
  };
}

export const isApiError = (error: unknown): error is ApiError => {
  return typeof error === 'object' && error !== null && 'status' in error && 'data' in error;
};

// Base API with no endpoints
export const baseApi = createApi({
  reducerPath: 'api',
  baseQuery,
  tagTypes: [
    'User',
    'Job',
    'Statistics',
    'JobOffer',
    'Requester',
    'SearchHistory',
    'Experience',
    'Portfolio',
    'Certification',
  ],
  endpoints: () => ({}),
});
</file>

<file path="src/app/redux/services/become.ts">
import { baseApi } from './baseApi';

export const becomeApi = baseApi.injectEndpoints({
  overrideExisting: true,
  endpoints: (builder) => ({
    convertToFixer: builder.mutation<unknown, { id: string; profile: unknown }>({
      query: ({ id, profile }) => ({
        url: `/user-profiles/${id}/convert-fixer`,
        method: 'PATCH',
        body: { profile },
      }),
      invalidatesTags: ['User'],
    }),
  }),
});

export const { useConvertToFixerMutation } = becomeApi;
</file>

<file path="src/app/redux/services/certifications.ts">
import { baseApi } from './baseApi';
import type { ICertification } from '@/types/fixer-profile';

// Interfaces de respuesta del Backend
interface ApiResponse<T> {
  success: boolean;
  message?: string;
  data: T;
}

interface DeleteResponse {
  success: boolean;
  message: string;
}

export const certificationApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    // CREATE: POST /api/certifications
    createCertification: builder.mutation<ICertification, Partial<ICertification>>({
      query: (body) => ({
        url: '/certifications',
        method: 'POST',
        body,
      }),
      transformResponse: (response: ApiResponse<ICertification>) => response.data,
      // Invalidamos la lista para que se refresque al crear una nueva
      invalidatesTags: [{ type: 'Certification', id: 'LIST' }],
    }),

    // GET BY FIXER: GET /api/certifications/fixer/:fixerId
    getCertificationsByFixer: builder.query<ICertification[], string>({
      query: (fixerId) => `/certifications/fixer/${fixerId}`,
      transformResponse: (response: ApiResponse<ICertification[]>) => response.data,
      providesTags: (result) =>
        result
          ? [
              ...result.map(({ _id }) => ({ type: 'Certification' as const, id: _id })),
              { type: 'Certification', id: 'LIST' },
            ]
          : [{ type: 'Certification', id: 'LIST' }],
    }),

    // GET BY ID: GET /api/certifications/:id
    getCertificationById: builder.query<ICertification, string>({
      query: (id) => `/certifications/${id}`,
      transformResponse: (response: ApiResponse<ICertification>) => response.data,
      providesTags: (result, error, id) => [{ type: 'Certification', id }],
    }),

    // UPDATE: PUT /api/certifications/:id
    updateCertification: builder.mutation<
      ICertification,
      { id: string; data: Partial<ICertification> }
    >({
      query: ({ id, data }) => ({
        url: `/certifications/${id}`,
        method: 'PUT',
        body: data,
      }),
      transformResponse: (response: ApiResponse<ICertification>) => response.data,
      invalidatesTags: (result, error, { id }) => [
        { type: 'Certification', id },
        { type: 'Certification', id: 'LIST' },
      ],
    }),

    // ✅ DELETE CORREGIDO:
    // Ya no pide userId en el body, solo el id en la URL.
    deleteCertification: builder.mutation<{ message: string }, string>({
      query: (id) => ({
        url: `/certifications/${id}`,
        method: 'DELETE',
        // No se envía body
      }),
      transformResponse: (response: DeleteResponse) => ({ message: response.message }),
      invalidatesTags: (result, error, id) => [
        { type: 'Certification', id },
        { type: 'Certification', id: 'LIST' },
      ],
    }),
  }),
  overrideExisting: false,
});

export const {
  useCreateCertificationMutation,
  useGetCertificationsByFixerQuery,
  useGetCertificationByIdQuery,
  useUpdateCertificationMutation,
  useDeleteCertificationMutation,
  useLazyGetCertificationsByFixerQuery,
  useLazyGetCertificationByIdQuery,
} = certificationApi;
</file>

<file path="src/app/redux/services/dashboardApi.ts">
// redux/DashboardApi.ts
import { baseApi } from './baseApi';

export interface SearchDataItem {
  [key: string]: unknown;
}

export interface StatisticsResponse {
  success: boolean;
  count: number;
  period: string;
  start_date: string;
  end_date: string;
  data: SearchDataItem[];
  filter_statistics: {
    fixer_name: {
      'A-C': number;
      'D-F': number;
      'G-I': number;
      'J-L': number;
      'M-N': number;
      'O-Q': number;
      'R-T': number;
      'U-W': number;
      'X-Z': number;
    };
    city: {
      Cochabamba: number;
      'La Paz': number;
      'Santa Cruz': number;
      Pando: number;
      Potosi: number;
      Sucre: number;
      Beni: number;
      Oruro: number;
      Tarija: number;
    };
    job_type: {
      Carpintero: number;
      Electricista: number;
      Plomeria: number;
      Albañil: number;
      Mecanico: number;
      Jardinero: number;
      Fontanero: number;
      Pintor: number;
      Cerrajero: number;
      Decorador: number;
    };
  };
  user_type_statistics: {
    visitor: number;
    requester: number;
    fixer: number;
  };
}

export const statisticsApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    getStatistics: builder.query<StatisticsResponse, 'semanal' | 'mensual' | 'anual'>({
      query: (period) => {
        const routes = {
          semanal: '/searches/semanal',
          mensual: '/searches/month',
          anual: '/searches/year',
        };
        return {
          url: routes[period],
          method: 'GET',
        };
      },
      providesTags: ['Statistics'],
    }),
  }),
});

export const { useGetStatisticsQuery } = statisticsApi;
</file>

<file path="src/app/redux/services/editNumber.ts">
const BASE_URL = `${process.env.NEXT_PUBLIC_API_URL}/api/controlC/modificar-datos`;

export interface User {
  email: string;
  name?: string;
  picture?: string;
  telefono?: string;
  ubicacion?: Ubicacion;
}

export interface UpdateRequesterData {
  telefono: string;
  ubicacion: Ubicacion;
}
export interface Ubicacion {
  lat: number;
  lng: number;
  direccion: string;
  departamento: string;
  pais: string;
}

export interface RequesterData {
  requesterId: string;
  telefono: string;
  ubicacion: Ubicacion;
}

export async function obtenerDatosUsuarioLogueado(): Promise<RequesterData> {
  const token = localStorage.getItem('servineo_token');

  if (!token) {
    throw new Error('No se encontró token de autenticación.');
  }

  try {
    // 👈 URL CORREGIDA: Agregando la ruta completa del router
    const fullUrl = `${BASE_URL}/requester/data`;

    const res = await fetch(fullUrl, {
      method: 'GET',
      headers: { Authorization: `Bearer ${token}` },
    });

    if (!res.ok) {
      // Mejorar el manejo de errores para mostrar el mensaje del backend si existe
      const errorData = await res.json().catch(() => ({}));
      throw new Error(errorData.message || `Error ${res.status}: No se pudo cargar el perfil.`);
    }

    const data = await res.json();
    return data;
  } catch (error) {
    console.error('Error al obtener los datos del usuario:', error);
    throw error;
  }
}
export async function actualizarDatosUsuario(
  data: UpdateRequesterData,
): Promise<{ success: boolean; message?: string; code?: string }> {
  const token = localStorage.getItem('servineo_token');

  if (!token) {
    return { success: false, message: 'No autenticado.' };
  }

  try {
    // 👈 URL CORREGIDA: Agregando la ruta completa del router
    const fullUrl = `${BASE_URL}/requester/update-profile`;

    const res = await fetch(fullUrl, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify(data),
    });

    // parseamos siempre el body (si existe)
    const responseData = await res.json().catch(() => ({}));

    // insertado: manejo específico para 409 PHONE_TAKEN
    if (res.status === 409 && responseData?.error === 'PHONE_TAKEN') {
      // devolvemos el mismo formato pero con un codigo para que el front lo detecte
      return {
        success: false,
        message: responseData.message || 'Número ya registrado',
        code: 'PHONE_TAKEN',
      };
    }
    // fin de la verifiacion especifica

    if (!res.ok) {
      return {
        success: false,
        message: responseData.message || `Error ${res.status}: No se pudo actualizar.`,
      };
    }

    return { success: true, message: 'Perfil actualizado con éxito.' };
  } catch (error) {
    console.error('Error al actualizar el perfil:', error);
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const errAny = error as any;
    return { success: false, message: errAny?.message || 'Fallo en la conexión o servidor.' };
  }
}
</file>

<file path="src/app/redux/services/editPassword.ts">
const BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000';

export interface ChangePasswordRequest {
  currentPassword: string;
  newPassword: string;
  confirmPassword: string;
}

export interface ChangePasswordResponse {
  success: boolean;
  message: string;
  forceLogout?: boolean;
}

export async function cambiarContrasena(
  data: ChangePasswordRequest,
): Promise<ChangePasswordResponse> {
  const token = localStorage.getItem('servineo_token');

  if (!token) {
    throw new Error('No se encontró token de autenticación.');
  }

  try {
    console.log('Intentando cambiar contraseña...');

    const url = `${BASE_URL}/api/controlC/cambiar-contrasena/change-password`;

    console.log('URL final:', url);

    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify(data),
    });

    const result: ChangePasswordResponse = await response.json();
    console.log('📡 Resultado del servidor:', result);

    if (result.forceLogout) {
      console.log('Sesión cerrada por seguridad - demasiados intentos fallidos');

      localStorage.removeItem('servineo_token');
      localStorage.removeItem('servineo_user');

      alert(`${result.message}\n\nSerás redirigido al inicio de sesión.`);

      window.location.href = '/';

      return result;
    }

    if (!response.ok && response.status !== 423) {
      throw new Error(
        result.message || `Error ${response.status}: No se pudo cambiar la contraseña`,
      );
    }

    return result;
  } catch (error: unknown) {
    if (error instanceof Error) {
      console.error('Error al cambiar contraseña:', error.message);
    } else {
      console.error('Error desconocido al cambiar contraseña:', error);
    }
    throw error;
  }
}
</file>

<file path="src/app/redux/services/experiencesApi.ts">
// src/app/redux/services/experienceApi.ts
import { baseApi } from './baseApi';
import type { IExperience } from '@/types/fixer-profile';
export const experienceApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    // Crear experiencia
    createExperience: builder.mutation<IExperience, Partial<IExperience>>({
      query: (body) => ({
        url: '/experiences',
        method: 'POST',
        body,
      }),
      invalidatesTags: ['Experience'],
    }),

    // Obtener experiencias por fixer
    getExperiencesByFixer: builder.query<IExperience[], string>({
      query: (fixerId) => `/experiences/fixer/${fixerId}`,
      providesTags: ['Experience'],
    }),

    // Actualizar experiencia
    updateExperience: builder.mutation<IExperience, { id: string; data: Partial<IExperience> }>({
      query: ({ id, data }) => ({
        url: `/experiences/${id}`,
        method: 'PUT',
        body: data,
      }),
      invalidatesTags: ['Experience'],
    }),

    // Eliminar experiencia
    deleteExperience: builder.mutation<{ message: string }, string>({
      query: (id) => ({
        url: `/experiences/${id}`,
        method: 'DELETE',
      }),
      invalidatesTags: ['Experience'],
    }),
  }),
  overrideExisting: false,
});

export const {
  useCreateExperienceMutation,
  useGetExperiencesByFixerQuery,
  useUpdateExperienceMutation,
  useDeleteExperienceMutation,
} = experienceApi;
</file>

<file path="src/app/redux/services/fixerApi.ts">
// src/app/redux/services/fixerApi.ts
import { baseApi } from './baseApi';
import type { IUserProfile, JobOffer } from '@/types/job-offer';

export const fixerApi = baseApi.injectEndpoints({
  overrideExisting: false,
  endpoints: (builder) => ({
    getFixerById: builder.query<IUserProfile, string>({
      query: (id) => `user-profiles/${id}`,
      providesTags: (result) => (result ? [{ type: 'User', id: result.user.id }] : []),
    }),

    getFixers: builder.query<IUserProfile[], void>({
      query: () => 'user-profiles/role/fixer',
      providesTags: (result) =>
        result
          ? [
              ...result.map(({ user }) => ({ type: 'User' as const, id: user.id })),
              { type: 'User', id: 'LIST' },
            ]
          : [{ type: 'User', id: 'LIST' }],
    }),

    getJobsByFixer: builder.query<JobOffer[], string>({
      query: (fixerId) => `jobs/fixer/${fixerId}`,
      providesTags: (result, error, fixerId) =>
        result
          ? [
              ...result.map(({ id }) => ({ type: 'Job' as const, id })),
              { type: 'Job', id: `FIXER-${fixerId}` },
            ]
          : [{ type: 'Job', id: `FIXER-${fixerId}` }],
    }),
  }),
});

export const { useGetFixerByIdQuery, useGetFixersQuery, useGetJobsByFixerQuery } = fixerApi;
</file>

<file path="src/app/redux/services/getLastChange.ts">
const BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000';
const ULTIMO_CAMBIO_BASE = '/api/controlC/ultimo-cambio';

export interface LastPasswordChangeResponse {
  success: boolean;
  userId: string;
  userName: string;
  userEmail: string;
  hasPassword: boolean;
  lastPasswordChange: string | null;
  fechaFormateada: string;
}

export async function obtenerUltimoCambio(): Promise<LastPasswordChangeResponse> {
  const token = localStorage.getItem('servineo_token');

  if (!token) {
    throw new Error('No se encontró token de autenticación.');
  }

  try {
    console.log('🔍 Consultando último cambio...');
    console.log('🔑 Token disponible:', !!token);

    const fullUrl = `${BASE_URL}${ULTIMO_CAMBIO_BASE}/fecha-ultimo-cambio`;
    console.log('🌐 URL completa:', fullUrl);

    const response = await fetch(fullUrl, {
      method: 'GET',
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });

    console.log('📡 Response status:', response.status);

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      console.error('❌ Error response:', errorData);
      throw new Error(
        errorData.message || `Error ${response.status}: No se pudo obtener última modificación.`,
      );
    }

    const result: LastPasswordChangeResponse = await response.json();
    console.log('✅ Resultado obtenido:', result);

    return result;
  } catch (error: unknown) {
    if (error instanceof Error) {
      console.error('❌ Error al obtener último cambio:', error.message);
      throw error; // <- siempre lanza, TypeScript ya sabe que no sigue
    }

    // 👇 Si no es una instancia de Error, igualmente lanzamos uno
    throw new Error('Ocurrió un error desconocido al obtener el último cambio.');
  }
}
</file>

<file path="src/app/redux/services/jobApi.ts">
import { baseApi } from './baseApi';
import { IJobOffer } from '@/types/fixer-profile';

interface ApiResponse {
  data: IJobOffer[];
  count: number;
  success?: boolean;
}

export const jobApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    // Obtener todas las ofertas
    getAllJobs: builder.query<IJobOffer[], void>({
      query: () => '/job-offers',
      providesTags: ['Job'],
    }),

    // Obtener ofertas por fixerId
    getJobsByFixer: builder.query<IJobOffer[], string>({
      query: (fixerId) => `/job-offers/fixer/${fixerId}`,
      transformResponse: (response: ApiResponse) => response.data,
      providesTags: ['Job'],
    }),

    // Crear oferta
    createJob: builder.mutation<IJobOffer, FormData>({
      query: (formData) => ({
        url: '/job-offers',
        method: 'POST',
        body: formData,
      }),
      invalidatesTags: ['Job'],
    }),

    // Actualizar oferta
    updateJob: builder.mutation<IJobOffer, { jobId: string; formData: Partial<FormData> }>({
      query: ({ jobId, formData }) => ({
        url: `/job-offers/${jobId}`,
        method: 'PATCH',
        body: formData,
      }),
      invalidatesTags: ['Job'],
    }),

    // Eliminar oferta
    deleteJob: builder.mutation<{ message: string }, { jobId: string; fixerId: string }>({
      query: ({ jobId, fixerId }) => ({
        url: `/job-offers/${jobId}`,
        method: 'DELETE',
        body: { fixerId },
      }),
      invalidatesTags: ['Job'],
    }),

    //Activar / Desactivar oferta
    toggleJobStatus: builder.mutation<IJobOffer, { jobId: string }>({
      query: ({ jobId }) => ({
        url: `/job-offers/${jobId}/toggle-status`,
        method: 'PATCH',
      }),
      invalidatesTags: ['Job'],
    }),
  }),

  overrideExisting: false,
});

export const {
  useGetAllJobsQuery,
  useGetJobsByFixerQuery,
  useCreateJobMutation,
  useUpdateJobMutation,
  useDeleteJobMutation,
  useToggleJobStatusMutation,
} = jobApi;
</file>

<file path="src/app/redux/services/jobOfferApi.ts">
// esto ya no se utilizara
import { baseApi } from './baseApi';

export interface JobOfferLocation {
  lat: number;
  lng: number;
  address: string;
}

export interface JobOffer {
  _id?: string;
  id?: string;
  fixerId: string;
  fixerName: string;
  title?: string;
  description: string;
  services: string[];
  whatsapp: string;
  price: number;
  city: string;
  createdAt?: Date;
  photos?: string[];
  location?: JobOfferLocation;
  tags?: string[];
  rating?: number;
  completedJobs?: number;
  fixerPhoto?: string;
}

export interface CreateJobOfferInput {
  fixerId: string;
  fixerName: string;
  title?: string;
  description: string;
  services: string[];
  whatsapp: string;
  price: number;
  city: string;
  photos?: string[];
  location?: JobOfferLocation;
}

export interface JobOfferResponse {
  id: string;
  message: string;
}

export const jobOfferApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    // Obtener todas las ofertas
    getAllJobOffers: builder.query<JobOffer[], void>({
      query: () => '/newOffers',
      providesTags: ['JobOffer'],
    }),

    // Obtener ofertas por fixerId
    getJobOffersByFixer: builder.query<JobOffer[], string>({
      query: (fixerId) => `/newOffers/fixer/${fixerId}`,
      providesTags: ['JobOffer'],
    }),

    // Crear una nueva oferta
    createJobOffer: builder.mutation<JobOfferResponse, CreateJobOfferInput>({
      query: (body) => ({
        url: '/newOffers',
        method: 'POST',
        body,
      }),
      invalidatesTags: ['JobOffer'],
    }),

    // Actualizar una oferta
    updateJobOffer: builder.mutation<
      JobOffer,
      { offerId: string; data: Partial<CreateJobOfferInput> }
    >({
      query: ({ offerId, data }) => ({
        url: `/newOffers/${offerId}`,
        method: 'PUT',
        body: data,
      }),
      invalidatesTags: ['JobOffer'],
    }),

    // Eliminar una oferta
    deleteJobOffer: builder.mutation<{ message: string }, string>({
      query: (offerId) => ({
        url: `/newOffers/${offerId}`,
        method: 'DELETE',
      }),
      invalidatesTags: ['JobOffer'],
    }),
  }),
  overrideExisting: false,
});

export const {
  useGetAllJobOffersQuery,
  useGetJobOffersByFixerQuery,
  useCreateJobOfferMutation,
  useUpdateJobOfferMutation,
  useDeleteJobOfferMutation,
} = jobOfferApi;
</file>

<file path="src/app/redux/services/jobOffersApi.ts">
// src/app/redux/services/jobOffersApi.ts
import { baseApi } from './baseApi';
import { OfferParams, OfferResponse } from '@/app/redux/features/jobOffers/types';

// ===== TIPOS PARA PRICE RANGES =====
interface PriceRangeItem {
  label: string;
  min?: number | null;
  max?: number | null;
}

interface PriceRangesResponse {
  min: number | null;
  max: number | null;
  ranges: PriceRangeItem[];
}

// ===== TIPOS PARA RESPUESTAS DE LA API =====
interface TagsApiResponse {
  tags?: string[];
  data?: {
    tags?: string[];
  };
}

interface PriceRangesApiResponse {
  min?: number | null;
  max?: number | null;
  ranges?: PriceRangeItem[];
  data?: {
    min?: number | null;
    max?: number | null;
    ranges?: PriceRangeItem[];
  };
}

// ===== TIPOS PARA FILTER COUNTS =====
interface FilterCountsResponse {
  ranges: Record<string, number>;
  cities: Record<string, number>;
  categories: Record<string, number>;
  ratings: Record<string, number>;
  total: number;
}

interface FilterCountsParams {
  range?: string[];
  city?: string;
  category?: string[];
  search?: string;
  minRating?: number;
  maxRating?: number;
}

// Extender el baseApi con endpoints específicos de ofertas
export const jobOffersApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    // 1. Query principal
    getOffers: builder.query<OfferResponse, OfferParams>({
      query: (params) => {
        const urlParams = new URLSearchParams();

        if (params.search?.trim()) urlParams.append('search', params.search);
        if (params.filters?.range?.length)
          params.filters.range.forEach((r) => urlParams.append('range', r));
        if (params.filters?.city?.length) urlParams.append('city', params.filters.city.join(','));
        if (params.filters?.category?.length)
          params.filters.category.forEach((c) => urlParams.append('category', c));
        if (params.filters?.tags?.length) urlParams.append('tags', params.filters.tags.join(','));
        if (params.filters?.minPrice != null)
          urlParams.append('minPrice', String(params.filters.minPrice));
        if (params.filters?.maxPrice != null)
          urlParams.append('maxPrice', String(params.filters.maxPrice));
        if (params.sortBy) urlParams.append('sortBy', params.sortBy);
        if (params.date) urlParams.append('date', params.date);
        if (params.rating != null) urlParams.append('rating', String(params.rating));
        if (params.titleOnly) urlParams.append('titleOnly', 'true');
        if (params.exact) urlParams.append('exact', 'true');

        // Filtrar solo ofertas activas
        urlParams.append('status', 'true');

        urlParams.append('page', String(params.page || 1));
        urlParams.append('limit', String(params.limit || 10));

        return `/devmaster/offers?${urlParams.toString()}`;
      },
      providesTags: ['JobOffer'],
    }),

    // 2. Ofertas recientes (Home)
    getRecentOffers: builder.query<OfferResponse, { category?: string; limit?: number }>({
      query: ({ category, limit = 8 }) => {
        const params = new URLSearchParams({
          sortBy: 'recent',
          page: '1',
          limit: String(limit),
          status: 'true', // Filtrar solo ofertas activas
        });
        if (category && category !== 'Todos') params.append('category', category);
        return `/devmaster/offers?${params.toString()}`;
      },
      providesTags: ['JobOffer'],
    }),

    // 3. Tags dinámicos
    getTags: builder.query<string[], { search?: string; category?: string[] }>({
      query: ({ search, category }) => {
        const params = new URLSearchParams({ limit: '20' });
        if (search?.trim()) params.append('search', search);
        if (category?.length) params.append('category', category.join(','));
        if (!search && !category?.length) params.append('recent', 'true');
        return `/devmaster/tags?${params.toString()}`;
      },
      transformResponse: (response: TagsApiResponse | string[]) => {
        if (Array.isArray(response)) return response;
        if (response.tags) return response.tags;
        if (response.data?.tags) return response.data.tags;
        return [];
      },
    }),

    // 4. Rangos de precios
    getPriceRanges: builder.query<PriceRangesResponse, void>({
      query: () => {
        return '/devmaster/offers?action=getPriceRanges';
      },
      transformResponse: (response: PriceRangesApiResponse) => {
        // Si la respuesta ya tiene el formato correcto
        if (response.ranges) {
          return {
            min: response.min ?? null,
            max: response.max ?? null,
            ranges: response.ranges,
          };
        }

        // Si viene envuelto en data
        if (response.data?.ranges) {
          return {
            min: response.data.min ?? null,
            max: response.data.max ?? null,
            ranges: response.data.ranges,
          };
        }

        // Fallback: estructura vacía
        return {
          min: null,
          max: null,
          ranges: [],
        };
      },
    }),

    // 5. Filter Counts (AGREGADO SIGUIENDO TU MISMO FORMATO)
    getFilterCounts: builder.query<FilterCountsResponse, FilterCountsParams>({
      query: (params) => {
        const urlParams = new URLSearchParams();

        if (params.range?.length) params.range.forEach((r) => urlParams.append('range', r));
        if (params.city) urlParams.set('city', params.city);
        if (params.category?.length)
          params.category.forEach((c) => urlParams.append('category', c));
        if (params.search) urlParams.set('search', params.search);
        if (params.minRating != null) urlParams.set('minRating', String(params.minRating));
        if (params.maxRating != null) urlParams.set('maxRating', String(params.maxRating));

        return `/devmaster/filter-counts?${urlParams.toString()}`;
      },
      transformResponse: (response: { success: boolean; data: FilterCountsResponse }) => {
        return response.data;
      },
    }),
  }),
});

export const {
  useGetOffersQuery,
  useLazyGetOffersQuery,
  useGetRecentOffersQuery,
  useGetTagsQuery,
  useGetPriceRangesQuery,
  useGetFilterCountsQuery,
  useLazyGetFilterCountsQuery,
} = jobOffersApi;
</file>

<file path="src/app/redux/services/loginApi.ts">
const BASE_URL = `${process.env.NEXT_PUBLIC_API_URL}`;

export interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
  message?: string;
}

class ApiClient {
  private baseUrl: string;
  private timeout: number;

  constructor(baseUrl: string, timeout = 10000) {
    this.baseUrl = baseUrl;
    this.timeout = timeout;
  }

  private async request<T>(url: string, options: RequestInit): Promise<ApiResponse<T>> {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), this.timeout);

    try {
      const response = await fetch(`${this.baseUrl}${url}`, {
        ...options,
        signal: controller.signal,
        headers: {
          'Content-Type': 'application/json',
          ...(options.headers || {}),
        },
      });

      const data = await response.json();
      return { success: response.ok, data, message: data.message };
    } catch (error: unknown) {
      if (error instanceof Error) {
        return { success: false, error: error.message };
      }
      return { success: false, error: 'Error desconocido' };
    } finally {
      clearTimeout(id);
    }
  }

  get<T>(url: string) {
    return this.request<T>(url, { method: 'GET' });
  }
  post<T, B = unknown>(url: string, body: B) {
    return this.request<T>(url, {
      method: 'POST',
      body: JSON.stringify(body),
    });
  }
}

export const api = new ApiClient(BASE_URL);
</file>

<file path="src/app/redux/services/logoutService.ts">
const API_URL = process.env.NEXT_PUBLIC_API_URL || ('http://localhost:3000' as string);

export interface LogoutResponse {
  success: boolean;
  message: string;
}

export async function cerrarTodasSesiones(): Promise<LogoutResponse> {
  const token = localStorage.getItem('servineo_token');

  if (!token) {
    throw new Error('No se encontró token de autenticación.');
  }

  try {
    const response = await fetch(`${API_URL}/api/controlC/cerrar-sesiones/logout-all`, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({}), // cuerpo vacío
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Error al cerrar todas las sesiones (HTTP):', errorText);
      throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
    }

    const data: LogoutResponse = await response.json();
    return data;
  } catch (error) {
    if (error instanceof Error) {
      console.error('Error al cerrar todas las sesiones (fetch):', error.message);
      throw error;
    } else {
      console.error('Error al cerrar todas las sesiones (desconocido):', error);
      throw new Error('Error desconocido al cerrar las sesiones');
    }
  }
}
</file>

<file path="src/app/redux/services/portafolioApi.ts">
import { baseApi } from './baseApi';
import { IPortfolioItem } from '@/types/fixer-profile';

export const portfolioApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    // 1. Obtener Portafolio por Fixer
    getPortfolioByFixer: builder.query<IPortfolioItem[], string>({
      query: (fixerId) => `/portfolio/fixer/${fixerId}`,
      providesTags: ['Portfolio'], // Se auto-refresca cuando "Portfolio" es invalidado
    }),

    // 2. Crear Item (Imagen o Video)
    createPortfolioItem: builder.mutation<IPortfolioItem, Partial<IPortfolioItem>>({
      query: (body) => ({
        url: '/portfolio',
        method: 'POST',
        body,
      }),
      invalidatesTags: ['Portfolio'], // Fuerza la recarga de getPortfolioByFixer
    }),

    // 3. Eliminar Item
    deletePortfolioItem: builder.mutation<{ message: string }, string>({
      query: (id) => ({
        url: `/portfolio/${id}`,
        method: 'DELETE',
      }),
      invalidatesTags: ['Portfolio'],
    }),
  }),
  overrideExisting: false,
});

export const {
  useGetPortfolioByFixerQuery,
  useCreatePortfolioItemMutation,
  useDeletePortfolioItemMutation,
} = portfolioApi;
</file>

<file path="src/app/redux/services/searchApi.ts">
import { baseApi } from './baseApi';

export interface SearchData {
  user_type: string;
  search_query: string;
  search_type: string;
  filters: {
    [x: string]: {
      fixer_name: string;
      city: string;
      job_type: string;
      search_count: number;
    };
  };
}

export interface FilterData {
  filters: {
    fixer_name: string;
    city: string;
    job_type: string;
    search_count: number;
  };
}

export const searchApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    logSearch: builder.mutation<void, SearchData>({
      query: (searchData) => ({
        url: '/searches',
        method: 'POST',
        body: searchData,
      }),
      invalidatesTags: ['Requester'],
    }),
    updateFilters: builder.mutation<void, FilterData>({
      query: (filterData) => ({
        url: '/searches',
        method: 'PATCH',
        body: filterData,
      }),
      invalidatesTags: ['Requester'],
    }),
  }),
});

export const { useLogSearchMutation, useUpdateFiltersMutation } = searchApi;
</file>

<file path="src/app/redux/services/searchHistoryApi.ts">
// src/app/redux/services/searchHistoryApi.ts
import { baseApi } from './baseApi';

interface SearchHistoryItem {
  searchTerm: string;
}

interface HistoryResponse {
  success: boolean;
  sessionId?: string;
  searchHistory?: SearchHistoryItem[];
  deleted?: boolean;
  cleared?: number;
}

interface SuggestionItem {
  term?: string;
  count?: number;
  score?: number;
  source?: string;
}

interface SuggestionsResponse {
  success: boolean;
  sessionId?: string;
  suggestions?: SuggestionItem[];
}

// Helper seguro que obtiene sessionId solo en cliente
function getClientSessionId(): string {
  if (typeof window === 'undefined') {
    console.warn('⚠️ getClientSessionId llamado en servidor, retornando vacío');
    return '';
  }

  let sid = localStorage.getItem('sessionId');
  if (!sid) {
    sid = crypto.randomUUID?.() || `sid-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
    localStorage.setItem('sessionId', sid);
  }
  return sid;
}

// Helper para actualizar sessionId desde backend
function updateSessionIdFromResponse(response: { sessionId?: string }) {
  if (typeof window === 'undefined') return;
  if (response.sessionId) {
    const currentSid = localStorage.getItem('sessionId');
    if (currentSid !== response.sessionId) {
      localStorage.setItem('sessionId', response.sessionId);
    }
  }
}

// Helper para construir URLs con params
function buildUrlWithParams(
  base: string,
  params: Record<string, string | number | boolean>,
): string {
  const searchParams = new URLSearchParams();

  Object.entries(params).forEach(([key, value]) => {
    if (value !== undefined && value !== null && value !== '') {
      searchParams.append(key, String(value));
    }
  });
  const queryString = searchParams.toString();
  return queryString ? `${base}?${queryString}` : base;
}

export const searchHistoryApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    // ===== OBTENER HISTORIAL =====
    getSearchHistory: builder.query<string[], string>({
      query: (searchTerm = '') => {
        const sessionId = getClientSessionId();
        if (!sessionId) {
          console.error('❌ No se pudo obtener sessionId');
          return { url: '/devmaster/offers', method: 'GET' };
        }

        const url = buildUrlWithParams('/devmaster/offers', {
          action: 'getHistory',
          search: searchTerm,
          sessionId: sessionId,
        });
        return { url, method: 'GET' };
      },
      transformResponse: (response: HistoryResponse) => {
        updateSessionIdFromResponse(response);

        if (response.success && response.searchHistory) {
          return response.searchHistory.map((item) => item.searchTerm);
        }
        return [];
      },
      providesTags: ['SearchHistory'],
    }),

    // ===== ELIMINAR ITEM =====
    deleteSearchHistory: builder.mutation<{ success: boolean; updatedHistory: string[] }, string>({
      query: (searchTerm) => {
        const sessionId = getClientSessionId();
        if (!sessionId) {
          console.error('❌ No se pudo obtener sessionId');
          return { url: '/devmaster/offers', method: 'GET' };
        }

        const url = buildUrlWithParams('/devmaster/offers', {
          action: 'deleteHistory',
          searchTerm: searchTerm,
          sessionId: sessionId,
        });
        return { url, method: 'GET' };
      },
      transformResponse: (response: HistoryResponse) => {
        updateSessionIdFromResponse(response);

        const updatedHistory = response.searchHistory?.map((i) => i.searchTerm) || [];
        return { success: response.success, updatedHistory };
      },
      invalidatesTags: ['SearchHistory'],
    }),

    // ===== LIMPIAR TODO =====
    clearSearchHistory: builder.mutation<{ success: boolean; updatedHistory: string[] }, void>({
      query: () => {
        const sessionId = getClientSessionId();
        if (!sessionId) {
          console.error('❌ No se pudo obtener sessionId');
          return { url: '/devmaster/offers', method: 'GET' };
        }

        const url = buildUrlWithParams('/devmaster/offers', {
          action: 'clearAllHistory',
          sessionId: sessionId,
        });
        return { url, method: 'GET' };
      },
      transformResponse: (response: HistoryResponse) => {
        updateSessionIdFromResponse(response);

        const updatedHistory = response.searchHistory?.map((i) => i.searchTerm) || [];
        return { success: response.success, updatedHistory };
      },
      invalidatesTags: ['SearchHistory'],
    }),

    // ===== OBTENER SUGERENCIAS =====
    getSearchSuggestions: builder.query<string[], { query: string; limit?: number }>({
      query: ({ query, limit = 6 }) => {
        const sessionId = getClientSessionId();
        if (!sessionId) {
          console.error('❌ No se pudo obtener sessionId');
          return { url: '/devmaster/offers', method: 'GET' };
        }

        const url = buildUrlWithParams('/devmaster/offers', {
          search: query,
          limit: limit,
          record: false,
          sessionId: sessionId,
        });
        return { url, method: 'GET' };
      },
      transformResponse: (response: SuggestionsResponse) => {
        updateSessionIdFromResponse(response);

        if (response.success && response.suggestions) {
          return response.suggestions.map((s) => String(s.term ?? '')).filter(Boolean);
        }
        return [];
      },
    }),
  }),
  overrideExisting: false,
});

// EXPORT HOOKS
export const {
  useGetSearchHistoryQuery,
  useDeleteSearchHistoryMutation,
  useClearSearchHistoryMutation,
  useGetSearchSuggestionsQuery,
  useLazyGetSearchSuggestionsQuery,
} = searchHistoryApi;
</file>

<file path="src/app/redux/services/services/RegistrarDPconecionBackend.tsx">
const BASE_URL = `${process.env.NEXT_PUBLIC_API_URL}/api/controlC`;

export interface User {
  email: string;
  name?: string;
  picture?: string;
}

export interface RegistroResponse {
  success: boolean;
  message?: string;
  token?: string;
  user?: User;
}

export interface UbicacionResponse {
  success: boolean;
  message?: string;
}

export async function enviarRegistroManual(
  name: string,
  email: string,
  password: string,
): Promise<RegistroResponse> {
  const url = `${BASE_URL}/registro/manual`;

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password }),
    });

    const contentType = res.headers.get('content-type');

    if (contentType?.includes('text/html')) {
      const textError = await res.text();
      throw new Error(
        `Error ${res.status}: La API no respondió con JSON. Respuesta: ${textError.slice(0, 120)}`,
      );
    }

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({}));
      throw new Error(errorData.message || `Error del servidor: ${res.status}`);
    }

    return (await res.json()) as RegistroResponse;
  } catch (error) {
    console.error('Error al registrar manualmente:', error);
    throw error;
  }
}

export async function enviarUbicacion(
  lat: number,
  lng: number,
  direccion: string | null,
  departamento: string | null,
  pais: string | null,
): Promise<UbicacionResponse> {
  const url = `${BASE_URL}/ubicacion`;

  try {
    const token = localStorage.getItem('servineo_token');
    if (!token) throw new Error('No se encontró el token de autenticación.');

    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ lat, lng, direccion, departamento, pais }),
    });

    const contentType = res.headers.get('content-type');

    if (contentType?.includes('text/html')) {
      const textError = await res.text();
      throw new Error(
        `Error ${res.status}: La API no respondió con JSON. Respuesta: ${textError.slice(0, 120)}`,
      );
    }

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({}));
      throw new Error(errorData.message || `Error del servidor: ${res.status}`);
    }

    return (await res.json()) as UbicacionResponse;
  } catch (error) {
    console.error('Error al enviar la ubicación:', error);
    throw error;
  }
}

export interface FotoResponse {
  success: boolean;
  message?: string;
  user?: {
    name: string;
    email: string;
    picture?: string;
  };
}

export async function enviarFotoPerfil(usuarioId: string, archivo: File): Promise<FotoResponse> {
  const fileToBase64 = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result as string);
      reader.onerror = (error) => reject(error);
    });
  };

  const base64Foto = await fileToBase64(archivo);
  const url = `${BASE_URL}/fotoPerfil/usuarios/foto`;

  const res = await fetch(url, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ usuarioId, fotoPerfil: base64Foto }),
  });

  const data = await res.json();

  if (!res.ok) {
    return { success: false, message: data.message || 'Error al subir la foto' };
  }

  if (data.user) {
    localStorage.setItem('servineo_user', JSON.stringify(data.user));
  }

  return data;
}
</file>

<file path="src/app/redux/services/services/registro.ts">
const BASE_URL = `${process.env.NEXT_PUBLIC_API_URL}/api/signUp`;

export interface User {
  id: string;
  email: string;
  name?: string;
  picture?: string;
}

export interface GoogleAuthResponse {
  status: 'ok' | 'firstTime' | 'exists' | 'error';
  firstTime?: boolean;
  token?: string;
  user?: User;
  message?: string;
}

export interface UbicacionResponse {
  success: boolean;
  message?: string;
}

export interface TelefonoResponse {
  success: boolean;
  message?: string;
  error?: string;
}

export async function enviarTokenGoogle(token: string): Promise<GoogleAuthResponse> {
  try {
    const res = await fetch(`${BASE_URL}/google/auth`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token }),
    });

    if (!res.ok) throw new Error(`Error ${res.status}: ${res.statusText}`);
    return await res.json();
  } catch (error) {
    console.error('Error al conectar con el backend:', error);
    throw error;
  }
}

export async function verificarSesionBackend(token: string) {
  try {
    const res = await fetch(`${BASE_URL}/google/verify`, {
      method: 'GET',
      headers: { Authorization: `Bearer ${token}` },
    });

    if (!res.ok) throw new Error('Token inválido o expirado');
    return await res.json();
  } catch (error) {
    console.error('Error al verificar la sesión:', error);
    throw error;
  }
}

export async function enviarUbicacion(
  lat: number,
  lng: number,
  direccion: string | null,
  departamento: string | null,
  pais: string | null,
): Promise<UbicacionResponse> {
  const token = localStorage.getItem('servineo_token');
  try {
    const res = await fetch(`${BASE_URL}/registrar/ubicacion`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ lat, lng, direccion, departamento, pais }),
    });

    if (!res.ok) throw new Error(`Error ${res.status}: ${res.statusText}`);
    return await res.json();
  } catch (error) {
    console.error('Error al enviar la ubicación al backend:', error);
    throw error;
  }
}

//telefono
export async function enviarTelefono(telefono: string): Promise<TelefonoResponse> {
  const token = localStorage.getItem('servineo_token');
  try {
    const res = await fetch(`${BASE_URL}/registrar/telefono`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ telefono }),
    });

    const data = await res.json();

    if (!res.ok) {
      // Lanzar error con el mensaje del servidor
      throw new Error(`Error ${res.status}: ${data.error || res.statusText}`);
    }

    return data;
  } catch (error) {
    console.error('Error al enviar el teléfono al backend:', error);
    throw error;
  }
}

export interface RegistroResponse {
  success: boolean;
  message?: string;
  token?: string;
  user?: User;
}

export async function enviarRegistroManual(
  name: string,
  email: string,
  password: string,
): Promise<RegistroResponse> {
  try {
    const res = await fetch(`${BASE_URL}/registro/manual`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password }),
    });

    if (!res.ok) {
      const errorData = await res.json();
      throw new Error(errorData.message || `Error ${res.status}`);
    }

    return await res.json();
  } catch (error) {
    console.error('Error al registrar manualmente:', error);
    throw error;
  }
}
</file>

<file path="src/app/redux/services/statisticsApi.ts">
import { baseApi } from './baseApi';

export interface JobStatusMetadata {
  completed: number;
  pending: number;
  inProgress: number;
  total: number;
  collectionDate: string;
}

export interface JobLog {
  _id: string;
  userId: string;
  date: string;
  role: 'visitor' | 'requester' | 'fixer';
  type:
    | 'login'
    | 'search'
    | 'click'
    | 'review'
    | 'session_start'
    | 'session_end'
    | 'daily_jobs_status';
  metadata: JobStatusMetadata;
  timestamp: string;
}

export const statisticsApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    getJobStatistics: builder.query<JobLog[], void>({
      query: () => '/ActivityReviews',
      providesTags: ['Statistics'],
    }),
  }),
  overrideExisting: false,
});

export const { useGetJobStatisticsQuery } = statisticsApi;
</file>

<file path="src/app/redux/services/trackingAppointmentsApi.ts">
import { baseApi } from './baseApi';

export interface MapLocation {
  _id: string;
  lat: string;
  lon: string;
  schedule_state: 'booked' | 'cancelled';
  fixerName: string;
  current_requester_name: string;
  starting_time: string;
}

export interface TrackingMetrics {
  total: number;
  active: number;
  cancelled: number;
}

export interface FixerStat {
  id: string;
  name: string;
  total: number;
  active: number;
  cancelled: number;
  rescheduled: number;
  rate: string;
}

interface FilterArgs {
  startDate?: string;
  endDate?: string;
}

export const trackingAppointmentsApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    getMapLocations: builder.query<MapLocation[], void>({
      query: () => ({
        url: '/admin/map-locations',
        method: 'GET',
      }),
      providesTags: ['Statistics'],
    }),

    getTrackingMetrics: builder.query<TrackingMetrics, FilterArgs>({
      query: ({ startDate, endDate }) => {
        const url = '/admin/metrics';
        const params = new URLSearchParams();
        if (startDate) params.append('startDate', startDate);
        if (endDate) params.append('endDate', endDate);

        const queryString = params.toString();
        return {
          url: queryString ? `${url}?${queryString}` : url,
          method: 'GET',
        };
      },
      providesTags: ['Statistics'],
    }),

    getFixerStats: builder.query<FixerStat[], void>({
      query: () => ({
        url: '/admin/fixer-stats',
        method: 'GET',
      }),
      providesTags: ['Statistics'],
    }),
  }),
});

export const { useGetMapLocationsQuery, useGetTrackingMetricsQuery, useGetFixerStatsQuery } =
  trackingAppointmentsApi;
</file>

<file path="src/app/redux/services/userApi.ts">
// refactorizar  las rutas

import { baseApi } from './baseApi';
import type { IUserProfile } from '@/types/job-offer';
import type { IUser } from '@/types/user';

export const userApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    createUserProfile: builder.mutation<IUserProfile, IUserProfile>({
      query: (body) => ({
        url: '/user-profiles',
        method: 'POST',
        body,
      }),
      invalidatesTags: ['User'],
    }),

    getUserProfiles: builder.query<IUserProfile[], void>({
      query: () => '/user-profiles',
      providesTags: ['User'],
    }),
    updateDescription: builder.mutation<IUser, { id: string; description: string }>({
      query: ({ id, description }) => ({
        url: `/user/${id}/description`,
        method: 'POST',
        body: { description },
      }),
      invalidatesTags: ['User'],
    }),

    getUsersByRole: builder.query<IUserProfile[], string>({
      query: (role) => `/user-profiles/role/${role}`,
      providesTags: ['User'],
    }),

    convertToFixer: builder.mutation<
      IUserProfile,
      { id: string; profile: IUserProfile['profile'] }
    >({
      query: ({ id, profile }) => ({
        url: `/user-profiles/${id}/convert-fixer`,
        method: 'PATCH',
        body: { profile },
      }),
      invalidatesTags: ['User'],
    }),

    getUserById: builder.query<IUser, string>({
      query: (id) => `/user/${id}`,
      providesTags: ['User'],
    }),
    updateLocation: builder.mutation<
      { success: boolean; user: IUser },
      {
        id: string;
        location: {
          lat: number;
          lng: number;
          direccion?: string;
        };
      }
    >({
      query: ({ id, location }) => ({
        url: `/user/${id}/location`,
        method: 'PATCH',
        body: { workLocation: location },
      }),
      invalidatesTags: ['User'],
    }),
  }),

  overrideExisting: false,
});

export const {
  useCreateUserProfileMutation,
  useGetUserProfilesQuery,
  useUpdateDescriptionMutation,
  useGetUsersByRoleQuery,
  useConvertToFixerMutation,
  useLazyGetUserByIdQuery,
  useGetUserByIdQuery,
  useUpdateLocationMutation,
} = userApi;
</file>

<file path="src/app/redux/slice/filterSlice.ts">
import { createSlice, type PayloadAction } from '@reduxjs/toolkit';
import type { RootState } from '../store';
interface FilterState {
  searchQuery: string;
  recentSearches: string[];
  selectedFixerNames: string[];
  selectedCities: string[];
  selectedJobTypes: string[];
  isAutoSelectedJobType: boolean;
  isAutoSelectedCity: boolean;
  sidebarOpen: boolean;
}

const initialState: FilterState = {
  searchQuery: '',
  recentSearches: [],
  selectedFixerNames: [],
  selectedCities: [],
  selectedJobTypes: [],
  isAutoSelectedJobType: false,
  isAutoSelectedCity: false,
  sidebarOpen: false,
};

export const filterSlice = createSlice({
  name: 'filters',
  initialState,
  reducers: {
    setSearchQuery: (state, action: PayloadAction<string>) => {
      state.searchQuery = action.payload;
    },
    addRecentSearch: (state, action: PayloadAction<string>) => {
      const search = action.payload.trim();
      if (search) {
        state.recentSearches = [search, ...state.recentSearches.filter((s) => s !== search)].slice(
          0,
          5,
        );
      }
    },
    clearRecentSearches: (state) => {
      state.recentSearches = [];
    },
    toggleFixerName: (state, action: PayloadAction<string>) => {
      const name = action.payload;
      state.selectedFixerNames = state.selectedFixerNames.includes(name)
        ? state.selectedFixerNames.filter((n) => n !== name)
        : [...state.selectedFixerNames, name];
    },
    toggleCity: (state, action: PayloadAction<string>) => {
      const city = action.payload;
      state.selectedCities = state.selectedCities.includes(city)
        ? state.selectedCities.filter((c) => c !== city)
        : [...state.selectedCities, city];
      // Si el usuario selecciona manualmente, marcamos como NO automático
      state.isAutoSelectedCity = false;
    },
    toggleJobType: (state, action: PayloadAction<string>) => {
      const type = action.payload;
      state.selectedJobTypes = state.selectedJobTypes.includes(type)
        ? state.selectedJobTypes.filter((t) => t !== type)
        : [...state.selectedJobTypes, type];
      // Si el usuario selecciona manualmente, marcamos como NO automático
      state.isAutoSelectedJobType = false;
    },
    autoSelectJobType: (state, action: PayloadAction<string>) => {
      // Auto-selecciona un tipo de trabajo (usado cuando hay coincidencia en búsqueda)
      state.selectedJobTypes = [action.payload];
      // Marcamos como automático
      state.isAutoSelectedJobType = true;
    },
    clearJobTypeSelection: (state) => {
      // Limpia la selección de tipos de trabajo
      state.selectedJobTypes = [];
      state.isAutoSelectedJobType = false;
    },
    autoSelectCity: (state, action: PayloadAction<string>) => {
      // Auto-selecciona una ciudad (usado cuando hay coincidencia en búsqueda)
      state.selectedCities = [action.payload];
      // Marcamos como automático
      state.isAutoSelectedCity = true;
    },
    clearCitySelection: (state) => {
      // Limpia la selección de ciudad
      state.selectedCities = [];
      state.isAutoSelectedCity = false;
    },
    resetFilters: (state) => {
      state.selectedFixerNames = [];
      state.selectedCities = [];
      state.selectedJobTypes = [];
      state.searchQuery = '';
    },
    setSidebarOpen: (state, action: PayloadAction<boolean>) => {
      state.sidebarOpen = action.payload;
    },
  },
});

export const {
  setSearchQuery,
  addRecentSearch,
  clearRecentSearches,
  toggleFixerName,
  toggleCity,
  toggleJobType,
  autoSelectJobType,
  clearJobTypeSelection,
  autoSelectCity,
  clearCitySelection,
  resetFilters,
  setSidebarOpen,
} = filterSlice.actions;

export const selectSearchQuery = (state: RootState) => state.filters.searchQuery;
export const selectRecentSearches = (state: RootState) => state.filters.recentSearches;
export const selectSelectedFixerNames = (state: RootState) => state.filters.selectedFixerNames;
export const selectSelectedCities = (state: RootState) => state.filters.selectedCities;
export const selectSelectedJobTypes = (state: RootState) => state.filters.selectedJobTypes;
export const selectIsAutoSelectedJobType = (state: RootState) =>
  state.filters.isAutoSelectedJobType;
export const selectIsAutoSelectedCity = (state: RootState) => state.filters.isAutoSelectedCity;
export const selectSidebarOpen = (state: RootState) => state.filters.sidebarOpen;

export default filterSlice.reducer;
</file>

<file path="src/app/redux/slice/fixersByJobSlice.ts">
import { createSlice, PayloadAction } from '@reduxjs/toolkit';
import type { RootState } from '../store';

interface FixersByJobState {
  searchQuery: string;
  expandedJobs: string[];
}

const initialState: FixersByJobState = {
  searchQuery: '',
  expandedJobs: [],
};

export const fixersByJobSlice = createSlice({
  name: 'fixersByJob',
  initialState,
  reducers: {
    setSearchQuery: (state, action: PayloadAction<string>) => {
      state.searchQuery = action.payload;
    },
    toggleJobExpanded: (state, action: PayloadAction<string>) => {
      if (state.expandedJobs.includes(action.payload)) {
        state.expandedJobs = state.expandedJobs.filter((job) => job !== action.payload);
      } else {
        state.expandedJobs = [...state.expandedJobs, action.payload];
      }
    },
    expandAllJobs: (state, action: PayloadAction<string[]>) => {
      state.expandedJobs = action.payload;
    },
    collapseAllJobs: (state) => {
      state.expandedJobs = [];
    },
  },
});

export const { setSearchQuery, toggleJobExpanded, expandAllJobs, collapseAllJobs } =
  fixersByJobSlice.actions;

export const selectSearchQuery = (state: RootState) => state.fixersByJob.searchQuery;
export const selectExpandedJobs = (state: RootState) => state.fixersByJob.expandedJobs;

export default fixersByJobSlice.reducer;
</file>

<file path="src/app/redux/slice/fixerSlice.ts">
import { createSlice, PayloadAction } from '@reduxjs/toolkit';
import { Fixer } from '@/app/lib/mock-data';

interface FixerState {
  currentFixer: Fixer | null;
  loading: boolean;
}

const initialState: FixerState = {
  currentFixer: null,
  loading: false,
};

export const fixerSlice = createSlice({
  name: 'fixer',
  initialState,
  reducers: {
    setFixer: (state, action: PayloadAction<Fixer>) => {
      state.currentFixer = action.payload;
    },
    updateFixer: (state, action: PayloadAction<Partial<Fixer>>) => {
      if (state.currentFixer) {
        state.currentFixer = { ...state.currentFixer, ...action.payload };
      }
    },
    clearFixer: (state) => {
      state.currentFixer = null;
    },
    setLoading: (state, action: PayloadAction<boolean>) => {
      state.loading = action.payload;
    },
  },
});

export const { setFixer, updateFixer, clearFixer, setLoading } = fixerSlice.actions;

export default fixerSlice.reducer;
</file>

<file path="src/app/redux/slice/jobOffersSlice.ts">
import { createSlice, PayloadAction } from '@reduxjs/toolkit';
import { JobOffer } from '@/app/lib/mock-data';

interface JobOffersState {
  offers: JobOffer[];
  loading: boolean;
}

const initialState: JobOffersState = {
  offers: [],
  loading: false,
};

export const jobOffersSlice = createSlice({
  name: 'jobOffers',
  initialState,
  reducers: {
    setOffers: (state, action: PayloadAction<JobOffer[]>) => {
      state.offers = action.payload;
    },
    addOffer: (state, action: PayloadAction<JobOffer>) => {
      state.offers = [action.payload, ...state.offers];
    },
    updateOffer: (state, action: PayloadAction<JobOffer>) => {
      state.offers = state.offers.map((offer) =>
        offer.id === action.payload.id ? action.payload : offer,
      );
    },
    deleteOffer: (state, action: PayloadAction<string>) => {
      state.offers = state.offers.filter((offer) => offer.id !== action.payload);
    },
    setLoading: (state, action: PayloadAction<boolean>) => {
      state.loading = action.payload;
    },
  },
});

export const { setOffers, addOffer, updateOffer, deleteOffer, setLoading } = jobOffersSlice.actions;

export default jobOffersSlice.reducer;
</file>

<file path="src/app/redux/slice/userSlice.ts">
import { createSlice, PayloadAction } from '@reduxjs/toolkit';
import { IUser } from '@/types/user';

interface UserState {
  user: IUser | null;
  isAuthenticated: boolean;
  loading: boolean;
}

const initialState: UserState = {
  user: null,
  isAuthenticated: false,
  loading: false,
};

export const userSlice = createSlice({
  name: 'user',
  initialState,
  reducers: {
    setUser: (state, action: PayloadAction<UserState['user']>) => {
      state.user = action.payload;
      state.isAuthenticated = !!action.payload;
    },
    setLoading: (state, action: PayloadAction<boolean>) => {
      state.loading = action.payload;
    },
    logout: (state) => {
      state.user = null;
      state.isAuthenticated = false;
    },
  },
});

export const { setUser, setLoading, logout } = userSlice.actions;

export default userSlice.reducer;
</file>

<file path="src/app/redux/store.ts">
import { configureStore } from '@reduxjs/toolkit';
import { setupListeners } from '@reduxjs/toolkit/query';
import { baseApi } from './services/baseApi';
import userReducer from './slice/userSlice';
import fixerReducer from './slice/fixerSlice';
import filterReducer from './slice/filterSlice';
import jobOffersReducer from './slice/jobOffersSlice';
import jobOfertReducer from './slice/jobOfert';
import fixersByJobReducer from './slice/fixersByJobSlice';
import logger from 'redux-logger';

export const store = configureStore({
  reducer: {
    [baseApi.reducerPath]: baseApi.reducer,
    user: userReducer,
    fixer: fixerReducer,
    filters: filterReducer,
    jobOffers: jobOffersReducer,
    jobOfert: jobOfertReducer,
    fixersByJob: fixersByJobReducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware().concat(baseApi.middleware).concat(logger),
  devTools: process.env.NODE_ENV !== 'production',
});

setupListeners(store.dispatch);

export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
</file>

<file path="src/Components/Adv-search/ButtonAplicarBus.tsx">
'use client';

import React from 'react';
import { useTranslations } from 'next-intl';

interface ButtonAplicarBusProps {
  onClick: () => void;
  loading?: boolean;
}

const ButtonAplicarBus: React.FC<ButtonAplicarBusProps> = ({ onClick, loading = false }) => {
  const t = useTranslations('advancedSearch.buttons');

  return (
    <button
      onClick={onClick}
      disabled={loading}
      className={`${
        loading ? 'bg-gray-400 cursor-not-allowed' : 'bg-[#2B6AE0] hover:bg-[#265ACC]'
      } text-white font-bold text-sm px-4 py-2 rounded-lg transition-colors duration-300 shadow-md`}
    >
      {loading ? t('searching') : t('applySearch')}
    </button>
  );
};

export default ButtonAplicarBus;
</file>

<file path="src/Components/Adv-search/ButtonLimpiarDatos.tsx">
'use client';

import React from 'react';
import { useTranslations } from 'next-intl';

interface ButtonLimpiarDatosProps {
  onClick: () => void;
  disabled?: boolean;
}

const ButtonLimpiarDatos: React.FC<ButtonLimpiarDatosProps> = ({ onClick, disabled = false }) => {
  const t = useTranslations('advancedSearch.buttons');

  return (
    <button
      onClick={onClick}
      disabled={disabled}
      className={`${
        disabled ? 'bg-gray-400 cursor-not-allowed' : 'bg-[#2B6AE0] hover:bg-[#265ACC]'
      } text-white font-bold text-sm px-4 py-2 rounded-lg transition-colors duration-300 shadow-md`}
    >
      {t('clearData')}
    </button>
  );
};

export default ButtonLimpiarDatos;
</file>

<file path="src/Components/Adv-search/CalendarComponent.tsx">
'use client';
import React, { useState } from 'react';
import { useTranslations } from 'next-intl';

interface CalendarProps {
  selectedDate: Date;
  onDateSelect: (date: Date) => void;
  onClose: () => void;
}

const CalendarComponent: React.FC<CalendarProps> = ({ selectedDate, onDateSelect, onClose }) => {
  const t = useTranslations('calendar');
  const [currentMonth, setCurrentMonth] = useState(selectedDate.getMonth());
  const [currentYear, setCurrentYear] = useState(selectedDate.getFullYear());

  // Usar traducciones para meses
  const monthsFull = [
    t('months.january'),
    t('months.february'),
    t('months.march'),
    t('months.april'),
    t('months.may'),
    t('months.june'),
    t('months.july'),
    t('months.august'),
    t('months.september'),
    t('months.october'),
    t('months.november'),
    t('months.december'),
  ];

  // Usar traducciones para días de la semana
  const daysOfWeek = [
    t('daysShort.monday'),
    t('daysShort.tuesday'),
    t('daysShort.wednesday'),
    t('daysShort.thursday'),
    t('daysShort.friday'),
    t('daysShort.saturday'),
    t('daysShort.sunday'),
  ];

  const getDaysInMonth = (month: number, year: number) => new Date(year, month + 1, 0).getDate();
  const getFirstDayOfMonth = (month: number, year: number) => {
    const day = new Date(year, month, 1).getDay();
    return day === 0 ? 6 : day - 1;
  };

  const handleDateClick = (day: number) => {
    const newDate = new Date(currentYear, currentMonth, day);
    onDateSelect(newDate);
  };

  const getDayOfWeekName = (date: Date) => {
    const days = [
      t('daysAbbrev.sunday'),
      t('daysAbbrev.monday'),
      t('daysAbbrev.tuesday'),
      t('daysAbbrev.wednesday'),
      t('daysAbbrev.thursday'),
      t('daysAbbrev.friday'),
      t('daysAbbrev.saturday'),
    ];
    return days[date.getDay()];
  };

  const selectedDayOfWeek = getDayOfWeekName(selectedDate);
  const selectedDay = selectedDate.getDate();
  const selectedMonthShort = monthsFull[selectedDate.getMonth()].slice(0, 3) + '.';

  const renderCalendarDays = () => {
    const daysInMonth = getDaysInMonth(currentMonth, currentYear);
    const firstDay = getFirstDayOfMonth(currentMonth, currentYear);
    const days = [];

    const prevMonthDays = getDaysInMonth(currentMonth - 1, currentYear);
    for (let i = firstDay - 1; i >= 0; i--) {
      days.push(
        <div key={`prev-${i}`} className='text-center py-2 text-gray-400 text-sm'>
          {prevMonthDays - i}
        </div>,
      );
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const isSelected =
        day === selectedDate.getDate() &&
        currentMonth === selectedDate.getMonth() &&
        currentYear === selectedDate.getFullYear();

      days.push(
        <div
          key={day}
          onClick={() => handleDateClick(day)}
          className={`text-center py-2 text-sm cursor-pointer rounded-lg transition-colors ${
            isSelected ? 'bg-cyan-500 text-white font-semibold' : 'hover:bg-gray-100 text-gray-800'
          }`}
        >
          {day}
        </div>,
      );
    }

    const remainingDays = 42 - days.length;
    for (let day = 1; day <= remainingDays; day++) {
      days.push(
        <div key={`next-${day}`} className='text-center py-2 text-gray-400 text-sm'>
          {day}
        </div>,
      );
    }

    return days;
  };

  return (
    <div className='bg-white rounded-lg shadow-xl border border-gray-200 z-50 w-80'>
      {/* Encabezado celeste */}
      <div className='bg-cyan-500 text-white p-4 rounded-t-lg'>
        <div className='text-center'>
          <div className='text-xs opacity-90'>{currentYear}</div>
          <div className='text-lg font-medium'>
            {selectedDayOfWeek}, {selectedDay} {selectedMonthShort}
          </div>
        </div>
      </div>

      {/* Calendario (blanco) */}
      <div className='p-4'>
        <div className='flex justify-between items-center mb-3'>
          {/* Flecha izquierda */}
          <button
            onClick={() => {
              if (currentMonth === 0) {
                setCurrentMonth(11);
                setCurrentYear(currentYear - 1);
              } else {
                setCurrentMonth(currentMonth - 1);
              }
            }}
            className='text-cyan-600 hover:text-cyan-800 text-xl font-bold'
            aria-label={t('navigation.previousMonth')}
          >
            ←
          </button>

          {/* Mes y año */}
          <div className='font-medium text-gray-800'>
            {monthsFull[currentMonth]} {t('navigation.of')} {currentYear}
          </div>

          {/* Flecha derecha */}
          <button
            onClick={() => {
              if (currentMonth === 11) {
                setCurrentMonth(0);
                setCurrentYear(currentYear + 1);
              } else {
                setCurrentMonth(currentMonth + 1);
              }
            }}
            className='text-cyan-600 hover:text-cyan-800 text-xl font-bold'
            aria-label={t('navigation.nextMonth')}
          >
            →
          </button>
        </div>

        {/* Días de la semana */}
        <div className='grid grid-cols-7 gap-1 text-xs font-semibold text-gray-600 mb-1'>
          {daysOfWeek.map((day) => (
            <div key={day} className='text-center py-1'>
              {day}
            </div>
          ))}
        </div>

        {/* Días del mes */}
        <div className='grid grid-cols-7 gap-1'>{renderCalendarDays()}</div>

        {/* Botones */}
        <div className='mt-4 pt-3 border-t flex justify-end gap-2'>
          <button
            onClick={onClose}
            className='px-4 py-2 text-sm text-cyan-600 hover:bg-cyan-50 rounded transition-colors'
          >
            {t('buttons.cancel')}
          </button>
          <button
            onClick={() => {
              onDateSelect(selectedDate);
              onClose();
            }}
            className='px-4 py-2 text-sm bg-cyan-500 text-white rounded hover:bg-cyan-600 transition-colors'
          >
            {t('buttons.accept')}
          </button>
        </div>
      </div>
    </div>
  );
};

export default CalendarComponent;
</file>

<file path="src/Components/Adv-search/CalificacionEstrella.tsx">
'use client';
import React, { useState } from 'react';
import { Star } from 'lucide-react';
import { useTranslations } from 'next-intl';

type NoResultsMessageProps = {
  search: string;
};

export const NoResultsMessage: React.FC<NoResultsMessageProps> = ({ search }) => {
  const t = useTranslations('search');
  const trimmed = search?.trim();

  return (
    <div className='text-center py-12'>
      <p className='text-gray-500 text-xl font-roboto font-normal'>
        {t('noResults')}
        {trimmed && (
          <>
            {' '}
            {t('for')} <span className='font-bold'>&quot;{trimmed}&quot;</span>
          </>
        )}
      </p>
    </div>
  );
};

type Props = {
  value?: number | null;
  onChange?: (val: number | null) => void;
};

const CalificacionEstrella: React.FC<Props> = ({ value = null, onChange }) => {
  const t = useTranslations('advancedSearch.rating');
  const [hoverStar, setHoverStar] = useState<number | null>(null);
  const [showModal, setShowModal] = useState(false);
  const [selectedMainStar, setSelectedMainStar] = useState<number | null>(null);
  const [hoverSubStar, setHoverSubStar] = useState<number | null>(null);

  const totalStars = 5;
  const subScales = 9; // .1 - .9

  // Limitar el valor entre 1 y 5
  const clampedValue = value != null ? Math.min(5, Math.max(1, value)) : null;
  const mainStarValue = clampedValue ? Math.floor(clampedValue) : null;

  const handleMainStarClick = (star: number) => {
    setSelectedMainStar(star);
    setShowModal(true);
  };

  const handleSubScaleClick = (subScale: number) => {
    if (selectedMainStar && onChange) {
      const decimalValue = subScale === 0 ? selectedMainStar : selectedMainStar + subScale / 10;

      onChange(decimalValue);
    }
    setShowModal(false);
    setSelectedMainStar(null);
  };

  return (
    <div className='relative'>
      <h3 className='text-base mb-2'>{t('label')}</h3>

      {/* Estrellas principales */}
      <div className='bg-white rounded-lg border border-gray-300 p-4 w-fit'>
        <div className='flex items-center gap-2'>
          {Array.from({ length: totalStars }, (_, idx) => {
            const starNumber = idx + 1;
            const filled = (hoverStar ?? mainStarValue ?? 0) >= starNumber;
            return (
              <button
                key={starNumber}
                type='button'
                onClick={() => handleMainStarClick(starNumber)}
                onMouseEnter={() => setHoverStar(starNumber)}
                onMouseLeave={() => setHoverStar(null)}
                className='transition-transform hover:scale-110 active:scale-95 touch-manipulation'
              >
                <Star
                  size={30}
                  fill={filled ? '#fbbf24' : '#ffffff'}
                  stroke='#000000'
                  strokeWidth={2}
                />
              </button>
            );
          })}
        </div>

        {clampedValue && (
          <div className='mt-2 text-sm text-gray-600 text-center'>
            {clampedValue.toFixed(1)} {t('stars')}
          </div>
        )}
      </div>

      {/* MODAL / DROPDOWN */}
      {showModal && (
        <>
          {/* CLIC FUERA PARA CERRAR */}
          <div
            className='fixed inset-0 z-[9998]'
            onClick={() => {
              setShowModal(false);
              setSelectedMainStar(null);
            }}
          />

          {/* CUADRO DE OPCIONES */}
          <div className='absolute mt-2 right-0 translate-x-[160px] bg-white rounded-lg border-2 border-gray-300 shadow-xl p-3 w-64 max-h-[60vh] z-[9999]'>
            <div className='flex items-center justify-between mb-2 pb-2 border-b border-gray-200'>
              <h3 className='text-sm font-semibold'>{t('label')}</h3>
              <button
                onClick={() => {
                  setShowModal(false);
                  setSelectedMainStar(null);
                }}
                className='text-black-600 hover:text-black-800 text-xs font-bold'
              >
                ✖
              </button>
            </div>

            {/* CONTENEDOR CON SCROLL */}
            <div className='overflow-y-auto max-h-32'>
              {/* .0 */}
              <button
                onClick={() => handleSubScaleClick(0)}
                onMouseEnter={() => setHoverSubStar(0)}
                onMouseLeave={() => setHoverSubStar(null)}
                className={`w-full flex items-center gap-2 p-2 rounded-lg mb-1 transition-colors ${
                  hoverSubStar === 0 ? 'bg-gray-100' : 'hover:bg-gray-50'
                }`}
              >
                <Star size={18} fill='#fbbf24' stroke='#000000' strokeWidth={2} />
                <span className='font-medium text-base'>{selectedMainStar}.0</span>
              </button>

              {/* .1 - .9 */}
              {Array.from({ length: subScales }, (_, idx) => {
                const subNumber = idx + 1; // inicia en .1
                return (
                  <button
                    key={subNumber}
                    onClick={() => handleSubScaleClick(subNumber)}
                    onMouseEnter={() => setHoverSubStar(subNumber)}
                    onMouseLeave={() => setHoverSubStar(null)}
                    className={`w-full flex items-center gap-2 p-2 rounded-lg mb-1 transition-colors ${
                      hoverSubStar === subNumber ? 'bg-gray-100' : 'hover:bg-gray-50'
                    }`}
                  >
                    <Star size={18} fill='#fbbf24' stroke='#000000' strokeWidth={2} />
                    <span className='font-medium text-base'>
                      {selectedMainStar}.{subNumber}
                    </span>
                  </button>
                );
              })}
            </div>
          </div>
        </>
      )}
    </div>
  );
};

export default CalificacionEstrella;
</file>

<file path="src/Components/Adv-search/ClearButton.tsx">
'use client';

import React from 'react';
import { useTranslations } from 'next-intl';

interface ClearButtonProps {
  onClick?: () => void;
  disabled?: boolean;
  className?: string;
}

const ClearButton: React.FC<ClearButtonProps> = ({ onClick, disabled = false, className = '' }) => {
  const t = useTranslations('advancedSearch.buttons');

  return (
    <button
      type='button'
      onClick={onClick}
      disabled={disabled}
      className={`${
        disabled ? 'bg-gray-400 cursor-not-allowed' : 'bg-[#2B6AE0] hover:bg-[#265ACC]'
      } text-white font-bold text-sm px-4 py-2 rounded-lg transition-colors duration-300 shadow-md ${className}`}
    >
      {disabled ? t('loading') : t('clearData')}
    </button>
  );
};

export default ClearButton;
</file>

<file path="src/Components/Adv-search/DropdownList.tsx">
'use client';

import React, { useEffect, useState, useMemo, useCallback, useRef } from 'react';
import { useTranslations } from 'next-intl';
import { useGetTagsQuery } from '@/app/redux/services/jobOffersApi';

interface DropdownListProps {
  onFilterChange?: (filters: { categories: string[] }) => void;
  clearSignal?: number;
  searchQuery?: string;
  categoryFilters?: string[];
}

const DropdownList: React.FC<DropdownListProps> = ({
  onFilterChange,
  clearSignal,
  searchQuery = '',
  categoryFilters = [],
}) => {
  const tCommon = useTranslations('advancedSearch');

  const [selectedCategories, setSelectedCategories] = useState<string[]>([]);
  const [hasRestoredFromUrl, setHasRestoredFromUrl] = useState(false);

  // Ref to store the latest onFilterChange callback
  const onFilterChangeRef = useRef(onFilterChange);
  useEffect(() => {
    onFilterChangeRef.current = onFilterChange;
  }, [onFilterChange]);

  const {
    data: tagsData,
    isLoading,
    error: fetchError,
  } = useGetTagsQuery({
    search: searchQuery?.trim() || undefined,
    category: categoryFilters.length > 0 ? categoryFilters : undefined,
  });

  // Normalizar respuesta del backend
  const categories = useMemo(() => {
    if (!tagsData) return [];
    if (Array.isArray(tagsData)) return tagsData;
    return [];
  }, [tagsData]);

  const error = fetchError ? 'Error al cargar categorías' : null;

  // Restaurar desde URL (solo se ejecuta una vez)
  useEffect(() => {
    if (typeof window === 'undefined' || hasRestoredFromUrl) return;

    const sp = new URLSearchParams(window.location.search);
    const tagsFromAll = sp.getAll('tags') || [];
    let urlTags: string[] = [];

    if (tagsFromAll.length) {
      urlTags = tagsFromAll
        .flatMap((s) => (typeof s === 'string' ? s.split(',') : []))
        .map((s) => s.trim())
        .filter(Boolean);
    } else {
      const t = sp.get('tags');
      if (t != null) {
        urlTags = t
          .split(',')
          .map((s) => s.trim())
          .filter(Boolean);
      }
    }

    if (urlTags.length > 0) {
      setSelectedCategories(urlTags);
      onFilterChangeRef.current?.({ categories: urlTags });
    }

    setHasRestoredFromUrl(true);
  }, [hasRestoredFromUrl]); // Solo se ejecuta al montar el componente

  // Limpiar selección cuando cambia clearSignal
  useEffect(() => {
    if (!hasRestoredFromUrl || !clearSignal) return;

    setSelectedCategories([]);
    onFilterChangeRef.current?.({ categories: [] });
  }, [clearSignal, hasRestoredFromUrl]);

  const handleCheckboxChange = useCallback((categoryValue: string) => {
    setSelectedCategories((prev) => {
      const newSelectedCategories = prev.includes(categoryValue)
        ? prev.filter((cat) => cat !== categoryValue)
        : [...prev, categoryValue];

      // Llamar a onFilterChange después de actualizar el estado
      setTimeout(() => {
        onFilterChangeRef.current?.({ categories: newSelectedCategories });
      }, 0);

      return newSelectedCategories;
    });
  }, []);

  if (isLoading) {
    return (
      <div className='w-full border border-gray-300 rounded-lg p-8 text-center'>
        <div className='animate-pulse space-y-3'>
          <div className='h-4 bg-gray-200 rounded w-3/4 mx-auto'></div>
          <div className='h-4 bg-gray-200 rounded w-2/3 mx-auto'></div>
          <div className='h-4 bg-gray-200 rounded w-3/4 mx-auto'></div>
        </div>
        <p className='text-gray-500 text-xs mt-2'>{tCommon('resultsCounter.loading')}</p>
      </div>
    );
  }

  if (error) {
    return (
      <div className='w-full border border-red-300 rounded-lg p-4 bg-red-50'>
        <div className='text-center'>
          <p className='text-red-600 text-sm font-semibold mb-2'>⚠️ Error al cargar categorías</p>
          <p className='text-red-500 text-xs mb-3'>{error}</p>
        </div>
      </div>
    );
  }

  const selectedButNotInFilter = selectedCategories.filter(
    (selectedTag) => !categories.includes(selectedTag),
  );

  const displayCategories = [...categories, ...selectedButNotInFilter];

  if (displayCategories.length === 0) {
    return (
      <div className='w-full border border-gray-300 rounded-lg p-4'>
        <p className='text-gray-500 text-sm text-center'>{tCommon('resultsCounter.noResults')}</p>
      </div>
    );
  }

  return (
    <div className='w-full border border-gray-300 rounded-lg overflow-hidden'>
      <div className='max-h-64 overflow-y-auto'>
        {displayCategories.map((category, index) => (
          <label
            key={`${category}-${index}`}
            className={`flex items-center px-4 py-3 cursor-pointer hover:bg-gray-50 transition-colors ${
              index !== displayCategories.length - 1 ? 'border-b border-gray-200' : ''
            }`}
          >
            <input
              type='checkbox'
              checked={selectedCategories.includes(category)}
              onChange={() => handleCheckboxChange(category)}
              className='w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer'
            />
            <span className='ml-3 text-sm text-gray-700 capitalize'>{category}</span>
          </label>
        ))}
      </div>
    </div>
  );
};

export default DropdownList;
</file>

<file path="src/Components/Adv-search/HelpButton.tsx">
// HelpButton.tsx
'use client';

import React, { useState } from 'react';
import { useTranslations } from 'next-intl';
import {
  HelpCircle,
  Search,
  Hash,
  Filter,
  MapPin,
  Briefcase,
  DollarSign,
  Tag,
  Calendar,
  Star,
  CheckCircle,
  X,
  RotateCcw,
} from 'lucide-react';

export function HelpButton() {
  const t = useTranslations('advancedSearch.help');
  const [isHelpOpen, setIsHelpOpen] = useState(false);

  const handleClick = () => {
    setIsHelpOpen(true);
  };

  const closeHelp = () => {
    setIsHelpOpen(false);
  };

  const helpSteps = [
    { icon: Search, key: 'step1' },
    { icon: Hash, key: 'step2' },
    { icon: Filter, key: 'step3' },
    { icon: MapPin, key: 'step4' },
    { icon: Briefcase, key: 'step5' },
    { icon: DollarSign, key: 'step6' },
    { icon: Tag, key: 'step7' },
    { icon: Calendar, key: 'step8' },
    { icon: Star, key: 'step9' },
    { icon: CheckCircle, key: 'step10' },
    { icon: RotateCcw, key: 'step11' },
    { icon: X, key: 'step12' },
  ];

  return (
    <>
      <button
        onClick={handleClick}
        className='fixed right-4 sm:right-6 top-20 lg:top-24 bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 hover:shadow-xl transition-all duration-300 hover:scale-110 z-40'
        aria-label={t('buttonText')}
        title={t('buttonText')}
      >
        <HelpCircle className='w-5 h-5 sm:w-6 sm:h-6' />
      </button>

      {/* Panel lateral de Ayuda */}
      {isHelpOpen && (
        <>
          {/* Panel derecho - Estilo similar a filtros */}
          <div className='fixed right-0 top-0 h-full w-80 bg-gray-50 shadow-2xl z-50 flex flex-col transition-transform duration-300 border-l border-gray-200'>
            {/* Header - Ayuda con X */}
            <div className='flex items-center justify-between px-5 py-4 bg-white border-b border-gray-200'>
              <h1 className='text-xl font-bold text-gray-900'>{t('buttonText')}</h1>
              <button
                onClick={closeHelp}
                className='p-1.5 hover:bg-gray-100 rounded-lg transition-colors'
              >
                <X size={22} className='text-gray-700' />
              </button>
            </div>

            {/* Content - Steps tipo filtros */}
            <div className='overflow-y-auto p-4 space-y-3 flex-1'>
              {/* Sección: Guía de Búsqueda Avanzada */}
              <div className='bg-blue-600 text-white px-4 py-3 rounded font-semibold text-sm'>
                {t('tooltip')}
              </div>

              {/* Steps dinámicos */}
              {helpSteps.map(({ icon: Icon, key }, index) => (
                <div key={key} className='bg-white rounded-lg p-3 shadow-sm border border-gray-200'>
                  <div className='flex gap-3 items-start'>
                    <div className='flex-shrink-0 mt-0.5'>
                      <div className='w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center'>
                        <Icon className='text-blue-600' size={16} />
                      </div>
                    </div>
                    <div className='flex-1'>
                      <p className='text-sm text-gray-800 leading-relaxed'>
                        <span className='font-semibold text-blue-600'>{index + 1}.</span> {t(key)}
                      </p>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </>
      )}
    </>
  );
}
</file>

<file path="src/Components/Adv-search/PriceRangeList.tsx">
// src/Components/Adv-search/PriceRangeList.tsx
'use client';

import React, { useState, useEffect } from 'react';
import { useTranslations } from 'next-intl';
import { useGetPriceRangesQuery } from '@/app/redux/services/jobOffersApi';
import { SerializedError } from '@reduxjs/toolkit';
import { FetchBaseQueryError } from '@reduxjs/toolkit/query';

type RangeItem = { label: string; min: number | null; max: number | null };

interface PriceRangeListProps {
  onFilterChange?: (filters: { priceRanges: string[]; priceKey?: string }) => void;
  clearSignal?: number;
}

// Tipo para el error de la API
interface ApiErrorData {
  message?: string;
  [key: string]: unknown;
}

const PriceRangeList: React.FC<PriceRangeListProps> = ({ onFilterChange, clearSignal }) => {
  const t = useTranslations('advancedSearch');
  const [selectedRanges, setSelectedRanges] = useState<string[]>([]);
  const [ranges, setRanges] = useState<RangeItem[]>([]);

  // ===== RTK QUERY =====
  const { data: priceRangesData, isLoading, error: queryError } = useGetPriceRangesQuery();

  // ===== CARGAR CACHÉ DE SESSIONSTORAGE AL MONTAR =====
  useEffect(() => {
    // Try to read cached ranges from sessionStorage to avoid flicker on remount
    try {
      const cached = sessionStorage.getItem('adv_price_ranges');
      if (cached) {
        const parsed = JSON.parse(cached) as RangeItem[];
        if (Array.isArray(parsed) && parsed.length) {
          setRanges(parsed);
        }
      }
    } catch (err) {
      console.error('❌[PriceRangeList] Error loading cache:', err);
    }
  }, []);

  // ===== SINCRONIZAR CON RESPUESTA DE RTK QUERY =====
  useEffect(() => {
    if (priceRangesData) {
      const items: RangeItem[] = Array.isArray(priceRangesData.ranges)
        ? priceRangesData.ranges.map((r) => ({
            label: r.label,
            min: r.min ?? null,
            max: r.max ?? null,
          }))
        : [];

      setRanges(items);

      // Guardar en sessionStorage para futuros montajes
      try {
        sessionStorage.setItem('adv_price_ranges', JSON.stringify(items));
      } catch (err) {
        console.error('❌ [PriceRangeList] Error saving cache:', err);
      }
    }
  }, [priceRangesData]);

  // ===== MANEJAR CAMBIOS DE CHECKBOX =====
  const handleCheckboxChange = (rangeValue: string) => {
    const newSelectedRanges = selectedRanges.includes(rangeValue)
      ? selectedRanges.filter((range) => range !== rangeValue)
      : [...selectedRanges, rangeValue];

    setSelectedRanges(newSelectedRanges);

    // If exactly one range is selected, provide priceKey so parent can parse min/max
    const priceKey = newSelectedRanges.length === 1 ? newSelectedRanges[0] : '';
    onFilterChange?.({ priceRanges: newSelectedRanges, priceKey });
  };

  // ===== RESETEAR SELECCIONES CUANDO EL PADRE SEÑALA UN CLEAR =====
  useEffect(() => {
    if (typeof clearSignal === 'undefined') return;
    setSelectedRanges([]);
    onFilterChange?.({ priceRanges: [], priceKey: '' });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [clearSignal]);

  // ===== FORMATEAR ETIQUETAS =====
  function formatRangeLabel(label: string) {
    if (!label) return label;
    // Convert occurrences like "$90" or "$ 90" to "90bs"
    return label.replace(/\$\s*([0-9]+(?:\.[0-9]+)?)/g, '$1bs');
  }

  // ===== FUNCIÓN AUXILIAR PARA EXTRAER MENSAJE DE ERROR =====
  function getErrorMessage(error: FetchBaseQueryError | SerializedError): string {
    if ('status' in error) {
      // FetchBaseQueryError
      if (error.data && typeof error.data === 'object') {
        const apiError = error.data as ApiErrorData;
        return apiError.message || JSON.stringify(error.data);
      }
      return `Error ${error.status}`;
    }
    // SerializedError
    return error.message || 'Error desconocido';
  }

  // ===== ESTADOS DE CARGA Y ERROR =====
  // Mostrar loading solo si NO hay datos en caché
  if (isLoading && ranges.length === 0) {
    return <div className='p-4 text-sm text-gray-500'>{t('resultsCounter.loading')}</div>;
  }

  if (queryError) {
    const errorMessage = getErrorMessage(queryError);
    return <div className='p-4 text-sm text-red-500'>Error: {errorMessage}</div>;
  }

  if (!ranges.length) {
    return <div className='p-4 text-sm text-gray-500'>{t('resultsCounter.noResults')}</div>;
  }

  return (
    <div className='w-full border border-gray-300 rounded-lg overflow-hidden'>
      <div className='max-h-64 overflow-y-auto'>
        {ranges.map((r, index) => (
          <label
            key={`${r.label}-${index}`}
            className={`flex items-center px-4 py-3 cursor-pointer hover:bg-gray-50 transition-colors ${
              index !== ranges.length - 1 ? 'border-b border-gray-200' : ''
            }`}
          >
            <input
              type='checkbox'
              checked={selectedRanges.includes(r.label)}
              onChange={() => handleCheckboxChange(r.label)}
              className='w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer'
            />
            <span className='ml-3 text-sm text-gray-700 capitalize'>
              {formatRangeLabel(r.label)}
            </span>
          </label>
        ))}
      </div>
    </div>
  );
};

export default PriceRangeList;
</file>

<file path="src/Components/Adv-search/ResultsCounter.tsx">
'use client';
import React from 'react';
import { useTranslations } from 'next-intl';

type NoResultsMessageProps = {
  search: string;
};

export const NoResultsMessage: React.FC<NoResultsMessageProps> = ({ search }) => {
  const t = useTranslations('search');
  const trimmed = search?.trim();

  return (
    <div className='text-center py-12'>
      <p className='text-gray-500 text-xl font-roboto font-normal'>
        {t('noResults')}
        {trimmed && (
          <>
            {' '}
            {t('for')} <span className='font-bold'>&quot;{trimmed}&quot;</span>
          </>
        )}
      </p>
    </div>
  );
};

interface ResultsCounterProps {
  total: number;
  loading?: boolean;
}

export function ResultsCounter({ total, loading = false }: ResultsCounterProps) {
  const t = useTranslations('search'); // o 'resultsAdvSearch', donde tengas la key

  return (
    <div className='flex items-center gap-2' style={{ fontFamily: 'Roboto, sans-serif' }}>
      {/* Móvil */}
      <p className='block md:hidden text-sm font-bold text-gray-900 whitespace-nowrap'>
        {t('resultsCountLabel')}{' '}
        {loading ? (
          <span className='inline-block w-4 h-4 border-2 border-gray-900 border-t-transparent rounded-full animate-spin align-middle ml-1' />
        ) : (
          <span className='text-gray-900'>{total}</span>
        )}
      </p>

      {/* Desktop */}
      <div className='hidden md:flex items-center gap-2'>
        <div className='relative w-10 h-10 flex-shrink-0'>
          <svg viewBox='0 0 120 150' className='w-full h-full' xmlns='http://www.w3.org/2000/svg'>
            <path
              d='M 15 20 Q 15 10 25 10 L 95 10 Q 105 10 105 20 L 105 100 L 60 140 L 15 100 Z'
              fill='#E8F4FD'
              stroke='none'
            />
          </svg>

          {/* Ícono dentro del escudo */}
          <div className='absolute inset-0 flex items-center justify-center'>
            <svg className='w-5 h-5 text-blue-600' fill='currentColor' viewBox='0 0 20 20'>
              <path
                fillRule='evenodd'
                d='M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z'
                clipRule='evenodd'
              />
            </svg>
          </div>
        </div>

        {/* Texto */}
        <p className='text-sm font-bold text-gray-900 whitespace-nowrap'>
          {t('resultsCountLabel')}{' '}
          {loading ? (
            <span className='inline-block w-4 h-4 border-2 border-gray-900 border-t-transparent rounded-full animate-spin align-middle ml-1' />
          ) : (
            <span className='text-gray-900'>{total}</span>
          )}
        </p>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/Adv-search/SearchCheckboxes.tsx">
'use client';

import React from 'react';
import { useTranslations } from 'next-intl';

interface SearchCheckboxesProps {
  titleOnly: boolean;
  setTitleOnly: (value: boolean) => void;
  exactWords: boolean;
  setExactWords: (value: boolean) => void;
}

export function SearchCheckboxes({
  titleOnly,
  setTitleOnly,
  exactWords,
  setExactWords,
}: SearchCheckboxesProps) {
  const t = useTranslations('search');

  return (
    <div className='w-full bg-gray-100 border border-gray-200 rounded-lg p-4 mt-4'>
      <div className='flex flex-col gap-3'>
        <label className='flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded transition-colors'>
          <input
            type='checkbox'
            checked={titleOnly}
            onChange={(e) => {
              const checked = e.target.checked;
              setTitleOnly(checked);
              if (checked) setExactWords(false);
            }}
            className='w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 focus:ring-2 cursor-pointer'
          />
          <span className='text-sm text-gray-700'>{t('titleOnly')}</span>
        </label>

        <label className='flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded transition-colors'>
          <input
            type='checkbox'
            checked={exactWords}
            onChange={(e) => {
              const checked = e.target.checked;
              setExactWords(checked);
              if (checked) setTitleOnly(false);
            }}
            className='w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 focus:ring-2 cursor-pointer'
          />
          <span className='text-sm text-gray-700'>{t('exactWords')}</span>
        </label>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/appointments/forms/AppointmentDetails.tsx">
// components/appointments/forms/EditAppointmentForm.tsx
import React, { useState, forwardRef, useImperativeHandle, useRef, useEffect } from 'react';
import LocationModal from './LocationModal';
import { useUserRole } from '@/app/lib/utils/contexts/UserRoleContext';
// Import modules
import { EditAppointmentHeader } from './modules/EditAppointmentHeader';
import { DateTimeDisplaySection } from './modules/DateTimeDisplaySection';
import { ClientSection } from './modules/ClientSection';
import { DescriptionSection } from './modules/DescriptionSection';
import { LocationSection } from './modules/LocationSection';
import { MeetingLinkSection } from './modules/MeetingLinkSection';
import { EditAppointmentActions } from './modules/EditAppointmentActions';

export type AppointmentPayload = {
  datetime: string;
  client: string;
  contact: string;
  modality: 'virtual' | 'presencial';
  description?: string;
  meetingLink?: string;
  place?: string;
  lat?: number;
  lon?: number;
  address?: string;
};

export type ExistingAppointment = AppointmentPayload & {
  id: string;
};

export type EditAppointmentFormHandle = {
  open: (datetime: Date) => void;
  close: () => void;
};

const EditAppointmentForm = forwardRef<EditAppointmentFormHandle>((_props, ref) => {
  const [open, setOpen] = useState(false);
  const [appointmentId, setAppointmentId] = useState<string>('');
  const [datetime, setDatetime] = useState<string>('');
  const [client, setClient] = useState<string>('');
  const [contact, setContact] = useState<string>('+591 ');
  const [modality, setModality] = useState<'virtual' | 'presencial'>('virtual');
  const [description, setDescription] = useState<string>('');
  const [lat, setLat] = useState<number>();
  const [lon, setLon] = useState<number>();
  const [address, setAddress] = useState<string>('');
  const [meetingLink, setMeetingLink] = useState<string>('');
  const [loading] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);
  const [showLocationModal, setShowLocationModal] = useState(false);
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [originalAppointment, setOriginalAppointment] = useState<ExistingAppointment | null>(null);

  const [day, setDay] = useState<string>('');
  const [month, setMonth] = useState<string>('');
  const [hour, setHour] = useState<number>(0);

  const dialogRef = useRef<HTMLDivElement | null>(null);
  const firstFieldRef = useRef<HTMLInputElement | null>(null);
  const { fixer_id: fixerId } = useUserRole();
  const [changesDetected, setChangesDetected] = useState<boolean>(false);
  useEffect(() => {
    if (!originalAppointment) {
      setChangesDetected(false);
      return;
    }

    const originalDate = new Date(originalAppointment.datetime);
    const originalDay = originalDate.getDate().toString().padStart(2, '0');
    const originalMonth = (originalDate.getMonth() + 1).toString().padStart(2, '0');
    const originalHour = originalDate.getHours();

    const hasDateTimeChanges =
      day !== originalDay || month !== originalMonth || hour !== originalHour;
    const hasClientChanges = client.trim() !== originalAppointment.client;
    const hasContactChanges = contact.trim() !== originalAppointment.contact;
    const hasDescriptionChanges =
      (description || '').trim() !== (originalAppointment.description || '').trim();
    const hasModalityChanges = modality !== originalAppointment.modality;

    let hasLocationOrLinkChanges = false;
    if (modality === 'presencial') {
      hasLocationOrLinkChanges =
        (lat ?? 0) !== (originalAppointment.lat ?? 0) ||
        (lon ?? 0) !== (originalAppointment.lon ?? 0) ||
        (address || '') !== (originalAppointment.address || '');
    } else {
      hasLocationOrLinkChanges =
        (meetingLink || '').trim() !== (originalAppointment.meetingLink || '').trim();
    }

    const anyChange =
      hasDateTimeChanges ||
      hasClientChanges ||
      hasContactChanges ||
      hasDescriptionChanges ||
      hasModalityChanges ||
      hasLocationOrLinkChanges;

    setChangesDetected(anyChange);
  }, [
    day,
    month,
    hour,
    client,
    contact,
    description,
    modality,
    lat,
    lon,
    address,
    meetingLink,
    originalAppointment,
  ]);

  useImperativeHandle(ref, () => ({
    open: async (datetime: Date) => {
      const API = process.env.NEXT_PUBLIC_BACKEND as string;
      const appointment_date = datetime.toISOString().split('T')[0];
      const start_hour = datetime.getHours().toString();
      console.log('Date', appointment_date);
      console.log('Hora', start_hour);
      const url = `${API}/api/crud_read/appointments/get_appointment_by_fixer_hour?fixer_id=${fixerId}&date=${appointment_date}&hour=${start_hour}`;

      const res = await fetch(url);
      if (!res.ok) {
        const errorText = await res.text();
        console.error('Respuesta no OK:', res.status, errorText);
        throw new Error(`No se encuentra este dato: ${res.status} - ${errorText}`);
      }

      const data = await res.json();
      console.log('Datos recibidos para editar cita:', data);
      /*if(data.appointment[0].schedule_state === 'cancelled' || data.appointment[0].cancelled_fixer){
                alert('No se puede editar una cita cancelada.');
                return;
            }*/
      if (data.appointment[0].appointment_type != 'virtual') {
        if (data.appointment[0].appointment_type != 'presencial') {
          data.appointment[0].appointment_type = 'presencial';
        }
      }
      setAppointmentId(data.appointment[0]._id);
      setDatetime(datetime.toISOString());
      setClient(data.appointment[0].current_requester_name);
      setContact(data.appointment[0].current_requester_phone);
      setModality(data.appointment[0].appointment_type);
      setDescription(data.appointment[0].appointment_description || '');
      setLat(Number(data.appointment[0].lat));
      setLon(Number(data.appointment[0].lon));
      setAddress(data.appointment[0].display_name_location || '');
      setMeetingLink(data.appointment[0].link_id || '');
      setOriginalAppointment(data.appointment[0]);

      const dateObj = new Date(data.appointment[0].datetime);
      setDay(dateObj.getDate().toString().padStart(2, '0'));
      setMonth((dateObj.getMonth() + 1).toString().padStart(2, '0'));
      setHour(dateObj.getHours());

      setOpen(true);
      setTimeout(() => firstFieldRef.current?.focus(), 40);
    },
    close: () => handleClose(),
  }));

  useEffect(() => {
    function onKey(e: KeyboardEvent) {
      if (e.key === 'Escape' && open) handleClose();
    }
    document.addEventListener('keydown', onKey);
    return () => document.removeEventListener('keydown', onKey);
  }, [open]);

  function handleClose() {
    setOpen(false);
    setAppointmentId('');
    setClient('');
    setContact('+591 ');
    setModality('virtual');
    setDescription('');
    setLat(0);
    setLon(0);
    setAddress('');
    setMeetingLink('');
    setDay('');
    setMonth('');
    setHour(0);
    setMsg(null);
    setErrors({});
  }
  async function handleDeleteAppointment() {
    try {
      //const url = `${API}/api/crud_update/appointments/update_cancell_appointment_fixer`;
      console.log('Eliminando cita con ID:', appointmentId);
    } catch (error) {
      console.error('Error al eliminar la cita:', error);
    }
    handleClose();
  }

  const handleLocationConfirm = (locationData: { lat: number; lon: number; address: string }) => {
    console.log('Datos de ubicación confirmados:', locationData);
  };

  if (!open) return null;

  return (
    <>
      <div className='fixed inset-0 z-50 flex items-center justify-center px-4'>
        <div className='absolute inset-0 bg-black/50' onClick={handleClose} aria-hidden='true' />
        <div
          ref={dialogRef}
          role='dialog'
          aria-modal='true'
          aria-labelledby='edit-appointment-title'
          className='relative bg-white rounded-lg shadow-xl w-full max-w-xl mx-auto overflow-auto'
          style={{ maxHeight: '90vh' }}
        >
          <div className='p-4 sm:p-6 text-black'>
            <EditAppointmentHeader onClose={handleClose} title='Detalles de la Cita' />

            <DateTimeDisplaySection
              datetime={datetime}
              modality={modality}
              onModalityChange={setModality}
            />

            <ClientSection
              client={client}
              contact={contact}
              errors={errors}
              ref={firstFieldRef}
              onClientChange={setClient}
              onContactChange={setContact}
              readonly={true}
            />

            <DescriptionSection
              description={description}
              error={errors.description}
              onChange={setDescription}
              readOnly={true}
            />

            {modality === 'presencial' ? (
              <LocationSection
                address={address}
                error={errors.location}
                onOpenLocationModal={() => setShowLocationModal(true)}
                formtype='view'
              />
            ) : (
              <MeetingLinkSection
                meetingLink={meetingLink}
                error={errors.meetingLink}
                onChange={setMeetingLink}
                readonly={true}
              />
            )}
            <LocationModal
              open={showLocationModal}
              onClose={() => setShowLocationModal(false)}
              onConfirm={handleLocationConfirm}
              initialCoords={
                lat !== undefined && lon !== undefined
                  ? {
                      lat: lat,
                      lon: lon,
                      address: address,
                    }
                  : undefined
              }
              formtype='view'
            />

            {msg && <p className='text-sm text-red-600'>{msg}</p>}

            <EditAppointmentActions
              loading={loading}
              changesDetected={changesDetected}
              onCancel={handleClose}
              onDelete={handleDeleteAppointment}
              submitDisabled={modality === 'presencial' && !address}
              formType='view'
            />
          </div>
        </div>
      </div>
    </>
  );
});
EditAppointmentForm.displayName = 'EditAppointmentForm';
export default EditAppointmentForm;
</file>

<file path="src/Components/appointments/forms/AppointmentForm.tsx">
import React, { useState, forwardRef, useImperativeHandle, useRef, useEffect } from 'react';
import axios from 'axios';
import { z } from 'zod';
import LocationModal from './LocationModal';
import AppointmentSummaryModal from './AppointmentSummaryModal';

export type AppointmentFormHandle = {
  open: (datetimeISO: string) => void;
  close: () => void;
};

interface AppointmentFormProps {
  //    mode: 'create' | 'edit' | 'view' | 'reschedule';
  fixerId: string;
  requesterId: string;
}

// Zod esquema de validacion
const baseSchema = z.object({
  client: z
    .string()
    .regex(/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/, 'Ingrese un nombre de cliente válido')
    .nonempty('Ingrese un nombre de cliente')
    .max(50, 'El nombre no puede tener más de 50 caracteres'),

  contact: z
    .string()
    .regex(/^[67]\d{7}$/, 'Ingrese un número de teléfono válido')
    .nonempty('Ingrese un número de teléfono'),

  description: z
    .string()
    .nonempty('Ingrese una descripción de trabajo')
    .max(300, 'La descripción no puede tener más de 300 caracteres'),
});

const virtualSchema = baseSchema.extend({
  modality: z.literal('virtual'),
  meetingLink: z
    .string()
    .regex(
      /^(https?:\/\/)?(meet\.google\.com|zoom\.us)\/[^\s]+$/,
      'Ingrese un enlace válido de Meet o Zoom',
    )
    .nonempty('Ingrese un enlace de Meet o Zoom'),
  location: z.undefined().optional(),
});

const presentialSchema = baseSchema.extend({
  modality: z.literal('presential'),
  meetingLink: z.undefined().optional(),
  location: z
    .object({
      lat: z.number(),
      lon: z.number(),
      address: z.string().nonempty('Seleccione una ubicación'),
    })
    .nullable()
    .refine((val) => val !== null, { message: 'Seleccione una ubicación' })
    .refine((val) => val?.address !== 'No se pudo obtener la dirección', {
      message: 'Seleccione una ubicación.',
    }),
});

const appointmentSchema = z.discriminatedUnion('modality', [virtualSchema, presentialSchema]);

const AppointmentForm = forwardRef<AppointmentFormHandle, AppointmentFormProps>(
  ({ fixerId, requesterId }, ref) => {
    const [open, setOpen] = useState(false);
    const [datetime, setDatetime] = useState<string>('');
    const [client, setClient] = useState<string>('');
    const [contact, setContact] = useState<string>('');
    const [modality, setModality] = useState<'virtual' | 'presential'>('virtual');
    const [description, setDescription] = useState<string>('');
    const [place, setPlace] = useState<string>('');
    const [meetingLink, setMeetingLink] = useState<string>('');
    const [location, setLocation] = useState<{ lat: number; lon: number; address: string } | null>(
      null,
    );
    const [loading, setLoading] = useState(false);
    const [errors, setErrors] = useState<Record<string, string>>({});

    const [showLocationModal, setShowLocationModal] = useState(false);
    const [showSummary, setShowSummary] = useState(false);
    const [summaryData, setSummaryData] = useState<{
      title: string;
      name: string;
      date: string;
      time: string;
      modality: 'virtual' | 'presential';
      locationOrLink: string;
      description?: string;
    } | null>(null);

    const dialogRef = useRef<HTMLDivElement | null>(null);
    const firstFieldRef = useRef<HTMLInputElement | null>(null);

    useImperativeHandle(
      ref,
      () => ({
        open: (dt: string) => {
          setDatetime(dt);
          setOpen(true);
          setTimeout(() => firstFieldRef.current?.focus(), 40);
        },
        close: () => handleClose(),
      }),
      [],
    );

    useEffect(() => {
      function onKey(e: KeyboardEvent) {
        if (e.key === 'Escape' && open) handleClose();
      }
      document.addEventListener('keydown', onKey);
      return () => document.removeEventListener('keydown', onKey);
    }, [open]);

    function handleClose() {
      setOpen(false);
      setClient('');
      setContact('');
      setDescription('');
      setModality('virtual');
      setPlace('');
      setMeetingLink('');
      setLocation(null);
      setErrors({});
    }

    function parseDatetime(datetimeISO: string) {
      console.log('create.parsingDatetime', { inputISO: datetimeISO });

      // Parsear la fecha que llega (UTC)
      const originalDate = new Date(datetimeISO);

      // Restar 4 horas para el backend
      const adjustedStart = new Date(originalDate.getTime() - 4 * 60 * 60 * 1000);
      const adjustedEnd = new Date(adjustedStart.getTime() + 60 * 60 * 1000);

      console.log('create.adjustedStart', adjustedStart.toISOString());
      console.log('create.adjustedEnd', adjustedEnd.toISOString());

      return {
        selected_date: adjustedStart.toISOString().split('T')[0],
        starting_time: adjustedStart.toISOString(),
        finishing_time: adjustedEnd.toISOString(),
      };
    }

    const handleLocationConfirm = (locationData: { lat: number; lon: number; address: string }) => {
      setLocation(locationData);
      setPlace(locationData.address);
      setShowLocationModal(false);
    };

    async function handleSubmit(e: React.FormEvent) {
      e.preventDefault();
      setErrors({});

      const formData = {
        client,
        contact,
        description,
        modality,
        meetingLink: modality === 'virtual' ? meetingLink : undefined,
        location: modality === 'presential' ? location : undefined,
      };

      const validation = appointmentSchema.safeParse(formData);
      if (!validation.success) {
        const fieldErrors: Record<string, string> = {};
        validation.error.issues.forEach((err) => {
          const key = err.path && err.path.length ? err.path.join('.') : 'general';
          const normalizedKey = key.startsWith('location') ? 'location' : key;
          fieldErrors[normalizedKey] = err.message;
        });
        setErrors(fieldErrors);
        return;
      }

      const { selected_date, starting_time, finishing_time } = parseDatetime(datetime);

      const payload = {
        id_fixer: fixerId,
        id_requester: requesterId,
        selected_date,
        starting_time,
        finishing_time,
        schedule_state: 'booked',
        appointment_type: modality,
        appointment_description: description,
        current_requester_name: client,
        current_requester_phone: contact,
        link_id: modality === 'virtual' ? meetingLink : '',
        display_name_location: modality === 'presential' ? place : '',
        lat: modality === 'presential' ? location?.lat : null,
        lon: modality === 'presential' ? location?.lon : null,
      };

      setLoading(true);
      try {
        const res = await axios.post(
          'https://servineo-backend-lorem.onrender.com/api/crud_create/appointments/create',
          payload,
        );
        const data = res.data;

        if (data && data.success === false) {
          setErrors({ general: data.message || 'No se pudo crear la cita.' });
          setLoading(false);
          return;
        }

        const hourToShow = new Date(payload.starting_time).getUTCHours();
        let hourToShowString;

        if (hourToShow < 10) {
          hourToShowString = '0' + hourToShow.toString() + ':00';
        } else {
          hourToShowString = hourToShow.toString() + ':00';
        }

        if (data.success) {
          setSummaryData({
            title: 'Cita agendada con éxito',
            name: client,
            date: new Date(payload.starting_time).toLocaleDateString(),
            time: hourToShowString,
            //time: new Date(payload.starting_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), para futuro
            modality,
            locationOrLink: modality === 'virtual' ? meetingLink : place,
            description,
          });
          setShowSummary(true);
        }
      } catch (err: unknown) {
        console.error(err);
        setErrors({ general: 'Error: No se pudo crear la cita' });
      } finally {
        setLoading(false);
      }
    }

    if (!open) return null;

    return (
      <>
        <div className='fixed inset-0 z-50 flex items-center justify-center px-4'>
          <div className='absolute inset-0 bg-black/50' onClick={handleClose} aria-hidden='true' />
          <div
            ref={dialogRef}
            role='dialog'
            aria-modal='true'
            aria-labelledby='appointment-title'
            className='relative bg-white rounded-lg shadow-xl w-full max-w-xl mx-auto overflow-auto'
            style={{ maxHeight: '90vh' }}
          >
            <div className='p-4 sm:p-6'>
              <div className='flex items-start justify-between'>
                <h3 id='appointment-title' className='text-lg font-semibold text-black'>
                  Agendar cita
                </h3>
                <button
                  aria-label='Cerrar'
                  className='text-gray-500 hover:text-gray-700'
                  onClick={handleClose}
                >
                  ✕
                </button>
              </div>

              <form onSubmit={handleSubmit} className='mt-4 space-y-4 text-black'>
                {/* Campos del formulario */}
                <div className='grid grid-cols-1 sm:grid-cols-2 gap-3 p-3 rounded'>
                  <label className='block'>
                    <span className='text-sm font-medium'>Fecha y hora *</span>
                    <input
                      readOnly
                      value={new Date(datetime).toLocaleString()}
                      className='mt-1 block w-full bg-gray-100 border border-gray-200 rounded px-3 py-2 text-sm'
                    />
                  </label>

                  <label className='block'>
                    <span className='text-sm font-medium'>Modalidad *</span>
                    <select
                      value={modality}
                      onChange={(e) => setModality(e.target.value as 'virtual' | 'presential')}
                      className='mt-1 block w-full border rounded px-3 py-2 text-sm'
                    >
                      <option value='virtual'>Virtual</option>
                      <option value='presential'>Presencial</option>
                    </select>
                  </label>
                </div>

                <div className='grid grid-cols-1 sm:grid-cols-2 gap-3'>
                  <label className='block'>
                    <span className='text-sm font-medium'>Cliente *</span>
                    <input
                      ref={firstFieldRef}
                      value={client}
                      onChange={(e) => setClient(e.target.value)}
                      placeholder='Nombre del cliente'
                      className='mt-1 block w-full border rounded px-3 py-2 bg-white'
                    />
                    {errors.client && <p className='text-red-600 text-sm mt-1'>{errors.client}</p>}
                  </label>
                  <label className='block'>
                    <span className='text-sm font-medium'>Contacto *</span>
                    <input
                      value={contact}
                      onChange={(e) => setContact(e.target.value)}
                      placeholder='7XXXXXXX'
                      className='mt-1 block w-full border rounded px-3 py-2 bg-white'
                    />
                    {errors.contact && (
                      <p className='text-red-600 text-sm mt-1'>{errors.contact}</p>
                    )}
                  </label>
                </div>

                <label className='block'>
                  <span className='text-sm font-medium'>Descripción del trabajo *</span>
                  <textarea
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    placeholder='Breve descripción del trabajo requerido'
                    className='mt-1 block w-full border rounded px-3 py-2 bg-white'
                    rows={3}
                  />
                  {errors.description && (
                    <p className='text-red-600 text-sm mt-1'>{errors.description}</p>
                  )}
                </label>

                {modality === 'presential' && (
                  <>
                    <div
                      onClick={() => setShowLocationModal(true)}
                      className='text-center py-3 border border-gray-300 rounded-lg bg-gray-50 hover:bg-gray-100 cursor-pointer'
                    >
                      <p className='text-sm font-medium text-gray-700'>
                        📍 {place ? 'Editar ubicación' : 'Seleccionar ubicación'}
                      </p>
                    </div>
                    {place && (
                      <p className='text-sm text-green-700 px-2 mt-1'>📌 Ubicación: {place}</p>
                    )}
                    {errors.location && (
                      <p className='text-red-600 text-sm mt-1'>{errors.location}</p>
                    )}
                  </>
                )}

                {modality === 'virtual' && (
                  <label className='block'>
                    <span className='text-sm font-medium'>Enlace de reunión *</span>
                    <input
                      value={meetingLink}
                      onChange={(e) => setMeetingLink(e.target.value)}
                      placeholder='https://meet.example.com/'
                      className='mt-1 block w-full border rounded px-3 py-2 bg-white'
                    />
                    {errors.meetingLink && (
                      <p className='text-red-600 text-sm mt-1'>{errors.meetingLink}</p>
                    )}
                  </label>
                )}

                {errors.general && <p className='text-red-600 text-sm mt-1'>{errors.general}</p>}

                <div className='flex items-center justify-end gap-2 pt-2'>
                  <button
                    type='button'
                    onClick={handleClose}
                    className='px-4 py-2 rounded bg-gray-300 text-sm'
                  >
                    Cancelar
                  </button>
                  <button
                    type='submit'
                    disabled={loading}
                    className='px-4 py-2 rounded bg-[#2B6AE0] text-white text-sm disabled:opacity-60 disabled:cursor-not-allowed'
                  >
                    {loading ? 'Guardando...' : 'Añadir'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <LocationModal
          open={showLocationModal}
          onClose={() => setShowLocationModal(false)}
          onConfirm={handleLocationConfirm}
          initialCoords={location}
        />

        {summaryData && (
          <AppointmentSummaryModal
            open={showSummary}
            onClose={() => {
              setShowSummary(false);
              handleClose();
            }}
            data={summaryData}
          />
        )}
      </>
    );
  },
);
AppointmentForm.displayName = 'AppointmentForm';
export default AppointmentForm;
</file>

<file path="src/Components/appointments/forms/AppointmentSummaryModal.tsx">
import React from 'react';

import { useAppointmentsContext } from '@/app/lib/utils/contexts/AppointmentsContext/AppoinmentsContext';

interface AppointmentSummaryModalProps {
  open: boolean;
  onClose: () => void;
  data: {
    title: string;
    name: string;
    date: string;
    time: string;
    modality: 'virtual' | 'presential';
    locationOrLink: string;
    description?: string;
  };
}

const AppointmentSummaryModal: React.FC<AppointmentSummaryModalProps> = ({
  open,
  onClose,
  data,
}) => {
  const { refetchAll } = useAppointmentsContext();

  if (!open) return null;

  return (
    <div className='fixed inset-0 z-50 flex items-center justify-center px-4'>
      <div className='absolute inset-0 bg-black/50' onClick={onClose} aria-hidden='true' />
      <div className='relative bg-white rounded-xl shadow-2xl w-full max-w-md mx-auto p-6 z-10'>
        <div className='flex flex-col items-center'>
          {/* Icono de check centrado y verde */}
          <div className='w-12 h-12 rounded-full bg-green-100 flex items-center justify-center mb-4'>
            <svg
              className='w-8 h-8 text-green-600'
              fill='none'
              stroke='currentColor'
              strokeWidth='2'
              viewBox='0 0 24 24'
            >
              <path strokeLinecap='round' strokeLinejoin='round' d='M5 13l4 4L19 7' />
            </svg>
          </div>

          <h2 className='text-xl font-semibold text-gray-800 mb-4 text-center'>{data.title}</h2>
        </div>
        <div className='space-y-3 text-sm text-gray-700'>
          <div className='flex justify-between'>
            <span className='font-medium text-gray-500'>Nombre:</span>
            <span>{data.name}</span>
          </div>
          <div className='flex justify-between'>
            <span className='font-medium text-gray-500'>Fecha:</span>
            <span>{data.date}</span>
          </div>
          <div className='flex justify-between'>
            <span className='font-medium text-gray-500'>Hora:</span>
            <span>{data.time}</span>
          </div>
          <div className='flex justify-between'>
            <span className='font-medium text-gray-500'>Modalidad:</span>
            <span>{data.modality === 'virtual' ? 'Virtual' : 'Presencial'}</span>
          </div>
          <div className='flex justify-between items-start'>
            <span className='font-medium text-gray-500'>
              {data.modality === 'virtual' ? '🔗 Enlace:' : 'Ubicación:'}
            </span>
            <span className='text-right break-words max-w-[60%]'>{data.locationOrLink}</span>
          </div>
          <div>
            <span className='font-medium text-gray-500 block mb-1'>Descripción:</span>
            <p className='bg-gray-100 rounded p-2 text-sm'>{data.description}</p>
          </div>
        </div>

        <div className='mt-6 flex justify-between gap-2'>
          <button
            onClick={() => {
              onClose();
              refetchAll();
            }}
            className='px-4 py-2 bg-[#2B6AE0] text-white rounded hover:brightness-110 text-sm'
          >
            Aceptar
          </button>
        </div>
      </div>
    </div>
  );
};

export default AppointmentSummaryModal;
</file>

<file path="src/Components/appointments/forms/CancelDaysAppointment.tsx">
import React, { useState, useEffect } from 'react';
import { Button } from '../../atoms/button';
import axios from 'axios';
import { AlertPopup } from '../forms/popups/AlertPopup';
import { useAppointmentsContext } from '@/app/lib/utils/contexts/AppointmentsContext/AppoinmentsContext';

interface Appointment {
  _id: string;
  selected_date: string;
  client_name?: string;
  service_type?: string;
  cancelled_fixer?: boolean;
}

interface DayWithAppointments {
  date: string;
  appointmentCount: number;
  dayName: string;
  dayNumber: number;
  monthName: string;
  appointmentIds: string[];
  appointments: Appointment[];
}

interface CancelDaysAppointmentsProps {
  isOpen: boolean;
  onClose: () => void;
  loading?: boolean;
  fixer_id?: string;
}

export const CancelDaysAppointments: React.FC<CancelDaysAppointmentsProps> = ({
  isOpen,
  onClose,
  loading = false,
  fixer_id,
}) => {
  const { refetchAll } = useAppointmentsContext();

  const FIXER_ID = fixer_id;

  const [selectedDays, setSelectedDays] = useState<string[]>([]);
  const [daysWithAppointments, setDaysWithAppointments] = useState<DayWithAppointments[]>([]);
  const [currentMonth, setCurrentMonth] = useState(new Date().getMonth());
  const [currentYear, setCurrentYear] = useState(new Date().getFullYear());
  const [fetchLoading, setFetchLoading] = useState(false);
  const [cancelLoading, setCancelLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);
  const [showConfirmPopup, setShowConfirmPopup] = useState(false);
  const [totalAppointmentsToCancel, setTotalAppointmentsToCancel] = useState(0);

  const API_BASE = 'https://servineo-backend-lorem.onrender.com/api';

  const months = [
    'Enero',
    'Febrero',
    'Marzo',
    'Abril',
    'Mayo',
    'Junio',
    'Julio',
    'Agosto',
    'Septiembre',
    'Octubre',
    'Noviembre',
    'Diciembre',
  ];

  const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];

  const normalizeDate = (dateString: string): { normalizedDate: string; localDate: Date } => {
    try {
      const utcDate = new Date(dateString);
      const localDate = new Date(utcDate.getTime() + utcDate.getTimezoneOffset() * 60000);

      const year = localDate.getFullYear();
      const month = String(localDate.getMonth() + 1).padStart(2, '0');
      const day = String(localDate.getDate()).padStart(2, '0');

      return {
        normalizedDate: `${year}-${month}-${day}`,
        localDate: localDate,
      };
    } catch (error: unknown) {
      const fallbackDate = new Date(dateString.split('T')[0]);
      console.error('Error normalizando la fecha:', error);
      return {
        normalizedDate: dateString.split('T')[0],
        localDate: fallbackDate,
      };
    }
  };

  const fetchDaysWithAppointments = async (month: number, year: number) => {
    setFetchLoading(true);
    setError(null);

    try {
      const date = `${year}-${String(month + 1).padStart(2, '0')}-01`;

      const response = await axios.get(
        `${API_BASE}/crud_read/appointments/get_all_appointments_by_fixer_date`,
        {
          params: {
            id_fixer: FIXER_ID,
            date: date,
          },
        },
      );

      if (
        response.data &&
        response.data.appointments &&
        Array.isArray(response.data.appointments)
      ) {
        const appointmentsByDay: {
          [key: string]: {
            count: number;
            ids: string[];
            localDate: Date;
            appointments: Appointment[];
          };
        } = {};

        response.data.appointments.forEach((appointment: Appointment) => {
          if (appointment && appointment.selected_date && !appointment.cancelled_fixer) {
            try {
              const { normalizedDate, localDate } = normalizeDate(appointment.selected_date);

              if (!appointmentsByDay[normalizedDate]) {
                appointmentsByDay[normalizedDate] = {
                  count: 0,
                  ids: [],
                  localDate: localDate,
                  appointments: [],
                };
              }

              appointmentsByDay[normalizedDate].count += 1;
              appointmentsByDay[normalizedDate].ids.push(appointment._id);
              appointmentsByDay[normalizedDate].appointments.push(appointment);
            } catch (dateError) {
              console.error('Error procesando fecha:', dateError);
            }
          }
        });

        const formattedData: DayWithAppointments[] = Object.entries(appointmentsByDay).map(
          ([date, data]) => {
            const localDate = data.localDate;

            return {
              date: date,
              appointmentCount: data.count,
              dayName: dayNames[localDate.getDay()],
              dayNumber: localDate.getDate(),
              monthName: months[localDate.getMonth()],
              appointmentIds: data.ids,
              appointments: data.appointments,
            };
          },
        );

        formattedData.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
        return formattedData;
      } else {
        return [];
      }
    } catch (error: unknown) {
      console.error('Error fetching appointments:', error);
      setError('Error al cargar las citas');
      return [];
    } finally {
      setFetchLoading(false);
    }
  };

  const cancelAppointmentsForDay = async (day: DayWithAppointments) => {
    let successCount = 0;
    let failedCount = 0;

    for (const appointmentId of day.appointmentIds) {
      try {
        console.log('Canceling appointment ID:', appointmentId);

        const response = await axios.put(
          `${API_BASE}/crud_update/appointments/update_cancell_appointment_fixer?appointment_id=${appointmentId}`,
          {},
          {
            headers: {
              'Content-Type': 'application/json',
            },
          },
        );

        if (response.data && response.data.succeed === true) {
          successCount++;
        } else {
          failedCount++;
        }
      } catch (error: unknown) {
        console.error('Error canceling appointment ID:', appointmentId, error);
        failedCount++;
      }
    }

    return { success: successCount, failed: failedCount };
  };

  const handleConfirm = async () => {
    if (cancelLoading || selectedDays.length === 0) return;

    // Calcular el total de citas a cancelar
    const total = daysWithAppointments
      .filter((day) => selectedDays.includes(day.date))
      .reduce((sum, day) => sum + day.appointmentCount, 0);

    setTotalAppointmentsToCancel(total);
    setShowConfirmPopup(true);
  };

  const executeCancellation = async () => {
    const selectedDaysData = daysWithAppointments.filter((day) => selectedDays.includes(day.date));
    setError(null);
    setSuccessMessage(null);
    setCancelLoading(true);

    try {
      let totalSuccess = 0;
      let totalFailed = 0;

      for (const day of selectedDaysData) {
        const result = await cancelAppointmentsForDay(day);
        totalSuccess += result.success;
        totalFailed += result.failed;
      }

      if (totalSuccess > 0) {
        const successMsg = `Se cancelaron ${totalSuccess} cita${totalSuccess !== 1 ? 's' : ''}`;
        if (totalFailed > 0) {
          setSuccessMessage(
            `${successMsg}. ${totalFailed} cita${totalFailed !== 1 ? 's' : ''} no se pudieron cancelar.`,
          );
        } else {
          setSuccessMessage(successMsg);
        }

        setSelectedDays([]);

        // Cerrar el modal después de un breve delay y recargar la página
        setTimeout(() => {
          onClose();
          refetchAll();
        }, 1500);
      } else {
        setError('No se pudo cancelar ninguna cita');
        setShowConfirmPopup(false);
      }
    } catch (error: unknown) {
      setError('Error al cancelar las citas');
      setShowConfirmPopup(false);
      console.error('Error during cancellation process:', error);
    } finally {
      setCancelLoading(false);
    }
  };

  useEffect(() => {
    const loadData = async () => {
      if (isOpen) {
        const data = await fetchDaysWithAppointments(currentMonth, currentYear);
        setDaysWithAppointments(data || []);
        setSelectedDays([]);
        setError(null);
        setSuccessMessage(null);
        setTotalAppointmentsToCancel(0);
      }
    };

    loadData();
  });

  const toggleDaySelection = (date: string) => {
    setSelectedDays((prev) => {
      if (prev.includes(date)) {
        return prev.filter((d) => d !== date);
      } else if (prev.length < 5) {
        return [...prev, date];
      }
      return prev;
    });
  };

  const changeMonth = (direction: 'prev' | 'next') => {
    if (direction === 'next') {
      if (currentMonth === 11) {
        setCurrentMonth(0);
        setCurrentYear(currentYear + 1);
      } else {
        setCurrentMonth(currentMonth + 1);
      }
    } else {
      if (currentMonth === 0) {
        setCurrentMonth(11);
        setCurrentYear(currentYear - 1);
      } else {
        setCurrentMonth(currentMonth - 1);
      }
    }
  };

  if (!isOpen) return null;

  const isLoading = loading || cancelLoading;

  return (
    <div className='fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 sm:p-4'>
      <div className='bg-white rounded-lg w-full max-w-md mx-auto max-h-[95vh] sm:max-h-[90vh] overflow-hidden flex flex-col'>
        {/* Header */}
        <div className=' h-12 px-3 sm:px-4 flex items-center justify-between flex-shrink-0'>
          <div className='w-6'></div>
          <h3 className='text-white font-semibold text-base sm:text-lg text-center'>
            Cancelar Citas por Día
          </h3>
          <button
            onClick={onClose}
            className='text-white hover:text-gray-200 transition-colors'
            disabled={isLoading}
          >
            <svg
              xmlns='http://www.w3.org/2000/svg'
              fill='none'
              viewBox='0 0 24 24'
              strokeWidth={2.5}
              stroke='currentColor'
              className='w-5 h-5 sm:w-6 sm:h-6'
            >
              <path strokeLinecap='round' strokeLinejoin='round' d='M6 18L18 6M6 6l12 12' />
            </svg>
          </button>
        </div>

        {/* Content */}
        <div className='flex-1 overflow-hidden flex flex-col'>
          {/* Messages */}
          {(error || successMessage) && (
            <div className='flex-shrink-0 px-3 sm:px-4 pt-3 sm:pt-4'>
              {error && (
                <div className='bg-red-100 border border-red-400 text-red-700 px-3 py-2 sm:px-4 sm:py-3 rounded text-sm sm:text-base'>
                  {error}
                </div>
              )}
              {successMessage && (
                <div className='bg-green-100 border border-green-400 text-green-700 px-3 py-2 sm:px-4 sm:py-3 rounded text-sm sm:text-base'>
                  {successMessage}
                </div>
              )}
            </div>
          )}

          {/* Month Navigation */}
          <div className='flex items-center justify-between sm:justify-center sm:space-x-4 py-3 sm:py-4 flex-shrink-0 px-3 sm:px-0'>
            <button
              onClick={() => changeMonth('prev')}
              className='text-gray-600 hover:text-gray-800 transition-colors disabled:opacity-50 p-1'
              disabled={fetchLoading || isLoading}
            >
              <svg
                xmlns='http://www.w3.org/2000/svg'
                fill='none'
                viewBox='0 0 24 24'
                strokeWidth={2}
                stroke='currentColor'
                className='w-5 h-5'
              >
                <path
                  strokeLinecap='round'
                  strokeLinejoin='round'
                  d='M15.75 19.5L8.25 12l7.5-7.5'
                />
              </svg>
            </button>

            <h2 className='text-black text-lg sm:text-xl text-center font-medium'>
              {months[currentMonth]} {currentYear}
              {fetchLoading && (
                <span className='text-sm font-normal block sm:inline sm:ml-2 mt-1 sm:mt-0'>
                  (Cargando...)
                </span>
              )}
            </h2>

            <button
              onClick={() => changeMonth('next')}
              className='text-gray-600 hover:text-gray-800 transition-colors disabled:opacity-50 p-1'
              disabled={fetchLoading || isLoading}
            >
              <svg
                xmlns='http://www.w3.org/2000/svg'
                fill='none'
                viewBox='0 0 24 24'
                strokeWidth={2}
                stroke='currentColor'
                className='w-5 h-5'
              >
                <path strokeLinecap='round' strokeLinejoin='round' d='M8.25 4.5l7.5 7.5-7.5 7.5' />
              </svg>
            </button>
          </div>

          {/* Days List */}
          <div className='px-3 sm:px-6 pb-3 sm:pb-4 flex-1 overflow-y-auto'>
            {fetchLoading ? (
              <div className='text-center py-6 sm:py-8'>
                <div className='inline-block animate-spin rounded-full h-7 w-7 sm:h-8 sm:w-8 border-b-2 border-blue-600'></div>
                <p className='mt-2 text-gray-600 text-sm sm:text-base'>Cargando citas...</p>
              </div>
            ) : daysWithAppointments.length === 0 ? (
              <div className='text-center py-6 sm:py-8 text-gray-500 text-sm sm:text-base'>
                No hay citas programadas para {months[currentMonth]} {currentYear}
              </div>
            ) : (
              <>
                <p className='text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4 text-center'>
                  Selecciona los días que deseas cancelar (máximo 5)
                </p>

                <div className='space-y-2 sm:space-y-3'>
                  {daysWithAppointments.map((day) => (
                    <div
                      key={day.date}
                      className={`text-black flex items-center justify-between p-3 sm:p-4 border-2 rounded-lg cursor-pointer transition-all ${
                        selectedDays.includes(day.date)
                          ? 'bg-blue-50 border-blue-500 shadow-sm'
                          : 'border-gray-200 hover:bg-gray-50 hover:border-gray-300'
                      } ${isLoading ? 'opacity-50 pointer-events-none' : ''}`}
                      onClick={() => !isLoading && toggleDaySelection(day.date)}
                    >
                      <div className='flex flex-col flex-1 min-w-0'>
                        <span className='font-semibold text-base sm:text-lg truncate'>
                          {day.dayName} {day.dayNumber} de {day.monthName}
                        </span>
                        <span className='text-xs sm:text-sm text-gray-600 mt-1'>
                          {day.appointmentCount}{' '}
                          {day.appointmentCount === 1 ? 'cita programada' : 'citas programadas'}
                        </span>
                      </div>

                      <div
                        className={`flex-shrink-0 w-5 h-5 sm:w-6 sm:h-6 border-2 rounded flex items-center justify-center transition-colors ml-2 ${
                          selectedDays.includes(day.date)
                            ? 'bg-blue-600 border-blue-600'
                            : 'border-gray-400'
                        }`}
                      >
                        {selectedDays.includes(day.date) && (
                          <svg
                            xmlns='http://www.w3.org/2000/svg'
                            viewBox='0 0 20 20'
                            fill='currentColor'
                            className='w-3 h-3 sm:w-4 sm:h-4 text-white'
                          >
                            <path
                              fillRule='evenodd'
                              d='M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z'
                              clipRule='evenodd'
                            />
                          </svg>
                        )}
                      </div>
                    </div>
                  ))}
                </div>

                <div className='mt-4 sm:mt-6 p-2 sm:p-3 bg-gray-50 rounded-lg text-left'>
                  <strong className='text-gray-800 text-sm sm:text-base'>
                    Seleccionado: {selectedDays.length}
                  </strong>
                </div>
              </>
            )}
          </div>
        </div>
        <div className='border-t p-3 sm:p-4 flex justify-end space-x-2 sm:space-x-3 flex-shrink-0'>
          <Button
            onClick={handleConfirm}
            loading={cancelLoading}
            disabled={selectedDays.length === 0 || isLoading}
            className='bg-red-600 hover:bg-red-700 text-white px-4 sm:px-6 py-2 font-medium disabled:opacity-50 min-w-28 sm:min-w-32 text-sm sm:text-base'
          >
            {cancelLoading ? 'Cancelando...' : `Cancelar`}
          </Button>

          <AlertPopup
            open={showConfirmPopup}
            onClose={() => setShowConfirmPopup(false)}
            variant='confirm'
            title='Confirmar Cancelación'
            message={
              <div>
                ¿Está seguro de que desea cancelar las citas de {selectedDays.length} día
                {selectedDays.length !== 1 ? 's' : ''} ({totalAppointmentsToCancel} cita
                {totalAppointmentsToCancel !== 1 ? 's' : ''}) seleccionado
                {selectedDays.length !== 1 ? 's' : ''}?
                <br />
                <span className='text-red-600 font-medium'>Esta acción no se puede deshacer.</span>
              </div>
            }
            confirmLabel='Sí, Cancelar'
            cancelLabel='Volver'
            onConfirm={executeCancellation}
          />
        </div>
      </div>
    </div>
  );
};

export default CancelDaysAppointments;
</file>

<file path="src/Components/appointments/forms/DayAvailabilityModal.tsx">
import React from 'react';
import { useState, useImperativeHandle, forwardRef } from 'react';
import axios from 'axios';

import { AvailabilityActions } from './modules/AvailabilityActions';
import { AvailabilityHeader } from './modules/AvailabilityHeader';
import { SelectHourSection } from './modules/SelectHourSection';
import { useAppointmentsContext } from '../../../app/lib/utils/contexts/AppointmentsContext/AppoinmentsContext';

import useMessage from '@/hooks/useMessage';
import Message from '@/Components/ui/Message';

const API = process.env.NEXT_PUBLIC_BACKEND as string;

interface DayAvailabilityModalProps {
  fixerId?: string;
  onClose?: () => void;
  onConfirm?: () => void;
  availableDays: Record<string, number[]>;
}

export interface DayAvailabilityModalHandles {
  open: (daysToConfigure: string[]) => void;
  close: () => void;
}

export const DayAvailabilityModal = forwardRef<
  DayAvailabilityModalHandles,
  DayAvailabilityModalProps
>(({ fixerId = '68f55bf8f5c96a8e785049b9', onClose, onConfirm, availableDays }, ref) => {
  const [isOpen, setIsOpen] = useState(false);
  const [daysToConfigure, setDaysToConfigure] = useState<string[]>([]);
  const [selectedHours, setSelectedHours] = useState<number[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const { showMessage, messageState } = useMessage();

  const { refetchAll } = useAppointmentsContext();

  useImperativeHandle(ref, () => ({
    open: (days: string[]) => {
      setDaysToConfigure(days);
      setSelectedHours([]);
      setError(null);
      setIsOpen(true);
    },
    close: () => handleClose(),
  }));

  const toggleHour = (hours: number[]) => {
    setSelectedHours(hours);
  };

  const handleClose = () => {
    setIsOpen(false);
    setDaysToConfigure([]);
    setSelectedHours([]);
    setError(null);
    onClose?.();
  };

  const handleCancel = () => {
    handleClose();
  };

  const handleConfirm = async () => {
    if (selectedHours.length > 0 && daysToConfigure.length > 0) {
      try {
        setLoading(true);
        setError(null);

        const availabilityData: Record<string, number[]> = {
          lunes: availableDays.lunes || [],
          martes: availableDays.martes || [],
          miercoles: availableDays.miercoles || [],
          jueves: availableDays.jueves || [],
          viernes: availableDays.viernes || [],
          sabado: availableDays.sabado || [],
          domingo: availableDays.domingo || [],
        };

        daysToConfigure.forEach((day) => {
          availabilityData[day] = [...selectedHours];
        });

        const response = await axios.put(
          `${API}/api/crud_update/appointments/update_fixer_availability`,
          {
            fixer_id: fixerId,
            availability: availabilityData,
          },
        );

        if (response.data.updated) {
          showMessage({
            message: 'Horas guardadas correctamente',
            type: 'success',
            title: 'Éxito!',
            onCloseCallback: () => {
              handleClose();
              onConfirm?.();
            },
          });
        } else {
          setError('Error al actualizar la disponibilidad');
        }
      } catch (err) {
        console.error('Error guardando configuración:', err);
        setError('Error al guardar la configuración');
      } finally {
        refetchAll();
        setLoading(false);
      }
    } else {
      if (selectedHours.length === 0) {
        setError('Selecciona al menos una hora');
      }
    }
  };

  const isConfirmDisabled = selectedHours.length === 0 || daysToConfigure.length === 0 || loading;

  if (!isOpen) return null;

  return (
    <>
      <div className='fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50'>
        <div className='max-w-md w-full bg-white rounded-lg shadow-lg p-6'>
          <AvailabilityHeader headerText='Seleccionar Disponibilidad' onClose={handleClose} />

          <p className='text-black font-semibold mb-4'>
            Horas de trabajo para:{' '}
            {daysToConfigure.map((day) => day.charAt(0).toUpperCase() + day.slice(1)).join(', ')}
          </p>

          <SelectHourSection selectedHours={selectedHours} onHoursChange={toggleHour} />

          <p className='text-sm text-gray-700 mb-4'>
            *Las horas seleccionadas (azules) se aplicaran para todos los días laborales
            seleccionados de cada semana.
          </p>

          {error && <div className='text-red-600 text-sm mb-4 p-2 bg-red-50 rounded'>{error}</div>}

          <AvailabilityActions
            onCancel={handleCancel}
            confirmPlaceholder={loading ? 'Guardando...' : 'Guardar'}
            onConfirm={handleConfirm}
            confirmDisabled={isConfirmDisabled}
          />
        </div>
      </div>
      <Message {...messageState} />
    </>
  );
});

DayAvailabilityModal.displayName = 'DayAvailabilityModal';

export default DayAvailabilityModal;
</file>

<file path="src/Components/appointments/forms/DaySelectionModal.tsx">
'use client';

import { useState, useRef, useImperativeHandle, forwardRef } from 'react';
import axios from 'axios';

import { AvailabilityHeader } from './modules/AvailabilityHeader';
import { AvailabilityActions } from './modules/AvailabilityActions';
import { DaySelectSection } from './modules/DaySelectSection';
import { DayAvailabilityModal, DayAvailabilityModalHandles } from './DayAvailabilityModal';

const API = process.env.NEXT_PUBLIC_BACKEND as string;

interface AvailabilityResponse {
  message: string;
  availability: {
    lunes: number[];
    martes: number[];
    miercoles: number[];
    jueves: number[];
    viernes: number[];
    sabado: number[];
    domingo: number[];
  };
}

interface DaySelectionModalProps {
  fixerId?: string;
  onClose?: () => void;
}

export interface DaySelectionModalHandles {
  open: () => void;
  close: () => void;
}

export const DaySelectionModal = forwardRef<DaySelectionModalHandles, DaySelectionModalProps>(
  ({ fixerId = '68f55bf8f5c96a8e785049b9', onClose }, ref) => {
    const [isOpen, setIsOpen] = useState(false);
    const [availability, setAvailability] = useState<Record<string, number[]>>({});
    const [selectedDays, setSelectedDays] = useState<string[]>([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);

    const hourModalRef = useRef<DayAvailabilityModalHandles>(null);

    useImperativeHandle(ref, () => ({
      open: () => {
        setIsOpen(true);
        loadPreviousConfiguration();
      },
      close: () => handleClose(),
    }));

    const loadPreviousConfiguration = async () => {
      try {
        setLoading(true);
        setError(null);

        const response = await axios.get<AvailabilityResponse>(
          `${API}/api/crud_read/appointments/get_fixer_availability?fixer_id=${fixerId}`,
        );

        const availability = response.data.availability;

        setAvailability(availability);
      } catch (err) {
        setError('Error al cargar la configuracion previa');
        console.error('Error loading availability:', err);
      } finally {
        setLoading(false);
      }
    };

    const handleClose = () => {
      setIsOpen(false);
      setAvailability({});
      setSelectedDays([]);
      setError(null);
      onClose?.();
    };

    const handleConfirm = () => {
      if (selectedDays.length > 0) {
        // console.log("dias seleccionados para editar:", selectedDays);
        setIsOpen(false);
        hourModalRef.current?.open(selectedDays);
      }
    };

    const handleCancel = () => {
      handleClose();
    };

    const handleSelectedDaysChange = (days: string[]) => {
      // console.log("Desde handleSelectedDaysChange", days);
      setSelectedDays(days);
    };

    const handleHourModalClose = () => {
      setIsOpen(true);
    };

    const handleHourModalConfirm = () => {
      handleClose();
    };

    const isConfirmDisabled = selectedDays.length === 0;

    return (
      <>
        <div
          className={`fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 ${
            isOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'
          }`}
        >
          <div
            className="max-w-md w-full bg-white rounded-lg shadow-lg p-6 transform transition-transform duration-300 ${
            isOpen ? 'scale-100' : 'scale-95'
          }"
          >
            <AvailabilityHeader headerText='Seleccionar Disponibilidad' onClose={handleClose} />

            <p className='text-black font-semibold mb-4'>Días de trabajo de la semana</p>

            {loading ? (
              <div className='flex justify-center items-center py-8'>
                <div className='animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600'></div>
                <span className='ml-2'>Cargando configuración...</span>
              </div>
            ) : error ? (
              <div className='text-red-600 text-center py-4'>
                {error}
                <div className='flex gap-2 justify-center mt-3'>
                  <button
                    onClick={loadPreviousConfiguration}
                    className='px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm'
                  >
                    Reintentar
                  </button>
                  <button
                    onClick={handleClose}
                    className='px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 text-sm'
                  >
                    Cerrar
                  </button>
                </div>
              </div>
            ) : (
              <>
                <DaySelectSection
                  availableDays={availability}
                  onDaysChange={handleSelectedDaysChange}
                />

                <p className='text-sm text-gray-700 mb-4'>
                  *Se editará la disponibilidad los días seleccionados (azules)
                </p>

                <AvailabilityActions
                  onCancel={handleCancel}
                  confirmPlaceholder='Editar'
                  onConfirm={handleConfirm}
                  confirmDisabled={isConfirmDisabled}
                />
              </>
            )}
          </div>
        </div>

        <DayAvailabilityModal
          ref={hourModalRef}
          fixerId={fixerId}
          onClose={handleHourModalClose}
          onConfirm={handleHourModalConfirm}
          availableDays={availability}
        />
      </>
    );
  },
);

DaySelectionModal.displayName = 'DaySelectionModal';

export default DaySelectionModal;
</file>

<file path="src/Components/appointments/forms/EditAppointmentForm.tsx">
import React, {
  useState,
  forwardRef,
  useImperativeHandle,
  useRef,
  useEffect,
  useMemo,
} from 'react';
import LocationModal from './LocationModal';
import { z } from 'zod';

import { EditAppointmentHeader } from './modules/EditAppointmentHeader';
import { DateTimeSection } from './modules/DateTimeSection';
import { ClientSection } from './modules/ClientSection';
import { DescriptionSection } from './modules/DescriptionSection';
import { LocationSection } from './modules/LocationSection';
import { MeetingLinkSection } from './modules/MeetingLinkSection';
import { EditAppointmentActions } from './modules/EditAppointmentActions';

import { JustificationPopup } from '../forms/popups/JustificationPopup';
import RescheduleForm, { RescheduleFormHandle } from './RescheduleForm';

// --- Schemas ---

const baseSchema = z.object({
  client: z
    .string()
    .regex(/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/, 'Ingrese un nombre de cliente válido')
    .nonempty('Ingrese un nombre de cliente')
    .max(50),
  contact: z
    .string()
    .regex(/[67]\d{7}$/, 'Ingrese un número de teléfono válido')
    .nonempty('Ingrese un número de teléfono'),
  description: z.string().nonempty('Ingrese una descripción de trabajo').max(300),
});

const virtualSchema = baseSchema.extend({
  modality: z.literal('virtual'),
  meetingLink: z
    .string()
    .regex(
      /^(https?:\/\/)?(meet\.google\.com|zoom\.us)\/[^\s]+$/,
      'Ingrese un enlace válido de Meet o Zoom',
    )
    .nonempty('Ingrese un enlace de Meet o Zoom'),
  location: z.undefined().optional(),
});

const presentialSchema = baseSchema.extend({
  modality: z.literal('presential'),
  meetingLink: z.undefined().optional(),
  location: z
    .object({
      lat: z.number(),
      lon: z.number(),
      address: z.string().nonempty('Seleccione una ubicación'),
    })
    .nullable()
    .refine((val) => val !== null, { message: 'Seleccione una ubicación' }),
});

const appointmentSchema = z.discriminatedUnion('modality', [virtualSchema, presentialSchema]);

// --- Types ---

export type AppointmentPayload = {
  datetime: string;
  client: string;
  contact: string;
  modality: 'virtual' | 'presencial';
  description?: string;
  meetingLink?: string;
  place?: string;
  lat?: number;
  lon?: number;
  address?: string;
};

export type ExistingAppointment = AppointmentPayload & {
  id: string;
  fixerId: string;
  requesterId: string;
};

export type EditAppointmentFormHandle = {
  open: (appointmentData: ExistingAppointment) => void;
  close: () => void;
};

// --- Helpers ---

function genMeetingLink(datetimeISO: string) {
  const id = Math.random().toString(36).slice(2, 9);
  return `https://meet.example.com/${id}?t=${encodeURIComponent(datetimeISO)}`;
}

// --- Component ---

const EditAppointmentForm = forwardRef<EditAppointmentFormHandle>((_props, ref) => {
  const [open, setOpen] = useState(false);
  const [appointmentId, setAppointmentId] = useState<string>('');
  const [datetime, setDatetime] = useState<string>('');
  const [client, setClient] = useState<string>('');
  const [contact, setContact] = useState<string>('');
  const [modality, setModality] = useState<'virtual' | 'presencial'>('virtual');
  const [description, setDescription] = useState<string>('');
  const [lat, setLat] = useState<number | undefined>(undefined);
  const [lon, setLon] = useState<number | undefined>(undefined);
  const [address, setAddress] = useState<string>('');
  const [meetingLink, setMeetingLink] = useState<string>('');
  const [loading, setLoading] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);
  const [showLocationModal, setShowLocationModal] = useState(false);
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [originalAppointment, setOriginalAppointment] = useState<ExistingAppointment | null>(null);

  const [day, setDay] = useState<string>('');
  const [month, setMonth] = useState<string>('');
  const [hour, setHour] = useState<number>(0);

  const dialogRef = useRef<HTMLDivElement | null>(null);
  const firstFieldRef = useRef<HTMLInputElement | null>(null);

  // Justificación + Reprogramación
  const [justifyOpen, setJustifyOpen] = useState(false);
  const [reprogReason, setReprogReason] = useState('');
  const rescheduleRef = useRef<RescheduleFormHandle>(null);

  // Cálculo de cambios detectados (Derived State para evitar useEffect y deps issues)
  const changesDetected = useMemo(() => {
    if (!originalAppointment) return false;

    const originalDate = new Date(originalAppointment.datetime);
    const originalDay = originalDate.getDate().toString().padStart(2, '0');
    const originalMonth = (originalDate.getMonth() + 1).toString().padStart(2, '0');
    const originalHour = originalDate.getHours();

    const hasDateTimeChanges =
      day !== originalDay || month !== originalMonth || hour !== originalHour;
    const hasClientChanges = client.trim() !== originalAppointment.client;
    const hasContactChanges = contact.trim() !== originalAppointment.contact;
    const hasDescriptionChanges =
      (description || '').trim() !== (originalAppointment.description || '').trim();
    const hasModalityChanges = modality !== originalAppointment.modality;

    let hasLocationOrLinkChanges = false;
    if (modality === 'presencial') {
      hasLocationOrLinkChanges =
        (lat ?? 0) !== (originalAppointment.lat ?? 0) ||
        (lon ?? 0) !== (originalAppointment.lon ?? 0) ||
        (address || '') !== (originalAppointment.address || '');
    } else {
      hasLocationOrLinkChanges =
        (meetingLink || '').trim() !== (originalAppointment.meetingLink || '').trim();
    }

    return (
      hasDateTimeChanges ||
      hasClientChanges ||
      hasContactChanges ||
      hasDescriptionChanges ||
      hasModalityChanges ||
      hasLocationOrLinkChanges
    );
  }, [
    originalAppointment,
    day,
    month,
    hour,
    client,
    contact,
    description,
    modality,
    lat,
    lon,
    address,
    meetingLink,
  ]);

  const handleClose = () => {
    setOpen(false);
    setAppointmentId('');
    setClient('');
    setContact('');
    setModality('virtual');
    setDescription('');
    setLat(undefined);
    setLon(undefined);
    setAddress('');
    setMeetingLink('');
    setDay('');
    setMonth('');
    setHour(0);
    setMsg(null);
    setErrors({});
    setJustifyOpen(false);
    setReprogReason('');
  };

  useImperativeHandle(
    ref,
    () => ({
      open: (appointmentData: ExistingAppointment) => {
        const normalized: 'virtual' | 'presencial' =
          appointmentData.modality === 'virtual' ? 'virtual' : 'presencial';

        setAppointmentId(appointmentData.id);
        setDatetime(appointmentData.datetime);
        setClient(appointmentData.client);
        setContact(appointmentData.contact || '');
        setModality(normalized);
        setDescription(appointmentData.description || '');

        const latNum = appointmentData.lat ?? undefined;
        setLat(Number.isFinite(latNum) ? latNum : undefined);
        const lonNum = appointmentData.lon ?? undefined;
        setLon(Number.isFinite(lonNum) ? lonNum : undefined);

        setAddress(appointmentData.address || '');
        setMeetingLink(appointmentData.meetingLink || '');
        setOriginalAppointment(appointmentData);

        const dateObj = new Date(appointmentData.datetime);
        setDay(dateObj.getDate().toString().padStart(2, '0'));
        setMonth((dateObj.getMonth() + 1).toString().padStart(2, '0'));
        setHour(dateObj.getHours());

        setOpen(true);
        setTimeout(() => firstFieldRef.current?.focus(), 40);
      },
      close: () => handleClose(),
    }),
    [],
  );

  useEffect(() => {
    function onKey(e: KeyboardEvent) {
      if (e.key === 'Escape' && open) handleClose();
    }
    document.addEventListener('keydown', onKey);
    return () => document.removeEventListener('keydown', onKey);
  }, [open]);

  const handleLocationConfirm = (locationData: { lat: number; lon: number; address: string }) => {
    setLat(locationData.lat);
    setLon(locationData.lon);
    setAddress(locationData.address);
    setShowLocationModal(false);
  };

  // Guardar cambios normales del formulario
  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setMsg(null);
    setErrors({});

    if (!day || !month || day.length !== 2 || month.length !== 2) {
      setMsg('Ingrese día y mes válidos (DD/MM)');
      return;
    }
    const dayNum = parseInt(day, 10);
    const monthNum = parseInt(month, 10);
    if (dayNum < 1 || dayNum > 31 || monthNum < 1 || monthNum > 12) {
      setMsg('Ingrese una fecha válida (DD: 1-31, MM: 1-12)');
      return;
    }

    const originalDate = new Date(originalAppointment?.datetime || datetime);
    const currentYear = originalDate.getFullYear();
    const newDatetime = new Date(currentYear, monthNum - 1, dayNum, hour, 0);
    if (newDatetime <= new Date()) {
      setMsg('La cita debe ser en una fecha y hora futura');
      return;
    }

    // Usamos Record<string, unknown> en lugar de any
    const formData: Record<string, unknown> = {
      client: client.trim(),
      contact: contact.trim(),
      description: description.trim(),
      modality: modality === 'presencial' ? 'presential' : 'virtual',
    };

    if (modality === 'presencial') {
      formData.location =
        lat !== undefined &&
        lon !== undefined &&
        Number.isFinite(lat) &&
        Number.isFinite(lon) &&
        address
          ? { lat, lon, address: address.trim() }
          : null;
    } else {
      formData.meetingLink = meetingLink.trim() || genMeetingLink(datetime);
    }

    const validation = appointmentSchema.safeParse(formData);
    if (!validation.success) {
      const fieldErrors: Record<string, string> = {};
      validation.error.issues.forEach((err) => {
        const key =
          Array.isArray(err.path) && err.path.length ? (err.path[0] as string) : 'general';
        fieldErrors[key] = err.message;
      });
      setErrors(fieldErrors);
      return;
    }

    // Payload tipado
    const payload: Record<string, string | number> = {};
    if (!originalAppointment) {
      setMsg('Error: datos originales no disponibles');
      return;
    }

    if (client.trim() !== originalAppointment.client) {
      payload.current_requester_name = client.trim();
    }
    if (contact.trim() !== originalAppointment.contact) {
      payload.current_requester_phone = contact.trim();
    }
    if ((description || '') !== (originalAppointment.description || '')) {
      payload.appointment_description = description.trim();
    }
    if (modality !== originalAppointment.modality) {
      payload.appointment_type = modality === 'presencial' ? 'presential' : 'virtual';
    }

    if (modality === 'presencial') {
      if (!address) {
        setMsg('Selecciona una ubicación.');
        return;
      }
      if (lat !== undefined && lat !== (originalAppointment.lat ?? undefined)) {
        payload.lat = String(lat);
      }
      if (lon !== undefined && lon !== (originalAppointment.lon ?? undefined)) {
        payload.lon = String(lon);
      }
      if (address !== (originalAppointment.address ?? '')) {
        payload.display_name_location = address;
      }
    } else {
      const linkToUse = meetingLink.trim() || genMeetingLink(datetime);
      if (meetingLink.trim()) {
        const urlRegex = /^(https?:\/\/)?([\w\-]+\.)+[\w\-]+(\/[\w\-./?%&=]*)?$/i;
        if (!urlRegex.test(meetingLink.trim())) {
          setMsg('Ingrese un enlace válido.');
          return;
        }
      }
      if ((meetingLink || '') !== (originalAppointment.meetingLink || '')) {
        payload.link_id = linkToUse;
      }
    }

    if (Object.keys(payload).length === 0) {
      setMsg('No hay cambios para guardar.');
      return;
    }

    try {
      setLoading(true);
      const API = process.env.NEXT_PUBLIC_BACKEND as string;
      const res = await fetch(
        `${API}/api/crud_update/appointments/update_by_id?id=${appointmentId}`,
        {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        },
      );

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        setMsg(
          (data as { error?: string; message?: string })?.error ||
            (data as { error?: string; message?: string })?.message ||
            'Error al actualizar',
        );
        setLoading(false);
        return;
      }

      setMsg('¡Cita actualizada!');
      setTimeout(() => {
        setLoading(false);
        handleClose();
      }, 700);
    } catch (err) {
      console.error(err);
      setMsg('Error en la conexión.');
      setLoading(false);
    }
  }

  // Flujo de cancelación/reprogramación
  const handleAskJustification = () => {
    if (!justifyOpen) setJustifyOpen(true);
  };

  const handleSubmitJustification = (reason: string) => {
    setReprogReason(reason);
    setJustifyOpen(false);
    // Abre el formulario de reprogramación (prefill desde backend con pastDate)
    rescheduleRef.current?.open();
  };

  if (!open) return null;

  return (
    <>
      <div className='fixed inset-0 z-50 flex items-center justify-center px-4'>
        <div className='absolute inset-0 bg-black/50' onClick={handleClose} aria-hidden='true' />
        <div
          ref={dialogRef}
          role='dialog'
          aria-modal='true'
          aria-labelledby='edit-appointment-title'
          className='relative bg-white rounded-lg shadow-xl w-full max-w-xl mx-auto overflow-auto'
          style={{ maxHeight: '90vh' }}
        >
          <div className='p-4 sm:p-6'>
            <EditAppointmentHeader onClose={handleClose} />

            <form onSubmit={handleSubmit} className='mt-4 space-y-4 text-black'>
              <DateTimeSection
                datetime={datetime}
                modality={modality}
                onModalityChange={setModality}
              />

              <ClientSection
                client={client}
                contact={contact}
                errors={errors}
                ref={firstFieldRef}
                onClientChange={setClient}
                onContactChange={setContact}
                readonly={false}
              />

              <DescriptionSection
                description={description}
                error={errors.description}
                onChange={setDescription}
              />

              {modality === 'presencial' ? (
                <LocationSection
                  address={address}
                  error={errors.location}
                  onOpenLocationModal={() => setShowLocationModal(true)}
                  formtype='edit'
                />
              ) : (
                <MeetingLinkSection
                  meetingLink={meetingLink}
                  error={errors.meetingLink}
                  onChange={setMeetingLink}
                />
              )}

              <LocationModal
                open={showLocationModal}
                onClose={() => setShowLocationModal(false)}
                onConfirm={handleLocationConfirm}
                initialCoords={
                  Number.isFinite(lat) &&
                  Number.isFinite(lon) &&
                  lat !== undefined &&
                  lon !== undefined
                    ? { lat: lat as number, lon: lon as number, address }
                    : undefined
                }
              />

              {msg && <p className='text-sm text-red-600'>{msg}</p>}

              <EditAppointmentActions
                loading={loading}
                changesDetected={changesDetected}
                onCancel={handleClose}
                appointmentStart={
                  originalAppointment ? new Date(originalAppointment.datetime) : undefined
                }
                submitDisabled={modality === 'presencial' && !address}
                onRequestReprogram={handleAskJustification}
              />
            </form>
          </div>
        </div>
      </div>

      {/* ÚNICO modal de justificación */}
      <JustificationPopup
        open={justifyOpen}
        onClose={() => setJustifyOpen(false)}
        onSubmit={handleSubmitJustification}
        title='Justificación'
      />

      {/* Reprogramación: pre-llenado desde backend usando pastDate */}
      <RescheduleForm
        ref={rescheduleRef}
        fixerId={originalAppointment?.fixerId ?? ''}
        requesterId={originalAppointment?.requesterId ?? ''}
        pastDate={originalAppointment?.datetime ?? ''}
        motivo={reprogReason}
      />
    </>
  );
});

EditAppointmentForm.displayName = 'EditAppointmentForm';

export default EditAppointmentForm;
</file>

<file path="src/Components/appointments/forms/EditAppointmentLocation.tsx">
'use client';
import { useEffect, useMemo, useState } from 'react';
//BASE DE DATOS (DE MOMENTO POSTMAN)
const API = process.env.NEXT_PUBLIC_API_BASE_URL as string;
type CitaResponse = {
  Cita: {
    id_Cita: string;
    id_Fixer: string;
    id_Requester: string;
    fecha_Cita: string;
    estado_Fecha_Seleccionada: string;
    id_Horario: string;
  };
  DetalleCita: {
    id_Cita: string;
    estado_Cita: 'Activo' | 'Cancelado';
    modalidad_Cita: 'Presencial' | 'Virtual';
    descripcion_Cita: string;
    id_Ubicacion: string;
  };
  Requester: {
    id_Requester: string;
    nombre_Requester: string;
    numero_Requester: string;
  };
  Fixer: {
    idFixer: string;
    nombre_Fixer: string;
  };
  Horario: {
    id_Horario: string;
    Hora_Inicio: string;
    Hora_Fin: string;
    estado_Horario: 'libre' | 'ocupado' | 'no_disponible';
  };
  Ubicacion: {
    id_Ubicacion: string;
    latitud_Ubicacion: number;
    longitud_Ubicacion: number;
    nombre_Ubicacion: string;
    direccion: string;
    provider?: string;
    place_id?: string;
    osm_type?: string;
    osm_id?: string;
    display_name?: string;
    icon?: string;
  };
  Requester_Ubicacion: {
    id_Ubicacion: string;
    id_Requester: string;
  };
};

function formatFechaHora(iso: string) {
  const d = new Date(iso);
  const fmtFecha = d.toLocaleDateString('es-ES', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
  });
  const fmtHora = d.toLocaleTimeString('es-ES', {
    hour: 'numeric',
    minute: '2-digit',
  });
  return { fmtFecha, fmtHora };
}

export default function EditBookingModal({
  bookingId,
  onClose,
  onSaved,
}: {
  bookingId: string;
  onClose: () => void;
  onSaved?: () => void;
}) {
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [err, setErr] = useState('');
  const [data, setData] = useState<CitaResponse | null>(null);
  const [descEditable, setDescEditable] = useState(false);
  const [desc, setDesc] = useState('');

  useEffect(() => {
    (async () => {
      try {
        setLoading(true);
        setErr('');
        const res = await fetch(`${API}/citas/${bookingId}`);
        const txt = await res.text();
        if (!res.ok) throw new Error(`No se pudo cargar la cita (HTTP ${res.status})`);
        const json: CitaResponse = JSON.parse(txt);
        setData(json);
        setDesc(json.DetalleCita?.descripcion_Cita ?? '');
      } catch (e) {
        if (e instanceof Error) setErr(e.message);
        else setErr('Error desconocido');
      } finally {
        setLoading(false);
      }
    })();
  }, [bookingId]);

  const titulo = useMemo(() => data?.Requester?.nombre_Requester ?? '—', [data]);
  const { fmtFecha, fmtHora } = useMemo(() => {
    if (!data) return { fmtFecha: '—', fmtHora: '—' };
    return formatFechaHora(data.Cita.fecha_Cita);
  }, [data]);

  async function handleSave() {
    if (!data) return;
    try {
      setSaving(true);
      setErr('');
      if (descEditable && desc !== data.DetalleCita.descripcion_Cita) {
        const r2 = await fetch(`${API}/citas/${data.Cita.id_Cita}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            DetalleCita: {
              descripcion_Cita: desc,
              modalidad_Cita: data.DetalleCita.modalidad_Cita,
            },
          }),
        });
        if (!r2.ok) throw new Error('No se pudo guardar la descripción');
      }

      onSaved?.();
      onClose();
    } catch (e) {
      if (e instanceof Error) setErr(e.message);
      else setErr('Error al guardar');
    } finally {
      setSaving(false);
    }
  }

  const handleEditUbicacion = () => {};

  return (
    <div className='fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4'>
      <div className='w-full max-w-lg rounded-3xl bg-white p-6 shadow-2xl'>
        <div className='mb-4 flex items-start justify-between'>
          <h2 className='text-3xl font-semibold'>{titulo}</h2>
          <button
            onClick={onClose}
            className='rounded-full p-1.5 text-slate-500 hover:bg-slate-100'
            aria-label='Cerrar'
          >
            ✕
          </button>
        </div>

        <div className='mb-5 space-y-2 text-[15px]'>
          <div className='flex items-center gap-2 text-slate-700'>
            <span className='text-xl'>📅</span>
            <span>
              <span className='font-medium'>Fecha:</span> {fmtFecha}
            </span>
          </div>
          <div className='flex items-center gap-2 text-slate-700'>
            <span className='text-xl'>🕗</span>
            <span>
              <span className='font-medium'>Hora de reunión:</span> {fmtHora}
            </span>
          </div>
        </div>

        {loading && <div className='text-slate-500'>Cargando…</div>}
        {err && <div className='mb-3 text-sm text-rose-600'>{err}</div>}

        {!loading && data && (
          <>
            <div className='mb-4'>
              <label className='mb-1 block text-[15px] font-semibold text-slate-800'>
                Ubicación:
                <button
                  type='button'
                  onClick={handleEditUbicacion}
                  className='ml-2 rounded-md p-1 text-slate-500 hover:bg-slate-100'
                  title='Editar ubicación (no disponible)'
                >
                  ✎
                </button>
              </label>

              <input
                value={data.Ubicacion?.direccion ?? ''}
                readOnly
                className='w-full rounded-xl border bg-slate-100 p-2.5 text-[15px] text-slate-700'
              />
              <p className='mt-1 text-xs text-slate-500'>
                La edición de ubicación no está disponible temporalmente.
              </p>
            </div>

            <div className='mb-6'>
              <label className='mb-1 flex items-center gap-2 text-[15px] font-semibold text-slate-800'>
                <span>Descripción del trabajo</span>
                <button
                  type='button'
                  onClick={() => setDescEditable((v) => !v)}
                  className={`rounded-md p-1 ${
                    descEditable
                      ? 'bg-amber-100 text-amber-700'
                      : 'text-slate-800 hover:bg-slate-100'
                  }`}
                  title={descEditable ? 'Salir de edición' : 'Editar'}
                >
                  ✎
                </button>
                {descEditable && (
                  <span className='rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700'>
                    Editando
                  </span>
                )}
              </label>

              <textarea
                value={desc}
                onChange={(e) => setDesc(e.target.value)}
                readOnly={!descEditable}
                rows={3}
                placeholder='Describe el trabajo…'
                className={`w-full resize-none rounded-xl border p-2.5 text-[15px] transition ${
                  descEditable
                    ? 'bg-white ring-2 ring-sky-400 border-sky-300 text-gray-900'
                    : 'bg-slate-100 text-slate-600'
                }`}
              />
              {descEditable && (
                <div className='mt-1 text-xs text-slate-500'>
                  Estás editando. Pulsa <b>Aceptar</b> para guardar los cambios.
                </div>
              )}
            </div>

            <div className='flex justify-end gap-3'>
              <button
                type='button'
                onClick={onClose}
                className='rounded-2xl bg-slate-200 px-5 py-2.5 text-[15px] font-medium text-slate-700 hover:bg-slate-300'
              >
                Cancelar
              </button>
              <button
                type='button'
                onClick={handleSave}
                disabled={saving}
                className='rounded-2xl bg-sky-600 px-5 py-2.5 text-[15px] font-medium text-white hover:bg-sky-700 disabled:opacity-60'
              >
                {saving ? 'Guardando…' : 'Aceptar'}
              </button>
            </div>
          </>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/Components/appointments/forms/LocationModal.tsx">
'use client';

import { useState, useEffect } from 'react';
import dynamic from 'next/dynamic';
export type FormType = 'create' | 'edit' | 'view';
const MapView = dynamic(() => import('@/Components/maps/location/MapView'), {
  ssr: false,
  loading: () => (
    <div
      style={{ height: 400, width: '100%' }}
      className='flex items-center justify-center bg-gray-100'
    >
      <p>Cargando mapa...</p>
    </div>
  ),
});

interface LocationModalProps {
  open: boolean;
  onClose: () => void;
  onConfirm: (location: { lat: number; lon: number; address: string }) => void;
  initialCoords?: { lat: number; lon: number; address?: string } | null;
  formtype?: 'create' | 'edit' | 'view';
}

export default function LocationModal({
  open,
  onClose,
  onConfirm,
  initialCoords,
  formtype,
}: LocationModalProps) {
  const [coords, setCoords] = useState<{ lat: number; lon: number } | null>(null);
  const [address, setAddress] = useState<string>('');

  // Cuando el modal se abre, inicializa con initialCoords si existen
  useEffect(() => {
    if (open && initialCoords) {
      setCoords({ lat: initialCoords.lat, lon: initialCoords.lon });
      setAddress(initialCoords.address || '');
    }
  }, [open, initialCoords]);

  async function fetchAddress(lat: number, lon: number) {
    try {
      const res = await fetch(
        `${process.env.NEXT_PUBLIC_BACKEND}/api/location/reverse?lat=${lat}&lon=${lon}`,
      );
      const data = await res.json();
      setAddress(data.display_name || 'Dirección no disponible');
    } catch {
      setAddress('No se pudo obtener la dirección');
    }
  }

  function handleSelect(lat: number, lon: number) {
    setCoords({ lat, lon });
    fetchAddress(lat, lon);
  }

  if (!open) return null;

  return (
    <div className='fixed inset-0 z-50 flex items-center justify-center px-4'>
      <div className='absolute inset-0 bg-black/50' onClick={onClose} />
      <div className='relative bg-white rounded-lg shadow-xl w-full max-w-2xl mx-auto overflow-hidden'>
        <div className='p-4'>
          <h3 className='text-lg font-semibold mb-2'>Seleccionar ubicación</h3>
          <MapView onSelect={handleSelect} markerPosition={coords} />

          {coords && (
            <p className='text-sm mt-3 text-gray-700'>
              <b>Dirección:</b> {address || 'Cargando...'}
            </p>
          )}
          <div className='flex justify-end gap-2 mt-4'>
            <button onClick={onClose} className='px-4 py-2 rounded bg-gray-300 text-black text-sm'>
              Cancelar
            </button>
            {formtype !== 'view' ? (
              <button
                onClick={() => coords && onConfirm({ ...coords, address })}
                disabled={!coords}
                className='px-4 py-2 rounded bg-blue-600 text-white text-sm disabled:opacity-60'
              >
                Confirmar ubicación
              </button>
            ) : null}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/appointments/forms/ModeSelectionModal.tsx">
import { forwardRef, useImperativeHandle, useState, useRef } from 'react';
import { AvailabilityHeader } from './modules/AvailabilityHeader';
import { ModeSelectionActions } from './modules/ModeSelectionActions';
import { WeekAvailabilityModal, WeekAvailabilityModalHandles } from './WeekAvailabilityModal';
import { DaySelectionModal, DaySelectionModalHandles } from './DaySelectionModal';
import { useUserRole } from '@/app/lib/utils/contexts/UserRoleContext';

export interface ModeSelectionModalHandles {
  open: () => void;
  close: () => void;
}

interface ModeSelectionModalProps {
  fixerId?: string;
}

export const ModeSelectionModal = forwardRef<ModeSelectionModalHandles, ModeSelectionModalProps>(
  ({ fixerId }, ref) => {
    const { role, fixer_id: contextFixerId } = useUserRole();
    const [isOpen, setIsOpen] = useState(false);
    const weekModalRef = useRef<WeekAvailabilityModalHandles>(null);
    const dayModalRef = useRef<DaySelectionModalHandles>(null);

    // Usar el fixerId del contexto si no se proporciona como prop
    const actualFixerId = fixerId || contextFixerId || '68f55bf8f5c96a8e785049b9';

    useImperativeHandle(
      ref,
      () => ({
        open: () => {
          // Solo permitir abrir si el usuario es fixer
          if (role === 'fixer') {
            setIsOpen(true);
          }
        },
        close: () => handleClose(),
      }),
      [role],
    );

    const handleClose = () => {
      setIsOpen(false);
    };

    const handleOpenWeek = () => {
      setIsOpen(false);
      weekModalRef.current?.open();
    };

    const handleOpenDaySelection = () => {
      setIsOpen(false);
      dayModalRef.current?.open();
    };

    // Si el usuario no es fixer, no renderizar nada
    if (role !== 'fixer') return null;

    return (
      <>
        <div
          className={`fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 ${
            isOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'
          }`}
        >
          <div
            className={`max-w-md w-full bg-white rounded-lg shadow-lg p-6 ${
              isOpen ? 'scale-100' : 'scale-95'
            }`}
          >
            <AvailabilityHeader headerText='Seleccionar Disponibilidad' onClose={handleClose} />

            <p className='text-black font-semibold mb-4'>Selecciona el modo de configuración</p>

            <ModeSelectionActions
              openWeek={handleOpenWeek}
              openDaySelection={handleOpenDaySelection}
              fixerId={actualFixerId}
            />
          </div>
        </div>

        <WeekAvailabilityModal ref={weekModalRef} fixerId={actualFixerId} />
        <DaySelectionModal ref={dayModalRef} fixerId={actualFixerId} />
      </>
    );
  },
);

ModeSelectionModal.displayName = 'ModeSelectionModal';

export default ModeSelectionModal;
</file>

<file path="src/Components/appointments/forms/modules/AvailabilityActions.tsx">
import { Button } from '@/Components/atoms/button';

interface AvailabilityActionsProps {
  onCancel: () => void;
  confirmPlaceholder: string;
  onConfirm: () => void;
  confirmDisabled?: boolean; // Agregar esta prop
}

export const AvailabilityActions = ({
  confirmPlaceholder = '',
  onCancel,
  onConfirm,
  confirmDisabled = false,
}: AvailabilityActionsProps) => {
  return (
    <div className='flex items-center justify-end gap-2 pt-2'>
      <Button variant='secondary' onClick={onCancel}>
        Cancelar
      </Button>
      <Button variant='primary' onClick={onConfirm} disabled={confirmDisabled}>
        {confirmPlaceholder}
      </Button>
    </div>
  );
};
</file>

<file path="src/Components/appointments/forms/modules/AvailabilityButton.tsx">
import React from 'react';

interface DayButtonProps {
  label: string;
  selected: boolean;
  disabled?: boolean;
  isDay?: boolean;
  onToggle: () => void;
}

export const AvailabilityButton: React.FC<DayButtonProps> = ({
  label,
  selected,
  disabled = false,
  isDay = true,
  onToggle,
}) => {
  const getButtonStyles = () => {
    if (disabled) {
      return 'bg-[#64748B] text-white border-[#64748B] cursor-not-allowed';
    }
    if (selected) {
      return 'bg-[#2B6AE0] text-white border-[#2B6AE0] hover:bg-[#1E5BC7]';
    }
    return 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
  };

  const getCheckboxStyles = () => {
    if (disabled) {
      return 'border-white bg-white opacity-30';
    }
    if (selected) {
      return 'border-white bg-white';
    }
    return 'border-gray-400 bg-white';
  };

  const completeHourLabel = (hour: string) => {
    const startHour = parseInt(hour);
    const endHour = startHour + 1;

    const formatHour = (h: number) => {
      return h.toString().padStart(2, '0');
    };

    return `${formatHour(startHour)}:00 - ${formatHour(endHour)}:00`;
  };

  return (
    <button
      type='button'
      onClick={disabled ? undefined : onToggle}
      disabled={disabled}
      className={`
      relative flex items-center justify-between 
      w-full px-4 py-2 rounded-lg border-2  {/* py-3 → py-2 */}
      transition-all duration-200 
      font-medium text-sm
      ${getButtonStyles()}
      ${!disabled ? 'cursor-pointer' : ''}
    `}
    >
      {isDay ? (
        <span className={`font-medium ${disabled ? 'text-white opacity-90' : ''}`}>
          {label.charAt(0).toUpperCase() + label.slice(1)}
        </span>
      ) : (
        <span className={`font-medium `}>{completeHourLabel(label)}</span>
      )}

      <div
        className={`
      w-4 h-4 border-2 rounded-sm flex items-center justify-center {/* w-5/h-5 → w-4/h-4 */}
      transition-all duration-200
      ${getCheckboxStyles()}
    `}
      >
        {selected && !disabled && (
          <svg
            width='10'
            height='10'
            viewBox='0 0 24 24'
            fill='none'
            stroke='#2B6AE0'
            strokeWidth='3'
          >
            <path d='M20 6L9 17l-5-5' strokeLinecap='round' strokeLinejoin='round' />
          </svg>
        )}
      </div>
    </button>
  );
};
</file>

<file path="src/Components/appointments/forms/modules/AvailabilityHeader.tsx">
interface HeaderProps {
  onClose: () => void;
  headerText: string;
}

export const AvailabilityHeader = ({ headerText, onClose }: HeaderProps) => {
  return (
    <div className='flex items-start justify-between'>
      <div className='flex items-center gap-3'>
        <svg
          xmlns='http://www.w3.org/2000/svg'
          width='20'
          height='20'
          viewBox='0 0 24 24'
          fill='none'
          stroke='currentColor'
          strokeWidth='2'
          strokeLinecap='round'
          strokeLinejoin='round'
          className='text-gray-600'
        >
          <path d='M8 2v4' />
          <path d='M16 2v4' />
          <rect width='18' height='18' x='3' y='4' rx='2' />
          <path d='M3 10h18' />
        </svg>

        <h3 id='edit-appointment-title' className='text-lg font-semibold text-black'>
          {headerText}
        </h3>
      </div>
      <button aria-label='Cerrar' className='text-gray-500 hover:text-gray-700' onClick={onClose}>
        ✕
      </button>
    </div>
  );
};
</file>

<file path="src/Components/appointments/forms/modules/CircularDayButton.tsx">
interface CircularDayButtonProps {
  day: string;
  selected: boolean;
  onToggle: (day: string) => void;
  className?: string;
}

export const CircularDayButton = ({
  day,
  selected,
  onToggle,
  className = '',
}: CircularDayButtonProps) => {
  return (
    <button
      type='button'
      onClick={() => onToggle(day)}
      className={`
        w-12 h-12 rounded-full border-2 flex items-center justify-center
        text-sm font-light transition-colors
        ${
          selected
            ? 'bg-[#2B6AE0] border-[#2B6AE0] text-white'
            : 'bg-white border-[#D9D9D9] text-gray-700 hover:border-gray-400'
        }
        ${className}
      `}
    >
      {day}
    </button>
  );
};
</file>

<file path="src/Components/appointments/forms/modules/ClientSection.tsx">
import { Input } from '@/Components/atoms/inputs';
import React from 'react';

interface ClientSectionProps {
  client: string;
  contact: string;
  errors: Record<string, string>;
  onClientChange: (value: string) => void;
  onContactChange: (value: string) => void;
  readonly?: boolean;
}

export const ClientSection = React.forwardRef<HTMLInputElement, ClientSectionProps>(
  ({ client, contact, errors, onClientChange, onContactChange, readonly }, ref) => {
    const handleContactChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      const value = e.target.value;

      const numbersOnly = value.replace(/[^\d]/g, '').slice(0, 8);
      onContactChange(numbersOnly);
    };

    return (
      <div className='grid grid-cols-1 sm:grid-cols-2 gap-3'>
        <Input
          ref={ref}
          label='Cliente *'
          value={client}
          readOnly={readonly}
          onChange={(e) => onClientChange(e.target.value)}
          placeholder='Nombre del cliente'
          error={errors.client}
        />

        <Input
          label='Contacto *'
          value={contact}
          readOnly={readonly}
          onChange={handleContactChange}
          placeholder='7XXXXXXX'
          error={errors.contact}
        />
      </div>
    );
  },
);

ClientSection.displayName = 'ClientSection';
</file>

<file path="src/Components/appointments/forms/modules/DateTimeDisplaySection.tsx">
import { DisplayField } from '@/Components/atoms/displayfield';

interface DateTimeSectionProps {
  datetime: string;
  modality: 'virtual' | 'presencial';
  onModalityChange: (value: 'virtual' | 'presencial') => void;
}

export const DateTimeDisplaySection = ({ datetime, modality }: DateTimeSectionProps) => {
  return (
    <div className='flex gap-4 p-3 rounded items-start'>
      <label className='block'>
        <span className='text-sm font-medium'>Fecha y hora</span>
        <input
          readOnly
          value={new Date(datetime).toLocaleString()}
          className='mt-1 block w-full bg-gray-100 border border-gray-200 rounded px-3 py-2 text-sm'
        />
      </label>
      <div className='flex-1'>
        <label className='block'>
          <DisplayField label='Modalidad' value={modality.toString()} />
        </label>
      </div>
    </div>
  );
};
</file>

<file path="src/Components/appointments/forms/modules/DateTimeSection.tsx">
interface DateTimeSectionProps {
  datetime: string;
  modality: 'virtual' | 'presencial';
  onModalityChange: (value: 'virtual' | 'presencial') => void;
}

export const DateTimeSection = ({ datetime, modality, onModalityChange }: DateTimeSectionProps) => {
  return (
    <div className='flex gap-4 p-3 rounded items-start'>
      <label className='block'>
        <span className='text-sm font-medium'>Fecha y hora</span>
        <input
          readOnly
          value={new Date(datetime).toLocaleString()}
          className='mt-1 block w-full bg-gray-100 border border-gray-200 rounded px-3 py-2 text-sm'
        />
      </label>
      <div className='flex-1'>
        <label className='block'>
          <span className='text-sm font-medium'>Modalidad</span>
          <select
            value={modality}
            onChange={(e) => onModalityChange(e.target.value as 'virtual' | 'presencial')}
            className='mt-1 block w-full border rounded px-3 py-2 text-sm'
          >
            <option value='virtual'>Virtual</option>
            <option value='presencial'>Presencial</option>
          </select>
        </label>
      </div>
    </div>
  );
};
</file>

<file path="src/Components/appointments/forms/modules/DaySelectSection.tsx">
import { useState } from 'react';
import { AvailabilityButton } from './AvailabilityButton';

interface DaySelectionProps {
  availableDays: Record<string, number[]>;
  onDaysChange: (days: string[]) => void;
}

export const DaySelectSection: React.FC<DaySelectionProps> = ({ availableDays, onDaysChange }) => {
  const [selectedDays, setSelectedDays] = useState<string[]>([]);

  const toggleDay = (day: string) => {
    const newSelectedDays = selectedDays.includes(day)
      ? selectedDays.filter((d) => d !== day)
      : [...selectedDays, day];

    setSelectedDays(newSelectedDays);
    onDaysChange(newSelectedDays);
  };

  const days = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];

  const isDayDisabled = (day: string) => {
    return !availableDays[day] || availableDays[day].length === 0;
  };

  return (
    <div className='mb-4'>
      <div className='flex flex-col gap-2'>
        {days.map((day) => (
          <AvailabilityButton
            key={day}
            label={day}
            selected={selectedDays.includes(day)}
            disabled={isDayDisabled(day)}
            onToggle={() => toggleDay(day)}
          />
        ))}
      </div>
    </div>
  );
};
</file>

<file path="src/Components/appointments/forms/modules/DescriptionSection.tsx">
import { TextArea } from '../../../atoms/textArea';

interface DescriptionSectionProps {
  description: string;
  error?: string;
  onChange: (value: string) => void;
  readOnly?: boolean;
}

export const DescriptionSection = ({
  description,
  error,
  onChange,
  readOnly = false,
}: DescriptionSectionProps) => {
  return (
    <TextArea
      label='Descripción del trabajo'
      value={description}
      onChange={readOnly ? undefined : (e) => onChange?.(e.target.value)}
      placeholder={readOnly ? '' : 'Breve descripción de lo que se requiere'}
      rows={3}
      error={error}
      readOnly={readOnly}
    />
  );
};
</file>

<file path="src/Components/appointments/forms/modules/EditAppointmentActions.tsx">
import { useMemo, useState } from 'react';
import { Button } from '../../../atoms/button';
import { AlertPopup } from '../popups/AlertPopup';
import { useAppointmentsContext } from '@/app/lib/utils/contexts/AppointmentsContext/AppoinmentsContext';

export type FormType = 'create' | 'edit' | 'view';

interface EditAppointmentActionsProps {
  loading: boolean;
  changesDetected: boolean;
  onCancel: () => void;
  onDelete?: () => void;
  submitDisabled?: boolean;
  formType?: FormType;
  appointmentStart?: string | Date;
  onRequestReprogram?: () => void; // ← SOLO se notifica al padre; el padre abre Justificación
}

const THREE_HOURS_MS = 3 * 60 * 60 * 1000;

export const EditAppointmentActions = ({
  loading,
  changesDetected,
  onCancel,
  onDelete,
  submitDisabled = false,
  formType = 'edit',
  appointmentStart,
  onRequestReprogram,
}: EditAppointmentActionsProps) => {
  const [popupOpen, setPopupOpen] = useState(false);
  const [popupVariant, setPopupVariant] = useState<'info' | 'confirm'>('info');
  const [popupMessage, setPopupMessage] = useState<React.ReactNode>(null);
  const [popupConfirmLabel, setPopupConfirmLabel] = useState<string>('Confirmar');
  const [popupOnConfirm, setPopupOnConfirm] = useState<(() => void) | undefined>(undefined);

  const { refetchAll } = useAppointmentsContext();

  const within3h = useMemo(() => {
    if (!appointmentStart) return false;
    const start = new Date(appointmentStart).getTime();
    return start - Date.now() < THREE_HOURS_MS;
  }, [appointmentStart]);

  const openInfo = (message: React.ReactNode) => {
    setPopupVariant('info');
    setPopupMessage(message);
    setPopupOnConfirm(undefined);
    setPopupOpen(true);
  };

  const openConfirm = (
    message: React.ReactNode,
    confirmLabel = 'Confirmar',
    onConfirm?: () => void,
  ) => {
    setPopupVariant('confirm');
    setPopupMessage(message);
    setPopupConfirmLabel(confirmLabel);
    setPopupOnConfirm(() => onConfirm);
    setPopupOpen(true);
  };

  const askConfirmCancel = () => {
    if (within3h) {
      openInfo(
        <>
          No es posible cancelar una cita con menos de <b>3 horas</b> de anticipación.
        </>,
      );
      return;
    }
    openConfirm(
      <>
        ¿Está seguro que desea cancelar la cita actual?
        <br />
        <span className='text-gray-500 text-xs'>
          *En caso de cancelación,la cita dejara de ser accesible.
        </span>
      </>,
      'Confirmar',
      () => {
        onDelete?.();
      }, // ← aquí recién se pide justificación (en el padre)
    );
  };

  const askConfirmReprogram = () => {
    if (within3h) {
      openInfo(
        <>
          La reprogramación de citas deberá realizarse con al menos <b>3 horas</b> de anticipación.
        </>,
      );
      return;
    }
    openConfirm(
      <>
        ¿Esta seguro que desea reprogramar la cita actual?
        <br />
        <span className='text-gray-500 text-xs'>
          *En caso de reprogramación, la cita actual será cancelada.
        </span>
      </>,
      'Confirmar',
      () => {
        onRequestReprogram?.();
      },
    );
  };

  return (
    <div className='flex items-center justify-end gap-2 pt-2'>
      <Button variant='secondary' onClick={onCancel}>
        Volver
      </Button>

      {formType === 'create' && (
        <Button type='submit' loading={loading} disabled={!changesDetected || submitDisabled}>
          Crear Cita
        </Button>
      )}

      {formType === 'edit' && (
        <>
          <Button type='submit' onClick={askConfirmReprogram}>
            Reprogramar
          </Button>
          <Button
            type='submit'
            onClick={() => {
              refetchAll();
            }}
            loading={loading}
            disabled={!changesDetected || submitDisabled}
          >
            Editar
          </Button>
        </>
      )}

      {formType === 'view' && onDelete && <Button onClick={askConfirmCancel}>Cancelar Cita</Button>}

      <AlertPopup
        open={popupOpen}
        onClose={() => setPopupOpen(false)}
        variant={popupVariant}
        title={popupVariant === 'confirm' ? 'Confirmar acción' : 'Atención'}
        message={popupMessage ?? ''}
        confirmLabel={popupConfirmLabel}
        cancelLabel='Volver'
        onConfirm={popupOnConfirm}
      />
    </div>
  );
};
</file>

<file path="src/Components/appointments/forms/modules/EditAppointmentHeader.tsx">
interface EditAppointmentHeaderProps {
  onClose: () => void;
  title?: string;
}

export const EditAppointmentHeader = ({
  onClose,
  title = 'Editar Cita',
}: EditAppointmentHeaderProps) => {
  return (
    <div className='flex items-start justify-between'>
      <h3 id='edit-appointment-title' className='text-lg font-semibold text-black'>
        {title}
      </h3>
      <button aria-label='Cerrar' className='text-gray-500 hover:text-gray-700' onClick={onClose}>
        ✕
      </button>
    </div>
  );
};
</file>

<file path="src/Components/appointments/forms/modules/LocationSection.tsx">
export type FormType = 'create' | 'edit' | 'view';
interface LocationSectionProps {
  address: string;
  error?: string;
  formtype: FormType;
  onOpenLocationModal: () => void;
}

export const LocationSection = ({
  address,
  error,
  onOpenLocationModal,
  formtype,
}: LocationSectionProps) => {
  return (
    <div className='flex flex-col gap-1'>
      <div
        onClick={onOpenLocationModal}
        className='text-center py-3 border border-gray-300 rounded-lg bg-gray-50 hover:bg-gray-100 cursor-pointer'
      >
        {formtype === 'view' ? (
          <p className='text-sm font-medium text-gray-700'>Ver Ubicacion</p>
        ) : null}
        {formtype !== 'view' && (
          <p className='text-sm font-medium text-gray-700'>
            📍 {address ? 'Editar ubicación' : 'Seleccionar ubicación'}
          </p>
        )}

        {error && <p className='text-red-600 text-sm mt-1'>{error}</p>}
      </div>

      {address && <p className='text-sm text-green-700 px-2'>📌 Ubicación: {address}</p>}
    </div>
  );
};
</file>

<file path="src/Components/appointments/forms/modules/MeetingLinkSection.tsx">
import { Input } from '../../../atoms/inputs';

interface MeetingLinkSectionProps {
  meetingLink: string;
  error?: string;
  onChange: (value: string) => void;
  readonly?: boolean;
}

export const MeetingLinkSection = ({
  meetingLink,
  error,
  onChange,
  readonly,
}: MeetingLinkSectionProps) => {
  return (
    <div className='space-y-2'>
      <Input
        label='Enlace de reunión'
        value={meetingLink}
        readOnly={readonly}
        onChange={(e) => onChange(e.target.value)}
        placeholder='https://meet.example.com/abcd'
        error={error}
      />
      <p className='text-xs text-gray-600'>
        Si no ingresa enlace, se generará uno automáticamente.
      </p>
    </div>
  );
};
</file>

<file path="src/Components/appointments/forms/modules/ModeSelectionActions.tsx">
import { Button } from '@/Components/atoms/button';

interface ModeSelectionActionsProps {
  fixerId: string;
  openWeek: () => void;
  openDaySelection: () => void;
}

export const ModeSelectionActions = ({ openWeek, openDaySelection }: ModeSelectionActionsProps) => {
  return (
    <div className='space-y-4'>
      <div className='text-center mb-6'>
        <p className='text-gray-600 text-sm'>Elige cómo quieres configurar tu disponibilidad</p>
      </div>

      <div className='space-y-3'>
        <Button
          onClick={openWeek}
          className='w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium'
        >
          Configuración Semanal
        </Button>

        <p className='text-xs text-gray-500 text-center'>
          Define días laborales y horarios para toda la semana
        </p>

        <div className='border-t border-gray-200 my-2'></div>

        <Button
          onClick={openDaySelection}
          className='w-full py-3 bg-green-600 hover:bg-green-700 text-white font-medium'
        >
          Configuración por Días
        </Button>

        <p className='text-xs text-gray-500 text-center'>
          Selecciona días específicos para modificar sus horarios
        </p>
      </div>
    </div>
  );
};
</file>

<file path="src/Components/appointments/forms/modules/SelectHourSection.tsx">
import { AvailabilityButton } from './AvailabilityButton';
interface SelectHourSectionProps {
  selectedHours: number[];
  onHoursChange: (hours: number[]) => void;
}

export const SelectHourSection = ({ selectedHours, onHoursChange }: SelectHourSectionProps) => {
  const toggleHour = (hour: number) => {
    const newSelectedHours = selectedHours.includes(hour)
      ? selectedHours.filter((h) => h !== hour)
      : [...selectedHours, hour];

    onHoursChange(newSelectedHours);
  };

  const hours = [
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,
  ];

  return (
    <div className='mb-6'>
      <div className='max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-2'>
        <div className='flex flex-col gap-2'>
          {hours.map((hour) => (
            <AvailabilityButton
              key={hour}
              label={hour.toString()}
              selected={selectedHours.includes(hour)}
              onToggle={() => toggleHour(hour)}
              disabled={false}
              isDay={false}
            />
          ))}
        </div>
      </div>
    </div>
  );
};
</file>

<file path="src/Components/appointments/forms/modules/WeekDaysSection.tsx">
import { CircularDayButton } from './CircularDayButton';

interface WeekDaysSectionProps {
  selectedDays: string[];
  onDaysChange: (days: string[]) => void;
}

export const WeekDaysSection = ({ selectedDays, onDaysChange }: WeekDaysSectionProps) => {
  const toggleDay = (day: string) => {
    const newSelectedDays = selectedDays.includes(day)
      ? selectedDays.filter((d) => d !== day)
      : [...selectedDays, day];

    onDaysChange(newSelectedDays);
  };

  const days = ['Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab', 'Dom'];

  return (
    <div className='mb-6'>
      <div className='flex justify-between items-center mb-4'>
        {days.map((day) => (
          <CircularDayButton
            key={day}
            day={day}
            selected={selectedDays.includes(day)}
            onToggle={toggleDay}
          />
        ))}
      </div>
    </div>
  );
};
</file>

<file path="src/Components/appointments/forms/popups/AlertPopup.tsx">
import * as React from 'react';
import { Dialog, DialogContent } from '../../../calendar/ui/dialog';
import { Button } from '../../../atoms/button';

type Variant = 'info' | 'confirm';

interface AlertPopupProps {
  open: boolean;
  onClose: () => void;
  variant?: Variant;
  title?: string;
  message: React.ReactNode;
  confirmLabel?: string;
  cancelLabel?: string;
  onConfirm?: () => void;
}

export const AlertPopup: React.FC<AlertPopupProps> = ({
  open,
  onClose,
  variant = 'info',
  title = 'Atención',
  message,
  confirmLabel = 'Confirmar',
  cancelLabel = 'Volver',
  onConfirm,
}) => {
  const handleConfirm = () => {
    onClose(); // cierra primero
    setTimeout(() => {
      // evita doble montaje en el mismo tick
      onConfirm?.();
    }, 0);
  };

  return (
    <Dialog open={open} onOpenChange={(v) => !v && onClose()}>
      <DialogContent className='bg-transparent shadow-none p-0'>
        <div className='overflow-hidden rounded-2xl max-w-sm bg-white'>
          <div className='bg-indigo-700 text-white px-4 py-3 flex items-center justify-between'>
            <span className='font-semibold'>{title}</span>
            <button
              onClick={onClose}
              className='opacity-90 hover:opacity-100 transition'
              aria-label='Cerrar'
            >
              <svg
                xmlns='http://www.w3.org/2000/svg'
                className='h-5 w-5'
                viewBox='0 0 24 24'
                strokeWidth={2}
                stroke='currentColor'
                fill='none'
                strokeLinecap='round'
                strokeLinejoin='round'
              >
                <path d='M18 6L6 18M6 6l12 12' />
              </svg>
            </button>
          </div>

          <div className='p-6 text-center'>
            <div className='mx-auto mb-3'>
              <svg
                xmlns='http://www.w3.org/2000/svg'
                className='h-6 w-6 inline-block text-red-600'
                viewBox='0 0 24 24'
                fill='currentColor'
              >
                <path d='M12 2a1 1 0 0 1 .894.553l9 18A1 1 0 0 1 21 22H3a1 1 0 0 1-.894-1.447l9-18A1 1 0 0 1 12 2Zm0 6a1 1 0 0 0-1 1v5a1 1 0 1 0 2 0V9a1 1 0 0 0-1-1Zm0 9a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z' />
              </svg>
            </div>
            <div className='text-sm text-gray-700 leading-relaxed'>{message}</div>

            <div
              className={`mt-5 flex ${variant === 'confirm' ? 'justify-between gap-3' : 'justify-center'}`}
            >
              <Button variant='secondary' onClick={onClose} className='rounded-full px-6'>
                {cancelLabel}
              </Button>
              {variant === 'confirm' && (
                <Button onClick={handleConfirm} className='rounded-full px-6'>
                  {confirmLabel}
                </Button>
              )}
            </div>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
};
</file>

<file path="src/Components/appointments/forms/popups/JustificationPopup.tsx">
'use client';
import * as React from 'react';
import { Dialog, DialogContent } from '../../../calendar/ui/dialog';
import { Button } from '../../../atoms/button';

interface JustificationPopupProps {
  open: boolean;
  onClose: () => void;
  onSubmit: (reason: string) => void;
  title?: string;
  confirmLabel?: string;
  cancelLabel?: string;
  minLength?: number; // por defecto 10
  maxLength?: number; // por defecto 300
  placeholder?: string;
}

export const JustificationPopup: React.FC<JustificationPopupProps> = ({
  open,
  onClose,
  onSubmit,
  title = 'Justificación',
  confirmLabel = 'Continuar',
  cancelLabel = 'Volver',
  minLength = 10,
  maxLength = 300,
  placeholder = 'Describe brevemente el motivo…',
}) => {
  const [reason, setReason] = React.useState('');
  const [error, setError] = React.useState<string | null>(null);
  const textareaRef = React.useRef<HTMLTextAreaElement | null>(null);

  React.useEffect(() => {
    if (open) {
      setTimeout(() => textareaRef.current?.focus(), 40);
    } else {
      // limpiar al cerrar
      setReason('');
      setError(null);
    }
  }, [open]);

  const handleConfirm = () => {
    const trimmed = reason.trim();
    if (trimmed.length < minLength) {
      setError(`Debe ingresar al menos ${minLength} caracteres.`);
      return;
    }
    if (trimmed.length > maxLength) {
      setError(`El motivo no puede superar los ${maxLength} caracteres.`);
      return;
    }
    setError(null);
    onSubmit(trimmed);
  };

  return (
    <Dialog open={open} onOpenChange={(v) => !v && onClose()}>
      <DialogContent className='bg-transparent shadow-none p-0'>
        <div className='overflow-hidden rounded-2xl w-full max-w-md bg-white text-black'>
          {/* Header */}
          <div className='bg-indigo-700 text-white px-4 py-3 flex items-center justify-between'>
            <span className='font-semibold'>{title}</span>
            <button
              onClick={onClose}
              className='opacity-90 hover:opacity-100 transition'
              aria-label='Cerrar'
            >
              <svg
                xmlns='http://www.w3.org/2000/svg'
                className='h-5 w-5'
                viewBox='0 0 24 24'
                strokeWidth={2}
                stroke='currentColor'
                fill='none'
                strokeLinecap='round'
                strokeLinejoin='round'
              >
                <path d='M18 6L6 18M6 6l12 12' />
              </svg>
            </button>
          </div>

          {/* Body */}
          <div className='p-5'>
            <p className='text-sm text-gray-700 mb-3'>
              Indique el motivo por el cual desea reprogramar la cita.
            </p>

            <textarea
              ref={textareaRef}
              value={reason}
              onChange={(e) => setReason(e.target.value)}
              rows={5}
              maxLength={maxLength}
              placeholder={placeholder}
              className='w-full rounded-md border border-gray-300 px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500'
            />

            <div className='mt-1 text-right text-xs text-gray-500'>
              {reason.trim().length}/{maxLength}
            </div>

            {error && <p className='mt-2 text-sm text-red-600'>{error}</p>}

            <div className='mt-5 flex justify-between gap-3'>
              <Button variant='secondary' onClick={onClose} className='rounded-full px-6'>
                {cancelLabel}
              </Button>
              <Button onClick={handleConfirm} className='rounded-full px-6'>
                {confirmLabel}
              </Button>
            </div>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
};

export default JustificationPopup;
</file>

<file path="src/Components/appointments/forms/RescheduleForm.tsx">
'use client';
import React, { forwardRef, useImperativeHandle, useRef, useState } from 'react';
import axios from 'axios';
import { z } from 'zod';
import LocationModal from './LocationModal';
import AppointmentSummaryModal from './AppointmentSummaryModal';
import MobileDayliView from '@/Components/calendar/mobile/MobileDayliView';
import { useAppointmentsContext } from '@/app/lib/utils/contexts/AppointmentsContext/AppoinmentsContext';

export type RescheduleFormHandle = {
  open: (newSlotISO?: string) => void;
  close: () => void;
};

interface RescheduleFormProps {
  fixerId: string;
  requesterId: string;
  pastDate: string; // ISO de la cita actual
  motivo: string; // Motivo de reprogramación
  onSuccess?: () => void;
}

const baseSchema = z.object({
  client: z
    .string()
    .regex(/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/, 'Ingrese un nombre de cliente válido')
    .nonempty('Ingrese un nombre de cliente')
    .max(50),
  contact: z
    .string()
    .regex(/^[67]\d{7}$/, 'Ingrese un número de teléfono válido (8 dígitos)')
    .nonempty('Ingrese un número de teléfono'),
  description: z.string().nonempty('Ingrese una descripción de trabajo').max(300),
});
const virtualSchema = baseSchema.extend({
  modality: z.literal('virtual'),
  meetingLink: z
    .string()
    .regex(
      /^(https?:\/\/)?(meet\.google\.com|zoom\.us)\/[^\s]+$/,
      'Ingrese un enlace válido de Meet o Zoom',
    )
    .nonempty('Ingrese un enlace de Meet o Zoom'),
  location: z.undefined().optional(),
});
const presentialSchema = baseSchema.extend({
  modality: z.literal('presential'),
  meetingLink: z.undefined().optional(),
  location: z
    .object({
      lat: z.number(),
      lon: z.number(),
      address: z.string().nonempty('Seleccione una ubicación'),
    })
    .nullable()
    .refine((val) => val !== null, { message: 'Seleccione una ubicación' })
    .refine((val) => val?.address !== 'No se pudo obtener la dirección', {
      message: 'Seleccione una ubicación.',
    }),
});
const appointmentSchema = z.discriminatedUnion('modality', [virtualSchema, presentialSchema]);

const API_BASE = process.env.NEXT_PUBLIC_BACKEND || 'https://servineo-backend-lorem.onrender.com';

function ymd(iso: string) {
  const d = new Date(iso);
  const pad = (n: number) => String(n).padStart(2, '0');
  return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
}
function startHour(iso: string) {
  return new Date(iso).getHours();
}

export default forwardRef<RescheduleFormHandle, RescheduleFormProps>(function RescheduleForm(
  { fixerId, requesterId, pastDate, motivo, onSuccess },
  ref,
) {
  const [open, setOpen] = useState(false);
  const [newDatetime, setNewDatetime] = useState<string>('');

  // campos editables (prefill desde backend)
  const [client, setClient] = useState('');
  const [contact, setContact] = useState('');
  const [modality, setModality] = useState<'virtual' | 'presential'>('virtual');
  const [description, setDescription] = useState('');
  const [meetingLink, setMeetingLink] = useState('');
  const [place, setPlace] = useState('');
  const [location, setLocation] = useState<{ lat: number; lon: number; address: string } | null>(
    null,
  );
  const [originalAppointmentId, setOriginalAppointmentId] = useState<string | null>(null);

  const [loading, setLoading] = useState(false);
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [showLocationModal, setShowLocationModal] = useState(false);
  const [showDatePicker, setShowDatePicker] = useState(false);
  const [pickerSelectedDate, setPickerSelectedDate] = useState<Date>(new Date());

  const [showSummary, setShowSummary] = useState(false);
  const [summaryData, setSummaryData] = useState<{
    title: string;
    name: string;
    date: string;
    time: string;
    modality: 'virtual' | 'presential';
    locationOrLink: string;
    description?: string;
    motive?: string;
  } | null>(null);

  const dialogRef = useRef<HTMLDivElement | null>(null);
  const firstRef = useRef<HTMLInputElement | null>(null);

  useImperativeHandle(ref, () => ({
    open: async (iso?: string) => {
      if (iso) setNewDatetime(iso);
      setOpen(true);
      try {
        await loadOriginalAppointment();
      } finally {
        setTimeout(() => firstRef.current?.focus(), 40);
      }
    },
    close: () => handleClose(),
  }));

  const { refetchAll } = useAppointmentsContext();

  function handleClose() {
    setOpen(false);
    setNewDatetime('');
    setClient('');
    setContact('');
    setDescription('');
    setModality('virtual');
    setMeetingLink('');
    setPlace('');
    setLocation(null);
    setErrors({});
    setShowSummary(false);
    setSummaryData(null);
  }

  function parseNewTimes(iso: string) {
    const base = iso ? new Date(iso) : new Date();
    const start = new Date(base.getTime() - 4 * 60 * 60 * 1000); // si tu backend espera UTC-4
    const end = new Date(start.getTime() + 60 * 60 * 1000);
    return {
      selected_date: start.toISOString().split('T')[0],
      starting_time: start.toISOString(),
      finishing_time: end.toISOString(),
    };
  }

  async function loadOriginalAppointment() {
    try {
      const url =
        `${API_BASE}/api/crud_read/appointments/get_modal_form` +
        `?fixer_id=${encodeURIComponent(fixerId)}` +
        `&requester_id=${encodeURIComponent(requesterId)}` +
        `&appointment_date=${encodeURIComponent(ymd(pastDate))}T00:00:00.000Z` +
        `&start_hour=${encodeURIComponent(String(startHour(pastDate)))}`;

      const res = await axios.get(url, {
        headers: { Accept: 'application/json' },
        timeout: 10000,
      });

      const ap = res.data?.data || {};
      setOriginalAppointmentId(ap._id || null);
      setClient(ap.current_requester_name || '');
      setContact(ap.current_requester_phone || '');
      setDescription(ap.appointment_description || '');
      const isPresential = ap.appointment_type === 'presential';
      setModality(isPresential ? 'presential' : 'virtual');

      if (isPresential) {
        const lat = ap.latitude != null ? Number(ap.latitude) : undefined;
        const lon = ap.longitude != null ? Number(ap.longitude) : undefined;
        const address = ap.display_name_location || '';
        if (Number.isFinite(lat) && Number.isFinite(lon) && address) {
          setLocation({ lat: lat as number, lon: lon as number, address });
          setPlace(address);
        }
      } else {
        setMeetingLink(ap.link_id || '');
      }
    } catch (e) {
      console.error('❌ Error al cargar cita original:', e);
      setErrors({ general: 'No se pudo cargar la cita original.' });
    }
  }

  function handleLocationConfirm(loc: { lat: number; lon: number; address: string }) {
    setLocation(loc);
    setPlace(loc.address);
    setShowLocationModal(false);
  }

  function handleDatePickerOpen() {
    setPickerSelectedDate(new Date());
    setShowDatePicker(true);
  }

  function handleDatePickerDateChange(newDate: Date) {
    setPickerSelectedDate(newDate);
  }

  function handleDateTimeSelect(selectedDatetime: string) {
    setNewDatetime(selectedDatetime);
    setShowDatePicker(false);
  }

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setErrors({});

    const formData = {
      client,
      contact,
      description,
      modality,
      meetingLink: modality === 'virtual' ? meetingLink : undefined,
      location: modality === 'presential' ? location : undefined,
    };
    const validation = appointmentSchema.safeParse(formData);
    if (!validation.success) {
      const fieldErrors: Record<string, string> = {};
      validation.error.issues.forEach((err) => {
        const key = (Array.isArray(err.path) && err.path[0]) || 'general';
        fieldErrors[key as string] = err.message;
      });
      setErrors(fieldErrors);
      return;
    }

    if (!newDatetime) {
      setErrors({ general: 'Seleccione una nueva fecha y hora' });
      return;
    }

    setLoading(true);
    try {
      if (!originalAppointmentId) {
        setErrors({ general: 'No se pudo obtener el ID de la cita original.' });
        return;
      }

      const updateUrl = `${API_BASE}/api/crud_update/appointments/update_by_id?id=${encodeURIComponent(originalAppointmentId)}`;
      const updatePayload = {
        schedule_state: 'cancelled',
        reprogram_reason: motivo ?? 'Sin motivo',
      };

      const updateRes = await axios.put(updateUrl, updatePayload, {
        headers: { 'Content-Type': 'application/json' },
        timeout: 10000,
      });

      const updateData = updateRes?.data;
      console.log('update response:', updateRes.status, updateData);

      if (updateRes.status >= 400 || updateData?.modified === false) {
        throw new Error(
          updateData?.message || `Actualización fallida (status ${updateRes.status})`,
        );
      }

      console.log('Cita original cancelada');

      //  --- CREAR LA NUEVA CITA ---
      const { selected_date, starting_time, finishing_time } = parseNewTimes(newDatetime);

      const createPayload = {
        id_fixer: fixerId,
        id_requester: requesterId,
        selected_date,
        starting_time,
        finishing_time,
        schedule_state: 'booked',
        appointment_type: modality,
        appointment_description: description,
        current_requester_name: client,
        current_requester_phone: contact,
        link_id: modality === 'virtual' ? meetingLink : '',
        display_name_location: modality === 'presential' ? place : '',
        lat: modality === 'presential' ? (location?.lat ?? null) : null,
        lon: modality === 'presential' ? (location?.lon ?? null) : null,
      };

      const createRes = await axios.post(
        `${API_BASE}/api/crud_create/appointments/create`,
        createPayload,
        {
          headers: { 'Content-Type': 'application/json' },
          timeout: 10000,
        },
      );

      const createData = createRes?.data;
      console.log('create response:', createRes.status, createData);

      if (createRes.status >= 400 || (createData && createData.success === false)) {
        throw new Error(createData?.message || `Creación fallida (status ${createRes.status})`);
      }

      console.log('✅ Nueva cita creada');

      //  --- MOSTRAR RESUMEN ---
      const startLocal = new Date(createPayload.starting_time);
      const adjustedHour = new Date(startLocal.getTime() + 4 * 60 * 60 * 1000); // +4 horas
      const hourStr = `${String(adjustedHour.getHours()).padStart(2, '0')}:00`;

      setSummaryData({
        title: 'Cita reprogramada con éxito',
        name: client,
        date: startLocal.toLocaleDateString(),
        time: hourStr,
        modality,
        locationOrLink: modality === 'virtual' ? meetingLink : place,
        description,
        motive: motivo || undefined,
      });
      setShowSummary(true);
    } catch (err: unknown) {
      // Mensaje claro para el usuario + logging para debugging
      console.error('❌ Error en reprogramación:', err);
    } finally {
      setLoading(false);
    }
  }
  if (!open) return null;

  return (
    <>
      <div className='fixed inset-0 z-50 flex items-center justify-center px-4'>
        <div className='absolute inset-0 bg-black/50' onClick={handleClose} aria-hidden />
        <div
          ref={dialogRef}
          role='dialog'
          aria-modal='true'
          aria-labelledby='reschedule-title'
          className='relative bg-white rounded-lg shadow-xl w-full max-w-xl mx-auto overflow-auto'
          style={{ maxHeight: '90vh' }}
        >
          <div className='p-4 sm:p-6'>
            <div className='flex items-start justify-between'>
              <h2 id='reschedule-title' className='text-lg font-semibold text-black'>
                Reprogramar cita
              </h2>
              <button
                aria-label='Cerrar'
                className='text-gray-500 hover:text-gray-700'
                onClick={handleClose}
              >
                ✕
              </button>
            </div>

            <form onSubmit={handleSubmit} className='mt-4 space-y-4 text-black'>
              <div className='grid grid-cols-1 sm:grid-cols-2 gap-3 p-3 rounded'>
                <label className='block'>
                  <span className='text-sm font-medium'>Fecha y hora nueva *</span>
                  <input
                    readOnly
                    value={newDatetime ? new Date(newDatetime).toLocaleString() : ''}
                    onClick={handleDatePickerOpen}
                    className='mt-1 block w-full bg-gray-50 border border-gray-300 rounded px-3 py-2 text-sm cursor-pointer hover:bg-gray-100'
                    placeholder='Click para seleccionar fecha'
                  />
                  {errors.general && <p className='text-red-600 text-sm mt-1'>{errors.general}</p>}
                </label>

                <label className='block'>
                  <span className='text-sm font-medium'>Modalidad *</span>
                  <select
                    value={modality}
                    onChange={(e) => setModality(e.target.value as 'virtual' | 'presential')}
                    className='mt-1 block w-full border rounded px-3 py-2 text-sm'
                  >
                    <option value='virtual'>Virtual</option>
                    <option value='presential'>Presencial</option>
                  </select>
                </label>
              </div>

              <div className='grid grid-cols-1 sm:grid-cols-2 gap-3'>
                <label className='block'>
                  <span className='text-sm font-medium'>Cliente *</span>
                  <input
                    ref={firstRef}
                    value={client}
                    onChange={(e) => setClient(e.target.value)}
                    className='mt-1 block w-full border rounded px-3 py-2 bg-white'
                    placeholder='Nombre del cliente'
                  />
                  {errors.client && <p className='text-red-600 text-sm mt-1'>{errors.client}</p>}
                </label>
                <label className='block'>
                  <span className='text-sm font-medium'>Contacto *</span>
                  <input
                    value={contact}
                    onChange={(e) => setContact(e.target.value)}
                    className='mt-1 block w-full border rounded px-3 py-2 bg-white'
                    placeholder='7XXXXXXX'
                    maxLength={8}
                  />
                  {errors.contact && <p className='text-red-600 text-sm mt-1'>{errors.contact}</p>}
                </label>
              </div>

              <label className='block'>
                <span className='text-sm font-medium'>Descripción del trabajo *</span>
                <textarea
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  className='mt-1 block w-full border rounded px-3 py-2 bg-white'
                  rows={3}
                />
                {errors.description && (
                  <p className='text-red-600 text-sm mt-1'>{errors.description}</p>
                )}
              </label>

              {modality === 'presential' ? (
                <>
                  <div
                    onClick={() => setShowLocationModal(true)}
                    className='text-center py-3 border border-gray-300 rounded-lg bg-gray-50 hover:bg-gray-100 cursor-pointer'
                  >
                    <p className='text-sm font-medium text-gray-700'>
                      📍 {place ? 'Editar ubicación' : 'Seleccionar ubicación'}
                    </p>
                  </div>
                  {place && (
                    <p className='text-sm text-green-700 px-2 mt-1'>📌 Ubicación: {place}</p>
                  )}
                  {errors.location && (
                    <p className='text-red-600 text-sm mt-1'>{errors.location}</p>
                  )}
                </>
              ) : (
                <label className='block'>
                  <span className='text-sm font-medium'>Enlace de reunión *</span>
                  <input
                    value={meetingLink}
                    onChange={(e) => setMeetingLink(e.target.value)}
                    className='mt-1 block w-full border rounded px-3 py-2 bg-white'
                    placeholder='https://meet.example.com/...'
                  />
                  {errors.meetingLink && (
                    <p className='text-red-600 text-sm mt-1'>{errors.meetingLink}</p>
                  )}
                </label>
              )}

              <div className='flex items-center justify-end gap-2 pt-2'>
                <button
                  type='button'
                  onClick={handleClose}
                  className='px-4 py-2 rounded bg-gray-300 text-sm'
                >
                  Volver
                </button>
                <button
                  type='submit'
                  disabled={loading}
                  className='px-4 py-2 rounded bg-[#2B6AE0] text-white text-sm disabled:opacity-60 disabled:cursor-not-allowed'
                >
                  {loading ? 'Reprogramando...' : 'Reprogramar'}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <LocationModal
        open={showLocationModal}
        onClose={() => setShowLocationModal(false)}
        onConfirm={handleLocationConfirm}
        initialCoords={location}
      />

      {/* Modal de selección de fecha/hora con calendario */}
      {showDatePicker && (
        <div className='fixed inset-0 z-[60] flex items-center justify-center px-4'>
          <div className='absolute inset-0 bg-black/50' onClick={() => setShowDatePicker(false)} />
          <div
            className='relative bg-white rounded-lg shadow-xl w-full max-w-2xl mx-auto overflow-hidden'
            style={{ maxHeight: '90vh' }}
          >
            <div className='p-4 border-b flex items-center justify-between'>
              <h4 className='text-lg font-semibold text-black'>Seleccionar nueva fecha y hora</h4>
              <button
                onClick={() => setShowDatePicker(false)}
                className='text-gray-500 hover:text-gray-700'
                aria-label='Cerrar'
              >
                ✕
              </button>
            </div>
            <div className='overflow-auto' style={{ maxHeight: 'calc(90vh - 80px)' }}>
              <MobileDayliView
                selectedDate={pickerSelectedDate}
                fixerId={fixerId}
                requesterId={requesterId}
                onDateChange={handleDatePickerDateChange}
                pickerMode={true} // <--- activar modo "picker"
                onSlotSelect={(iso: string) => {
                  // recibe la ISO desde MobileDayliView y la procesa como antes
                  handleDateTimeSelect(iso);
                }}
              />
            </div>
          </div>
        </div>
      )}

      {summaryData && (
        <AppointmentSummaryModal
          open={showSummary}
          onClose={() => {
            setShowSummary(false);
            handleClose();
            onSuccess?.();
            refetchAll();
          }}
          data={summaryData}
        />
      )}
    </>
  );
});
</file>

<file path="src/Components/appointments/forms/WeekAvailabilityModal.tsx">
'use client';

import { useState, useImperativeHandle, forwardRef } from 'react';
import axios from 'axios';

import { AvailabilityActions } from './modules/AvailabilityActions';
import { AvailabilityHeader } from './modules/AvailabilityHeader';
import { WeekDaysSection } from './modules/WeekDaysSection';
import { useAppointmentsContext } from '@/app/lib/utils/contexts/AppointmentsContext/AppoinmentsContext';

import useMessage from '@/hooks/useMessage';
import Message from '@/Components/ui/Message';

const API = process.env.NEXT_PUBLIC_BACKEND as string;

interface AvailabilityResponse {
  message: string;
  availability: {
    lunes: number[];
    martes: number[];
    miercoles: number[];
    jueves: number[];
    viernes: number[];
    sabado: number[];
    domingo: number[];
  };
}

interface WeekAvailabilityModalProps {
  fixerId?: string;
  onClose?: () => void;
}

export interface WeekAvailabilityModalHandles {
  open: () => void;
  close: () => void;
}

export const WeekAvailabilityModal = forwardRef<
  WeekAvailabilityModalHandles,
  WeekAvailabilityModalProps
>(({ fixerId, onClose }, ref) => {
  const [isOpen, setIsOpen] = useState(false);
  const [selectedDays, setSelectedDays] = useState<string[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const { showMessage, messageState } = useMessage();

  const { refetchAll } = useAppointmentsContext();
  useImperativeHandle(ref, () => ({
    open: () => {
      setIsOpen(true);
      loadPreviousConfiguration();
    },
    close: () => handleClose(),
  }));

  const loadPreviousConfiguration = async () => {
    try {
      setLoading(true);
      setError(null);

      const response = await axios.get<AvailabilityResponse>(
        `${API}/api/crud_read/appointments/get_fixer_availability?fixer_id=${fixerId}`,
      );

      const availability = response.data.availability;

      const daysWithAvailability = Object.entries(availability)
        .filter(([hours]) => hours.length > 0)
        .map(([day]) => day);

      const abbreviatedDays = daysWithAvailability.map((day: string) => {
        switch (day.toLowerCase()) {
          case 'lunes':
            return 'Lun';
          case 'martes':
            return 'Mar';
          case 'miercoles':
            return 'Mie';
          case 'jueves':
            return 'Jue';
          case 'viernes':
            return 'Vie';
          case 'sabado':
            return 'Sab';
          case 'domingo':
            return 'Dom';
          default:
            return day;
        }
      });

      setSelectedDays(abbreviatedDays);
    } catch (err) {
      setError('Error al cargar la configuración previa');
      console.error('Error loading availability:', err);
    } finally {
      setLoading(false);
    }
  };

  const handleClose = () => {
    setIsOpen(false);
    setSelectedDays([]);
    setError(null);
    onClose?.();
  };

  const handleConfirm = async () => {
    if (selectedDays.length) {
      const daysFullName = selectedDays.map((day) => {
        switch (day) {
          case 'Lun':
            return 'lunes';
          case 'Mar':
            return 'martes';
          case 'Mie':
            return 'miercoles';
          case 'Jue':
            return 'jueves';
          case 'Vie':
            return 'viernes';
          case 'Sab':
            return 'sabado';
          case 'Dom':
            return 'domingo';
          default:
            return day.toLowerCase();
        }
      });

      // console.log('Días seleccionados:', daysFullName);

      const availabilityData: Record<string, number[]> = {
        lunes: [],
        martes: [],
        miercoles: [],
        jueves: [],
        viernes: [],
        sabado: [],
        domingo: [],
      };

      daysFullName.forEach((day) => {
        availabilityData[day] = [8, 9, 10, 11, 14, 15, 16, 17];
      });

      const allDays = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
      allDays.forEach((day) => {
        if (!daysFullName.includes(day)) {
          availabilityData[day] = [];
        }
      });

      try {
        const response = await axios.put(
          `${API}/api/crud_update/appointments/update_fixer_availability`,
          {
            fixer_id: fixerId,
            availability: availabilityData,
          },
        );

        if (response.data.updated) {
          showMessage({
            message: 'Días guardados correctamente',
            type: 'success',
            title: 'Éxito!',
            onCloseCallback: () => {
              handleClose();
            },
          });
        } else {
          setError('Error al actualizar la disponibilidad');
        }
      } catch (err) {
        console.error('Error guardando configuración:', err);
        setError('Error al guardar la configuración');
      } finally {
        refetchAll();
      }
    } else {
      setError('Selecciona al menos un día');
    }
  };

  const handleCancel = () => {
    handleClose();
  };

  const handleDaysChange = (days: string[]) => {
    setSelectedDays(days);
    setError(null);
  };

  if (!isOpen) return null;

  return (
    <>
      <div className='fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50'>
        <div className='max-w-md w-full bg-white rounded-lg shadow-lg p-6'>
          <AvailabilityHeader headerText='Seleccionar Disponibilidad' onClose={handleClose} />

          <p className='text-black font-semibold mb-4'>Días de trabajo de la semana</p>

          {loading ? (
            <div className='flex justify-center items-center py-8'>
              <div className='animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600'></div>
              <span className='ml-2'>Cargando configuración...</span>
            </div>
          ) : error ? (
            <div className='text-red-600 text-center py-4'>
              {error}
              <div className='flex gap-2 justify-center mt-3'>
                <button
                  onClick={loadPreviousConfiguration}
                  className='px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm'
                >
                  Reintentar
                </button>
                <button
                  onClick={handleClose}
                  className='px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 text-sm'
                >
                  Cerrar
                </button>
              </div>
            </div>
          ) : (
            <>
              <WeekDaysSection selectedDays={selectedDays} onDaysChange={handleDaysChange} />

              <p className='text-sm text-gray-700 mb-4'>
                *Los días seleccionados (azules) se aplicarán como laborales para todas las semanas
                de cada mes.
              </p>

              <AvailabilityActions
                confirmPlaceholder='Guardar'
                onCancel={handleCancel}
                onConfirm={handleConfirm}
              />
            </>
          )}
        </div>
      </div>
      <Message {...messageState} />
    </>
  );
});

WeekAvailabilityModal.displayName = 'WeekAvailabilityModal';
</file>

<file path="src/Components/ask_for_help/boton_whatsapp.tsx">
'use client';
import React, { useState, useRef } from 'react';
import { FaWhatsapp } from 'react-icons/fa';
import ReCAPTCHA from 'react-google-recaptcha';
import ErrorMessage from './ErrorMessage';

const BotonWhatsapp = () => {
  const [showError, setShowError] = useState(false);
  const [showCaptcha, setShowCaptcha] = useState(false);
  const recaptchaRef = useRef<ReCAPTCHA>(null);

  const numerowhapi = '59178194834';
  const mensaje = '';
  const encodedMessage = encodeURIComponent(mensaje);
  const whatsappUrl = `https://wa.me/${numerowhapi}?text=${encodedMessage}`;

  const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000/api';

  const handleInitialClick = () => {
    if (navigator.onLine) {
      setShowCaptcha(true);
    } else {
      setShowError(true);
    }
  };

  const handleCaptchaChange = async (token: string | null) => {
    if (!token) return;

    try {
      const response = await fetch(`${API_URL}/verify-captcha`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token }),
      });

      const data = await response.json();

      if (data.success) {
        setTimeout(() => {
          setShowCaptcha(false);
          window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
        }, 1000);
      } else {
        alert('Verificación fallida. Las claves no coinciden o el token expiró.');
        recaptchaRef.current?.reset();
      }
    } catch (error) {
      console.error('Error conectando con el backend:', error);
      setShowError(true);
      setShowCaptcha(false);
    }
  };

  return (
    <>
      {/* Botón Flotante - UN POCO MÁS ARRIBA */}
      <button
        type='button'
        onClick={handleInitialClick}
        className='fixed z-40 flex items-center justify-center
                   w-14 h-14 md:w-16 md:h-16
                   bg-green-500 hover:bg-green-600
                   rounded-full shadow-2xl shadow-green-500/50
                   transition-all duration-300 transform hover:scale-110
                   cursor-pointer
                   /* Desktop: más arriba */
                   bottom-20 right-6
                   /* Tablet: ajustado */
                   md:bottom-22 md:right-8
                   /* Mobile: MÁS ARRIBA para no tapar header */
                   sm:bottom-24 sm:right-5
                   /* Mobile pequeño: aún más arriba */
                   xs:bottom-28 xs:right-4
                   /* Para teléfonos muy pequeños */
                   max-sm:bottom-[7rem] max-sm:right-4'
        aria-label='Contactar por WhatsApp'
      >
        <FaWhatsapp size={32} className='text-white' />

        {/* Glow effect verde */}
        <div className='absolute inset-0 rounded-full bg-green-400/20 animate-pulse'></div>
      </button>

      {/* Modal / Overlay del Captcha */}
      {showCaptcha && (
        <div className='fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm'>
          <div className='bg-white p-6 rounded-lg shadow-xl relative flex flex-col items-center gap-4'>
            <h3 className='text-lg font-semibold text-gray-700'>Verificación de seguridad</h3>
            <p className='text-sm text-gray-500 mb-2'>Confirma que eres humano para continuar.</p>

            <ReCAPTCHA
              ref={recaptchaRef}
              sitekey={
                process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY_V2 ||
                process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY ||
                ''
              }
              onChange={handleCaptchaChange}
            />

            {/* Botón para cerrar */}
            <button
              onClick={() => setShowCaptcha(false)}
              className='text-gray-400 hover:text-gray-600 text-sm mt-2 underline'
            >
              Cancelar
            </button>
          </div>
        </div>
      )}

      {showError && (
        <ErrorMessage
          message='Hubo un problema de conexión. Intenta más tarde.'
          onClose={() => setShowError(false)}
        />
      )}
    </>
  );
};

export default BotonWhatsapp;
</file>

<file path="src/Components/ask_for_help/contenedor.tsx">
import React from 'react';
import BotonWhatsapp from './boton_whatsapp';

const BotonesFlotantes = () => {
  return (
    // Ya NO es fixed, solo apila el botón de WhatsApp
    <div className='flex flex-col items-center'>
      <BotonWhatsapp />
    </div>
  );
};

export default BotonesFlotantes;
</file>

<file path="src/Components/ask_for_help/ErrorMessage.tsx">
'use client';
import React from 'react';

interface ErrorMessageProps {
  message: string;
  onClose: () => void;
}

const ErrorMessage: React.FC<ErrorMessageProps> = ({ message, onClose }) => {
  return (
    // Contenedor fijo: se superpone a toda la página
    <div
      className='fixed inset-0 bg-gray-500 bg-opacity-50 flex items-center justify-center z-[100]'
      onClick={onClose}
    >
      <div
        className='bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4'
        onClick={(e) => e.stopPropagation()}
      >
        <div className='flex items-center'>
          <svg
            className='w-8 h-8 text-[#2B31E0] mr-3'
            fill='none'
            stroke='currentColor'
            viewBox='0 0 24 24'
            xmlns='http://www.w3.org/2000/svg'
          >
            <path
              strokeLinecap='round'
              strokeLinejoin='round'
              strokeWidth={2}
              d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
            />
          </svg>
          <h3 className='text-xl font-semibold text-gray-800'>Error de Conexión</h3>
        </div>

        <p className='text-gray-600 mt-4'>{message}</p>

        <button
          onClick={onClose}
          className='mt-6 w-full bg-[#2B31E0] hover:bg-[#2B6AE0] text-white font-bold py-2 px-4 rounded transition-colors'
        >
          Entendido
        </button>
      </div>
    </div>
  );
};

export default ErrorMessage;
</file>

<file path="src/Components/ask_for_help/faq.service.ts">
// frontend/src/components/ask_for_help/faq.service.ts
import { FAQ, FAQResponse } from './faq.types';

// Leemos SOLO lo que ya existe en el .env
const RAW_API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';

// Normalizamos:
// - Si es "http://localhost:8000"      → "http://localhost:8000/api"
// - Si algún día fuera "http://localhost:8000/api" → se queda igual
const API_BASE_URL = (() => {
  const trimmed = RAW_API_URL.replace(/\/+$/, '');

  if (trimmed.endsWith('/api')) {
    return trimmed;
  }
  return `${trimmed}/api`;
})();

console.log('[FAQService] API_BASE_URL =', API_BASE_URL);

export class FAQService {
  private baseURL: string;

  constructor() {
    this.baseURL = API_BASE_URL;
  }

  async getAllFAQs(): Promise<FAQ[]> {
    const response = await fetch(`${this.baseURL}/faqs`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    });

    const data: FAQResponse = await response.json();

    if (!data.success || !data.data) {
      throw new Error(data.message || 'Error al obtener FAQs');
    }

    return data.data;
  }

  // Ejemplo de otros métodos, adapta a lo que ya tenías:
  async getFAQById(id: string): Promise<FAQ> {
    const response = await fetch(`${this.baseURL}/faqs/${id}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    });

    const data: FAQResponse = await response.json();

    if (!data.success || !data.data) {
      throw new Error(data.message || 'Error al obtener la FAQ');
    }

    // asumiendo que data.data es un FAQ cuando es por ID
    return data.data as unknown as FAQ;
  }

  async searchFAQs(query: string): Promise<FAQ[]> {
    const response = await fetch(`${this.baseURL}/faqs/search?q=${encodeURIComponent(query)}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    });

    const data: FAQResponse = await response.json();

    if (!data.success || !data.data) {
      throw new Error(data.message || 'Error al buscar FAQs');
    }

    return data.data;
  }
}

// si ya usabas una instancia:
export const faqService = new FAQService();
</file>

<file path="src/Components/ask_for_help/faq.types.ts">
// frontend/src/components/ask_for_help/faq.types.ts

export enum FAQCategoria {
  PROBLEMAS = 'problemas',
  SERVICIOS = 'servicios',
  PAGOS = 'pagos',
  GENERAL = 'general',
}

export interface FAQ {
  _id: string;
  pregunta: string;
  respuesta: string;
  categoria: FAQCategoria;
  palabrasClave: string[];
  orden: number;
  activo: boolean;
  createdAt?: string;
  updatedAt?: string;
}

export interface FAQResponse {
  success: boolean;
  data?: FAQ[];
  count?: number;
  message?: string;
  error?: string;
}

// ⬇️ ACTUALIZAR ESTA INTERFAZ
export interface UseFAQReturn {
  faqs: FAQ[];
  loading: boolean;
  error: string | null;
  selectedCategory: FAQCategoria | 'all'; // ⬅️ AGREGAR
  searchFAQs: (query: string) => Promise<void>;
  fetchFAQs: () => Promise<void>;
  filterByCategory: (category: FAQCategoria | 'all') => void; // ⬅️ AGREGAR
}
</file>

<file path="src/Components/ask_for_help/FAQCategoryFilter.tsx">
// frontend/src/components/ask_for_help/FAQCategoryFilter.tsx
'use client';

import React from 'react';
import { FAQCategoria } from './faq.types';
// Eliminada: import styles from '../styles/faq.module.css';

interface FAQCategoryFilterProps {
  selectedCategory: FAQCategoria | 'all';
  onCategoryChange: (category: FAQCategoria | 'all') => void;
}

const categories = [
  { value: 'all', label: 'Todas' },
  { value: FAQCategoria.PROBLEMAS, label: 'Problemas' },
  { value: FAQCategoria.SERVICIOS, label: 'Servicios' },
  { value: FAQCategoria.PAGOS, label: 'Pagos' },
  { value: FAQCategoria.GENERAL, label: 'General' },
];

export const FAQCategoryFilter: React.FC<FAQCategoryFilterProps> = ({
  selectedCategory,
  onCategoryChange,
}) => {
  return (
    <div className='flex flex-wrap gap-2 mb-8 border-b border-gray-200'>
      {categories.map((category) => {
        const isActive = selectedCategory === category.value;
        const buttonClasses = isActive
          ? 'border-primary text-primary font-bold'
          : 'border-transparent text-neutral-text hover:text-primary hover:border-primary font-semibold';

        return (
          <button
            key={category.value}
            onClick={() => onCategoryChange(category.value as FAQCategoria | 'all')}
            className={`
              px-4 py-2 text-base border-b-2
              flex items-center space-x-2 transition duration-150 ease-in-out
              ${buttonClasses}
            `}
            aria-pressed={isActive}
          >
            <span className='whitespace-nowrap'>{category.label}</span>
          </button>
        );
      })}
    </div>
  );
};
</file>

<file path="src/Components/ask_for_help/FAQItem.tsx">
// frontend/src/components/ask_for_help/FAQItem.tsx
'use client';

import React from 'react';
import { FAQ } from './faq.types';

interface FAQItemProps {
  faq: FAQ;
  isOpen: boolean;
  onToggle: () => void;
}

const getCategoryClasses = (categoria: string): { bg: string; text: string } => {
  const colors: Record<string, { bg: string; text: string }> = {
    problemas: { bg: 'bg-red-100', text: 'text-red-800' },
    servicios: { bg: 'bg-blue-100', text: 'text-blue-800' },
    pagos: { bg: 'bg-yellow-100', text: 'text-yellow-800' },
    general: { bg: 'bg-gray-100', text: 'text-gray-800' },
  };
  return colors[categoria] || { bg: 'bg-gray-100', text: 'text-gray-800' };
};

export const FAQItem: React.FC<FAQItemProps> = ({ faq, isOpen, onToggle }) => {
  const { bg, text } = getCategoryClasses(faq.categoria.toLowerCase());

  return (
    <div className='border border-gray-200 rounded-lg shadow-sm overflow-hidden'>
      <button
        className='w-full text-left p-4 flex justify-between items-center focus:outline-none bg-white hover:bg-gray-50 transition duration-150'
        onClick={onToggle}
        aria-expanded={isOpen}
        aria-controls={`faq-answer-${faq._id}`}
      >
        <div className='flex-1 pr-4'>
          <span
            className={`
              text-xs font-semibold px-2 py-0.5 rounded-full uppercase tracking-wider 
              ${bg} ${text} block w-fit mb-1
            `}
          >
            {faq.categoria}
          </span>
          <div className='text-base font-semibold text-gray-800'>{faq.pregunta}</div>
        </div>

        <span
          className={`
            text-xl font-bold text-gray-500 transition-transform duration-300
            ${isOpen ? 'rotate-180' : 'rotate-0'}
          `}
        >
          ▼
        </span>
      </button>

      {isOpen && (
        <div
          id={`faq-answer-${faq._id}`}
          className='p-4 pt-0 border-t border-gray-100 text-gray-600 transition-all duration-300'
          role='region'
        >
          <div className='pt-3'>{faq.respuesta}</div>
        </div>
      )}
    </div>
  );
};
</file>

<file path="src/Components/ask_for_help/FAQList.tsx">
// frontend/src/components/ask_for_help/FAQList.tsx
'use client';

import React, { useState, useMemo } from 'react';
import { FAQ } from './faq.types';
import { FAQItem } from './FAQItem';

interface FAQListProps {
  faqs: FAQ[];
  loading: boolean;
}

const FAQ_LIMIT = 5;

export const FAQList: React.FC<FAQListProps> = ({ faqs }) => {
  const [showAll, setShowAll] = useState(false);

  // 👉 Nuevo estado: cuál FAQ está abierta
  const [openFAQId, setOpenFAQId] = useState<string | null>(null);

  const faqsToShow = useMemo(() => {
    if (showAll || faqs.length <= FAQ_LIMIT) {
      return faqs;
    }
    return faqs.slice(0, FAQ_LIMIT);
  }, [faqs, showAll]);

  const hasMore = faqs.length > FAQ_LIMIT;
  const itemsShownCount = faqsToShow.length;

  if (faqs.length === 0) {
    return (
      <div className='text-center p-12 bg-gray-50 border border-gray-200 rounded-lg mt-8'>
        <h3 className='text-xl font-semibold text-gray-800 mb-2'>No se encontraron resultados</h3>
        <p className='text-gray-600'>
          Intenta con otras palabras clave o navega por todas las preguntas frecuentes.
        </p>
      </div>
    );
  }

  return (
    <div>
      {/* Lista de Preguntas Frecuentes */}
      <div className='space-y-4'>
        {faqsToShow.map((faq) => (
          <FAQItem
            key={faq._id}
            faq={faq}
            isOpen={openFAQId === faq._id}
            onToggle={() => setOpenFAQId((prev) => (prev === faq._id ? null : faq._id))}
          />
        ))}
      </div>

      {/* Botón Ver más / Ver menos */}
      {hasMore && (
        <div className='mt-6 text-center'>
          <button
            onClick={() => setShowAll(!showAll)}
            className='
              text-blue-600 
              hover:text-blue-700   
              font-semibold 
              py-2 px-4 
              rounded-lg 
              transition 
              duration-150 
              ease-in-out 
              border 
              border-blue-600
            '
          >
            {showAll
              ? `Ver menos (${itemsShownCount} resultados)`
              : `Ver más (${faqs.length - FAQ_LIMIT} preguntas más)`}
          </button>
        </div>
      )}
    </div>
  );
};
</file>

<file path="src/Components/ask_for_help/FAQSearch.tsx">
// frontend/src/components/ask_for_help/FAQSearch.tsx
'use client';

import React, { useState, useEffect, useCallback } from 'react';

interface FAQSearchProps {
  onSearch: (query: string) => void;
}

const MAX_LENGTH = 100;

export const FAQSearch: React.FC<FAQSearchProps> = ({ onSearch }) => {
  const [searchTermRaw, setSearchTermRaw] = useState('');
  const handleSearch = useCallback(onSearch, [onSearch]);
  const searchTermClean = searchTermRaw.trim();

  useEffect(() => {
    const debounceTimer = setTimeout(() => {
      handleSearch(searchTermClean);
    }, 300);
    return () => clearTimeout(debounceTimer);
  }, [searchTermClean, handleSearch]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    let value = e.target.value;
    if (value.length > MAX_LENGTH) value = value.substring(0, MAX_LENGTH);
    setSearchTermRaw(value);
  };

  // ✅ Función para borrar el texto
  const clearSearch = () => setSearchTermRaw('');

  return (
    <div className='relative w-full mb-8'>
      {/* 🔍 Icono de búsqueda */}
      <span className='absolute left-3 top-1/2 transform -translate-y-1/2 text-xl text-gray-400'>
        <svg
          xmlns='http://www.w3.org/2000/svg'
          viewBox='0 0 24 24'
          fill='currentColor'
          className='w-5 h-5'
        >
          <path
            fillRule='evenodd'
            d='M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.25 10.5a8.25 8.25 0 1114.59 5.28l4.69 4.69a.75.75 0 11-1.06 1.06l-4.69-4.69A8.25 8.25 0 012.25 10.5z'
            clipRule='evenodd'
          />
        </svg>
      </span>

      {/* Campo de texto */}
      <input
        type='text'
        placeholder='Buscar preguntas frecuentes...'
        value={searchTermRaw}
        onChange={handleChange}
        maxLength={MAX_LENGTH}
        className='w-full pl-12 pr-10 py-3 border-2 border-border rounded-xl bg-card focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all shadow-sm hover:shadow-md'
        aria-label={`Buscar preguntas frecuentes (máx. ${MAX_LENGTH} caracteres)`}
      />

      {/* ❌ Icono para borrar texto */}
      {searchTermRaw && (
        <button
          onClick={clearSearch}
          className='
            absolute 
            right-3 
            top-1/2 
            transform 
            -translate-y-1/2 
            text-gray-400 
            hover:text-gray-600 
            focus:outline-none
          '
          aria-label='Borrar búsqueda'
        >
          <svg
            xmlns='http://www.w3.org/2000/svg'
            viewBox='0 0 24 24'
            fill='currentColor'
            className='w-5 h-5'
          >
            <path
              fillRule='evenodd'
              d='M6.72 6.72a.75.75 0 011.06 0L12 10.94l4.22-4.22a.75.75 0 111.06 1.06L13.06 12l4.22 4.22a.75.75 0 11-1.06 1.06L12 13.06l-4.22 4.22a.75.75 0 11-1.06-1.06L10.94 12 6.72 7.78a.75.75 0 010-1.06z'
              clipRule='evenodd'
            />
          </svg>
        </button>
      )}
    </div>
  );
};
</file>

<file path="src/Components/ask_for_help/forum.service.ts">
import { ForumThread, ForumWithComments } from './forum.types';

// Usamos SOLO lo que ya tienes en el .env:
// NEXT_PUBLIC_API_URL=http://localhost:8000  (la última línea es la que manda)
// Igual que en otros archivos de tu proyecto, le agregamos /api acá.
const API_BASE_URL = `${process.env.NEXT_PUBLIC_API_URL}/api`;

// ---------- LISTAR FOROS ----------
export async function listForums(): Promise<ForumThread[]> {
  const url = `${API_BASE_URL}/forums`;
  console.log('[ForumService] GET', url);

  const res = await fetch(url, {
    method: 'GET',
    headers: { Accept: 'application/json' },
  });

  if (!res.ok) {
    const text = await res.text().catch(() => '');
    console.error('Error al cargar el foro:', res.status, text);
    throw new Error('Error al cargar el foro');
  }

  return res.json();
}

// ---------- CREAR FORO (1 solo argumento, como en page.tsx) ----------
export async function createForum(input: {
  titulo: string;
  descripcion: string;
  categoria: 'problemas' | 'servicios' | 'consejos' | 'general';
}): Promise<ForumThread> {
  // El token de acceso se guarda como "servineo_token" en localStorage
  const token = typeof window !== 'undefined' ? localStorage.getItem('servineo_token') : null;

  if (!token) {
    console.error('[ForumService] No se encontró servineo_token en localStorage');
    throw new Error('Debes iniciar sesión para crear una publicación');
  }

  const url = `${API_BASE_URL}/forums`;
  console.log('[ForumService] POST', url, input);

  const res = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`, // 👈 el backend espera esto
    },
    // IMPORTANTE: sin credentials: "include" para evitar el error CORS con "*"
    body: JSON.stringify(input),
  });

  const text = await res.text().catch(() => '');

  if (res.status === 401) {
    console.error('Error 401 al crear foro:', text);
    throw new Error('Debes iniciar sesión para crear una publicación');
  }

  if (res.status === 409) {
    console.error('Error 409 al crear foro:', text);
    throw new Error('No se puede crear la publicación (conflicto)');
  }

  if (!res.ok) {
    console.error('Error al crear el foro:', res.status, text);
    throw new Error('Error al crear la publicación');
  }

  try {
    return JSON.parse(text);
  } catch {
    return res.json();
  }
}

// ---------- OBTENER FORO CON COMENTARIOS ----------
export async function getForumWithComments(forumId: string): Promise<ForumWithComments> {
  const url = `${API_BASE_URL}/forums/${forumId}`;
  console.log('[ForumService] GET', url);

  const res = await fetch(url, {
    method: 'GET',
    headers: { Accept: 'application/json' },
  });

  if (!res.ok) {
    const text = await res.text().catch(() => '');
    console.error('Error al cargar la publicación:', res.status, text);
    throw new Error('Error al cargar la publicación');
  }

  return res.json();
}

// ---------- AGREGAR COMENTARIO ----------
export async function addCommentToForum(forumId: string, contenido: string) {
  const token = typeof window !== 'undefined' ? localStorage.getItem('servineo_token') : null;

  if (!token) {
    console.error('[ForumService] No se encontró servineo_token al comentar');
    throw new Error('Debes iniciar sesión para comentar');
  }

  const url = `${API_BASE_URL}/forums/${forumId}/comments`;
  console.log('[ForumService] POST comment', url, { contenido });

  const res = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`,
    },
    body: JSON.stringify({ contenido }),
  });

  const text = await res.text().catch(() => '');

  if (res.status === 401) {
    console.error('Error 401 al comentar:', text);
    throw new Error('Debes iniciar sesión para comentar');
  }

  if (res.status === 409) {
    console.error('Error 409 al comentar:', text);
    throw new Error('Este hilo está bloqueado para nuevos comentarios');
  }

  if (!res.ok) {
    console.error('Error al agregar el comentario:', res.status, text);
    throw new Error('Error al agregar el comentario');
  }

  try {
    return JSON.parse(text);
  } catch {
    return res.json();
  }
}
</file>

<file path="src/Components/ask_for_help/forum.types.ts">
export type AuthorRole = 'requester' | 'fixer' | 'visitor' | 'admin';
export type ForumCategoria = 'problemas' | 'servicios' | 'consejos' | 'general';

export interface ForumThread {
  _id: string;
  authorId: string;
  authorName: string;
  authorRole: AuthorRole;
  titulo: string;
  descripcion: string;
  categoria: ForumCategoria;
  commentsCount: number;
  isLocked: boolean;
  createdAt: string;
  updatedAt: string;
  lastActivityAt: string;
}

export interface ForumComment {
  _id: string;
  forumId: string;
  authorId: string;
  authorName: string;
  authorRole: AuthorRole;
  contenido: string;
  createdAt: string;
  updatedAt: string;
}

export interface ForumWithComments {
  forum: ForumThread;
  comments: ForumComment[];
}

export interface CreateForumPayload {
  titulo: string;
  descripcion: string;
  categoria: ForumCategoria;
}
</file>

<file path="src/Components/ask_for_help/FORUMCategoryFilter.tsx">
// frontend/src/Components/ask_for_help/FORUMCategoryFilter.tsx
'use client';

import React from 'react';
import type { ForumCategoria } from './forum.types';

export type ForumCategoryFilterValue = ForumCategoria | 'todas';

interface FORUMCategoryFilterProps {
  selectedCategory: ForumCategoryFilterValue;
  onCategoryChange: (value: ForumCategoryFilterValue) => void;
}

const categories: { value: ForumCategoryFilterValue; label: string }[] = [
  { value: 'todas', label: 'Todas' },
  { value: 'problemas', label: 'Problemas' },
  { value: 'servicios', label: 'Servicios' },
  { value: 'consejos', label: 'Consejos' },
  { value: 'general', label: 'General' },
];

export const FORUMCategoryFilter: React.FC<FORUMCategoryFilterProps> = ({
  selectedCategory,
  onCategoryChange,
}) => {
  return (
    <div className='flex flex-wrap gap-2 mb-4 border-b border-gray-200'>
      {categories.map((category) => {
        const isActive = selectedCategory === category.value;
        const buttonClasses = isActive
          ? 'border-primary text-primary font-bold'
          : 'border-transparent text-neutral-text hover:text-primary hover:border-primary font-semibold';

        return (
          <button
            key={category.value}
            onClick={() => onCategoryChange(category.value)}
            className={`
              px-4 py-2 text-base border-b-2
              flex items-center space-x-2 transition duration-150 ease-in-out
              ${buttonClasses}
            `}
            aria-pressed={isActive}
          >
            <span className='whitespace-nowrap'>{category.label}</span>
          </button>
        );
      })}
    </div>
  );
};
</file>

<file path="src/Components/ask_for_help/FORUMCommentForm.tsx">
// src/Components/ask_for_help/FORUMCommentForm.tsx
'use client';

import React from 'react';

interface FORUMCommentFormProps {
  value: string;
  posting: boolean;
  error: string | null;
  onChange: (v: string) => void;
  onSubmit: (e: React.FormEvent) => void;
}

export const FORUMCommentForm: React.FC<FORUMCommentFormProps> = ({
  value,
  posting,
  error,
  onChange,
  onSubmit,
}) => {
  return (
    <form onSubmit={onSubmit} className='space-y-2'>
      <textarea
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder='Escriba el mensaje...'
        className='w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500'
        rows={3}
      />
      {error && <p className='text-sm text-red-600'>{error}</p>}
      <button
        type='submit'
        disabled={posting || !value.trim()}
        className='px-4 py-2 rounded-md bg-blue-600 text-white text-sm hover:bg-blue-700 disabled:opacity-60'
      >
        {posting ? 'Enviando...' : 'Enviar'}
      </button>
    </form>
  );
};
</file>

<file path="src/Components/ask_for_help/FORUMCommetsList.tsx">
// src/Components/ask_for_help/FORUMCommentsList.tsx
'use client';

import React from 'react';
import type { ForumComment } from './forum.types';

interface FORUMCommentsListProps {
  comments: ForumComment[];
}

export const FORUMCommentsList: React.FC<FORUMCommentsListProps> = ({ comments }) => {
  return (
    <div className='space-y-3 mb-4'>
      {comments.map((c) => (
        <div key={c._id} className='border border-gray-200 rounded-lg p-3 text-sm'>
          <p className='font-semibold text-gray-800'>
            {c.authorName}
            <span className='ml-2 text-xs text-gray-500'>
              {c.authorRole === 'fixer' && '(Fixer)'}
              {c.authorRole === 'requester' && '(Solicitante)'}
              {c.authorRole === 'admin' && '(Admin)'}
              {c.authorRole === 'visitor' && '(Visitante)'}
            </span>
          </p>
          <p className='text-gray-700 mt-1'>{c.contenido}</p>
          <p className='text-xs text-gray-400 mt-1'>{new Date(c.createdAt).toLocaleString()}</p>
        </div>
      ))}

      {comments.length === 0 && (
        <p className='text-sm text-gray-500'>
          Aún no hay comentarios. ¡Sé el primero en responder!
        </p>
      )}
    </div>
  );
};
</file>

<file path="src/Components/ask_for_help/FORUMCreateForm.tsx">
// frontend/src/Components/ask_for_help/FORUMCreateForm.tsx
'use client';

import React from 'react';
import type { ForumCategoria } from './forum.types';

interface FORUMCreateFormProps {
  show: boolean;
  titulo: string;
  descripcion: string;
  categoria: ForumCategoria | '';
  creating: boolean;
  error: string | null;
  onChangeTitulo: (v: string) => void;
  onChangeDescripcion: (v: string) => void;
  onChangeCategoria: (v: ForumCategoria | '') => void;
  onSubmit: (e: React.FormEvent) => void;
}

export const FORUMCreateForm: React.FC<FORUMCreateFormProps> = ({
  show,
  titulo,
  descripcion,
  categoria,
  creating,
  error,
  onChangeTitulo,
  onChangeDescripcion,
  onChangeCategoria,
  onSubmit,
}) => {
  if (!show) return null;

  return (
    <section className='mb-6 border border-gray-200 rounded-lg p-4'>
      <h2 className='font-semibold mb-3'>Crear nueva publicación</h2>
      <form onSubmit={onSubmit} className='space-y-3'>
        <div>
          <label className='block text-sm font-medium mb-1'>Título</label>
          <input
            type='text'
            value={titulo}
            onChange={(e) => onChangeTitulo(e.target.value)}
            className='w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500'
            maxLength={150}
          />
        </div>

        <div>
          <label className='block text-sm font-medium mb-1'>Descripción del problema</label>
          <textarea
            value={descripcion}
            onChange={(e) => onChangeDescripcion(e.target.value)}
            className='w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500'
            rows={4}
          />
        </div>

        <div>
          <label className='block text-sm font-medium mb-1'>Categoría</label>
          <select
            value={categoria}
            onChange={(e) =>
              onChangeCategoria(e.target.value ? (e.target.value as ForumCategoria) : '')
            }
            className='w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500'
          >
            <option value=''>Selecciona una categoría</option>
            <option value='problemas'>Problemas</option>
            <option value='servicios'>Servicios</option>
            <option value='consejos'>Consejos</option>
            <option value='general'>General</option>
          </select>
        </div>

        {error && <p className='text-sm text-red-600'>{error}</p>}

        <button
          type='submit'
          disabled={creating}
          className='px-4 py-2 rounded-md bg-blue-600 text-white text-sm hover:bg-blue-700 disabled:opacity-60'
        >
          {creating ? 'Publicando...' : 'Publicar foro'}
        </button>
      </form>
    </section>
  );
};
</file>

<file path="src/Components/ask_for_help/FORUMSearch.tsx">
// frontend/src/Components/ask_for_help/FORUMSearch.tsx
'use client';

import React from 'react';
import { Search } from 'lucide-react';

interface FORUMSearchProps {
  query: string;
  onChange: (value: string) => void;
}

export const FORUMSearch: React.FC<FORUMSearchProps> = ({ query, onChange }) => {
  return (
    <div className='relative flex-1'>
      <span className='absolute left-3 top-1/2 -translate-y-1/2 text-gray-400'>
        <Search className='h-5 w-5' />
      </span>
      <input
        type='text'
        placeholder='Buscar por título o descripción...'
        value={query}
        onChange={(e) => onChange(e.target.value)}
        className='w-full pl-12 pr-10 py-3 border-2 border-border rounded-xl bg-card focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all shadow-sm hover:shadow-md'
      />
    </div>
  );
};
</file>

<file path="src/Components/ask_for_help/FORUMThreadDetail.tsx">
// src/Components/ask_for_help/FORUMThreadDetail.tsx
'use client';

import React from 'react';
import type { ForumThread } from './forum.types';

interface FORUMThreadDetailProps {
  forum: ForumThread;
  onBack: () => void;
}

export const FORUMThreadDetail: React.FC<FORUMThreadDetailProps> = ({ forum, onBack }) => {
  return (
    <div className='bg-white rounded-xl shadow-lg p-6 mb-6'>
      <button onClick={onBack} className='text-sm text-gray-600 mb-4 hover:underline'>
        ← Volver al foro
      </button>

      <h1 className='text-2xl font-bold mb-2'>{forum.titulo}</h1>

      {/* Chip de categoría */}
      <p className='mb-2'>
        <span className='inline-flex items-center rounded-full bg-blue-50 px-2.5 py-0.5 text-xs font-medium text-blue-700'>
          {forum.categoria === 'problemas' && 'Problemas'}
          {forum.categoria === 'servicios' && 'Servicios'}
          {forum.categoria === 'consejos' && 'Consejos'}
          {forum.categoria === 'general' && 'General'}
        </span>
      </p>

      <p className='text-sm text-gray-500 mb-4'>
        Por {forum.authorName} • {new Date(forum.createdAt).toLocaleString()}
      </p>

      <div className='border border-gray-200 rounded-lg p-4 text-gray-800'>{forum.descripcion}</div>
    </div>
  );
};
</file>

<file path="src/Components/ask_for_help/FORUMThreadList.tsx">
// frontend/src/Components/ask_for_help/FORUMThreadList.tsx
'use client';

import React from 'react';
import type { ForumThread } from './forum.types';

interface FORUMThreadListProps {
  threads: ForumThread[];
  loading: boolean;
  error: string | null;
  onOpenThread: (id: string) => void;
}

export const FORUMThreadList: React.FC<FORUMThreadListProps> = ({
  threads,
  loading,
  error,
  onOpenThread,
}) => {
  if (loading) {
    return <p className='text-center text-gray-600'>Cargando publicaciones...</p>;
  }

  if (error) {
    return <p className='text-center text-red-600'>{error}</p>;
  }

  if (threads.length === 0) {
    return (
      <section className='border border-gray-200 rounded-lg p-8 text-center text-gray-600'>
        <p className='font-medium mb-2'>No se encontraron publicaciones.</p>
        <p className='text-sm'>
          Cuando los usuarios comiencen a crear publicaciones, aparecerán aquí.
        </p>
      </section>
    );
  }

  return (
    <section className='space-y-4'>
      {threads.map((thread) => (
        <button
          key={thread._id}
          type='button'
          onClick={() => onOpenThread(thread._id)}
          className='w-full text-left border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition'
        >
          <div className='flex justify-between items-start'>
            <div>
              <h2 className='font-semibold text-gray-900'>{thread.titulo}</h2>

              {/* chip de categoría */}
              <div className='mt-1 mb-1'>
                <span className='inline-flex items-center rounded-full bg-blue-50 px-2.5 py-0.5 text-xs font-medium text-blue-700'>
                  {thread.categoria === 'problemas' && 'Problemas'}
                  {thread.categoria === 'servicios' && 'Servicios'}
                  {thread.categoria === 'consejos' && 'Consejos'}
                  {thread.categoria === 'general' && 'General'}
                </span>
              </div>

              <p className='text-sm text-gray-600 mt-1 line-clamp-2'>{thread.descripcion}</p>
              <p className='mt-2 text-xs text-gray-400'>
                Por {thread.authorName} • {new Date(thread.createdAt).toLocaleDateString()}
              </p>
            </div>
            <span className='text-sm text-gray-500 whitespace-nowrap'>
              {thread.commentsCount} comentarios
            </span>
          </div>
        </button>
      ))}
    </section>
  );
};
</file>

<file path="src/Components/ask_for_help/useFAQ.ts">
// frontend/src/componentes/ask_for_help/useFAQ.ts
import { useState, useEffect, useCallback } from 'react';
import { FAQ, FAQCategoria, UseFAQReturn } from './faq.types';
import { FAQService } from './faq.service';

// Crear una ÚNICA instancia del servicio
const faqServiceInstance = new FAQService();

export const useFAQ = (): UseFAQReturn => {
  const [faqs, setFaqs] = useState<FAQ[]>([]);
  const [allFaqs, setAllFaqs] = useState<FAQ[]>([]);
  const [loading, setLoading] = useState<boolean>(false);
  const [error, setError] = useState<string | null>(null);
  const [selectedCategory, setSelectedCategory] = useState<FAQCategoria | 'all'>('all');

  const faqService = faqServiceInstance;

  const fetchFAQs = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      const data = await faqService.getAllFAQs();
      setAllFaqs(data);
      setFaqs(data);
    } catch (err) {
      const errorMessage =
        err instanceof Error ? err.message : 'Error al cargar las preguntas frecuentes';
      setError(errorMessage);
      console.error('Error:', err);
    } finally {
      setLoading(false);
    }
  }, [faqService]); // <-- ¡Solución de la advertencia!

  // 2. Corregido: Añadido 'faqService', 'allFaqs' y 'selectedCategory' como dependencias
  const searchFAQs = useCallback(
    async (query: string) => {
      if (!query || query.trim().length === 0) {
        if (selectedCategory === 'all') {
          setFaqs(allFaqs);
        } else {
          setFaqs(allFaqs.filter((faq) => faq.categoria === selectedCategory));
        }
        return;
      }

      setLoading(true);
      setError(null);

      try {
        const data = await faqService.searchFAQs(query);

        if (selectedCategory === 'all') {
          setFaqs(data);
        } else {
          setFaqs(data.filter((faq) => faq.categoria === selectedCategory));
        }
      } catch (err) {
        const errorMessage = err instanceof Error ? err.message : 'Error en la búsqueda';
        setError(errorMessage);
        console.error('Error:', err);
      } finally {
        setLoading(false);
      }
    },
    [allFaqs, selectedCategory, faqService],
  ); // <-- ¡Solución de la advertencia!

  const filterByCategory = useCallback(
    (category: FAQCategoria | 'all') => {
      setSelectedCategory(category);

      if (category === 'all') {
        setFaqs(allFaqs);
      } else {
        setFaqs(allFaqs.filter((faq) => faq.categoria === category));
      }
    },
    [allFaqs],
  );

  useEffect(() => {
    fetchFAQs();
  }, [fetchFAQs]);

  return {
    faqs,
    loading,
    error,
    selectedCategory,
    searchFAQs,
    fetchFAQs,
    filterByCategory,
  };
};
</file>

<file path="src/Components/atoms/button.tsx">
import React from 'react';

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary';
  loading?: boolean;
}

export const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ variant = 'primary', loading, children, className = '', disabled, ...props }, ref) => {
    const baseStyles = 'px-4 py-2 rounded text-sm transition-colors';
    const variants = {
      primary: 'bg-[#2B6AE0] text-white disabled:opacity-60 disabled:cursor-not-allowed',
      secondary: 'bg-gray-300 text-gray-700 hover:bg-gray-400',
    };

    return (
      <button
        ref={ref}
        className={`${baseStyles} ${variants[variant]} ${className}`}
        disabled={disabled || loading}
        {...props}
      >
        {loading ? 'Actualizando...' : children}
      </button>
    );
  },
);

Button.displayName = 'Button';
</file>

<file path="src/Components/atoms/displayfield.tsx">
// atoms/inputs/DisplayField.tsx
interface DisplayFieldProps {
  label: string;
  value: string;
  placeholder?: string;
  className?: string;
}

export const DisplayField = ({
  label,
  value,
  placeholder = 'No especificado',
  className = '',
}: DisplayFieldProps) => {
  return (
    <div className={`block ${className}`}>
      <span className='text-sm font-medium text-gray-700'>{label}</span>
      <div className='mt-1 p-2 bg-gray-50 border border-gray-300 rounded text-gray-900 min-h-[42px] flex items-center'>
        {value || <span className='text-gray-500 italic'>{placeholder}</span>}
      </div>
    </div>
  );
};
</file>

<file path="src/Components/atoms/inputs.tsx">
import React from 'react';

interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  error?: string;
  label?: string;
}

export const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ error, label, className = '', ...props }, ref) => {
    return (
      <label className='block'>
        {label && <span className='text-sm font-medium'>{label}</span>}
        <input
          ref={ref}
          className={`mt-1 block w-full border rounded px-3 py-2 bg-white ${className} ${
            error ? 'border-red-500' : ''
          }`}
          {...props}
        />
        {error && <p className='text-red-600 text-sm mt-1'>{error}</p>}
      </label>
    );
  },
);

Input.displayName = 'Input';
</file>

<file path="src/Components/atoms/select.tsx">
import React from 'react';

interface SelectProps extends React.SelectHTMLAttributes<HTMLSelectElement> {
  error?: string;
  label?: string;
  options: { value: string; label: string }[];
}

export const Select = React.forwardRef<HTMLSelectElement, SelectProps>(
  ({ error, label, options, className = '', ...props }, ref) => {
    return (
      <label className='block'>
        {label && <span className='text-sm font-medium'>{label}</span>}
        <select
          ref={ref}
          className={`mt-1 block w-full border rounded px-3 py-2 text-sm ${className} ${
            error ? 'border-red-500' : ''
          }`}
          {...props}
        >
          {options.map((option) => (
            <option key={option.value} value={option.value}>
              {option.label}
            </option>
          ))}
        </select>
        {error && <p className='text-red-600 text-sm mt-1'>{error}</p>}
      </label>
    );
  },
);

Select.displayName = 'Select';
</file>

<file path="src/Components/atoms/textArea.tsx">
import React from 'react';

interface TextAreaProps extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {
  error?: string;
  label?: string;
  readOnly?: boolean;
}

export const TextArea = React.forwardRef<HTMLTextAreaElement, TextAreaProps>(
  ({ error, label, className = '', readOnly, ...props }, ref) => {
    return (
      <label className='block'>
        {label && <span className='text-sm font-medium'>{label}</span>}
        <textarea
          ref={ref}
          className={`mt-1 block w-full border rounded px-3 py-2 bg-white ${className} ${
            error ? 'border-red-500' : ''
          }${readOnly ? 'bg-gray-100 text-gray-600 cursor-not-allowed' : ''}`}
          readOnly={readOnly}
          {...props}
        />
        {error && <p className='text-red-600 text-sm mt-1'>{error}</p>}
      </label>
    );
  },
);

TextArea.displayName = 'TextArea';
</file>

<file path="src/Components/calendar/day/DesktopDailyHours.tsx">
'use client';
import React from 'react';

import HourCell from './HourCell/HourCell';

interface DesktopDailyViewProps {
  date: Date;
  view: 'week' | 'day';
}

const today = new Date();
const currentHour = today.getHours();

export default function DesktopDailyHours({ date, view }: DesktopDailyViewProps) {
  const isPast = (hour: number) => {
    const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const todayOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());

    if (dateOnly < todayOnly) {
      return true;
    }

    if (dateOnly.getTime() === todayOnly.getTime()) {
      return hour < currentHour;
    }

    return false;
  };
  const isToday =
    date.getFullYear() === today.getFullYear() &&
    date.getMonth() === today.getMonth() &&
    date.getDate() === today.getDate();

  const hours = Array.from({ length: 24 }, (_, i) => i);

  return (
    <div className='flex-1 flex flex-col'>
      {hours.map((hour) => (
        <HourCell
          key={hour}
          date={date}
          hour={hour}
          isPast={isPast(hour)}
          isToday={isToday}
          view={view}
        />
      ))}
    </div>
  );
}
</file>

<file path="src/Components/calendar/day/DesktopDailyView.tsx">
'use client';
import React from 'react';
import DesktopDailyHours from './DesktopDailyHours';
import Hours from '../ui/Hours';

interface DesktopDailyViewProps {
  date: Date;
}
function getDayName(dayNumber: number): string {
  const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
  return days[dayNumber];
}
export default function DesktopDailyView({ date }: DesktopDailyViewProps) {
  return (
    <div className='flex'>
      <div>
        <div className='text-white'>
          <p>--</p>
        </div>
        <Hours />
      </div>

      <div className='w-full'>
        <div className=' flex items-center justify-center border-r border-b bg-gray-300 text-black'>
          {getDayName(date.getDay())}{' '}
        </div>
        <DesktopDailyHours date={date} view={'day'} />
      </div>
    </div>
  );
}
</file>

<file path="src/Components/calendar/day/HourCell/HourCell.tsx">
'use client';

import { useRef } from 'react';
import EditAppointmentForm, {
  EditAppointmentFormHandle,
  ExistingAppointment,
} from '@/Components/appointments/forms/EditAppointmentForm';
import { useUserRole } from '@/app/lib/utils/contexts/UserRoleContext';
import type { AppointmentFormHandle } from '@/Components/appointments/forms/AppointmentForm';
import AppointmentForm from '@/Components/appointments/forms/AppointmentForm';
import AppointmentDetailsForm, {
  EditAppointmentFormHandle as DetailsFormHandle,
} from '@/Components/appointments/forms/AppointmentDetails';
import { useAppointmentsContext } from '@/app/lib/utils/contexts/AppointmentsContext/AppoinmentsContext';
const API_BASE = 'https://servineo-backend-lorem.onrender.com';

interface HourCellProps {
  date: Date;
  hour: number;
  isPast: boolean;
  isToday: boolean;
  view: 'day' | 'week';
}

/*type Estados =
    'disponible' | 'reservado' | 'inhabilitado'
    | 'ocupado' | 'reservadoOtro' | 'cancelFixer' | 'cancelRequester'
    | 'cancelOtherFixer' | 'cancelOtherRequester';*/
const today = new Date();

export default function HourCell({ hour, date, isPast, isToday, view }: HourCellProps) {
  const refFormularioCita = useRef<AppointmentFormHandle | null>(null);
  const formRef = useRef<DetailsFormHandle>(null);
  const refFormularioEditarCita = useRef<EditAppointmentFormHandle | null>(null);

  const { isHourBookedFixer, isHourBooked, isEnabled, isCanceled } = useAppointmentsContext();

  const { isFixer, isRequester, requester_id, fixer_id } = useUserRole();

  const isBookedFixer = isHourBookedFixer(date, hour);
  const isBooked = isHourBooked(date, hour, requester_id);
  const isEnable = isEnabled(date, hour);
  const isCancel = isCanceled(date, hour, requester_id);

  const todayColor = () => {
    if (isToday && view === 'week') return 'bg-blue-300';
    if (isToday && view === 'day' && today.getHours() === hour) return 'bg-blue-300';
    else return 'bg-white';
  };

  const getEstado = () => {
    if (isBooked === 'self') return 'reservado';
    if (isBooked === 'other') return 'reservadoOtro';
    if (isBookedFixer) return 'ocupado';
    if (!isEnable) return 'inhabilitado';

    if (isCancel === 'fixer') {
      return 'cancelFixer';
    } else if (isCancel === 'requester') {
      return 'cancelRequester';
    } else if (isCancel === 'otherFixer') {
      return 'cancelOtherFixer';
    } else if (isCancel === 'otherRequester') return 'cancelOtherRequester';

    return 'disponible';
  };

  const estado = getEstado();
  const getColor = () => {
    if (estado === 'reservado' || estado === 'ocupado' || estado === 'reservadoOtro')
      return 'bg-[#FFC857]';
    if (
      estado === 'cancelFixer' ||
      estado === 'cancelOtherRequester' ||
      estado === 'cancelRequester'
    )
      return 'bg-[#FF3E17] text-sm ';
    if (estado === 'inhabilitado') return 'bg-[#64748B]';
    if (isFixer) {
      if (estado === 'cancelOtherFixer') return 'bg-[#FF3E17]';
    } else {
      if (estado === 'disponible') return 'bg-[#16A34A]';
      if (estado === 'cancelOtherFixer') return 'bg-[#64748B]';
    }
  };

  const getText = () => {
    if (isFixer) {
      if (estado === 'disponible') return 'Disponible';
      if (estado === 'cancelOtherFixer' || estado === 'cancelFixer') return 'Cancelado';

      if (estado === 'cancelOtherRequester' || estado === 'cancelRequester')
        return 'Cancelado (Requester)';

      if (estado === 'reservado' || estado === 'ocupado' || estado === 'reservadoOtro')
        return 'Reservado';

      if (estado === 'inhabilitado') return 'Inhabilitado';
    } else {
      if (estado === 'disponible' || estado === 'cancelOtherRequester') return 'Disponible';
      if (estado === 'cancelFixer') return 'Cancelado (Fixer)';
      if (estado === 'cancelRequester') return 'Cancelado';

      if (estado === 'reservado') return 'Reservado';

      if (estado === 'ocupado' || estado === 'reservadoOtro') return 'Ocupado';
      if (estado === 'inhabilitado') return 'Inhabilitado';

      if (estado === 'cancelOtherFixer') return 'No Disponible';
    }
    return '';
  };

  const createISOWithOffset = (date: Date, hour: number) => {
    const fechaActual = new Date(date);
    const anio = fechaActual.getUTCFullYear();
    const mes = fechaActual.getUTCMonth();
    const dia = fechaActual.getUTCDate();
    const fechaFinal = new Date(Date.UTC(anio, mes, dia, hour + 4, 0, 0));
    return fechaFinal.toISOString();
  };

  const handleOpenForm = () => {
    if (formRef.current) {
      const now = new Date(date);
      now.setHours(hour, 0, 0, 0);
      formRef.current.open(now);
    }
  };

  // Función para cargar y editar cita (copiada de HorarioDelDia)
  async function cargarYEditarCita() {
    try {
      const ymd = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      const isoParaEditar = new Date(
        Date.UTC(date.getFullYear(), date.getMonth(), date.getDate(), hour + 4, 0, 0),
      ).toISOString();

      const url =
        `${API_BASE}/api/crud_read/appointments/get_modal_form` +
        `?fixer_id=${encodeURIComponent(fixer_id)}` +
        `&requester_id=${encodeURIComponent(requester_id)}` +
        `&appointment_date=${encodeURIComponent(ymd)}` +
        `&start_hour=${encodeURIComponent(String(hour))}`;

      const res = await fetch(url, { headers: { Accept: 'application/json' } });
      if (!res.ok) {
        const body = await res.text().catch(() => '<sin cuerpo>');
        alert(`Error ${res.status} al consultar la cita.\n${body}`);
        return;
      }
      const data = await res.json();

      const modality = data?.data?.appointment_type === 'presential' ? 'presencial' : 'virtual';

      const existingAppointment: ExistingAppointment = {
        id: data?.data?._id || data?.data?.id || `${ymd}-${hour}`,
        datetime: isoParaEditar,
        client: data?.data?.current_requester_name || '',
        contact: data?.data?.current_requester_phone || '',
        modality,
        description: data?.data?.appointment_description || '',
        meetingLink: data?.data?.link_id || '',
        lat:
          data?.data?.latitude !== undefined && data?.data?.latitude !== null
            ? Number(data.data.latitude)
            : undefined,
        lon:
          data?.data?.longitude !== undefined && data?.data?.longitude !== null
            ? Number(data.data.longitude)
            : undefined,
        address: data?.data?.display_name_location || '',
        place: '',
        fixerId: fixer_id,
        requesterId: requester_id,
      };

      refFormularioEditarCita.current?.open(existingAppointment);
    } catch (err) {
      alert('Error al cargar los datos de la cita para editar. Revisa consola.');
      console.error(err);
    }
  }

  const handleClick = () => {
    if (isRequester) {
      if (estado === 'disponible' || estado === 'cancelOtherRequester') {
        const localISOString = createISOWithOffset(date, hour);
        refFormularioCita.current?.open(localISOString);
      } else if (estado === 'reservado') {
        cargarYEditarCita();
      }
    } else {
      if (estado === 'ocupado' || estado == 'reservado' || estado === 'reservadoOtro') {
        handleOpenForm();
      }
    }
  };

  const showHourCell = () => {
    if (isPast) return false;
    if (isFixer) {
      if (estado === 'disponible') return false;
    }
    return true;
  };

  return (
    <div className={`flex items-center ${todayColor()} h-15 border-b border-r border-black`}>
      <div className='w-full'>
        {showHourCell() && (
          <div
            className={`mx-2  rounded-md text-center text-white ${getColor()} py-3 cursor-pointer`}
            onClick={handleClick}
          >
            <p>{getText()}</p>
          </div>
        )}
      </div>

      <AppointmentForm ref={refFormularioCita} fixerId={fixer_id} requesterId={requester_id} />

      <EditAppointmentForm ref={refFormularioEditarCita} />

      <AppointmentDetailsForm ref={formRef} />
    </div>
  );
}
</file>

<file path="src/Components/calendar/DesktopCalendar.tsx">
'use client';
import { useState, useMemo } from 'react';
import DesktopMonthView from './month/DesktopMonthView/DesktopMonthView';
import HeaderDesktop from './Header/HeaderDesktop';
import useCalendarView from '@/hooks/useCalendarView';
import DesktopDailyView from './day/DesktopDailyView';
import DesktopWeekView from './week/DesktopWeekView';

export default function DesktopCalendar() {
  const date = useMemo(() => {
    const d = new Date();
    d.setHours(0, 0, 0, 0);
    return d;
  }, []);
  const [month, setMonth] = useState(date.getMonth());
  const [year, setYear] = useState(date.getFullYear());
  const [day, setDay] = useState(date.getDate());
  const { view, handleMonthView, handleWeekView, handleDayView } = useCalendarView();

  const selectedDate = useMemo(() => {
    return new Date(year, month, day);
  }, [year, month, day]);

  //    console.log(`Esta es la fecha actual ${selectedDate}`);
  return (
    <div className='w-full flex flex-col items-center bg-white'>
      <div className='w-full max-w-5xl'>
        <div className='bg-blue-500 w-full p-1 flex items-center'>
          <HeaderDesktop
            year={year}
            month={month}
            day={day}
            onChangeMonth={setMonth}
            onChangeYear={setYear}
            onChangeDate={setDay}
            view={view}
            onViewChange={{ handleMonthView, handleWeekView, handleDayView }}
          />
        </div>

        <div className=' w-full  justify-center'>
          {view === 'month' && <DesktopMonthView year={year} month={month} />}

          {view === 'week' && <DesktopWeekView date={selectedDate} />}

          {view === 'day' && <DesktopDailyView date={selectedDate} />}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/calendar/Header/HeaderDesktop.tsx">
'use client';

import React from 'react';
import useCalendarNavigation from '@/hooks/useCalendarNavigation';
import HeaderSection from './HeaderSection';

interface HeaderDesktopProps {
  year: number;
  month: number;
  day: number;
  onChangeMonth: (newMonth: number) => void;
  onChangeYear: (newYear: number) => void;
  onChangeDate: (newDate: number) => void;
  view: 'month' | 'week' | 'day';
  onViewChange: {
    handleMonthView: () => void;
    handleWeekView: () => void;
    handleDayView: () => void;
  };
}

const monthNames = [
  'Enero',
  'Febrero',
  'Marzo',
  'Abril',
  'Mayo',
  'Junio',
  'Julio',
  'Agosto',
  'Septiembre',
  'Octubre',
  'Noviembre',
  'Diciembre',
];
export default function HeaderDesktop({
  year: initialYear,
  month: initialMonth,
  day: initialDay,
  onChangeMonth,
  onChangeYear,
  onChangeDate,
  view,
  onViewChange,
}: HeaderDesktopProps) {
  const {
    year,
    month,
    date,
    handlePrev,
    handleNext,
    handleToday,
    isPrevDisabled,
    isNextDisabled,
    getWeekRange,
  } = useCalendarNavigation({
    initialYear,
    initialMonth,
    initialDate: initialDay,
    view,
    onChangeMonth,
    onChangeYear,
    onChangeDate,
  });

  const { start, end } = getWeekRange();

  return (
    <div className='text-black flex  justify-between items-center my-1 px-2 w-full'>
      <HeaderSection
        buttons={[
          { label: 'Anterior', onClick: handlePrev, disabled: isPrevDisabled },
          { label: 'Hoy', onClick: handleToday, disabled: isPrevDisabled },
          { label: 'Siguiente', onClick: handleNext, disabled: isNextDisabled },
        ]}
      />

      {view === 'month' && (
        <span className='text-lg font-semibold'>
          {monthNames[month]} {year}{' '}
        </span>
      )}
      {view === 'week' && (
        <span className='text-lg font-semibold'>
          {monthNames[month]} {start.getDate()} - {end.getDate()}
        </span>
      )}
      {view === 'day' && (
        <span className='text-lg font-semibold'>
          {monthNames[month]} {date}{' '}
        </span>
      )}

      <HeaderSection
        buttons={[
          { label: 'Mes', onClick: onViewChange.handleMonthView, disabled: view === 'month' },
          { label: 'Semana', onClick: onViewChange.handleWeekView, disabled: view === 'week' },
          { label: 'Día', onClick: onViewChange.handleDayView, disabled: view === 'day' },
        ]}
      />
    </div>
  );
}
</file>

<file path="src/Components/calendar/Header/HeaderSection.tsx">
import React from 'react';
import ButtonCalendar from '../ui/ButtonCalendar';

interface HeaderSectionProps {
  buttons: { label: string; onClick: () => void; disabled: boolean }[];
}

export default function HeaderSection({ buttons }: HeaderSectionProps) {
  return (
    <div className='flex items-center gap-2'>
      {buttons.map((b, idx) => (
        <ButtonCalendar key={idx} onClick={b.onClick} disable={b.disabled}>
          {b.label}
        </ButtonCalendar>
      ))}
    </div>
  );
}
</file>

<file path="src/Components/calendar/mobile/DayCell/DayCell.tsx">
'use client';

import React from 'react';
import useDayUtilities from '@/hooks/useDayUtilities';

import { useAppointmentsContext } from '@/app/lib/utils/contexts/AppointmentsContext/AppoinmentsContext';

interface DayCellProps {
  date: Date;
  selectedDate: Date;

  onSelectDate: (date: Date) => void;
}

export default function DayCell({ date, selectedDate, onSelectDate }: DayCellProps) {
  const dayNumber = date.getDate();
  const { isPast, isToday, isSameDay, getColor } = useDayUtilities(date);

  const { getAppointmentsForDay } = useAppointmentsContext();

  const isSelected = isSameDay(date, selectedDate);
  const todayRing = isToday ? 'ring-2 ring-blue-600 ring-offset-2' : '';

  const color = getColor(
    getAppointmentsForDay(date.getDate(), date.getMonth(), date.getFullYear()),
  );
  const colorControl = () => {
    if (isSelected) {
      return 'bg-blue-500 text-white';
    } else {
      if (!isPast) {
        return `${color} text-white`;
      } else {
        return 'text-black';
      }
    }
  };

  return (
    <button
      onClick={() => onSelectDate(date)}
      className={`
        relative flex items-center justify-center w-10 h-10 mx-auto rounded-full 
        select-none font-medium cursor-pointer 
        ${colorControl()} ${todayRing}`}
    >
      <span>{dayNumber}</span>
    </button>
  );
}
</file>

<file path="src/Components/calendar/mobile/MobileCalendar.tsx">
'use client';
import React, { useState, useEffect } from 'react';
import MobileHeader from './MobileHeader';
import MobileMonthView from './MobileMonthView';

interface MobileCalendarProps {
  selectedDate: Date;
  onSelectDate: (dato: Date) => void;
}
export default function MobileCalendar({ selectedDate, onSelectDate }: MobileCalendarProps) {
  const today = selectedDate || new Date();
  const [year, setYear] = useState(today.getFullYear());
  const [month, setMonth] = useState(today.getMonth());
  const [date, setDate] = useState(today.getDate());
  const [message, setMessage] = useState('');

  useEffect(() => {
    if (selectedDate) {
      setTempSelectedDate(selectedDate);
      setYear(selectedDate.getFullYear());
      setMonth(selectedDate.getMonth());
    }
  }, [selectedDate]);

  const [tempSelectedDate, setTempSelectedDate] = useState<Date>(selectedDate);
  const handleSelectedClick = () => {
    if (tempSelectedDate) {
      onSelectDate(tempSelectedDate);
    } else {
      setMessage('Por favor selecciona una fecha primero');
    }
  };

  return (
    <div className='bg-white rounded-2xl shadow p-4 max-w-md mx-auto'>
      <MobileHeader
        month={month}
        year={year}
        date={date}
        onChangeMonth={setMonth}
        onChangeYear={setYear}
        onChangeDate={setDate}
      />

      <MobileMonthView
        year={year}
        month={month}
        selectedDate={tempSelectedDate}
        onSelectDate={setTempSelectedDate}
      />

      <div className='flex justify-end mt-4'>
        <button
          onClick={handleSelectedClick}
          className='bg-blue-500 text-white font-semibold px-4 py-2 rounded-2xl
               active:bg-gray-500 transition-colors'
        >
          Seleccionar
        </button>
      </div>

      {message && <div className='mt-2 text-gray-700 font-medium text-center'>{message}</div>}
    </div>
  );
}
</file>

<file path="src/Components/calendar/mobile/MobileDayliView.tsx">
'use client';
import { useEffect, useRef, useState, useMemo } from 'react';
import AppointmentForm from '../../appointments/forms/AppointmentForm';
import type { AppointmentFormHandle } from '../../appointments/forms/AppointmentForm';
import EditAppointmentForm from '../../appointments/forms/EditAppointmentForm';
import type {
  EditAppointmentFormHandle,
  ExistingAppointment,
} from '../../appointments/forms/EditAppointmentForm';
import AppointmentDetailsForm, {
  EditAppointmentFormHandle as DetailsFormHandle,
} from '@/Components/appointments/forms/AppointmentDetails';

import DatePicker from '@/Components/list/DatePicker/DatePicker';
import { useUserRole } from '@/app/lib/utils/contexts/UserRoleContext';
import { useAppointmentsContext } from '@/app/lib/utils/contexts/AppointmentsContext/AppoinmentsContext';

const API_BASE = 'https://servineo-backend-lorem.onrender.com';

interface PropiedadesHorarioDia {
  fixerId: string;
  requesterId: string;
  selectedDate: Date | string | null;
  onDateChange?: (newDate: Date) => void;
  pickerMode?: boolean;
  onSlotSelect?: (iso: string) => void;
}

type Estado =
  | 'disponible'
  | 'reservado'
  | 'cancelado_fixer'
  | 'cancelado_requester'
  | 'no_disponible'
  | 'ocupado'
  | 'inhabilitado';

interface HorarioItem {
  id_Horario: string;
  Hora_Inicio: string;
  estado_Horario: Estado;
}

interface DatosDia {
  horarios?: HorarioItem[];
}

type Icono = '＋' | '✎' | null;

// Convierte string YYYY-MM-DD a objeto Date local
function convertirYMDaFechaLocal(ymd: string) {
  const [y, m, d] = ymd.split('-').map(Number);
  return new Date(y, m - 1, d);
}

// Convierte Date o string a formato YYYY-MM-DD
function aYMDDeCualquiera(d: Date | string) {
  const fecha = typeof d === 'string' ? convertirYMDaFechaLocal(d) : d;
  const pad = (n: number) => String(n).padStart(2, '0');
  return `${fecha.getFullYear()}-${pad(fecha.getMonth() + 1)}-${pad(fecha.getDate())}`;
}

// Genera array de horas [0, 1, 2, ..., 23]
function rangoHorasEnteras(inicio = 0, fin = 23) {
  const arr: number[] = [];
  for (let h = inicio; h <= fin; h++) arr.push(h);
  return arr;
}

function formatearHora(h: number) {
  return `${String(h).padStart(2, '0')}:00`;
}

// Obtiene fecha/hora actual en Bolivia (UTC-4)
function obtenerAhoraBolivia(): Date {
  const ahora = new Date();
  const utc = ahora.getTime() + ahora.getTimezoneOffset() * 60000;
  const boliviaTime = new Date(utc - 4 * 60 * 60 * 1000);
  return boliviaTime;
}

// Verifica si una fecha YYYY-MM-DD ya pasó
function esPasadoYMD(d: string) {
  const hoyBolivia = obtenerAhoraBolivia();
  const hoy = aYMDDeCualquiera(hoyBolivia);
  return d < hoy;
}

// Verifica si una hora específica de hoy ya pasó
function esHoraPasadaHoy(ymd: string, hora: number): boolean {
  const ahoraBolivia = obtenerAhoraBolivia();
  const hoyYMD = aYMDDeCualquiera(ahoraBolivia);

  if (ymd !== hoyYMD) return false;

  const horaActual = ahoraBolivia.getHours();
  const minutoActual = ahoraBolivia.getMinutes();

  if (hora < horaActual) return true;
  if (hora === horaActual && minutoActual > 0) return true;

  return false;
}

export default function HorarioDelDia({
  fixerId,
  requesterId,
  selectedDate,
  onDateChange,
  pickerMode = false,
  onSlotSelect,
}: PropiedadesHorarioDia) {
  const { isFixer, isRequester } = useUserRole();

  const {
    isHourBookedFixer,
    isEnabled,
    isCanceled,
    isHourBooked,
    loading: fixerLoading,
  } = useAppointmentsContext();

  const fechaFormateadaInicial = selectedDate ? aYMDDeCualquiera(selectedDate) : '';
  const [fecha, setFecha] = useState<string>(fechaFormateadaInicial);
  const [error] = useState<string>('');

  const refFormularioCita = useRef<AppointmentFormHandle | null>(null);
  const refFormularioEditarCita = useRef<EditAppointmentFormHandle | null>(null);
  const formRef = useRef<DetailsFormHandle>(null);
  const handleDatePickerChange = (newDate: Date) => {
    const newDateStr = aYMDDeCualquiera(newDate);
    setFecha(newDateStr);
    onDateChange?.(newDate);
  };

  useEffect(() => {
    if (selectedDate) {
      const d = aYMDDeCualquiera(selectedDate);
      setFecha(d);
    }
  }, [selectedDate]);

  // CÁLCULO REACTIVO DE HORARIOS usando useMemo
  const datos = useMemo<DatosDia | null>(() => {
    if (!fecha) return null;

    const horas = rangoHorasEnteras(0, 23);

    // Si el día completo ya pasó, marcar todo como no disponible
    if (esPasadoYMD(fecha)) {
      const horarios: HorarioItem[] = horas.map((h) => ({
        id_Horario: `${fecha}-${String(h).padStart(2, '0')}`,
        Hora_Inicio: formatearHora(h),
        estado_Horario: 'inhabilitado',
      }));
      return { horarios };
    }

    const horarios: HorarioItem[] = [];
    for (const h of horas) {
      const horaMostrar = formatearHora(h);
      const idBase = `${fecha}-${String(h).padStart(2, '0')}`;

      // Si la hora ya pasó hoy, marcar como no disponible
      if (esHoraPasadaHoy(fecha, h)) {
        horarios.push({
          id_Horario: idBase,
          Hora_Inicio: horaMostrar,
          estado_Horario: 'inhabilitado',
        });
        continue;
      }

      // Crear Date object para la hora actual
      const [year, month, day] = fecha.split('-').map(Number);
      const currentHourDate = new Date(year, month - 1, day, h, 0, 0);

      let estadoHora: Estado = 'inhabilitado';

      const bookedFix = isHourBookedFixer(currentHourDate, h);
      const canceled = isCanceled(currentHourDate, h, requesterId);
      const enabled = isEnabled(currentHourDate, h);
      const booked = isHourBooked(currentHourDate, h, requesterId);

      // PICKER MODE
      if (pickerMode) {
        if (booked === 'self' || booked === 'other') {
          estadoHora = 'no_disponible';
        } else if (canceled === 'fixer' || canceled === 'requester') {
          estadoHora = 'no_disponible';
        } else if (enabled) {
          estadoHora = 'disponible';
        }
      }
      // VISTA FIXER
      else if (isFixer) {
        if (bookedFix) {
          estadoHora = 'reservado';
        } else if (canceled === 'fixer' || canceled === 'otherFixer') {
          estadoHora = 'cancelado_fixer';
        } else if (canceled === 'requester' || canceled === 'otherRequester') {
          estadoHora = 'cancelado_requester';
        } else if (enabled) {
          estadoHora = 'disponible';
        }
      }
      // VISTA REQUESTER
      else if (isRequester) {
        if (booked === 'self') {
          estadoHora = 'reservado';
        } else if (booked === 'other') {
          estadoHora = 'ocupado';
        } else if (canceled === 'otherFixer') {
          estadoHora = 'no_disponible';
        } else if (canceled === 'fixer') {
          estadoHora = 'cancelado_fixer';
        } else if (canceled === 'requester') {
          estadoHora = 'cancelado_requester';
        } else if (enabled) {
          estadoHora = 'disponible';
        }
      }

      horarios.push({ id_Horario: idBase, Hora_Inicio: horaMostrar, estado_Horario: estadoHora });
    }

    return { horarios };
  }, [
    fecha,
    isFixer,
    isRequester,
    pickerMode,
    requesterId,
    isHourBookedFixer,
    isEnabled,
    isCanceled,
    isHourBooked,
  ]);

  async function cargarYEditarCita(item: HorarioItem) {
    try {
      if (!fecha) return;
      const [y, m, d] = fecha.split('-').map(Number);
      const [hh] = (item.Hora_Inicio || '00:00').split(':');
      const horaLocal = parseInt(hh, 10);

      const isoParaEditar = new Date(Date.UTC(y, m - 1, d, horaLocal + 4, 0, 0)).toISOString();

      const url =
        `${API_BASE}/api/crud_read/appointments/get_modal_form` +
        `?fixer_id=${encodeURIComponent(fixerId)}` +
        `&requester_id=${encodeURIComponent(requesterId)}` +
        `&appointment_date=${encodeURIComponent(fecha)}` +
        `&start_hour=${encodeURIComponent(String(horaLocal))}`;

      const res = await fetch(url, { headers: { Accept: 'application/json' } });
      if (!res.ok) {
        const body = await res.text().catch(() => '<sin cuerpo>');
        alert(`Error ${res.status} al consultar la cita.\n${body}`);
        return;
      }
      const data = await res.json();

      const modality = data?.data?.appointment_type === 'presential' ? 'presencial' : 'virtual';

      const existingAppointment: ExistingAppointment = {
        id: data?.data?._id || data?.data?.id || `${fecha}-${hh}`,
        datetime: isoParaEditar,
        client: data?.data?.current_requester_name || '',
        contact: data?.data?.current_requester_phone || '',
        modality,
        description: data?.data?.appointment_description || '',
        meetingLink: data?.data?.link_id || '',
        lat:
          data?.data?.latitude !== undefined && data?.data?.latitude !== null
            ? Number(data.data.latitude)
            : undefined,
        lon:
          data?.data?.longitude !== undefined && data?.data?.longitude !== null
            ? Number(data.data.longitude)
            : undefined,
        address: data?.data?.display_name_location || '',
        place: '',
        fixerId,
        requesterId,
      };

      refFormularioEditarCita.current?.open(existingAppointment);
    } catch (err) {
      alert('Error al cargar los datos de la cita para editar. Revisa consola.');
      console.error(err);
    }
  }

  async function cargarDetallesCita(item: HorarioItem) {
    if (formRef.current) {
      const [y, m, d] = fecha.split('-').map(Number);
      const [hh] = item.Hora_Inicio.split(':');
      const horaLocal = parseInt(hh, 10);

      const now = new Date(y, m - 1, d, horaLocal, 0, 0, 0);
      formRef.current.open(now);
    }
  }

  const etiquetaPorEstado = (
    estado: Estado,
  ): { text: string; icon: Icono; textCls: string; rowCls: string } => {
    switch (estado) {
      case 'disponible':
        return { text: 'DISPONIBLE', icon: '＋', textCls: 'text-emerald-600', rowCls: 'bg-white' };
      case 'reservado':
        return { text: 'RESERVADO', icon: '✎', textCls: 'text-amber-500', rowCls: 'bg-white' };
      case 'cancelado_fixer':
        return {
          text: 'CANCELADO POR FIXER',
          icon: null,
          textCls: 'text-white',
          rowCls: 'bg-rose-600',
        };
      case 'cancelado_requester':
        return {
          text: 'CANCELADO POR REQUESTER',
          icon: null,
          textCls: 'text-white',
          rowCls: 'bg-rose-600',
        };
      case 'no_disponible':
        return {
          text: 'NO DISPONIBLE',
          icon: null,
          textCls: 'text-slate-400',
          rowCls: 'bg-white opacity-60',
        };
      case 'ocupado':
        return {
          text: 'OCUPADO',
          icon: null,
          textCls: 'text-slate-400',
          rowCls: 'bg-white opacity-60',
        };
      case 'inhabilitado':
        return {
          text: 'INHABILITADO',
          icon: null,
          textCls: 'text-slate-400',
          rowCls: 'bg-white opacity-60',
        };
    }
  };

  const manejarClickEnSlot = (item: HorarioItem) => {
    // Validar que la hora no haya pasado antes de permitir click
    if (fecha) {
      const [hh] = item.Hora_Inicio.split(':');
      const hora = parseInt(hh, 10);
      if (esHoraPasadaHoy(fecha, hora)) {
        return;
      }
    }

    // Determinar si el slot es clickeable según el modo y rol
    let clickeable = false;

    if (pickerMode) {
      clickeable = item.estado_Horario === 'disponible';
    } else if (isFixer) {
      clickeable = item.estado_Horario === 'reservado';
    } else if (isRequester) {
      clickeable = item.estado_Horario === 'disponible' || item.estado_Horario === 'reservado';
    }

    if (!clickeable) return;

    const ymd = fecha || aYMDDeCualquiera(selectedDate || new Date());
    const baseDate = convertirYMDaFechaLocal(ymd);
    const hour = parseInt(item.Hora_Inicio.split(':')[0], 10);

    const slotDateLocal = new Date(
      baseDate.getFullYear(),
      baseDate.getMonth(),
      baseDate.getDate(),
      hour,
      0,
      0,
      0,
    );
    const iso = slotDateLocal.toISOString();

    if (pickerMode) {
      onSlotSelect?.(iso);
      return;
    }

    if (item.estado_Horario === 'disponible') {
      refFormularioCita.current?.open(iso);
      return;
    }

    if (item.estado_Horario === 'reservado' && isRequester) {
      cargarYEditarCita(item);
    } else if (item.estado_Horario === 'reservado' && isFixer) {
      cargarDetallesCita(item);
    }
  };

  const noHayHorariosDisponibles =
    !!datos && (datos.horarios ?? []).every((it) => it.estado_Horario !== 'disponible');

  const esEstadoCancelado = (estado: Estado) =>
    estado === 'cancelado_fixer' || estado === 'cancelado_requester';

  return (
    <div className='mx-auto max-w-sm p-4 text-black'>
      <h1 className='text-2xl font-semibold mb-3'>
        Calendario de Diego Paredes
        {!pickerMode && (
          <span className='text-xs ml-2 text-slate-500'>
            ({isFixer ? 'Vista Fixer' : 'Vista Requester'})
          </span>
        )}
      </h1>

      <div className='mb-3'>
        <label className='block text-sm mb-1'>Fecha</label>
        <DatePicker
          selectedDate={
            selectedDate
              ? typeof selectedDate === 'string'
                ? convertirYMDaFechaLocal(selectedDate)
                : selectedDate
              : new Date()
          }
          onDateChange={handleDatePickerChange}
        />
      </div>

      {fixerLoading && (
        <div className='mb-2 rounded-md bg-slate-100 text-slate-600 px-3 py-2 text-sm font-medium'>
          Cargando…
        </div>
      )}
      {error && <div className='text-red-600'>{String(error)}</div>}

      {datos && (
        <div className='rounded-xl bg-slate-100 p-3 text-black'>
          <div className='text-sm font-semibold text-slate-600 mb-2'>
            {fecha
              ? convertirYMDaFechaLocal(fecha).toLocaleDateString('es-BO', {
                  day: '2-digit',
                  month: 'long',
                })
              : ''}
          </div>

          <div className='space-y-2'>
            {datos.horarios &&
              (() => {
                const horariosVisibles = pickerMode
                  ? datos.horarios.filter((h) => h.estado_Horario === 'disponible')
                  : datos.horarios;

                return (
                  <div className='space-y-2'>
                    {horariosVisibles.map((item, idx) => {
                      const meta = etiquetaPorEstado(item.estado_Horario);

                      let clickeable = false;
                      if (pickerMode) {
                        clickeable = item.estado_Horario === 'disponible';
                      } else if (isFixer) {
                        clickeable = item.estado_Horario === 'reservado';
                      } else if (isRequester) {
                        clickeable =
                          item.estado_Horario === 'disponible' ||
                          item.estado_Horario === 'reservado';
                      }

                      return (
                        <div
                          key={item.id_Horario || `slot-${idx}`}
                          onClick={() => {
                            if (!clickeable) return;
                            manejarClickEnSlot(item);
                          }}
                          className={`grid grid-cols-[64px_1fr_28px] items-center rounded-lg border px-3 py-2 shadow-sm ${meta.rowCls} ${clickeable ? 'hover:brightness-95 cursor-pointer' : ''}`}
                        >
                          <div
                            className={`font-semibold ${esEstadoCancelado(item.estado_Horario) ? 'text-white' : 'text-slate-800'}`}
                          >
                            {item.Hora_Inicio}
                          </div>
                          <div className={`text-sm font-semibold ${meta.textCls}`}>{meta.text}</div>
                          <div
                            className={`text-xl text-right ${esEstadoCancelado(item.estado_Horario) ? 'text-white' : 'text-slate-500'}`}
                          >
                            {meta.icon}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                );
              })()}
          </div>

          {noHayHorariosDisponibles && !fixerLoading && !pickerMode && (
            <div className='mt-3 text-center text-sm font-semibold text-slate-600'>
              No hay horarios disponibles
            </div>
          )}
        </div>
      )}

      {!pickerMode && (
        <>
          <AppointmentForm ref={refFormularioCita} fixerId={fixerId} requesterId={requesterId} />
          <EditAppointmentForm ref={refFormularioEditarCita} />
          <AppointmentDetailsForm ref={formRef} />
        </>
      )}
    </div>
  );
}
</file>

<file path="src/Components/calendar/mobile/MobileHeader.tsx">
'use client';
import React from 'react';
import useCalendarNavigation from '@/hooks/useCalendarNavigation';
interface MobileHeaderProps {
  year: number;
  month: number;
  date: number;
  onChangeMonth: (newMonth: number) => void;
  onChangeYear: (newYear: number) => void;
  onChangeDate: (newDate: number) => void;
}

const monthNames = [
  'Enero',
  'Febrero',
  'Marzo',
  'Abril',
  'Mayo',
  'Junio',
  'Julio',
  'Agosto',
  'Septiembre',
  'Octubre',
  'Noviembre',
  'Diciembre',
];

const view = 'month';
export default function MobileHeader({
  year: initialYear,
  month: initialMonth,
  date: initialDate,
  onChangeMonth,
  onChangeYear,
  onChangeDate,
}: MobileHeaderProps) {
  const { year, month, handlePrev, handleNext, isPrevDisabled, isNextDisabled } =
    useCalendarNavigation({
      initialYear,
      initialMonth,
      initialDate,
      view,
      onChangeMonth,
      onChangeYear,
      onChangeDate,
    });

  return (
    <div className='text-black flex justify-between items-center mb-4 px-2'>
      <div className='flex items-center gap-2'>
        <button
          onClick={handlePrev}
          disabled={isPrevDisabled}
          className={`p-1 rounded-full transition-colors ${
            isPrevDisabled
              ? 'opacity-40 cursor-not-allowed'
              : 'hover:bg-gray-200 active:bg-gray-400'
          }`}
        >
          &lt;
        </button>

        <span className='text-lg font-semibold'>{monthNames[month]}</span>

        <button
          onClick={handleNext}
          disabled={isNextDisabled}
          className={`p-1 rounded-full transition-colors ${
            isNextDisabled
              ? 'opacity-40 cursor-not-allowed'
              : 'hover:bg-gray-200 active:bg-gray-400'
          }`}
        >
          &gt;
        </button>
      </div>

      <div className='flex items-center gap-2'>
        <span className='text-lg font-semibold'>{year}</span>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/calendar/mobile/MobileMonthView.tsx">
'use client';
import React from 'react';
import DayCell from './DayCell/DayCell';

interface MobileMonthViewProps {
  year: number;
  month: number;
  selectedDate: Date;

  onSelectDate: (date: Date) => void;
}

export default function MobileMonthView({
  year,
  month,

  selectedDate,
  onSelectDate,
}: MobileMonthViewProps) {
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  const firstDay = (new Date(year, month, 1).getDay() + 6) % 7;

  const days: React.ReactNode[] = [];

  for (let i = 0; i < firstDay; i++) {
    days.push(<div key={`empty-${i}`} className='h-12' />);
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);

    days.push(
      <DayCell key={day} date={date} selectedDate={selectedDate} onSelectDate={onSelectDate} />,
    );
  }
  return (
    <div className='p-4'>
      <div className='grid grid-cols-7 gap-2 text-center text-sm font-medium text-gray-500 mb-2'>
        <div>L</div>
        <div>M</div>
        <div>M</div>
        <div>J</div>
        <div>V</div>
        <div>S</div>
        <div>D</div>
      </div>

      <div className='grid grid-cols-7 gap-y-4'>{days}</div>
    </div>
  );
}
</file>

<file path="src/Components/calendar/mobile/MobileWeekView.tsx">
'use client';

import { useEffect, useState } from 'react';
import DatePicker from '@/Components/list/DatePicker/DatePicker';
const API = process.env.NEXT_PUBLIC_BACKEND as string;

import axios from 'axios';

export interface Schedule {
  _id: string;
  appointment_description: string;
  starting_time: string;
  finishing_time: string;
  schedule_state: string;
  display_name_location: string;
  lat: number;
  lon: number;
}

// Define la interfaz para las props
interface MobileWeekViewProps {
  fixerId: string;
  requesterId: string;
  selectedDate: Date;
  onChangeDate: (newDate: Date) => void;
}

// Función para obtener el día del mes (1-31) de una fecha
function getDayOfMonth(date: Date): number {
  return date.getDate();
}

// Función para obtener el mes de una fecha (0-11)
function getMonthFromDate(date: Date): number {
  return date.getMonth();
}

function groupSchedulesByMonthAndDay(fixerSchedules: Schedule[]): Map<string, Schedule[]> {
  const schedulesMap = new Map<string, Schedule[]>();

  fixerSchedules.forEach((schedule) => {
    const scheduleDate = new Date(schedule.starting_time);
    const month = scheduleDate.getMonth();
    const day = scheduleDate.getDate();

    // Crear una clave única para el día (mes-día)
    const key = `${month}-${day}`;

    if (!schedulesMap.has(key)) {
      schedulesMap.set(key, []);
    }

    schedulesMap.get(key)!.push(schedule);
  });

  return schedulesMap;
}

// Función para obtener las próximas 4 semanas
function getNextFourWeeks(): { startDate: Date; endDate: Date; days: Date[] }[] {
  const weeks = [];
  const today = new Date();

  // Si es fin de semana (sábado = 6, domingo = 0), empezar desde la próxima semana
  const startDate = new Date(today);
  if (today.getDay() === 0 || today.getDay() === 6) {
    startDate.setDate(today.getDate() + (7 - today.getDay()));
  }

  // Ajustar al lunes de la semana actual o próxima
  startDate.setDate(startDate.getDate() - (startDate.getDay() - 1));

  for (let i = 0; i < 4; i++) {
    const weekStart = new Date(startDate);
    weekStart.setDate(startDate.getDate() + i * 7);

    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 4); // Lunes a Viernes

    const days = [];
    for (let j = 0; j < 5; j++) {
      // Solo días de semana (lunes a viernes)
      const day = new Date(weekStart);
      day.setDate(weekStart.getDate() + j);
      days.push(day);
    }

    weeks.push({
      startDate: weekStart,
      endDate: weekEnd,
      days: days,
    });
  }

  return weeks;
}

// Función para formatear fecha
function formatDate(date: Date): string {
  return date.toLocaleDateString('es-ES', {
    day: 'numeric',
    month: 'short',
  });
}

// Función para obtener el nombre del día
function getDayName(date: Date): string {
  return date.toLocaleDateString('es-ES', { weekday: 'long' });
}

function combineSchedules(
  currentRequesterSchedules: Schedule[],
  otherRequesterSchedules: Schedule[],
): Schedule[] {
  // Combinar ambos arrays
  const combined = [...currentRequesterSchedules, ...otherRequesterSchedules];

  for (const schedule of currentRequesterSchedules) {
    if (schedule.schedule_state != 'cancelled') {
      schedule.schedule_state = 'booked';
    }
  }

  for (const schedule of otherRequesterSchedules) {
    schedule.schedule_state = 'occupied';
  }

  // Ordenar por starting_time ascendente (con Z)
  combined.sort((a, b) => a.starting_time.localeCompare(b.starting_time));

  // Convertir a formato sin Z después del sort
  const schedulesWithoutZ = combined.map((schedule) => ({
    ...schedule,
    starting_time: schedule.starting_time ? schedule.starting_time.replace('Z', '') : '',
    finishing_time: schedule.finishing_time ? schedule.finishing_time.replace('Z', '') : '',
  }));

  return schedulesWithoutZ;
}

export default function MobileWeekView({
  fixerId,
  requesterId,
  selectedDate,
  onChangeDate,
}: MobileWeekViewProps) {
  const month = selectedDate ? selectedDate.getMonth() : new Date().getMonth();
  const [schedulesMap, setSchedulesMap] = useState<Map<string, Schedule[]>>(new Map());
  const [loading, setLoading] = useState(true);

  async function fetchWeekSchedule() {
    try {
      setLoading(true);

      const [currentRequesterResponse, otherRequesterResponse] = await Promise.all([
        axios.get(`${API}/api/crud_read/schedules/get_by_fixer_current_requester_month`, {
          params: {
            fixer_id: fixerId,
            requester_id: requesterId,
            month: month + 1,
          },
        }),
        axios.get(`${API}/api/crud_read/schedules/get_by_fixer_other_requesters_month`, {
          params: {
            fixer_id: fixerId,
            requester_id: requesterId,
            month: month + 1,
          },
        }),
      ]);

      const currentRequesterFixerSchedules = currentRequesterResponse.data;
      const otherRequesterFixerSchedules = otherRequesterResponse.data;

      const fixerSchedules: Schedule[] = combineSchedules(
        currentRequesterFixerSchedules,
        otherRequesterFixerSchedules,
      );
      const schedulesByMonthAndDay = groupSchedulesByMonthAndDay(fixerSchedules);

      console.log('Schedules grouped by month and day:', schedulesByMonthAndDay);
      setSchedulesMap(schedulesByMonthAndDay);
    } catch (err) {
      console.error('Error al generar los slots para el fixer:', err);
    } finally {
      setLoading(false);
    }
  }

  // Determinar el estado del día basado en la cantidad de horarios para esa fecha específica
  function getDayStatus(day: Date): { text: string; color: string; available: boolean } {
    const month = getMonthFromDate(day);
    const dayOfMonth = getDayOfMonth(day);
    const key = `${month}-${dayOfMonth}`;

    const daySchedules = schedulesMap.get(key) || [];

    if (daySchedules.length >= 1) {
      return { text: 'Ocupado', color: 'text-slate-400', available: false };
    } else {
      return { text: 'Horarios Disponibles', color: 'text-emerald-600', available: true };
    }
  }

  useEffect(() => {
    fetchWeekSchedule();
  });

  const weeks = getNextFourWeeks();

  if (loading) {
    return (
      <div className='mx-auto max-w-sm p-4 bg-white'>
        <div className='flex justify-center items-center h-32'>
          <p className='text-black'>Cargando horarios...</p>
        </div>
      </div>
    );
  }

  return (
    <div className='mx-auto max-w-sm p-4 bg-white min-h-screen'>
      <h1 className='text-2xl font-semibold mb-3 text-black'>Calendario de usuario</h1>
      <div className='mb-3'>
        <label className='block text-sm mb-1 text-black'>Fecha</label>
        <DatePicker selectedDate={selectedDate} onDateChange={onChangeDate} />
      </div>

      {/* Renderizado de las semanas */}
      <div className='space-y-6'>
        {weeks.map((week, weekIndex) => (
          <div key={weekIndex} className='bg-gray-50 rounded-lg border border-gray-200 p-4'>
            {/* Título de la semana */}
            <h3 className='text-lg font-semibold mb-3 text-center text-black'>
              {formatDate(week.startDate)} - {formatDate(week.endDate)}
            </h3>

            {/* Días de la semana */}
            <div className='space-y-2'>
              {week.days.map((day, dayIndex) => {
                const dayStatus = getDayStatus(day);
                return (
                  <div
                    key={dayIndex}
                    className='flex justify-between items-center p-2 border-b border-gray-200 bg-white rounded-lg'
                  >
                    <div className='flex flex-col'>
                      <span className='font-medium capitalize text-black'>{getDayName(day)}</span>
                      <span className='text-sm text-gray-700'>{formatDate(day)}</span>
                    </div>

                    {dayStatus.available ? (
                      <button className={`font-bold ${dayStatus.color} cursor-default`} disabled>
                        {dayStatus.text}
                      </button>
                    ) : (
                      <span className={`font-bold ${dayStatus.color}`}>{dayStatus.text}</span>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="src/Components/calendar/month/dateCell/DateCell.tsx">
'use client';
import React from 'react';

import useDayUtilities from '@/hooks/useDayUtilities';
import { useAppointmentsContext } from '@/app/lib/utils/contexts/AppointmentsContext/AppoinmentsContext';

interface DateCellProps {
  date: Date;
}

export default function DateCell({ date }: DateCellProps) {
  const day = date.getDate();

  const { isPast, isToday, getColor, getText } = useDayUtilities(date);

  const { getAppointmentsForDay } = useAppointmentsContext();

  const color = getColor(
    getAppointmentsForDay(date.getDate(), date.getMonth(), date.getFullYear()),
  );
  const text = getText(getAppointmentsForDay(date.getDate(), date.getMonth(), date.getFullYear()));

  return (
    <div className='border border-[#b8bec6]'>
      <div className={`h-30 flex flex-col ${isToday ? 'bg-blue-300' : 'bg-white'}`}>
        <div className='text-right text-black'>{day}</div>
        {!isPast && (
          <div className='flex-1 flex items-center'>
            <div className={`w-full p-2 rounded-md text-center text-white ${color}`}>
              <p>{text}</p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/Components/calendar/month/DesktopMonthView/DesktopMonthView.tsx">
'use client';
import React from 'react';
import DateCell from '../dateCell/DateCell';

interface DesktopMonthViewProps {
  year: number;
  month: number;
}
export default function DesktopMonthView({ year, month }: DesktopMonthViewProps) {
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const firstDay = (new Date(year, month, 1).getDay() + 6) % 7;

  const days: React.ReactNode[] = [];

  for (let i = 0; i < firstDay; i++) {
    days.push(<div key={`empty-${i}`} className='border-x border-[#b8bec6]' />);
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);

    days.push(<DateCell key={day} date={date} />);
  }

  return (
    <div className='border border-[#b8bec6] w-full h-full'>
      <div className='text-black grid grid-cols-7 text-center text-sm font-medium  bg-[#D9D9D9] '>
        <div className='border border-[#b8bec6]'> Lunes</div>
        <div className='border border-[#b8bec6]'>Martes</div>
        <div className='border border-[#b8bec6]'>Miercoles</div>
        <div className='border border-[#b8bec6]'>Jueves</div>
        <div className='border border-[#b8bec6]'>Viernes</div>
        <div className='border border-[#b8bec6]'>Sabado</div>
        <div className='border border-[#b8bec6]'>Domingo</div>
      </div>
      <div className='grid grid-cols-7 bg-[#D9D9D9]'>{days}</div>
    </div>
  );
}
</file>

<file path="src/Components/calendar/ui/ButtonCalendar.tsx">
'use client';

import React from 'react';

interface ButtonCalendarProps {
  onClick: () => void;
  disable: boolean;
  children: React.ReactNode;
}

export default function ButtonCalendar({ onClick, disable, children }: ButtonCalendarProps) {
  return (
    <button
      onClick={onClick}
      disabled={disable}
      className={`p-1 rounded-[10px] bg-gray-300 transition-colors ${
        disable ? 'opacity-40 cursor-not-allowed' : 'hover:bg-gray-200 active:bg-gray-400'
      } cursor-pointer`}
    >
      {children}
    </button>
  );
}
</file>

<file path="src/Components/calendar/ui/dialog.tsx">
import * as React from 'react';
import { createPortal } from 'react-dom';

type DialogProps = {
  open: boolean;
  onOpenChange?: (v: boolean) => void;
  children: React.ReactNode;
};

export function Dialog({ open, onOpenChange, children }: DialogProps) {
  React.useEffect(() => {
    if (!open) return;
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onOpenChange?.(false);
    };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [open, onOpenChange]);

  if (!open) return null;

  return createPortal(
    <div aria-modal='true' role='dialog' className='fixed inset-0 z-[9999] grid place-items-center'>
      <div className='fixed inset-0 bg-black/50' onClick={() => onOpenChange?.(false)} />
      {children}
    </div>,
    document.body,
  );
}

type DivProps = React.HTMLAttributes<HTMLDivElement> & { children: React.ReactNode };

export function DialogContent({ className, children, ...rest }: DivProps) {
  return (
    <div
      {...rest}
      className={['relative z-[10000]', className].filter(Boolean).join(' ')}
      onClick={(e) => e.stopPropagation()}
    >
      {children}
    </div>
  );
}
</file>

<file path="src/Components/calendar/ui/Hours.tsx">
'use client';
import React from 'react';
export default function Hours() {
  const hours = Array.from({ length: 24 }, (_, i) => i);

  const setZero = (hour: number) => {
    return hour < 10 ? `0${hour}` : `${hour}`;
  };
  return (
    <div className='w-24 flex-shrink-0 bg-[#D9D9D9] border-b border-black '>
      {hours.map((hour) => (
        <div
          key={`hour-${hour}`}
          className='h-15 flex items-center px-1 text-black text-sm border-x'
        >
          {setZero(hour)}:00 - {setZero(hour + 1)}:00
        </div>
      ))}
    </div>
  );
}
</file>

<file path="src/Components/calendar/week/DesktopWeekView.tsx">
'use client';
import DesktopDailyHours from '../day/DesktopDailyHours';
import Hours from '../ui/Hours';

interface DesktopWeekViewProps {
  date: Date;
}

const getWeekDays = (selectedDate: Date) => {
  const days: Date[] = [];

  // 👇 Crea una copia y normaliza la hora
  const current = new Date(selectedDate);
  current.setHours(0, 0, 0, 0);

  const dayOfWeek = current.getDay();
  const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;

  const firstDay = new Date(current);
  firstDay.setDate(current.getDate() + diff);

  for (let i = 0; i < 7; i++) {
    const day = new Date(firstDay);
    day.setDate(firstDay.getDate() + i);
    day.setHours(0, 0, 0, 0); // 👈 Normaliza cada día
    days.push(day);
  }

  return days;
};

function getDayName(dayNumber: number): string {
  const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
  return days[dayNumber];
}

export default function DesktopWeekView({ date }: DesktopWeekViewProps) {
  const weekDays = getWeekDays(date);

  return (
    <div className='flex flex-col'>
      <div className='flex'>
        <div>
          <div className='text-white'>
            <p>--</p>
          </div>
          <Hours />
        </div>
        <div className='border-[#b8bec6] w-full h-full'>
          <div className='flex-1 grid grid-cols-7'>
            {weekDays.map((day) => (
              <div key={day.toISOString()}>
                <div className='flex items-center justify-center border-r border-b bg-gray-300 text-black'>
                  {getDayName(day.getDay())} {day.getDate()}
                </div>
                <DesktopDailyHours date={day} view={'week'} />
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/Card.tsx">
import type React from 'react';
interface CardProps {
  title?: string;
  className?: string;
  children: React.ReactNode;
}

export function Card({ title, children, className }: CardProps) {
  return (
    <div
      className={`neon-border glass-panel rounded-2xl border border-primary p-5 shadow-sm animate-slide-up ${className}`}
    >
      <h3 className='mb-3 text-center text-lg font-semibold'>{title}</h3>
      {children}
    </div>
  );
}
</file>

<file path="src/Components/Common/Accordion.tsx">
import { ChevronDown } from 'lucide-react';
import { useState } from 'react';

interface AccordionProps {
  title: string;
  children: React.ReactNode;
  isOpen?: boolean;
  onToggle?: () => void;
  className?: string;
}

const Accordion = ({
  title,
  children,
  isOpen: isOpenProp,
  onToggle,
  className = '',
}: AccordionProps) => {
  const [isOpenInternal, setIsOpenInternal] = useState(false);
  const isControlled = isOpenProp !== undefined;
  const isOpen = isControlled ? isOpenProp : isOpenInternal;

  const toggle = () => {
    if (isControlled && onToggle) {
      onToggle();
    } else {
      setIsOpenInternal(!isOpen);
    }
  };

  const headerClasses = [
    'flex items-center justify-between w-full px-4 py-3 text-sm font-medium text-left',
    'bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors duration-200',
    isOpen ? 'rounded-b-none' : '',
  ]
    .filter(Boolean)
    .join(' ');

  const contentClasses = [
    'overflow-hidden transition-all duration-200 ease-in-out',
    isOpen ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0',
  ]
    .filter(Boolean)
    .join(' ');

  return (
    <div className={['w-full', className].filter(Boolean).join(' ')}>
      <button type='button' className={headerClasses} onClick={toggle}>
        <span className='text-gray-700'>{title}</span>
        <ChevronDown
          className={[
            'w-4 h-4 text-gray-500 transform transition-transform duration-200',
            isOpen ? 'rotate-180' : '',
          ]
            .filter(Boolean)
            .join(' ')}
        />
      </button>
      <div className={contentClasses}>
        <div className='p-4 bg-white border border-t-0 border-gray-200 rounded-b-lg'>
          {children}
        </div>
      </div>
    </div>
  );
};

export default Accordion;
</file>

<file path="src/Components/Common/Button.tsx">
import { Loader2 } from 'lucide-react';
import { ButtonHTMLAttributes } from 'react';

interface ButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'outline' | 'ghost' | 'link';
  size?: 'sm' | 'md' | 'lg';
  isLoading?: boolean;
}

const Button = ({
  children,
  className = '',
  variant = 'primary',
  size = 'md',
  isLoading = false,
  disabled,
  ...props
}: ButtonProps) => {
  const baseStyles =
    'inline-flex items-center justify-center rounded-md font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary disabled:opacity-50 disabled:pointer-events-none';

  const variants = {
    primary: 'bg-primary text-white hover:bg-primary/90',
    secondary: 'bg-secondary text-secondary-foreground hover:bg-secondary/80',
    outline: 'border border-input bg-transparent hover:bg-accent hover:text-accent-foreground',
    ghost: 'hover:bg-accent hover:text-accent-foreground',
    link: 'text-primary underline-offset-4 hover:underline',
  };

  const sizes = {
    sm: 'h-9 px-3 text-sm',
    md: 'h-10 py-2 px-4',
    lg: 'h-11 px-8 rounded-md',
  };

  const buttonClasses = [baseStyles, variants[variant], sizes[size], className]
    .filter(Boolean)
    .join(' ');

  return (
    <button className={buttonClasses} disabled={isLoading || disabled} {...props}>
      {isLoading && <Loader2 className='mr-2 h-4 w-4 animate-spin' />}
      {children}
    </button>
  );
};

export { Button };
</file>

<file path="src/Components/Common/Input.tsx">
interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  error?: string;
  containerClassName?: string;
}

const Input = ({ label, error, className = '', containerClassName = '', ...props }: InputProps) => {
  const containerClasses = ['w-full', containerClassName].filter(Boolean).join(' ');
  const inputClasses = [
    'w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm',
    'focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary',
    'text-gray-900 placeholder-gray-400',
    'disabled:bg-gray-100 disabled:cursor-not-allowed',
    'transition-all duration-200',
    className,
  ]
    .filter(Boolean)
    .join(' ');

  return (
    <div className={containerClasses}>
      {label && <label className='block text-sm font-medium text-gray-700 mb-1'>{label}</label>}
      <input className={inputClasses} {...props} />
      {error && <p className='mt-1 text-sm text-red-600'>{error}</p>}
    </div>
  );
};

export default Input;
</file>

<file path="src/Components/Common/StatCard.tsx">
import React from 'react';

interface StatCardProps {
  number: string;
  text: string;
}

export default function StatCard({ number, text }: StatCardProps) {
  return (
    <div className='text-center bg-white/80 backdrop-blur-sm rounded-xl p-6 shadow-md transform transition-all duration-500 hover:scale-105 hover:shadow-lg'>
      <p className='text-3xl md:text-5xl font-bold text-primary mb-2'>{number}</p>
      <p className='text-gray-700 text-lg font-medium'>{text}</p>
    </div>
  );
}
</file>

<file path="src/Components/Common/TextHighlighter.ts">
/**
 * Normaliza una palabra individual para crear un patrón flexible
 * que coincida con variantes de tildes y diéresis
 */
function normalizeWord(word: string): string {
  let normalized = word.toLowerCase();

  // Escapar caracteres especiales de RegExp
  normalized = normalized.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

  // Quitar tildes del texto de búsqueda
  normalized = normalized.replace(/[ÁáÀàÂâÄäÃãÅåĀāĂăǍǎȦȧ]/g, 'a');
  normalized = normalized.replace(/[ÉéÈèÊêËëĒēĔĕĚěĖė]/g, 'e');
  normalized = normalized.replace(/[ÍíÌìÎîÏïĨĩĪīĬĭǏǐ]/g, 'i');
  normalized = normalized.replace(/[ÓóÒòÔôÖöÕõŌōŎŏǑǒȮȯ]/g, 'o');
  normalized = normalized.replace(/[ÚúÙùÛûÜüŨũŮůŪūŬŭǓǔU̇u̇]/g, 'u');

  // Crear patrón flexible que coincida con tildes
  let pattern = normalized.replace(/a/g, '[aáäàâ]');
  pattern = pattern.replace(/e/g, '[eéëèê]');
  pattern = pattern.replace(/i/g, '[iíïìî]');
  pattern = pattern.replace(/o/g, '[oóöòô]');
  pattern = pattern.replace(/u/g, '[uúüùû]');

  return pattern;
}

/**
 * Extrae palabras individuales del texto de búsqueda
 * separando por espacios, guiones, guiones bajos, puntos y comas
 */
function extractSearchWords(searchText: string): string[] {
  if (!searchText || !searchText.trim()) {
    return [];
  }

  // Dividir por separadores: espacios, guiones, guiones bajos, puntos, comas
  const words = searchText
    .trim()
    .split(/[\s\-_.,]+/)
    .filter((word) => word.length > 0);

  return words;
}

/**
 * Crea un patrón de búsqueda que coincida con cualquiera de las palabras
 */
export function createSearchPattern(searchText: string): RegExp | null {
  const words = extractSearchWords(searchText);

  if (words.length === 0) {
    return null;
  }

  // Crear patrón para cada palabra y unirlos con OR (|)
  const patterns = words.map((word) => normalizeWord(word));
  const combinedPattern = patterns.join('|');

  return new RegExp(`(${combinedPattern})`, 'gi');
}

/**
 * Resalta las coincidencias devolviendo un array de partes
 * Útil para React donde necesitas componentes en lugar de HTML string
 */
export function highlightTextParts(
  text: string,
  searchText: string,
): Array<{ text: string; highlight: boolean }> {
  if (!text || !searchText) {
    return [{ text, highlight: false }];
  }

  const pattern = createSearchPattern(searchText);
  if (!pattern) {
    return [{ text, highlight: false }];
  }

  const parts: Array<{ text: string; highlight: boolean }> = [];
  let lastIndex = 0;
  let match: RegExpExecArray | null;

  // Reset del regex para asegurar que empiece desde el inicio
  pattern.lastIndex = 0;

  while ((match = pattern.exec(text)) !== null) {
    // Agregar texto antes de la coincidencia
    if (match.index > lastIndex) {
      parts.push({
        text: text.slice(lastIndex, match.index),
        highlight: false,
      });
    }

    // Agregar la coincidencia resaltada
    parts.push({
      text: match[0],
      highlight: true,
    });

    lastIndex = match.index + match[0].length;
  }

  // Agregar texto restante
  if (lastIndex < text.length) {
    parts.push({
      text: text.slice(lastIndex),
      highlight: false,
    });
  }

  return parts.length > 0 ? parts : [{ text, highlight: false }];
}
</file>

<file path="src/Components/Contact/Contact-card.tsx">
'use client';

import { MessageCircle, Phone, Copy, Mail } from 'lucide-react';
import { useState } from 'react';

interface ContactCardProps {
  name: string;
  whatsapp: string;
  email?: string;
  phone?: string;
  city?: string;
}

export function ContactCard({ name, whatsapp, email, phone, city }: ContactCardProps) {
  const [copiedField, setCopiedField] = useState<string | null>(null);

  const handleCopy = (text: string, field: string) => {
    navigator.clipboard.writeText(text);
    setCopiedField(field);
    setTimeout(() => setCopiedField(null), 2000);
  };

  return (
    <div className='bg-gradient-to-br from-card via-card to-green-50/20 border-2 border-border rounded-2xl p-6 space-y-4 shadow-lg hover:shadow-xl transition-all'>
      <div className='flex items-start justify-between mb-4'>
        <div>
          <h3 className='text-lg font-bold text-foreground'>{name}</h3>
          {city && <p className='text-sm text-muted-foreground mt-1'>{city}</p>}
        </div>
      </div>

      {/* WhatsApp Contact */}
      <div className='flex items-center justify-between p-3 bg-green-50 border-2 border-green-200 rounded-xl hover:bg-green-100 transition-all'>
        <div className='flex items-center gap-3'>
          <div className='w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center'>
            <MessageCircle className='w-5 h-5 text-white' />
          </div>
          <div>
            <p className='text-xs text-muted-foreground font-medium'>WhatsApp</p>
            <p className='text-sm font-semibold text-foreground'>{whatsapp}</p>
          </div>
        </div>
        <button
          onClick={() => handleCopy(whatsapp, 'whatsapp')}
          className={`p-2 rounded-lg transition-all ${
            copiedField === 'whatsapp'
              ? 'bg-green-300 text-green-800'
              : 'hover:bg-green-200 text-green-700'
          }`}
          title='Copiar'
        >
          <Copy className='w-4 h-4' />
        </button>
      </div>

      {/* Phone Contact */}
      {phone && (
        <div className='flex items-center justify-between p-3 bg-blue-50 border-2 border-blue-200 rounded-xl hover:bg-blue-100 transition-all'>
          <div className='flex items-center gap-3'>
            <div className='w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center'>
              <Phone className='w-5 h-5 text-white' />
            </div>
            <div>
              <p className='text-xs text-muted-foreground font-medium'>Teléfono</p>
              <p className='text-sm font-semibold text-foreground'>{phone}</p>
            </div>
          </div>
          <button
            onClick={() => handleCopy(phone, 'phone')}
            className={`p-2 rounded-lg transition-all ${
              copiedField === 'phone'
                ? 'bg-blue-300 text-blue-800'
                : 'hover:bg-blue-200 text-blue-700'
            }`}
            title='Copiar'
          >
            <Copy className='w-4 h-4' />
          </button>
        </div>
      )}

      {/* Email Contact */}
      {email && (
        <div className='flex items-center justify-between p-3 bg-purple-50 border-2 border-purple-200 rounded-xl hover:bg-purple-100 transition-all'>
          <div className='flex items-center gap-3'>
            <div className='w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center'>
              <Mail className='w-5 h-5 text-white' />
            </div>
            <div>
              <p className='text-xs text-muted-foreground font-medium'>Email</p>
              <p className='text-sm font-semibold text-foreground truncate'>{email}</p>
            </div>
          </div>
          <button
            onClick={() => handleCopy(email, 'email')}
            className={`p-2 rounded-lg transition-all ${
              copiedField === 'email'
                ? 'bg-purple-300 text-purple-800'
                : 'hover:bg-purple-200 text-purple-700'
            }`}
            title='Copiar'
          >
            <Copy className='w-4 h-4' />
          </button>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/Components/Contact/Contact-modal.tsx">
'use client';

import { X, MessageCircle, Phone, Mail, Share2 } from 'lucide-react';
import { WhatsAppButton } from './Whasapp-button';

interface ContactModalProps {
  isOpen: boolean;
  onClose: () => void;
  name: string;
  whatsapp: string;
  email?: string;
  phone?: string;
  city?: string;
  message?: string;
}

export function ContactModal({
  isOpen,
  onClose,
  name,
  whatsapp,
  email,
  phone,
  city,
  message = `Hola ${name}, encontré tu perfil en FIXER y me interesaría trabajar contigo.`,
}: ContactModalProps) {
  if (!isOpen) return null;

  const handleShare = async () => {
    if (navigator.share) {
      try {
        await navigator.share({
          title: `Contactar con ${name}`,
          text: `Contacta a ${name} - Profesional de servicios en ${city || 'FIXER'}`,
          url: window.location.href,
        });
      } catch (error) {
        console.log('Error sharing:', error);
      }
    }
  };

  return (
    <div className='fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in'>
      <div className='bg-card rounded-2xl max-w-md w-full shadow-2xl border-2 border-border animate-scale-in'>
        {/* Header */}
        <div className='bg-gradient-to-r from-primary to-blue-600 p-6 flex items-center justify-between rounded-t-xl'>
          <div>
            <h2 className='text-2xl font-bold text-primary-foreground'>{name}</h2>
            {city && <p className='text-sm text-primary-foreground/80 mt-1'>{city}</p>}
          </div>
          <button
            onClick={onClose}
            className='p-2 hover:bg-white/20 rounded-lg transition-all hover:rotate-90 duration-300'
          >
            <X className='w-5 h-5 text-primary-foreground' />
          </button>
        </div>

        {/* Content */}
        <div className='p-6 space-y-4'>
          {/* Main WhatsApp CTA */}
          <WhatsAppButton phone={whatsapp} message={message} className='w-full justify-center' />

          {/* Contact Options Grid */}
          <div className='grid grid-cols-2 gap-3'>
            {phone && (
              <a
                href={`tel:${phone}`}
                className='flex items-center justify-center gap-2 px-4 py-3 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-lg text-blue-700 font-medium transition-all text-sm'
              >
                <Phone className='w-4 h-4' />
                Llamar
              </a>
            )}

            {email && (
              <a
                href={`mailto:${email}`}
                className='flex items-center justify-center gap-2 px-4 py-3 bg-purple-50 hover:bg-purple-100 border-2 border-purple-200 rounded-lg text-purple-700 font-medium transition-all text-sm'
              >
                <Mail className='w-4 h-4' />
                Email
              </a>
            )}
          </div>

          {/* Share Button */}
          <button
            onClick={handleShare}
            className='w-full flex items-center justify-center gap-2 px-4 py-2 border-2 border-border rounded-lg text-foreground hover:bg-muted transition-all font-medium text-sm'
          >
            <Share2 className='w-4 h-4' />
            Compartir
          </button>

          {/* Contact Info Display */}
          <div className='pt-4 border-t border-border/50 space-y-2'>
            <div className='flex items-center gap-2 text-sm'>
              <MessageCircle className='w-4 h-4 text-green-600' />
              <span className='text-muted-foreground'>{whatsapp}</span>
            </div>
            {phone && (
              <div className='flex items-center gap-2 text-sm'>
                <Phone className='w-4 h-4 text-blue-600' />
                <span className='text-muted-foreground'>{phone}</span>
              </div>
            )}
            {email && (
              <div className='flex items-center gap-2 text-sm'>
                <Mail className='w-4 h-4 text-purple-600' />
                <span className='text-muted-foreground truncate'>{email}</span>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/Contact/Quick-contact.tsx">
'use client';

import { MessageCircle, Phone, Mail, X } from 'lucide-react';
import { useState } from 'react';

interface QuickContactProps {
  whatsapp: string;
  phone?: string;
  email?: string;
  position?: 'bottom-right' | 'bottom-left';
}

export function QuickContact({
  whatsapp,
  phone,
  email,
  position = 'bottom-right',
}: QuickContactProps) {
  const [isOpen, setIsOpen] = useState(false);

  const positionClass = position === 'bottom-right' ? 'bottom-6 right-6' : 'bottom-6 left-6';

  return (
    <div className={`fixed ${positionClass} z-40`}>
      {/* Menu */}
      {isOpen && (
        <div className='absolute bottom-full mb-4 right-0 bg-card border-2 border-border rounded-2xl p-3 shadow-2xl animate-scale-in space-y-2 w-56'>
          <p className='text-sm font-semibold text-foreground mb-3 px-2'>Nuestros Contactos</p>

          <a
            href={`https://wa.me/${whatsapp.replace(/\D/g, '')}`}
            target='_blank'
            rel='noopener noreferrer'
            className='flex items-center gap-3 w-full p-3 bg-green-50 hover:bg-green-100 border-2 border-green-200 rounded-lg text-green-700 font-medium transition-all text-sm'
          >
            <MessageCircle className='w-4 h-4' />
            WhatsApp
          </a>

          {phone && (
            <a
              href={`tel:${phone}`}
              className='flex items-center gap-3 w-full p-3 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-lg text-blue-700 font-medium transition-all text-sm'
            >
              <Phone className='w-4 h-4' />
              Llamar
            </a>
          )}

          {email && (
            <a
              href={`mailto:${email}`}
              className='flex items-center gap-3 w-full p-3 bg-purple-50 hover:bg-purple-100 border-2 border-purple-200 rounded-lg text-purple-700 font-medium transition-all text-sm'
            >
              <Mail className='w-4 h-4' />
              Email
            </a>
          )}
        </div>
      )}

      {/* Toggle Button */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        className='w-14 h-14 rounded-full bg-gradient-to-r from-green-500 to-green-600 text-white shadow-2xl shadow-green-500/50 flex items-center justify-center hover:scale-110 transition-transform duration-300 border-4 border-background'
      >
        {isOpen ? <X className='w-6 h-6' /> : <MessageCircle className='w-6 h-6' />}
      </button>
    </div>
  );
}
</file>

<file path="src/Components/Contact/Whasapp-button.tsx">
// src/Components/Contact/WhatsAppButton.tsx
'use client';

import { Phone } from 'lucide-react';

interface WhatsAppButtonProps {
  phone: string;
  message?: string;
  className?: string;
}

export function WhatsAppButton({ phone, message = '', className = '' }: WhatsAppButtonProps) {
  const handleClick = () => {
    const text = encodeURIComponent(message);
    window.open(`https://wa.me/${phone}?text=${text}`, '_blank');
  };

  return (
    <button
      onClick={handleClick}
      className={`flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors ${className}`}
    >
      <Phone className='w-4 h-4' />
      <span>Contactar por WhatsApp</span>
    </button>
  );
}
</file>

<file path="src/Components/FiltersPanel.tsx">
'use client';

import { useAppDispatch, useAppSelector } from '@/app/redux/hooks';
import {
  toggleFixerName,
  toggleCity,
  toggleJobType,
  resetFilters,
  selectSelectedFixerNames,
  selectSelectedCities,
  selectSelectedJobTypes,
  selectIsAutoSelectedJobType,
  selectIsAutoSelectedCity,
  selectSidebarOpen,
  setSidebarOpen,
} from '../app/redux/slice/filterSlice';
import { DB_VALUES } from '@/app/redux/contants';
import { X } from 'lucide-react';
import { useTranslations } from 'next-intl';

export function FiltersPanel() {
  const t = useTranslations('filtersPanel');
  const dispatch = useAppDispatch();
  const sidebarOpen = useAppSelector(selectSidebarOpen);
  const selectedFixerNames = useAppSelector(selectSelectedFixerNames);
  const selectedCities = useAppSelector(selectSelectedCities);
  const selectedJobTypes = useAppSelector(selectSelectedJobTypes);
  const isAutoSelectedJobType = useAppSelector(selectIsAutoSelectedJobType);
  const isAutoSelectedCity = useAppSelector(selectIsAutoSelectedCity);

  return (
    <>
      {/* Overlay */}
      {sidebarOpen && (
        <div
          className='fixed inset-0 bg-black/40 z-30 lg:hidden animate-fade-in'
          onClick={() => dispatch(setSidebarOpen(false))}
        />
      )}

      {/* Sidebar */}
      <aside
        className={`fixed left-0 top-0 h-screen w-72 bg-white border-r border-gray-200 overflow-y-auto z-40 transition-all duration-300 ease-in-out lg:relative lg:translate-x-0 lg:top-auto lg:h-auto lg:w-64 ${
          sidebarOpen ? 'translate-x-0 shadow-lg' : '-translate-x-full'
        }`}
      >
        <div className='p-4 space-y-6'>
          {/* Mobile Header */}
          <div className='flex items-center justify-between lg:hidden'>
            <h2 className='text-xl font-semibold text-gray-800'>{t('filters')}</h2>
            <button
              onClick={() => dispatch(setSidebarOpen(false))}
              className='p-2 text-gray-500 hover:bg-gray-100 rounded-full transition-colors'
            >
              <X className='w-5 h-5' />
            </button>
          </div>

          {/* Desktop Header */}
          <div className='hidden lg:flex items-center justify-between'>
            <h2 className='text-xl font-semibold text-gray-800'>{t('filters')}</h2>
            <button
              onClick={() => dispatch(resetFilters())}
              className='px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium'
            >
              {t('resetButton.desktop')}
            </button>
          </div>

          {/* Mobile Reset Button */}
          <button
            onClick={() => dispatch(resetFilters())}
            className='lg:hidden w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium'
          >
            {t('resetButton.mobile')}
          </button>

          {/* Filter Sections */}
          <div className='space-y-6'>
            {/* Nombre de Fixer */}
            <div className='space-y-3'>
              <div className='px-3 py-2 bg-blue-50 rounded-lg'>
                <h3 className='font-medium text-blue-800'>{t('fixerName')}</h3>
              </div>
              <div className='grid grid-cols-2 gap-2'>
                {DB_VALUES.ranges.slice(0, 5).map((range) => (
                  <label
                    key={range}
                    className='flex items-center gap-2 p-2 cursor-pointer hover:bg-gray-50 rounded-lg transition-colors'
                  >
                    <input
                      type='checkbox'
                      checked={selectedFixerNames.includes(range)}
                      onChange={() => dispatch(toggleFixerName(range))}
                      className='w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500'
                    />
                    <span className='text-sm text-gray-700'>{range}</span>
                  </label>
                ))}
              </div>
            </div>

            {/* Ciudad */}
            <div className='space-y-3'>
              <div className='px-3 py-2 bg-blue-50 rounded-lg'>
                <h3 className='font-medium text-blue-800'>{t('city')}</h3>
              </div>
              <div className='space-y-2 max-h-48 overflow-y-auto pr-2'>
                {DB_VALUES.cities.map((city) => {
                  const isSelected = selectedCities.includes(city);
                  const isAutoMarked = isAutoSelectedCity && isSelected;
                  const isDisabled = isAutoSelectedCity && !isSelected;

                  return (
                    <label
                      key={city}
                      className={`flex items-center gap-2 p-2 rounded-lg transition-colors ${
                        isDisabled
                          ? 'cursor-not-allowed opacity-50 bg-gray-200'
                          : 'cursor-pointer hover:bg-gray-50'
                      }`}
                    >
                      <input
                        type='checkbox'
                        checked={isSelected}
                        onChange={() => {
                          // Si es automarcado, no permite deseleccionar
                          if (isAutoMarked) return;
                          dispatch(toggleCity(city));
                        }}
                        disabled={isDisabled}
                        className={`w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer`}
                      />
                      <span className={`text-sm ${isDisabled ? 'text-gray-400' : 'text-gray-700'}`}>
                        {city}
                      </span>
                    </label>
                  );
                })}
              </div>
            </div>

            {/* Tipo de Trabajo */}
            <div className='space-y-3'>
              <div className='px-3 py-2 bg-blue-50 rounded-lg'>
                <h3 className='font-medium text-blue-800'>{t('jobCategory')}</h3>
              </div>
              <div className='space-y-2 max-h-48 overflow-y-auto pr-2'>
                {DB_VALUES.jobTypes.map((type) => {
                  const isSelected = selectedJobTypes.includes(type);
                  const isAutoMarked = isAutoSelectedJobType && isSelected;
                  const isDisabled = isAutoSelectedJobType && !isSelected;

                  return (
                    <label
                      key={type}
                      className={`flex items-center gap-2 p-2 rounded-lg transition-colors ${
                        isDisabled
                          ? 'cursor-not-allowed opacity-50 bg-gray-200'
                          : isAutoMarked
                            ? 'cursor-pointer hover:bg-gray-50'
                            : 'cursor-pointer hover:bg-gray-50'
                      }`}
                    >
                      <input
                        type='checkbox'
                        checked={isSelected}
                        onChange={() => {
                          // Si es automarcado, no permite deseleccionar
                          if (isAutoMarked) return;
                          dispatch(toggleJobType(type));
                        }}
                        disabled={isDisabled}
                        className={`w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer`}
                      />
                      <span className={`text-sm ${isDisabled ? 'text-gray-400' : 'text-gray-700'}`}>
                        {type}
                      </span>
                    </label>
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      </aside>
    </>
  );
}
</file>

<file path="src/Components/Fixer-profile.tsx">
'use client';

import { useState, useEffect, useRef } from 'react';
import {
  MapPin,
  Edit,
  Save,
  X,
  Briefcase,
  MessageSquare,
  Star,
  Phone,
  Mail,
  Calendar,
} from 'lucide-react';
import Image from 'next/image';
import Link from 'next/link';
import type { Fixer } from '@/app/lib/mock-data';
import FixerGraficCard from '@/Components/fixer/Fixer-grafic-card';
import JobStatistics from '@/Components/fixer/Fixer-statistics';

interface FixerProfileProps {
  fixer: Fixer;
  isOwner?: boolean;
}

interface FormData {
  bio: string;
  phone: string;
  city: string;
  whatsapp: string;
}

interface LocationMapProps {
  lat: number;
  lng: number;
}

// Remove duplicate Window interface declaration to avoid type conflicts

export function FixerProfile({ fixer, isOwner = false }: FixerProfileProps) {
  const [isEditing, setIsEditing] = useState(false);
  const [formData, setFormData] = useState<FormData>({
    bio: fixer.bio || '',
    phone: fixer.phone || '',
    city: fixer.city || '',
    whatsapp: fixer.whatsapp || '',
  });

  const handleInputChange = (e: React.ChangeEvent<HTMLTextAreaElement | HTMLInputElement>) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  const handleSave = () => {
    console.log('Saving profile:', formData);
    setIsEditing(false);
  };

  const handleContact = () => {
    if (fixer.whatsapp) {
      window.open(`https://wa.me/${fixer.whatsapp.replace(/\D/g, '')}`, '_blank');
    }
  };

  const handleClickCalendar = () => {
    sessionStorage.setItem('fixer_id', fixer.id);
    sessionStorage.setItem('requester_id', 'pupup');
    sessionStorage.setItem('roluser', 'fixer');
  };

  const formattedJoinDate = (() => {
    if (!fixer.joinDate) return null;
    const date = new Date(fixer.joinDate);
    if (Number.isNaN(date.getTime())) return null;

    return date.toLocaleDateString('es-ES', {
      month: 'long',
      year: 'numeric',
    });
  })();

  return (
    <div className='max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8'>
      <div className='bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden'>
        {/* Profile Header */}
        <div className='bg-gradient-to-r from-blue-600 to-blue-800 p-6 text-white'>
          <div className='flex flex-col md:flex-row items-center gap-6'>
            <div className='relative'>
              <div className='w-32 h-32 rounded-full border-4 border-white bg-white overflow-hidden'>
                {fixer.photo && fixer.photo.startsWith('http') ? (
                  <Image
                    src={fixer.photo}
                    alt={fixer.name}
                    width={128}
                    height={128}
                    className='w-full h-full object-cover'
                    unoptimized
                  />
                ) : (
                  <div className='w-full h-full bg-blue-100 flex items-center justify-center'>
                    <Briefcase className='w-16 h-16 text-blue-600' />
                  </div>
                )}
              </div>
              {isOwner && (
                <button className='absolute bottom-0 right-0 bg-white p-2 rounded-full shadow-md hover:bg-gray-100 transition-colors'>
                  <Edit className='w-4 h-4 text-blue-600' />
                </button>
              )}
            </div>

            <div className='text-center md:text-left flex-1'>
              <h1 className='text-2xl font-bold'>{fixer.name}</h1>
              <div className='flex items-center justify-center md:justify-start gap-2 mt-2'>
                <MapPin className='w-4 h-4' />
                <span>{fixer.city}</span>
              </div>

              <div className='flex items-center justify-center md:justify-start gap-4 mt-4'>
                <div className='flex items-center gap-1 bg-white/20 px-3 py-1 rounded-full'>
                  <Star className='w-4 h-4 text-yellow-300 fill-yellow-300' />
                  <span>{fixer.rating?.toFixed(1) || 'Nuevo'}</span>
                </div>
                <span className='text-sm opacity-80'>
                  {fixer.completedJobs} trabajos realizados
                </span>
              </div>

              {formattedJoinDate && (
                <p className='mt-1 text-sm opacity-80'>En la app desde {formattedJoinDate}</p>
              )}

              {!isOwner && fixer.whatsapp && (
                <button
                  onClick={handleContact}
                  className='mt-4 px-4 py-2 bg-white text-blue-700 rounded-lg font-medium flex items-center gap-2 mx-auto md:mx-0 hover:bg-gray-50 transition-colors'
                >
                  <MessageSquare className='w-4 h-4' />
                  Contactar por WhatsApp
                </button>
              )}
              {isOwner && (
                <Link
                  href='../calendar'
                  onClick={handleClickCalendar}
                  className='mt-4 px-4 py-2 bg-white text-blue-700 rounded-lg font-medium flex items-center gap-2 mx-auto md:mx-0 hover:bg-gray-50 transition-colors'
                >
                  <Calendar className='w-4 h-4' />
                  Ver Calendario
                </Link>
              )}
            </div>
          </div>
        </div>

        {/* Profile Content */}
        <div className='p-6'>
          {/* Botones de edición */}
          {isOwner && (
            <div className='flex justify-end mb-6'>
              {isEditing ? (
                <div className='flex gap-2'>
                  <button
                    onClick={() => setIsEditing(false)}
                    className='px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg flex items-center gap-2'
                  >
                    <X className='w-4 h-4' />
                    Cancelar
                  </button>
                  <button
                    onClick={handleSave}
                    className='px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 flex items-center gap-2'
                  >
                    <Save className='w-4 h-4' />
                    Guardar cambios
                  </button>
                </div>
              ) : (
                <button
                  onClick={() => setIsEditing(true)}
                  className='px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 rounded-lg flex items-center gap-2'
                >
                  <Edit className='w-4 h-4' />
                  Editar perfil
                </button>
              )}
            </div>
          )}

          {/* Bio Section */}
          <div className='mb-8'>
            <h3 className='text-lg font-semibold text-gray-900 mb-3'>Acerca de mí</h3>
            {isEditing ? (
              <textarea
                name='bio'
                value={formData.bio}
                onChange={handleInputChange}
                className='w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none'
                rows={4}
                placeholder='Cuéntanos sobre ti y tus servicios...'
              />
            ) : (
              <p className='text-gray-700 whitespace-pre-line leading-relaxed'>
                {fixer.bio || 'Este profesional aún no ha agregado una descripción.'}
              </p>
            )}
          </div>

          {/* Contact & Services */}
          <div className='grid grid-cols-1 md:grid-cols-2 gap-8 mb-8'>
            {/* Contact Info */}
            <div>
              <h3 className='text-lg font-semibold text-gray-900 mb-4'>Información de contacto</h3>
              <div className='space-y-3'>
                {fixer.email && (
                  <div className='flex items-center gap-3 p-3 bg-gray-50 rounded-lg'>
                    <Mail className='w-5 h-5 text-gray-500' />
                    <span>{fixer.email}</span>
                  </div>
                )}
                <div className='flex items-center gap-3 p-3 bg-gray-50 rounded-lg'>
                  <Phone className='w-5 h-5 text-gray-500' />
                  {isEditing ? (
                    <input
                      type='tel'
                      name='phone'
                      value={formData.phone}
                      onChange={handleInputChange}
                      className='flex-1 bg-white px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                      placeholder='Número de teléfono'
                    />
                  ) : (
                    <span>{fixer.phone || 'No especificado'}</span>
                  )}
                </div>
                {isEditing && (
                  <div className='flex items-center gap-3 p-3 bg-gray-50 rounded-lg'>
                    <MessageSquare className='w-5 h-5 text-gray-500' />
                    <input
                      type='tel'
                      name='whatsapp'
                      value={formData.whatsapp}
                      onChange={handleInputChange}
                      className='flex-1 bg-white px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                      placeholder='WhatsApp (opcional)'
                    />
                  </div>
                )}
              </div>
            </div>

            {/* Services */}
            <div>
              <div className='flex justify-between items-center mb-4'>
                <h3 className='text-lg font-semibold text-gray-900'>Mis Servicios</h3>
                {isOwner && (
                  <button className='text-blue-600 text-sm hover:underline'>Gestionar</button>
                )}
              </div>
              <div className='flex flex-wrap gap-2'>
                {fixer.services.length > 0 ? (
                  fixer.services.map((service, index) => (
                    <span
                      key={index}
                      className='px-3 py-1.5 bg-blue-50 text-blue-700 text-sm rounded-full font-medium'
                    >
                      {service}
                    </span>
                  ))
                ) : (
                  <p className='text-gray-500'>Aún no se han agregado servicios</p>
                )}
              </div>

              {/* Payment Methods */}
              {fixer.paymentMethods?.length > 0 && (
                <div className='mt-6'>
                  <h4 className='text-sm font-medium text-gray-500 mb-2'>
                    Métodos de pago aceptados
                  </h4>
                  <div className='flex flex-wrap gap-2'>
                    {fixer.paymentMethods.map((method, index) => (
                      <span
                        key={index}
                        className='px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full'
                      >
                        {method}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Mapa de ubicación */}
          {fixer.location?.lat && fixer.location?.lng && (
            <LocationMap lat={fixer.location.lat} lng={fixer.location.lng} />
          )}

          {/* Estadísticas */}
          <div className='mt-12 grid grid-cols-1 lg:grid-cols-2 gap-8'>
            {/* Gráfico de tarjeta de fixer */}
            <div>
              <FixerGraficCard
                completedJobs={fixer.completedJobs ?? 0}
                cancelledJobs={fixer.cancelledJobs ?? 0}
                monthlyData={fixer.monthlyData}
              />
            </div>
            {/* Gráfico de estadísticas de trabajos */}
            <div>
              <JobStatistics />
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// ========================================
// Componente del mapa
// ========================================
function LocationMap({ lat, lng }: LocationMapProps) {
  const mapRef = useRef<HTMLDivElement | null>(null);
  const [mapLoaded, setMapLoaded] = useState(false);

  useEffect(() => {
    if (!document.getElementById('leaflet-css')) {
      const link = document.createElement('link');
      link.id = 'leaflet-css';
      link.rel = 'stylesheet';
      link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      document.head.appendChild(link);
    }

    if (!window.L) {
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.onload = () => setMapLoaded(true);
      document.body.appendChild(script);
    } else {
      setMapLoaded(true);
    }
  }, []);

  useEffect(() => {
    if (!mapLoaded || !mapRef.current || !window.L) return;

    const L = window.L;
    const map = L.map(mapRef.current).setView([lat, lng], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
      maxZoom: 19,
    }).addTo(map);

    L.marker([lat, lng]).addTo(map);

    return () => {
      map.remove();
    };
  }, [lat, lng, mapLoaded]);

  if (!mapLoaded) {
    return (
      <div className='mt-8'>
        <h3 className='text-lg font-semibold text-gray-900 mb-3'>Ubicación</h3>
        <div className='h-64 w-full rounded-xl border border-gray-200 bg-gray-100 flex items-center justify-center text-gray-500'>
          Cargando mapa...
        </div>
      </div>
    );
  }

  return (
    <div className='mt-12'>
      <h3 className='text-lg font-semibold text-gray-900 mb-3'>Ubicación</h3>
      <div ref={mapRef} className='h-64 w-full rounded-xl border border-gray-200' />
    </div>
  );
}
</file>

<file path="src/Components/fixer/dashboard/CertificationsSection.tsx">
'use client';

import { useState } from 'react';
import { PillButton } from '../Pill-button';
import {
  Plus,
  Edit2,
  Trash2,
  Award,
  ExternalLink,
  Calendar,
  Building2,
  Loader2,
} from 'lucide-react';
import { ICertification } from '@/types/fixer-profile';
import { Modal } from '@/Components/Modal';
import { useForm } from 'react-hook-form';
import NotificationModal from '@/Components/Modal-notifications';
import { useTranslations } from 'next-intl';
import {
  useGetCertificationsByFixerQuery,
  useCreateCertificationMutation,
  useUpdateCertificationMutation,
  useDeleteCertificationMutation,
} from '@/app/redux/services/certifications';

interface CertificationsSectionProps {
  readOnly?: boolean;
  fixerId?: string;
}

interface NotificationState {
  isOpen: boolean;
  type: 'success' | 'error' | 'info' | 'warning';
  title: string;
  message: string;
  onConfirm?: () => void;
}

export function CertificationsSection({ readOnly = false, fixerId }: CertificationsSectionProps) {
  const t = useTranslations('CertificationsSection');

  const { data: certs = [], isLoading } = useGetCertificationsByFixerQuery(fixerId || '', {
    skip: !fixerId,
    refetchOnMountOrArgChange: true,
  });

  const [createCertification, { isLoading: isCreating }] = useCreateCertificationMutation();
  const [updateCertification, { isLoading: isUpdating }] = useUpdateCertificationMutation();
  const [deleteCertification, { isLoading: isDeleting }] = useDeleteCertificationMutation();

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingCert, setEditingCert] = useState<ICertification | null>(null);

  const [notification, setNotification] = useState<NotificationState>({
    isOpen: false,
    type: 'info',
    title: '',
    message: '',
    onConfirm: undefined,
  });

  const { register, handleSubmit, reset, setValue } = useForm<ICertification>();

  const closeNotification = () => {
    setNotification((prev) => ({ ...prev, isOpen: false }));
  };

  const showSuccess = (message: string) => {
    setNotification({
      isOpen: true,
      type: 'success',
      title: t('notifications.success'),
      message,
      onConfirm: undefined,
    });
  };

  const showError = (message: string) => {
    setNotification({
      isOpen: true,
      type: 'error',
      title: t('notifications.error'),
      message,
      onConfirm: undefined,
    });
  };

  const handleOpenModal = (cert?: ICertification) => {
    if (readOnly) return;

    if (cert) {
      setEditingCert(cert);
      setValue('name', cert.name);
      setValue('institution', cert.institution);
      setValue(
        'issueDate',
        cert.issueDate ? new Date(cert.issueDate).toISOString().split('T')[0] : '',
      );
      setValue(
        'expiryDate',
        cert.expiryDate ? new Date(cert.expiryDate).toISOString().split('T')[0] : '',
      );
      setValue('credentialId', cert.credentialId);
      setValue('credentialUrl', cert.credentialUrl);
    } else {
      setEditingCert(null);
      reset({
        name: '',
        institution: '',
        issueDate: '',
        expiryDate: '',
        credentialId: '',
        credentialUrl: '',
      });
    }
    setIsModalOpen(true);
  };

  const handleCloseModal = () => {
    setIsModalOpen(false);
    setEditingCert(null);
    reset();
  };

  const onSubmit = async (data: ICertification) => {
    if (!fixerId) return;

    try {
      if (editingCert && editingCert._id) {
        await updateCertification({
          id: editingCert._id,
          data: { ...data, fixerId },
        }).unwrap();
        showSuccess(t('notifications.updateSuccess'));
      } else {
        await createCertification({
          ...data,
          fixerId,
        }).unwrap();
        showSuccess(t('notifications.createSuccess'));
      }
      handleCloseModal();
    } catch (error) {
      console.error(error);
      showError(t('notifications.saveError'));
    }
  };

  const handleDeleteClick = (id: string) => {
    if (readOnly) return;

    setNotification({
      isOpen: true,
      type: 'warning',
      title: t('notifications.deleteTitle'),
      message: t('notifications.deleteMessage'),
      onConfirm: () => confirmDelete(id),
    });
  };

  const confirmDelete = async (id: string) => {
    try {
      await deleteCertification(id).unwrap();
      setTimeout(() => {
        showSuccess(t('notifications.deleteSuccess'));
      }, 300);
    } catch (error) {
      console.error(error);
      setTimeout(() => {
        showError(t('notifications.deleteError'));
      }, 300);
    }
  };

  if (!fixerId) {
    return <div className='p-4 text-center text-gray-500'>{t('errors.noFixerProfile')}</div>;
  }

  if (isLoading)
    return (
      <div className='p-4 text-center flex justify-center'>
        <Loader2 className='animate-spin h-6 w-6' />
      </div>
    );

  return (
    <div className='space-y-6'>
      {/* Encabezado */}
      <div className='flex items-center justify-between'>
        <h2 className='text-xl font-semibold text-gray-900 flex items-center gap-2'>
          <Award className='h-5 w-5 text-blue-600' />
          {readOnly ? t('titles.certifications') : t('titles.myCertifications')}
        </h2>
        {!readOnly && (
          <PillButton
            onClick={() => handleOpenModal()}
            className='bg-primary text-white hover:bg-blue-800 flex items-center gap-2'
          >
            <Plus className='h-4 w-4' />
            {t('buttons.addCertification')}
          </PillButton>
        )}
      </div>

      {/* Lista de Certificaciones */}
      <div className='grid gap-4'>
        {certs.length === 0 && (
          <div className='text-gray-500 text-center py-8 border border-dashed border-gray-300 rounded-lg bg-gray-50'>
            {t('empty')}
          </div>
        )}

        {certs.map((cert) => (
          <div
            key={cert._id}
            className='group relative bg-white rounded-xl border border-gray-200 p-5 hover:shadow-md transition-all hover:border-blue-200'
          >
            <div className='flex justify-between items-start gap-4'>
              <div className='flex gap-4 w-full'>
                {/* Icono */}
                <div className='h-12 w-12 rounded-lg bg-blue-50 flex items-center justify-center shrink-0 text-blue-600 border border-blue-100'>
                  <Award className='h-6 w-6' />
                </div>

                {/* Contenido */}
                <div className='flex-1'>
                  <h3 className='font-semibold text-gray-900 text-lg leading-tight'>{cert.name}</h3>
                  <div className='flex items-center gap-2 text-gray-600 mt-1 font-medium'>
                    <Building2 className='h-4 w-4' />
                    <span>{cert.institution}</span>
                  </div>

                  <div className='flex flex-wrap gap-x-6 gap-y-2 mt-3 text-sm text-gray-500'>
                    <div className='flex items-center gap-1.5 bg-gray-50 px-2 py-1 rounded'>
                      <Calendar className='h-3.5 w-3.5' />
                      <span>
                        {t('card.issued')}:{' '}
                        {new Date(cert.issueDate).toLocaleDateString(undefined, {
                          timeZone: 'UTC',
                        })}
                      </span>
                    </div>
                    {cert.expiryDate && (
                      <div className='flex items-center gap-1.5 bg-gray-50 px-2 py-1 rounded'>
                        <Calendar className='h-3.5 w-3.5' />
                        <span>
                          {t('card.expires')}:{' '}
                          {new Date(cert.expiryDate).toLocaleDateString(undefined, {
                            timeZone: 'UTC',
                          })}
                        </span>
                      </div>
                    )}
                  </div>

                  {cert.credentialUrl && (
                    <a
                      href={cert.credentialUrl}
                      target='_blank'
                      rel='noopener noreferrer'
                      className='inline-flex items-center gap-1 text-blue-600 hover:text-blue-700 hover:underline text-sm mt-3 font-medium transition-colors'
                    >
                      {t('card.viewCredential')} <ExternalLink className='h-3 w-3' />
                    </a>
                  )}
                </div>
              </div>

              {/* Botones de acción */}
              {!readOnly && (
                <div className='flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity absolute top-4 right-4 md:static md:opacity-100'>
                  <button
                    onClick={() => handleOpenModal(cert)}
                    className='p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors'
                    title={t('tooltips.edit')}
                  >
                    <Edit2 className='h-4 w-4' />
                  </button>
                  <button
                    onClick={() => cert._id && handleDeleteClick(cert._id)}
                    disabled={isDeleting}
                    className='p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors disabled:opacity-50'
                    title={t('tooltips.delete')}
                  >
                    {isDeleting ? (
                      <Loader2 className='h-4 w-4 animate-spin' />
                    ) : (
                      <Trash2 className='h-4 w-4' />
                    )}
                  </button>
                </div>
              )}
            </div>
          </div>
        ))}
      </div>

      {/* Modal Formulario */}
      <Modal
        open={isModalOpen}
        onClose={handleCloseModal}
        title={editingCert ? t('modal.editTitle') : t('modal.newTitle')}
        size='lg'
        closeOnOverlayClick={!isCreating && !isUpdating}
        className='rounded-2xl border-primary border-2'
      >
        <Modal.Header className='text-center text-primary'>
          {editingCert ? t('modal.editTitle') : t('modal.newTitle')}
        </Modal.Header>
        <Modal.Body>
          <form id='certificationForm' onSubmit={handleSubmit(onSubmit)} className='space-y-4'>
            <div>
              <label className='block text-sm font-medium text-gray-700 mb-1'>
                {t('form.name.label')}
              </label>
              <input
                {...register('name', { required: true })}
                className='w-full rounded-lg border-primary border focus:outline-none py-2 px-3'
                placeholder={t('form.name.placeholder')}
              />
            </div>

            <div>
              <label className='block text-sm font-medium text-gray-700 mb-1'>
                {t('form.institution.label')}
              </label>
              <input
                {...register('institution', { required: true })}
                className='w-full rounded-lg border-primary border focus:outline-none py-2 px-3'
                placeholder={t('form.institution.placeholder')}
              />
            </div>

            <div className='grid grid-cols-2 gap-4'>
              <div>
                <label className='block text-sm font-medium text-gray-700 mb-1'>
                  {t('form.issueDate.label')}
                </label>
                <input
                  type='date'
                  {...register('issueDate', { required: true })}
                  className='w-full rounded-lg border-primary border focus:outline-none py-2 px-3 bg-white'
                />
              </div>
              <div>
                <label className='block text-sm font-medium text-gray-700 mb-1'>
                  {t('form.expiryDate.label')}{' '}
                  <span className='text-gray-400 font-normal'>({t('form.optional')})</span>
                </label>
                <input
                  type='date'
                  {...register('expiryDate')}
                  className='w-full rounded-lg border-primary border focus:outline-none py-2 px-3 bg-white'
                />
              </div>
            </div>

            <div>
              <label className='block text-sm font-medium text-gray-700 mb-1'>
                {t('form.credentialId.label')}{' '}
                <span className='text-gray-400 font-normal'>({t('form.optional')})</span>
              </label>
              <input
                {...register('credentialId')}
                className='w-full rounded-lg border-primary border focus:outline-none py-2 px-3'
                placeholder={t('form.credentialId.placeholder')}
              />
            </div>

            <div>
              <label className='block text-sm font-medium text-gray-700 mb-1'>
                {t('form.credentialUrl.label')}{' '}
                <span className='text-gray-400 font-normal'>({t('form.optional')})</span>
              </label>
              <input
                {...register('credentialUrl')}
                type='url'
                className='w-full rounded-lg border-primary border focus:outline-none py-2 px-3'
                placeholder={t('form.credentialUrl.placeholder')}
              />
            </div>
          </form>
        </Modal.Body>
        <Modal.Footer>
          <div className='flex justify-end gap-2'>
            <button
              type='button'
              onClick={handleCloseModal}
              className='border border-primary py-2 px-4 rounded-2xl text-primary hover:text-white hover:bg-primary transition-colors'
            >
              {t('buttons.cancel')}
            </button>
            <PillButton
              type='submit'
              form='certificationForm'
              className='bg-primary text-white hover:bg-blue-800'
              disabled={isCreating || isUpdating}
            >
              {(isCreating || isUpdating) && <Loader2 className='animate-spin h-4 w-4 mr-2' />}
              {isCreating || isUpdating ? t('buttons.saving') : t('buttons.save')}
            </PillButton>
          </div>
        </Modal.Footer>
      </Modal>

      {/* Modal de Notificaciones */}
      <NotificationModal
        isOpen={notification.isOpen}
        onClose={closeNotification}
        type={notification.type}
        title={notification.title}
        message={notification.message}
        onConfirm={notification.onConfirm}
        confirmText={t('buttons.delete')}
        cancelText={t('buttons.cancel')}
      />
    </div>
  );
}
</file>

<file path="src/Components/fixer/dashboard/ExperienceSection.tsx">
'use client';

import { useState } from 'react';
import { PillButton } from '../Pill-button';
import { Plus, Edit2, Trash2, Building2, Calendar, Briefcase, Loader2 } from 'lucide-react';
import { IExperience } from '@/types/fixer-profile';
import { Modal } from '@/Components/Modal';
import { useForm } from 'react-hook-form';
import { useTranslations } from 'next-intl';
import NotificationModal from '@/Components/Modal-notifications';
import {
  useGetExperiencesByFixerQuery,
  useCreateExperienceMutation,
  useUpdateExperienceMutation,
  useDeleteExperienceMutation,
} from '@/app/redux/services/experiencesApi';
import { FetchBaseQueryError } from '@reduxjs/toolkit/query';

// Type guards para errores de API
function isFetchBaseQueryError(error: unknown): error is FetchBaseQueryError {
  return typeof error === 'object' && error != null && 'status' in error;
}

function isErrorWithMessage(error: unknown): error is { message: string } {
  return (
    typeof error === 'object' &&
    error != null &&
    'message' in error &&
    typeof (error as { message: unknown }).message === 'string'
  );
}

function isErrorWithData(error: unknown): error is { data: { message?: string } } {
  return (
    typeof error === 'object' &&
    error != null &&
    'data' in error &&
    typeof (error as { data: unknown }).data === 'object'
  );
}

interface ExperienceSectionProps {
  readOnly?: boolean;
  fixerId?: string;
}

export function ExperienceSection({ readOnly = false, fixerId }: ExperienceSectionProps) {
  const t = useTranslations('ExperienceSection');
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingExp, setEditingExp] = useState<IExperience | null>(null);
  const [pendingDelete, setPendingDelete] = useState<string | null>(null);
  const [notification, setNotification] = useState({
    isOpen: false,
    type: 'success',
    title: '',
    message: '',
  });

  const {
    register,
    handleSubmit,
    reset,
    setValue,
    watch,
    formState: { errors },
  } = useForm<Omit<IExperience, '_id' | 'createdAt' | 'updatedAt'>>();

  const isCurrent = watch('isCurrent');

  const {
    data: experiences = [],
    isLoading,
    isError,
    refetch,
  } = useGetExperiencesByFixerQuery(fixerId!, {
    skip: !fixerId,
  });

  const [createExperience, { isLoading: isCreating }] = useCreateExperienceMutation();
  const [updateExperience] = useUpdateExperienceMutation();
  const [deleteExperience] = useDeleteExperienceMutation();

  const handleOpenModal = (exp?: IExperience) => {
    if (readOnly) return;
    if (exp) {
      setEditingExp(exp);
      setValue('jobTitle', exp.jobTitle);
      setValue('organization', exp.organization);
      setValue('jobType', exp.jobType);
      setValue('isCurrent', exp.isCurrent);
      setValue('startDate', exp.startDate.split('T')[0]);
      setValue('endDate', exp.endDate ? exp.endDate.split('T')[0] : '');
    } else {
      setEditingExp(null);
      reset({
        jobTitle: '',
        jobType: 'Tiempo completo',
        organization: '',
        isCurrent: false,
        startDate: '',
        endDate: '',
      });
    }
    setIsModalOpen(true);
  };

  const handleCloseModal = () => {
    setIsModalOpen(false);
    setEditingExp(null);
    reset();
  };

  const onSubmit = async (data: Omit<IExperience, '_id' | 'createdAt' | 'updatedAt'>) => {
    if (!fixerId) return;

    try {
      if (editingExp?._id) {
        await updateExperience({ id: editingExp._id, data }).unwrap();
        setNotification({
          isOpen: true,
          type: 'success',
          title: t('notifications.success'),
          message: t('notifications.updateSuccess'),
        });
      } else {
        await createExperience({ ...data, fixerId }).unwrap();
        setNotification({
          isOpen: true,
          type: 'success',
          title: t('notifications.success'),
          message: t('notifications.createSuccess'),
        });
      }

      handleCloseModal();
      refetch();
    } catch (error) {
      let errorMessage = t('notifications.genericError');

      if (isFetchBaseQueryError(error)) {
        errorMessage = 'error' in error ? String(error.error) : JSON.stringify(error.data);
      } else if (isErrorWithData(error) && error.data.message) {
        errorMessage = error.data.message;
      } else if (isErrorWithMessage(error)) {
        errorMessage = error.message;
      }

      setNotification({
        isOpen: true,
        type: 'error',
        title: t('notifications.error'),
        message: errorMessage,
      });
    }
  };

  const handleDelete = (id: string) => {
    if (readOnly) return;
    setPendingDelete(id);
    setNotification({
      isOpen: true,
      type: 'warning',
      title: t('notifications.deleteTitle'),
      message: t('notifications.deleteMessage'),
    });
  };

  const confirmDelete = async () => {
    if (!pendingDelete) return;
    try {
      await deleteExperience(pendingDelete).unwrap();
      refetch();
      setNotification({
        isOpen: true,
        type: 'success',
        title: t('notifications.deleteSuccessTitle'),
        message: t('notifications.deleteSuccess'),
      });
      setPendingDelete(null);
    } catch (error) {
      let errorMessage = t('notifications.genericError');

      if (isFetchBaseQueryError(error)) {
        errorMessage = 'error' in error ? String(error.error) : JSON.stringify(error.data);
      } else if (isErrorWithData(error) && error.data.message) {
        errorMessage = error.data.message;
      } else if (isErrorWithMessage(error)) {
        errorMessage = error.message;
      }

      setNotification({
        isOpen: true,
        type: 'error',
        title: t('notifications.error'),
        message: errorMessage,
      });
      setPendingDelete(null);
    }
  };

  const cancelDelete = () => {
    setPendingDelete(null);
    setNotification((prev) => ({ ...prev, isOpen: false }));
  };

  if (isLoading) return <div className='text-center p-8'>{t('loading')}</div>;
  if (isError) return <div className='text-center p-8 text-red-600'>{t('errors.loadError')}</div>;

  return (
    <div className='space-y-6'>
      <NotificationModal
        isOpen={notification.isOpen}
        onClose={() => {
          setNotification((prev) => ({ ...prev, isOpen: false }));
        }}
        type={notification.type as 'success' | 'error' | 'info' | 'warning'}
        title={notification.title}
        message={notification.message}
        autoClose={notification.type !== 'warning'}
        autoCloseDelay={5000}
        onConfirm={pendingDelete ? confirmDelete : undefined}
        onCancel={pendingDelete ? cancelDelete : undefined}
      />

      <div className='flex items-center justify-between'>
        <h2 className='text-xl font-semibold text-gray-900 flex items-center gap-2'>
          <Building2 className='h-5 w-5 text-blue-600' />
          {readOnly ? t('titles.experience') : t('titles.myExperience')}
        </h2>
        {!readOnly && (
          <PillButton
            onClick={() => handleOpenModal()}
            className='bg-primary text-white hover:bg-blue-800 flex items-center gap-2'
          >
            <Plus className='h-4 w-4' />
            {t('buttons.addExperience')}
          </PillButton>
        )}
      </div>

      {experiences.length === 0 ? (
        <div className='text-center p-8 text-gray-500'>
          {readOnly ? t('empty.readOnly') : t('empty.editable')}
        </div>
      ) : (
        <div className='relative border-l-2 border-gray-200 ml-3 space-y-8 py-2'>
          {experiences.map((exp) => (
            <div key={exp._id} className='relative pl-8 group'>
              <div className='absolute -left-[9px] top-1 h-4 w-4 rounded-full border-2 border-white bg-blue-600 shadow-sm' />

              <div className='bg-white rounded-xl border border-gray-200 p-5 hover:shadow-md transition-all hover:border-blue-200'>
                <div className='flex justify-between items-start gap-4'>
                  <div className='space-y-2'>
                    <div>
                      <h3 className='font-semibold text-gray-900 text-lg'>{exp.jobTitle}</h3>
                      <div className='flex items-center gap-2 text-gray-600 font-medium'>
                        <Briefcase className='h-4 w-4' />
                        <span>{exp.organization}</span>
                      </div>
                    </div>

                    <div className='flex flex-wrap gap-4 text-sm text-gray-500'>
                      <span className='inline-flex items-center gap-1.5 bg-gray-50 px-2.5 py-1 rounded-md'>
                        <Calendar className='h-3.5 w-3.5' />
                        {new Date(exp.startDate).toLocaleDateString()} -{' '}
                        {exp.isCurrent
                          ? t('card.present')
                          : exp.endDate
                            ? new Date(exp.endDate).toLocaleDateString()
                            : ''}
                      </span>
                      <span className='px-2.5 py-1 bg-blue-50 text-blue-700 rounded-md font-medium text-xs uppercase tracking-wide'>
                        {exp.jobType}
                      </span>
                    </div>
                  </div>

                  {!readOnly && (
                    <div className='flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity'>
                      <button
                        onClick={() => handleOpenModal(exp)}
                        className='p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors'
                        title={t('tooltips.edit')}
                      >
                        <Edit2 className='h-4 w-4' />
                      </button>
                      <button
                        onClick={() => handleDelete(exp._id!)}
                        className='p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors'
                        title={t('tooltips.delete')}
                      >
                        <Trash2 className='h-4 w-4' />
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      <Modal
        open={isModalOpen}
        onClose={handleCloseModal}
        title={editingExp ? t('modal.editTitle') : t('modal.newTitle')}
        size='lg'
        closeOnOverlayClick={!isCreating}
        className='rounded-2xl border-primary border-2'
      >
        <Modal.Header className='text-center text-primary'>
          {editingExp ? t('modal.editTitle') : t('modal.newTitle')}
        </Modal.Header>
        <Modal.Body>
          <form id='experienceForm' onSubmit={handleSubmit(onSubmit)} className='space-y-4'>
            <div>
              <label className='block text-sm font-medium text-gray-700 mb-1'>
                {t('form.jobTitle.label')} *
              </label>
              <input
                {...register('jobTitle', { required: t('form.jobTitle.required') })}
                className={`w-full rounded-lg border ${errors.jobTitle ? 'border-red-500' : 'border-primary'} focus:outline-none py-2 px-3`}
                placeholder={t('form.jobTitle.placeholder')}
              />
              {errors.jobTitle && (
                <p className='mt-1 text-sm text-red-600'>{errors.jobTitle.message}</p>
              )}
            </div>

            <div>
              <label className='block text-sm font-medium text-gray-700 mb-1'>
                {t('form.organization.label')} *
              </label>
              <input
                {...register('organization', { required: t('form.organization.required') })}
                className={`w-full rounded-lg border ${errors.organization ? 'border-red-500' : 'border-primary'} focus:outline-none py-2 px-3`}
                placeholder={t('form.organization.placeholder')}
              />
              {errors.organization && (
                <p className='mt-1 text-sm text-red-600'>{errors.organization.message}</p>
              )}
            </div>

            <div>
              <label className='block text-sm font-medium text-gray-700 mb-1'>
                {t('form.jobType.label')} *
              </label>
              <select
                {...register('jobType', { required: t('form.jobType.required') })}
                className={`w-full rounded-lg border ${errors.jobType ? 'border-red-500' : 'border-primary'} focus:outline-none py-2 px-3 bg-white`}
              >
                <option value=''>{t('form.jobType.select')}</option>
                <option value='Tiempo completo'>{t('form.jobType.options.fullTime')}</option>
                <option value='Medio tiempo'>{t('form.jobType.options.partTime')}</option>
                <option value='Contrato'>{t('form.jobType.options.contract')}</option>
                <option value='Freelance'>{t('form.jobType.options.freelance')}</option>
              </select>
              {errors.jobType && (
                <p className='mt-1 text-sm text-red-600'>{errors.jobType.message}</p>
              )}
            </div>

            <div className='grid grid-cols-2 gap-4'>
              <div>
                <label className='block text-sm font-medium text-gray-700 mb-1'>
                  {t('form.startDate.label')} *
                </label>
                <input
                  type='date'
                  {...register('startDate', { required: t('form.startDate.required') })}
                  className={`w-full rounded-lg border ${errors.startDate ? 'border-red-500' : 'border-primary'} focus:outline-none py-2 px-3 bg-white`}
                />
                {errors.startDate && (
                  <p className='mt-1 text-sm text-red-600'>{errors.startDate.message}</p>
                )}
              </div>

              <div>
                <label className='block text-sm font-medium text-gray-700 mb-1'>
                  {t('form.endDate.label')}
                </label>
                <input
                  type='date'
                  {...register('endDate', { required: !isCurrent })}
                  disabled={isCurrent}
                  className='w-full rounded-lg border border-primary focus:outline-none py-2 px-3 bg-white disabled:bg-gray-100 disabled:text-gray-400'
                />
              </div>
            </div>

            <div className='flex items-center gap-2 py-2'>
              <input
                type='checkbox'
                id='isCurrent'
                {...register('isCurrent')}
                className='h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500'
              />
              <label htmlFor='isCurrent' className='text-sm font-medium text-gray-700'>
                {t('form.isCurrent.label')}
              </label>
            </div>
          </form>
        </Modal.Body>
        <Modal.Footer>
          <div className='flex justify-end gap-2'>
            <button
              type='button'
              onClick={handleCloseModal}
              className='border border-primary py-2 px-4 rounded-2xl text-primary hover:text-white hover:bg-primary transition-colors'
              disabled={isCreating}
            >
              {t('buttons.cancel')}
            </button>
            <PillButton
              type='submit'
              form='experienceForm'
              className='bg-primary text-white hover:bg-blue-800 flex items-center gap-2'
              disabled={isCreating}
            >
              {isCreating && <Loader2 className='h-4 w-4 animate-spin' />}
              {isCreating ? t('buttons.saving') : t('buttons.save')}
            </PillButton>
          </div>
        </Modal.Footer>
      </Modal>
    </div>
  );
}
</file>

<file path="src/Components/fixer/dashboard/LocationSection.tsx">
'use client';

import { useCallback, useEffect, useMemo, useRef, useState } from 'react';
import { MapPin, Edit2, Check, X, Loader2 } from 'lucide-react';
import { PillButton } from '../Pill-button';
import NotificationModal from '@/Components/Modal-notifications';
import { useUpdateLocationMutation } from '@/app/redux/services/userApi';

interface Location {
  lat: number;
  lng: number;
  direccion?: string;
}

interface LocationSectionProps {
  readOnly?: boolean;
  fixerId?: string;
  currentLocation: {
    lat: number;
    lng: number;
    direccion?: string;
  };
}

// Tipos de Leaflet
type LeafletMap = L.Map;
type LeafletMarker = L.Marker;
type LeafletMouseEvent = L.LeafletMouseEvent;

declare global {
  interface Window {
    L: typeof import('leaflet');
  }
}

export function LocationSection({
  readOnly = false,
  fixerId,
  currentLocation,
}: LocationSectionProps) {
  const mapRef = useRef<HTMLDivElement>(null);
  const [mapLoaded, setMapLoaded] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [selectedLocation, setSelectedLocation] = useState<Location | null>(
    currentLocation || null,
  );
  const [manualLat, setManualLat] = useState(currentLocation?.lat.toString() || '');
  const [manualLng, setManualLng] = useState(currentLocation?.lng.toString() || '');
  const [outOfBounds, setOutOfBounds] = useState(false);
  const [notification, setNotification] = useState({
    isOpen: false,
    type: 'success' as 'success' | 'error' | 'info' | 'warning',
    title: '',
    message: '',
  });

  const [updateLocation, { isLoading: isUpdating }] = useUpdateLocationMutation();

  const COCHABAMBA_BOUNDS = useMemo(
    () => ({
      north: -17.2,
      south: -17.6,
      east: -65.8,
      west: -66.4,
    }),
    [],
  );

  // Cargar Leaflet CSS y JS
  useEffect(() => {
    if (!document.getElementById('leaflet-css')) {
      const link = document.createElement('link');
      link.id = 'leaflet-css';
      link.rel = 'stylesheet';
      link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      document.head.appendChild(link);
    }

    if (!window.L) {
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.onload = () => setMapLoaded(true);
      document.body.appendChild(script);
    } else {
      setMapLoaded(true);
    }
  }, []);

  const isInCochabamba = useCallback(
    (lat: number, lng: number): boolean => {
      return (
        lat >= COCHABAMBA_BOUNDS.south &&
        lat <= COCHABAMBA_BOUNDS.north &&
        lng >= COCHABAMBA_BOUNDS.west &&
        lng <= COCHABAMBA_BOUNDS.east
      );
    },
    [COCHABAMBA_BOUNDS],
  );

  // Inicializar mapa
  useEffect(() => {
    if (!mapLoaded || !mapRef.current) return;

    const map: LeafletMap = window.L.map(mapRef.current).setView(
      selectedLocation ? [selectedLocation.lat, selectedLocation.lng] : [-17.3935, -66.157],
      selectedLocation ? 15 : 13,
    );

    window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 19,
    }).addTo(map);

    const bounds = window.L.latLngBounds(
      window.L.latLng(COCHABAMBA_BOUNDS.south, COCHABAMBA_BOUNDS.west),
      window.L.latLng(COCHABAMBA_BOUNDS.north, COCHABAMBA_BOUNDS.east),
    );
    map.setMaxBounds(bounds);
    map.on('drag', () => {
      map.panInsideBounds(bounds, { animate: false });
    });

    let marker: LeafletMarker | null = null;

    if (selectedLocation && isInCochabamba(selectedLocation.lat, selectedLocation.lng)) {
      marker = window.L.marker([selectedLocation.lat, selectedLocation.lng]).addTo(map);
      setOutOfBounds(false);
    }

    // Solo permitir clicks si está en modo edición y no es readOnly
    if (!readOnly && isEditing) {
      map.on('click', (e: L.LeafletEvent) => {
        const mouseEvent = e as LeafletMouseEvent;
        const { lat, lng } = mouseEvent.latlng;

        if (!isInCochabamba(lat, lng)) {
          setOutOfBounds(true);
          return;
        }

        setOutOfBounds(false);

        if (marker) {
          map.removeLayer(marker);
        }

        marker = window.L.marker([lat, lng]).addTo(map);

        setSelectedLocation({ lat, lng });
        setManualLat(lat.toFixed(6));
        setManualLng(lng.toFixed(6));
      });
    }

    return () => {
      map.remove();
    };
  }, [mapLoaded, selectedLocation, isEditing, readOnly, isInCochabamba, COCHABAMBA_BOUNDS]);

  const handleManualUpdate = () => {
    const lat = Number.parseFloat(manualLat);
    const lng = Number.parseFloat(manualLng);

    if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
      if (isInCochabamba(lat, lng)) {
        setOutOfBounds(false);
        setSelectedLocation({ lat, lng });
      } else {
        setOutOfBounds(true);
      }
    }
  };

  const handleSave = async () => {
    if (!fixerId || !selectedLocation) return;

    try {
      await updateLocation({
        id: fixerId,
        location: {
          lat: selectedLocation.lat,
          lng: selectedLocation.lng,
          direccion: selectedLocation.direccion || '',
        },
      }).unwrap();

      setNotification({
        isOpen: true,
        type: 'success',
        title: '¡Éxito!',
        message: 'Ubicación actualizada correctamente',
      });
      setIsEditing(false);
    } catch (error) {
      console.error(error);
      setNotification({
        isOpen: true,
        type: 'error',
        title: 'Error',
        message: 'No se pudo actualizar la ubicación',
      });
    }
  };

  const handleCancel = () => {
    setIsEditing(false);
    setSelectedLocation(currentLocation || null);
    setManualLat(currentLocation?.lat.toString() || '');
    setManualLng(currentLocation?.lng.toString() || '');
    setOutOfBounds(false);
  };

  if (!fixerId) {
    return (
      <div className='p-4 text-center text-gray-500'>
        No se puede cargar la ubicación sin un perfil de fixer.
      </div>
    );
  }

  return (
    <div className='space-y-6'>
      <NotificationModal
        isOpen={notification.isOpen}
        onClose={() => setNotification((prev) => ({ ...prev, isOpen: false }))}
        type={notification.type}
        title={notification.title}
        message={notification.message}
        autoClose
        autoCloseDelay={3000}
      />

      {/* Header */}
      <div className='flex items-center justify-between'>
        <h2 className='text-xl font-semibold text-gray-900 flex items-center gap-2'>
          <MapPin className='h-5 w-5 text-blue-600' />
          {readOnly ? 'Ubicación de Trabajo' : 'Mi Ubicación de Trabajo'}
        </h2>
        {!readOnly && !isEditing && (
          <PillButton
            onClick={() => setIsEditing(true)}
            className='bg-primary text-white hover:bg-blue-800 flex items-center gap-2'
          >
            <Edit2 className='h-4 w-4' />
            Editar Ubicación
          </PillButton>
        )}
      </div>

      {/* Información */}
      <div className='space-y-4'>
        {isEditing && (
          <div className='rounded-lg bg-amber-50 p-3 border border-amber-200'>
            <p className='text-sm text-amber-800 font-medium'>⚠️ Restricción de ubicación</p>
            <p className='text-xs text-amber-700 mt-1'>
              Solo puedes seleccionar ubicaciones dentro del departamento de Cochabamba, Bolivia.
              Haz clic en el mapa para actualizar tu ubicación.
            </p>
          </div>
        )}

        {/* Mapa */}
        <div
          ref={mapRef}
          className={`h-96 w-full rounded-xl border ${isEditing ? 'border-blue-500 ring-2 ring-blue-200' : 'border-gray-300'} bg-gray-100 ${!mapLoaded ? 'flex items-center justify-center' : ''}`}
        >
          {!mapLoaded && <Loader2 className='animate-spin h-8 w-8 text-blue-600' />}
        </div>

        {/* Mensaje de fuera de límites */}
        {outOfBounds && isEditing && (
          <div className='rounded-lg bg-red-50 p-3 border border-red-200'>
            <p className='text-sm text-red-800 font-medium'>Ubicación fuera de Cochabamba</p>
            <p className='text-xs text-red-700 mt-1'>
              La ubicación seleccionada está fuera de la región de Cochabamba. Por favor, selecciona
              una ubicación dentro del departamento.
            </p>
          </div>
        )}

        {/* Coordenadas actuales */}
        {selectedLocation && selectedLocation.lat !== 0 && selectedLocation.lng !== 0 && (
          <div className='space-y-2 rounded-lg bg-blue-50 p-4'>
            <p className='text-sm font-medium text-blue-900'>
              {isEditing ? 'Ubicación seleccionada:' : 'Ubicación actual:'}
            </p>
            <div className='grid grid-cols-2 gap-3'>
              <div>
                <label className='text-xs font-medium text-blue-700 block mb-1'>Latitud</label>
                <input
                  type='number'
                  step='0.000001'
                  value={manualLat}
                  onChange={(e) => setManualLat(e.target.value)}
                  disabled={!isEditing}
                  className='w-full rounded-md border border-blue-200 bg-white px-3 py-2 text-sm disabled:bg-gray-50 disabled:text-gray-600'
                />
              </div>
              <div>
                <label className='text-xs font-medium text-blue-700 block mb-1'>Longitud</label>
                <input
                  type='number'
                  step='0.000001'
                  value={manualLng}
                  onChange={(e) => setManualLng(e.target.value)}
                  disabled={!isEditing}
                  className='w-full rounded-md border border-blue-200 bg-white px-3 py-2 text-sm disabled:bg-gray-50 disabled:text-gray-600'
                />
              </div>
            </div>
            {isEditing && (
              <button
                type='button'
                onClick={handleManualUpdate}
                className='w-full rounded-md bg-blue-600 px-3 py-2 text-sm font-medium text-white hover:bg-blue-700 transition-colors'
              >
                Actualizar desde coordenadas
              </button>
            )}
          </div>
        )}

        {/* Sin ubicación */}
        {!selectedLocation && (
          <div className='text-center py-8 border border-dashed border-gray-300 rounded-lg bg-gray-50'>
            <MapPin className='h-12 w-12 text-gray-400 mx-auto mb-2' />
            <p className='text-gray-500 text-sm'>
              {readOnly
                ? 'Este fixer aún no ha registrado su ubicación de trabajo.'
                : 'Aún no has registrado tu ubicación de trabajo.'}
            </p>
            {!readOnly && !isEditing && (
              <PillButton
                onClick={() => setIsEditing(true)}
                className='mt-4 bg-primary text-white hover:bg-blue-800'
              >
                Agregar Ubicación
              </PillButton>
            )}
          </div>
        )}

        {/* Botones de acción en modo edición */}
        {isEditing && (
          <div className='flex justify-end gap-3'>
            <button
              onClick={handleCancel}
              disabled={isUpdating}
              className='flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-full text-gray-700 hover:bg-gray-50 transition-colors disabled:opacity-50'
            >
              <X className='h-4 w-4' />
              Cancelar
            </button>
            <PillButton
              onClick={handleSave}
              disabled={isUpdating || !selectedLocation || outOfBounds}
              className='bg-primary text-white hover:bg-blue-800 flex items-center gap-2 disabled:opacity-50'
            >
              {isUpdating ? (
                <>
                  <Loader2 className='h-4 w-4 animate-spin' />
                  Guardando...
                </>
              ) : (
                <>
                  <Check className='h-4 w-4' />
                  Guardar Ubicación
                </>
              )}
            </PillButton>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/Components/fixer/dashboard/PortfolioSection.tsx">
'use client';

import { useEffect, useState } from 'react';
import { PillButton } from '../Pill-button';
import {
  Plus,
  Trash2,
  Image as ImageIcon,
  Video,
  X,
  CheckCircle,
  XCircle,
  Loader2,
} from 'lucide-react';
import { Modal } from '@/Components/Modal';
import NotificationModal from '@/Components/Modal-notifications';
import { useForm } from 'react-hook-form';
import Image from 'next/image';
import { useTranslations } from 'next-intl';

import {
  useGetPortfolioByFixerQuery,
  useCreatePortfolioItemMutation,
  useDeletePortfolioItemMutation,
} from '@/app/redux/services/portafolioApi';
import { isApiError } from '@/app/redux/services/baseApi';

type PortfolioFormValues = {
  type: 'image' | 'video';
  url?: string;
  youtubeUrl?: string;
};

interface PortfolioSectionProps {
  readOnly?: boolean;
  fixerId?: string;
}

function getYouTubeId(rawUrl?: string): string | undefined {
  if (!rawUrl) return undefined;
  try {
    const url = new URL(rawUrl);
    if (url.hostname.includes('youtu.be')) return url.pathname.replace('/', '');
    const vParam = url.searchParams.get('v');
    if (vParam) return vParam;
    const parts = url.pathname.split('/');
    return parts[parts.length - 1] || undefined;
  } catch {
    return undefined;
  }
}

export function PortfolioSection({ readOnly = false, fixerId }: PortfolioSectionProps) {
  const t = useTranslations('PortfolioSection');

  const effectiveFixerId = fixerId || '69285d2860ea986813517593';

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [modalType, setModalType] = useState<'image' | 'video'>('image');
  const [fullscreenImage, setFullscreenImage] = useState<string | null>(null);

  const [previewUrl, setPreviewUrl] = useState<string>('');
  const [isValidUrl, setIsValidUrl] = useState<boolean | null>(null);
  const [isValidating, setIsValidating] = useState(false);

  const [deleteId, setDeleteId] = useState<string | null>(null);
  const [notification, setNotification] = useState({
    isOpen: false,
    type: 'success',
    title: '',
    message: '',
  });

  const {
    data: items = [],
    isLoading,
    isError,
  } = useGetPortfolioByFixerQuery(effectiveFixerId, {
    skip: !effectiveFixerId,
  });

  const [createItem, { isLoading: isCreating }] = useCreatePortfolioItemMutation();
  const [deleteItem, { isLoading: isDeleting }] = useDeletePortfolioItemMutation();

  const { register, handleSubmit, reset, watch } = useForm<PortfolioFormValues>();
  const watchedUrl = watch('url');

  useEffect(() => {
    if (!watchedUrl || modalType !== 'image') {
      setPreviewUrl('');
      setIsValidUrl(null);
      return;
    }

    const timeoutId = setTimeout(() => {
      setIsValidating(true);
      const img = document.createElement('img');
      img.onload = () => {
        setIsValidUrl(true);
        setPreviewUrl(watchedUrl);
        setIsValidating(false);
      };
      img.onerror = () => {
        setIsValidUrl(false);
        setPreviewUrl('');
        setIsValidating(false);
      };
      img.src = watchedUrl;
    }, 500);

    return () => clearTimeout(timeoutId);
  }, [watchedUrl, modalType]);

  const getErrorMessage = (error: unknown) => {
    if (isApiError(error)) return error.data.message || t('errors.unknown');
    return t('errors.unexpected');
  };

  const showNotification = (
    type: 'success' | 'error' | 'warning',
    title: string,
    message: string,
  ) => {
    setNotification({ isOpen: true, type, title, message });
  };

  const handleOpenModal = (type: 'image' | 'video') => {
    if (readOnly) return;
    setModalType(type);
    setPreviewUrl('');
    setIsValidUrl(null);
    reset({ type, url: '', youtubeUrl: '' });
    setIsModalOpen(true);
  };

  const handleCloseModal = () => {
    setIsModalOpen(false);
    reset();
    setPreviewUrl('');
    setIsValidUrl(null);
  };

  const onSubmit = async (data: PortfolioFormValues) => {
    try {
      let finalUrl = data.url;

      if (data.type === 'image') {
        if (!finalUrl) {
          showNotification('error', t('notifications.requiredField'), t('notifications.enterUrl'));
          return;
        }
        if (isValidUrl !== true) {
          showNotification(
            'error',
            t('notifications.invalidUrl'),
            t('notifications.imageLoadError'),
          );
          return;
        }
      }

      if (data.type === 'video' && data.youtubeUrl) {
        const videoId = getYouTubeId(data.youtubeUrl);
        if (videoId) {
          if (!finalUrl) {
            finalUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
          }
        } else {
          showNotification('error', t('notifications.invalidUrl'), t('notifications.videoIdError'));
          return;
        }
      }

      const payload = {
        type: data.type,
        url: finalUrl,
        youtubeUrl: data.youtubeUrl,
        fixerId: effectiveFixerId,
      };

      await createItem(payload).unwrap();

      showNotification('success', t('notifications.success'), t('notifications.itemAdded'));
      handleCloseModal();
    } catch (error) {
      showNotification('error', t('notifications.saveError'), getErrorMessage(error));
    }
  };

  const handleDeleteRequest = (id: string) => {
    if (readOnly) return;
    setDeleteId(id);
    showNotification('warning', t('notifications.confirmDelete'), t('notifications.deleteWarning'));
  };

  const confirmDelete = async () => {
    if (!deleteId) return;
    try {
      await deleteItem(deleteId).unwrap();
      showNotification('success', t('notifications.deleted'), t('notifications.deletedSuccess'));
      setDeleteId(null);
    } catch (error) {
      showNotification('error', t('notifications.error'), getErrorMessage(error));
      setDeleteId(null);
    }
  };

  const cancelDelete = () => {
    setDeleteId(null);
  };

  if (isLoading) return <div className='text-center p-8 text-gray-500'>{t('loading')}</div>;
  if (isError) return <div className='text-center p-8 text-red-500'>{t('loadError')}</div>;

  return (
    <div className='space-y-6'>
      <NotificationModal
        isOpen={notification.isOpen}
        onClose={() => setNotification((prev) => ({ ...prev, isOpen: false }))}
        type={notification.type as 'success' | 'error' | 'warning'}
        title={notification.title}
        message={notification.message}
        autoClose={notification.type !== 'warning'}
        autoCloseDelay={5000}
        onConfirm={deleteId ? confirmDelete : undefined}
        onCancel={deleteId ? cancelDelete : undefined}
      />

      <div className='flex items-center justify-between'>
        <h2 className='text-xl font-semibold text-gray-900 flex items-center gap-2'>
          <ImageIcon className='h-5 w-5 text-blue-600' />
          {readOnly ? t('titles.portfolio') : t('titles.myPortfolio')}
        </h2>

        {!readOnly && (
          <div className='flex gap-2'>
            <PillButton
              onClick={() => handleOpenModal('video')}
              className='bg-primary text-white hover:bg-blue-800 flex items-center gap-2'
            >
              <Video className='h-4 w-4' />
              {t('buttons.video')}
            </PillButton>

            <PillButton
              onClick={() => handleOpenModal('image')}
              className='bg-primary text-white hover:bg-blue-800 flex items-center gap-2'
            >
              <Plus className='h-4 w-4' />
              {t('buttons.image')}
            </PillButton>
          </div>
        )}
      </div>

      {items.length === 0 ? (
        <div className='text-center p-12 bg-gray-50 rounded-xl border border-dashed border-gray-300'>
          <p className='text-gray-500'>{t('emptyState')}</p>
        </div>
      ) : (
        <div className='grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4'>
          {items.map((item) => {
            const isVideo = item.type === 'video';
            const videoId = getYouTubeId(item.youtubeUrl || undefined);
            const hasUrl = item.url && item.url.trim() !== '';
            const isDataUrl = hasUrl && item.url!.startsWith('data:');
            const isHttpUrl =
              hasUrl && (item.url!.startsWith('http://') || item.url!.startsWith('https://'));

            return (
              <div
                key={item._id}
                className='group relative aspect-square rounded-2xl overflow-hidden bg-gray-100 border border-gray-200 shadow-sm hover:shadow-lg transition-all'
              >
                {!readOnly && (
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      handleDeleteRequest(item._id!);
                    }}
                    disabled={isDeleting}
                    className='absolute top-2 right-2 z-10 p-2 bg-white/90 text-red-600 rounded-full hover:bg-white transition-all shadow-md hover:scale-110 opacity-0 group-hover:opacity-100'
                    title={t('tooltips.delete')}
                  >
                    <Trash2 className='h-4 w-4' />
                  </button>
                )}

                {isVideo && videoId ? (
                  <div className='absolute inset-0 w-full h-full'>
                    <iframe
                      className='w-full h-full rounded-2xl'
                      src={`https://www.youtube.com/embed/${videoId}`}
                      title='YouTube video'
                      frameBorder='0'
                      allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture'
                      allowFullScreen
                    />
                  </div>
                ) : hasUrl ? (
                  <div
                    className='absolute inset-0 cursor-pointer'
                    onClick={() => setFullscreenImage(item.url || null)}
                  >
                    {isDataUrl ? (
                      /* eslint-disable-next-line @next/next/no-img-element */
                      <img
                        src={item.url!}
                        alt={t('image.alt')}
                        className='w-full h-full object-cover transition-transform duration-500 group-hover:scale-110'
                      />
                    ) : isHttpUrl ? (
                      <Image
                        src={item.url!}
                        alt={t('image.alt')}
                        fill
                        sizes='(max-width: 768px) 50vw, (max-width: 1200px) 33vw, 25vw'
                        className='object-cover transition-transform duration-500 group-hover:scale-110'
                        unoptimized={true}
                      />
                    ) : (
                      /* eslint-disable-next-line @next/next/no-img-element */
                      <img
                        src={item.url!}
                        alt={t('image.alt')}
                        className='w-full h-full object-cover'
                      />
                    )}
                  </div>
                ) : (
                  <div className='absolute inset-0 flex items-center justify-center bg-gray-100'>
                    <div className='text-center p-4'>
                      <ImageIcon className='h-12 w-12 text-gray-400 mx-auto mb-2' />
                      <p className='text-xs text-gray-500 font-medium'>{t('noImage')}</p>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}

      <Modal
        open={isModalOpen}
        onClose={handleCloseModal}
        title={modalType === 'image' ? t('modal.addImage') : t('modal.addVideo')}
        size='lg'
        closeOnOverlayClick={!isCreating}
        className='rounded-2xl border-primary border-2'
      >
        <Modal.Header className='text-center text-primary'>
          {modalType === 'image' ? t('modal.addImage') : t('modal.addVideo')}
        </Modal.Header>
        <Modal.Body>
          <form id='portfolioForm' onSubmit={handleSubmit(onSubmit)} className='space-y-4'>
            <input type='hidden' value={modalType} {...register('type')} />

            {modalType === 'image' ? (
              <div className='space-y-3'>
                <div>
                  <label className='block text-sm font-medium text-gray-700 mb-1'>
                    {t('form.imageUrl.label')} *
                  </label>
                  <div className='relative'>
                    <input
                      {...register('url', { required: t('form.imageUrl.required') })}
                      className='w-full rounded-lg border-primary border focus:outline-none py-2 px-3 pr-10'
                      placeholder={t('form.imageUrl.placeholder')}
                    />
                    {isValidating && (
                      <div className='absolute right-3 top-1/2 -translate-y-1/2'>
                        <Loader2 className='animate-spin h-5 w-5 text-blue-600' />
                      </div>
                    )}
                    {!isValidating && isValidUrl === true && (
                      <CheckCircle className='absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-green-600' />
                    )}
                    {!isValidating && isValidUrl === false && (
                      <XCircle className='absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-red-600' />
                    )}
                  </div>
                  {isValidUrl === false && (
                    <p className='text-xs text-red-600 mt-1'>
                      {t('form.imageUrl.validationError')}
                    </p>
                  )}
                </div>

                {previewUrl && isValidUrl && (
                  <div className='border-2 border-dashed border-green-300 rounded-lg p-4 bg-green-50'>
                    <p className='text-xs text-green-700 mb-2 font-semibold'>{t('form.preview')}</p>
                    <div className='relative w-full h-48 rounded-lg overflow-hidden bg-white shadow-md'>
                      {/* eslint-disable-next-line @next/next/no-img-element */}
                      <img
                        src={previewUrl}
                        alt='Preview'
                        className='w-full h-full object-contain'
                      />
                    </div>
                  </div>
                )}
              </div>
            ) : (
              <>
                <div>
                  <label className='block text-sm font-medium text-gray-700 mb-1'>
                    {t('form.youtubeUrl.label')} *
                  </label>
                  <input
                    {...register('youtubeUrl', { required: t('form.youtubeUrl.required') })}
                    className='w-full rounded-lg border-primary border focus:outline-none py-2 px-3'
                    placeholder={t('form.youtubeUrl.placeholder')}
                  />
                </div>

                <div>
                  <label className='block text-sm font-medium text-gray-700 mb-1'>
                    {t('form.thumbnailUrl.label')}
                  </label>
                  <input
                    {...register('url')}
                    className='w-full rounded-lg border-primary border focus:outline-none py-2 px-3'
                    placeholder={t('form.thumbnailUrl.placeholder')}
                  />
                </div>
              </>
            )}
          </form>
        </Modal.Body>
        <Modal.Footer>
          <div className='flex justify-end gap-2'>
            <button
              type='button'
              onClick={handleCloseModal}
              className='border border-primary py-2 px-4 rounded-2xl text-primary hover:text-white hover:bg-primary transition-colors'
              disabled={isCreating}
            >
              {t('buttons.cancel')}
            </button>
            <PillButton
              type='submit'
              form='portfolioForm'
              className='bg-primary text-white hover:bg-blue-800 flex items-center gap-2'
              disabled={(modalType === 'image' && isValidUrl !== true) || isCreating}
            >
              {isCreating && <Loader2 className='h-4 w-4 animate-spin' />}
              {isCreating ? t('buttons.saving') : t('buttons.save')}
            </PillButton>
          </div>
        </Modal.Footer>
      </Modal>

      {fullscreenImage && (
        <div
          className='fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 animate-fade-in'
          onClick={() => setFullscreenImage(null)}
        >
          <button
            onClick={() => setFullscreenImage(null)}
            className='absolute top-4 right-4 p-2 bg-white/10 hover:bg-white/20 rounded-full text-white transition-colors z-10'
          >
            <X className='h-6 w-6' />
          </button>
          <div
            className='relative w-full h-full max-w-6xl max-h-[90vh]'
            onClick={(e) => e.stopPropagation()}
          >
            {/* eslint-disable-next-line @next/next/no-img-element */}
            <img
              src={fullscreenImage}
              alt={t('fullscreen.alt')}
              className='w-full h-full object-contain'
            />
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/Components/fixer/Filter-eneable-wizard.tsx">
'use client';

import { useState } from 'react';
import { useForm, FormProvider, SubmitHandler } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
//import Image from 'next/image';
import { StepIndicator } from './Step-indicator';
import { Card } from '../Card';
import { PillButton } from './Pill-button';
import { CIStep } from './steps/Ci-step';
import { LocationStep } from './steps/Location-step';
import { ServicesStep, type Service } from './steps/Services-step';
import { PaymentStep } from './steps/Payment-step';
import { VehicleStep } from './steps/Vehicle-step';
import { TermsStep } from './steps/Terms-step';
import { CheckCircle2, ArrowLeft, ArrowRight } from 'lucide-react';
import { ProfilePhotoStep } from './steps/Profile-photo-step';
import { useConvertToFixerMutation } from '@/app/redux/services/become';
import { IUser } from '@/types/user';
import { fixerProfileSchema, type FixerProfileData } from '@/app/lib/validations/fixer-schemas';
import { FetchBaseQueryError } from '@reduxjs/toolkit/query';
import { SerializedError } from '@reduxjs/toolkit';
import NotificationModal from '../Modal-notifications';

const DEFAULT_SERVICES: Service[] = [
  { id: 'svc-plumbing', name: 'Plomería' },
  { id: 'svc-electric', name: 'Electricidad' },
  { id: 'svc-carpentry', name: 'Carpintería' },
  { id: 'svc-paint', name: 'Pintura' },
];

interface FixerEnableWizardProps {
  user: IUser;
}

// Type guards para manejar errores
function isFetchBaseQueryError(error: unknown): error is FetchBaseQueryError {
  return typeof error === 'object' && error != null && 'status' in error;
}

function isErrorWithData(error: unknown): error is { data: { message?: string; error?: string } } {
  return (
    typeof error === 'object' &&
    error != null &&
    'data' in error &&
    typeof (error as { data: unknown }).data === 'object'
  );
}

function isSerializedError(error: unknown): error is SerializedError {
  return (
    typeof error === 'object' &&
    error != null &&
    ('name' in error || 'message' in error || 'code' in error)
  );
}

export function FixerEnableWizard({ user }: FixerEnableWizardProps) {
  const [convertToFixer] = useConvertToFixerMutation();
  const [step, setStep] = useState(0);
  const total = 7; // 0 to 6
  const [success, setSuccess] = useState(false);

  // Estados para el modal de notificación
  const [modalState, setModalState] = useState({
    isOpen: false,
    type: 'success' as 'success' | 'error' | 'info' | 'warning',
    title: '',
    message: '',
  });

  const methods = useForm<FixerProfileData>({
    resolver: zodResolver(fixerProfileSchema),
    defaultValues: {
      ci: '',
      workLocation: { lat: -16.5, lng: -68.15 },
      servicios: [],
      metodoPago: {
        hasEfectivo: false,
        qr: false,
        tarjetaCredito: false,
      },
      accountInfo: '',
      experience: { descripcion: '' },
      vehiculo: {
        hasVehiculo: false,
        tipoVehiculo: undefined,
      },
      acceptTerms: false,
      url_photo: user.url_photo || '',
    },
    mode: 'onChange',
  });

  const {
    handleSubmit,
    trigger,
    watch,
    setValue,
    formState: { isSubmitting, errors },
  } = methods;

  const url_photo = watch('url_photo');
  const ci = watch('ci');
  const workLocation = watch('workLocation');
  const servicios = watch('servicios');
  const metodoPago = watch('metodoPago');
  const accountInfo = watch('accountInfo');
  const vehiculo = watch('vehiculo');
  const acceptTerms = watch('acceptTerms');

  const [availableServices, setAvailableServices] = useState<Service[]>(
    DEFAULT_SERVICES.map((s) => ({ id: s.id, name: s.name })),
  );

  const validateStep = async () => {
    let fieldsToValidate: (keyof FixerProfileData)[] = [];

    switch (step) {
      case 0:
        fieldsToValidate = ['url_photo'];
        break;
      case 1:
        fieldsToValidate = ['ci'];
        break;
      case 2:
        fieldsToValidate = ['workLocation'];
        break;
      case 3:
        fieldsToValidate = ['servicios'];
        break;
      case 4:
        fieldsToValidate = ['metodoPago', 'accountInfo'];
        break;
      case 5:
        fieldsToValidate = ['vehiculo'];
        break;
      case 6:
        fieldsToValidate = ['acceptTerms'];
        break;
    }

    const isValid = await trigger(fieldsToValidate);
    return isValid;
  };

  const goNext = async () => {
    const isValid = await validateStep();
    if (isValid) {
      setStep((s) => Math.min(total - 1, s + 1));
    }
  };

  const goPrev = () => {
    setStep((s) => Math.max(0, s - 1));
  };

  const handleToggleService = (id: string) => {
    const current = servicios || [];
    const updated = current.includes(id) ? current.filter((x) => x !== id) : [...current, id];
    setValue('servicios', updated, { shouldValidate: true });
  };

  const handleAddCustomService = (name: string) => {
    const trimmed = name.trim();
    if (!trimmed) return;
    const id = `custom-${Date.now()}`;
    setAvailableServices((prev) => [...prev, { id, name: trimmed, custom: true }]);
    setValue('servicios', [...(servicios || []), id], { shouldValidate: true });
  };

  const handleEditService = (id: string, name: string) => {
    setAvailableServices((prev) => prev.map((s) => (s.id === id ? { ...s, name } : s)));
  };

  const handleDeleteService = (id: string) => {
    setAvailableServices((prev) => prev.filter((s) => s.id !== id));
    setValue(
      'servicios',
      (servicios || []).filter((x) => x !== id),
      { shouldValidate: true },
    );
  };

  const handleTogglePayment = (method: 'cash' | 'qr' | 'card') => {
    const current = { ...metodoPago };
    if (method === 'cash') current.hasEfectivo = !current.hasEfectivo;
    if (method === 'qr') current.qr = !current.qr;
    if (method === 'card') current.tarjetaCredito = !current.tarjetaCredito;

    setValue('metodoPago', current, { shouldValidate: true });
  };

  const getPaymentArray = () => {
    const arr: ('cash' | 'qr' | 'card')[] = [];
    if (metodoPago?.hasEfectivo) arr.push('cash');
    if (metodoPago?.qr) arr.push('qr');
    if (metodoPago?.tarjetaCredito) arr.push('card');
    return arr;
  };

  const onSubmit: SubmitHandler<FixerProfileData> = async (data) => {
    try {
      if (!user._id) {
        setModalState({
          isOpen: true,
          type: 'error',
          title: 'Error',
          message: 'No se pudo identificar al usuario. Por favor, intenta nuevamente.',
        });
        return;
      }

      const payload = {
        id: user._id?.toString(),
        profile: {
          telefono: user.telefono,
          ci: data.ci.trim(),
          services: data.servicios
            .filter((id): id is string => id.startsWith('svc-'))
            .map((id) => {
              const service = DEFAULT_SERVICES.find((s) => s.id === id);
              return { name: service?.name ?? 'Servicio desconocido' };
            }),
          vehicle: data.vehiculo.hasVehiculo
            ? {
                hasVehiculo: true,
                tipoVehiculo: data.vehiculo.tipoVehiculo || undefined,
              }
            : { hasVehiculo: false },
          paymentMethods: (() => {
            const methods: { type: string }[] = [];
            if (data.metodoPago.hasEfectivo) methods.push({ type: 'efectivo' });
            if (data.metodoPago.qr) methods.push({ type: 'qr' });
            if (data.metodoPago.tarjetaCredito) methods.push({ type: 'tarjeta' });
            return methods;
          })(),
          location: {
            lat: Number(data.workLocation.lat),
            lng: Number(data.workLocation.lng),
            direccion: data.workLocation.direccion?.trim() || '',
          },
          terms: {
            accepted: data.acceptTerms,
          },
        },
      };

      await convertToFixer(payload).unwrap();
      setSuccess(true);
      setModalState({
        isOpen: true,
        type: 'success',
        title: '¡Registro Exitoso!',
        message: `${user.name}, tu perfil de FIXER ha sido creado exitosamente. Tu cuenta está en revisión y pronto podrás comenzar a recibir solicitudes.`,
      });
    } catch (error) {
      console.error('Error registering fixer:', error);

      let errorMessage = 'Ocurrió un error al registrar tu perfil. Por favor, intenta nuevamente.';

      if (isErrorWithData(error)) {
        const data = error.data;
        errorMessage = data.message || data.error || errorMessage;
      } else if (isFetchBaseQueryError(error)) {
        errorMessage = `Error de conexión (${error.status}). Verifica tu conexión a internet.`;
      } else if (isSerializedError(error)) {
        errorMessage = error.message || errorMessage;
      }

      setModalState({
        isOpen: true,
        type: 'error',
        title: 'Error al Registrar',
        message: errorMessage,
      });
    }
  };

  return (
    <FormProvider {...methods}>
      <div className='mx-auto w-full max-w-3xl animate-fade-in'>
        <StepIndicator step={step} total={total} />
        {success ? (
          <Card title='¡Listo!'>
            <div className='space-y-4 text-center'>
              <div className='flex justify-center'>
                <CheckCircle2 className='h-16 w-16 text-green-600 animate-scale-in' />
              </div>
              <p className='text-lg font-semibold text-gray-900'>
                {user.name} ahora está habilitado como FIXER.
              </p>
              <div className='text-sm text-gray-600 space-y-1'>
                <p>CI: {ci}</p>
                <p>
                  Ubicación: {workLocation?.lat.toFixed(5)}, {workLocation?.lng.toFixed(5)}
                </p>
                <p>Servicios: {servicios?.length}</p>
                <p>Métodos de pago: {getPaymentArray().join(', ')}</p>
                <p>Vehículo: {vehiculo?.hasVehiculo ? `Sí (${vehiculo.tipoVehiculo})` : 'No'}</p>
                <p className='text-xs text-gray-500 mt-4'>Estado: En revisión (pending)</p>
              </div>
            </div>
          </Card>
        ) : (
          <form onSubmit={handleSubmit(onSubmit)} className='space-y-4'>
            {step === 0 && (
              <ProfilePhotoStep
                photoUrl={url_photo}
                onPhotoChange={(url) => setValue('url_photo', url, { shouldValidate: true })}
                error={errors.url_photo?.message}
              />
            )}

            {step === 1 && (
              <CIStep
                ci={ci}
                onCIChange={(val) => setValue('ci', val, { shouldValidate: true })}
                error={errors.ci?.message}
              />
            )}

            {step === 2 && (
              <LocationStep
                location={workLocation}
                onLocationChange={(val) => setValue('workLocation', val, { shouldValidate: true })}
                error={errors.workLocation?.message || errors.workLocation?.lat?.message}
              />
            )}

            {step === 3 && (
              <ServicesStep
                services={availableServices}
                selectedServiceIds={servicios}
                onToggleService={handleToggleService}
                onAddCustomService={handleAddCustomService}
                onEditService={handleEditService}
                onDeleteService={handleDeleteService}
                error={errors.servicios?.message}
              />
            )}

            {step === 4 && (
              <PaymentStep
                payments={getPaymentArray()}
                accountInfo={accountInfo || ''}
                onTogglePayment={handleTogglePayment}
                onAccountInfoChange={(val) =>
                  setValue('accountInfo', val, { shouldValidate: true })
                }
                paymentsError={errors.metodoPago?.root?.message}
                accountError={errors.accountInfo?.message}
              />
            )}

            {step === 5 && (
              <VehicleStep
                hasVehicle={vehiculo?.hasVehiculo}
                vehicleType={vehiculo?.tipoVehiculo}
                onHasVehicleChange={(val) => {
                  setValue('vehiculo.hasVehiculo', val, { shouldValidate: true });
                  if (!val) setValue('vehiculo.tipoVehiculo', undefined);
                }}
                onVehicleTypeChange={(val) =>
                  setValue('vehiculo.tipoVehiculo', val, { shouldValidate: true })
                }
                error={
                  errors.vehiculo?.hasVehiculo?.message || errors.vehiculo?.tipoVehiculo?.message
                }
              />
            )}

            {step === 6 && (
              <TermsStep
                accepted={acceptTerms}
                onAcceptChange={(val) => setValue('acceptTerms', val, { shouldValidate: true })}
                error={errors.acceptTerms?.message}
              />
            )}

            {errors.root && (
              <div className='bg-red-50 border border-red-200 rounded-lg p-3 text-red-700 text-sm'>
                {errors.root.message}
              </div>
            )}

            <div className='flex items-center justify-between'>
              <PillButton
                type='button'
                disabled={step === 0}
                onClick={goPrev}
                className='bg-gray-200 text-gray-800 hover:bg-gray-300 disabled:opacity-50 flex items-center gap-2'
              >
                <ArrowLeft className='h-4 w-4' />
                Atrás
              </PillButton>
              {step < total - 1 ? (
                <PillButton
                  type='button'
                  onClick={goNext}
                  className='bg-primary text-white hover:bg-blue-800 flex items-center gap-2'
                >
                  Siguiente
                  <ArrowRight className='h-4 w-4' />
                </PillButton>
              ) : (
                <PillButton
                  type='submit'
                  disabled={isSubmitting || !acceptTerms}
                  className='bg-primary text-white hover:bg-blue-800 disabled:opacity-50 flex items-center gap-2'
                >
                  {isSubmitting ? 'Registrando...' : 'Registrar'}
                  <CheckCircle2 className='h-4 w-4' />
                </PillButton>
              )}
            </div>
          </form>
        )}

        {/* Modal de Notificaciones */}
        <NotificationModal
          isOpen={modalState.isOpen}
          onClose={() => setModalState((prev) => ({ ...prev, isOpen: false }))}
          type={modalState.type}
          title={modalState.title}
          message={modalState.message}
          autoClose={modalState.type === 'success'}
          autoCloseDelay={4000}
        />
      </div>
    </FormProvider>
  );
}
</file>

<file path="src/Components/fixer/Fixer-grafic-card.tsx">
// src/Components/fixer/Fixer-grafic-card.tsx
import { CheckCircle, XCircle, TrendingUp } from 'lucide-react';

interface FixerGraficCardProps {
  completedJobs: number;
  cancelledJobs: number;
}

interface FixerGraficCardProps {
  completedJobs: number;
  cancelledJobs: number;
  monthlyData?: { month: string; completados: number; cancelados: number }[];
}

export default function FixerGraficCard({ completedJobs, cancelledJobs }: FixerGraficCardProps) {
  console.log('Completed Jobs:', completedJobs);
  console.log('Cancelled Jobs:', cancelledJobs);
  const monthlyData = [
    { month: 'Ene', completados: 8, cancelados: 1 },
    { month: 'Feb', completados: 30, cancelados: 2 },
    { month: 'Mar', completados: 15, cancelados: 0 },
    { month: 'Abr', completados: 20, cancelados: 3 },
    { month: 'May', completados: 22, cancelados: 1 },
    { month: 'Jun', completados: 20, cancelados: 2 },
  ];

  // 🔥 Calcular totales del año desde monthlyData
  const yearlyCompleted = monthlyData.reduce((sum, month) => sum + month.completados, 0);
  const yearlyCancelled = monthlyData.reduce((sum, month) => sum + month.cancelados, 0);
  const totalJobs = yearlyCompleted + yearlyCancelled;
  const completionRate = totalJobs > 0 ? Math.round((yearlyCompleted / totalJobs) * 100) : 0;

  // 🔥 Escala lineal normal (sin logaritmo) para mejor visualización
  const maxValue = Math.max(...monthlyData.map((m) => Math.max(m.completados, m.cancelados)), 1);

  // Función para escalar valores linealmente
  const scaleValue = (value: number) => {
    if (value === 0) return 0;
    return (value / maxValue) * 100;
  };

  return (
    <div className='bg-white rounded-3xl border-gray-100 overflow-hidden'>
      <div className='p-8 border-b border-gray-100'>
        <h3 className='text-2xl font-bold text-gray-800 flex items-center gap-3'>
          <TrendingUp className='w-8 h-8 text-green-600' />
          Desempeño Mensual
        </h3>

        <div className='flex items-center justify-between mt-6'>
          <div className='flex items-center gap-8'>
            <div className='flex items-center gap-3'>
              <CheckCircle className='w-7 h-7 text-green-600' />
              <div>
                <p className='text-2xl font-bold text-gray-800'>{yearlyCompleted}</p>
                <p className='text-xs text-gray-500 uppercase tracking-wider'>Completados</p>
              </div>
            </div>
            <div className='flex items-center gap-3'>
              <XCircle className='w-7 h-7 text-red-500' />
              <div>
                <p className='text-2xl font-bold text-gray-800'>{yearlyCancelled}</p>
                <p className='text-xs text-gray-500 uppercase tracking-wider'>Cancelados</p>
              </div>
            </div>
          </div>

          <div className='text-right'>
            <p className='text-5xl font-bold text-green-600'>{completionRate}%</p>
            <p className='text-sm text-gray-500 uppercase tracking-wider'>Tasa de éxito</p>
          </div>
        </div>
      </div>

      <div className='p-8 bg-gradient-to-b from-gray-50 to-white'>
        <div className='grid grid-cols-6 gap-6'>
          {monthlyData.map((data, index) => {
            const completedHeight = scaleValue(data.completados);
            const cancelledHeight = scaleValue(data.cancelados);

            // Calcular % de éxito del mes
            const monthTotal = data.completados + data.cancelados;
            const successRate =
              monthTotal > 0 ? Math.round((data.completados / monthTotal) * 100) : 0;

            return (
              <div key={index} className='flex flex-col items-center space-y-3'>
                <div className='text-center'>
                  <span className='text-xs font-bold text-gray-700'>{data.month}</span>
                  <p className='text-[10px] font-semibold text-green-600'>{successRate}%</p>
                </div>

                <div className='flex items-end gap-2 h-64 w-full'>
                  {/* ⭐ Barra Completados */}
                  <div className='flex-1 flex flex-col justify-end items-center gap-1'>
                    <div
                      className='w-full bg-green-500 rounded-t-lg transition-all duration-700 ease-out shadow-lg'
                      style={{
                        height: `${completedHeight}%`,
                        minHeight: data.completados > 0 ? '24px' : '0px',
                      }}
                    />
                    <span className='text-xs font-bold text-green-700'>{data.completados}</span>
                  </div>

                  {/* ⭐ Barra Cancelados */}
                  <div className='flex-1 flex flex-col justify-end items-center gap-1'>
                    <div
                      className='w-full bg-red-500 rounded-t-lg transition-all duration-700 ease-out shadow-lg'
                      style={{
                        height: `${cancelledHeight}%`,
                        minHeight: data.cancelados > 0 ? '20px' : '0px',
                        opacity: data.cancelados > 0 ? 1 : 0.35,
                      }}
                    />
                    <span className='text-xs font-bold text-red-700'>{data.cancelados}</span>
                  </div>
                </div>

                <span className='text-xs font-semibold text-gray-600'>
                  {data.completados + data.cancelados}
                </span>
              </div>
            );
          })}
        </div>

        <div className='flex justify-center gap-10 mt-10 text-sm font-medium'>
          <div className='flex items-center gap-3'>
            <div className='w-6 h-6 bg-green-500 rounded'></div>
            <span>Completados</span>
          </div>
          <div className='flex items-center gap-3'>
            <div className='w-6 h-6 bg-red-500 rounded'></div>
            <span>Cancelados</span>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/fixer/Fixer-register-form.tsx">
'use client';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import {
  initialRegistrationSchema,
  type InitialRegistrationData,
} from '@/app/lib/validations/fixer-schemas';
import { useState, useEffect } from 'react';
import { useTranslations } from 'next-intl';

interface FixerRegisterFormProps {
  onSubmit: (data: InitialRegistrationData) => void;
  submitButtonText?: string;
  defaultValues?: Partial<InitialRegistrationData>;
}

export default function FixerRegisterForm({
  onSubmit,
  submitButtonText,
  defaultValues = {},
}: FixerRegisterFormProps) {
  const t = useTranslations('becomeFixer');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const {
    control,
    handleSubmit,
    reset,
    formState: { errors },
  } = useForm<InitialRegistrationData>({
    resolver: zodResolver(initialRegistrationSchema),
    defaultValues: {
      name: '',
      email: '',
      phone: '',
      ...defaultValues,
    },
    mode: 'onChange',
  });

  useEffect(() => {
    reset({
      name: defaultValues.name || '',
      email: defaultValues.email || '',
      phone: defaultValues.phone || '',
    });
  }, [defaultValues, reset]);

  const handleFormSubmit = async (data: InitialRegistrationData) => {
    setIsSubmitting(true);
    await onSubmit(data);
    setIsSubmitting(false);
  };

  return (
    <form onSubmit={handleSubmit(handleFormSubmit)} className='space-y-4'>
      {/* NAME */}
      <div className='space-y-1'>
        <label htmlFor='name' className='block text-sm font-medium text-gray-700'>
          {t('fields.name.label')} <span className='text-red-500'>*</span>
        </label>
        <Controller
          name='name'
          control={control}
          render={({ field }) => (
            <div className='relative'>
              <input
                {...field}
                maxLength={30}
                className='w-full rounded-full bg-gray-200 px-4 py-2 text-sm'
                placeholder={t('fields.name.placeholder')}
                onChange={(e) => {
                  const value = e.target.value.replace(/[^A-Za-záéíóúÁÉÍÓÚñÑ\s]/g, '').slice(0, 30);
                  field.onChange(value);
                }}
              />
              <span className='absolute right-4 top-1/2 -translate-y-1/2 text-xs text-gray-500'>
                {field.value?.length || 0}/30
              </span>
            </div>
          )}
        />
        {errors.name && <p className='text-xs text-red-600'>{errors.name.message}</p>}
      </div>

      {/* EMAIL */}
      <div className='space-y-1'>
        <label htmlFor='email' className='block text-sm font-medium text-gray-700'>
          {t('fields.email.label')} <span className='text-red-500'>*</span>
        </label>
        <Controller
          name='email'
          control={control}
          render={({ field }) => (
            <input
              {...field}
              type='email'
              className='w-full rounded-full bg-gray-200 px-4 py-2 text-sm'
              placeholder={t('fields.email.placeholder')}
            />
          )}
        />
        {errors.email && <p className='text-xs text-red-600'>{errors.email.message}</p>}
      </div>

      {/* PHONE */}
      <div className='space-y-1'>
        <label htmlFor='phone' className='block text-sm font-medium text-gray-700'>
          {t('fields.phone.label')} <span className='text-red-500'>*</span>
        </label>
        <Controller
          name='phone'
          control={control}
          render={({ field }) => (
            <div className='relative'>
              <input
                {...field}
                type='tel'
                className='w-full rounded-full bg-gray-200 px-4 py-2 text-sm pr-20'
                placeholder={t('fields.phone.placeholder')}
                onChange={(e) => {
                  const value = e.target.value.replace(/[^\d\s+-]/g, '');
                  field.onChange(value);
                }}
              />
              <span className='absolute right-4 top-1/2 -translate-y-1/2 text-xs text-gray-400'>
                {field.value ? field.value.replace(/\D/g, '').length : 0} {t('digits')}
              </span>
            </div>
          )}
        />
        {errors.phone && <p className='text-xs text-red-600'>{errors.phone.message}</p>}
      </div>

      {/* BUTTON */}
      <button
        type='submit'
        disabled={isSubmitting}
        className='w-full rounded-full bg-primary text-white py-2.5 text-sm font-semibold'
      >
        {isSubmitting ? t('buttons.submitting') : submitButtonText || t('buttons.submit')}
      </button>
    </form>
  );
}
</file>

<file path="src/Components/fixer/Fixer-statistics.tsx">
'use client';

import { useTranslations } from 'next-intl';
import { Pie, PieChart, Cell, Tooltip } from 'recharts';
import { useGetJobStatisticsQuery } from '../../app/redux/services/statisticsApi';

const COLORS = {
  completed: 'blue',
  inProgress: '#3B82F6',
  pending: '#1AA7ED',
};

interface TooltipPayload {
  name: string;
  value: number;
  payload: {
    estado: string;
    cantidad: number;
  };
}

interface TooltipProps {
  active?: boolean;
  payload?: TooltipPayload[];
}

const CustomTooltip = ({ active, payload }: TooltipProps) => {
  if (active && payload && payload.length) {
    return (
      <div className='p-2 bg-white border border-gray-300 shadow-md rounded-md text-sm'>
        <p className='font-semibold text-gray-800'>{`${payload[0].name}: ${payload[0].value}`}</p>
      </div>
    );
  }
  return null;
};

export default function EstadisticasTrabajos() {
  const t = useTranslations('statistics.jobs');

  const { data: jobLogs, isLoading, isError } = useGetJobStatisticsQuery();

  if (isLoading) {
    return <div className='text-center p-8'>{t('loading')}</div>;
  }
  if (isError || !jobLogs) {
    return <div className='text-center p-8 text-red-600'>{t('error')}</div>;
  }

  const dailyStatusLog = jobLogs
    .filter((log) => log.type === 'daily_jobs_status')
    .sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())[0];

  if (!dailyStatusLog) {
    return <div className='text-center p-8 text-gray-500'>{t('noLogs')}</div>;
  }

  const stats = dailyStatusLog.metadata;

  const chartData = [
    { estado: 'completed', estadoLabel: t('status.completed'), cantidad: stats.completed },
    { estado: 'inProgress', estadoLabel: t('status.inProgress'), cantidad: stats.inProgress },
    { estado: 'pending', estadoLabel: t('status.pending'), cantidad: stats.pending },
  ];

  const totalTrabajos = stats.total;

  return (
    <div className="flex flex-col font-['Roboto'] shadow-md rounded-2xl p-4 bg-white max-w-sm mx-auto">
      <div className='flex justify-center pb-2'>
        <h2 className='text-xl font-semibold text-gray-800'>{t('title')}</h2>
      </div>
      <div className='flex flex-col items-center justify-center'>
        <PieChart width={300} height={300}>
          <Tooltip content={<CustomTooltip />} />
          <Pie
            data={chartData}
            dataKey='cantidad'
            nameKey='estadoLabel'
            outerRadius={100}
            labelLine={false}
            label={({ payload, ...props }) => (
              <text
                cx={props.cx}
                cy={props.cy}
                x={props.x}
                y={props.y}
                textAnchor={props.textAnchor}
                dominantBaseline={props.dominantBaseline}
                fill='#333'
                className='text-sm font-medium'
              >
                {`${payload.cantidad}`}
              </text>
            )}
          >
            {chartData.map((entry, index) => (
              <Cell key={`cell-${index}`} fill={COLORS[entry.estado as keyof typeof COLORS]} />
            ))}
          </Pie>
        </PieChart>
      </div>
      <div className='mt-4 w-full text-sm text-gray-700'>
        {chartData.map((item, index) => (
          <div
            key={item.estado}
            className={`flex justify-between px-4 py-1 ${index < chartData.length - 1 ? 'border-b border-gray-200' : ''}`}
          >
            <span className='font-medium flex items-center'>
              <span
                className='inline-block w-3 h-3 rounded-full mr-2'
                style={{ backgroundColor: COLORS[item.estado as keyof typeof COLORS] }}
              ></span>
              {item.estadoLabel}
            </span>

            <span>
              {item.cantidad} {t('jobs')}
              <span className='ml-2 font-normal text-gray-500'>
                ({((item.cantidad / totalTrabajos) * 100).toFixed(0)}%)
              </span>
            </span>
          </div>
        ))}

        <div className='flex justify-between px-4 py-1 mt-2 border-t-2 border-gray-300 font-bold'>
          <span>{t('total')}</span>
          <span>
            {totalTrabajos} {t('jobs')}
          </span>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/fixer/Pill-button.tsx">
export { PillButton } from '../Pill-button';
</file>

<file path="src/Components/fixer/Step-indicator.tsx">
interface StepIndicatorProps {
  step: number;
  total: number;
}

export function StepIndicator({ step, total }: StepIndicatorProps) {
  return (
    <div className='mb-6 flex items-center justify-center gap-2'>
      {Array.from({ length: total }).map((_, i) => (
        <span
          key={i}
          className={
            'h-1.5 w-10 rounded-full transition-all ' +
            (i < step ? 'bg-primary' : i === step ? 'bg-blue-500' : 'bg-gray-300')
          }
        />
      ))}
    </div>
  );
}
</file>

<file path="src/Components/fixer/steps/Ci-step.tsx">
'use client';

import { Card } from '@/Components/Card';
import { AlertCircle, CreditCard } from 'lucide-react';

interface CIStepProps {
  ci: string;
  onCIChange: (ci: string) => void;
  error?: string;
}

export function CIStep({ ci, onCIChange, error }: CIStepProps) {
  const handleChange = (value: string) => {
    const sanitized = value.replace(/[^0-9]/g, '').slice(0, 10);
    onCIChange(sanitized);
  };

  return (
    <Card title='Registrar CI'>
      <div className='space-y-3'>
        <div className='space-y-1'>
          <label className='flex items-center gap-2 text-sm text-gray-700'>
            <CreditCard className='h-4 w-4 text-blue-600' />
            Cédula de Identidad <span className='text-red-600'>*</span>
          </label>
          <input
            value={ci}
            onChange={(e) => handleChange(e.target.value)}
            placeholder='Ej: 1234567890'
            maxLength={10}
            className='w-full rounded-full border border-transparent bg-gray-200 px-4 py-2 text-sm outline-none placeholder:text-gray-500 focus:border-blue-500 focus:bg-gray-100 focus:ring-2 focus:ring-blue-400 transition-all'
          />
          <p className='text-xs text-gray-600'>Solo números, máximo 10 dígitos ({ci.length}/10)</p>
        </div>
        {error && (
          <div className='flex items-center gap-1 text-sm text-red-600'>
            <AlertCircle className='h-4 w-4' />
            <span>{error}</span>
          </div>
        )}
      </div>
    </Card>
  );
}
</file>

<file path="src/Components/fixer/steps/Experience-step.tsx">
// "use client"

// import type React from "react"

// import { useState } from "react"
// import { Card } from "@/Components/Card"
// import { Upload, ImageIcon, Video, Trash2, AlertCircle } from "lucide-react"
// import Image from "next/image"

// export interface Experience {
//   id: string
//   title: string
//   description: string
//   fileUrl: string
//   fileType: "image" | "video"
//   fileName: string
// }

// interface ExperienceStepProps {
//   experiences: Experience[]
//   onAddExperience: (experience: Omit<Experience, "id">) => void
//   onDeleteExperience: (id: string) => void
//   error?: string
// }

// export function ExperienceStep({ experiences, onAddExperience, onDeleteExperience, error }: ExperienceStepProps) {
//   const [title, setTitle] = useState("")
//   const [description, setDescription] = useState("")
//   const [uploading, setUploading] = useState(false)

//   const handleTitleChange = (value: string) => {
//     const sanitized = value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, "").slice(0, 20)
//     setTitle(sanitized)
//   }

//   const handleDescriptionChange = (value: string) => {
//     const sanitized = value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s.,!?¿¡]/g, "").slice(0, 200)
//     setDescription(sanitized)
//   }

//   const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
//     const file = e.target.files?.[0]
//     if (!file) return

//     const isImage = file.type.startsWith("image/")
//     const isVideo = file.type.startsWith("video/")

//     if (!isImage && !isVideo) {
//       alert("Solo se permiten imágenes o videos")
//       return
//     }

//     if (file.size > 50 * 1024 * 1024) {
//       alert("El archivo es muy grande. Máximo 50MB")
//       return
//     }

//     if (!title.trim()) {
//       alert("Por favor ingresa un título para la experiencia")
//       return
//     }

//     setUploading(true)

//     try {
//       const blobUrl = URL.createObjectURL(file)

//       onAddExperience({
//         title: title.trim(),
//         description: description.trim(),
//         fileUrl: blobUrl,
//         fileType: isImage ? "image" : "video",
//         fileName: file.name,
//       })

//       setTitle("")
//       setDescription("")
//       e.target.value = ""
//     } catch {
//       alert("Error al subir el archivo")
//     } finally {
//       setUploading(false)
//     }
//   }

//   return (
//     <Card title="Subir experiencias">
//       <div className="space-y-4">
//         <p className="text-sm text-gray-700 flex items-center gap-2">
//           <Upload className="h-4 w-4 text-primary" />
//           Muestra tus trabajos anteriores subiendo fotos o videos de tus proyectos completados
//         </p>

//         <div className="space-y-3 rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 p-4">
//           <div className="space-y-2">
//             <label className="text-sm font-medium text-gray-800">
//               Título del trabajo <span className="text-red-600">*</span>
//             </label>
//             <input
//               type="text"
//               value={title}
//               onChange={(e) => handleTitleChange(e.target.value)}
//               placeholder="Ej: Instalación eléctrica residencial"
//               maxLength={20}
//               className="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400 transition-all"
//             />
//             <p className="text-xs text-gray-600">Solo letras, máximo 20 caracteres ({title.length}/20)</p>
//           </div>

//           <div className="space-y-2">
//             <label className="text-sm font-medium text-gray-800">Descripción (opcional)</label>
//             <textarea
//               value={description}
//               onChange={(e) => handleDescriptionChange(e.target.value)}
//               placeholder="Describe brevemente el trabajo realizado..."
//               maxLength={200}
//               rows={3}
//               className="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400 transition-all"
//             />
//             <p className="text-xs text-gray-600">Solo letras y signos de puntuación, máximo 200 caracteres ({description.length}/200)</p>
//           </div>

//           <div className="space-y-2">
//             <label className="text-sm font-medium text-gray-800 flex items-center gap-2">
//               <ImageIcon className="h-4 w-4 text-primary" />
//               Foto o video <span className="text-red-600">*</span>
//             </label>
//             <input
//               type="file"
//               accept="image/*,video/*"
//               onChange={handleFileUpload}
//               disabled={uploading}
//               className="w-full text-sm text-gray-700 file:mr-4 file:rounded-full file:border-0 file:bg-primary file:px-4 file:py-2 file:text-sm file:font-medium file:text-white hover:file:bg-blue-700 disabled:opacity-50 transition-all"
//             />
//             <p className="text-xs text-gray-600">Máximo 50MB. Formatos: JPG, PNG, MP4, MOV</p>
//           </div>
//         </div>

//         {experiences.length > 0 && (
//           <div className="space-y-3 animate-fade-in">
//             <h3 className="text-sm font-medium text-gray-800">Experiencias agregadas ({experiences.length})</h3>
//             <div className="grid grid-cols-1 gap-3 md:grid-cols-2">
//               {experiences.map((exp) => (
//                 <div
//                   key={exp.id}
//                   className="relative overflow-hidden rounded-lg border border-gray-300 bg-white shadow-sm hover:shadow-md transition-shadow"
//                 >
//                   <div className="absolute top-2 right-2 z-10">
//                     {exp.fileType === "image" ? (
//                       <div className="rounded-full bg-blue-600 p-1.5">
//                         <ImageIcon className="h-3 w-3 text-white" />
//                       </div>
//                     ) : (
//                       <div className="rounded-full bg-purple-600 p-1.5">
//                         <Video className="h-3 w-3 text-white" />
//                       </div>
//                     )}
//                   </div>
//                   {exp.fileType === "image" ? (
//                     <div className="relative h-40">
//                       <Image
//                         src={exp.fileUrl || "/placeholder.svg"}
//                         alt={exp.title}
//                         fill
//                         className="object-cover"
//                       />
//                     </div>
//                   ) : (
//                     <video src={exp.fileUrl} className="h-40 w-full object-cover" controls />
//                   )}
//                   <div className="p-3">
//                     <h4 className="font-medium text-gray-900 text-sm">{exp.title}</h4>
//                     {exp.description && <p className="mt-1 text-xs text-gray-600 line-clamp-2">{exp.description}</p>}
//                     <button
//                       type="button"
//                       onClick={() => onDeleteExperience(exp.id)}
//                       className="mt-2 flex items-center gap-1 text-xs text-red-600 hover:text-red-700 transition-colors"
//                     >
//                       <Trash2 className="h-3 w-3" />
//                       Eliminar
//                     </button>
//                   </div>
//                 </div>
//               ))}
//             </div>
//           </div>
//         )}

//         {error && (
//           <div className="flex items-center gap-1 text-sm text-red-600">
//             <AlertCircle className="h-4 w-4" />
//             <span>{error}</span>
//           </div>
//         )}
//       </div>
//     </Card>
//   )
// }
</file>

<file path="src/Components/fixer/steps/Location-step.tsx">
'use client';

import { useCallback, useEffect, useMemo, useRef, useState } from 'react';
import { Card } from '@/Components/Card';

interface Location {
  lat: number;
  lng: number;
}

interface LocationStepProps {
  location: Location | null;
  onLocationChange: (location: Location) => void;
  error?: string;
}

export function LocationStep({ location, onLocationChange, error }: LocationStepProps) {
  const mapRef = useRef<HTMLDivElement>(null);
  const [mapLoaded, setMapLoaded] = useState(false);
  const [manualLat, setManualLat] = useState(location?.lat.toString() || '');
  const [manualLng, setManualLng] = useState(location?.lng.toString() || '');
  const [outOfBounds, setOutOfBounds] = useState(false);

  const COCHABAMBA_BOUNDS = useMemo(
    () => ({
      north: -17.2,
      south: -17.6,
      east: -65.8,
      west: -66.4,
    }),
    [],
  );

  useEffect(() => {
    if (!document.getElementById('leaflet-css')) {
      const link = document.createElement('link');
      link.id = 'leaflet-css';
      link.rel = 'stylesheet';
      link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      document.head.appendChild(link);
    }

    if (!window.L) {
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.onload = () => setMapLoaded(true);
      document.body.appendChild(script);
    } else {
      setMapLoaded(true);
    }
  }, []);

  const isInCochabamba = useCallback(
    (lat: number, lng: number): boolean => {
      return (
        lat >= COCHABAMBA_BOUNDS.south &&
        lat <= COCHABAMBA_BOUNDS.north &&
        lng >= COCHABAMBA_BOUNDS.west &&
        lng <= COCHABAMBA_BOUNDS.east
      );
    },
    [COCHABAMBA_BOUNDS],
  );

  useEffect(() => {
    if (!mapLoaded || !mapRef.current) return;
    const map = L.map(mapRef.current).setView([-17.3935, -66.157], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 19,
    }).addTo(map);

    const bounds = L.latLngBounds(
      L.latLng(COCHABAMBA_BOUNDS.south, COCHABAMBA_BOUNDS.west),
      L.latLng(COCHABAMBA_BOUNDS.north, COCHABAMBA_BOUNDS.east),
    );
    map.setMaxBounds(bounds);
    map.on('drag', () => {
      map.panInsideBounds(bounds, { animate: false });
    });

    let marker: L.Marker | null = null;
    if (location && isInCochabamba(location.lat, location.lng)) {
      marker = L.marker([location.lat, location.lng]).addTo(map);
      map.setView([location.lat, location.lng], 15);
      setOutOfBounds(false);
    }

    map.on('click', (e: L.LeafletEvent) => {
      const { lat, lng } = e.latlng;
      if (!isInCochabamba(lat, lng)) {
        setOutOfBounds(true);

        if (marker) {
          map.removeLayer(marker);
          marker = null;
        }
        onLocationChange({ lat: 0, lng: 0 });
        setManualLat('');
        setManualLng('');
        return;
      }

      setOutOfBounds(false);

      if (marker) {
        map.removeLayer(marker);
      }

      marker = L.marker([lat, lng]).addTo(map);

      onLocationChange({ lat, lng });
      setManualLat(lat.toFixed(6));
      setManualLng(lng.toFixed(6));
    });

    return () => {
      map.remove();
    };
  }, [mapLoaded, location, onLocationChange, isInCochabamba, COCHABAMBA_BOUNDS]);

  const handleManualUpdate = () => {
    const lat = Number.parseFloat(manualLat);
    const lng = Number.parseFloat(manualLng);

    if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
      if (isInCochabamba(lat, lng)) {
        setOutOfBounds(false);
        onLocationChange({ lat, lng });
      } else {
        setOutOfBounds(true);
      }
    }
  };

  return (
    <Card title='Registrar ubicación de trabajo'>
      <div className='space-y-4'>
        <div className='space-y-2'>
          <p className='text-sm text-gray-700'>
            Haz clic en el mapa para seleccionar tu ubicación de trabajo{' '}
            <strong>solo en la región de Cochabamba</strong>
          </p>
          <div className='rounded-lg bg-amber-50 p-3 border border-amber-200'>
            <p className='text-sm text-amber-800 font-medium'>⚠️ Restricción de ubicación</p>
            <p className='text-xs text-amber-700 mt-1'>
              Solo puedes seleccionar ubicaciones dentro del departamento de Cochabamba, Bolivia.
            </p>
          </div>
          <div ref={mapRef} className='h-80 w-full rounded-xl border border-gray-300 bg-gray-100' />
        </div>

        {outOfBounds && (
          <div className='rounded-lg bg-red-50 p-3 border border-red-200'>
            <p className='text-sm text-red-800 font-medium'>Ubicación fuera de Cochabamba</p>
            <p className='text-xs text-red-700 mt-1'>
              La ubicación seleccionada está fuera de la región de Cochabamba. Por favor, selecciona
              una ubicación dentro del departamento.
            </p>
          </div>
        )}

        {location && location.lat !== 0 && location.lng !== 0 && (
          <div className='space-y-2 rounded-lg bg-blue-50 p-3'>
            <p className='text-sm font-medium text-blue-900'>Ubicación seleccionada:</p>
            <div className='grid grid-cols-2 gap-2'>
              <div>
                <label className='text-xs text-blue-700'>Latitud</label>
                <input
                  type='number'
                  step='0.000001'
                  value={manualLat}
                  onChange={(e) => setManualLat(e.target.value)}
                  className='w-full rounded-md border border-blue-200 bg-white px-2 py-1 text-sm'
                />
              </div>
              <div>
                <label className='text-xs text-blue-700'>Longitud</label>
                <input
                  type='number'
                  step='0.000001'
                  value={manualLng}
                  onChange={(e) => setManualLng(e.target.value)}
                  className='w-full rounded-md border border-blue-200 bg-white px-2 py-1 text-sm'
                />
              </div>
            </div>
            <button
              type='button'
              onClick={handleManualUpdate}
              className='w-full rounded-md bg-blue-600 px-3 py-1 text-sm text-white hover:bg-blue-700'
            >
              Actualizar ubicación
            </button>
          </div>
        )}

        {error && <p className='text-sm text-red-600'>{error}</p>}
      </div>
    </Card>
  );
}
</file>

<file path="src/Components/fixer/steps/Payment-step.tsx">
'use client';

import type React from 'react';

import { Card } from '@/Components/Card';
import { Banknote, CreditCard, QrCode, AlertCircle } from 'lucide-react';

export type PaymentMethod = 'cash' | 'qr' | 'card';

interface PaymentStepProps {
  payments: PaymentMethod[];
  accountInfo: string;
  onTogglePayment: (method: PaymentMethod) => void;
  onAccountInfoChange: (info: string) => void;
  paymentsError?: string;
  accountError?: string;
}

const PAYMENT_CONFIG: Record<PaymentMethod, { label: string; icon: React.ReactNode }> = {
  cash: { label: 'Efectivo', icon: <Banknote className='h-4 w-4' /> },
  qr: { label: 'QR', icon: <QrCode className='h-4 w-4' /> },
  card: { label: 'Tarjeta', icon: <CreditCard className='h-4 w-4' /> },
};

export function PaymentStep({
  payments,
  accountInfo,
  onTogglePayment,
  onAccountInfoChange,
  paymentsError,
  accountError,
}: PaymentStepProps) {
  const needsAccount = payments.includes('qr') || payments.includes('card');

  const handleAccountChange = (value: string) => {
    // Solo permitir números y limitar a 34 caracteres (máximo para CBU/IBAN)
    const numericOnly = value.replace(/\D/g, '').slice(0, 34);
    onAccountInfoChange(numericOnly);
  };

  const getAccountType = () => {
    const length = accountInfo.length;
    if (length === 22) return 'CBU';
    if (length === 24) return 'IBAN';
    if (length > 0 && length < 22) return 'Número incompleto';
    if (length > 24) return 'Número demasiado largo';
    return '';
  };

  return (
    <Card title='Métodos de pago aceptados'>
      <div className='space-y-4'>
        <div className='flex flex-wrap gap-2'>
          {(['cash', 'qr', 'card'] as const).map((m) => (
            <button
              key={m}
              type='button'
              onClick={() => onTogglePayment(m)}
              className={
                'rounded-full px-4 py-2 text-sm transition-all flex items-center gap-2 ' +
                (payments.includes(m)
                  ? 'bg-primary text-white shadow-md scale-105'
                  : 'bg-gray-200 text-gray-900 hover:bg-gray-300')
              }
            >
              {PAYMENT_CONFIG[m].icon}
              {PAYMENT_CONFIG[m].label}
            </button>
          ))}
        </div>

        {needsAccount && (
          <div className='space-y-2 animate-fade-in'>
            <label className='text-sm text-gray-800'>Nro de Cuenta para recibir pagos</label>
            <input
              value={accountInfo}
              onChange={(e) => handleAccountChange(e.target.value)}
              placeholder='Ingrese solo números de su cuenta'
              maxLength={34}
              className='w-full rounded-full bg-gray-200 px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-400 transition-all'
            />
            <div className='flex justify-between items-center px-2'>
              <p className='text-xs text-gray-600'>
                Solo números, máximo 34 caracteres ({accountInfo.length}/34)
              </p>
              <span
                className={`text-xs ${
                  accountInfo.length === 22 || accountInfo.length === 24
                    ? 'text-green-600 font-medium'
                    : 'text-gray-500'
                }`}
              >
                {getAccountType()}
              </span>
            </div>
          </div>
        )}

        {paymentsError && (
          <div className='flex items-center gap-1 text-sm text-red-600'>
            <AlertCircle className='h-4 w-4' />
            <span>{paymentsError}</span>
          </div>
        )}
        {accountError && (
          <div className='flex items-center gap-1 text-sm text-red-600'>
            <AlertCircle className='h-4 w-4' />
            <span>{accountError}</span>
          </div>
        )}
      </div>
    </Card>
  );
}
</file>

<file path="src/Components/fixer/steps/Profile-photo-step.tsx">
'use client';

import type React from 'react';

import { useState } from 'react';
import { Upload, User, X } from 'lucide-react';
import { Card } from '@/Components/Card';
import { fixerService } from '@/app/lib/service/fixer-service';
import Image from 'next/image';

interface ProfilePhotoStepProps {
  photoUrl?: string;
  onPhotoChange: (url: string) => void;
  error?: string;
}

export function ProfilePhotoStep({ photoUrl, onPhotoChange, error }: ProfilePhotoStepProps) {
  const [uploading, setUploading] = useState(false);
  const [preview, setPreview] = useState<string | null>(photoUrl || null);

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // Validar tipo de archivo
    if (!file.type.startsWith('image/')) {
      alert('Por favor seleccione una imagen válida');
      return;
    }

    // Validar tamaño (máximo 5MB)
    if (file.size > 5 * 1024 * 1024) {
      alert('La imagen no debe superar los 5MB');
      return;
    }

    setUploading(true);
    try {
      const url = await fixerService.uploadProfilePhoto(file);
      setPreview(url);
      onPhotoChange(url);
    } catch (err) {
      console.error('Error uploading photo:', err);
      alert('Error al subir la foto');
    } finally {
      setUploading(false);
    }
  };

  const handleRemove = () => {
    setPreview(null);
    onPhotoChange('');
  };

  return (
    <Card title='Foto de Perfil'>
      <div className='space-y-4'>
        <p className='text-sm text-gray-600'>
          Sube una foto de perfil para que los clientes puedan identificarte
        </p>

        <div className='flex flex-col items-center gap-4'>
          {preview ? (
            <div className='relative'>
              <div className='relative h-40 w-40'>
                <Image
                  src={preview || '/placeholder.svg'}
                  alt='Foto de perfil'
                  fill
                  className='rounded-full object-cover ring-4 ring-blue-100'
                />
              </div>
              <button
                type='button'
                onClick={handleRemove}
                className='absolute -right-2 -top-2 rounded-full bg-red-500 p-1.5 text-white shadow-lg transition hover:bg-red-600'
              >
                <X className='h-4 w-4' />
              </button>
            </div>
          ) : (
            <div className='flex h-40 w-40 items-center justify-center rounded-full bg-gray-100 ring-4 ring-gray-200'>
              <User className='h-16 w-16 text-gray-400' />
            </div>
          )}

          <label className='cursor-pointer'>
            <input
              type='file'
              accept='image/*'
              onChange={handleFileChange}
              className='hidden'
              disabled={uploading}
            />
            <div className='flex items-center gap-2 rounded-full bg-primary px-6 py-2.5 text-sm font-medium text-white transition hover:bg-blue-700'>
              <Upload className='h-4 w-4' />
              {uploading ? 'Subiendo...' : preview ? 'Cambiar foto' : 'Subir foto'}
            </div>
          </label>
        </div>

        {error && <p className='text-center text-sm text-red-600'>{error}</p>}

        <div className='rounded-lg bg-blue-50 p-3 text-xs text-blue-800'>
          <p className='font-medium'>Recomendaciones:</p>
          <ul className='mt-1 list-inside list-disc space-y-1'>
            <li>Usa una foto clara de tu rostro</li>
            <li>Formato: JPG, PNG o WebP</li>
            <li>Tamaño máximo: 5MB</li>
          </ul>
        </div>
      </div>
    </Card>
  );
}
</file>

<file path="src/Components/fixer/steps/Services-step.tsx">
'use client';

import type React from 'react';

import { Card } from '@/Components/Card';
import { PillButton } from '../Pill-button';
import { Plus, Edit2, Trash2, Wrench } from 'lucide-react';
import { useState } from 'react';

export interface Service {
  id: string;
  name: string;
  custom?: boolean;
}

interface ServicesStepProps {
  services: Service[];
  selectedServiceIds: string[];
  onToggleService: (id: string) => void;
  onAddCustomService: (name: string) => void;
  onEditService: (id: string, name: string) => void;
  onDeleteService: (id: string) => void;
  error?: string;
}

export function ServicesStep({
  services,
  selectedServiceIds,
  onToggleService,
  onAddCustomService,
  onEditService,
  onDeleteService,
  error,
}: ServicesStepProps) {
  const [newService, setNewService] = useState('');

  const handleServiceChange = (value: string) => {
    const sanitized = value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '').slice(0, 20);
    setNewService(sanitized);
  };

  const handleAddService = () => {
    if (!newService.trim()) {
      alert('Por favor ingresa un nombre para el servicio');
      return;
    }

    if (newService.trim().length < 2) {
      alert('El servicio debe tener al menos 2 caracteres');
      return;
    }

    onAddCustomService(newService.trim());
    setNewService('');
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      handleAddService();
    }
  };

  const handleEdit = (service: Service) => {
    const newName = prompt('Editar servicio', service.name);
    if (newName) {
      const sanitized = newName.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '').slice(0, 20);
      if (sanitized.trim().length >= 2) {
        onEditService(service.id, sanitized.trim());
      } else {
        alert('El servicio debe tener al menos 2 caracteres y solo contener letras');
      }
    }
  };

  return (
    <Card title='Selecciona tus servicios'>
      <div className='space-y-4'>
        <div className='flex items-center gap-2 text-sm text-gray-600'>
          <Wrench className='h-4 w-4' />
          <span>Selecciona los servicios que ofreces</span>
        </div>

        <div className='grid grid-cols-1 gap-2 md:grid-cols-2'>
          {services.map((s) => (
            <label
              key={s.id}
              className='flex items-center gap-2 rounded-full bg-gray-200 px-4 py-2 text-sm text-gray-900 hover:bg-gray-300 transition-colors cursor-pointer'
            >
              <input
                type='checkbox'
                checked={selectedServiceIds.includes(s.id)}
                onChange={() => onToggleService(s.id)}
                className='h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500'
              />
              <span className='flex-1 truncate'>{s.name}</span>
              {s.custom && (
                <span className='flex gap-2 text-xs'>
                  <button
                    type='button'
                    className='text-blue-600 hover:text-blue-800 transition-colors'
                    onClick={(e) => {
                      e.preventDefault();
                      handleEdit(s);
                    }}
                    title='Editar servicio'
                  >
                    <Edit2 className='h-3 w-3' />
                  </button>
                  <button
                    type='button'
                    className='text-red-600 hover:text-red-700 transition-colors'
                    onClick={(e) => {
                      e.preventDefault();
                      onDeleteService(s.id);
                    }}
                    title='Eliminar servicio'
                  >
                    <Trash2 className='h-3 w-3' />
                  </button>
                </span>
              )}
            </label>
          ))}
        </div>

        <div className='space-y-2'>
          <div className='flex items-center gap-2'>
            <input
              value={newService}
              onChange={(e) => handleServiceChange(e.target.value)}
              onKeyPress={handleKeyPress}
              placeholder='Añadir nuevo servicio'
              maxLength={20}
              className='flex-1 rounded-full bg-gray-200 px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-400 transition-all'
            />
            <PillButton
              className='bg-blue-600 text-white hover:bg-blue-800 flex items-center gap-2'
              onClick={handleAddService}
            >
              <Plus className='h-4 w-4' />
              Agregar
            </PillButton>
          </div>
          <p className='text-xs text-gray-600 px-2'>
            Solo letras, máximo 20 caracteres ({newService.length}/20)
            {newService.trim().length < 2 && newService.length > 0 && (
              <span className='text-amber-600 ml-1'>Mínimo 2 caracteres</span>
            )}
          </p>
        </div>
        {error && <p className='text-sm text-red-600'>{error}</p>}
      </div>
    </Card>
  );
}
</file>

<file path="src/Components/fixer/steps/Terms-step.tsx">
'use client';

import { Card } from '@/Components/Card';

interface TermsStepProps {
  accepted: boolean;
  onAcceptChange: (accepted: boolean) => void;
  error?: string;
}

export function TermsStep({ accepted, onAcceptChange, error }: TermsStepProps) {
  return (
    <Card title='Términos y Condiciones'>
      <div className='space-y-4'>
        <div className='max-h-96 overflow-y-auto rounded-lg border border-gray-200 bg-gray-50 p-4 text-sm text-gray-700'>
          <h3 className='font-bold text-gray-900 mb-3 text-base'>
            Términos y Condiciones – Plataforma Fixers
          </h3>

          <div className='space-y-4'>
            <section>
              <h4 className='font-semibold text-gray-800 mb-2'>1. ACEPTACIÓN DE TÉRMINOS</h4>
              <p className='text-xs leading-relaxed'>
                Al acceder y utilizar la plataforma Fixers, usted acepta cumplir y estar sujeto a
                los presentes Términos y Condiciones. Si no está de acuerdo con alguna parte de
                estos términos, no podrá acceder ni utilizar el servicio.
              </p>
            </section>

            <section>
              <h4 className='font-semibold text-gray-800 mb-2'>2. DESCRIPCIÓN DEL SERVICIO</h4>
              <p className='text-xs leading-relaxed mb-2'>
                Fixers es una plataforma digital que conecta trabajadores independientes (Fixers)
                con personas o empresas que requieren servicios específicos. A través del sistema,
                los usuarios pueden:
              </p>
              <ul className='text-xs leading-relaxed list-disc list-inside ml-2 space-y-1'>
                <li>Registrar su cuenta como Fixer (trabajador) o como cliente.</li>
                <li>Crear y publicar ofertas de trabajo.</li>
                <li>Ver listados de trabajos disponibles.</li>
                <li>Visualizar en el mapa las ofertas publicadas cercanas a su ubicación.</li>
              </ul>
              <p className='text-xs leading-relaxed mt-2'>
                Fixers actúa únicamente como intermediario tecnológico entre las partes, sin asumir
                responsabilidad directa por la ejecución de los trabajos ni la relación contractual
                entre usuario y fixer.
              </p>
            </section>

            <section>
              <h4 className='font-semibold text-gray-800 mb-2'>3. USO DEL SERVICIO</h4>
              <p className='text-xs leading-relaxed mb-2'>
                Usted se compromete a utilizar el servicio de manera responsable y conforme a las
                leyes aplicables. Está prohibido utilizar Fixers para cualquier propósito ilegal,
                fraudulento o no autorizado.
              </p>
              <p className='text-xs leading-relaxed mb-1'>Como usuario, usted es responsable de:</p>
              <ul className='text-xs leading-relaxed list-disc list-inside ml-2 space-y-1'>
                <li>Mantener la confidencialidad de su cuenta y contraseña.</li>
                <li>
                  Verificar la veracidad de la información que publica (datos personales, ofertas o
                  servicios).
                </li>
                <li>No publicar contenido ofensivo, engañoso o que viole derechos de terceros.</li>
              </ul>
              <p className='text-xs leading-relaxed mt-2'>
                El incumplimiento de estas normas puede derivar en la suspensión o eliminación de la
                cuenta.
              </p>
            </section>

            <section>
              <h4 className='font-semibold text-gray-800 mb-2'>4. REGISTRO DE FIXERS</h4>
              <p className='text-xs leading-relaxed'>
                Para registrarse como Fixer (trabajador), deberá proporcionar información veraz,
                completa y actualizada. El registro implica aceptar que su perfil y ubicación puedan
                mostrarse en el mapa o listados de trabajos con fines de conexión laboral. Fixers
                podrá verificar la información proporcionada, pero no garantiza la exactitud ni
                autenticidad de los datos de los usuarios registrados.
              </p>
            </section>

            <section>
              <h4 className='font-semibold text-gray-800 mb-2'>
                5. PUBLICACIÓN Y GESTIÓN DE OFERTAS
              </h4>
              <p className='text-xs leading-relaxed'>
                Los fixers pueden crear y publicar ofertas de trabajo o servicios. Toda publicación
                debe cumplir con las políticas de la plataforma y no contener información falsa,
                discriminatoria o inapropiada. El sistema se reserva el derecho de eliminar
                cualquier oferta que incumpla estas normas o afecte la calidad del servicio.
              </p>
            </section>

            <section>
              <h4 className='font-semibold text-gray-800 mb-2'>6. PRIVACIDAD Y DATOS PERSONALES</h4>
              <p className='text-xs leading-relaxed'>
                La recopilación y uso de la información personal se rige por nuestra Política de
                Privacidad. Al utilizar Fixers, usted consiente que procesemos sus datos con el fin
                de mejorar la experiencia del servicio, mostrar trabajos en el mapa y facilitar la
                comunicación entre usuarios. Nos comprometemos a proteger su información y a no
                compartirla con terceros sin su consentimiento, salvo en los casos legalmente
                permitidos.
              </p>
            </section>

            <section>
              <h4 className='font-semibold text-gray-800 mb-2'>
                7. MODIFICAR DATOS DEL PERFIL (REQUESTER)
              </h4>
              <p className='text-xs leading-relaxed mb-2'>
                Esta funcionalidad permite al usuario con rol Requester modificar ciertos datos
                personales de su cuenta, específicamente:
              </p>
              <ul className='text-xs leading-relaxed list-disc list-inside ml-2 space-y-1'>
                <li>
                  <strong>Número de teléfono:</strong> utilizado como medio principal de contacto y
                  verificación.
                </li>
                <li>
                  <strong>Ubicación:</strong> información geográfica del usuario, obtenida de manera
                  manual o automática (GPS).
                </li>
              </ul>
              <p className='text-xs leading-relaxed mt-2 mb-1'>
                <strong>Validación y restricciones:</strong>
              </p>
              <ul className='text-xs leading-relaxed list-disc list-inside ml-2 space-y-1'>
                <li>
                  El sistema verifica que el número de teléfono no esté registrado por otro usuario.
                </li>
                <li>Solo puede actualizar 3 veces al mes (máximo) su ubicación.</li>
                <li>Solo puede actualizar 2 veces al mes su número (máximo) de teléfono.</li>
              </ul>
            </section>

            <section>
              <h4 className='font-semibold text-gray-800 mb-2'>8. TÉRMINOS DE PAGO</h4>
              <p className='text-xs leading-relaxed mb-2'>
                <strong>Métodos de Pago Aceptados:</strong>
              </p>
              <ul className='text-xs leading-relaxed list-disc list-inside ml-2 space-y-1'>
                <li>
                  <strong>Tarjeta de Crédito/Débito:</strong> Procesados a través de Stripe. No
                  almacenamos datos completos de tarjetas.
                </li>
                <li>
                  <strong>Pago QR:</strong> Código QR compatible con plataformas bancarias de
                  Bolivia.
                </li>
                <li>
                  <strong>Pago en Efectivo:</strong> Sistema de verificación mediante código único
                  temporal.
                </li>
              </ul>
              <p className='text-xs leading-relaxed mt-2'>
                Los reembolsos se procesarán al método de pago original. Para disputas, contactar a
                soporte dentro de 7 días desde la transacción.
              </p>
            </section>

            <section>
              <h4 className='font-semibold text-gray-800 mb-2'>9. PROPIEDAD INTELECTUAL</h4>
              <p className='text-xs leading-relaxed'>
                Todo el contenido de la plataforma Fixers (diseño, logotipos, software, textos,
                gráficos y funcionalidades) es propiedad de Fixers o sus licenciantes, y está
                protegido por las leyes de propiedad intelectual vigentes. Queda prohibida la
                reproducción, modificación o distribución sin autorización previa y por escrito.
              </p>
            </section>

            <section>
              <h4 className='font-semibold text-gray-800 mb-2'>
                10. LIMITACIÓN DE RESPONSABILIDAD
              </h4>
              <p className='text-xs leading-relaxed mb-1'>Fixers no se responsabiliza por:</p>
              <ul className='text-xs leading-relaxed list-disc list-inside ml-2 space-y-1'>
                <li>
                  La calidad, cumplimiento o resultados de los trabajos realizados por los Fixers.
                </li>
                <li>Cualquier daño directo o indirecto derivado del uso del servicio.</li>
                <li>Errores técnicos, interrupciones o fallas en la plataforma.</li>
              </ul>
              <p className='text-xs leading-relaxed mt-2'>
                La plataforma se ofrece &quot;tal cual&quot;, sin garantías de disponibilidad o
                resultados específicos.
              </p>
            </section>

            <section>
              <h4 className='font-semibold text-gray-800 mb-2'>
                11. MODIFICACIONES DE LOS TÉRMINOS
              </h4>
              <p className='text-xs leading-relaxed'>
                Fixers se reserva el derecho de modificar estos términos en cualquier momento. Las
                modificaciones entrarán en vigor al ser publicadas en la plataforma. El uso
                continuado del servicio tras los cambios constituirá su aceptación de los nuevos
                términos.
              </p>
            </section>

            <section>
              <h4 className='font-semibold text-gray-800 mb-2'>12. SUSPENSIÓN Y TERMINACIÓN</h4>
              <p className='text-xs leading-relaxed'>
                El Sistema puede suspender o eliminar cuentas que incumplan los términos
                establecidos, sin previo aviso. Las disposiciones relacionadas con propiedad
                intelectual, limitación de responsabilidad y privacidad seguirán vigentes tras la
                terminación.
              </p>
            </section>

            <section>
              <h4 className='font-semibold text-gray-800 mb-2'>13. LEY APLICABLE</h4>
              <p className='text-xs leading-relaxed'>
                Estos términos se regirán por las leyes vigentes en Bolivia, sin perjuicio de sus
                normas sobre conflictos de leyes. Cualquier disputa será resuelta ante los
                tribunales competentes de Cochabamba.
              </p>
            </section>

            <section>
              <h4 className='font-semibold text-gray-800 mb-2'>14. CONTACTO</h4>
              <p className='text-xs leading-relaxed'>
                Si tiene preguntas o comentarios sobre estos términos, puede comunicarse con
                nosotros a través de:
                <strong> lumon@gmail.com</strong>, <strong>Innosys@gmail.com</strong> o mediante el
                formulario de contacto disponible en la plataforma.
              </p>
            </section>
          </div>
        </div>

        <label className='flex items-start gap-3 cursor-pointer'>
          <input
            type='checkbox'
            checked={accepted}
            onChange={(e) => onAcceptChange(e.target.checked)}
            className='mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-2 focus:ring-blue-500'
          />
          <span className='text-sm text-gray-700'>
            He leído y acepto los términos y condiciones para convertirme en FIXER
          </span>
        </label>

        {error && <p className='text-xs text-red-600'>{error}</p>}
      </div>
    </Card>
  );
}
</file>

<file path="src/Components/fixer/steps/Vehicle-step.tsx">
'use client';

import { Card } from '@/Components/Card';

interface VehicleStepProps {
  hasVehicle: boolean | null;
  vehicleType?: string;
  onHasVehicleChange: (hasVehicle: boolean) => void;
  onVehicleTypeChange: (type: string) => void;
  error?: string;
}

export function VehicleStep({
  hasVehicle,
  vehicleType = '',
  onHasVehicleChange,
  onVehicleTypeChange,
  error,
}: VehicleStepProps) {
  return (
    <Card title='Vehículo Propio'>
      <div className='space-y-4'>
        <p className='text-sm text-gray-600'>
          ¿Cuenta con vehículo propio para realizar los trabajos?
        </p>

        <div className='space-y-3'>
          <label className='flex items-center gap-3 rounded-lg border border-gray-200 p-4 cursor-pointer hover:bg-gray-50 transition-colors'>
            <input
              type='radio'
              name='hasVehicle'
              checked={hasVehicle === true}
              onChange={() => onHasVehicleChange(true)}
              className='h-4 w-4 text-primary focus:ring-2 focus:ring-blue-500'
            />
            <div>
              <div className='font-medium text-gray-900'>Sí, tengo vehículo</div>
              <div className='text-xs text-gray-500'>
                Puedo transportar herramientas y materiales
              </div>
            </div>
          </label>

          <label className='flex items-center gap-3 rounded-lg border border-gray-200 p-4 cursor-pointer hover:bg-gray-50 transition-colors'>
            <input
              type='radio'
              name='hasVehicle'
              checked={hasVehicle === false}
              onChange={() => onHasVehicleChange(false)}
              className='h-4 w-4 text-primary focus:ring-2 focus:ring-blue-500'
            />
            <div>
              <div className='font-medium text-gray-900'>No tengo vehículo</div>
              <div className='text-xs text-gray-500'>Me movilizo en transporte público</div>
            </div>
          </label>
        </div>

        {hasVehicle === true && (
          <div className='mt-4 animate-fade-in'>
            <label htmlFor='vehicleType' className='block text-sm font-medium text-gray-700 mb-2'>
              Tipo de vehículo
            </label>
            <select
              id='vehicleType'
              value={vehicleType}
              onChange={(e) => onVehicleTypeChange(e.target.value)}
              className='w-full rounded-lg border border-gray-300 px-4 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500'
            >
              <option value=''>Seleccione un tipo</option>
              <option value='moto'>Motocicleta</option>
              <option value='auto'>Automóvil</option>
              <option value='camioneta'>Camioneta</option>
              <option value='furgoneta'>Furgoneta</option>
            </select>
          </div>
        )}

        {error && <p className='text-xs text-red-600'>{error}</p>}
      </div>
    </Card>
  );
}
</file>

<file path="src/Components/FixerCard.tsx">
'use client';

import { Fixer } from '@/hooks/useFixersByJob';
import Link from 'next/link';
import Image from 'next/image';
import { Star } from 'lucide-react';

interface FixerCardProps {
  fixer: Fixer;
}

export function FixerCard({ fixer }: FixerCardProps) {
  return (
    <Link href={`/fixer/${fixer.id}`}>
      <div className='p-4 border border-gray-200 rounded-lg hover:shadow-md hover:border-blue-300 transition-all cursor-pointer bg-white'>
        <div className='flex items-start justify-between'>
          <div className='flex gap-3 flex-1'>
            {fixer.avatar && (
              <Image
                src={fixer.avatar}
                alt={fixer.name}
                width={48} // 12 * 4px (w-12)
                height={48} // 12 * 4px (h-12)
                className='rounded-full object-cover'
              />
            )}

            <div className='flex-1'>
              <h4 className='font-semibold text-gray-800 hover:text-blue-600'>{fixer.name}</h4>
              <p className='text-sm text-gray-600'>{fixer.city}</p>
            </div>
          </div>

          <div className='flex items-center gap-1'>
            <Star className='w-4 h-4 fill-yellow-400 text-yellow-400' />
            <span className='text-sm font-medium text-gray-700'>{fixer.rating}</span>
          </div>
        </div>
      </div>
    </Link>
  );
}
</file>

<file path="src/Components/Footer.tsx">
import React from 'react';

const Footer = () => {
  return <div>mi componente Foooter</div>;
};

export default Footer;
</file>

<file path="src/Components/Home/CTA-section.tsx">
'use client';
import { useTranslations } from 'next-intl';
import Link from 'next/link';

export default function CTASection() {
  const t = useTranslations('cta');
  return (
    <section
      id='tour-cta-section'
      className='py-16 px-4 bg-gradient-to-r from-primary to-primary/90 text-white'
    >
      <div className='max-w-4xl mx-auto text-center'>
        <h2 className='text-3xl md:text-4xl font-bold mb-6'>{t('footerTitle')}</h2>
        <p className='text-xl mb-8 opacity-90'>{t('footerSubtitle')}</p>
        <div className='flex flex-col sm:flex-row justify-center gap-4'>
          <Link
            href='/signUp'
            className='px-8 py-3 bg-white text-primary font-semibold rounded-lg hover:bg-gray-100 transition-colors'
          >
            {t('footerButton')}
          </Link>
          <Link
            href='/servicios'
            className='px-8 py-3 border-2 border-white text-white font-semibold rounded-lg hover:bg-white/10 transition-colors'
          >
            {t('footerButtonView')}
          </Link>
        </div>
      </div>
    </section>
  );
}
</file>

<file path="src/Components/Home/HowItWorks-section.tsx">
'use client';
import { Search, UserCheck, MessageSquare, Star } from 'lucide-react';

export default function HowItWorksSection() {
  const steps = [
    {
      icon: <Search className='w-8 h-8 text-primary' />,
      title: 'Busca',
      description: 'Encuentra el servicio que necesitas',
    },
    {
      icon: <UserCheck className='w-8 h-8 text-primary' />,
      title: 'Compara',
      description: 'Revisa perfiles y calificaciones',
    },
    {
      icon: <MessageSquare className='w-8 h-8 text-primary' />,
      title: 'Contacta',
      description: 'Habla directamente con los profesionales',
    },
    {
      icon: <Star className='w-8 h-8 text-primary' />,
      title: 'Califica',
      description: 'Comparte tu experiencia',
    },
  ];

  return (
    <section id='tour-how-it-works' className='py-16 px-4 bg-gray-50'>
      <div className='max-w-7xl mx-auto'>
        <div className='text-center mb-12'>
          <h2 className='text-3xl md:text-4xl font-bold text-gray-800 mb-4'>¿Cómo funciona?</h2>
          <p className='text-lg text-gray-600 max-w-2xl mx-auto'>
            Encuentra y contrata al profesional ideal en simples pasos
          </p>
        </div>

        <div className='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8'>
          {steps.map((step, index) => (
            <div
              key={index}
              className='bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300'
            >
              <div className='w-16 h-16 mb-4 mx-auto bg-primary/10 rounded-full flex items-center justify-center text-primary'>
                {step.icon}
              </div>
              <h3 className='text-xl font-semibold text-center text-gray-800 mb-2'>{step.title}</h3>
              <p className='text-gray-600 text-center'>{step.description}</p>
            </div>
          ))}
        </div>
      </div>
    </section>
  );
}
</file>

<file path="src/Components/Home/Inspiration-section.tsx">
'use client';

import { useState, useEffect, TouchEvent } from 'react';
import Image from 'next/image';
import { ChevronLeft, ChevronRight } from 'lucide-react';
import { useTranslations } from 'next-intl';
import type { StaticImageData } from 'next/image';

import carpinteriaImg from '../../../public/es/img/carpinteria.png';
import electricistaImg from '../../../public/es/img/electricista.png';
import limpiezaImg from '../../../public/es/img/limpieza.png';
import pinturaImg from '../../../public/es/img/pintura.png';
import plomeriaImg from '../../../public/es/img/plomeria.png';
import fallbackImg from '../../../public/fallback-image.svg';

interface Slide {
  image: StaticImageData | string;
  category: string;
  title: string;
  subtitle: string;
  description: string;
}

const slides: Slide[] = [
  {
    image: carpinteriaImg,
    category: 'CARPINTERÍA',
    title: 'Muebles y carpintería a medida',
    subtitle: 'Carpintería y muebles a medida',
    description: 'Profesionales especializados en trabajos de carpintería y muebles personalizados',
  },
  {
    image: electricistaImg,
    category: 'ELECTRICIDAD',
    title: 'Soluciones eléctricas seguras',
    subtitle: 'Instalaciones y reparaciones eléctricas',
    description: 'Expertos en instalaciones eléctricas residenciales e industriales',
  },
  {
    image: limpiezaImg,
    category: 'LIMPIEZA',
    title: 'Espacios impecables, vida saludable',
    subtitle: 'Servicios de limpieza profesional',
    description: 'Limpieza completa para hogares y oficinas con productos eco-amigables',
  },
  {
    image: pinturaImg,
    category: 'PINTURA',
    title: 'Renueva tus espacios con color',
    subtitle: 'Pintura de interiores y exteriores',
    description: 'Transforma tu hogar con colores que reflejan tu personalidad',
  },
  {
    image: plomeriaImg,
    category: 'PLOMERÍA',
    title: 'Soluciones expertas para tus tuberías',
    subtitle: 'Reparación e instalación de plomería',
    description: 'Soluciones rápidas y efectivas para todos tus problemas de plomería',
  },
];

const PREFETCH_TIMEOUT_MS = 3000;
const fallbackSrc = fallbackImg;
const blurDataURL =
  'data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMDAnIGhlaWdodD0nMTAwJz48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9J2cnIHgxPScwJyB5MT0nMCcgeDI9JzEnIHkyPScxJz48c3RvcCBvZmZzZXQ9JzAnIHN0b3AtY29sb3I9JyMwZWF1ZWUnLz48c3RvcCBvZmZzZXQ9JzEnIHN0b3AtY29sb3I9JyMxZTNhOGEnLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgZmlsbD0ndXJsKCNnKScvPjwvc3ZnPiI=';

export default function InspirationSection() {
  const t = useTranslations('Inspiration');
  const [currentIndex, setCurrentIndex] = useState<number>(0);
  const [failedMap, setFailedMap] = useState<Record<number, boolean>>({});
  const [loadingMap, setLoadingMap] = useState<Record<number, boolean>>(() =>
    Object.fromEntries(slides.map((_, i) => [i, true])),
  );

  const [touchStart, setTouchStart] = useState<number>(0);
  const [touchEnd, setTouchEnd] = useState<number>(0);

  // Preload images
  useEffect(() => {
    if (typeof window === 'undefined') return;

    const preloadIndexes = [
      currentIndex,
      (currentIndex + 1) % slides.length,
      (currentIndex - 1 + slides.length) % slides.length,
    ];

    preloadIndexes.forEach((index) => {
      try {
        const img = new window.Image();
        let settled = false;
        const timer = window.setTimeout(() => {
          if (!settled) {
            setFailedMap((prev) => ({ ...prev, [index]: true }));
          }
        }, PREFETCH_TIMEOUT_MS);

        img.onload = () => {
          settled = true;
          window.clearTimeout(timer);
        };
        img.onerror = () => {
          settled = true;
          window.clearTimeout(timer);
          setFailedMap((prev) => ({ ...prev, [index]: true }));
        };
        const src =
          typeof slides[index].image === 'string' ? slides[index].image : slides[index].image.src;
        img.src = src;
      } catch {
        setFailedMap((prev) => ({ ...prev, [index]: true }));
      }
    });
  }, [currentIndex]);

  // Touch handlers
  const handleTouchStart = (e: TouchEvent<HTMLDivElement>) => {
    setTouchStart(e.targetTouches[0].clientX);
  };

  const handleTouchMove = (e: TouchEvent<HTMLDivElement>) => {
    setTouchEnd(e.targetTouches[0].clientX);
  };

  const handleTouchEnd = () => {
    if (touchStart - touchEnd > 150) {
      nextSlide();
    }
    if (touchStart - touchEnd < -150) {
      prevSlide();
    }
  };

  const prevSlide = () => {
    setCurrentIndex((prev) => (prev - 1 + slides.length) % slides.length);
  };

  const nextSlide = () => {
    setCurrentIndex((prev) => (prev + 1) % slides.length);
  };

  // Auto-play
  useEffect(() => {
    const interval = setInterval(() => {
      setCurrentIndex((prev) => (prev + 1) % slides.length);
    }, 8000);
    return () => clearInterval(interval);
  }, []);

  // Keyboard navigation
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'ArrowLeft') {
        prevSlide();
      } else if (e.key === 'ArrowRight') {
        nextSlide();
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => {
      window.removeEventListener('keydown', handleKeyDown);
    };
  }, []);

  return (
    <section id='tour-inspiration-section' className='py-16 px-4 bg-white'>
      <div className='max-w-5xl mx-auto'>
        {/* Header */}
        <div className='text-center mb-12'>
          <h2 className='text-3xl md:text-4xl font-bold text-gray-800 mb-4'>{t('insTitle')}</h2>
          <p className='text-lg text-gray-600 max-w-2xl mx-auto'>{t('insDescription')}</p>
        </div>

        {/* Carousel */}
        <div
          className='carrusel-container'
          onTouchStart={handleTouchStart}
          onTouchMove={handleTouchMove}
          onTouchEnd={handleTouchEnd}
        >
          {slides.map((slide, index) => (
            <div key={index} className={`carrusel-slide ${index === currentIndex ? 'active' : ''}`}>
              <Image
                src={failedMap[index] ? fallbackSrc : slide.image}
                alt={slide.title}
                fill
                style={{ objectFit: 'cover' }}
                className='carrusel-image'
                priority={index === 0}
                placeholder='blur'
                blurDataURL={blurDataURL}
                onError={() => {
                  setFailedMap((prev) => ({ ...prev, [index]: true }));
                }}
                onLoad={() => {
                  setLoadingMap((prev) => ({ ...prev, [index]: false }));
                }}
              />

              {loadingMap[index] && <div className='carrusel-skeleton' />}

              <div className='carrusel-overlay'></div>
              <div className='carrusel-content'>
                <span className='carrusel-category bg-primary text-white px-4 py-2 rounded-lg font-bold text-sm [text-shadow:_0_0_8px_black,_0_0_4px_black,_0_0_2px_black]'>
                  {slide.category}
                </span>

                <div className='carrusel-text-group'>
                  <h2 className='carrusel-title text-white font-bold text-3xl md:text-5xl [text-shadow:_0_0_20px_black,_0_0_12px_black,_0_0_6px_black,_0_0_3px_black]'>
                    {slide.title}
                  </h2>

                  <p className='carrusel-subtitle text-white font-medium text-lg md:text-xl [text-shadow:_0_0_12px_black,_0_0_6px_black,_0_0_3px_black]'>
                    {slide.subtitle}
                  </p>
                </div>
              </div>
            </div>
          ))}

          <button
            onClick={prevSlide}
            className='carrusel-arrow carrusel-arrow-left'
            aria-label='Diapositiva anterior'
          >
            <ChevronLeft className='w-6 h-6' />
          </button>
          <button
            onClick={nextSlide}
            className='carrusel-arrow carrusel-arrow-right'
            aria-label='Diapositiva siguiente'
          >
            <ChevronRight className='w-6 h-6' />
          </button>
          <div className='carrusel-dots'>
            {slides.map((_, index) => (
              <span
                key={index}
                className={`carrusel-dot ${currentIndex === index ? 'active' : ''}`}
                onClick={() => setCurrentIndex(index)}
              ></span>
            ))}
          </div>
        </div>
      </div>
    </section>
  );
}
</file>

<file path="src/Components/Home/Map-section.tsx">
'use client';
import React, { useEffect, useState } from 'react';
import { useTranslations } from 'next-intl';
import dynamic from 'next/dynamic';

const MapComponent = dynamic(() => import('@/app/Mapa/Map'), {
  loading: () => (
    <div className='h-full w-full flex items-center justify-center bg-gray-100 text-gray-500'>
      Cargando mapa...
    </div>
  ),
  ssr: false,
});

export default function MapSection() {
  const t = useTranslations('Map');
  const [isMounted, setIsMounted] = useState(false);

  useEffect(() => {
    setIsMounted(true);
  }, []);

  return (
    <div className='mb-16 scroll-mt-32'>
      <div className='text-center mb-8'>
        <h2 className='text-3xl md:text-4xl font-bold text-gray-800 mb-4'>{t('mapTitle')}</h2>
        <p className='text-lg text-gray-600 max-w-2xl mx-auto'>{t('mapDescription')}</p>
      </div>

      {/* ✅ ID en el contenedor del mapa */}
      <div
        id='titulo-seccion-mapa'
        className='h-[60vh] w-full bg-gray-100 rounded-xl overflow-hidden relative shadow-sm border border-gray-200'
      >
        {isMounted && <MapComponent />}
      </div>
    </div>
  );
}
</file>

<file path="src/Components/Home/RecentOffer-secction.tsx">
'use client';

import { useEffect, useState, useRef } from 'react';
import Link from 'next/link';
import { ChevronLeft, ChevronRight, SlidersHorizontal } from 'lucide-react';
import { useTranslations } from 'next-intl';
import { JobOfferCard } from '@/Components/Job-offers/JobOfferCard';
import { JobOfferModal } from '../Job-offers/Job-offer-modal';
import { useGetRecentOffersQuery } from '@/app/redux/services/jobOffersApi';
import { DB_VALUES } from '@/app/redux/contants';
import type { JobOfferData, AdaptedJobOffer } from '@/types/jobOffers';
import { adaptOfferToModalFormat } from '@/types/jobOffers';

export default function RecentOffersSection() {
  const t = useTranslations('RecentOffer');
  const tCat = useTranslations('Categories');
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const CATEGORIES = DB_VALUES.categories;

  const [selectedCategory, setSelectedCategory] = useState('Todos');
  const [selectedOffer, setSelectedOffer] = useState<AdaptedJobOffer | null>(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [canScrollLeft, setCanScrollLeft] = useState(false);
  const [canScrollRight, setCanScrollRight] = useState(true);
  const [isMobile, setIsMobile] = useState(false);

  const {
    data: offersData,
    isLoading,
    error: fetchError,
  } = useGetRecentOffersQuery({
    category: selectedCategory !== 'Todos' ? selectedCategory : undefined,
    limit: 8,
  });

  const trabajos = offersData?.data || [];
  const error = fetchError ? 'Error al cargar ofertas' : null;

  // Detectar móvil
  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768);
    };

    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  // Check scroll state
  useEffect(() => {
    const container = scrollContainerRef.current;
    if (!container) return;

    const checkScroll = () => {
      setCanScrollLeft(container.scrollLeft > 0);
      setCanScrollRight(container.scrollLeft < container.scrollWidth - container.clientWidth - 10);
    };

    checkScroll();
    container.addEventListener('scroll', checkScroll);
    return () => container.removeEventListener('scroll', checkScroll);
  }, [selectedCategory]);

  const handleCardClick = (offer: JobOfferData) => {
    const adaptedOffer = adaptOfferToModalFormat(offer);
    setSelectedOffer(adaptedOffer);
    setIsModalOpen(true);
  };

  const handleCategorySelect = (category: string) => {
    setSelectedCategory(category);
  };

  const scroll = (direction: 'left' | 'right') => {
    const container = scrollContainerRef.current;
    if (!container) return;

    const scrollAmount = 200;
    const newScrollLeft =
      direction === 'left'
        ? container.scrollLeft - scrollAmount
        : container.scrollLeft + scrollAmount;

    container.scrollTo({
      left: newScrollLeft,
      behavior: 'smooth',
    });
  };

  return (
    <section id='tour-recent-offers' className='w-full py-12 px-4'>
      <div className='max-w-7xl mx-auto'>
        {/* Header */}
        <div className='flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4'>
          <div>
            <h2 className='text-3xl font-bold text-gray-900 mb-2'>{t('recOfTitle')}</h2>
            <p className='text-gray-600'>{t('recOfDescription')}</p>
          </div>

          <Link
            href='/job-offer-list'
            className='inline-flex items-center gap-2 px-6 py-3 bg-primary text-white font-medium rounded-xl hover:bg-primary/90 transition-all hover:shadow-lg'
          >
            {t('viewAll')}
            <svg className='w-4 h-4' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
              <path strokeLinecap='round' strokeLinejoin='round' strokeWidth={2} d='M9 5l7 7-7 7' />
            </svg>
          </Link>
        </div>

        {/* Category Filter */}
        <div id='tour-category-filters' className='mb-6'>
          {isMobile ? (
            <div className='relative'>
              <div className='flex items-center gap-2'>
                <button
                  onClick={() => scroll('left')}
                  disabled={!canScrollLeft}
                  className={`flex-shrink-0 p-2 rounded-lg transition-all ${
                    canScrollLeft
                      ? 'bg-white border-2 border-gray-200 hover:border-primary text-gray-700 hover:text-primary shadow-sm'
                      : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                  }`}
                  aria-label='Scroll left'
                >
                  <ChevronLeft className='w-5 h-5' />
                </button>

                <div
                  ref={scrollContainerRef}
                  className='flex gap-2 overflow-x-auto scrollbar-hide scroll-smooth flex-1'
                  style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}
                >
                  {CATEGORIES.map((cat) => (
                    <button
                      key={cat}
                      onClick={() => handleCategorySelect(cat)}
                      className={`flex-shrink-0 px-4 py-2 rounded-xl font-medium transition-all ${
                        selectedCategory === cat
                          ? 'bg-gradient-to-r from-primary to-blue-600 text-white shadow-md'
                          : 'bg-white border-2 border-gray-200 text-gray-700 hover:border-primary hover:text-primary'
                      }`}
                    >
                      {tCat(cat)}
                    </button>
                  ))}
                </div>

                <button
                  onClick={() => scroll('right')}
                  disabled={!canScrollRight}
                  className={`flex-shrink-0 p-2 rounded-lg transition-all ${
                    canScrollRight
                      ? 'bg-white border-2 border-gray-200 hover:border-primary text-gray-700 hover:text-primary shadow-sm'
                      : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                  }`}
                  aria-label='Scroll right'
                >
                  <ChevronRight className='w-5 h-5' />
                </button>
              </div>
            </div>
          ) : (
            <div className='flex flex-wrap gap-2'>
              {CATEGORIES.map((cat) => (
                <button
                  key={cat}
                  onClick={() => handleCategorySelect(cat)}
                  className={`px-4 py-2 rounded-xl font-medium transition-all ${
                    selectedCategory === cat
                      ? 'bg-gradient-to-r from-primary to-blue-600 text-white shadow-md'
                      : 'bg-white border-2 border-gray-200 text-gray-700 hover:border-primary hover:text-primary'
                  }`}
                >
                  {tCat(cat)}
                </button>
              ))}
            </div>
          )}
        </div>

        {/* Loading State */}
        {isLoading && (
          <div className='flex justify-center items-center py-12'>
            <div className='animate-spin rounded-full h-12 w-12 border-b-2 border-primary'></div>
          </div>
        )}

        {/* Error State */}
        {error && !isLoading && (
          <div className='text-center py-12'>
            <p className='text-red-500 mb-4'>{error}</p>
          </div>
        )}

        {/* Offers Grid */}
        {!isLoading && !error && trabajos.length > 0 && (
          <div className='grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6'>
            {trabajos.map((trabajo) => (
              <JobOfferCard
                key={trabajo._id}
                offer={trabajo}
                viewMode='grid'
                onClick={handleCardClick}
              />
            ))}
          </div>
        )}

        {/* Empty State */}
        {!isLoading && !error && trabajos.length === 0 && (
          <div className='text-center py-12'>
            <div className='inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4'>
              <SlidersHorizontal className='w-8 h-8 text-gray-400' />
            </div>
            <h3 className='text-lg font-medium text-gray-900 mb-2'>{t('noOffersAvailable')}</h3>
            <p className='text-gray-500'>{t('noOffersCategory')}</p>
          </div>
        )}
      </div>

      {/* Modal */}
      <JobOfferModal
        offer={selectedOffer}
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
      />

      <style jsx>{`
        .scrollbar-hide::-webkit-scrollbar {
          display: none;
        }
      `}</style>
    </section>
  );
}
</file>

<file path="src/Components/Home/Services-section.tsx">
'use client';

import { useRouter } from 'next/navigation';
import { useState } from 'react';
import Link from 'next/link';

export type Service = {
  name: string;
  icon: string;
  description: string;
  demand: number;
  slug: string;
  image?: string;
};

export const services: Service[] = [
  {
    name: 'Plomería',
    icon: '🔧',
    description: 'Instalaciones, reparaciones y mantenimiento',
    demand: 95,
    slug: 'plomeria',
    image: '/Plomeria.webp',
  },
  {
    name: 'Electricidad',
    icon: '⚡',
    description: 'Instalaciones eléctricas y reparaciones',
    demand: 90,
    slug: 'electricidad',
    image: '/Electricistas.webp',
  },
  {
    name: 'Carpintería',
    icon: '🔨',
    description: 'Muebles, puertas y trabajos en madera',
    demand: 85,
    slug: 'carpinteria',
    image: '/Carpinteria.webp',
  },
  {
    name: 'Pintura',
    icon: '🎨',
    description: 'Pintura interior y exterior',
    demand: 80,
    slug: 'pintura',
    image: '/Pintura.webp',
  },
  {
    name: 'Limpieza',
    icon: '🧽',
    description: 'Limpieza residencial y comercial',
    demand: 88,
    slug: 'limpieza',
    image: '/Limpieza.webp',
  },
  {
    name: 'Jardinería',
    icon: '🌱',
    description: 'Mantenimiento y diseño de jardines',
    demand: 75,
    slug: 'jardineria',
    image: '/Jardineria.png',
  },
  {
    name: 'Albañilería',
    icon: '🧱',
    description: 'Construcción y reparaciones de albañilería',
    demand: 82,
    slug: 'albanileria',
    image: '/Albañileria.png',
  },
  {
    name: 'Cerrajería',
    icon: '🔑',
    description: 'Apertura de puertas y cambio de cerraduras',
    demand: 78,
    slug: 'cerrajeria',
    image: '/Cerrajeria.png',
  },
  {
    name: 'Gasfitería',
    icon: '💧',
    description: 'Instalación y reparación de tuberías de gas',
    demand: 70,
    slug: 'gasfiteria',
    image: '/Gasfiteria.png',
  },
  {
    name: 'Vidriería',
    icon: '🪟',
    description: 'Instalación y reparación de vidrios',
    demand: 72,
    slug: 'vidrieria',
    image: '/Vidrieria.png',
  },
  {
    name: 'Soldadura',
    icon: '🛠️',
    description: 'Trabajos de soldadura y metal',
    demand: 76,
    slug: 'soldadura',
    image: '/Soldadura.png',
  },
  {
    name: 'Mecánica',
    icon: '🚗',
    description: 'Mecánica ligera y mantenimiento',
    demand: 76,
    slug: 'mecanica',
    image: '/Mecanica.png',
  },
  {
    name: 'Refrigeración',
    icon: '❄️',
    description: 'Instalación y reparación de aire acondicionado',
    demand: 74,
    slug: 'refrigeracion',
    image: '/Refrigeracion.png',
  },
  {
    name: 'Techos y Cubiertas',
    icon: '🏠',
    description: 'Instalación y mantenimiento de techos',
    demand: 68,
    slug: 'techos',
    image: '/Techos y Cubiertas.png',
  },
  {
    name: 'Tapicería',
    icon: '🪑',
    description: 'Tapizado y restauración de muebles',
    demand: 66,
    slug: 'tapiceria',
    image: '/Tapiceria.png',
  },
  {
    name: 'Instalación CCTV',
    icon: '📷',
    description: 'Instalación y configuración de cámaras de seguridad',
    demand: 73,
    slug: 'cctv',
    image: '/Instalacion CCTV.png',
  },
  {
    name: 'Piscinas',
    icon: '🏊',
    description: 'Mantenimiento y limpieza de piscinas',
    demand: 65,
    slug: 'piscinas',
    image: '/Picsina.png',
  },
  {
    name: 'Mudanzas',
    icon: '🚚',
    description: 'Transporte y mudanza de bienes',
    demand: 77,
    slug: 'mudanzas',
    image: '/Mudanzas.png',
  },
  {
    name: 'Fumigación',
    icon: '🦟',
    description: 'Control de plagas y fumigación',
    demand: 69,
    slug: 'fumigacion',
    image: '/Fumigacion.png',
  },
  {
    name: 'Calefacción',
    icon: '🔥',
    description: 'Instalación y reparación de calefacción',
    demand: 71,
    slug: 'calefaccion',
    image: '/Calefaccion.png',
  },
  {
    name: 'Paneles Solares',
    icon: '☀️',
    description: 'Instalación de sistemas solares',
    demand: 67,
    slug: 'paneles-solares',
    image: '/Paneles Solares.png',
  },
  {
    name: 'Impermeabilización',
    icon: '💦',
    description: 'Sellado y protección contra humedad',
    demand: 64,
    slug: 'impermeabilizacion',
    image: '/Impermeablilizacion.png',
  },
  {
    name: 'Domótica',
    icon: '🏡',
    description: 'Automatización del hogar y smart devices',
    demand: 62,
    slug: 'domotica',
    image: '/Domotica.png',
  },
  {
    name: 'Lavado de alfombras',
    icon: '🧼',
    description: 'Lavado profundo y desinfección de alfombras',
    demand: 60,
    slug: 'lavado-alfombras',
    image: '/Lavado de alfombras.png',
  },
];

export default function ServicesSection({
  showHero = true,
  showAllServices = true,
  showCTA = true,
  title,
  subtitle,
}: {
  showHero?: boolean;
  showAllServices?: boolean;
  showCTA?: boolean;
  title?: string;
  subtitle?: string;
}) {
  const servicesToShow = showAllServices ? services : services.slice(0, 6);
  const router = useRouter();
  const [activeIndex, setActiveIndex] = useState(0);

  const handleCardKey = (e: React.KeyboardEvent<HTMLDivElement>, idx: number, slug: string) => {
    const cards = document.querySelectorAll('[data-service-card="true"]');
    const last = cards.length - 1;
    let target = idx;

    switch (e.key) {
      case 'ArrowRight':
      case 'ArrowDown':
        target = Math.min(idx + 1, last);
        break;
      case 'ArrowLeft':
      case 'ArrowUp':
        target = Math.max(idx - 1, 0);
        break;
      case 'Home':
        target = 0;
        break;
      case 'End':
        target = last;
        break;
      case 'Enter':
      case ' ':
        router.push(`/servicios/${slug}`);
        e.preventDefault();
        return;
      default:
        return;
    }

    setActiveIndex(target);
    (cards[target] as HTMLElement)?.focus();
    e.preventDefault();
  };

  return (
    <div className={showHero ? 'min-h-screen bg-white pt-16' : 'bg-white'}>
      {showHero && (
        <section
          id='tour-services-hero'
          className='w-full py-16 px-4 bg-gradient-to-b from-blue-600 to-blue-800 text-white'
        >
          <div className='max-w-7xl mx-auto text-center'>
            <h1 className='text-4xl md:text-6xl font-bold mb-6'>
              {title || 'Servicios disponibles'}
            </h1>
            <p className='text-lg md:text-xl mb-12 max-w-3xl mx-auto opacity-90'>
              {subtitle || 'Encuentra el profesional perfecto para cualquier trabajo en tu hogar'}
            </p>
          </div>
        </section>
      )}

      <section id='tour-services-section' className='w-full py-16 px-4'>
        <div className='max-w-7xl mx-auto'>
          {!showHero && title && (
            <div className='text-center mb-12'>
              <h2 className='text-3xl md:text-4xl font-bold text-gray-800 mb-4'>{title}</h2>
              {subtitle && <p className='text-lg text-gray-600 max-w-2xl mx-auto'>{subtitle}</p>}
            </div>
          )}

          <div className='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8' role='grid'>
            {servicesToShow.map((service, index) => (
              <div
                key={index}
                tabIndex={activeIndex === index ? 0 : -1}
                role='button'
                aria-label={`Abrir detalles del servicio ${service.name}`}
                data-service-card='true'
                onKeyDown={(e) => handleCardKey(e, index, service.slug)}
                onClick={() => router.push(`/services/${service.slug}`)}
                onFocus={() => setActiveIndex(index)}
                className='select-none bg-white p-8 rounded-xl shadow-lg border border-gray-200 transition-all duration-200 hover:bg-blue-50 hover:border-blue-300 hover:shadow-xl focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 cursor-pointer'
              >
                <div className='flex items-start justify-between mb-6'>
                  <div className='text-5xl'>{service.icon}</div>
                </div>
                <h3 className='text-2xl font-bold text-gray-800 mb-3'>{service.name}</h3>
                <p className='text-gray-600 mb-6 leading-relaxed'>{service.description}</p>

                <div className='mb-6'>
                  <div className='flex justify-between items-center mb-2'>
                    <span className='text-sm font-medium text-gray-700'>
                      {service.demand}% de demanda
                    </span>
                  </div>
                  <div className='w-full bg-gray-200 rounded-full h-2'>
                    <div
                      className='bg-blue-600 h-2 rounded-full transition-all duration-500'
                      style={{ width: `${service.demand}%` }}
                    ></div>
                  </div>
                </div>
              </div>
            ))}
          </div>

          {!showAllServices && (
            <div className='flex justify-center mt-12'>
              <Link
                href='/servicios'
                className='bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg transition-colors duration-300 shadow-md hover:shadow-lg'
              >
                Ver más
              </Link>
            </div>
          )}
        </div>
      </section>

      {showCTA && (
        <section className='w-full py-16 px-4 bg-gradient-to-r from-blue-600 to-blue-700'>
          <div className='max-w-4xl mx-auto text-center text-white'>
            <h2 className='text-3xl md:text-4xl font-bold mb-6'>¿No encuentras lo que buscas?</h2>
            <p className='text-lg md:text-xl mb-8 opacity-90'>
              Contáctanos y te ayudamos a encontrar el profesional perfecto para tu proyecto
            </p>
            <div className='flex flex-col sm:flex-row gap-4 justify-center'>
              <button className='bg-white text-blue-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors'>
                Solicitar servicio personalizado
              </button>
              <button className='border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-blue-600 transition-colors'>
                Hablar con un asesor
              </button>
            </div>
          </div>
        </section>
      )}
    </div>
  );
}
</file>

<file path="src/Components/HowUseServineo/Accordion.tsx">
'use client';
import React, { useState } from 'react';
import { ChevronDown, ChevronUp } from 'lucide-react';
import { useTranslations } from 'next-intl';

const Accordion = () => {
  const t = useTranslations('Accordion');
  const [openIndex, setOpenIndex] = useState<number | null>(null);

  const faqs = [
    {
      question: '¿Cómo funciona Servineo?',
      answer:
        'Servineo conecta hogares con profesionales calificados en Cochabamba. Publica tu necesidad, recibe cotizaciones de fixers verificados y elige al mejor para el trabajo.',
    },
    {
      question: '¿Qué tipos de servicios ofrecen?',
      answer:
        'Ofrecemos plomería, electricidad, carpintería, pintura, limpieza, jardinería, soldadura, albañilería y muchos servicios más para el hogar.',
    },
    {
      question: '¿Cómo se verifican los fixers?',
      answer:
        'Todos nuestros fixers pasan por un proceso de verificación que incluye revisión de documentos, entrevistas y evaluación de experiencia previa.',
    },
    {
      question: '¿Qué garantía ofrecen?',
      answer:
        'Ofrecemos garantía de 30 días en todos los trabajos realizados. Si no estás satisfecho, nuestro equipo de soporte te ayudará a resolver cualquier problema.',
    },
    {
      question: '¿Cómo se realizan los pagos?',
      answer:
        'Los pagos son 100% seguros a través de nuestra plataforma. Solo liberas el pago cuando el trabajo esté completado y estés satisfecho con el resultado.',
    },
  ];

  const toggleAccordion = (index: number) => {
    setOpenIndex(openIndex === index ? null : index);
  };

  return (
    <section className='max-w-4xl mx-auto px-4 py-8' aria-label='Preguntas frecuentes'>
      <h2 className='text-3xl font-bold text-gray-800 mb-8 text-center'>{t('title')}</h2>

      <div className='space-y-2'>
        {faqs.map((faq, index) => (
          <div
            key={index}
            className='border border-gray-200 rounded-lg transition-all duration-300 hover:shadow-md'
          >
            <button
              onClick={() => toggleAccordion(index)}
              className='w-full px-6 py-4 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-inset rounded-lg'
              aria-expanded={openIndex === index}
              aria-controls={`answer-${index}`}
            >
              <span className='text-lg font-medium text-gray-800 pr-4'>
                {t(`section${index + 1}.question`)}
              </span>
              <span className='flex-shrink-0 transition-transform duration-300'>
                {openIndex === index ? (
                  <ChevronUp className='h-5 w-5 text-blue-600' aria-hidden='true' />
                ) : (
                  <ChevronDown className='h-5 w-5 text-gray-500' aria-hidden='true' />
                )}
              </span>
            </button>

            <div
              id={`answer-${index}`}
              className={`px-6 pb-4 transition-all duration-300 ${
                openIndex === index ? 'block opacity-100 max-h-96' : 'hidden opacity-0 max-h-0'
              }`}
              role='region'
              aria-labelledby={`question-${index}`}
            >
              <div className='border-t border-gray-100 pt-4'>
                <p className='text-gray-600 leading-relaxed'>{t(`section${index + 1}.answer`)}</p>
              </div>
            </div>
          </div>
        ))}
      </div>
    </section>
  );
};

export default Accordion;
</file>

<file path="src/Components/HowUseServineo/CategoriasP.tsx">
'use client';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { Droplets } from 'lucide-react';
import { useTranslations } from 'next-intl';
const services = [
  {
    name: 'Plomería',
    icon: <Droplets className='w-8 h-8 text-primary' />,
    description: 'Reparaciones e instalaciones de fontanería',
    slug: 'plomeria',
    demand: 85,
  },
  {
    name: 'Electricidad',
    icon: '⚡',
    description: 'Instalaciones y reparaciones eléctricas',
    slug: 'electricidad',
    demand: 78,
  },
  {
    name: 'Carpintería',
    icon: '🔨',
    description: 'Trabajos en madera y muebles',
    slug: 'carpinteria',
    demand: 72,
  },
  {
    name: 'Limpieza',
    icon: '🧹',
    description: 'Servicios de limpieza profesional',
    slug: 'limpieza',
    demand: 90,
  },
  {
    name: 'Jardinería',
    icon: '🌿',
    description: 'Cuidado y mantenimiento de jardines',
    slug: 'jardineria',
    demand: 68,
  },
  {
    name: 'Pintura',
    icon: '🎨',
    description: 'Servicios de pintura residencial',
    slug: 'pintura',
    demand: 75,
  },
  {
    name: 'Mudanzas',
    icon: '📦',
    description: 'Servicios de mudanza y transporte',
    slug: 'mudanzas',
    demand: 65,
  },
  {
    name: 'Tecnología',
    icon: '💻',
    description: 'Reparación de equipos tecnológicos',
    slug: 'tecnologia',
    demand: 82,
  },
];

export const CategoriasP = () => {
  const t = useTranslations('CategoriasPopulares');
  const router = useRouter();

  // Tomar las 8 categorías más populares (ordenadas por demanda)
  const categoriasPopulares = services.sort((a, b) => b.demand - a.demand).slice(0, 8);

  return (
    <div className='flex flex-col items-center gap-[40px] ml-[30px] mr-[30px] my-8 p-8 bg-white rounded-2xl shadow-2xl'>
      <div className='flex flex-col items-center gap-[25px]'>
        <h1 className='text-center text-[35px] font-bold text-gray-800'> {t('title')} </h1>
        <h2 className='text-center text-gray-600 text-lg'> {t('subtitle')} </h2>
        <h3 className='text-center text-gray-500'> {t('subtitle2')} </h3>
      </div>

      {/* Grid de categorías */}
      <div className='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 w-full max-w-6xl'>
        {categoriasPopulares.map((service, index) => (
          <div
            key={index}
            onClick={() => router.push(`/servicios/${service.slug}`)}
            className='bg-white p-6 rounded-xl shadow-lg border border-gray-200 transition-all duration-200 hover:bg-blue-50 hover:border-blue-300 hover:shadow-xl cursor-pointer group'
          >
            <div className='flex items-start justify-between mb-4'>
              <div className='text-4xl group-hover:scale-110 transition-transform duration-200'>
                {service.icon}
              </div>
            </div>

            <h3 className='text-xl font-bold text-gray-800 mb-2 group-hover:text-blue-600 transition-colors'>
              {t(`card${index + 1}.name`)}
            </h3>
            <p className='text-gray-600 mb-4 text-sm leading-relaxed'>
              {t(`card${index + 1}.description`)}
            </p>

            <div className='mb-4'>
              <div className='flex justify-between items-center mb-1'>
                <span className='text-xs font-medium text-gray-700'>
                  {service.demand}% {t('demand')}
                </span>
              </div>
              <div className='w-full bg-gray-200 rounded-full h-2'>
                <div
                  className='bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full transition-all duration-500'
                  style={{ width: `${service.demand}%` }}
                ></div>
              </div>
            </div>

            <button className='w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 px-4 rounded-lg transition-colors transform group-hover:scale-105 duration-200'>
              {t('button')}
            </button>
          </div>
        ))}
      </div>

      {/* Botón para ver todas las categorías */}
      <Link
        href='/servicios'
        className='mt-4 px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium shadow-lg hover:shadow-xl'
      >
        {t('button2')}
      </Link>
    </div>
  );
};
</file>

<file path="src/Components/HowUseServineo/Consejos.tsx">
import React from 'react';
import { ConsejosCard } from './ConsejosCard';
import { useTranslations } from 'next-intl';

const subtitle = 'Perfecciona tu uso sobre la plataforma,\naqui tenemos algunos consejos';

const consejos = [
  {
    title: 'Filtros',
    imageUrl: '/es/img/imgHowUseServineo/consejosFiltros.png',
    descripcion:
      'Aplica los filtros de búsqueda, palabras claves o consulta nuestro mapa si hay fixers cercanos a tu ubicación.',
  },
  {
    title: 'Calificaciones y reseñas',
    imageUrl: '/es/img/imgHowUseServineo/reseñas.png',
    descripcion:
      'Consulta las calificaciones y opiniones de otras personas para saber mas sobre el desempeño de cierto fixer.',
  },
  {
    title: 'Comunicación',
    imageUrl: '/es/img/imgHowUseServineo/comunicacion.png',
    descripcion:
      'Comunícate con el fixer para tener más detalles del servicio y aclarar las dudas que tengas.',
  },
];

export const Consejos = () => {
  const t = useTranslations('Consejos');
  return (
    <div className='flex flex-col items-center gap-[40px] ml-[30px] mr-[30px] my-8 p-8 bg-white rounded-2xl shadow-2xl'>
      <div className='flex flex-col items-center gap-[25px]'>
        <h1 className='text-center text-[35px]'> {t('title')} </h1>
        <h1 className='text-center opacity-[60%] whitespace-pre-line'> {t('subtitle')} </h1>
      </div>

      <div className='grid gap-4 grid-cols-1 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3'>
        {consejos.map((item, index) => (
          <ConsejosCard
            key={index}
            title={t(`tip${index + 1}.title`)}
            imageUrl={item.imageUrl}
            descripcion={t(`tip${index + 1}.description`)}
          />
        ))}
      </div>
    </div>
  );
};
</file>

<file path="src/Components/HowUseServineo/ConsejosCard.tsx">
import React from 'react';

interface ConsejosCardProps {
  title: string;
  imageUrl: string;
  descripcion: string;
}

export const ConsejosCard = ({ title, imageUrl, descripcion }: ConsejosCardProps) => {
  return (
    <div className='flex flex-col items-center text-center gap-[15px]'>
      <div className='flex flex-col items-center gap-[15px]'>
        <strong className='text-xl font-bold text-gray-800'> {title} </strong>

        {/* SOLUCIÓN APLICADA: <img> nativo en lugar de <Image /> */}
        <img
          className='rounded-lg w-60 h-45 object-cover'
          src={imageUrl}
          alt={`Imagen ilustrativa de ${title}`}
          loading='lazy'
          decoding='async'
        />

        <p className='opacity-[80%] text-gray-600 leading-relaxed'> {descripcion} </p>
      </div>
    </div>
  );
};
</file>

<file path="src/Components/HowUseServineo/PasoCards.tsx">
import React from 'react';

interface Props {
  number: number;
  title: string;
  imageUrl: string;
  descripcion: string;
}

export const PasoCards = ({ number, title, imageUrl, descripcion }: Props) => {
  return (
    <div className='flex flex-col items-center text-center gap-[15px]'>
      <div className='flex flex-row gap-[8px] items-center'>
        <strong className='text-2xl text-blue-600 font-bold'> {number}. </strong>
        <strong className='text-xl font-bold text-gray-800'> {title} </strong>
      </div>

      {/* SOLUCIÓN APLICADA: <img> nativo en lugar de <Image /> */}
      <img
        className='rounded-lg w-48 h-45 object-cover shadow-md'
        src={imageUrl}
        alt={`Paso ${number}: ${title}`}
        loading='lazy'
        decoding='async'
      />

      <p className='opacity-[80%] text-gray-600 leading-relaxed px-2'> {descripcion} </p>
    </div>
  );
};
</file>

<file path="src/Components/HowUseServineo/Pasos.tsx">
'use client';

import React from 'react';
import { useRouter } from 'next/navigation';
import { PasoCards } from './PasoCards';
import { useTranslations } from 'next-intl';

const subtitle =
  'Encuentra el fixer que tenga las habilidades que necesitas,\npuedes empezar con estos pasos';

const pasos = [
  {
    number: 1,
    title: 'Navega y busca',
    imageUrl: '/es/img/imgHowUseServineo/navegarYBuscar.jpg',
    descripcion:
      'Explora nuestros servicios utilizando la barra de búsqueda, filtros por categorías y palabras claves para encontrar lo que buscas.',
  },
  {
    number: 2,
    title: 'Contacta',
    imageUrl: '/es/img/imgHowUseServineo/contacta.jpg',
    descripcion:
      'Comunícate con el fixer directamente mediante su número telefónico para poder saber más sobre el servicio o coordinar el trabajo.',
  },
  {
    number: 3,
    title: 'Coordina tu servicio',
    imageUrl: '/es/img/imgHowUseServineo/coordinar.jpg',
    descripcion:
      'Coordina con tu fixer para que el servicio sea lo que tu busca y elige una oferta antes de enviar los datos necesitados por el fixer.',
  },
  {
    number: 4,
    title: 'Aprueba y contacta',
    imageUrl: '/es/img/imgHowUseServineo/contrata.jpg',
    descripcion: 'Recibe el servicio y deja tus comentarios sobre la calidad del servicio.',
  },
];

export const Pasos = () => {
  const t = useTranslations('Pasos');

  const router = useRouter();

  const handleVerServicios = () => {
    router.push('/servicios');
  };

  return (
    <div className='flex flex-col items-center gap-[40px] ml-[30px] mr-[30px] my-8 p-8 bg-white rounded-2xl shadow-2xl'>
      <div className='flex flex-col items-center gap-[25px]'>
        <h1 className='text-center text-[35px]'> {t('title')} </h1>
        <p className='text-center text-black opacity-[60%] text-[18px] whitespace-pre-line'>
          {' '}
          {t('subtitle')}{' '}
        </p>
      </div>

      <div className='grid gap-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4'>
        {pasos.map((item, index) => (
          <PasoCards
            key={index}
            number={item.number}
            imageUrl={item.imageUrl}
            title={t(`step${item.number}.title`)}
            descripcion={t(`step${item.number}.description`)}
          />
        ))}
      </div>

      <div>
        <button
          className='cursor-pointer gap-[3px] bg-[#2B6EA0] hover:bg-[#2B31E0] duration-150 text-white h-9 w-40 rounded-[8px]'
          onClick={handleVerServicios}
        >
          {t('button')}
        </button>
      </div>
    </div>
  );
};
</file>

<file path="src/Components/inspiration-section.tsx">
'use client';

import Image from 'next/image';
import { ChevronLeft, ChevronRight } from 'lucide-react';
import { useState } from 'react';

const inspirationProjects = [
  {
    id: 1,
    title: 'Soluciones expertas para tus tuberías',
    description: 'Reparación e instalación de plomería',
    category: 'PLOMERÍA',
    image: '/plomeria-profesional.jpg',
  },
  {
    id: 2,
    title: 'Transformación de espacios',
    description: 'Pintura interior y exterior de calidad',
    category: 'PINTURA',
    image: '/pintura-interior-moderna.jpg',
  },
  {
    id: 3,
    title: 'Muebles y carpintería a medida',
    description: 'Diseños personalizados para tu hogar',
    category: 'CARPINTERÍA',
    image: '/muebles-carpinteria.jpg',
  },
];

export function InspirationSection() {
  const [currentSlide, setCurrentSlide] = useState(0);

  const nextSlide = () => {
    setCurrentSlide((prev) => (prev + 1) % inspirationProjects.length);
  };

  const prevSlide = () => {
    setCurrentSlide((prev) => (prev - 1 + inspirationProjects.length) % inspirationProjects.length);
  };

  const project = inspirationProjects[currentSlide];

  return (
    <section className='py-16 px-4 bg-background'>
      <div className='max-w-5xl mx-auto'>
        {/* Header */}
        <div className='text-center mb-12'>
          <h2 className='text-3xl md:text-4xl font-bold text-foreground mb-4'>
            Inspiración para tu hogar
          </h2>
          <p className='text-lg text-muted-foreground max-w-2xl mx-auto'>
            Descubre ideas y proyectos realizados por nuestros profesionales expertos
          </p>
        </div>

        {/* Carousel */}
        <div className='relative overflow-hidden rounded-2xl shadow-lg'>
          {/* Image */}
          <div className='relative h-96 w-full'>
            <Image
              src={project.image || '/placeholder.svg'}
              alt={project.title}
              fill
              className='object-cover'
            />
            {/* Dark overlay */}
            <div className='absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent' />
          </div>

          {/* Content overlay */}
          <div className='absolute inset-0 flex flex-col justify-between p-6 md:p-8'>
            <div>
              <span className='inline-block bg-primary/90 text-white px-3 py-1 rounded-md text-sm font-medium'>
                {project.category}
              </span>
            </div>
            <div>
              <h3 className='text-2xl md:text-4xl font-bold text-white mb-2 text-balance'>
                {project.title}
              </h3>
              <p className='text-white/90 text-lg'>{project.description}</p>
            </div>
          </div>

          {/* Navigation buttons */}
          <button
            onClick={prevSlide}
            className='absolute left-4 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/40 text-white p-2 rounded-full transition-colors z-10'
            aria-label='Anterior'
          >
            <ChevronLeft className='w-6 h-6' />
          </button>
          <button
            onClick={nextSlide}
            className='absolute right-4 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/40 text-white p-2 rounded-full transition-colors z-10'
            aria-label='Siguiente'
          >
            <ChevronRight className='w-6 h-6' />
          </button>

          <div className='absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2'>
            {inspirationProjects.map((_, index) => (
              <button
                key={index}
                onClick={() => setCurrentSlide(index)}
                className={`h-2 rounded-full transition-all ${
                  index === currentSlide ? 'bg-primary w-8' : 'bg-white/50 w-2'
                }`}
                aria-label={`Ir a proyecto ${index + 1}`}
              />
            ))}
          </div>
        </div>
      </div>
    </section>
  );
}
</file>

<file path="src/Components/interface/Fixer_Interface.ts">
export interface Fixer {
  id: number;
  nombre: string;
  servicio: string;
  lat: number;
  lng: number;
  available: boolean; // true = disponible, false = ocupado
}
</file>

<file path="src/Components/Job-offers/Filter/FilterButton.tsx">
import { Button } from '@/Components/ui/button';
import { SlidersHorizontal } from 'lucide-react';
import React from 'react';

export function FilterButton(props: React.ButtonHTMLAttributes<HTMLButtonElement>) {
  return (
    <Button
      size='lg'
      className='
        bg-[#2B6AE0] text-white hover:bg-[#2B6AE0]/90 
        shrink-0
        w-10
        px-2
        rounded-[8px] sm:rounded-[10px] 
        flex items-center justify-center 
        font-roboto 
        shadow-lg sm:shadow-xl 
        ring-1 sm:ring-2 
        cursor-pointer 
        border
        transition-all duration-200
      '
      {...props}
    >
      <SlidersHorizontal size={18} color='white' strokeWidth={2.8} />
    </Button>
  );
}
</file>

<file path="src/Components/Job-offers/Filter/FilterDrawer.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { Star } from 'lucide-react';
import { roboto } from '@/app/fonts';
import { validateFilters } from '@/app/lib/validations/filter.validator';
import { useTranslations } from 'next-intl';
import { useAppSelector, useAppDispatch } from '@/app/redux/hooks';
import { DB_VALUES } from '@/app/redux/contants';
import type { FilterState } from '@/app/redux/features/jobOffers/types';
import { setRating } from '@/app/redux/slice/jobOfert';
import { useGetFilterCountsQuery } from '@/app/redux/services/jobOffersApi';

interface FilterDrawerProps {
  isOpen: boolean;
  onClose: () => void;
  onFiltersApply?: (filters: FilterState) => void;
  onRatingChange?: (rating: number | null) => void;
  onReset?: () => void;
}

export function FilterDrawer({ isOpen, onClose, onFiltersApply, onReset }: FilterDrawerProps) {
  const filtersFromStore = useAppSelector((state) => state.jobOfert.filters);

  const [openSections, setOpenSections] = useState<{ [key: string]: boolean }>({
    fixer: false,
    ciudad: false,
    trabajo: false,
    rating: false,
  });

  const t = useTranslations('filtersPanel');
  const tName = useTranslations('advancedSearch.fixerName');
  const tCity = useTranslations('advancedSearch.city');
  const tJob = useTranslations('advancedSearch.jobType');

  const [selectedRanges, setSelectedRanges] = useState<string[]>(filtersFromStore.range || []);
  const [selectedCities, setSelectedCities] = useState<string[]>(filtersFromStore.city || []);
  const [selectedJobs, setSelectedJobs] = useState<string[]>(filtersFromStore.category || []);
  const [selectedRating, setSelectedRating] = useState<number | null>(null);

  const dispatch = useAppDispatch();
  const storeRating = useAppSelector((s) => s.jobOfert.rating);
  const storeSearch = useAppSelector((s) => s.jobOfert.search);

  // 🔧 Petición de contadores: NO enviar la categoría para obtener totales por categoría
  const { data: backendCounts, isLoading: loadingCounts } = useGetFilterCountsQuery(
    {
      range: selectedRanges.length > 0 ? selectedRanges : undefined,
      city: selectedCities.length > 0 ? selectedCities.join(',') : undefined,
      // Enviar las categorías seleccionadas como ARRAY para que el builder
      // de query agregue correctamente múltiples params `category=`.
      // (Antes se enviaba una cadena con comas y provocaba errores al iterar.)
      category: selectedJobs.length > 0 ? selectedJobs : undefined,
      search: storeSearch?.trim() ? storeSearch : undefined,
      minRating: selectedRating ?? undefined,
      maxRating: selectedRating !== null && selectedRating < 5 ? selectedRating + 0.99 : undefined,
    },
    {
      skip: !isOpen,
    },
  );

  useEffect(() => {
    setSelectedRanges(filtersFromStore.range || []);
    setSelectedCities(filtersFromStore.city || []);
    setSelectedJobs(filtersFromStore.category || []);
    setSelectedRating(storeRating ?? null);
  }, [filtersFromStore, storeRating]);

  // Cuando se abre el drawer, mantener abiertas las secciones que ya tienen filtros aplicados
  useEffect(() => {
    if (!isOpen) return;

    setOpenSections((prev) => ({
      fixer: prev.fixer || (filtersFromStore.range && filtersFromStore.range.length > 0),
      ciudad: prev.ciudad || (filtersFromStore.city && filtersFromStore.city.length > 0),
      trabajo: prev.trabajo || (filtersFromStore.category && filtersFromStore.category.length > 0),
      rating: prev.rating || storeRating != null,
    }));
  }, [isOpen, filtersFromStore, storeRating]);

  useEffect(() => {
    setSelectedRating(storeRating ?? null);
  }, [storeRating]);

  useEffect(() => {
    if (isOpen) {
      document.body.style.overflowY = 'scroll';
    } else {
      document.body.style.overflowY = 'unset';
    }
    return () => {
      document.body.style.overflowY = 'unset';
    };
  }, [isOpen]);

  const toggleSection = (section: string) => {
    setOpenSections((prev) => ({
      ...prev,
      [section]: !prev[section],
    }));
  };

  const handleRatingClick = (star: number) => {
    const newRating = selectedRating === star ? null : star;
    setSelectedRating(newRating);
    dispatch(setRating(newRating));
    applyFilters(
      selectedRanges,
      selectedCities,
      selectedJobs,
      filtersFromStore.isAutoSelectedCategory,
      filtersFromStore.isAutoSelectedCity,
    );
  };

  const handleRangeChange = (dbValue: string) => {
    const newRanges = selectedRanges.includes(dbValue)
      ? selectedRanges.filter((r) => r !== dbValue)
      : [...selectedRanges, dbValue];

    setSelectedRanges(newRanges);
    applyFilters(
      newRanges,
      selectedCities,
      selectedJobs,
      filtersFromStore.isAutoSelectedCategory,
      filtersFromStore.isAutoSelectedCity,
    );
  };

  const handleCityChange = (dbValue: string) => {
    if (process.env.NODE_ENV === 'development')
      console.debug('[FilterDrawer] handleCityChange click:', dbValue, {
        selectedCities,
        filtersFromStore,
      });
    const isAutoMarked =
      filtersFromStore.isAutoSelectedCity && filtersFromStore.city.includes(dbValue);
    if (isAutoMarked && selectedCities.includes(dbValue)) {
      return;
    }

    let newCities: string[];
    if (filtersFromStore.isAutoSelectedCity) {
      newCities = selectedCities.includes(dbValue) ? [] : [dbValue];
    } else {
      newCities = selectedCities.includes(dbValue)
        ? selectedCities.filter((c) => c !== dbValue)
        : [...selectedCities, dbValue];
    }

    setSelectedCities(newCities);
    applyFilters(
      selectedRanges,
      newCities,
      selectedJobs,
      filtersFromStore.isAutoSelectedCategory,
      false,
    );
  };

  const handleJobChange = (dbValue: string) => {
    if (process.env.NODE_ENV === 'development')
      console.debug('[FilterDrawer] handleJobChange click:', dbValue, {
        selectedJobs,
        filtersFromStore,
      });
    // Si hay auto-selección, permitir cambio libre entre categorías
    let newJobs: string[];

    if (filtersFromStore.isAutoSelectedCategory) {
      // Si clickea en otra categoría, cambiar a esa (comportamiento de radio button)
      newJobs = selectedJobs.includes(dbValue) ? [] : [dbValue];
    } else {
      // Comportamiento normal de checkbox múltiple
      newJobs = selectedJobs.includes(dbValue)
        ? selectedJobs.filter((j) => j !== dbValue)
        : [...selectedJobs, dbValue];
    }

    setSelectedJobs(newJobs);
    // Quitar el flag de auto-selección ya que el usuario hizo un cambio manual
    applyFilters(
      selectedRanges,
      selectedCities,
      newJobs,
      false,
      filtersFromStore.isAutoSelectedCity,
    );
  };

  const applyFilters = (
    ranges: string[],
    cities: string[],
    jobs: string[],
    isAutoCat: boolean = false,
    isAutoCity: boolean = false,
  ) => {
    if (process.env.NODE_ENV === 'development')
      console.debug('[FilterDrawer] applyFilters called with:', {
        ranges,
        cities,
        jobs,
        isAutoCat,
        isAutoCity,
        filtersFromStore,
      });
    const filtersToValidate = { range: ranges, city: cities, category: jobs };
    const { isValid, data } = validateFilters(filtersToValidate);

    if (!isValid || !data) return;

    const filterState: FilterState = {
      range: data.range ?? [],
      city: data.city ?? [],
      category: data.category ?? [],
      isAutoSelectedCategory: isAutoCat,
      isAutoSelectedCity: isAutoCity,
    };

    // Evitar disparar el handler si no hay cambios reales respecto al store
    const arraysEqual = (a: string[] = [], b: string[] = []) => {
      if (a.length !== b.length) return false;
      const sa = [...a].sort();
      const sb = [...b].sort();
      for (let i = 0; i < sa.length; i++) if (sa[i] !== sb[i]) return false;
      return true;
    };

    const sameAsStore =
      arraysEqual(filterState.range, filtersFromStore.range) &&
      arraysEqual(filterState.city, filtersFromStore.city) &&
      arraysEqual(filterState.category, filtersFromStore.category);

    if (!sameAsStore && onFiltersApply) {
      if (process.env.NODE_ENV === 'development')
        console.debug('[FilterDrawer] applyFilters -> dispatching onFiltersApply', filterState);
      onFiltersApply(filterState);
    } else {
      if (process.env.NODE_ENV === 'development')
        console.debug('[FilterDrawer] applyFilters -> no-op (sameAsStore)', {
          sameAsStore,
          filterState,
          store: filtersFromStore,
        });
    }
  };

  const handleReset = () => {
    setSelectedRanges([]);
    setSelectedCities([]);
    setSelectedJobs([]);
    setSelectedRating(null);
    dispatch(setRating(null));

    if (onReset) {
      onReset();
    } else if (onFiltersApply) {
      onFiltersApply({
        range: [],
        city: [],
        category: [],
        isAutoSelectedCategory: false,
        isAutoSelectedCity: false,
      } as FilterState);
    }
  };

  const getRangeCount = (dbValue: string): number => {
    if (!backendCounts?.ranges) return 0;
    return backendCounts.ranges[dbValue] || 0;
  };

  const getRatingCount = (starNumber: number): number => {
    if (!backendCounts?.ratings) return 0;
    const key = `${starNumber}-${starNumber + 1}`;
    return backendCounts.ratings[key] || 0;
  };

  const nameRanges = [
    [
      { dbValue: DB_VALUES.ranges[0], label: tName('ranges.ac') },
      { dbValue: DB_VALUES.ranges[1], label: tName('ranges.df') },
      { dbValue: DB_VALUES.ranges[2], label: tName('ranges.gi') },
      { dbValue: DB_VALUES.ranges[3], label: tName('ranges.jl') },
      { dbValue: DB_VALUES.ranges[4], label: tName('ranges.mn') },
    ],
    [
      { dbValue: DB_VALUES.ranges[5], label: tName('ranges.oq') },
      { dbValue: DB_VALUES.ranges[6], label: tName('ranges.rt') },
      { dbValue: DB_VALUES.ranges[7], label: tName('ranges.uw') },
      { dbValue: DB_VALUES.ranges[8], label: tName('ranges.xz') },
    ],
  ];

  const nameOptions = nameRanges.flat();

  const cities = DB_VALUES.cities.map((dbValue, index) => ({
    dbValue,
    label: tCity(
      `options.${['beni', 'chuquisaca', 'cochabamba', 'laPaz', 'oruro', 'pando', 'potosi', 'santaCruz', 'tarija'][index]}`,
    ),
  }));

  // SIEMPRE mostrar todas las categorías estáticas con sus traducciones
  // Obtener los contadores del backend, pero mantener la lista completa
  const jobTypes = DB_VALUES.jobTypes.map((dbValue, index) => ({
    dbValue,
    label: tJob(
      `options.${['mason', 'carpenter', 'locksmith', 'decorator', 'electrician', 'plumber', 'fumigator', 'installer', 'gardener', 'cleaner', 'mechanic', 'assembler', 'painter', 'polisher', 'welder', 'roofer', 'glazier', 'plasterer'][index]}`,
    ),
  }));
  // Mantener orden alfabético por etiqueta (no reordenar por conteos)
  const jobTypesSorted = React.useMemo(() => {
    return [...jobTypes].sort((a, b) =>
      a.label.localeCompare(b.label, 'es', { sensitivity: 'base' }),
    );
  }, [jobTypes]);
  return (
    <>
      <div
        className={`fixed inset-0 bg-black duration-300 z-40 ${
          isOpen ? 'opacity-0' : 'opacity-0 pointer-events-none'
        }`}
        onClick={onClose}
      />

      <div
        className={`${roboto.variable} font-sans fixed top-0 left-0 h-full w-full max-w-[265px] md:w-64 md:max-w-none bg-white shadow-xl z-80 transform transition-transform duration-300 ease-in-out overflow-hidden ${
          isOpen ? 'translate-x-0' : '-translate-x-full'
        }`}
      >
        <style jsx>{`
          .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
          }
          .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
          }
          .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
          }
          .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
          }
        `}</style>

        <div className='p-4 sm:p-6 h-full flex flex-col'>
          <div className='flex justify-between items-center mb-6'>
            <h2 className='text-base sm:text-lg font-bold'>{t('filters')}</h2>

            <div className='flex items-center gap-2'>
              <button
                onClick={handleReset}
                className='bg-[#2B6AE0] text-white px-3 sm:px-4 py-2 rounded-lg text-sm font-semibold hover:bg-[#2B31E0] transition-colors'
              >
                {t('resetButton.desktop')}
              </button>
            </div>
          </div>

          <div className='flex-1 overflow-y-auto custom-scrollbar'>
            {/* Filtro: Nombre de Fixer */}
            <div className='mb-6'>
              <div
                className='bg-[#2B6AE0] text-white px-4 py-2 text-sm font-semibold mb-3 cursor-pointer hover:bg-[#2B31E0] rounded-none transition-colors'
                onClick={() => toggleSection('fixer')}
              >
                <span className='truncate'>{t('fixerName')}</span>
              </div>
              {openSections.fixer && (
                <div className='bg-white border border-gray-200 p-4 rounded max-h-[130px] overflow-y-auto custom-scrollbar'>
                  <div className='flex flex-col gap-2'>
                    {nameOptions.map((range) => {
                      const count = getRangeCount(range.dbValue);
                      const disabled = false;
                      return (
                        <label
                          key={range.dbValue}
                          className={`flex items-center justify-between gap-2 text-xs min-w-0 transition-colors ${'cursor-pointer hover:text-[#2B31E0]'}`}
                        >
                          <div className={`flex items-center gap-2`}>
                            <input
                              type='checkbox'
                              className='w-4 h-4 cursor-pointer flex-shrink-0'
                              checked={selectedRanges.includes(range.dbValue)}
                              onChange={() => handleRangeChange(range.dbValue)}
                              disabled={disabled}
                            />
                            <span className='truncate'>{range.label}</span>
                          </div>
                          {loadingCounts ? (
                            <span className='inline-block h-4 w-8 bg-gray-200 rounded animate-pulse' />
                          ) : (
                            <span
                              className={`${count > 0 ? 'text-[#2B6AE0]' : 'text-gray-400'} text-xs`}
                            >
                              ({count})
                            </span>
                          )}
                        </label>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>

            {/* Filtro: Ciudad */}
            <div className='mb-6'>
              <div
                className='bg-[#2B6AE0] text-white px-4 py-2 text-sm font-semibold mb-3 cursor-pointer hover:bg-[#2B31E0] rounded-none transition-colors'
                onClick={() => toggleSection('ciudad')}
              >
                <span className='truncate'>{t('city')}</span>
              </div>
              {openSections.ciudad && (
                <div className='bg-white border border-gray-200 p-4 rounded max-h-[130px] overflow-y-auto custom-scrollbar'>
                  <div className='flex flex-col gap-2'>
                    {cities.map((city) => {
                      const isSelected = selectedCities.includes(city.dbValue);
                      const isAutoMarked =
                        filtersFromStore.isAutoSelectedCity &&
                        filtersFromStore.city.includes(city.dbValue);
                      const count = backendCounts?.cities?.[city.dbValue] ?? 0;
                      const disabled = filtersFromStore.isAutoSelectedCity && !isAutoMarked;

                      return (
                        <label
                          key={city.dbValue}
                          className={`flex items-center justify-between gap-2 text-xs min-w-0 transition-colors ${
                            disabled
                              ? 'opacity-50 cursor-not-allowed text-gray-400 pointer-events-none'
                              : 'cursor-pointer hover:text-[#2B31E0]'
                          }`}
                        >
                          <div
                            className={`flex items-center gap-2 ${disabled ? 'pointer-events-none' : ''}`}
                          >
                            <input
                              type='checkbox'
                              className='w-4 h-4 flex-shrink-0 cursor-pointer'
                              checked={isSelected}
                              onChange={() => handleCityChange(city.dbValue)}
                              disabled={disabled}
                            />
                            <span className='truncate'>{city.label}</span>
                          </div>
                          {loadingCounts ? (
                            <span className='inline-block h-4 w-8 bg-gray-200 rounded animate-pulse' />
                          ) : (
                            <span
                              className={`${count > 0 ? 'text-[#2B6AE0]' : 'text-gray-400'} text-xs`}
                            >
                              ({count})
                            </span>
                          )}
                        </label>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>

            {/* Filtro: Tipo de Trabajo */}
            <div className='mb-6'>
              <div
                className='bg-[#2B6AE0] text-white px-4 py-2 text-sm font-semibold mb-3 cursor-pointer hover:bg-[#2B31E0] rounded-none transition-colors'
                onClick={() => toggleSection('trabajo')}
              >
                <span className='truncate'>{t('jobCategory')}</span>
              </div>
              {openSections.trabajo && (
                <div className='bg-white border border-gray-200 p-4 rounded max-h-[130px] overflow-y-auto custom-scrollbar'>
                  <div className='flex flex-col gap-2'>
                    {jobTypesSorted.map((job) => {
                      const isSelected = selectedJobs.includes(job.dbValue);
                      const count = backendCounts?.categories?.[job.dbValue] ?? 0;
                      // Nunca deshabilitar, siempre permitir selección
                      const disabled = false;

                      return (
                        <label
                          key={job.dbValue}
                          className='flex items-center justify-between gap-2 text-xs min-w-0 transition-colors cursor-pointer hover:text-[#2B31E0]'
                        >
                          <div className='flex items-center gap-2'>
                            <input
                              type='checkbox'
                              className='w-4 h-4 flex-shrink-0 cursor-pointer'
                              checked={isSelected}
                              onChange={() => handleJobChange(job.dbValue)}
                              disabled={disabled}
                            />
                            <span className='truncate'>{job.label}</span>
                          </div>
                          {loadingCounts ? (
                            <span className='inline-block h-4 w-8 bg-gray-200 rounded animate-pulse' />
                          ) : (
                            <span
                              className={`${count > 0 ? 'text-[#2B6AE0]' : 'text-gray-400'} text-xs`}
                            >
                              ({count})
                            </span>
                          )}
                        </label>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>

            {/* Filtro: Calificación */}
            <div className='mb-6'>
              <div
                className='bg-[#2B6AE0] text-white px-4 py-2 text-sm font-semibold mb-3 cursor-pointer hover:bg-[#2B31E0] rounded-none transition-colors'
                onClick={() => toggleSection('rating')}
              >
                <span className='truncate'>Calificación</span>
              </div>
              {openSections.rating && (
                <div className='bg-white border border-gray-200 p-3 sm:p-4 rounded'>
                  <div className='flex items-center gap-1 justify-center'>
                    {Array.from({ length: 5 }, (_, idx) => {
                      const starNumber = idx + 1;
                      const filled = (selectedRating ?? 0) >= starNumber;
                      const count = getRatingCount(starNumber);
                      const disabled = false;

                      return (
                        <div
                          key={starNumber}
                          className='flex flex-col items-center gap-1 min-w-[32px]'
                        >
                          <button
                            type='button'
                            onClick={() => !disabled && handleRatingClick(starNumber)}
                            className={`transition-transform touch-manipulation flex-shrink-0 ${
                              disabled
                                ? 'opacity-50 cursor-not-allowed'
                                : 'hover:scale-110 active:scale-95'
                            }`}
                            aria-label={`${starNumber} estrellas`}
                            disabled={disabled}
                          >
                            <Star
                              className='w-[22px] h-[22px] sm:w-[26px] sm:h-[26px]'
                              fill={filled ? '#fbbf24' : '#ffffff'}
                              stroke='#000000'
                              strokeWidth={2}
                            />
                          </button>
                          {loadingCounts ? (
                            <span className='inline-block h-4 w-8 bg-gray-200 rounded animate-pulse' />
                          ) : (
                            <span
                              className={`${count > 0 ? 'text-[#2B6AE0]' : 'text-gray-400'} text-xs whitespace-nowrap`}
                            >
                              ({count})
                            </span>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </>
  );
}
</file>

<file path="src/Components/Job-offers/index.ts">
// src/app/job-offer/components_jo/index.ts
export { SearchBar } from '@/Components/Job-offers/Search/SearchBar';
export { NoResultsMessage } from '@/Components/Job-offers/Search/NoResultsMessage';
export { FilterButton } from '@/Components/Job-offers/Filter/FilterButton';
export { FilterDrawer } from '@/Components/Job-offers/Filter/FilterDrawer';
export { default as Paginacion } from '@/Components/Job-offers/Pagination/Paginacion';
export { default as PaginationInfo } from '@/Components/Job-offers/Pagination/PaginationInfo';
export { default as PaginationSelector } from '@/Components/Job-offers/Pagination/PaginationSelector';
export { default as SortCard } from '@/Components/Job-offers/Sort/SortCard';

export { JobOfferCard } from './JobOfferCard';
export { JobOffersView } from './JobOffersView';
export type { ViewMode } from './JobOffersView';
export { ViewModeToggle } from './ViewModeToggle';

// Re-exportar tipos compartidos para conveniencia
export type { JobOfferData, AdaptedJobOffer } from '@/types/jobOffers';
export { adaptOfferToModalFormat, prepareOfferImages } from '@/types/jobOffers';
</file>

<file path="src/Components/Job-offers/Job-offer-card.tsx">
'use client';

import { useRouter } from 'next/navigation';
import { MapPin, Star, ChevronRight, MessageCircle } from 'lucide-react';
import type { JobOffer } from '@/app/lib/mock-data';
import { ImageCarousel } from '@/Components/Shared/ImageCarousel';
import Image from 'next/image';

interface JobOfferCardProps {
  offer: JobOffer;
  showFixerInfo?: boolean;
  onClick?: () => void;
}

export function JobOfferCard({ offer, showFixerInfo = true, onClick }: JobOfferCardProps) {
  const router = useRouter();

  const handleCardClick = () => {
    if (onClick) {
      onClick();
    }
  };

  const handleViewProfile = (e: React.MouseEvent) => {
    e.stopPropagation();
    router.push(`/fixer/${offer.fixerId}`);
  };

  const images =
    offer.photos?.length > 0 ? offer.photos : ['/placeholder.svg?height=180&width=320&text=Oferta'];

  return (
    <div
      onClick={handleCardClick}
      className='group relative w-full overflow-hidden rounded-xl  border-primary border-2 bg-white shadow-sm transition-all duration-300 hover:shadow-md hover:-translate-y-0.5 cursor-pointer'
    >
      <div className='h-48 w-full relative'>
        <ImageCarousel images={images} alt={offer.title || 'Oferta de trabajo'} />

        {/* City Badge */}
        <div className='absolute left-3 top-3 inline-flex items-center gap-1 rounded-full bg-white/90 px-3 py-1 text-xs text-slate-700 shadow-sm border border-gray-200'>
          <MapPin className='w-3 h-3 text-primary' />
          <span className='font-medium text-gray-700'>{offer.city}</span>
        </div>

        {/* Price */}
        <div className='absolute right-3 top-3 rounded-lg bg-white/90 px-3 py-1.5 text-sm font-semibold text-primary shadow-sm border border-primary/20'>
          {offer.price?.toLocaleString()} Bs
        </div>

        {/* WhatsApp Button */}
        {offer.whatsapp && (
          <a
            href={`https://wa.me/${offer.whatsapp.replace(/\s/g, '')}`}
            target='_blank'
            rel='noopener noreferrer'
            onClick={(e) => e.stopPropagation()}
            className='absolute right-3 bottom-3 bg-white p-2 rounded-full shadow-md hover:bg-gray-50 transition-colors'
            aria-label='Contactar por WhatsApp'
          >
            <MessageCircle className='w-5 h-5 text-primary' />
          </a>
        )}
      </div>

      {/* Offer Information */}
      <div className='p-4 flex flex-col h-full'>
        <div className='flex-1'>
          <div className='mb-3'>
            <h3 className='text-lg font-semibold text-gray-900 mb-1'>{offer.title}</h3>
            <p className='text-sm text-gray-500 line-clamp-2'>{offer.description}</p>
          </div>

          {/* Service Type */}
          {offer.services?.[0] && (
            <div className='mb-3'>
              <span className='inline-block bg-blue-50 text-blue-700 text-xs font-medium px-2.5 py-0.5 rounded-full'>
                {offer.services[0]}
              </span>
            </div>
          )}
        </div>

        {/* Fixer Info - Ahora en la parte inferior */}
        {showFixerInfo && (
          <div className='mt-4 pt-3 border-t border-gray-100' onClick={handleViewProfile}>
            <div className='flex items-center gap-3'>
              <div className='w-8 h-8 rounded-full bg-gray-200 overflow-hidden flex-shrink-0'>
                {offer.fixerPhoto ? (
                  <Image
                    src={offer.fixerPhoto}
                    alt={offer.fixerName || 'Fixer'}
                    className='w-full h-full object-cover'
                    width={32}
                    height={32}
                  />
                ) : (
                  <div className='w-full h-full bg-primary/10 flex items-center justify-center text-primary text-sm font-medium'>
                    {offer.fixerName?.[0]?.toUpperCase() || 'U'}
                  </div>
                )}
              </div>
              <div className='flex-1 min-w-0'>
                <div className='flex items-center justify-between'>
                  <p className='text-sm font-medium text-gray-900 truncate'>
                    {offer.fixerName || 'Usuario'}
                  </p>
                  <ChevronRight className='w-4 h-4 text-gray-400' />
                </div>
                <div className='flex items-center text-xs text-gray-500 mt-0.5'>
                  <Star className='w-3.5 h-3.5 fill-amber-400 text-amber-400 mr-1' />
                  <span>{offer.rating?.toFixed(1) || 'Nuevo'}</span>
                  <span className='mx-1.5'>•</span>
                  <span>{offer.completedJobs || 0} trabajos</span>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/Components/Job-offers/Job-offer-form.tsx">
'use client';

import { useState } from 'react';
import { zodResolver } from '@hookform/resolvers/zod';
import { useForm } from 'react-hook-form';
import { X } from 'lucide-react';
import { jobOfferSchema, type JobOfferFormData } from '@/app/lib/validations/Job-offer-Schemas';
import { availableServices, type JobOffer } from '@/app/lib/mock-data';

interface JobOfferFormProps {
  onSubmit: (data: JobOfferFormData) => void;
  onCancel: () => void;
  defaultValues?: Partial<JobOffer> | Partial<JobOfferFormData>;
  submitButtonText?: string;
}

export default function JobOfferForm({
  onSubmit,
  onCancel,
  defaultValues,
  submitButtonText = 'Publicar Oferta',
}: JobOfferFormProps) {
  // Normalize services to object format
  const normalizeServices = (services?: string[] | { id: string; value: string }[]) => {
    if (!services) return [];
    if (typeof services[0] === 'string') {
      return (services as string[]).map((s) => ({ id: s, value: s }));
    }
    return services as { id: string; value: string }[];
  };

  const [selectedServices, setSelectedServices] = useState<Array<{ id: string; value: string }>>(
    normalizeServices(defaultValues?.services),
  );

  const {
    register,
    handleSubmit,
    formState: { errors },
    setValue,
  } = useForm<JobOfferFormData>({
    resolver: zodResolver(jobOfferSchema),
    defaultValues: {
      description: defaultValues?.description || '',
      city: defaultValues?.city || 'Cochabamba',
      price: defaultValues?.price || 0,
      photos: defaultValues?.photos || [],
      services: normalizeServices(defaultValues?.services),
    },
  });

  const toggleService = (service: string) => {
    const serviceObj = { id: service, value: service };
    const isSelected = selectedServices.some((s) => s.value === service);

    if (isSelected) {
      const newServices = selectedServices.filter((s) => s.value !== service);
      setSelectedServices(newServices);
      setValue('services', newServices);
    } else {
      const newServices = [...selectedServices, serviceObj];
      setSelectedServices(newServices);
      setValue('services', newServices);
    }
  };

  const handleFormSubmit = (data: JobOfferFormData) => {
    onSubmit({ ...data, services: selectedServices });
  };

  return (
    <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div className="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between z-10">
        <h2 className="text-2xl font-bold text-blue-600">
          {defaultValues ? 'Editar Oferta' : 'Nueva Oferta de Trabajo'}
        </h2>
        <button
          onClick={onCancel}
          className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
          aria-label="Cerrar"
        >
          <X className="w-5 h-5" />
        </button>
      </div>

      <form onSubmit={handleSubmit(handleFormSubmit)} className="p-6 space-y-6">
        <div className="space-y-2">
          <label htmlFor="description" className="block text-sm font-medium text-gray-700">
            Descripción del servicio
            <span className="text-xs text-gray-500 ml-2">(máx. 100 caracteres)</span>
          </label>
          <textarea
            id="description"
            {...register('description')}
            placeholder="Describe tu servicio..."
            maxLength={100}
            className="w-full min-h-[100px] px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
          />
          {errors.description && (
            <p className="text-sm text-red-600">{errors.description.message}</p>
          )}
        </div>

        <div className="space-y-2">
          <label htmlFor="city" className="block text-sm font-medium text-gray-700">
            Ciudad
          </label>
          <select
            id="city"
            {...register('city')}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="Cochabamba">Cochabamba</option>
            <option value="La Paz">La Paz</option>
            <option value="Santa Cruz">Santa Cruz</option>
            <option value="El Alto">El Alto</option>
          </select>
          {errors.city && <p className="text-sm text-red-600">{errors.city.message}</p>}
        </div>

        <div className="space-y-2">
          <label className="block text-sm font-medium text-gray-700">Servicios</label>
          <div className="grid grid-cols-2 gap-2">
            {availableServices.map((service) => (
              <button
                key={service}
                type="button"
                onClick={() => toggleService(service)}
                className={`px-4 py-2 rounded-lg border-2 transition-all font-medium ${
                  selectedServices.some((s) => s.value === service)
                    ? 'border-blue-600 bg-blue-600 text-white'
                    : 'border-gray-200 hover:border-blue-600 text-gray-700'
                }`}
              >
                {service}
              </button>
            ))}
          </div>
          {errors.services && <p className="text-sm text-red-600">{errors.services.message}</p>}
        </div>

        <div className="space-y-2">
          <label htmlFor="price" className="block text-sm font-medium text-gray-700">
            Precio (Bs)
            <span className="text-xs text-gray-500 ml-2">(máx. 10 dígitos)</span>
          </label>
          <input
            id="price"
            type="number"
            {...register('price', { valueAsNumber: true })}
            placeholder="0"
            max={9999999999}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          {errors.price && <p className="text-sm text-red-600">{errors.price.message}</p>}
        </div>

        <div className="flex gap-3 pt-4">
          <button
            type="button"
            onClick={onCancel}
            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition-colors"
          >
            Cancelar
          </button>
          <button
            type="submit"
            className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors"
          >
            {submitButtonText}
          </button>
        </div>
      </form>
    </div>
  );
}
</file>

<file path="src/Components/Job-offers/Job-offer-modal.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { X, MessageCircle, MapPin, Sparkles, Calendar, Tag, Share2, Gift } from 'lucide-react';
import Image from 'next/image';
import Link from 'next/link';
import { useTranslations } from 'next-intl';
import type { JobOfferData, AdaptedJobOffer } from '@/types/jobOffers';
import JobRequestModal from '../../app/[locale]/job-request/ModalFormMap/JobRequestModal';
import { useSelector } from 'react-redux';
import { IUser } from '@/types/user';
import { useRouter } from 'next/navigation';
import { getPromotionsByOfferId } from '@/services/promotions';
import type { Promotion } from '@/types/promotion';

interface Props {
  offer: JobOfferData | AdaptedJobOffer | null;
  isOpen: boolean;
  onClose: () => void;
}

interface UserState {
  user: IUser | null;
  isAuthenticated: boolean;
  loading: boolean;
}
interface RootState {
  user: UserState;
}

export function JobOfferModal({ offer, isOpen, onClose }: Props) {
  const [isMapModalOpen, setIsMapModalOpen] = useState(false);
  const { user, isAuthenticated } = useSelector((state: RootState) => state.user);
  const router = useRouter();

  //const t = useTranslations('cardJob');
  const tCat = useTranslations('Categories');
  const t = useTranslations('jobOfferModal');
  const [promotions, setPromotions] = useState<Promotion[]>([]);
  const [loadingPromos, setLoadingPromos] = useState(false);

  // Cargar promociones cuando se abre el modal
  useEffect(() => {
    if (!isOpen || !offer) return;

    const loadPromotions = async () => {
      try {
        setLoadingPromos(true);
        const offerId = (offer as JobOfferData)._id || (offer as AdaptedJobOffer)._id;
        const promos = await getPromotionsByOfferId(offerId);
        setPromotions(Array.isArray(promos) ? promos : []);
      } catch (error) {
        console.warn('Error loading promotions:', error);
        setPromotions([]);
      } finally {
        setLoadingPromos(false);
      }
    };

    loadPromotions();
  }, [isOpen, offer]);

  if (!isOpen || !offer) return null;

  // Type guard: AdaptedJobOffer (comes from backend shape that already has services)
  const isAdapted = (o: JobOfferData | AdaptedJobOffer): o is AdaptedJobOffer => {
    return 'services' in o && Array.isArray(o.services);
  };

  // Normalize common fields
  const title = offer.title ?? '';
  const description = offer.description ?? '';
  const price = isAdapted(offer) ? offer.price : ((offer as JobOfferData).price ?? 0);
  const city = offer.city ?? '';
  const createdAt = isAdapted(offer)
    ? offer.createdAt
    : ((offer as JobOfferData).createdAt ?? new Date());
  const category = isAdapted(offer)
    ? (offer.services?.[0] ?? 'General')
    : ((offer as JobOfferData).category ?? 'General');

  // phone/whatsapp normalization
  const phone = isAdapted(offer)
    ? (offer.phone ?? '')
    : ((offer as JobOfferData).contactPhone ?? '');
  const whatsappRaw = phone ?? '';
  const whatsappClean = (whatsappRaw || '').toString().replace(/\D/g, '');

  // Images collection
  const images: string[] = (() => {
    if (isAdapted(offer)) {
      return offer.photos ?? [];
    } else {
      const o = offer as JobOfferData;
      if (o.allImages && o.allImages.length > 0) return o.allImages;
      if (o.photos && o.photos.length > 0) return o.photos;
      if (o.imagenUrl) return [o.imagenUrl];
      return [];
    }
  })();

  // Services list (fallback to tags)
  const servicesList: string[] = isAdapted(offer)
    ? (offer.services ?? offer.tags ?? [])
    : ((offer as JobOfferData).tags ?? []);

  // Calendar click: set sessionStorage for scheduling flow
  const handleClickCalendar = () => {
    if (typeof window === 'undefined') return;
    const fixerId = isAdapted(offer) ? offer.fixerId : (offer as JobOfferData).fixerId;
    const requesterId = sessionStorage.getItem('requester_id') ?? '';
    sessionStorage.setItem('fixer_id', fixerId);
    sessionStorage.setItem('requester_id', requesterId);
    sessionStorage.setItem('roluser', 'requester');
  };

  const handleWhatsAppClick = () => {
    if (!whatsappClean) return;
    const url = `https://wa.me/${whatsappClean}`;
    window.open(url, '_blank');
  };

  const handleShare = () => {
    const url = typeof window !== 'undefined' ? window.location.href : '';
    navigator.clipboard?.writeText(url);
  };

  const handleRequestJobClick = () => {
    if (!isAuthenticated) {
      router.push('/signUp');
      return;
    }
    if (user?.role === 'fixer') {
      return;
    }
    setIsMapModalOpen(true);
  };

  return (
    <div className='fixed inset-0 z-50 flex items-center justify-center p-4'>
      <div
        className='absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity'
        onClick={onClose}
      />

      <div className='relative bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-in fade-in zoom-in-95 duration-200'>
        {/* Header Image Area */}
        <div className='relative h-48 sm:h-64 bg-gray-100 shrink-0'>
          {images.length > 0 ? (
            <Image src={images[0]} alt={title} fill className='object-cover' />
          ) : (
            <div className='w-full h-full flex items-center justify-center text-gray-400'>
              <span className='text-lg font-medium'>{t('noImage')}</span>
            </div>
          )}

          <div className='absolute inset-0 bg-gradient-to-t from-black/60 to-transparent' />

          <button
            onClick={onClose}
            className='absolute top-4 right-4 p-2 bg-black/20 hover:bg-black/40 text-white rounded-full backdrop-blur-md transition-all'
            aria-label={t('closeModal')}
          >
            <X className='w-5 h-5' />
          </button>

          <div className='absolute bottom-4 left-6 right-6 text-white'>
            <div className='flex items-center gap-2 mb-2'>
              <span className='px-2.5 py-1 bg-primary/90 rounded-full text-xs font-semibold backdrop-blur-sm'>
                {tCat(category)}
              </span>
              <div className='flex items-center gap-1 text-xs font-medium bg-black/30 px-2 py-1 rounded-full backdrop-blur-sm'>
                <MapPin className='w-3 h-3' />
                <span>{city}</span>
              </div>
            </div>

            <h2 className='text-2xl sm:text-3xl font-bold leading-tight drop-shadow-md'>{title}</h2>
          </div>
        </div>

        {/* Content */}
        <div className='flex-1 overflow-y-auto p-6 space-y-6'>
          {/* Price & Date */}
          <div className='flex items-center justify-between pb-4 border-b border-gray-100'>
            <div className='flex items-center gap-2 text-gray-500 text-sm'>
              <Calendar className='w-4 h-4' />
              <span>{new Date(createdAt).toLocaleDateString()}</span>
            </div>
            <div className='text-xl font-bold text-primary'>{price?.toLocaleString()} Bs</div>
          </div>

          {/* Description */}
          <div className='space-y-3'>
            <div className='flex items-center gap-2 text-gray-900 font-semibold'>
              <Sparkles className='w-4 h-4 text-amber-500' />
              <h3>{t('description')}</h3>
            </div>
            <p className='text-gray-600 leading-relaxed text-sm sm:text-base'>{description}</p>
          </div>

          {/* Services / Tags */}
          {servicesList && servicesList.length > 0 && (
            <div className='space-y-3'>
              <div className='flex items-center gap-2 text-gray-900 font-semibold'>
                <Tag className='w-4 h-4 text-blue-500' />
                <h3>{t('servicesOffered')}</h3>
              </div>
              <div className='flex flex-wrap gap-2'>
                {servicesList.map((s, i) => (
                  <span
                    key={i}
                    className='px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-lg font-medium'
                  >
                    {s}
                  </span>
                ))}
              </div>
            </div>
          )}

          {/* Gallery grid (if more images) */}
          {images.length > 1 && (
            <div className='space-y-3'>
              <h3 className='font-semibold text-gray-900'>{t('gallery')}</h3>
              <div className='grid grid-cols-2 gap-2'>
                {images.slice(1).map((img, idx) => (
                  <div
                    key={idx}
                    className='relative aspect-video rounded-lg overflow-hidden bg-gray-100'
                  >
                    <Image
                      src={img}
                      alt={`${t('gallery')} ${idx}`}
                      fill
                      className='object-cover hover:scale-105 transition-transform duration-500'
                    />
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Promotions Section */}
          {promotions.length > 0 && (
            <div className='space-y-3 p-4 bg-gradient-to-r from-yellow-50 to-amber-50 rounded-xl border border-yellow-200'>
              <div className='flex items-center gap-2 text-gray-900 font-semibold'>
                <Gift className='w-4 h-4 text-yellow-500' />
                <h3>Promociones Disponibles</h3>
                <span className='ml-auto text-xs bg-yellow-500 text-white px-2 py-1 rounded-full font-bold'>
                  {promotions.length}
                </span>
              </div>
              <div className='space-y-2'>
                {promotions.map((promo) => (
                  <div key={promo._id} className='bg-white p-3 rounded-lg border border-yellow-200'>
                    <h4 className='font-semibold text-gray-900 text-sm'>{promo.title}</h4>
                    <p className='text-gray-600 text-xs mt-1'>{promo.description}</p>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Contact & Meta */}
          <div className='pt-4 border-t border-border/50'>
            <h3 className='font-bold text-lg mb-4'>{t('contactInfo')}</h3>
            <div className='grid md:grid-cols-2 gap-3'>
              <div className='flex items-center gap-3 p-4 bg-muted/50 rounded-xl'>
                <div className='w-10 h-10 bg-gradient-to-br from-primary to-blue-600 rounded-lg flex items-center justify-center shadow-lg'>
                  <MessageCircle className='w-5 h-5 text-white' />
                </div>
                <div>
                  <p className='text-xs text-muted-foreground'>WhatsApp</p>
                  <p className='font-semibold'>{whatsappClean || phone || '—'}</p>
                </div>
              </div>

              <div className='flex items-center gap-3 p-4 bg-muted/50 rounded-xl'>
                <div className='w-10 h-10 bg-gradient-to-br from-primary to-blue-600 rounded-lg flex items-center justify-center shadow-lg'>
                  <MapPin className='w-5 h-5 text-white' />
                </div>
                <div>
                  <p className='text-xs text-muted-foreground'>{t('city')}</p>
                  <p className='font-semibold'>{city || '—'}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Footer actions */}
        <div className='p-4 border-t bg-gray-50 flex flex-col sm:flex-row gap-3'>
          <button
            onClick={handleWhatsAppClick}
            disabled={!whatsappClean}
            className={`flex-1 ${
              whatsappClean
                ? 'bg-primary hover:bg-primary/90 text-white'
                : 'bg-gray-200 text-gray-500 cursor-not-allowed'
            } py-3 rounded-xl font-semibold shadow-sm flex items-center justify-center gap-2 transition-all`}
          >
            <MessageCircle className='w-5 h-5' />
            {t('contactWhatsApp')}
          </button>

          <Link
            href='/calendar'
            onClick={handleClickCalendar}
            className='flex-1 bg-white border border-gray-200 text-gray-800 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 hover:shadow-sm transition-all'
          >
            <Calendar className='w-5 h-5' />
            {t('scheduleAppointment')}
          </Link>

          <button
            onClick={handleShare}
            className='p-3 rounded-lg bg-white border border-gray-200 hover:shadow-sm'
            title={t('share')}
          >
            <Share2 className='w-5 h-5' />
          </button>

          {user?.role !== 'fixer' && (
            <>
              <button
                onClick={handleRequestJobClick}
                className='flex-1 bg-primary hover:bg-primary/90 text-white py-3 rounded-xl font-semibold shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2'
              >
                Solicitar trabajo
              </button>

              {isAuthenticated && (
                <JobRequestModal
                  isOpen={isMapModalOpen}
                  onClose={() => setIsMapModalOpen(false)}
                  onSubmit={(data) => console.log('Solicitud enviada:', data)}
                  fixerId={offer.fixerId}
                  offerId={offer._id}
                />
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/Job-offers/JobOfferCard.tsx">
// src/Components/Job-offers/JobOfferCard.tsx
'use client';

import React, { memo, useCallback, useState, useEffect } from 'react';
import Image from 'next/image';
import { useRouter } from 'next/navigation';
import {
  MapPin,
  Star,
  MessageCircle,
  ChevronLeft,
  ChevronRight,
  Edit2,
  Trash2,
} from 'lucide-react';
import { useTranslations } from 'next-intl';
import { useImageCarousel } from '@/app/redux/features/jobOffers/useImageCarousel';
import type { JobOfferData } from '@/types/jobOffers';
import { SearchHighlight } from '../SearchHighlight';
import { getPromotionsByOfferId } from '@/services/promotions';

interface JobOfferCardProps {
  offer: JobOfferData;
  viewMode?: 'grid' | 'list' | string;
  onClick?: (offer: JobOfferData) => void;
  onEdit?: (offer: JobOfferData) => void;
  onDelete?: (id: string) => void;
  className?: string;
  searchQuery?: string;
  readOnly?: boolean;
}

export const JobOfferCard = memo<JobOfferCardProps>(
  ({
    offer,
    viewMode = 'grid',
    onClick,
    onEdit,
    onDelete,
    className = '',
    searchQuery = '',
    readOnly = false,
  }) => {
    const router = useRouter();
    const t = useTranslations('cardJob');
    const tCat = useTranslations('Categories');
    const [hasPromotions, setHasPromotions] = useState(false);
    const [loadingPromos, setLoadingPromos] = useState(true);

    // Verificar si la oferta tiene promociones
    useEffect(() => {
      const checkPromotions = async () => {
        try {
          const promotions = await getPromotionsByOfferId(offer._id);
          setHasPromotions(Array.isArray(promotions) && promotions.length > 0);
        } catch (error) {
          console.warn(`Error checking promotions for offer ${offer._id}:`, error);
          setHasPromotions(false);
        } finally {
          setLoadingPromos(false);
        }
      };

      checkPromotions();
    }, [offer._id]);

    // Preparar imágenes
    const images = React.useMemo(() => {
      const imageArray = [];

      if (offer.allImages && offer.allImages.length > 0) {
        imageArray.push(...offer.allImages);
      } else if (offer.photos && offer.photos.length > 0) {
        imageArray.push(...offer.photos);
      } else if (offer.imagenUrl) {
        imageArray.push(offer.imagenUrl);
      }

      // Filtrar y validar imágenes
      return imageArray.filter((img) => {
        if (!img || typeof img !== 'string') return false;

        const trimmed = img.trim();
        if (trimmed.length === 0) return false;

        // Validar que sea una URL válida
        try {
          new URL(trimmed);
          return true;
        } catch {
          // Si no es URL válida pero es una ruta relativa, permitir
          return trimmed.startsWith('/') || trimmed.startsWith('./');
        }
      });
    }, [offer.allImages, offer.photos, offer.imagenUrl]);

    const {
      currentIndex,
      isHovered,
      isTouching,
      elementRef,
      handleMouseEnter,
      handleMouseLeave,
      handlePrevImage,
      handleNextImage,
      handleTouchStart,
      handleTouchMove,
      handleTouchEnd,
    } = useImageCarousel(offer._id, images.length);

    const handleWhatsAppClick = useCallback(
      (e: React.MouseEvent) => {
        e.stopPropagation();
        const cleanPhone = offer.contactPhone.replace(/\D/g, '');
        const message = encodeURIComponent(
          `Hola ${offer.fixerName}, vi tu oferta "${offer.title}" y me interesa.`,
        );
        window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
      },
      [offer.contactPhone, offer.fixerName, offer.title],
    );

    const handleFixerClick = useCallback(
      (e: React.MouseEvent) => {
        e.stopPropagation();
        if (offer.fixerId) {
          // Si quieres mantener el console.log(offer), debes incluir 'offer' en las dependencias.
          // Si eliminas el console.log, podrías dejar solo [offer.fixerId, router]
          console.log(offer);
          console.log('Navigating to fixer with ID:', offer.fixerId);
          router.push(`/fixer/${offer.fixerId}`);
        }
      },
      // CORRECCIÓN: Se agregó 'offer' aquí porque se usa dentro del console.log
      [offer, router],
    );

    const handleCardClick = useCallback(() => {
      if (onClick) onClick(offer);
    }, [onClick, offer]);

    const handleEditClick = useCallback(
      (e: React.MouseEvent) => {
        e.stopPropagation();
        if (onEdit) onEdit(offer);
      },
      [onEdit, offer],
    );

    const handleDeleteClick = useCallback(
      (e: React.MouseEvent) => {
        e.stopPropagation();
        if (onDelete) onDelete(offer._id);
      },
      [onDelete, offer._id],
    );

    const isDashboardMode = !!onEdit || !!onDelete;
    const totalImages = images.length;

    // Render Image Carousel
    const renderImageCarousel = () => (
      <div
        className={`relative overflow-hidden transition-transform ${isTouching ? 'scale-[0.98]' : 'scale-100'} ${viewMode === 'grid' ? 'h-48 w-full' : 'w-64 h-full flex-shrink-0'}`}
        onTouchStart={handleTouchStart}
        onTouchMove={handleTouchMove}
        onTouchEnd={handleTouchEnd}
        onClick={handleCardClick}
      >
        {images.length > 0 ? (
          images.map((img, idx) => {
            // Double-check en tiempo de render
            if (!img || typeof img !== 'string') return null;

            return (
              <Image
                key={idx}
                src={img}
                alt={offer.title}
                fill
                sizes={
                  viewMode === 'grid'
                    ? '(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 25vw'
                    : '16rem'
                }
                className={`object-cover transition-all duration-500 ${idx === currentIndex ? 'opacity-100 scale-100' : 'opacity-0 scale-110'}`}
                style={{ position: 'absolute' }}
                priority={idx === 0}
                onError={(e) => {
                  console.warn(`Failed to load image: ${img}`, e);
                }}
              />
            );
          })
        ) : (
          <div className='w-full h-full bg-gray-100 flex items-center justify-center text-gray-400'>
            <span className='text-sm'>No image</span>
          </div>
        )}

        {/* Navigation Arrows */}
        {totalImages > 1 && isHovered && (
          <>
            <button
              onClick={handlePrevImage}
              className='absolute left-2 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white p-1.5 rounded-full shadow-lg transition-all z-20 hover:scale-110 active:scale-95'
            >
              <ChevronLeft className='w-4 h-4 text-gray-800' />
            </button>
            <button
              onClick={handleNextImage}
              className='absolute right-2 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white p-1.5 rounded-full shadow-lg transition-all z-20 hover:scale-110 active:scale-95'
            >
              <ChevronRight className='w-4 h-4 text-gray-800' />
            </button>
          </>
        )}

        {/* Overlay */}
        <div className='absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300' />

        {/* Indicators */}
        {totalImages > 1 && (
          <div className='absolute bottom-3 left-0 right-0 flex justify-center gap-1.5 z-10'>
            {Array.from({ length: totalImages }).map((_, idx) => (
              <div
                key={idx}
                className={`h-1 rounded-full transition-all duration-300 ${idx === currentIndex ? 'w-6 bg-white shadow-lg' : 'w-1.5 bg-white/60'}`}
              />
            ))}
          </div>
        )}

        {/* Badges */}
        <div className='absolute left-3 top-3 inline-flex items-center gap-1.5 rounded-full bg-white/90 backdrop-blur-sm px-3 py-1.5 text-xs font-medium shadow-sm border border-primary'>
          <MapPin className='w-3.5 h-3.5 text-primary' />
          <span className='text-gray-700'>{offer.city}</span>
        </div>

        {!loadingPromos && hasPromotions && (
          <div className='absolute left-3 top-12 inline-flex items-center gap-1.5 rounded-full bg-gradient-to-r from-yellow-400 to-yellow-300 px-3 py-1.5 text-xs font-bold shadow-md border border-yellow-500 text-yellow-900 animate-pulse'>
            <svg
              className='w-3.5 h-3.5'
              fill='currentColor'
              viewBox='0 0 20 20'
              xmlns='http://www.w3.org/2000/svg'
            >
              <path d='M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z' />
            </svg>
            <span>Promoción</span>
          </div>
        )}

        {viewMode === 'grid' && (
          <div className='absolute right-3 top-3 rounded-lg bg-white/90 backdrop-blur-sm px-3 py-1.5 text-sm font-semibold shadow-sm border border-primary/20'>
            <span className='text-primary'>{offer.price?.toLocaleString()} Bs</span>
          </div>
        )}
      </div>
    );

    // Render Content
    const renderContent = () => (
      <div className={`flex flex-col ${viewMode === 'grid' ? 'p-4' : 'flex-1 p-4 relative'}`}>
        {viewMode === 'list' && (
          <div className='absolute right-4 top-4 rounded-lg bg-white/90 backdrop-blur-sm px-3 py-1.5 text-sm font-semibold shadow-sm border border-primary/20'>
            <span className='text-primary'>{offer.price?.toLocaleString()} Bs</span>
          </div>
        )}

        <div className={viewMode === 'list' ? 'mb-2 pr-32' : ''}>
          <h3
            className={`text-base font-semibold text-gray-900 group-hover:text-primary transition-colors ${viewMode === 'grid' ? 'truncate' : 'text-left'}`}
          >
            <SearchHighlight text={offer.title} searchQuery={searchQuery} />
          </h3>
          <p className='mt-1.5 text-sm text-gray-500 line-clamp-2 leading-relaxed'>
            <SearchHighlight text={offer.description} searchQuery={searchQuery} />
          </p>
        </div>

        <div className='mt-2 flex items-center justify-between'>
          <div className='flex items-center gap-2 flex-wrap'>
            <span className='inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary/10 text-primary'>
              {offer.category ? tCat(offer.category) : ''}
            </span>
            {offer.tags && offer.tags.length > 0 && (
              <span className='inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600'>
                {offer.tags[0]}
              </span>
            )}
          </div>
          <span className='text-xs text-gray-400 font-medium ml-auto'>
            {new Date(offer.createdAt).toLocaleDateString()}
          </span>
        </div>
      </div>
    );

    // Render Footer
    const renderFooter = () => {
      if (isDashboardMode && !readOnly) {
        return (
          <div className='border-t border-gray-100 p-3 flex items-center justify-end gap-2 bg-gray-50/50'>
            {onEdit && (
              <button
                onClick={handleEditClick}
                className='p-2 text-blue-600 hover:bg-blue-50 rounded-full transition-colors'
                title='Editar'
              >
                <Edit2 className='w-4 h-4' />
              </button>
            )}
            {onDelete && (
              <button
                onClick={handleDeleteClick}
                className='p-2 text-red-600 hover:bg-red-50 rounded-full transition-colors'
                title='Eliminar'
              >
                <Trash2 className='w-4 h-4' />
              </button>
            )}
          </div>
        );
      }

      if (readOnly) return null;

      return (
        <div className='border-t border-gray-100 p-3 flex items-center justify-between gap-3'>
          <div
            className='flex items-center gap-3 flex-1 min-w-0 cursor-pointer hover:opacity-80 transition-opacity'
            onClick={handleFixerClick}
          >
            <div className='w-9 h-9 rounded-full overflow-hidden flex-shrink-0 ring-2 ring-gray-100'>
              {offer.fixerPhoto ? (
                <Image
                  src={offer.fixerPhoto}
                  alt={offer.fixerName}
                  width={36}
                  height={36}
                  className='w-full h-full object-cover'
                />
              ) : (
                <div className='w-full h-full bg-primary/10 flex items-center justify-center text-primary text-sm font-bold'>
                  {offer.fixerName?.[0]?.toUpperCase() || 'U'}
                </div>
              )}
            </div>

            <div className='min-w-0 flex-1'>
              <p className='text-sm font-medium text-gray-900 truncate'>
                {offer.fixerName || t('defaultUserName')}
              </p>
              {offer.rating && (
                <div className='flex items-center gap-1 mt-0.5'>
                  <Star className='w-3.5 h-3.5 fill-amber-400 text-amber-400' />
                  <span className='text-xs font-semibold text-gray-600'>
                    {offer.rating.toFixed(1)}
                  </span>
                </div>
              )}
            </div>
          </div>

          <button
            onClick={handleWhatsAppClick}
            className='flex-shrink-0 bg-primary hover:bg-primary/90 rounded-full transition-all shadow-sm flex items-center gap-2 px-3 py-2'
            aria-label={t('contactWhatsApp')}
          >
            <MessageCircle className='w-4 h-4 text-white' />
            <span className='text-white text-xs font-medium'>{offer.contactPhone}</span>
          </button>
        </div>
      );
    };

    // Return
    return (
      <div
        ref={elementRef}
        onMouseEnter={handleMouseEnter}
        onMouseLeave={handleMouseLeave}
        className={`group relative w-full overflow-hidden rounded-2xl border border-gray-200 bg-white transition-all duration-300 hover:shadow-xl hover:border-primary hover:-translate-y-1 ${
          viewMode === 'list' ? 'flex flex-row' : ''
        } ${className}`}
      >
        {viewMode === 'grid' ? (
          <>
            <div onClick={handleCardClick} className='cursor-pointer contents'>
              {renderImageCarousel()}
              {renderContent()}
            </div>
            {renderFooter()}
          </>
        ) : (
          <>
            <div onClick={handleCardClick} className='cursor-pointer'>
              {renderImageCarousel()}
            </div>
            {/* Contenedor vertical para contenido + footer */}
            <div className='flex flex-col flex-1'>
              <div onClick={handleCardClick} className='cursor-pointer flex-1'>
                {renderContent()}
              </div>
              {renderFooter()}
            </div>
          </>
        )}
      </div>
    );
  },
  (prevProps, nextProps) => {
    return (
      prevProps.offer._id === nextProps.offer._id &&
      prevProps.viewMode === nextProps.viewMode &&
      prevProps.searchQuery === nextProps.searchQuery &&
      prevProps.readOnly === nextProps.readOnly &&
      prevProps.className === nextProps.className
      // No comparar onClick, onEdit, onDelete porque son memoizados en el padre
    );
  },
);

JobOfferCard.displayName = 'JobOfferCard';
</file>

<file path="src/Components/Job-offers/JobOffersView.tsx">
// src/Components/Job-offers/JobOffersView.tsx
'use client';

import React, { memo, useCallback, useMemo, useState, useEffect } from 'react';
import { useTranslations } from 'next-intl';
import { JobOfferCard } from './JobOfferCard';
import { MapView } from './maps/MapView';
import { mockJobOffers } from '@/app/lib/mock-data';
import { JobOfferData } from '@/types/jobOffers';

export type ViewMode = 'grid' | 'list' | 'map';

interface JobOffersViewProps {
  offers: JobOfferData[];
  viewMode: ViewMode;
  onOfferClick?: (offer: JobOfferData) => void;
  className?: string;
  showTitle?: boolean;
  search?: string;
}

export const JobOffersView = memo<JobOffersViewProps>(
  ({ offers, viewMode, onOfferClick, className = '', showTitle = true, search = '' }) => {
    const t = useTranslations('cardJob');

    // Para mobile, siempre mostrar grid
    const [isMobile, setIsMobile] = useState(false);

    useEffect(() => {
      const checkMobile = () => {
        setIsMobile(window.innerWidth < 1024);
      };

      checkMobile();
      window.addEventListener('resize', checkMobile);
      return () => window.removeEventListener('resize', checkMobile);
    }, []);

    const effectiveViewMode = isMobile ? 'grid' : viewMode;

    const handleOfferClick = useCallback(
      (offer: JobOfferData) => {
        onOfferClick?.(offer);
      },
      [onOfferClick],
    );

    const handleMapOfferClick = useCallback(
      (offer: { id: string }) => {
        const originalOffer = offers.find((o) => o._id === offer.id);
        if (originalOffer && onOfferClick) {
          onOfferClick(originalOffer);
        }
      },
      [offers, onOfferClick],
    );

    const gridClasses = useMemo(() => {
      switch (effectiveViewMode) {
        case 'grid':
          return 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-4';
        case 'list':
          return 'flex flex-col gap-4';
        case 'map':
          return '';
        default:
          return 'grid grid-cols-1 gap-4';
      }
    }, [effectiveViewMode]);

    const renderedCards = useMemo(() => {
      return offers.map((offer) => (
        <JobOfferCard
          key={offer._id}
          offer={offer}
          viewMode={effectiveViewMode === 'map' ? 'grid' : effectiveViewMode}
          onClick={handleOfferClick}
          searchQuery={search}
        />
      ));
    }, [offers, effectiveViewMode, handleOfferClick, search]);

    // Empty state
    if (offers.length === 0) {
      return (
        <div className={className}>
          {showTitle && (
            <h1 className='text-lg font-semibold mb-4 border-b border-gray-400 pb-2'>
              {t('searchResults')}
            </h1>
          )}
          <p className='text-gray-500 text-center'>{t('noResults')}</p>
        </div>
      );
    }

    // Vista de mapa
    if (effectiveViewMode === 'map') {
      return (
        <div className={className}>
          <div className='h-[calc(100vh-250px)] rounded-lg overflow-hidden border border-gray-200 bg-white mb-8'>
            <MapView offers={mockJobOffers} onOfferClick={handleMapOfferClick} />
          </div>
        </div>
      );
    }

    // Vista Grid o List
    return (
      <div className={className}>
        {showTitle && (
          <h1 className='text-lg font-semibold mb-4 border-b border-gray-400 pb-2'>
            {t('searchResults')}
          </h1>
        )}
        <div className={gridClasses}>{renderedCards}</div>
      </div>
    );
  },
  (prevProps, nextProps) => {
    // Comparar props primitivas
    if (prevProps.viewMode !== nextProps.viewMode) return false;
    if (prevProps.search !== nextProps.search) return false;
    if (prevProps.className !== nextProps.className) return false;
    if (prevProps.showTitle !== nextProps.showTitle) return false;

    // Comparar longitud de arrays
    if (prevProps.offers.length !== nextProps.offers.length) return false;

    // Comparar IDs de ofertas (shallow comparison es suficiente)
    return prevProps.offers.every((offer, index) => offer._id === nextProps.offers[index]._id);
  },
);

JobOffersView.displayName = 'JobOffersView';
</file>

<file path="src/Components/Job-offers/maps/JobMarker.tsx">
'use client';

import { MapPin } from 'lucide-react';
import type { JobOffer } from '@/app/lib/mock-data';

interface JobMarkerProps {
  offer: JobOffer;
  isSelected: boolean;
  onClick: () => void;
}

export function JobMarker({ offer, isSelected, onClick }: JobMarkerProps) {
  return (
    <button
      onClick={onClick}
      className={`
        relative transform transition-all duration-200 hover:scale-110
        ${isSelected ? 'scale-125 z-50' : 'z-10'}
      `}
      title={offer.fixerName}
    >
      <MapPin
        className={`
          w-10 h-10 drop-shadow-lg transition-colors
          ${isSelected ? 'text-primary fill-primary' : 'text-red-500 fill-red-500'}
        `}
      />
      <div
        className={`
        absolute -top-1 -right-1 w-4 h-4 rounded-full border-2 border-white
        ${isSelected ? 'bg-primary animate-pulse' : 'bg-red-500'}
      `}
      />
    </button>
  );
}
</file>

<file path="src/Components/Job-offers/maps/JobQuickInfo.tsx">
'use client';

import type React from 'react';
import { Phone, MessageCircle, ChevronRight, MapPin, Star, Navigation } from 'lucide-react';
import type { JobOffer } from '@/app/lib/mock-data';

interface JobQuickInfoProps {
  offer: JobOffer;
  onShowMore: () => void;
  distance?: number;
}

export function JobQuickInfo({ offer, onShowMore, distance }: JobQuickInfoProps) {
  const handleWhatsAppClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    const message = encodeURIComponent(
      `Hola ${offer.fixerName}, vi tu oferta de trabajo y me interesa.`,
    );
    window.open(`https://wa.me/${offer.whatsapp.replace(/\s/g, '')}?text=${message}`, '_blank');
  };

  return (
    <div className='relative bg-white/90 backdrop-blur-md rounded-2xl shadow-xl border-2 border-primary/80 p-5 min-w-[300px] max-w-[calc(100vw-2rem)] sm:max-w-[380px] animate-in fade-in slide-in-from-left-8 duration-300 overflow-hidden z-[1000]'>
      <div className='absolute inset-0 bg-gradient-to-b from-blue-500/5 to-transparent'></div>

      <div className='relative z-10'>
        <div className='flex items-start gap-3 mb-4'>
          <div className='relative group'>
            <div className='relative w-14 h-14 rounded-xl bg-blue-500/90 flex items-center justify-center text-white font-bold text-xl shadow-md border border-white/50 flex-shrink-0 transition-all duration-300 group-hover:bg-blue-600/90'>
              {offer.fixerName.charAt(0)}
            </div>
          </div>

          <div className='flex-1 min-w-0'>
            <h3 className='font-bold text-lg text-blue-900 truncate'>{offer.fixerName}</h3>
            <div className='flex items-center gap-1 mt-1'>
              {[...Array(5)].map((_, i) => (
                <Star key={i} className='w-3.5 h-3.5 text-yellow-400 fill-yellow-400' />
              ))}
              <span className='text-xs text-gray-600 ml-1'>(4.9)</span>
            </div>
            {distance !== undefined && (
              <div className='flex items-center gap-1 mt-2 text-xs text-primary'>
                <Navigation className='w-3 h-3' />
                <span className='font-semibold'>{distance.toFixed(1)} km de distancia</span>
              </div>
            )}
          </div>
        </div>

        <p className='text-sm text-gray-700 line-clamp-2 mb-4 leading-relaxed'>
          {offer.description}
        </p>

        <div className='flex flex-wrap gap-2 mb-4'>
          {offer.tags.slice(0, 3).map((tag, index) => (
            <span
              key={tag}
              className='px-3 py-1.5 bg-blue-100 text-primary text-xs rounded-lg font-semibold border border-blue-300 animate-in fade-in slide-in-from-left duration-300 hover:bg-blue-200 hover:border-blue-400 transition-all'
              style={{ animationDelay: `${index * 50}ms` }}
            >
              {tag}
            </span>
          ))}
        </div>

        <div className='flex items-center gap-2 text-xs text-gray-600 mb-4 pb-4 border-b border-blue-200'>
          <MapPin className='w-3.5 h-3.5 text-primary' />
          <span>{offer.location.address}</span>
        </div>

        <div className='flex items-center gap-2'>
          <button
            onClick={handleWhatsAppClick}
            className='flex-1 px-4 py-2.5 rounded-lg text-sm font-medium bg-green-50 border-2 border-green-500 text-green-700 hover:bg-green-100 transition-all duration-300 flex items-center justify-center gap-2'
          >
            <MessageCircle className='w-4 h-4' />
            WhatsApp
          </button>

          <button
            onClick={onShowMore}
            className='flex-1 px-4 py-2.5 rounded-lg text-sm font-medium bg-primary text-white shadow-lg transition-all duration-300 hover:shadow-xl hover:scale-105 flex items-center justify-center gap-2 border-2 border-blue-600'
          >
            Ver más
            <ChevronRight className='w-4 h-4' />
          </button>
        </div>

        <div className='flex items-center gap-2 text-xs text-gray-600 mt-3 pt-3 border-t border-blue-200'>
          <Phone className='w-3.5 h-3.5 text-primary' />
          <span className='font-medium'>{offer.whatsapp}</span>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/Job-offers/maps/JobTyleFilter.tsx">
'use client';

import { availableServices } from '@/app/lib/mock-data';
import { Check, Filter, X } from 'lucide-react';

interface JobTypeFilterProps {
  selectedTypes: string[];
  onTypeToggle: (type: string) => void;
  onClearAll: () => void;
}

export function JobTypeFilter({ selectedTypes, onTypeToggle, onClearAll }: JobTypeFilterProps) {
  return (
    <div className='bg-gradient-to-br from-card/95 to-card/90 backdrop-blur-xl border-2 border-border rounded-2xl p-6 shadow-2xl animate-in fade-in slide-in-from-top duration-500'>
      <div className='flex items-center justify-between mb-5'>
        <div className='flex items-center gap-3'>
          <div className='w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center shadow-lg'>
            <Filter className='w-5 h-5 text-white' />
          </div>
          <div>
            <h3 className='font-bold text-lg text-foreground'>Filtrar por tipo</h3>
            <p className='text-xs text-muted-foreground'>Selecciona los servicios que buscas</p>
          </div>
        </div>

        {selectedTypes.length > 0 && (
          <button
            onClick={onClearAll}
            className='px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-destructive/10 hover:text-destructive transition-all duration-300 flex items-center gap-1'
          >
            <X className='w-4 h-4' />
            Limpiar
          </button>
        )}
      </div>

      <div className='grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3'>
        {availableServices.map((service, index) => {
          const isSelected = selectedTypes.includes(service);
          return (
            <button
              key={service}
              onClick={() => onTypeToggle(service)}
              className={`
                group relative px-4 py-3 rounded-xl text-sm font-medium transition-all duration-300
                hover:shadow-lg hover:-translate-y-0.5
                ${
                  isSelected
                    ? 'bg-gradient-to-br from-primary to-blue-600 text-white shadow-lg shadow-primary/30 scale-105'
                    : 'bg-muted/50 text-muted-foreground hover:bg-muted border-2 border-transparent hover:border-primary/20'
                }
              `}
              style={{
                animation: `fadeIn 0.3s ease-out ${index * 0.05}s both`,
              }}
            >
              <span className='flex items-center justify-center gap-2'>
                {isSelected && <Check className='w-4 h-4 animate-in zoom-in duration-300' />}
                <span className='truncate'>{service}</span>
              </span>

              {/* Efecto de brillo en hover */}
              <div className='absolute inset-0 rounded-xl bg-gradient-to-r from-transparent via-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none' />
            </button>
          );
        })}
      </div>

      {selectedTypes.length > 0 && (
        <div className='mt-5 pt-4 border-t border-border animate-in fade-in slide-in-from-bottom duration-300'>
          <div className='flex items-center justify-between'>
            <p className='text-sm text-muted-foreground'>
              {selectedTypes.length}{' '}
              {selectedTypes.length === 1 ? 'tipo seleccionado' : 'tipos seleccionados'}
            </p>
            <div className='flex flex-wrap gap-2'>
              {selectedTypes.slice(0, 3).map((type) => (
                <span
                  key={type}
                  className='px-3 py-1 bg-primary/10 text-primary text-xs rounded-lg font-medium border border-primary/20'
                >
                  {type}
                </span>
              ))}
              {selectedTypes.length > 3 && (
                <span className='px-3 py-1 bg-muted text-muted-foreground text-xs rounded-lg font-medium'>
                  +{selectedTypes.length - 3} más
                </span>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/Components/Job-offers/maps/MapView.tsx">
'use client';

import { useState, useEffect, useRef, useCallback } from 'react';
import type { JobOffer } from '@/app/lib/mock-data';
import { userLocation } from '@/app/lib/mock-data';
import { JobQuickInfo } from './JobQuickInfo';
import { MapPin, Minus, Plus } from 'lucide-react';
import type { Map, Marker, Circle } from 'leaflet';

interface MapViewProps {
  offers: JobOffer[];
  onOfferClick: (offer: JobOffer) => void;
}

export function MapView({ offers, onOfferClick }: MapViewProps) {
  const [isClient, setIsClient] = useState(false);
  const [hoveredOffer, setHoveredOffer] = useState<JobOffer | null>(null);
  const [radiusKm, setRadiusKm] = useState(1);
  const [offersInRadius, setOffersInRadius] = useState(0);

  const mapRef = useRef<HTMLDivElement>(null);
  const mapInstanceRef = useRef<Map | null>(null);
  const markersRef = useRef<Marker[]>([]);
  const userMarkerRef = useRef<Marker | null>(null);
  const circleRef = useRef<Circle | null>(null);
  const hoverTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const isHoveringCardRef = useRef<boolean>(false);
  const currentHoveredOfferIdRef = useRef<string | null>(null);
  const pendingHoverRef = useRef<string | null>(null);

  const calculateDistance = (lat1: number, lng1: number, lat2: number, lng2: number) => {
    const R = 6371;
    const dLat = ((lat2 - lat1) * Math.PI) / 180;
    const dLng = ((lng2 - lng1) * Math.PI) / 180;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos((lat1 * Math.PI) / 180) *
        Math.cos((lat2 * Math.PI) / 180) *
        Math.sin(dLng / 2) *
        Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  };

  // Calcular ofertas dentro del radio actual
  const calculateOffersInRadius = useCallback(
    (currentRadius: number) => {
      const count = offers.filter((offer) => {
        const distance = calculateDistance(
          userLocation.lat,
          userLocation.lng,
          offer.location.lat,
          offer.location.lng,
        );
        return distance <= currentRadius;
      }).length;
      setOffersInRadius(count);
    },
    [offers],
  );

  // Actualizar radio del círculo
  const updateCircleRadius = useCallback(
    (newRadius: number) => {
      if (circleRef.current) {
        circleRef.current.setRadius(newRadius * 1000); // convertir a metros
      }
      calculateOffersInRadius(newRadius);
    },
    [calculateOffersInRadius],
  );

  // Handlers para ajustar el radio
  const handleRadiusChange = useCallback(
    (newRadius: number) => {
      const clampedRadius = Math.max(0.5, Math.min(10, newRadius));
      setRadiusKm(clampedRadius);
      updateCircleRadius(clampedRadius);
    },
    [updateCircleRadius],
  );

  const increaseRadius = useCallback(() => {
    handleRadiusChange(radiusKm + 0.5);
  }, [radiusKm, handleRadiusChange]);

  const decreaseRadius = useCallback(() => {
    handleRadiusChange(radiusKm - 0.5);
  }, [radiusKm, handleRadiusChange]);

  const updateMarkers = useCallback(
    async (L: typeof import('leaflet'), map: Map, offersToShow: JobOffer[]) => {
      // Limpiar marcadores existentes de forma segura
      markersRef.current.forEach((marker) => {
        try {
          map.removeLayer(marker);
        } catch (error) {
          console.error('Error removing marker:', error);
        }
      });
      markersRef.current = [];

      // ========================================================================
      // 📍 MARCADORES OPTIMIZADOS CON MEJOR MANEJO DE HOVER
      // ========================================================================
      offersToShow.forEach((offer, index) => {
        const distance = calculateDistance(
          userLocation.lat,
          userLocation.lng,
          offer.location.lat,
          offer.location.lng,
        ).toFixed(1);

        const markerIcon = L.divIcon({
          className: 'custom-offer-marker',
          html: `
          <div class="relative animate-in fade-in slide-in-from-bottom-4 duration-500" style="animation-delay: ${index * 100}ms">
            <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-6 h-2 bg-black/20 rounded-full blur-sm"></div>
            <div class="relative group cursor-pointer">
              <div class="absolute inset-0 bg-primary/20 rounded-full blur-md group-hover:bg-primary/40 transition-all duration-300"></div>
              <div class="relative w-12 h-12 bg-black/15 rounded-full border-4 border-white shadow-2xl flex items-center justify-center transition-all duration-300 group-hover:scale-110">
                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
              </div>
              <div class="absolute -top-1 -right-1 w-6 h-6 bg-primary text-white text-xs font-bold rounded-full flex items-center justify-center shadow-lg border-2 border-white group-hover:scale-110 transition-transform duration-300">
                ${offer.services.length}
              </div>
            </div>
          </div>
        `,
          iconSize: [48, 48],
          iconAnchor: [24, 48],
        });

        const marker = L.marker([offer.location.lat, offer.location.lng], {
          icon: markerIcon,
        }).addTo(map);

        // ========================================================================
        // 📍 EVENTOS HOVER OPTIMIZADOS - Mejor manejo de múltiples hover
        // ========================================================================
        const markerElement = marker.getElement();
        if (markerElement) {
          markerElement.addEventListener('mouseenter', () => {
            // Limpiar cualquier timeout pendiente
            if (hoverTimeoutRef.current) {
              clearTimeout(hoverTimeoutRef.current);
              hoverTimeoutRef.current = null;
            }

            // Si ya estamos mostrando esta oferta, no hacer nada
            if (currentHoveredOfferIdRef.current === offer.id) {
              return;
            }

            // Marcar como pendiente
            pendingHoverRef.current = offer.id;

            // Delay más corto para mejor responsividad
            hoverTimeoutRef.current = setTimeout(() => {
              // Verificar que sigue siendo la pendiente (no se canceló)
              if (pendingHoverRef.current === offer.id && !isHoveringCardRef.current) {
                currentHoveredOfferIdRef.current = offer.id;
                setHoveredOffer(offer);
              }
              pendingHoverRef.current = null;
            }, 100);
          });

          markerElement.addEventListener('mouseleave', () => {
            // Si este marcador era el pendiente, cancelarlo
            if (pendingHoverRef.current === offer.id) {
              pendingHoverRef.current = null;
            }

            // Limpiar timeout de entrada
            if (hoverTimeoutRef.current) {
              clearTimeout(hoverTimeoutRef.current);
              hoverTimeoutRef.current = null;
            }

            // Solo ocultar si es el marcador actualmente mostrado
            if (currentHoveredOfferIdRef.current === offer.id) {
              // Delay antes de ocultar para permitir mover el mouse a la tarjeta
              hoverTimeoutRef.current = setTimeout(() => {
                if (!isHoveringCardRef.current && currentHoveredOfferIdRef.current === offer.id) {
                  currentHoveredOfferIdRef.current = null;
                  setHoveredOffer(null);
                }
              }, 150);
            }
          });
        }

        // Popup al hacer click
        marker.bindPopup(
          `<div class="text-center p-3">
          <p class="font-bold text-sm text-gray-800 mb-1">${offer.fixerName}</p>
          <p class="text-xs text-gray-600 mb-2">${offer.description}</p>
          <p class="text-xs text-primary font-semibold">${distance} km de distancia</p>
        </div>`,
          { className: 'custom-popup' },
        );

        markersRef.current.push(marker);
      });
    },
    [],
  ); // Dependencias: calculateDistance y userLocation son estables, pero si no, se pueden incluir

  useEffect(() => {
    setIsClient(true);
  }, []);

  useEffect(() => {
    if (!isClient || !mapRef.current) return;

    const initializeMap = async () => {
      const L = await import('leaflet');

      const map = L.map(mapRef.current!, {
        zoomControl: false,
      }).setView([userLocation.lat, userLocation.lng], 14);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19,
      }).addTo(map);

      // Marcador de usuario
      const userIcon = L.divIcon({
        className: 'custom-user-marker',
        html: `
          <div class="relative">
            <div class="absolute inset-0 w-10 h-10 -left-1 -top-1 bg-primary/30 rounded-full animate-ping"></div>
            <div class="relative w-8 h-8 bg-primary rounded-full border-4 border-white shadow-2xl flex items-center justify-center">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
              </svg>
            </div>
          </div>
        `,
        iconSize: [40, 40],
        iconAnchor: [20, 20],
      });

      const userMarker = L.marker([userLocation.lat, userLocation.lng], {
        icon: userIcon,
      }).addTo(map);

      userMarker.bindPopup(
        `<div class="text-center p-3">
          <p class="font-bold text-sm text-blue-400 mb-1">Tu ubicación</p>
          <p class="text-xs text-gray-600">${userLocation.address}</p>
        </div>`,
        { className: 'custom-popup' },
      );

      userMarkerRef.current = userMarker;

      // Círculo dinámico con radio inicial
      const circle = L.circle([userLocation.lat, userLocation.lng], {
        color: '#3b82f6',
        fillColor: '#3b82f6',
        fillOpacity: 0.15,
        radius: radiusKm * 1000,
        weight: 2,
        opacity: 0.6,
      }).addTo(map);

      circleRef.current = circle;

      mapInstanceRef.current = map;
      updateMarkers(L, map, offers);
      calculateOffersInRadius(radiusKm);
    };

    initializeMap();

    return () => {
      if (mapInstanceRef.current) {
        mapInstanceRef.current.remove();
        mapInstanceRef.current = null;
      }
    };
  }, [isClient, offers, updateMarkers, radiusKm, calculateOffersInRadius]);

  // Efecto para actualizar marcadores cuando las ofertas cambian
  useEffect(() => {
    if (!isClient || !mapInstanceRef.current) return;

    const updateMarkersOnChange = async () => {
      const L = await import('leaflet');
      updateMarkers(L, mapInstanceRef.current!, offers);
    };

    updateMarkersOnChange();
  }, [offers, isClient, updateMarkers]);

  const handleShowMore = useCallback(
    (offer: JobOffer) => {
      // Limpiar todos los estados y timeouts
      if (hoverTimeoutRef.current) {
        clearTimeout(hoverTimeoutRef.current);
        hoverTimeoutRef.current = null;
      }

      // Resetear todas las refs
      isHoveringCardRef.current = false;
      currentHoveredOfferIdRef.current = null;
      pendingHoverRef.current = null;

      onOfferClick(offer);
      setHoveredOffer(null);
    },
    [onOfferClick],
  );

  // Cleanup al desmontar componente
  useEffect(() => {
    return () => {
      if (hoverTimeoutRef.current) {
        clearTimeout(hoverTimeoutRef.current);
      }
    };
  }, []);

  const handleZoomIn = () => {
    if (mapInstanceRef.current) {
      mapInstanceRef.current.zoomIn();
    }
  };

  const handleZoomOut = () => {
    if (mapInstanceRef.current) {
      mapInstanceRef.current.zoomOut();
    }
  };

  // const handleRecenter = () => {
  //   if (mapInstanceRef.current) {
  //     mapInstanceRef.current.setView([userLocation.lat, userLocation.lng], 14)
  //   }
  // }

  // Si no estamos en el cliente, mostrar un placeholder
  if (!isClient) {
    return (
      <div className='w-full h-full rounded-2xl overflow-hidden shadow-lg border border-blue-200 bg-gray-200 flex items-center justify-center'>
        <p>Cargando mapa...</p>
      </div>
    );
  }

  return (
    <div className='relative w-full h-full rounded-2xl overflow-hidden shadow-lg border border-blue-200'>
      <div ref={mapRef} className='w-full h-full relative' />

      {/* ======================================================================
          📍 PANEL "DETALLES DE LA OFERTA" (JobQuickInfo) - OPTIMIZADO
          ====================================================================== */}
      {hoveredOffer && (
        <div
          className='absolute top-4 left-1/4 -translate-x-1/2 z-[400] animate-in fade-in slide-in-from-top-4 duration-200 w-full max-w-sm px-4'
          onMouseEnter={() => {
            // Marcar que estamos sobre la tarjeta
            isHoveringCardRef.current = true;

            // Limpiar cualquier timeout de cierre
            if (hoverTimeoutRef.current) {
              clearTimeout(hoverTimeoutRef.current);
              hoverTimeoutRef.current = null;
            }
          }}
          onMouseLeave={() => {
            // Marcar que salimos de la tarjeta
            isHoveringCardRef.current = false;

            // Limpiar timeout anterior
            if (hoverTimeoutRef.current) {
              clearTimeout(hoverTimeoutRef.current);
            }

            // Delay corto para ocultar la tarjeta
            hoverTimeoutRef.current = setTimeout(() => {
              if (!isHoveringCardRef.current) {
                currentHoveredOfferIdRef.current = null;
                pendingHoverRef.current = null;
                setHoveredOffer(null);
              }
            }, 150);
          }}
        >
          <JobQuickInfo
            offer={hoveredOffer}
            onShowMore={() => handleShowMore(hoveredOffer)}
            distance={Number(
              calculateDistance(
                userLocation.lat,
                userLocation.lng,
                hoveredOffer.location.lat,
                hoveredOffer.location.lng,
              ).toFixed(1),
            )}
          />
        </div>
      )}

      {/* Botones de zoom */}
      <div className='absolute top-4 left-4 flex flex-col gap-0 z-[450] bg-white rounded-lg shadow-md border border-gray-300 overflow-hidden'>
        <button
          onClick={handleZoomIn}
          className='w-10 h-10 flex items-center justify-center text-gray-700 hover:bg-gray-100 transition-colors border-b border-gray-300'
          aria-label='Zoom in'
        >
          <span className='text-xl font-semibold leading-none'>+</span>
        </button>
        <button
          onClick={handleZoomOut}
          className='w-10 h-10 flex items-center justify-center text-gray-700 hover:bg-gray-100 transition-colors'
          aria-label='Zoom out'
        >
          <span className='text-xl font-semibold leading-none'>−</span>
        </button>
      </div>

      {/* ======================================================================
          📍 PANEL DINÁMICO "DETALLES DEL MAPA" CON CONTROL DE RADIO
          ====================================================================== */}
      <div className='absolute bottom-4 right-4 bg-white/95 backdrop-blur-xl border border-blue-300 rounded-2xl p-4 shadow-2xl shadow-blue-500/20 z-[450] animate-in fade-in slide-in-from-right duration-500 max-w-xs'>
        <h4 className='font-bold text-sm text-primary mb-3 flex items-center gap-2'>
          <MapPin className='w-4 h-4' />
          Detalles del mapa
        </h4>
        <div className='space-y-2.5 text-sm'>
          <div className='flex items-center gap-3 group cursor-default'>
            <div className='relative'>
              <div className='w-5 h-5 rounded-full bg-primary border-2 border-white shadow-lg transition-transform duration-300 group-hover:scale-110' />
            </div>
            <span className='font-medium'>Tu ubicación</span>
          </div>
          <div className='flex items-center gap-3 group cursor-default'>
            <div className='relative'>
              <div className='w-5 h-5 rounded-full bg-black/20 border-2 border-white shadow-lg transition-transform duration-300 group-hover:scale-110' />
            </div>
            <span className='font-medium'>Ofertas de trabajo</span>
          </div>

          {/* Control de Radio */}
          <div className='pt-3 border-t border-blue-500/30 space-y-3'>
            <div className='flex items-center justify-between'>
              <span className='text-gray-700 text-xs font-medium'>Radio de búsqueda</span>
              <span className='text-primary text-sm font-bold'>{radiusKm.toFixed(1)} km</span>
            </div>

            {/* Slider */}
            <div className='relative'>
              <input
                type='range'
                min='0.5'
                max='10'
                step='0.5'
                value={radiusKm}
                onChange={(e) => handleRadiusChange(parseFloat(e.target.value))}
                className='w-full h-2 bg-blue-100 rounded-lg appearance-none cursor-pointer accent-blue-600 hover:accent-blue-700 transition-all'
              />
              <div className='flex justify-between text-xs text-gray-400 mt-1'>
                <span>0.5km</span>
                <span>10km</span>
              </div>
            </div>

            {/* Botones +/- */}
            <div className='flex items-center justify-center gap-2'>
              <button
                onClick={decreaseRadius}
                disabled={radiusKm <= 0.5}
                className='w-8 h-8 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 disabled:opacity-40 disabled:cursor-not-allowed transition-all hover:scale-110'
                aria-label='Disminuir radio'
              >
                <Minus className='w-4 h-4' />
              </button>
              <span className='text-xs text-gray-500 min-w-[60px] text-center'>Ajustar radio</span>
              <button
                onClick={increaseRadius}
                disabled={radiusKm >= 10}
                className='w-8 h-8 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 disabled:opacity-40 disabled:cursor-not-allowed transition-all hover:scale-110'
                aria-label='Aumentar radio'
              >
                <Plus className='w-4 h-4' />
              </button>
            </div>
          </div>
        </div>

        {/* Contador de ofertas */}
        <div className='mt-3 pt-3 border-t border-blue-500/30'>
          <p className='text-xs font-semibold text-primary'>
            {offersInRadius} {offersInRadius === 1 ? 'oferta' : 'ofertas'} en el radio
          </p>
          <p className='text-xs text-gray-500 mt-1'>{offers.length} total disponibles</p>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/Job-offers/Pagination/PaginationInfo.tsx">
'use client';
import React from 'react';
import { useTranslations } from 'next-intl';

interface PaginationInfoProps {
  paginaActual: number;
  registrosPorPagina: number;
  totalRegistros: number;
}

const PaginationInfo: React.FC<PaginationInfoProps> = ({
  paginaActual,
  registrosPorPagina,
  totalRegistros,
}) => {
  const t = useTranslations('pagination');

  if (totalRegistros === 0) {
    return (
      <div className='text-sm text-gray-600 mt-3'>
        {t('showingResults', { start: 0, end: 0, total: 0 })}
      </div>
    );
  }

  const inicioRegistro = (paginaActual - 1) * registrosPorPagina + 1;
  const finRegistro = Math.min(paginaActual * registrosPorPagina, totalRegistros);

  return (
    <div className='text-sm text-gray-600 mt-3'>
      {t('showingResults', { start: inicioRegistro, end: finRegistro, total: totalRegistros })}
    </div>
  );
};

export default PaginationInfo;
</file>

<file path="src/Components/Job-offers/Pagination/PaginationSelector.tsx">
'use client';

import { Fragment } from 'react';
import { Listbox, Transition } from '@headlessui/react';
import { ChevronDown } from 'lucide-react';
import {
  validatePagination,
  JOBOFERT_ALLOWED_LIMITS,
} from '@/app/lib/validations/pagination.validator';
import { useTranslations } from 'next-intl';

interface PaginationSelectorProps {
  registrosPorPagina: number;
  onChange: (valor: number) => void;
}

const PaginationSelector: React.FC<PaginationSelectorProps> = ({
  registrosPorPagina,
  onChange,
}) => {
  const t = useTranslations('pagination');
  const opciones = [...JOBOFERT_ALLOWED_LIMITS];

  const handleChange = (valor: number) => {
    const { isValid, data } = validatePagination(1, valor);
    if (!isValid || !data) return;
    onChange(data.limit);
  };

  return (
    <div className='flex items-center gap-2 mt-4'>
      <span className='text-sm text-gray-600'>{t('show')}</span>
      <Listbox value={registrosPorPagina} onChange={handleChange}>
        <div className='relative'>
          <Listbox.Button className='relative w-20 cursor-pointer border border-gray-300 rounded-lg bg-white px-2 py-1 text-left text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500'>
            {registrosPorPagina}
            <span className='absolute inset-y-0 right-0 flex items-center pr-2'>
              <ChevronDown size={16} />
            </span>
          </Listbox.Button>

          <Transition
            as={Fragment}
            leave='transition ease-in duration-100'
            leaveFrom='opacity-100'
            leaveTo='opacity-0'
          >
            <Listbox.Options className='absolute mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-sm shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none'>
              {opciones.map((opcion) => (
                <Listbox.Option
                  key={opcion}
                  value={opcion}
                  className={({ active, selected }) =>
                    `cursor-pointer select-none px-4 py-2 ${
                      active ? 'bg-blue-600 text-white' : 'text-black'
                    } ${selected ? 'font-bold' : ''}`
                  }
                >
                  {opcion}
                </Listbox.Option>
              ))}
            </Listbox.Options>
          </Transition>
        </div>
      </Listbox>
      <span className='text-sm text-gray-600'>{t('perPage')}</span>
    </div>
  );
};

export default PaginationSelector;
</file>

<file path="src/Components/Job-offers/Search/AdvancedSearchButton.tsx">
'use client';

import React from 'react';
import { useRouter } from 'next/navigation';
import { ZoomIn } from 'lucide-react';
import { Button } from '@/Components/ui/button';
import { useTranslations } from 'next-intl';

interface AdvancedSearchButtonProps {
  src?: string;
  alt?: string;
}

export function AdvancedSearchButton({}: AdvancedSearchButtonProps) {
  const t = useTranslations('search');
  const router = useRouter();

  const handleClick = () => {
    router.push('/adv-search');
  };

  return (
    <Button
      onClick={handleClick}
      aria-label={t('goToAdvancedSearch')}
      size='lg'
      className='
        bg-[#2B6AE0] text-white
        hover:bg-[#2B6AE0]/90
        shrink-0
        px-1 sm:px-2
        py-2 sm:py-5
        text-sm sm:text-base
        font-semibold
        rounded
        shadow
        transition-all duration-200
        flex items-center justify-center
      '
    >
      <div className='flex-shrink-0'>
        <ZoomIn className='w-8 h-8' strokeWidth={2.8} />
      </div>
    </Button>
  );
}
</file>

<file path="src/Components/Job-offers/Search/ClearButton.tsx">
import { X } from 'lucide-react';
import React from 'react';
import { useTranslations } from 'next-intl';

interface ClearButtonProps {
  onClick: () => void;
}

export const ClearButton = ({ onClick }: ClearButtonProps) => {
  const t = useTranslations('search');

  return (
    <button
      onClick={onClick}
      type='button'
      className='absolute right-2 top-1/2 z-[2] -translate-y-1/2 flex items-center justify-center w-5 h-5 bg-transparent border-none cursor-pointer p-0'
      aria-label={t('clearSearch')}
    >
      <X size={16} color='#888' />
    </button>
  );
};
</file>

<file path="src/Components/Job-offers/Search/InputOnlySearch.tsx">
'use client';

import React from 'react';
import { Input } from '@/Components/ui/input';
import { SearchIcon } from './SearchIcon';
import { ClearButton } from './ClearButton';
import { validateSearch } from '@/app/lib/validations/search.validator';
import { useTranslations } from 'next-intl';

type NoResultsMessageProps = {
  search: string;
};
export const NoResultsMessage: React.FC<NoResultsMessageProps> = ({ search }) => {
  const t = useTranslations('search');
  const trimmed = search?.trim();

  return (
    <div className='text-center py-12'>
      <p className='text-gray-500 text-xl font-roboto font-normal'>
        {t('noResults')}
        {trimmed && (
          <>
            {' '}
            {t('for')} <span className='font-bold'>&quot;{trimmed}&quot;</span>
          </>
        )}
      </p>
    </div>
  );
};

interface InputOnlySearchProps {
  onSearch: (query: string) => void;
  onValueChange?: (value: string) => void;
}

export const InputOnlySearch = ({ onSearch, onValueChange }: InputOnlySearchProps) => {
  const t = useTranslations('search');
  const [value, setValue] = React.useState('');
  const [error, setError] = React.useState<string | undefined>();

  // Use a ref to track if we've already initialized from URL
  const hasInitialized = React.useRef(false);

  // On mount, if there's a `search` query param (coming from AdvSearch "Modificar"), populate the input
  React.useEffect(() => {
    if (typeof window === 'undefined' || hasInitialized.current) return;

    try {
      const sp = new URLSearchParams(window.location.search);
      const s = sp.get('search');
      if (s && s.length) {
        setValue(s);
        if (typeof onValueChange === 'function') onValueChange(s);
        hasInitialized.current = true;
      }
    } catch {
      // ignore
    }
  }, [onValueChange]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setValue(e.target.value);
    if (typeof onValueChange === 'function') onValueChange(e.target.value);
    const { isValid, error } = validateSearch(e.target.value);
    setError(isValid ? undefined : error);
  };

  const handleClear = () => {
    setValue('');
    setError(undefined);
    // Only clear the input value locally and notify parent of the value change.
    // Do NOT trigger a search/navigation here.
    if (typeof onValueChange === 'function') onValueChange('');
  };

  const handleSearch = () => {
    const { isValid, error, data } = validateSearch(value);
    if (!isValid) {
      setError(error);
      return;
    }
    onSearch(data!);
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter') handleSearch();
  };

  const hasError = !!error;
  const inputClasses = `pl-10 ${value.length > 0 ? 'pr-10' : 'pr-9'} w-full sm:min-w-80 rounded ${
    hasError ? 'border-red-500 border-[1.5px] outline-none shadow-[0_0_0_1px_red]' : ''
  }`;

  return (
    <div className='w-full'>
      <div className='relative'>
        <SearchIcon hasError={hasError} />
        <Input
          type='text'
          placeholder={t('placeholder')}
          className={inputClasses}
          value={value}
          onChange={handleChange}
          onKeyDown={handleKeyDown}
        />
        {value.length > 0 && <ClearButton onClick={handleClear} />}
      </div>
      <div className='h-2 mt-1'>{hasError && <p className='text-red-500 text-sm'>{error}</p>}</div>
    </div>
  );
};
</file>

<file path="src/Components/Job-offers/Search/NoResultsMessage.tsx">
import { useTranslations } from 'next-intl';

type NoResultsMessageProps = {
  search: string;
};

export const NoResultsMessage: React.FC<NoResultsMessageProps> = ({ search }) => {
  const t = useTranslations('search');
  const trimmed = search?.trim();

  return (
    <div className='text-center py-12'>
      <p className='text-gray-500 text-xl font-roboto font-normal'>
        {t('noResults')}
        {trimmed && (
          <>
            {' '}
            {t('for')} <span className='font-bold'>&quot;{trimmed}&quot;</span>
          </>
        )}
      </p>
    </div>
  );
};
</file>

<file path="src/Components/Job-offers/Search/SearchBar.tsx">
// src/Components/Job-offers/Search/SearchBar.tsx
'use client';

import React from 'react';
import { Input } from '@/Components/ui/input';
import { SearchIcon } from './SearchIcon';
import { ClearButton } from './ClearButton';
import { SearchButton } from './SearchButton';
import { AdvancedSearchButton } from './AdvancedSearchButton';
import { FilterButton } from '../Filter/FilterButton';
import { validateSearch } from '@/app/lib/validations/search.validator';
import { useAppSelector, useAppDispatch } from '@/app/redux/hooks';
import { useTranslations } from 'next-intl';
import { useSearchHistory } from '@/app/redux/features/searchHistory/useSearchHistory';
import { useSearchSuggestions } from '@/app/redux/features/searchHistory/useSearchSuggestions';
import { useSearchKeyboard } from '@/app/redux/features/searchHistory/useSearchKeyboard';
import { useSearchTouch } from '@/app/redux/features/searchHistory/useSearchTouch';
import { SearchDropdown } from '@/Components/Shared/SearchDropdown';
import { usePathname } from 'next/navigation'; // 👈 TU ÚNICA IMPORTACIÓN NUEVA
import { useJobTypeAutoMatch } from '@/lib/useJobTypeAutoMatch';
import { setFilters } from '@/app/redux/slice/jobOfert';
import { useEffect } from 'react';

interface SearchBarProps {
  onSearch: (query: string) => void;
  onFilter?: () => void;
}

export const SearchBar = ({ onSearch, onFilter }: SearchBarProps) => {
  const t = useTranslations('search');
  const pathname = usePathname(); // 👈 TU LÍNEA 1
  const dispatch = useAppDispatch();
  const { findMatchingJobType, findMatchingCity } = useJobTypeAutoMatch();

  const searchFromStore = useAppSelector((state) => state.jobOfert.search);
  const filtersFromStore = useAppSelector((state) => state.jobOfert.filters);

  const [value, setValue] = React.useState('');
  const [error, setError] = React.useState<string | undefined>();
  const [isOpen, setIsOpen] = React.useState(false);
  const [highlighted, setHighlighted] = React.useState<number>(-1);
  const [longPressedItem, setLongPressedItem] = React.useState<string | null>(null);
  const [previewValue, setPreviewValue] = React.useState<string | null>(null);

  const containerRef = React.useRef<HTMLDivElement | null>(null);
  const inputRef = React.useRef<HTMLInputElement | null>(null);

  useEffect(() => {
    if (value !== '') {
      const { isValid, error } = validateSearch(value);
      setError(isValid ? undefined : error);
    }
  }, [value]);

  const prevSearchFromStore = React.useRef(searchFromStore);

  // 👇 TU BLOQUE COMPLETO (LÍNEAS 2-6)
  const currentLanguage = React.useMemo(() => {
    const pathSegments = (pathname || '').split('/').filter(Boolean);
    const langSegment = pathSegments[0];
    return ['en', 'es'].includes(langSegment) ? langSegment : 'es';
  }, [pathname]);

  // Hooks personalizados
  const { history, addToHistory, removeFromHistory, clearHistory } = useSearchHistory({
    useBackend: true,
  });

  const { suggestions } = useSearchSuggestions(value, {
    enabled: value.trim().length > 0,
    minLength: 1,
    debounceMs: 300,
    maxResults: 6,
    language: currentLanguage, // 👈 TU LÍNEA 7 (única modificación en su código)
  });

  // Restaurar desde Redux/localStorage al cargar
  React.useEffect(() => {
    if (searchFromStore) {
      setValue(searchFromStore);
    }
  }, [searchFromStore]);

  // Sincronizar con Redux
  React.useEffect(() => {
    if (searchFromStore !== prevSearchFromStore.current && searchFromStore !== value) {
      setValue(searchFromStore);
      setError(undefined);
      prevSearchFromStore.current = searchFromStore;
    }
  }, [searchFromStore, value]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const newValue = e.target.value;
    if (newValue.length >= 100) {
      // asegura que no pase de 100
      const trimmed = newValue.slice(0, 100);
      setPreviewValue(null);
      setValue(trimmed);
      setError('Límite máximo de 100 caracteres.');
      return;
    }
    setValue(newValue);
    setPreviewValue(null);
    // Abrir el dropdown al escribir para que las sugerencias vuelvan a mostrarse
    setIsOpen(true);
    const { isValid, error } = validateSearch(newValue);
    setError(isValid ? undefined : error);
    setHighlighted(-1);
  };

  const handleClear = () => {
    setValue('');
    setError(undefined);
    onSearch('');
    // Limpia el automarcado del filtro cuando se borra la búsqueda
    if (filtersFromStore.isAutoSelectedCategory || filtersFromStore.isAutoSelectedCity) {
      dispatch(
        setFilters({
          ...filtersFromStore,
          category: filtersFromStore.isAutoSelectedCategory ? [] : filtersFromStore.category,
          city: filtersFromStore.isAutoSelectedCity ? [] : filtersFromStore.city,
          isAutoSelectedCategory: false,
          isAutoSelectedCity: false,
        }),
      );
    }
  };

  /**
   * Auto-detecta si la búsqueda coincide con un tipo de trabajo o ciudad
   * y auto-selecciona los filtros correspondientes
   */
  const applyAutoFilterIfMatch = (searchQuery: string) => {
    const matchedJobType = findMatchingJobType(searchQuery);
    const matchedCity = findMatchingCity(searchQuery);
    const newFilters = { ...filtersFromStore };

    if (matchedJobType) {
      newFilters.category = [matchedJobType];
      newFilters.isAutoSelectedCategory = true;
    } else {
      if (
        filtersFromStore.isAutoSelectedCategory &&
        filtersFromStore.category.length === 1 &&
        filtersFromStore.range.length === 0 &&
        filtersFromStore.city.length === 0
      ) {
        newFilters.category = [];
        newFilters.isAutoSelectedCategory = false;
      }
    }

    if (matchedCity) {
      newFilters.city = [matchedCity];
      newFilters.isAutoSelectedCity = true;
    } else {
      if (filtersFromStore.isAutoSelectedCity && filtersFromStore.city.length > 0) {
        newFilters.city = [];
        newFilters.isAutoSelectedCity = false;
      }
    }

    dispatch(setFilters(newFilters));
  };

  const selectItem = (item: string) => {
    setValue(item);
    applyAutoFilterIfMatch(item);
    onSearch(item);
    addToHistory(item);
    setIsOpen(false);
    setHighlighted(-1);
    setPreviewValue(null);
  };

  const previewItem = (item: string) => {
    setValue(item);
    setError(undefined);
    setIsOpen(true);
    setHighlighted(-1);
    inputRef.current?.focus();
  };

  const handleSearch = () => {
    const { isValid, error, data } = validateSearch(value);
    if (!isValid) {
      setError(error);
      return;
    }
    const query = data!;
    applyAutoFilterIfMatch(query);
    onSearch(query);
    addToHistory(query);
    setIsOpen(false);
    setPreviewValue(null);
  };

  // Filtrar historial visible (CORREGIDO: usar useMemo)
  const visibleHistory = React.useMemo(() => {
    const q = value.trim().toLowerCase();
    if (q.length === 0) {
      return history.slice(0, 5);
    }
    return history.filter((h) => h.toLowerCase().includes(q)).slice(0, 5);
  }, [history, value]);

  // Filtrar sugerencias visibles (CORREGIDO: usar useMemo)
  const visibleSuggestions = React.useMemo(() => {
    return suggestions.slice(0, 5);
  }, [suggestions]);

  // Combinar arrays (CORREGIDO: usar useMemo)
  const visibleCombined = React.useMemo(() => {
    return [...visibleHistory, ...visibleSuggestions];
  }, [visibleHistory, visibleSuggestions]);

  // Hook de teclado
  const { handleKeyDown: handleKeyDownBase } = useSearchKeyboard({
    isOpen,
    highlighted,
    combinedItems: visibleCombined,
    onSelect: selectItem,
    onSearch: handleSearch,
    onClose: () => {
      setIsOpen(false);
      setHighlighted(-1);
      setPreviewValue(null);
    },
    setHighlighted,
    setPreviewValue,
    enablePreview: typeof window !== 'undefined' && window.innerWidth >= 640,
  });

  // Hook de touch
  const { handleTouchStart, handleTouchEnd, handlePointerDown, handlePointerUp } = useSearchTouch(
    (item) => setLongPressedItem(item),
    600,
  );

  // Click fuera para cerrar
  React.useEffect(() => {
    const onDocClick = (ev: MouseEvent) => {
      if (!containerRef.current) return;
      if (ev.target instanceof Node && !containerRef.current.contains(ev.target)) {
        setIsOpen(false);
        setHighlighted(-1);
      }
    };
    document.addEventListener('mousedown', onDocClick);
    return () => document.removeEventListener('mousedown', onDocClick);
  }, []);

  const hasError = !!error;
  const inputClasses = `pl-10 ${value.length > 0 ? 'pr-10' : 'pr-9'} w-full sm:min-w-80 rounded overflow-hidden text-ellipsis ${
    hasError ? 'border-red-500 border-[1.5px] outline-none shadow-[0_0_0_1px_red]' : ''
  }`;

  return (
    <div className='w-full' ref={containerRef}>
      <div className='flex flex-row w-full items-center gap-2'>
        <div className='relative flex-1 min-w-0 self-center'>
          <SearchIcon hasError={hasError} />
          <Input
            type='text'
            placeholder={t('placeholder')}
            className={inputClasses}
            value={previewValue ?? value}
            onChange={handleChange}
            maxLength={100}
            ref={(el) => {
              inputRef.current = el as HTMLInputElement | null;
            }}
            onKeyDown={handleKeyDownBase}
            onFocus={() => setIsOpen(true)}
          />
          {value.length > 0 && <ClearButton onClick={handleClear} />}

          <SearchDropdown
            isOpen={isOpen}
            history={visibleHistory}
            suggestions={visibleSuggestions}
            highlighted={highlighted}
            longPressedItem={longPressedItem}
            query={value}
            onSelectItem={selectItem}
            onPreviewItem={previewItem}
            onDeleteItem={removeFromHistory}
            onClearHistory={async () => {
              await clearHistory();
              setIsOpen(true);
            }}
            onHighlight={setHighlighted}
            onLongPressStart={(item) => {
              const handler = handleTouchStart(item);
              handler();
              const pointerHandler = handlePointerDown(item);
              return pointerHandler;
            }}
            onLongPressEnd={() => {
              handleTouchEnd();
              handlePointerUp();
            }}
            onCancelDelete={() => setLongPressedItem(null)}
          />
        </div>

        <div className='flex gap-2 items-center shrink-0'>
          <SearchButton onClick={handleSearch} />
          <AdvancedSearchButton />
          {onFilter && <FilterButton onClick={onFilter} />}
        </div>
      </div>
      <div className='min-h-5 mt-1'>
        {hasError && <p className='text-red-500 text-sm leading-4'>{error}</p>}
      </div>
    </div>
  );
};
</file>

<file path="src/Components/Job-offers/Search/SearchButton.tsx">
'use client';

import { Button } from '@/Components/ui/button';
import React from 'react';
import { useTranslations } from 'next-intl';

export function SearchButton(props: React.ButtonHTMLAttributes<HTMLButtonElement>) {
  const t = useTranslations('search');
  const { disabled, ...rest } = props;

  return (
    <Button
      size='lg'
      className={`
        bg-[#2B6AE0] text-white
        ${disabled ? 'opacity-70 cursor-not-allowed' : 'hover:bg-[#2B6AE0]/90'}
        shrink-0
        px-3 sm:px-6 
        py-2 sm:py-5
        text-sm sm:text-base 
        font-semibold 
        rounded 
        shadow
        transition-all duration-200
      `}
      disabled={disabled}
      {...rest}
    >
      {t('buttonSearch')}
    </Button>
  );
}
</file>

<file path="src/Components/Job-offers/Search/SearchIcon.tsx">
import { Search } from 'lucide-react';
import React from 'react';

interface SearchIconProps {
  hasError?: boolean;
  className?: string;
}

export const SearchIcon = ({ hasError = false, className = '' }: SearchIconProps) => (
  <span className={`absolute left-2 top-1/2 -translate-y-1/2 z-[2] flex items-center ${className}`}>
    <Search size={20} color={hasError ? 'red' : '#888'} />
  </span>
);
</file>

<file path="src/Components/Job-offers/Sort/SortCard.tsx">
'use client';

import { Button } from '@/Components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/Components/ui/dropdown-menu';
import React from 'react';
import { ChevronDown } from 'lucide-react';
import { useTranslations } from 'next-intl';
import { SORT_OPTIONS } from '@/app/lib/constants/sortOptions';

interface SortCardProps {
  value: string; // Valor del backend: 'rating', 'recent', etc.
  onSelect: (backendValue: string) => void;
}

export default function SortCard({ value, onSelect }: SortCardProps) {
  const t = useTranslations();

  // Opciones con valor backend y label traducido
  const sortOptions = [
    { value: SORT_OPTIONS.DESTACADOS, label: t('sortBy.featured') },
    { value: SORT_OPTIONS.RECIENTES, label: t('sortBy.mostRecent') },
    { value: SORT_OPTIONS.ANTIGUOS, label: t('sortBy.oldest') },
    { value: SORT_OPTIONS.NOMBRE_ASC, label: t('sortBy.nameAZ') },
    { value: SORT_OPTIONS.NOMBRE_DESC, label: t('sortBy.nameZA') },
    { value: SORT_OPTIONS.CONTACTO_ASC, label: t('sortBy.contactAsc') },
    { value: SORT_OPTIONS.CONTACTO_DESC, label: t('sortBy.contactDesc') },
  ];

  // Obtener el label traducido del valor actual
  const currentLabel =
    sortOptions.find((opt) => opt.value === value)?.label || t('sortBy.mostRecent');

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button
          variant='outline'
          className='flex font-bold items-center gap-2
          !bg-[#2B6AE0] !text-white !transition-colors hover:!bg-[#2B6AE0]/90
            !shadow-md
            focus-visible:!ring-0 focus-visible:!ring-offset-0
            py-5'
        >
          {currentLabel}
          <ChevronDown className='h-4 w-4' />
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent
        align='start'
        className='!bg-white !border-black !shadow-md !rounded-lg z-70'
      >
        {sortOptions.map((option) => (
          <DropdownMenuItem
            key={option.value}
            onClick={() => onSelect(option.value)} // Envía valor backend
            className={`cursor-pointer !px-3 !py-2 !rounded-md !transition-colors ${
              value === option.value // Comparación correcta con valor backend
                ? '!bg-[#2B6AE0] !text-white'
                : 'hover:!bg-[#1AA7ED] hover:!text-white'
            }`}
          >
            {option.label}
          </DropdownMenuItem>
        ))}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
</file>

<file path="src/Components/Job-offers/ViewModeToggle.tsx">
// src/Components/Job-offers/ViewModeToggle.tsx
'use client';

import React from 'react';
import { Map, List, LayoutGrid } from 'lucide-react';
import { useTranslations } from 'next-intl';
import type { ViewMode } from './JobOffersView';

interface ViewModeToggleProps {
  viewMode: ViewMode;
  onChange: (mode: ViewMode) => void;
  variant?: 'mobile' | 'desktop';
  className?: string;
}

export const ViewModeToggle: React.FC<ViewModeToggleProps> = ({
  viewMode,
  onChange,
  variant = 'desktop',
  className = '',
}) => {
  const t = useTranslations('jobOffers');

  if (variant === 'mobile') {
    return (
      <div
        className={`flex gap-1 bg-gray-50 border border-gray-200 rounded-lg p-1 shadow-sm ${className}`}
      >
        <button
          onClick={() => onChange('grid')}
          className={`p-2 rounded-md transition-all duration-200 ${
            viewMode === 'grid'
              ? 'bg-primary text-white shadow-md'
              : 'bg-white text-gray-600 hover:bg-gray-100'
          }`}
          title={t('viewModes.grid', { default: 'Vista cuadrícula' })}
        >
          <LayoutGrid className='w-5 h-5' />
        </button>
        <button
          onClick={() => onChange('map')}
          className={`p-2 rounded-md transition-all duration-200 ${
            viewMode === 'map'
              ? 'bg-primary text-white shadow-md'
              : 'bg-white text-gray-600 hover:bg-gray-100'
          }`}
          title={t('viewModes.map')}
        >
          <Map className='w-5 h-5' />
        </button>
      </div>
    );
  }

  return (
    <div
      className={`flex gap-2 bg-gray-50 border border-gray-200 rounded-xl p-1.5 shadow-sm ${className}`}
    >
      <button
        onClick={() => onChange('grid')}
        className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all duration-200 ${
          viewMode === 'grid'
            ? 'bg-primary text-white shadow-md scale-105'
            : 'bg-white text-gray-600 hover:bg-gray-100 hover:shadow-sm'
        }`}
        title={t('viewModes.grid', { default: 'Vista cuadrícula' })}
      >
        <LayoutGrid className='w-4 h-4' />
        <span className='text-sm'>{t('viewModes.grid', { default: 'Cuadrícula' })}</span>
      </button>
      <button
        onClick={() => onChange('list')}
        className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all duration-200 ${
          viewMode === 'list'
            ? 'bg-primary text-white shadow-md scale-105'
            : 'bg-white text-gray-600 hover:bg-gray-100 hover:shadow-sm'
        }`}
        title={t('viewModes.list')}
      >
        <List className='w-4 h-4' />
        <span className='text-sm'>{t('viewModes.list')}</span>
      </button>
      <button
        onClick={() => onChange('map')}
        className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all duration-200 ${
          viewMode === 'map'
            ? 'bg-primary text-white shadow-md scale-105'
            : 'bg-white text-gray-600 hover:bg-gray-100 hover:shadow-sm'
        }`}
        title={t('viewModes.map')}
      >
        <Map className='w-4 h-4' />
        <span className='text-sm'>{t('viewModes.map')}</span>
      </button>
    </div>
  );
};
</file>

<file path="src/Components/JobFixerSection.tsx">
'use client';

import { Fixer } from '@/hooks/useFixersByJob';
import { useAppDispatch, useAppSelector } from '@/app/redux/hooks';
import { toggleJobExpanded, selectExpandedJobs } from '@/app/redux/slice/fixersByJobSlice';
import { ChevronDown } from 'lucide-react';
import { FixerCard } from './FixerCard';
//import { useTranslations } from "next-intl"

interface JobFixerSectionProps {
  jobType: string;
  fixers: Fixer[];
  matchCount: number;
}

export function JobFixerSection({ jobType, fixers, matchCount }: JobFixerSectionProps) {
  //const t = useTranslations("Fixers Por Trabajo")
  const dispatch = useAppDispatch();
  const expandedJobs = useAppSelector(selectExpandedJobs);
  const isExpanded = expandedJobs.includes(jobType);

  const formatJobType = (type: string) => {
    const customLabels: Record<string, string> = {
      'svc-plumbing': 'Plomería',
      'svc-electricity': 'Electricidad',
      'svc-carpentry': 'Carpintería',
      'svc-painting': 'Pintura',
      'svc-masonry': 'Albañilería',
      'svc-gardening': 'Jardinería',
      'svc-cleaning': 'Limpieza',
    };

    if (customLabels[type]) return customLabels[type];

    const normalized = type.replace(/^svc-/, '').replace(/-/g, ' ');
    return normalized.charAt(0).toUpperCase() + normalized.slice(1);
  };

  return (
    <div className='border border-gray-200 rounded-lg overflow-hidden bg-white'>
      <button
        onClick={() => dispatch(toggleJobExpanded(jobType))}
        className='w-full px-6 py-4 flex items-center justify-between bg-gradient-to-r from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-150 transition-colors'
      >
        <div className='flex items-center gap-2'>
          <h3 className='text-lg font-semibold text-gray-800'>{formatJobType(jobType)}</h3>
          <span className='text-sm font-medium text-blue-600 bg-blue-50 px-3 py-1 rounded-full'>
            ({matchCount})
          </span>
        </div>
        <ChevronDown
          className={`w-5 h-5 text-gray-600 transition-transform duration-300 ${
            isExpanded ? 'rotate-180' : ''
          }`}
        />
      </button>

      {isExpanded && (
        <div className='p-6 space-y-4 animate-fade-in'>
          {fixers.length > 0 ? (
            fixers.map((fixer) => <FixerCard key={fixer.id} fixer={fixer} />)
          ) : (
            <p className='text-center text-gray-500 py-8'>No hay resultados</p>
          )}
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/Components/list/DatePicker/DatePicker.tsx">
'use client';
import React, { useState, useEffect } from 'react';

interface DatePickerProps {
  selectedDate: Date;
  onDateChange?: (newDate: Date) => void;
}

export default function DatePicker({ selectedDate, onDateChange }: DatePickerProps) {
  // Usa strings para permitir valores vacíos temporalmente
  const [day, setDay] = useState<string>(selectedDate.getDate().toString());
  const [month, setMonth] = useState<string>((selectedDate.getMonth() + 1).toString());
  const [year, setYear] = useState<string>(selectedDate.getFullYear().toString());
  const [isFocused, setIsFocused] = useState(false);

  useEffect(() => {
    setDay(selectedDate.getDate().toString());
    setMonth((selectedDate.getMonth() + 1).toString());
    setYear(selectedDate.getFullYear().toString());
  }, [selectedDate]);

  const getDaysInMonth = (month: number, year: number) => {
    return new Date(year, month, 0).getDate();
  };

  const notifyDateChange = (newDay: number, newMonth: number, newYear: number) => {
    if (onDateChange) {
      const newDate = new Date(newYear, newMonth - 1, newDay, 12, 0, 0);
      onDateChange(newDate);
    }
  };

  const handleDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setDay(value); // Permite vacío temporalmente

    const newDay = parseInt(value);
    if (isNaN(newDay) || value === '') return; // No notifica si está vacío

    const monthNum = parseInt(month);
    const yearNum = parseInt(year);
    if (isNaN(monthNum) || isNaN(yearNum)) return;

    const maxDays = getDaysInMonth(monthNum, yearNum);
    const validDay = newDay > maxDays ? maxDays : newDay;
    notifyDateChange(validDay, monthNum, yearNum);
  };

  const handleMonthChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setMonth(value); // Permite vacío temporalmente

    const newMonth = parseInt(value);
    if (isNaN(newMonth) || value === '') return; // No notifica si está vacío

    const dayNum = parseInt(day);
    const yearNum = parseInt(year);
    if (isNaN(dayNum) || isNaN(yearNum)) return;

    const maxDays = getDaysInMonth(newMonth, yearNum);
    const validDay = dayNum > maxDays ? maxDays : dayNum;
    if (dayNum > maxDays) {
      setDay(validDay.toString());
    }
    notifyDateChange(validDay, newMonth, yearNum);
  };

  const handleYearChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setYear(value); // Permite vacío temporalmente

    const newYear = parseInt(value);
    if (isNaN(newYear) || value === '') return; // No notifica si está vacío

    const dayNum = parseInt(day);
    const monthNum = parseInt(month);
    if (isNaN(dayNum) || isNaN(monthNum)) return;

    notifyDateChange(dayNum, monthNum, newYear);
  };

  // Validar al perder el foco (blur) para asegurar valores válidos
  const handleDayBlur = () => {
    const dayNum = parseInt(day);
    if (isNaN(dayNum) || day === '') {
      setDay(selectedDate.getDate().toString()); // Restaura valor original
    }
  };

  const handleMonthBlur = () => {
    const monthNum = parseInt(month);
    if (isNaN(monthNum) || month === '') {
      setMonth((selectedDate.getMonth() + 1).toString()); // Restaura valor original
    }
  };

  const handleYearBlur = () => {
    const yearNum = parseInt(year);
    if (isNaN(yearNum) || year === '') {
      setYear(selectedDate.getFullYear().toString()); // Restaura valor original
    }
  };

  return (
    <div
      tabIndex={0}
      onFocus={() => setIsFocused(true)}
      onBlur={() => setIsFocused(false)}
      onClick={() => setIsFocused(true)}
      className={`flex items-center justify-center bg-white text-gray-800 rounded-xl shadow-sm px-3 py-2 border transition-all duration-200 w-fit cursor-text
                ${isFocused ? 'border-blue-500 ring-2 ring-blue-300 shadow-md' : 'border-gray-200 hover:shadow-md'}
            `}
    >
      <input
        className='w-10 text-center font-medium text-xl focus:outline-none bg-transparent'
        type='text'
        value={day}
        onChange={handleDateChange}
        onBlur={handleDayBlur}
        placeholder='DD'
        onFocus={() => setIsFocused(true)}
      />
      <span className='text-gray-400 text-2xl mx-1'>/</span>
      <input
        className='w-10 text-center font-medium text-xl focus:outline-none bg-transparent'
        type='text'
        value={month}
        onChange={handleMonthChange}
        onBlur={handleMonthBlur}
        placeholder='MM'
        onFocus={() => setIsFocused(true)}
      />
      <span className='text-gray-400 text-2xl mx-1'>/</span>
      <input
        className='w-14 text-center font-medium text-xl focus:outline-none bg-transparent'
        type='text'
        value={year}
        onChange={handleYearChange}
        onBlur={handleYearBlur}
        placeholder='YYYY'
        onFocus={() => setIsFocused(true)}
      />
    </div>
  );
}
</file>

<file path="src/Components/list/MobileList.tsx">
'use client';

import { useState } from 'react';
import DaySchedule from '../calendar/mobile/MobileDayliView';
import WeekSchedule from '../calendar/mobile/MobileWeekView';

interface MobileListProps {
  selectedDate: Date;
  fixerId: string;
  requesterId: string;
  onDateChange: (newDate: Date) => void;
}

export default function MobileList({
  selectedDate,
  fixerId,
  requesterId,
  onDateChange,
}: MobileListProps) {
  const [type, setType] = useState<'day' | 'week'>('day');

  return (
    <div>
      <div className='flex flex-col bg-gray-200 rounded-full p-1 w-fit mx-auto cursor-pointer'>
        <div>
          <button
            onClick={() => setType('day')}
            className={`px-4 py-1 rounded-full text-base font-semibold transition-colors duration-200 ${
              type === 'day' ? 'bg-primary text-white' : 'text-gray-700 hover:text-blue-600'
            }`}
          >
            Horario del día
          </button>
          <button
            onClick={() => setType('week')}
            className={`px-4 py-1 rounded-full text-base font-semibold transition-colors duration-200 ${
              type === 'week' ? 'bg-blue-600 text-white' : 'text-gray-700 hover:text-blue-600'
            }`}
          >
            Horario de la semana
          </button>
        </div>
      </div>

      <div className='mt-4'>
        {type === 'day' && (
          <DaySchedule
            fixerId={fixerId}
            requesterId={requesterId}
            selectedDate={selectedDate}
            onDateChange={onDateChange}
          />
        )}
      </div>

      <div className='mt-4'>
        {type === 'week' && (
          <WeekSchedule
            fixerId={fixerId}
            requesterId={requesterId}
            selectedDate={selectedDate}
            onChangeDate={onDateChange}
          />
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/Components/login/ClientResend.tsx">
'use client';

import { useEffect, useMemo, useState } from 'react';
import { z } from 'zod';
import Link from 'next/link';

const BASE_API = `${process.env.NEXT_PUBLIC_API_URL}/api/controlC`;

const RESEND_COOLDOWN_MS = 60_000; // 1 minuto
const LINK_VALIDITY_SEC = 5 * 60; // contador visible de 5 minutos

// 🔹 Esquema Zod para la respuesta de la API
const resendResponseSchema = z.object({
  success: z.boolean(),
  message: z.string().optional(),
});

export default function ClientResend({ email: emailProp }: { email?: string; token?: string }) {
  // Email: preferir prop; si no hay recuperar de sessionStorage
  const [email, setEmail] = useState<string | undefined>(emailProp);
  useEffect(() => {
    if (!emailProp && typeof window !== 'undefined') {
      const s = sessionStorage.getItem('servineo_last_email');
      if (s) setEmail(s);
    }
  }, [emailProp]);

  // Estado UI
  const [info, setInfo] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  // Contador visual (5 min)
  const [countdown, setCountdown] = useState<number>(LINK_VALIDITY_SEC);
  useEffect(() => {
    const t = setInterval(() => setCountdown((c) => (c <= 0 ? 0 : c - 1)), 1000);
    return () => clearInterval(t);
  }, []);
  const minutos = useMemo(() => Math.floor(countdown / 60), [countdown]);
  const segundos = useMemo(() => countdown % 60, [countdown]);

  // Cooldown de reenvio basado en localStorage por correo
  const [now, setNow] = useState<number>(() => Date.now());
  useEffect(() => {
    const t = setInterval(() => setNow(Date.now()), 1000);
    return () => clearInterval(t);
  }, []);

  const lastKey = email ? `servineo_last_request_${email}` : undefined;

  const lastTs = useMemo(() => {
    if (typeof window === 'undefined' || !lastKey) return undefined;
    const raw = localStorage.getItem(lastKey);
    return raw ? Number(raw) : undefined;
  }, [lastKey]); // <--- quitar now

  const msFromLast = lastTs ? now - lastTs : Infinity;
  const canResend = msFromLast >= RESEND_COOLDOWN_MS;
  const secondsToResend = Math.max(0, Math.ceil((RESEND_COOLDOWN_MS - (msFromLast || 0)) / 1000));

  // Acción de reenvío
  const handleResend = async () => {
    setInfo(null);

    if (!email) {
      setInfo('No se encontró el correo. Vuelve a la pantalla anterior.');
      return;
    }
    if (!canResend) {
      setInfo(`Espera ${secondsToResend}s para volver a reenviar.`);
      return;
    }

    setLoading(true);
    const fallback = setTimeout(() => setInfo('Estamos tardando más de lo normal…'), 3000);

    try {
      const res = await fetch(`${BASE_API}/auth/forgot-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });
      const data = await res.json();

      // 🔹 Validación con Zod
      const parsed = resendResponseSchema.safeParse(data);
      if (!parsed.success) {
        console.error('Respuesta inválida del backend:', parsed.error);
        setInfo('Respuesta inesperada del servidor.');
        return;
      }

      const { success, message } = parsed.data;

      if (res.ok && success) {
        if (typeof window !== 'undefined' && lastKey) {
          localStorage.setItem(lastKey, String(Date.now()));
        }
        setInfo('Enlace reenviado. Revisa tu bandeja de entrada.');
        setCountdown(LINK_VALIDITY_SEC); // reinicia contador visual del enlace
      } else if (res.status === 429) {
        setInfo('Ya existe una solicitud en curso. Intenta nuevamente en 1 minuto.');
        if (typeof window !== 'undefined' && lastKey && !lastTs) {
          localStorage.setItem(lastKey, String(Date.now()));
        }
      } else if (res.status === 404) {
        setInfo('El correo no está asociado a ninguna cuenta.');
      } else {
        setInfo(message || 'No se pudo reenviar el enlace.');
      }
    } catch {
      setInfo('Error de conexión con el servidor.');
    } finally {
      clearTimeout(fallback);
      setLoading(false);
      setNow(Date.now()); // fuerza recalculo inmediato
    }
  };

  return (
    <div className='p-8'>
      <p className='text-sm text-muted-foreground'>
        Te enviamos un enlace para ingresar sin contraseña. Por seguridad, el enlace caduca en
        <span className='font-medium'> 5 minutos</span>.
      </p>

      <div className='mt-5 flex flex-col items-center gap-2' aria-live='polite'>
        <p className='text-sm text-muted-foreground'>Tiempo restante para usar el enlace:</p>
        <div
          className='px-6 py-2 rounded-full bg-muted ring-1 ring-border text-3xl font-semibold text-foreground tracking-widest tabular-nums shadow-sm'
          title='Tiempo restante'
        >
          {String(minutos).padStart(2, '0')}:{String(segundos).padStart(2, '0')}
        </div>
      </div>

      {info && (
        <div
          role='status'
          aria-live='polite'
          className='mt-4 rounded-xl bg-accent/20 border border-accent/40 text-foreground p-3 text-sm'
        >
          {info}
        </div>
      )}

      <div className='mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3'>
        <button
          onClick={handleResend}
          disabled={loading || !email}
          className={`rounded-xl p-3.5 font-semibold transition
            ${
              loading || !email
                ? 'bg-primary/30 text-primary-foreground/70 cursor-not-allowed shadow-none'
                : 'bg-primary hover:bg-primary/90 text-primary-foreground shadow-sm hover:shadow'
            }`}
          title={!canResend ? `Podrás reenviar en ${secondsToResend}s` : 'Reenviar enlace'}
        >
          {loading ? 'Reenviando…' : !canResend ? `Espera ${secondsToResend}s` : 'Reenviar enlace'}
        </button>

        <Link
          href='/login'
          className='text-center rounded-xl p-3.5 font-semibold transition
                     bg-background text-foreground ring-1 ring-border hover:bg-muted'
        >
          Volver a inicio de sesión
        </Link>
      </div>

      <div className='mt-6 text-xs text-muted-foreground space-y-1'>
        <p>
          • Revisa la carpeta de <span className='font-medium'>Spam</span> o{' '}
          <span className='font-medium'>Promociones</span> si no ves el correo.
        </p>
        <p>
          • Al generar un nuevo enlace, los anteriores quedan{' '}
          <span className='font-medium'>inválidos</span>.
        </p>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/login/ClientVerify.tsx">
'use client';

import { useEffect, useState } from 'react';

const BASE_API = `${process.env.NEXT_PUBLIC_API_URL}/api/controlC`;

export default function ClientVerify({ token }: { token?: string }) {
  const [msg, setMsg] = useState('Verificando enlace de acceso...');

  useEffect(() => {
    if (!token) {
      setMsg('Token no proporcionado.');
      return;
    }

    let cancelled = false;

    const verifyLink = async () => {
      try {
        const res = await fetch(`${BASE_API}/auth/magic-login?token=${encodeURIComponent(token)}`);
        const data = await res.json();
        if (cancelled) return;

        if (res.ok && data.success && data.token) {
          localStorage.setItem('servineo_token', data.token);
          localStorage.setItem('servineo_user', JSON.stringify(data.user));
          window.location.replace('/'); // hidratar UI logueado
        } else if (res.status === 410) {
          setMsg('El enlace ha expirado. Serás redirigido a la pantalla de recuperación.');
          setTimeout(() => window.location.replace('/login/forgotpass'), 2500);
        } else if (res.status === 400) {
          setMsg('El enlace ya fue utilizado.');
          setTimeout(() => window.location.replace('/login/forgotpass'), 2500);
        } else {
          setMsg(data.message || 'Error verificando enlace. Intenta nuevamente.');
          setTimeout(() => window.location.replace('/login/forgotpass'), 2500);
        }
      } catch (err) {
        console.error('Error al verificar enlace:', err);
        setMsg('Error de conexión con el servidor.');
        setTimeout(() => window.location.replace('/login/forgotpass'), 2500);
      }
    };

    verifyLink();
    return () => {
      cancelled = true;
    };
  }, [token]);

  return (
    <p role='status' aria-live='polite' className='text-gray-700'>
      {msg}
    </p>
  );
}
</file>

<file path="src/Components/login/google/layout.tsx">
'use client';

import { GoogleOAuthProvider } from '@react-oauth/google';

export default function LoginLayout({ children }: { children: React.ReactNode }) {
  console.log('Google Client ID cargado:', process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID);

  return (
    <GoogleOAuthProvider clientId={process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID!}>
      {children}
    </GoogleOAuthProvider>
  );
}
</file>

<file path="src/Components/login/google/LoginGoogle.tsx">
'use client';

import { useState } from 'react';
import { GoogleLogin, CredentialResponse } from '@react-oauth/google';
import { api, ApiResponse } from '../../../app/redux/services/loginApi';

interface LoginGoogleProps {
  onMensajeChange: (mensaje: string, tipo: 'error') => void;
}

interface GoogleLoginResponse {
  token: string;
  user: {
    id: string | number;
    name: string;
    email: string;
    picture?: string;
  };
  message?: string;
}

export default function LoginGoogle({ onMensajeChange }: LoginGoogleProps) {
  const [loading, setLoading] = useState(false);

  const handleSuccess = async (credentialResponse: CredentialResponse) => {
    setLoading(true);

    try {
      const res: ApiResponse<GoogleLoginResponse> = await api.post('/auth/google', {
        credential: credentialResponse.credential,
        token: credentialResponse.credential,
        modo: 'login',
      });

      if (res.success && res.data) {
        localStorage.setItem('servineo_token', res.data.token);
        localStorage.setItem('servineo_user', JSON.stringify(res.data.user));
        window.location.href = '/';
      } else {
        const mensajeError =
          res.message ||
          res.data?.message ||
          res.error ||
          'Error desconocido al iniciar sesión con Google.';
        onMensajeChange(mensajeError, 'error');
      }
    } catch (err: unknown) {
      if (err instanceof Error) {
        onMensajeChange(err.message, 'error');
      } else {
        onMensajeChange('No se pudo conectar con el servidor.', 'error');
      }
    } finally {
      setLoading(false);
    }
  };

  const handleError = () => {
    onMensajeChange('Error al iniciar sesión con Google.', 'error');
  };

  return (
    <div className="flex flex-col items-center gap-2">
      <div className="w-full flex justify-center">
        <GoogleLogin onSuccess={handleSuccess} onError={handleError} />
      </div>

      {loading && (
        <p className="text-sm text-gray-500 mt-2 animate-pulse">Verificando credenciales...</p>
      )}
    </div>
  );
}
</file>

<file path="src/Components/login/Proveedores/layout.tsx">
'use client';

import { GoogleOAuthProvider } from '@react-oauth/google';

export default function LoginLayout({ children }: { children: React.ReactNode }) {
  console.log('Google Client ID cargado:', process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID);

  return (
    <GoogleOAuthProvider clientId={process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID!}>
      {children}
    </GoogleOAuthProvider>
  );
}
</file>

<file path="src/Components/login/Proveedores/LoginDiscord.tsx">
'use client';

import React from 'react';
import { FaDiscord } from 'react-icons/fa';

interface Props {
  onMensajeChange: (mensaje: string) => void;
}

const LoginDiscord: React.FC<Props> = ({ onMensajeChange }) => {
  const handleDiscordClick = () => {
    try {
      const clientId = process.env.NEXT_PUBLIC_DISCORD_CLIENT_ID;
      if (!clientId) {
        onMensajeChange('Falta configurar NEXT_PUBLIC_DISCORD_CLIENT_ID.');
        return;
      }

      const redirectUri = `${window.location.origin}/login?provider=discord`;
      const scope = 'identify email';

      const discordUrl =
        `https://discord.com/api/oauth2/authorize` +
        `?client_id=${encodeURIComponent(clientId)}` +
        `&redirect_uri=${encodeURIComponent(redirectUri)}` +
        `&response_type=code` +
        `&scope=${encodeURIComponent(scope)}`;

      window.location.href = discordUrl;
    } catch (error) {
      console.error(error);
      onMensajeChange('No se pudo iniciar el login con Discord.');
    }
  };

  return (
    <div className='w-full flex justify-center'>
      <button
        type='button'
        onClick={handleDiscordClick}
        className='inline-flex items-center justify-center gap-3
                   bg-[#5865F2] text-white rounded-xl
                   px-4 py-3 text-base font-medium
                   hover:bg-[#4752C4] transition shadow-sm'
      >
        <FaDiscord className='text-xl' />
        <span>Continuar con Discord</span>
      </button>
    </div>
  );
};

export default LoginDiscord;
</file>

<file path="src/Components/login/Proveedores/LoginGitHub.tsx">
// Components/login/Proveedores/LoginGitHub.tsx
'use client';

import React from 'react';
import { FaGithub } from 'react-icons/fa';

interface Props {
  onMensajeChange: (mensaje: string) => void;
}

const LoginGithub: React.FC<Props> = ({ onMensajeChange }) => {
  const handleGithubClick = () => {
    try {
      const baseUrl = process.env.NEXT_PUBLIC_API_URL; // ej: http://localhost:8000
      if (!baseUrl) {
        onMensajeChange('Falta configurar NEXT_PUBLIC_API_URL para GitHub.');
        return;
      }

      // 👇 Armamos el state como JSON, tal y como espera tu githubAuth
      const stateObj = { mode: 'login-only' };
      const state = encodeURIComponent(JSON.stringify(stateObj));

      const authUrl = `${baseUrl}/auth/github?state=${state}`;

      // 🔹 Abrimos en popup (para que githubAuth pueda usar window.opener.postMessage)
      window.open(authUrl, 'github_oauth', 'width=600,height=700,menubar=no,toolbar=no');
    } catch (error) {
      console.error(error);
      onMensajeChange('No se pudo iniciar el login con GitHub.');
    }
  };

  return (
    <div className='w-full flex justify-center'>
      <button
        type='button'
        onClick={handleGithubClick}
        className='inline-flex items-center justify-center gap-3
                   bg-white border border-gray-300 rounded-xl
                   px-4 py-3 text-base font-medium
                   hover:bg-gray-100 transition shadow-sm'
      >
        <FaGithub className='text-xl' />
        <span>Continuar con GitHub</span>
      </button>
    </div>
  );
};

export default LoginGithub;
</file>

<file path="src/Components/login/Proveedores/LoginGoogle.tsx">
'use client';

import { useState } from 'react';
import { GoogleLogin, CredentialResponse } from '@react-oauth/google';
import { api, ApiResponse } from '../../../app/redux/services/loginApi';

interface LoginGoogleProps {
  onMensajeChange: (mensaje: string, tipo: 'error') => void;
}

interface GoogleLoginResponse {
  token: string;
  user: {
    id: string | number;
    name: string;
    email: string;
    picture?: string;
  };
  message?: string;
}

export default function LoginGoogle({ onMensajeChange }: LoginGoogleProps) {
  const [loading, setLoading] = useState(false);

  const handleSuccess = async (credentialResponse: CredentialResponse) => {
    setLoading(true);

    try {
      const res: ApiResponse<GoogleLoginResponse> = await api.post('/login/google', {
        credential: credentialResponse.credential,
        token: credentialResponse.credential,
        modo: 'login',
      });

      if (res.success && res.data) {
        localStorage.setItem('servineo_token', res.data.token);
        localStorage.setItem('servineo_user', JSON.stringify(res.data.user));
        window.location.href = '/';
      } else {
        const mensajeError =
          res.message ||
          res.data?.message ||
          res.error ||
          'Error desconocido al iniciar sesión con Google.';
        onMensajeChange(mensajeError, 'error');
      }
    } catch (err: unknown) {
      if (err instanceof Error) {
        onMensajeChange(err.message, 'error');
      } else {
        onMensajeChange('No se pudo conectar con el servidor.', 'error');
      }
    } finally {
      setLoading(false);
    }
  };

  const handleError = () => {
    onMensajeChange('Error al iniciar sesión con Google.', 'error');
  };

  return (
    <div className='flex flex-col items-center gap-2'>
      <div className='w-full flex justify-center'>
        <GoogleLogin onSuccess={handleSuccess} onError={handleError} />
      </div>

      {loading && (
        <p className='text-sm text-gray-500 mt-2 animate-pulse'>Verificando credenciales...</p>
      )}
    </div>
  );
}
</file>

<file path="src/Components/login/SeleccionMetodoModal.tsx">
'use client';

interface Props {
  showModal: boolean;
  onClose: () => void;
  onSelectForgotPassword: () => void;
  onSelectPasswordless: () => void;
}

export default function OpcionesLoginModal({
  showModal,
  onClose,
  onSelectForgotPassword,
  onSelectPasswordless,
}: Props) {
  if (!showModal) return null;

  return (
    <div className='fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm'>
      <div className='bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 border border-gray-200'>
        {/* Header */}
        <div className='text-center mb-6'>
          <h2 className='text-2xl font-bold text-gray-800 mb-2'>Opciones de acceso</h2>
          <p className='text-sm text-gray-600'>Elige cómo deseas recuperar tu acceso</p>
        </div>

        {/* Opciones */}
        <div className='space-y-4'>
          {/* OPCIÓN 1: Olvidaste tu contraseña */}
          <button
            onClick={onSelectForgotPassword}
            className='w-full flex items-center gap-4 p-5 rounded-xl border-2 border-gray-200 hover:border-primary hover:bg-primary/5 transition-all duration-300 group'
          >
            <div className='w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center group-hover:bg-primary/20 transition'>
              <span className='text-2xl'>🔑</span>
            </div>
            <div className='flex-1 text-left'>
              <h3 className='font-semibold text-gray-800 group-hover:text-primary transition'>
                ¿Olvidaste tu contraseña?
              </h3>
              <p className='text-sm text-gray-600'>Recupera tu contraseña por correo electrónico</p>
            </div>
          </button>

          {/* OPCIÓN 2: Ingresar sin contraseña */}
          <button
            onClick={onSelectPasswordless}
            className='w-full flex items-center gap-4 p-5 rounded-xl border-2 border-gray-200 hover:border-primary hover:bg-primary/5 transition-all duration-300 group'
          >
            <div className='w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center group-hover:bg-primary/20 transition'>
              <span className='text-2xl'>🔐</span>
            </div>
            <div className='flex-1 text-left'>
              <h3 className='font-semibold text-gray-800 group-hover:text-primary transition'>
                Ingresar sin contraseña
              </h3>
              <p className='text-sm text-gray-600'>Usa Google Authenticator</p>
            </div>
          </button>
        </div>

        {/* Botón cancelar */}
        <button
          onClick={onClose}
          className='w-full mt-6 px-4 py-3 text-gray-600 hover:text-gray-800 font-medium rounded-xl hover:bg-gray-100 transition'
        >
          Cancelar
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/maps/location/MapView.tsx">
'use client';

import { MapContainer, TileLayer, Marker, useMapEvents } from 'react-leaflet';
import { useState, useEffect } from 'react';
import 'leaflet/dist/leaflet.css';
interface MapViewProps {
  onSelect: (lat: number, lon: number) => void;
  markerPosition?: { lat: number; lon: number } | null;
}

export default function MapView({ onSelect, markerPosition }: MapViewProps) {
  return (
    <MapContainer
      center={[markerPosition?.lat || -17.39, markerPosition?.lon || -66.15]}
      zoom={13}
      style={{ height: 400, width: '100%' }}
    >
      <TileLayer url='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' />
      <MarkerHandler onSelect={onSelect} markerPosition={markerPosition} />
    </MapContainer>
  );
}

interface MarkerHandlerProps {
  onSelect: (lat: number, lon: number) => void;
  markerPosition?: { lat: number; lon: number } | null;
}

function MarkerHandler({ onSelect, markerPosition }: MarkerHandlerProps) {
  const [position, setPosition] = useState(markerPosition || null);

  useEffect(() => {
    setPosition(markerPosition || null);
  }, [markerPosition]);

  useMapEvents({
    click(e) {
      setPosition({ lat: e.latlng.lat, lon: e.latlng.lng });
      onSelect(e.latlng.lat, e.latlng.lng);
    },
  });

  return position ? <Marker position={[position.lat, position.lon]} /> : null;
}
</file>

<file path="src/Components/Modal-confirmation.tsx">
'use client';

import { X, AlertTriangle } from 'lucide-react';

interface ConfirmationModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => void;
  title: string;
  message: string;
  confirmText?: string;
  cancelText?: string;
  type?: 'danger' | 'warning' | 'info';
}

export default function ConfirmationModal({
  isOpen,
  onClose,
  onConfirm,
  title,
  message,
  confirmText = 'Confirmar',
  cancelText = 'Cancelar',
  type = 'danger',
}: ConfirmationModalProps) {
  if (!isOpen) return null;

  const typeConfig = {
    danger: {
      bgColor: 'bg-red-500/10',
      borderColor: 'border-red-500/30',
      iconColor: 'text-red-500',
      titleColor: 'text-red-700 dark:text-red-400',
      buttonColor: 'bg-red-500 hover:bg-red-600',
    },
    warning: {
      bgColor: 'bg-orange-500/10',
      borderColor: 'border-orange-500/30',
      iconColor: 'text-orange-500',
      titleColor: 'text-orange-700 dark:text-orange-400',
      buttonColor: 'bg-orange-500 hover:bg-orange-600',
    },
    info: {
      bgColor: 'bg-blue-500/10',
      borderColor: 'border-blue-500/30',
      iconColor: 'text-blue-500',
      titleColor: 'text-blue-700 dark:text-blue-400',
      buttonColor: 'bg-blue-500 hover:bg-blue-600',
    },
  };

  const config = typeConfig[type];

  const handleConfirm = () => {
    onConfirm();
    onClose();
  };

  return (
    <div className='fixed inset-0 z-50 flex items-center justify-center px-4 animate-fade-in'>
      <div
        className='fixed inset-0 bg-black/60 backdrop-blur-sm'
        onClick={onClose}
        aria-hidden='true'
      />

      <div
        className={`relative w-full max-w-md bg-card border-2 ${config.borderColor} rounded-2xl shadow-2xl animate-scale-in`}
      >
        <div className='p-6'>
          <div className='flex items-start gap-4'>
            <div
              className={`flex-shrink-0 w-12 h-12 ${config.bgColor} rounded-xl flex items-center justify-center`}
            >
              <AlertTriangle className={`w-6 h-6 ${config.iconColor}`} />
            </div>

            <div className='flex-1 min-w-0'>
              <h3 className={`text-lg font-bold ${config.titleColor} mb-1`}>{title}</h3>
              <p className='text-sm text-muted-foreground leading-relaxed'>{message}</p>
            </div>

            <button
              onClick={onClose}
              className='flex-shrink-0 p-1.5 hover:bg-muted rounded-lg transition-all hover:rotate-90 duration-300'
              aria-label='Cerrar'
            >
              <X className='w-5 h-5' />
            </button>
          </div>

          <div className='flex gap-3 mt-6'>
            <button
              onClick={onClose}
              className='flex-1 px-4 py-2.5 border-2 border-border rounded-xl hover:bg-muted transition-all font-semibold'
            >
              {cancelText}
            </button>
            <button
              onClick={handleConfirm}
              className={`flex-1 px-4 py-2.5 ${config.buttonColor} text-white rounded-xl transition-all font-semibold shadow-lg hover:shadow-xl`}
            >
              {confirmText}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/Modal-notifications.tsx">
'use client';

import { X, CheckCircle, AlertCircle, Info, type LucideIcon, AlertTriangle } from 'lucide-react';
import { useEffect, type ReactNode } from 'react';

interface NotificationModalProps {
  isOpen: boolean;
  onClose: () => void;
  type: 'success' | 'error' | 'info' | 'warning';
  title: string;
  message: ReactNode;
  icon?: LucideIcon;
  autoClose?: boolean;
  autoCloseDelay?: number;
  // Acciones para confirmación
  onConfirm?: () => void;
  onCancel?: () => void;
  confirmText?: string;
  cancelText?: string;
}

const typeConfig = {
  success: {
    icon: CheckCircle,
    bgColor: 'bg-green-500/10',
    borderColor: 'border-green-500/30',
    iconColor: 'text-green-500',
    titleColor: 'text-green-700 dark:text-green-400',
    progressColor: 'bg-green-500',
    buttonColor: 'bg-green-600 hover:bg-green-700',
  },
  error: {
    icon: AlertCircle,
    bgColor: 'bg-red-500/10',
    borderColor: 'border-red-500/30',
    iconColor: 'text-red-500',
    titleColor: 'text-red-700 dark:text-red-400',
    progressColor: 'bg-red-500',
    buttonColor: 'bg-red-600 hover:bg-red-700',
  },
  info: {
    icon: Info,
    bgColor: 'bg-blue-500/10',
    borderColor: 'border-blue-500/30',
    iconColor: 'text-blue-500',
    titleColor: 'text-blue-700 dark:text-blue-400',
    progressColor: 'bg-blue-500',
    buttonColor: 'bg-blue-600 hover:bg-blue-700',
  },
  warning: {
    icon: AlertTriangle, // Cambiado a triangulo para advertencia general
    bgColor: 'bg-orange-500/10',
    borderColor: 'border-orange-500/30',
    iconColor: 'text-orange-500',
    titleColor: 'text-orange-700 dark:text-orange-400',
    progressColor: 'bg-orange-500',
    buttonColor: 'bg-orange-600 hover:bg-orange-700', // Color del botón de confirmar
  },
};

export default function NotificationModal({
  isOpen,
  onClose,
  type,
  title,
  message,
  icon: CustomIcon,
  autoClose = true,
  autoCloseDelay = 3000,
  onConfirm,
  onCancel,
  confirmText = 'Confirmar',
  cancelText = 'Cancelar',
}: NotificationModalProps) {
  const config = typeConfig[type] || typeConfig.info;
  const IconComponent = CustomIcon || config.icon;

  // Lógica: Solo auto-cerrar si NO es warning, o si el usuario forzó autoClose=true explícitamente
  const shouldAutoClose = isOpen && autoClose && type !== 'warning';

  useEffect(() => {
    if (shouldAutoClose) {
      const timer = setTimeout(() => {
        onClose();
      }, autoCloseDelay);
      return () => clearTimeout(timer);
    }
  }, [shouldAutoClose, autoCloseDelay, onClose]);

  if (!isOpen) return null;

  const handleConfirm = () => {
    if (onConfirm) onConfirm();
    onClose();
  };

  const handleCancel = () => {
    if (onCancel) onCancel();
    onClose();
  };

  return (
    <div className='fixed inset-0 z-50 flex items-start justify-start pt-20 animate-fade-in'>
      {/* Overlay backdrop */}
      <div
        className='fixed inset-0 bg-black/20 backdrop-blur-sm transition-opacity'
        onClick={handleCancel}
        aria-hidden='true'
      />

      <div
        className={`relative w-full max-w-md bg-white border-2 ${config.borderColor} rounded-2xl shadow-2xl animate-scale-in ml-16`}
        role='dialog'
        aria-modal='true'
      >
        <div className='p-6'>
          <div className='flex items-start gap-4'>
            {/* Ícono */}
            <div
              className={`flex-shrink-0 w-12 h-12 ${config.bgColor} rounded-xl flex items-center justify-center`}
            >
              <IconComponent className={`w-6 h-6 ${config.iconColor}`} />
            </div>

            {/* Contenido Texto */}
            <div className='flex-1 min-w-0'>
              <h3 className={`text-lg font-bold ${config.titleColor} mb-1`}>{title}</h3>
              <div className='text-sm text-gray-600 leading-relaxed'>{message}</div>
            </div>

            {/* Botón X de cerrar */}
            <button
              onClick={handleCancel}
              className='flex-shrink-0 p-1.5 hover:bg-gray-100 rounded-lg transition-all hover:rotate-90 duration-300 text-gray-400 hover:text-gray-600'
              aria-label='Cerrar'
            >
              <X className='w-5 h-5' />
            </button>
          </div>

          {/* Botones de Acción (Solo si es warning o se pasó onConfirm) */}
          {(type === 'warning' || onConfirm) && (
            <div className='mt-6 flex gap-3 justify-end'>
              <button
                onClick={handleCancel}
                className='px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors'
              >
                {cancelText}
              </button>
              <button
                onClick={handleConfirm}
                className={`px-4 py-2 ${config.buttonColor} text-white rounded-lg text-sm font-medium transition-colors shadow-sm`}
              >
                {confirmText}
              </button>
            </div>
          )}

          {/* Barra de Progreso (Solo si auto-cierra) */}
          {shouldAutoClose && (
            <div className='mt-4 h-1 bg-gray-100 rounded-full overflow-hidden'>
              <div
                className={`h-full ${config.progressColor} animate-progress origin-left`}
                style={{ animationDuration: `${autoCloseDelay}ms` }}
              />
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/Modal.tsx">
'use client';

import type React from 'react';
import { useEffect, useRef } from 'react';
import ReactDOM from 'react-dom';
import { X } from 'lucide-react';

export type ModalSize = 'sm' | 'md' | 'lg' | 'xl' | '2xl' | 'full';
export type ModalAlign = 'center' | 'top';

export interface ModalProps {
  open: boolean;
  onClose: () => void;
  title?: React.ReactNode;
  children?: React.ReactNode;
  footer?: React.ReactNode;
  showCloseButton?: boolean;
  size?: ModalSize;
  align?: ModalAlign;
  closeOnOverlayClick?: boolean;
  closeOnEsc?: boolean;
  className?: string;
  overlayClassName?: string;
}

const sizeClasses: Record<ModalSize, string> = {
  sm: 'max-w-sm',
  md: 'max-w-md',
  lg: 'max-w-lg',
  xl: 'max-w-xl',
  '2xl': 'max-w-2xl',
  full: 'w-screen h-screen max-w-none m-0 rounded-none',
};

function useLockBodyScroll(locked: boolean) {
  useEffect(() => {
    if (!locked) return;
    const original = document.body.style.overflow;
    document.body.style.overflow = 'hidden';
    return () => {
      document.body.style.overflow = original;
    };
  }, [locked]);
}

const Modal: React.FC<ModalProps> & {
  Header: React.FC<React.HTMLAttributes<HTMLDivElement>>;
  Body: React.FC<React.HTMLAttributes<HTMLDivElement>>;
  Footer: React.FC<React.HTMLAttributes<HTMLDivElement>>;
} = ({
  open,
  onClose,
  title,
  children,
  footer,
  showCloseButton = true,
  size = 'md',
  align = 'center',
  closeOnOverlayClick = true,
  closeOnEsc = true,
  className = '',
  overlayClassName = '',
}) => {
  const overlayRef = useRef<HTMLDivElement>(null);
  const panelRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (!open || !closeOnEsc) return;
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onClose();
    };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [open, closeOnEsc, onClose]);

  useLockBodyScroll(open);

  // Focus trap simple al abrir
  useEffect(() => {
    if (open) {
      requestAnimationFrame(() => {
        panelRef.current?.focus();
      });
    }
  }, [open]);

  if (!open) return null;

  const content = (
    <div
      ref={overlayRef}
      role='presentation'
      className={[
        // Layout
        'fixed inset-0 z-[1000] flex',
        align === 'center' ? 'items-end sm:items-center' : 'items-start', // En móvil empieza abajo, en desktop centro
        'justify-center p-4 sm:p-6',
        // Estilo Visual del Fondo (Backdrop)
        'bg-gray-900/60 backdrop-blur-sm transition-all duration-300',
        // Animación de entrada del fondo
        'animate-in fade-in duration-200',
        overlayClassName,
      ].join(' ')}
      onMouseDown={(e) => {
        if (!closeOnOverlayClick) return;
        if (e.target === overlayRef.current) onClose();
      }}
    >
      <div
        role='dialog'
        aria-modal='true'
        aria-label={typeof title === 'string' ? title : undefined}
        tabIndex={-1}
        ref={panelRef}
        className={[
          // Layout Base
          'w-full bg-white relative outline-none flex flex-col',
          // Bordes y Sombras
          'rounded-xl sm:rounded-2xl shadow-2xl border border-gray-100',
          // Altura máxima segura (para que no se salga de la pantalla en laptops pequeñas)
          'max-h-[90vh] sm:max-h-[85vh]',
          // Animación de entrada del Panel (Zoom sutil y fade)
          'animate-in zoom-in-95 fade-in slide-in-from-bottom-4 duration-300 ease-out',
          sizeClasses[size],
          align === 'top' ? 'mt-10 sm:mt-20' : '',
          className,
        ].join(' ')}
        onMouseDown={(e) => e.stopPropagation()}
      >
        {/* Renderizado condicional del Header automático */}
        {(title || showCloseButton) && (
          <div className='flex items-center justify-between gap-4 border-b border-gray-100 px-6 py-4 shrink-0 bg-white rounded-t-2xl'>
            {title && <div className='text-lg font-bold text-gray-900 leading-6'>{title}</div>}

            {showCloseButton && (
              <button
                type='button'
                aria-label='Cerrar'
                onClick={onClose}
                className='group relative -mr-2 p-2 rounded-full hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-primary/20'
              >
                <X className='h-5 w-5 text-gray-400 group-hover:text-gray-600 transition-colors' />
              </button>
            )}
          </div>
        )}

        {/* El children se renderiza directamente aquí. 
            El usuario debe usar <Modal.Body> para el padding y scroll. */}
        {children}

        {/* Renderizado condicional del Footer automático */}
        {footer && (
          <div className='border-t border-gray-100 px-6 py-4 bg-gray-50/50 rounded-b-2xl shrink-0 flex justify-end gap-3'>
            {footer}
          </div>
        )}
      </div>
    </div>
  );

  if (typeof window === 'undefined') return null;
  return ReactDOM.createPortal(content, document.body);
};

// === SUBCOMPONENTES ESTILIZADOS ===

Modal.Header = function ModalHeader({ className = '', children, ...props }) {
  return (
    <div
      className={`px-6 py-4 border-b border-gray-100 text-lg font-bold text-gray-900 shrink-0 flex items-center justify-between bg-white rounded-t-2xl ${className}`}
      {...props}
    >
      {children}
    </div>
  );
};

Modal.Body = function ModalBody({ className = '', children, ...props }) {
  // overflow-y-auto permite scroll si el contenido es muy alto
  // flex-1 hace que ocupe el espacio restante entre header y footer
  return (
    <div className={`px-6 py-6 overflow-y-auto flex-1 overscroll-contain ${className}`} {...props}>
      {children}
    </div>
  );
};

Modal.Footer = function ModalFooter({ className = '', children, ...props }) {
  return (
    <div
      className={`px-6 py-4 border-t border-gray-100 bg-gray-50/80 rounded-b-2xl shrink-0 flex items-center justify-end gap-3 ${className}`}
      {...props}
    >
      {children}
    </div>
  );
};

export { Modal };
export default Modal;
</file>

<file path="src/Components/payment/BackButton.tsx">
"use client";
import { useRouter } from "next/navigation";

export default function BackButton({
  fallback = "/payments",
  className = "",
}: { fallback?: string; className?: string }) {
  const router = useRouter();
  const handleClick = () => {
    if (typeof window !== "undefined" && window.history.length <= 1) router.push(fallback);
    else router.back();
  };

  return (
    <button
      onClick={handleClick}
      className={`inline-flex items-center gap-2 px-4 py-3 rounded-xl bg-[#2B31E0] text-white hover:bg-gray-800 text-sm shadow-lg ${className}`}
      aria-label="Volver"
    >
      <span aria-hidden>←</span> Volver
    </button>
  );
}
</file>

<file path="src/Components/payment/EarningsFilterModal.tsx">
//src/Components/payment/EarningsFilterModal.tsx
"use client";
import React, { useState } from 'react';
import { Calendar, AlertCircle } from 'lucide-react';

interface Props {
  currentFrom: string; // YYYY-MM-DD
  currentTo: string;   // YYYY-MM-DD
  onApply: (from: string, to: string) => void;
  onClose: () => void;
}

export default function EarningsFilterModal({ currentFrom, currentTo, onApply, onClose }: Props) {
  // Convertir YYYY-MM-DD a MM/DD/YYYY para mostrar
  const formatToDisplay = (isoDate: string): string => {
    if (!isoDate) return '';
    const [year, month, day] = isoDate.split('-');
    return `${month}/${day}/${year}`;
  };

  // Convertir MM/DD/YYYY a YYYY-MM-DD para guardar
  const formatToISO = (displayDate: string): string => {
    if (!displayDate || displayDate.length !== 10) return '';
    const parts = displayDate.split('/');
    if (parts.length !== 3) return '';
    const [month, day, year] = parts;
    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
  };

  const [fromDateDisplay, setFromDateDisplay] = useState(formatToDisplay(currentFrom));
  const [toDateDisplay, setToDateDisplay] = useState(formatToDisplay(currentTo));
  const [dateError, setDateError] = useState<string | null>(null);

  // ===== VALIDACIONES =====
  const isValidDate = (month: number, day: number, year: number): boolean => {
    if (month < 1 || month > 12) return false;
    if (day < 1 || day > 31) return false;
    if (year < 1900 || year > 2100) return false;

    const d = new Date(year, month - 1, day);
    return (
      d.getFullYear() === year &&
      d.getMonth() + 1 === month &&
      d.getDate() === day
    );
  };

  const validateDateString = (dateStr: string, fieldName: string): string | null => {
    if (!dateStr) return `La fecha "${fieldName}" es obligatoria`;
    
    if (dateStr.length !== 10) {
      return `La fecha "${fieldName}" está incompleta. Use formato MM/DD/YYYY`;
    }

    const parts = dateStr.split('/');
    if (parts.length !== 3) {
      return `La fecha "${fieldName}" tiene formato incorrecto`;
    }

    const month = parseInt(parts[0], 10);
    const day = parseInt(parts[1], 10);
    const year = parseInt(parts[2], 10);

    if (isNaN(month) || isNaN(day) || isNaN(year)) {
      return `La fecha "${fieldName}" contiene valores no numéricos`;
    }

    if (!isValidDate(month, day, year)) {
      if (month === 2 && day > 29) {
        return `Fecha inválida: Febrero solo tiene hasta 29 días`;
      } else if ([4, 6, 9, 11].includes(month) && day > 30) {
        return `Fecha inválida: Este mes solo tiene 30 días`;
      } else if (day > 31) {
        return `Fecha inválida: Ningún mes tiene más de 31 días`;
      } else if (month < 1 || month > 12) {
        return `Fecha inválida: El mes debe estar entre 01 y 12`;
      }
      return `La fecha "${fieldName}" no existe en el calendario`;
    }

    return null;
  };

  // ===== HANDLERS =====
  const handleTextInput = (
    value: string,
    setter: (val: string) => void,
    fieldName: string
  ) => {
    // Permitir solo números y /
    let cleaned = value.replace(/[^\d/]/g, '');
    
    // Auto-agregar / después de MM y DD
    if (cleaned.length === 2 && !cleaned.includes('/')) {
      cleaned = cleaned + '/';
    } else if (cleaned.length === 5 && cleaned.split('/').length === 2) {
      cleaned = cleaned + '/';
    }
    
    // Limitar a 10 caracteres
    if (cleaned.length > 10) {
      cleaned = cleaned.substring(0, 10);
    }

    setter(cleaned);

    // Validar si está completo
    if (cleaned.length === 10) {
      const error = validateDateString(cleaned, fieldName);
      setDateError(error);
    } else {
      setDateError(null);
    }
  };

  const handleSubmit = () => {
    // Validar ambas fechas
    const fromError = validateDateString(fromDateDisplay, 'Desde');
    if (fromError) {
      setDateError(fromError);
      return;
    }
    
    const toError = validateDateString(toDateDisplay, 'Hasta');
    if (toError) {
      setDateError(toError);
      return;
    }

    const fromISO = formatToISO(fromDateDisplay);
    const toISO = formatToISO(toDateDisplay);

    // Validar orden de fechas
    const fromDateObj = new Date(fromISO + 'T00:00:00');
    const toDateObj = new Date(toISO + 'T23:59:59');
    
    if (fromDateObj > toDateObj) {
      setDateError("La fecha 'Desde' no puede ser posterior a 'Hasta'");
      return;
    }

    // Validar rango máximo de 7 días
    const daysDiff = Math.ceil((toDateObj.getTime() - fromDateObj.getTime()) / (1000 * 60 * 60 * 24));
    if (daysDiff > 7) {
      setDateError("El rango de fechas no puede ser mayor a 7 días");
      return;
    }

    // Todo OK, aplicar filtro
    setDateError(null);
    onApply(fromISO, toISO);
  };

  const hasError = (dateDisplay: string): boolean => {
    return dateDisplay.length === 10 && validateDateString(dateDisplay, '') !== null;
  };

  const setPresetRange = (days: number) => {
    const to = new Date();
    const from = new Date();
    from.setDate(from.getDate() - (days - 1));
    
    setFromDateDisplay(formatToDisplay(from.toISOString().split('T')[0]));
    setToDateDisplay(formatToDisplay(to.toISOString().split('T')[0]));
    setDateError(null);
  };

  return (
    <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4">
      <div className="bg-white w-full max-w-md rounded-2xl shadow-xl relative overflow-hidden">
        
        {/* Header */}
        <div className="bg-blue-600 text-white px-6 py-4 flex items-center justify-between">
          <h2 className="text-xl font-bold">Filtrar por Fechas</h2>
          <button onClick={onClose} className="text-white hover:text-gray-200">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>

        <div className="p-6">
          <h3 className="text-lg font-semibold text-gray-800 mb-4">
            Seleccione el rango de fechas (máximo 7 días)
          </h3>
          <div className="space-y-5">
            {/* Campo Desde */}
            <div>
              <label className="block font-semibold text-gray-700 mb-2">Desde</label>
              <div className="relative">
                <input 
                  type="text"
                  placeholder="MM/DD/YYYY"
                  value={fromDateDisplay}
                  onChange={(e) => handleTextInput(e.target.value, setFromDateDisplay, 'Desde')}
                  maxLength={10}
                  className={`w-full p-3 pr-10 border-2 rounded-lg focus:outline-none focus:ring-2 ${
                    hasError(fromDateDisplay)
                      ? 'border-red-500 bg-red-50 focus:ring-red-500'
                      : 'border-gray-300 focus:ring-blue-500'
                  }`}
                />
                <input
                  type="date"
                  onChange={(e) => {
                    if (e.target.value) {
                      setFromDateDisplay(formatToDisplay(e.target.value));
                      setDateError(null);
                    }
                  }}
                  className="absolute right-2 top-1/2 -translate-y-1/2 opacity-0 w-8 h-8 cursor-pointer"
                  title="Abrir calendario"
                />
                <Calendar 
                  size={20} 
                  className={`absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none ${
                    hasError(fromDateDisplay) ? 'text-red-400' : 'text-gray-400'
                  }`} 
                />
              </div>
            </div>

            {/* Campo Hasta */}
            <div>
              <label className="block font-semibold text-gray-700 mb-2">Hasta</label>
              <div className="relative">
                <input 
                  type="text"
                  placeholder="MM/DD/YYYY"
                  value={toDateDisplay}
                  onChange={(e) => handleTextInput(e.target.value, setToDateDisplay, 'Hasta')}
                  maxLength={10}
                  className={`w-full p-3 pr-10 border-2 rounded-lg focus:outline-none focus:ring-2 ${
                    hasError(toDateDisplay)
                      ? 'border-red-500 bg-red-50 focus:ring-red-500'
                      : 'border-gray-300 focus:ring-blue-500'
                  }`}
                />
                <input
                  type="date"
                  onChange={(e) => {
                    if (e.target.value) {
                      setToDateDisplay(formatToDisplay(e.target.value));
                      setDateError(null);
                    }
                  }}
                  className="absolute right-2 top-1/2 -translate-y-1/2 opacity-0 w-8 h-8 cursor-pointer"
                  title="Abrir calendario"
                />
                <Calendar 
                  size={20} 
                  className={`absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none ${
                    hasError(toDateDisplay) ? 'text-red-400' : 'text-gray-400'
                  }`} 
                />
              </div>
            </div>

            {/* Error */}
            {dateError && (
              <div className="bg-red-50 border-2 border-red-400 rounded-lg p-4 flex gap-3">
                <AlertCircle className="text-red-600 flex-shrink-0" size={24} />
                <div>
                  <p className="text-red-800 font-bold text-sm">¡Error!</p>
                  <p className="text-red-700 text-sm">{dateError}</p>
                </div>
              </div>
            )}
            
            {/* Botones */}
            <div className="flex gap-4 pt-4"> 
              <button
                onClick={handleSubmit}
                disabled={!!dateError}
                className={`flex-1 px-6 py-3 rounded-lg font-semibold text-white ${
                  dateError
                    ? 'bg-gray-300 cursor-not-allowed'
                    : 'bg-blue-600 hover:bg-blue-700'
                }`}
              >
                Aplicar Filtro
              </button>
              <button 
                onClick={onClose} 
                className="flex-1 px-6 py-3 rounded-lg font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200"
              >
                Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/payment/InvoiceDetail.tsx">
// src/Components/payment/InvoiceDetail.tsx
'use client';

import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Download, ArrowLeft, Loader2 } from 'lucide-react';
import { jsPDF } from 'jspdf';
import QRCode from 'qrcode';

export interface InvoiceItem {
 description: string;
 quantity: number;
 unitPrice: number;
 subtotal: number;
}

export interface InvoiceDetailData {
 id: string;
 transactionId?: string; // Aseguramos que transactionId esté aquí
 requesterName: string; 
 clientName?: string; 
 clientAddress?: string;
 clientVAT?: string;
 service: string;
 date: string;
 totalAmount: number;
 taxRate?: number;
 taxAmount?: number;
 items: InvoiceItem[];
}

interface InvoiceDetailProps {
 invoice: InvoiceDetailData;
 onBack?: () => void;
 isDownloadForbidden?: boolean; 
}

const InvoiceDetail: React.FC<InvoiceDetailProps> = ({ invoice, onBack, isDownloadForbidden = false }) => {
 const router = useRouter();
 const [downloading, setDownloading] = useState(false);
 const [qrDataUrl, setQrDataUrl] = useState<string | null>(null);

 // Generar QR
 useEffect(() => {
 const generateQr = async () => {
 if (!invoice || !invoice.id) return; 
 const qrValue = `Factura ID: ${invoice.id} | Cliente: ${invoice.requesterName} | Total: Bs. ${invoice.totalAmount ?? 0}`;
 const dataUrl = await QRCode.toDataURL(qrValue, { width: 120, margin: 1 });
 setQrDataUrl(dataUrl);
 };
 generateQr();
 }, [invoice]);

 if (!invoice) {
 return (
 <div className="min-h-screen flex items-center justify-center">
 <p className="text-red-500 font-bold">Factura no encontrada.</p>
 </div>
 );
 }

 const calculatedSubtotal = invoice.items.reduce((sum, item) => sum + (item.subtotal ?? 0), 0);

 const handleDownloadPDF = async () => {
 if (isDownloadForbidden) return;

 setDownloading(true);
 try {
 const doc = new jsPDF();
 let y = 15; 
      const marginX = 15; 

 // 1. ENCABEZADO Y TÍTULO
 doc.setFontSize(22);
 doc.setTextColor(63, 81, 181); 
 doc.text('FACTURA COMERCIAL', marginX, y);
 y += 10;
      
      // 2. NÚMERO DE FACTURA Y FECHA (En dos columnas)
      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100); 
      
      doc.text(`Factura No.`, marginX, y);
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0); 
      doc.text(`${invoice.id}`, marginX, y + 4);
      
      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100);
      doc.text(`Fecha de Emisión:`, 150, y);
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0); 
      doc.text(`${invoice.date}`, 150, y + 4);

 y += 12; 
      doc.line(marginX, y, 210 - marginX, y); 
      y += 8;
      
 // 3. DATOS DEL CLIENTE
      doc.setFontSize(14);
      doc.setTextColor(63, 81, 181);
      doc.text('Datos del Cliente', marginX, y);
      y += 6;
      
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      
      doc.setFont('helvetica', 'bold');
      doc.text(`Cliente: ${invoice.clientName || invoice.requesterName}`, marginX, y);
      y += 5;
      
      if (invoice.clientAddress) {
          doc.setFont('helvetica', 'normal');
          doc.text(`Dirección: ${invoice.clientAddress}`, marginX, y);
          y += 5;
      }
      
      if (invoice.clientVAT) {
          doc.setFont('helvetica', 'normal');
          doc.text(`RUC/VAT: ${invoice.clientVAT}`, marginX, y);
          y += 5;
      }
      
      doc.setFont('helvetica', 'normal');
      doc.text(`Concepto: ${invoice.service}`, marginX, y);
      y += 8;
      
 // 4. TABLA DE ÍTEMS
      doc.setFontSize(14);
      doc.setTextColor(63, 81, 181);
      doc.text('Detalle de Cargos', marginX, y);
      y += 5;

      // Encabezados de Columna (manual)
      doc.setFontSize(9);
      doc.setTextColor(0, 0, 0);
      doc.setFont('helvetica', 'bold');
      doc.text('Descripción', 18, y + 2);
      doc.text('Cant.', 110, y + 2);
      doc.text('P. Unit. (Bs.)', 135, y + 2);
      doc.text('Total (Bs.)', 170, y + 2);
      doc.line(15, y + 4, 210 - marginX, y + 4); 
      y += 8;
      
      // Ítems
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
 invoice.items.forEach((item) => {
 doc.text(item.description, 18, y);
        doc.text((item.quantity ?? 0).toString(), 110, y, { align: 'right' });
        doc.text((item.unitPrice ?? 0).toFixed(2), 135, y, { align: 'right' });
        doc.text((item.subtotal ?? 0).toFixed(2), 170, y, { align: 'right' });
 y += 6;
 });
      
      y += 5; 
      doc.line(15, y, 210 - marginX, y); 
      y += 5;
      
 // 5. TOTALES (Alineados a la derecha)
      const totalX = 175; 
      
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      doc.setFont('helvetica', 'normal');
 doc.text(`Subtotal:`, 140, y);
      doc.text(`${calculatedSubtotal.toFixed(2)}`, totalX, y, { align: 'right' });
 y += 5;
      
 doc.text(`Impuestos (${((invoice.taxRate ?? 0) * 100).toFixed(0)}%):`, 140, y);
      doc.text(`${(invoice.taxAmount ?? 0).toFixed(2)}`, totalX, y, { align: 'right' });
 y += 8;
      
      doc.setTextColor(63, 81, 181);
 doc.setFontSize(14);
 doc.setFont('helvetica', 'bold');
 doc.text(`TOTAL:`, 140, y);
      doc.text(`Bs. ${(invoice.totalAmount ?? 0).toFixed(2)}`, totalX, y, { align: 'right' });
      
 // 6. QR Code (Si está disponible)
 if (qrDataUrl) {
 doc.addImage(qrDataUrl, 'PNG', 25, 250, 40, 40); 
 }

 doc.save(`Factura_${invoice.id}.pdf`);
 } catch (err) {
 console.error('Error generando PDF:', err);
 } finally {
 setDownloading(false);
 }
 };

 return (
 <div className="min-h-screen bg-gray-50 p-4 sm:p-8 font-sans">
 <div className="max-w-3xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden">
 {/* Header (Botón Volver, Título, Botón Descargar) */}
<div className="p-6 bg-indigo-600 text-white flex justify-between items-center">
 <button
 onClick={onBack || (() => router.back())}
className="flex items-center text-sm font-semibold hover:text-indigo-200 transition-colors"
>
 <ArrowLeft className="w-5 h-5 mr-1" />
 Volver
 </button>
<h1 className="text-2xl font-extrabold">Detalle de Factura</h1>
 
            {/* Botón de Descarga con Control de Prohibición */}
 <button
 onClick={handleDownloadPDF}
 disabled={downloading || isDownloadForbidden} 
 className="flex items-center bg-white text-indigo-600 font-bold py-2 px-4 rounded-xl shadow-lg hover:bg-indigo-100 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
>
 {downloading ? (
 <>
 <Loader2 className="w-5 h-5 mr-2 animate-spin" />
 Generando...
 </>
 ) : isDownloadForbidden ? (
                'Descarga Única Realizada'
            ) : (
 <>
 <Download className="w-5 h-5 mr-2" />
 Descargar PDF
 </>
 )}
 </button>
 </div>

 {/* Contenido */}
 <div className="p-8 space-y-8">
            
          {/* Advertencia de Prohibición */}
          {isDownloadForbidden && (
            <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-xl shadow-md" role="alert">
                <p className="font-bold">Acceso Restringido (Descarga Única)</p>
                <p>Esta factura ya fue descargada. Por motivos de seguridad y control, solo se permite una única descarga de los datos de la factura.</p>
            </div>
          )}
          
 {/* 🔑 1. Encabezado de Factura (Número y Fecha) - CORREGIDO */}
 <div className="flex justify-between items-start border-b pb-6 mb-6">
 {/* Factura Número (Izquierda) */}
 <div>
 <p className="text-xs font-semibold text-gray-500 uppercase tracking-widest">Factura Número</p>
 <p className="text-3xl font-black text-white bg-indigo-600 inline-block px-3 py-1 mt-1 rounded-lg">
                {invoice.id}
              </p>
 </div>
 {/* Fecha de Emisión (Derecha) */}
 <div className="text-right">
 <p className="text-xs font-semibold text-gray-500 uppercase tracking-widest">Fecha de Emisión</p>
 <p className="text-xl font-bold text-gray-700 mt-1">{invoice.date}</p>
 </div>
 </div>
          
 {/* 2. Datos Cliente y Servicio/Transacción - CORREGIDO */}
 <div className="grid grid-cols-1 sm:grid-cols-2 gap-8 border-b pb-8">
 
            {/* Columna 1: Información del Cliente */}
 <div className="space-y-1">
 <h3 className="font-bold text-lg text-gray-800 mb-3 border-b-2 border-indigo-200 inline-block">Cliente</h3>
 <p className="font-extrabold text-indigo-600 text-xl">{invoice.clientName || invoice.requesterName}</p>
              
 {invoice.clientVAT && <p className="text-sm text-gray-600">**RUC/VAT:** {invoice.clientVAT}</p>}
 {invoice.clientAddress && <p className="text-sm text-gray-600">**Dirección:** {invoice.clientAddress}</p>}

 </div>
            
            {/* Columna 2: Información del Servicio/Factura */}
            <div className="space-y-1">
 <h3 className="font-bold text-lg text-gray-800 mb-3 border-b-2 border-indigo-200 inline-block">Detalles</h3>
 
              <p className="text-md text-gray-700">
                <span className="font-semibold text-indigo-600">Servicio Contratado:</span> {invoice.service}
              </p>
              {invoice.transactionId && (
                  <p className="text-md text-gray-700">
                    <span className="font-semibold text-indigo-600">Transacción ID:</span> {invoice.transactionId}
                  </p>
              )}
 </div>
 </div>

 {/* Tabla de ítems */}
 <div>
 <h3 className="font-bold text-indigo-600 mb-4">Detalle de Cargos</h3>
 <div className="overflow-x-auto rounded-xl shadow-lg">
 <table className="min-w-full bg-white">
 <thead className="bg-indigo-100 border-b border-indigo-200">
 <tr>
 <th className="px-6 py-3 text-left text-xs font-medium text-indigo-600 uppercase tracking-wider">Descripción</th>
 <th className="px-6 py-3 text-right text-xs font-medium text-indigo-600 uppercase tracking-wider">Cant.</th>
 <th className="px-6 py-3 text-right text-xs font-medium text-indigo-600 uppercase tracking-wider">P. Unit. (Bs.)</th>
 <th className="px-6 py-3 text-right text-xs font-medium text-indigo-600 uppercase tracking-wider">Total (Bs.)</th>
 </tr>
 </thead>
 <tbody className="divide-y divide-indigo-200">
 {invoice.items.map((item, idx) => (
 <tr key={idx} className="hover:bg-indigo-50 transition-colors">
 <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{item.description}</td>
 <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">{item.quantity ?? 0}</td>
 <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">{(item.unitPrice ?? 0).toFixed(2)}</td>
 <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-right text-gray-900">{(item.subtotal ?? 0).toFixed(2)}</td>
 </tr>
 ))}
 </tbody>
 </table>
 </div>
 </div>

 {/* Totales y QR centrados */}
 <div className="flex justify-center pt-4">
 <div className="w-full sm:w-96 space-y-3 p-4 bg-indigo-50 rounded-xl shadow-inner flex flex-col items-center">
 <div className="flex justify-between w-full">
 <span className="text-indigo-600 font-semibold">Subtotal:</span>
 <span className="font-medium">{calculatedSubtotal.toFixed(2)}</span>
 </div>
 <div className="flex justify-between w-full">
 <span className="text-indigo-600 font-semibold">Impuestos ({((invoice.taxRate ?? 0) * 100).toFixed(0)}%)</span>
 <span className="font-medium">{(invoice.taxAmount ?? 0).toFixed(2)}</span>
 </div>
 <div className="flex justify-between w-full border-t pt-3 border-indigo-200">
 <span className="text-xl font-extrabold text-indigo-600">TOTAL:</span>
 <span className="text-xl font-extrabold text-indigo-600">{(invoice.totalAmount ?? 0).toFixed(2)}</span>
 </div>

 {qrDataUrl && (
 <div className="mt-4 flex justify-center">
 <img src={qrDataUrl} alt="QR Factura" width={120} height={120} />
 </div>
 )}
 </div>
 </div>
 </div>
 </div>
 </div>
 );
};

export default InvoiceDetail;
</file>

<file path="src/Components/payment/PaymentSuccessModal.tsx">
// src/Components/payment/PaymentSuccessModal.tsx 
// Modal de confirmación exitosa de pago

import React from 'react';
import { PaymentSuccessModalProps } from '../../utils/types';

export default function PaymentSuccessModal({ onClose }: PaymentSuccessModalProps) {
  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
      <div className="bg-black rounded-lg shadow-2xl p-8 max-w-md w-full mx-4 text-center">
        <div className="inline-flex items-center justify-center w-16 h-16 bg-[#16A34A] rounded-full mb-4">
          <svg 
            className="w-8 h-8 text-white" 
            fill="none" 
            stroke="currentColor" 
            viewBox="0 0 24 24"
          >
            <path 
              strokeLinecap="round" 
              strokeLinejoin="round" 
              strokeWidth={3} 
              d="M5 13l4 4L19 7" 
            />
          </svg>
        </div>
        
        <h2 className="text-2xl font-bold text-white mb-2">
          ✓ Código correcto! Pago confirmado
        </h2>
        
        <button
          onClick={onClose}
          className="mt-6 px-8 py-3 bg-[#2B31E0] hover:bg-[#2B6AE0] text-white text-lg font-semibold rounded transition-colors w-full"
        >
          OK
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/Pill-button.tsx">
import type React from 'react';

interface PillButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'outline' | 'ghost' | 'danger';
  size?: 'sm' | 'md' | 'lg';
}

export function PillButton({
  className = '',
  variant = 'primary',
  size = 'md',
  ...props
}: PillButtonProps) {
  const baseStyles =
    'inline-flex items-center justify-center rounded-full font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 disabled:pointer-events-none disabled:opacity-50';

  const variants = {
    primary: 'bg-blue-600 text-white hover:bg-blue-700 shadow-sm',
    secondary: 'bg-gray-100 text-gray-900 hover:bg-gray-200',
    outline: 'border border-gray-200 bg-white hover:bg-gray-100 hover:text-gray-900',
    ghost: 'hover:bg-gray-100 hover:text-gray-900',
    danger: 'bg-red-600 text-white hover:bg-red-700 shadow-sm',
  };

  const sizes = {
    sm: 'h-8 px-4 text-xs',
    md: 'h-10 px-6 text-sm',
    lg: 'h-12 px-8 text-base',
  };

  const classes = `${baseStyles} ${variants[variant]} ${sizes[size]} ${className}`;

  return <button className={classes} {...props} />;
}
</file>

<file path="src/Components/requester/auth/usoAutentificacion.tsx">
'use client';

import { createContext, useContext, useState, useEffect } from 'react';
import { verificarSesionBackend, User } from '@/app/redux/services/auth/registro';
import { useRouter } from 'next/navigation';

interface AuthContextType {
  user: User | null;
  setUser: React.Dispatch<React.SetStateAction<User | null>>;
  logout: () => void;
  loading: boolean;
}

const AuthContext = createContext<AuthContextType | null>(null);

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const router = useRouter();

  useEffect(() => {
    try {
      const storedUser = localStorage.getItem('servineo_user');
      if (storedUser) {
        setUser(JSON.parse(storedUser));
      }
    } catch (e) {
      console.error('Error leyendo usuario:', e);
      localStorage.removeItem('servineo_user');
    }

    const token = localStorage.getItem('servineo_token');
    if (!token) {
      setLoading(false);
      return;
    }

    verificarSesionBackend(token)
      .then((data) => {
        if (data.valid && data.user) {
          setUser((prev) => {
            const newUser = { ...prev, ...data.user };
            localStorage.setItem('servineo_user', JSON.stringify(newUser));
            return newUser;
          });
        } else {
          localStorage.removeItem('servineo_token');
          localStorage.removeItem('servineo_user');
          setUser(null);
        }
      })
      .catch(() => {
        localStorage.removeItem('servineo_token');
        localStorage.removeItem('servineo_user');
        setUser(null);
      })
      .finally(() => setLoading(false));
  }, []);

  useEffect(() => {
    if (user) {
      localStorage.setItem('servineo_user', JSON.stringify(user));
    }
  }, [user]);

  const logout = () => {
    localStorage.removeItem('servineo_token');
    localStorage.removeItem('servineo_user');
    setUser(null);
    router.push('/');
  };

  return (
    <AuthContext.Provider value={{ user, setUser, logout, loading }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth(): AuthContextType {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth debe usarse dentro de un AuthProvider');
  }
  return context;
}
</file>

<file path="src/Components/requester/Authenticator/AuthenticatorButton.tsx">
'use client';
import React from 'react';

interface Props {
  onClick: () => void;
}

export default function AuthenticatorButton({ onClick }: Props) {
  return (
    <button
      onClick={onClick}
      className='flex items-center gap-3 px-5 py-3 border rounded-lg shadow-sm hover:shadow-md transition
                 bg-white text-gray-700 border-gray-200'
      aria-label='Configurar Authenticator'
    >
      <span className='w-8 h-8 flex items-center justify-center bg-blue-50 rounded-full'>
        {/* icon placeholder */}
        <svg className='w-5 h-5 text-blue-600' viewBox='0 0 24 24' fill='none'>
          <path
            d='M12 2v6'
            stroke='currentColor'
            strokeWidth='1.5'
            strokeLinecap='round'
            strokeLinejoin='round'
          />
          <rect x='3' y='8' width='18' height='13' rx='2' stroke='currentColor' strokeWidth='1.5' />
        </svg>
      </span>
      <span className='text-sm font-medium'>Authenticator</span>
    </button>
  );
}
</file>

<file path="src/Components/requester/Authenticator/AuthenticatorCodigoModal.tsx">
'use client';

import { useState } from 'react';
import { api, ApiResponse } from '../../../app/redux/services/api';

interface AuthenticatorCodigoModalProps {
  showModal: boolean;
  cerrarModal: () => void;
  volverATOTP: () => void;
  email: string;
}

interface RecoveryCodeResponse {
  success: boolean;
  message: string;
  data?: {
    token: string;
    user: {
      _id: string;
      email: string;
      name: string;
      picture?: string | null;
    };
  };
}

export default function AuthenticatorCodigoModal({
  showModal,
  cerrarModal,
  volverATOTP,
  email,
}: AuthenticatorCodigoModalProps) {
  const [codigo, setCodigo] = useState('');
  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState('');

  if (!showModal) return null;

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value.replace(/[^a-zA-Z0-9]/g, '');
    setCodigo(value.slice(0, 10));
    setErrorMsg('');
  };

  const handleIngresar = async () => {
    if (!codigo) {
      setErrorMsg('Ingresa un código de recuperación');
      return;
    }

    setLoading(true);

    try {
      const res: ApiResponse<RecoveryCodeResponse> = await api.post(
        '/codigos2fa/verify-recovery-code',
        { email, codigo },
      );

      const inner = res.data;

      if (!inner?.success) {
        setErrorMsg(inner?.message || 'Código incorrecto');
        return;
      }

      const token = inner?.data?.token;
      const user = inner?.data?.user;

      if (!token || !user) {
        setErrorMsg('Respuesta inválida del servidor');
        return;
      }

      // ✔️ Guardar token y usuario EXACTAMENTE igual al modal TOTP
      localStorage.setItem('servineo_token', token);
      localStorage.setItem('servineo_user', JSON.stringify(user));

      // ✔️ Mostrar el mensaje de bienvenida igual que en TOTP
      sessionStorage.setItem('toastMessage', `¡Bienvenido, ${user.name}!`);

      // Cerrar modal y redirigir
      cerrarModal();
      window.location.href = '/';
      return;
    } catch (err) {
      console.error('Error al verificar código de recuperación:', err);
      const errorMessage = err instanceof Error ? err.message : 'Error en el servidor';
      setErrorMsg(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className='fixed inset-0 z-50 flex items-center justify-center bg-black/60'>
      <div className='bg-white w-[520px] rounded-lg shadow-lg p-8'>
        <h2 className='text-3xl font-bold text-center text-servineo-500 mb-1'>
          <span className='text-servineo-400'>Servineo</span>
        </h2>

        <p className='text-2xl font-bold text-center text-servineo-500 mb-6'>Authenticator App</p>

        <p className='block text-sm font-semibold text-gray-600 mb-2'>
          Ingresar con código de recuperación
        </p>

        <form
          className='bg-white rounded-lg w-[420px] p-6 shadow-lg border mx-auto mt-2'
          onSubmit={(e) => {
            e.preventDefault();
            handleIngresar();
          }}
        >
          <p className='text-sm text-gray-600 mb-4 text-center'>
            Ingresa uno de los códigos de recuperacion que se le otorgo al configurar la app de
            Authenticator.
          </p>

          <input
            placeholder='Ingrese un código de recuperación'
            value={codigo}
            onChange={handleChange}
            className='w-full border rounded-xl p-3.5 text-gray-800 text-center font-mono focus:outline-none focus:ring-2 focus:ring-servineo-400'
            maxLength={10}
            required
          />

          {errorMsg && (
            <p className='text-red-600 text-sm mt-2 text-center font-medium'>{errorMsg}</p>
          )}

          <div className='flex gap-4 mt-6'>
            <button
              type='button'
              onClick={() => {
                cerrarModal();
                volverATOTP();
              }}
              className='flex-1 rounded-md bg-[#E5F4FB] px-4 py-2 text-[#1A223F] font-semibold hover:bg-[#2BDDE0]/20'
            >
              Volver
            </button>

            <button
              type='submit'
              disabled={loading}
              className='flex-1 rounded-md bg-[#1A223F] px-4 py-2 text-white font-semibold hover:bg-[#2B31E0]'
            >
              {loading ? 'Validando...' : 'Ingresar'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/requester/Authenticator/AuthenticatorQrModal.tsx">
'use client';
import React from 'react';

interface Props {
  open: boolean;
  onClose: () => void;
  qrDataUrl?: string | null;
  onNext: () => void;
  loading?: boolean;
  onRegenerate?: () => void;
  regenerating?: boolean;
}

export default function AuthenticatorQrModal({
  open,
  onClose,
  qrDataUrl,
  onNext,
  loading,
  onRegenerate,
  regenerating,
}: Props) {
  if (!open) return null;

  return (
    <div className='fixed inset-0 z-40 flex items-center justify-center bg-black/40'>
      <div className='bg-white rounded-lg w-[480px] p-6 shadow-lg border'>
        <h3 className='text-lg font-semibold mb-3'>Configurar aplicación de autenticación</h3>

        <div className='text-sm text-gray-600 mb-4'>
          <ul className='list-disc ml-5'>
            <li>
              En la aplicación Google Authenticator, toca el icono <strong>+</strong>.
            </li>
            <li>
              Elige <strong>Escanear un código QR</strong>.
            </li>
          </ul>
        </div>

        {/* Contenedor principal del QR + botón de refrescar */}
        <div className='flex flex-col items-center justify-center py-4 gap-3'>
          <div className='relative'>
            {qrDataUrl ? (
              // eslint-disable-next-line @next/next/no-img-element
              <img
                src={qrDataUrl}
                alt='QR 2FA'
                className={`w-48 h-48 object-contain rounded-lg transition-all duration-500
                  ${
                    regenerating
                      ? 'opacity-40 scale-95 shadow-[0_0_25px_rgba(79,70,229,0.35)] blur-[1px]'
                      : 'opacity-100 scale-100 shadow-sm'
                  }`}
              />
            ) : (
              <div className='w-48 h-48 flex items-center justify-center bg-gray-100 border rounded-lg text-gray-500 text-sm'>
                Cargando...
              </div>
            )}

            {/* Overlay “cool” mientras regenera */}
            {regenerating && (
              <div className='absolute inset-0 flex items-center justify-center rounded-lg pointer-events-none'>
                <div className='w-12 h-12 rounded-full border-2 border-indigo-500 border-t-transparent animate-spin' />
              </div>
            )}
          </div>

          {/* Botón de refrescar debajo, centrado */}
          {onRegenerate && (
            <button
              type='button'
              aria-label='Regenerar código QR'
              onClick={onRegenerate}
              disabled={regenerating || loading}
              className='inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-gray-200 bg-white text-xs text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all'
            >
              <svg
                className={`w-4 h-4 ${regenerating ? 'animate-spin' : ''}`}
                viewBox='0 0 24 24'
                fill='none'
                stroke='currentColor'
              >
                <path
                  strokeWidth='1.7'
                  strokeLinecap='round'
                  strokeLinejoin='round'
                  d='M4 4v6h6M20 20v-6h-6'
                />
                <path
                  strokeWidth='1.7'
                  strokeLinecap='round'
                  strokeLinejoin='round'
                  d='M5 13a7 7 0 0 0 12 3M19 11A7 7 0 0 0 7 8'
                />
              </svg>
              <span>Regenerar código</span>
            </button>
          )}
        </div>

        <div className='flex justify-end gap-3 mt-4'>
          <button
            onClick={onClose}
            className='px-4 py-2 rounded-md border text-sm bg-white text-gray-700'
          >
            Cancelar
          </button>
          <button
            onClick={onNext}
            className='px-4 py-2 rounded-md text-sm bg-indigo-600 text-white disabled:opacity-60'
            disabled={!qrDataUrl || loading || regenerating}
          >
            Siguiente
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/requester/Authenticator/AuthenticatorSesionModal.tsx">
'use client';
import { useState } from 'react';
import { api } from '../../../app/redux/services/api';

interface AuthenticatorSesionProps {
  showModal: boolean;
  setShowModal: () => void; // cierra este modal
  emailTOTP: string; // correo interno TOTP
  setEmailTOTP: (email: string) => void;
  abrirTOTP: () => void; // abre modal TOTP
}

interface TwoFactorResponse {
  success: boolean;
  data?: {
    exists: boolean;
    twoFactorEnabled: boolean;
    reason: string;
  };
  message?: string;
}

export default function AuthenticatorSesion({
  showModal,
  setShowModal,
  emailTOTP,
  setEmailTOTP,
  abrirTOTP,
}: AuthenticatorSesionProps) {
  const [email, setEmail] = useState(emailTOTP || '');
  const [errorMessage, setErrorMessage] = useState('');

  if (!showModal) return null;

  const handleContinuar = async () => {
    if (!email) {
      setErrorMessage('Debe ingresar un correo');
      setTimeout(() => setErrorMessage(''), 10000);
      return;
    }

    try {
      const res = await api.post<TwoFactorResponse>('/sesion2fa/check-status', { email });
      const exists = res.data?.data?.exists;
      const twoFactorEnabled = res.data?.data?.twoFactorEnabled;

      if (exists === undefined || twoFactorEnabled === undefined) {
        setErrorMessage(res.data?.message || 'Error al verificar usuario');
        setTimeout(() => setErrorMessage(''), 10000);
        return;
      }

      if (!exists) {
        setErrorMessage('Correo electrónico incorrecto');
        setTimeout(() => setErrorMessage(''), 10000);
      } else if (!twoFactorEnabled) {
        setErrorMessage('Su cuenta no tiene configurada la app Authenticator');
        setTimeout(() => setErrorMessage(''), 10000);
      } else {
        // Guardamos correo para TOTP
        setEmailTOTP(email);
        setShowModal(); // cierra modal de sesión
        abrirTOTP(); // abre modal TOTP
      }
    } catch (err) {
      setErrorMessage('Error de conexión con el servidor');
      setTimeout(() => setErrorMessage(''), 10000);
      console.error(err);
    }
  };

  return (
    <div className='fixed inset-0 z-50 flex items-center justify-center bg-black/60'>
      <div className='bg-white w-[520px] rounded-lg shadow-lg p-8'>
        <h2 className='text-3xl font-bold text-center text-servineo-500 mb-1'>
          <span className='text-servineo-400'>Servineo</span>
        </h2>
        <p className='text-2xl font-bold text-center text-servineo-500 mb-6'>Authenticator App</p>
        <p className='block text-sm font-semibold text-gray-600 mb-2'>
          Debe de tener configurado su app Authenticator
        </p>
        <p className='block text-sm font-semibold text-gray-600 mb-4'>
          Para el ingreso sin contraseña, ingrese su correo electrónico
        </p>
        <label className='block text-sm font-semibold text-gray-600 mb-2'>
          Correo electrónico*
        </label>
        <input
          type='email'
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          placeholder='Ingrese su correo electrónico'
          className='w-full border border-gray-300 rounded-xl p-3.5 text-gray-800 focus:outline-none focus:ring-2 focus:ring-servineo-400 transition mb-2'
        />

        {errorMessage && (
          <p className='text-red-600 text-sm font-semibold mb-4 transition-opacity duration-1000'>
            {errorMessage}
          </p>
        )}

        <div className='mt-6 flex justify-end gap-3'>
          <button
            onClick={setShowModal}
            className='flex-1 rounded-md bg-[#E5F4FB] px-4 py-2 text-[#1A223F] font-semibold hover:bg-[#2BDDE0]/20'
          >
            Cancelar
          </button>

          <button
            onClick={handleContinuar}
            className='flex-1 rounded-md bg-[#1A223F] px-4 py-2 text-white font-semibold hover:bg-[#2B31E0]'
          >
            Continuar
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/requester/Authenticator/AuthenticatorTOTPModal.tsx">
'use client';

import { useState } from 'react';
import { api, ApiResponse } from '../../../app/redux/services/api';

interface AuthenticatorTOTPModalProps {
  showModal: boolean;
  setShowModal: () => void;
  regresarSesionModal: () => void;
  abrirModalCodigo: () => void;
  email: string;
}

interface VerifyTOTPData {
  token?: string;
  user?: {
    _id: string;
    email: string;
    name: string;
    picture?: string | null;
  };
  firstTime?: boolean;
}

export default function AuthenticatorTOTPModal({
  showModal,
  setShowModal,
  regresarSesionModal,
  abrirModalCodigo,
  email,
}: AuthenticatorTOTPModalProps) {
  const [code, setCode] = useState('');
  const [errorMsg, setErrorMsg] = useState('');
  const [shake, setShake] = useState(false);
  const [loading, setLoading] = useState(false);

  if (!showModal) return null;

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const onlyNumbers = e.target.value.replace(/\D/g, '');
    setCode(onlyNumbers.slice(0, 6));
    setErrorMsg('');
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!code || code.length !== 6) {
      setErrorMsg('Ingrese un código válido de 6 dígitos');
      setShake(true);
      setTimeout(() => setShake(false), 500);
      return;
    }

    try {
      setLoading(true);
      const res: ApiResponse<VerifyTOTPData> = await api.post('/2fa-ingresar/verify-totp', {
        email,
        code,
      });
      if (!res.success) {
        setErrorMsg(res.error || 'Código incorrecto');
        setShake(true);
        setTimeout(() => setShake(false), 500);
        return;
      }

      if (!res.data || !res.data.token || !res.data.user) {
        setErrorMsg('Respuesta inválida del servidor');
        return;
      }

      const { token, user } = res.data;

      if (token) localStorage.setItem('servineo_token', token);
      if (user) {
        localStorage.setItem('servineo_user', JSON.stringify(user));
        sessionStorage.setItem('toastMessage', `¡Bienvenido, ${user.name}!`);
      }

      setShowModal();
      window.location.href = '/';
    } catch (err) {
      console.error('Error al verificar TOTP:', err);
      const errorMessage = err instanceof Error ? err.message : 'Error de servidor';
      setErrorMsg(errorMessage);
      setShake(true);
      setTimeout(() => setShake(false), 500);
    } finally {
      setLoading(false);
    }
  };

  const handleVolver = () => {
    setShowModal();
    regresarSesionModal();
  };

  const colors = [
    'text-blue-500',
    'text-red-500',
    'text-yellow-500',
    'text-blue-500',
    'text-green-500',
    'text-red-500',
    'text-yellow-500',
  ];
  const text = 'Google Authenticator';

  return (
    <div className='fixed inset-0 z-50 flex items-center justify-center bg-black/60'>
      <div className='bg-white w-[520px] rounded-lg shadow-lg p-8'>
        <h2 className='text-3xl font-bold text-center text-servineo-500 mb-1'>
          <span className='text-servineo-400'>Servineo</span>
        </h2>

        <p className='text-2xl font-bold text-center text-servineo-500 mb-6'>Authenticator App</p>

        <p className='block text-sm font-semibold text-gray-600 mb-10'>Bienvenido {email}!!</p>

        <p className='text-center mb-6 text-2xl font-bold'>
          {text.split('').map((char, idx) => {
            const colorClass = colors[idx % colors.length];
            return (
              <span key={idx} className={colorClass}>
                {char}
              </span>
            );
          })}
        </p>

        {/* FORMULARIO PRINCIPAL */}
        <form
          onSubmit={handleSubmit}
          className={`bg-white rounded-lg w-[420px] p-6 shadow-lg border mx-auto transition-all duration-300 ${shake ? 'animate-shake border-red-400' : ''}`}
        >
          <h3 className='text-lg font-semibold mb-2 text-center'>
            Ingresa el código de autenticador
          </h3>
          <p className='text-sm text-gray-600 mb-4 text-center'>
            Introduce los 6 dígitos que muestra tu app de autenticación.
          </p>

          <input
            autoFocus
            inputMode='numeric'
            pattern='\d{6}'
            maxLength={6}
            value={code}
            onChange={handleChange}
            className={`w-full p-2 border rounded mb-2 font-mono text-lg text-center tracking-widest transition-all ${
              errorMsg ? 'border-red-500 bg-red-50' : 'border-gray-300'
            }`}
            placeholder='••••••'
          />

          {errorMsg && (
            <div className='text-red-600 text-sm mb-3 text-center font-medium'>{errorMsg}</div>
          )}

          <div className='flex gap-4 mt-4'>
            <button
              type='button'
              onClick={handleVolver}
              className='flex-1 rounded-md bg-[#E5F4FB] px-4 py-2 text-[#1A223F] font-semibold hover:bg-[#2BDDE0]/20'
            >
              Volver
            </button>

            <button
              type='submit'
              disabled={loading}
              className='flex-1 rounded-md bg-[#1A223F] px-4 py-2 text-white font-semibold hover:bg-[#2B31E0]'
            >
              {loading ? 'Validando...' : 'Ingresar'}
            </button>
          </div>
        </form>

        {/* TEXTO + BOTÓN PARA ABRIR MODAL DE RECUPERACIÓN */}
        <p className='text-center text-sm text-gray-600 mt-4'>
          Si no tienes acceso a Google Authenticator
        </p>

        <div className='text-center mt-2'>
          <button
            type='button'
            onClick={abrirModalCodigo}
            className='text-servineo-400 hover:text-servineo-500 font-medium hover:underline transition'
          >
            Ingresar con código de recuperación
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/requester/Authenticator/ConfirmDisableModal.tsx">
'use client';
import React, { useState, useEffect } from 'react';

interface Props {
  open: boolean;
  onCancel: () => void;
  onConfirm: () => Promise<void> | void;
  onFinish?: () => void; // nuevo: callback al cerrar tras éxito
  loading?: boolean;
}

/**
 * Modal bonito con confirmación y mensaje de éxito.
 */
export default function ConfirmDisableModal({
  open,
  onCancel,
  onConfirm,
  onFinish,
  loading,
}: Props) {
  const [done, setDone] = useState(false);

  // Reinicia el estado cada vez que se abre
  useEffect(() => {
    if (open) setDone(false);
  }, [open]);

  if (!open) return null;

  return (
    <div className='fixed inset-0 z-50 flex items-center justify-center bg-black/40'>
      <div className='bg-white rounded-lg w-[560px] p-6 shadow-lg border transition-all duration-200'>
        {!done ? (
          <>
            <div className='flex items-start gap-4'>
              <div className='flex-shrink-0'>
                <div className='w-12 h-12 rounded-full bg-red-50 flex items-center justify-center border border-red-100'>
                  <svg
                    className='w-6 h-6 text-red-600'
                    viewBox='0 0 24 24'
                    fill='none'
                    stroke='currentColor'
                  >
                    <path
                      strokeWidth='1.5'
                      strokeLinecap='round'
                      strokeLinejoin='round'
                      d='M3 6h18M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6M10 6V4a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2'
                    />
                  </svg>
                </div>
              </div>

              <div className='flex-1'>
                <h3 className='text-lg font-semibold'>Desactivar autenticador</h3>
                <p className='text-sm text-gray-600 mt-1'>
                  ¿Estás seguro de que quieres desactivar la autenticación en dos pasos? Esto
                  eliminará tu clave secreta y los códigos de recuperación asociados.
                </p>

                <div className='mt-5 flex justify-end gap-3'>
                  <button
                    onClick={onCancel}
                    className='px-4 py-2 rounded-md border text-sm bg-white text-gray-700'
                    disabled={loading}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={async () => {
                      await onConfirm();
                      setDone(true);
                    }}
                    className='px-4 py-2 rounded-md text-sm bg-red-600 text-white'
                    disabled={loading}
                  >
                    {loading ? 'Desactivando...' : 'Desactivar 2FA'}
                  </button>
                </div>
              </div>
            </div>
          </>
        ) : (
          // ✅ Mensaje de éxito
          <div className='flex flex-col items-center justify-center text-center py-6'>
            <div className='w-12 h-12 rounded-full bg-green-100 flex items-center justify-center mb-4'>
              <svg
                className='w-6 h-6 text-green-600'
                fill='none'
                stroke='currentColor'
                viewBox='0 0 24 24'
              >
                <path
                  strokeLinecap='round'
                  strokeLinejoin='round'
                  strokeWidth={2}
                  d='M5 13l4 4L19 7'
                />
              </svg>
            </div>
            <h3 className='text-lg font-semibold text-gray-800 mb-1'>
              Autenticador desactivado correctamente
            </h3>
            <p className='text-sm text-gray-600 mb-6'>
              Ya puedes volver a configurar la autenticación cuando quieras desde esta misma página.
            </p>
            <button
              onClick={() => {
                onCancel(); // cierra modal
                if (onFinish) onFinish(); // notifica al padre para limpiar estado
              }}
              className='px-4 py-2 rounded-md text-sm bg-indigo-600 text-white'
            >
              Aceptar
            </button>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/Components/requester/Authenticator/RecoveryModal.tsx">
'use client';
import React from 'react';

interface Props {
  open: boolean;
  codes: string[] | null;
  onClose: () => void; // si el usuario cancela
  onConfirm: () => void; // cuando el usuario confirma que guardó los códigos
}

export default function RecoveryModal({ open, codes, onConfirm }: Props) {
  if (!open) return null;

  const handleCopyAll = async () => {
    if (!codes || codes.length === 0) return;
    const all = codes.join('\n');
    try {
      await navigator.clipboard.writeText(all);
      // feedback breve
      alert('Todos los códigos han sido copiados al portapapeles');
    } catch {
      // fallback si clipboard falla
      prompt('Copia manualmente los códigos (Ctrl+C):', all);
    }
  };

  return (
    <div className='fixed inset-0 z-50 flex items-center justify-center bg-black/40'>
      <div className='bg-white rounded-lg w-[560px] p-6 shadow-lg border'>
        <h3 className='text-lg font-semibold mb-2'>Códigos de recuperación</h3>
        <p className='text-sm text-gray-600 mb-4'>
          Guarda estos códigos en un lugar seguro. Se mostrarán <strong>una sola vez</strong>. Cada
          código sirve para recuperar tu cuenta si pierdes el acceso al autenticador.
        </p>

        <div className='grid grid-cols-2 gap-3 mb-4'>
          {codes && codes.length > 0 ? (
            codes.map((c) => (
              <div key={c} className='flex items-center justify-between p-3 rounded bg-gray-50'>
                <code className='font-mono text-sm break-all'>{c}</code>
              </div>
            ))
          ) : (
            <div className='col-span-2 text-sm text-gray-500'>No hay códigos para mostrar.</div>
          )}
        </div>

        <div className='flex justify-between items-center'>
          <button
            onClick={handleCopyAll}
            className='px-3 py-2 rounded border text-sm bg-white text-gray-700'
            disabled={!codes || codes.length === 0}
          >
            Copiar todos
          </button>

          <div className='flex gap-3'>
            <button
              onClick={onConfirm}
              className='px-4 py-2 rounded text-sm bg-indigo-600 text-white'
            >
              He guardado los códigos (OK)
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/requester/botonRegistro/buttonDiscord.tsx">
'use client';
import { FaDiscord } from 'react-icons/fa';
import { useRouter } from 'next/navigation';
import { useState } from 'react';
import { useAuth } from '@/Components/requester/auth/usoAutentificacion';

interface DiscordButtonProps {
  onNotify?: (n: {
    type: 'success' | 'error' | 'info' | 'warning';
    title: string;
    message: string;
  }) => void;

  captchaValid: boolean;
}

export default function DiscordButton({ onNotify, captchaValid }: DiscordButtonProps) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const { setUser } = useAuth();

  const API_URL = process.env.NEXT_PUBLIC_API_URL;

  const handleDiscord = () => {
    if (!captchaValid) {
      onNotify?.({
        type: 'warning',
        title: 'Completa la verificación',
        message: 'Debes completar el captcha antes de continuar.',
      });
      return;
    }

    setLoading(true);

    const popup = window.open(`${API_URL}/auth/discord`, 'DiscordLogin', 'width=600,height=700');

    if (!popup) {
      setLoading(false);
      onNotify?.({
        type: 'error',
        title: 'Error al abrir ventana',
        message: 'No se pudo abrir el popup de Discord.',
      });
      return;
    }

    const handleMessage = (event: MessageEvent) => {
      if (event.origin !== API_URL) return;
      const data = event.data;

      // ---- ÉXITO ----
      if (data.type === 'DISCORD_AUTH_SUCCESS') {
        onNotify?.({
          type: 'success',
          title: 'Inicio de sesión exitoso',
          message: `Bienvenido ${data.user?.name || ''}`,
        });

        localStorage.setItem('servineo_token', data.token);

        if (data.user) {
          localStorage.setItem('servineo_user', JSON.stringify(data.user));
          setUser(data.user);
        }

        popup.close();
        window.removeEventListener('message', handleMessage);
        setLoading(false);

        setTimeout(() => {
          if (data.isFirstTime) {
            router.push('/signUp/registrar/registroUbicacion');
          } else {
            setTimeout(() => {
              window.location.href = '/';
            }, 2000);
          }
        }, 2000);
      }

      // ---- ERROR ----
      if (data.type === 'DISCORD_AUTH_ERROR') {
        onNotify?.({
          type: 'error',
          title: 'Error de autenticación',
          message: data.message || 'No se pudo autenticar con Discord',
        });

        popup.close();
        window.removeEventListener('message', handleMessage);
        setLoading(false);
      }
    };

    window.addEventListener('message', handleMessage);
  };

  return (
    <button
      onClick={handleDiscord}
      disabled={loading}
      className={`flex items-center gap-2 bg-[#5865F2] text-white font-semibold py-2 px-4 rounded-lg transition
        ${!captchaValid ? 'opacity-50 cursor-not-allowed' : 'hover:opacity-90'}
      `}
    >
      <FaDiscord size={20} />
      {loading ? 'Cargando...' : 'Continuar con Discord'}
    </button>
  );
}
</file>

<file path="src/Components/requester/botonRegistro/buttonGithub.tsx">
'use client';
import React, { useState } from 'react';
import { FaGithub } from 'react-icons/fa';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/Components/requester/auth/usoAutentificacion';

interface GithubButtonProps {
  onNotify?: (n: {
    type: 'success' | 'error' | 'info' | 'warning';
    title: string;
    message: string;
  }) => void;

  captchaValid: boolean;
}

export default function GithubButton({ onNotify, captchaValid }: GithubButtonProps) {
  const [loading, setLoading] = useState(false);
  const router = useRouter();
  const BASE_URL = process.env.NEXT_PUBLIC_API_URL;
  const { setUser } = useAuth();

  const handleGithub = () => {
    if (!captchaValid) {
      onNotify?.({
        type: 'warning',
        title: 'Completa la verificación',
        message: 'Debes completar el captcha antes de continuar.',
      });
      return;
    }

    setLoading(true);

    const popup = window.open(`${BASE_URL}/auth/github`, 'GitHubLogin', 'width=600,height=700');

    if (!popup) {
      setLoading(false);
      onNotify?.({
        type: 'error',
        title: 'Error al abrir ventana',
        message: 'No se pudo abrir el popup de GitHub.',
      });
      return;
    }

    const handleMessage = (event: MessageEvent) => {
      if (event.origin !== BASE_URL) return;
      const data = event.data;

      if (data.type === 'GITHUB_AUTH_SUCCESS') {
        onNotify?.({
          type: 'success',
          title: 'Inicio de sesión exitoso',
          message: `Bienvenido ${data.user?.name || ''}`,
        });

        localStorage.setItem('servineo_token', data.token);

        if (data.user) {
          localStorage.setItem('servineo_user', JSON.stringify(data.user));
          setUser(data.user);
        }

        if (data.isFirstTime) {
          onNotify?.({
            type: 'info',
            title: 'Bienvenido',
            message: 'Primera vez en Servineo. Completa tu perfil para continuar.',
          });
        }

        window.removeEventListener('message', handleMessage);
        setLoading(false);
        popup.close();

        setTimeout(() => {
          if (data.isFirstTime) {
            router.push('/signUp/registrar/registroUbicacion');
          } else {
            setTimeout(() => {
              window.location.href = '/';
            }, 2000);
          }
        }, 2000);
      }

      if (data.type === 'GITHUB_AUTH_ERROR') {
        onNotify?.({
          type: 'error',
          title: 'Error de autenticación',
          message: data.message || 'No se pudo autenticar con GitHub',
        });

        window.removeEventListener('message', handleMessage);
        setLoading(false);
        popup.close();
      }
    };

    window.addEventListener('message', handleMessage);
  };

  return (
    <button
      onClick={handleGithub}
      disabled={loading}
      className={`flex items-center gap-2 bg-white border border-gray-300 
        font-semibold py-2 px-4 rounded-lg shadow-sm text-black transition-colors
        ${!captchaValid ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'}
      `}
    >
      <FaGithub size={24} className='text-black' />
      {loading ? 'Cargando...' : 'Continuar con GitHub'}
    </button>
  );
}
</file>

<file path="src/Components/requester/botonRegistro/buttonGoogle.tsx">
'use client';

import { GoogleLogin, CredentialResponse } from '@react-oauth/google';
import { FcGoogle } from 'react-icons/fc';

interface GoogleButtonProps {
  onLoginSuccess: (credentialResponse: CredentialResponse) => void;
  disabled?: boolean;
  onDisabledClick?: () => void;
}

export default function GoogleButton({
  onLoginSuccess,
  disabled,
  onDisabledClick,
}: GoogleButtonProps) {
  return (
    <div className='relative inline-block'>
      <button
        className={`flex items-center gap-2 bg-white border border-gray-300 
          font-semibold py-2 px-4 rounded-lg shadow-sm text-black transition-colors
          ${disabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'}
        `}
      >
        <FcGoogle size={24} />
        Continuar con Google
      </button>

      {disabled ? (
        <div className='absolute inset-0 cursor-not-allowed' onClick={() => onDisabledClick?.()} />
      ) : (
        <div className='absolute inset-0 opacity-0 cursor-pointer'>
          <GoogleLogin
            onSuccess={onLoginSuccess}
            onError={() => console.log('Error al iniciar sesión con Google')}
          />
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/Components/requester/botonRegistro/recaptcha.tsx">
'use client';

import { useRef } from 'react';
import ReCAPTCHA from 'react-google-recaptcha';

interface ReCaptchaFormProps {
  onVerified?: (success: boolean) => void;
}

const ReCaptchaForm: React.FC<ReCaptchaFormProps> = ({ onVerified }) => {
  const captchaRef = useRef<ReCAPTCHA>(null);

  const verifyBackend = async (token: string) => {
    try {
      const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/signUp/verify-recaptcha`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token }),
      });

      const data = await res.json();

      onVerified?.(data.success);
    } catch (err) {
      console.error('Error comunicando con backend:', err);
      onVerified?.(false);
    }
  };

  return (
    <div>
      <ReCAPTCHA
        ref={captchaRef}
        sitekey={process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY!}
        onChange={(token) => {
          if (token) {
            verifyBackend(token);
          }
        }}
        onExpired={() => {
          onVerified?.(false);
          captchaRef.current?.reset();
        }}
      />
    </div>
  );
};

export default ReCaptchaForm;
</file>

<file path="src/Components/requester/mapas/Mapa.tsx">
'use client';

import { useEffect, useState, useRef } from 'react';
import { MapContainer, TileLayer, Marker, Circle, Popup, useMap } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import L from 'leaflet';
import { enviarUbicacion } from '@/app/redux/services/auth/registro';

const customIcon = new L.Icon({
  iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
  iconSize: [35, 35],
  iconAnchor: [17, 35],
});

function MoveMapToPosition({ position }: { position: [number, number] }) {
  const map = useMap();
  useEffect(() => {
    if (position) map.setView(position, 15);
  }, [position, map]);
  return null;
}

export default function MapaLeaflet() {
  const [position, setPosition] = useState<[number, number] | null>(null);
  const [ubicacionPermitida, setUbicacionPermitida] = useState<boolean | null>(null);
  const [direccion, setDireccion] = useState<string | null>(null);
  const [departamento, setDepartamento] = useState<string | null>(null);
  const [pais, setPais] = useState<string | null>(null);
  const [cargandoDireccion, setCargandoDireccion] = useState(false);

  const ejecutado = useRef(false);

  useEffect(() => {
    if (ejecutado.current) return;
    ejecutado.current = true;

    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const { latitude, longitude } = pos.coords;
          setPosition([latitude, longitude]);
          setUbicacionPermitida(true);
          try {
            setCargandoDireccion(true);
            const res = await fetch(
              `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&addressdetails=1`,
            );
            const data = await res.json();

            if (data) {
              const dep = data.address?.state || null;
              const country = data.address?.country || null;
              let dir = data.display_name || null;

              if (dir) {
                if (dep) dir = dir.replace(new RegExp(`,?\\s*${dep}`, 'gi'), '');
                if (country) dir = dir.replace(new RegExp(`,?\\s*${country}`, 'gi'), '');
                dir = dir.replace(/,\s*$/, '');
              }

              setDireccion(dir);
              setDepartamento(dep);
              setPais(country);
            }
          } catch (error) {
            console.error('Error obteniendo dirección:', error);
          } finally {
            setCargandoDireccion(false);
          }
        },
        (error) => {
          console.warn('No se pudo obtener la ubicación:', error.message);
          setUbicacionPermitida(false);
          setPosition([0, 0]);
          setDireccion(null);
          setDepartamento(null);
          setPais(null);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 },
      );
    } else {
      console.warn('El navegador no soporta geolocalización.');
      setUbicacionPermitida(false);
      setPosition([0, 0]);
      setDireccion(null);
      setDepartamento(null);
      setPais(null);
    }
  }, []);

  const manejarEnvio = async () => {
    try {
      if (cargandoDireccion) {
        return;
      }

      await enviarUbicacion(
        position?.[0] || 0,
        position?.[1] || 0,
        direccion || null,
        departamento || null,
        pais || null,
      );

      window.location.href = '/signUp/registrar/registrarTelefono';
    } catch (error) {
      console.error(error);
    }
  };

  return (
    <div style={{ position: 'relative', width: '100%' }}>
      <div
        style={{
          background: 'white',
          borderRadius: '1rem',
          boxShadow: '0 4px 15px rgba(0,0,0,0.15)',
          padding: '1.5rem',
          maxWidth: '700px',
          margin: '2rem auto',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
        }}
      >
        <h2
          style={{
            width: '100%',
            textAlign: 'left',
            fontSize: '1.4rem',
            fontWeight: '600',
            borderBottom: '1px solid #ccc',
            marginBottom: '1rem',
            paddingBottom: '0.3rem',
            color: '#222',
          }}
        >
          Ubicación
        </h2>

        <div
          style={{
            width: '100%',
            height: '60vh',
            borderRadius: '0.8rem',
            overflow: 'hidden',
            marginBottom: '1.5rem',
          }}
        >
          <MapContainer
            center={position || [-17.3895, -66.1568]}
            zoom={position ? 14 : 5}
            style={{ height: '100%', width: '100%' }}
          >
            <TileLayer
              url='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
              attribution='&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
            />
            {position && ubicacionPermitida && <MoveMapToPosition position={position} />}
            {position && ubicacionPermitida && (
              <>
                <Marker position={position} icon={customIcon}>
                  <Popup>Tu ubicación actual</Popup>
                </Marker>
                <Circle
                  center={position}
                  radius={1000}
                  pathOptions={{
                    color: '#2B6AE0',
                    fillColor: '#cce0ff',
                    fillOpacity: 0.3,
                  }}
                />
              </>
            )}
          </MapContainer>
        </div>

        <button
          style={{
            backgroundColor: '#2B6AE0',
            color: 'white',
            padding: '0.8rem 1.8rem',
            border: 'none',
            borderRadius: '0.6rem',
            fontWeight: '600',
            fontSize: '1rem',
            cursor: 'pointer',
            transition: '0.2s',
            boxShadow: '0 3px 10px rgba(43,106,224,0.3)',
          }}
          onMouseEnter={(e) => (e.currentTarget.style.backgroundColor = '#1AA7ED')}
          onMouseLeave={(e) => (e.currentTarget.style.backgroundColor = '#2B6AE0')}
          onClick={manejarEnvio}
        >
          {cargandoDireccion ? 'Obteniendo dirección...' : 'Continuar'}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/requester/mapas/MapaLeaflet.tsx">
'use client';

import { useEffect, useState, useRef } from 'react';
import { MapContainer, TileLayer, Marker, Circle, Popup, useMap } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import L from 'leaflet';
import { useAuth } from '../auth/usoAutentificacion';
import { enviarUbicacion, enviarTokenGoogle } from '@/app/redux/services/auth/registro';
import { useParams } from 'next/navigation';

const customIcon = new L.Icon({
  iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
  iconSize: [35, 35],
  iconAnchor: [17, 35],
});

function MoveMapToPosition({ position }: { position: [number, number] }) {
  const map = useMap();
  useEffect(() => {
    if (position) map.setView(position, 15);
  }, [position, map]);
  return null;
}

export default function MapaLeaflet() {
  const params = useParams();
  const locale = params.locale;

  const [position, setPosition] = useState<[number, number] | null>(null);
  const [ubicacionPermitida, setUbicacionPermitida] = useState<boolean | null>(null);
  const [direccion, setDireccion] = useState<string | null>(null);
  const [departamento, setDepartamento] = useState<string | null>(null);
  const [pais, setPais] = useState<string | null>(null);
  const [cargandoDireccion, setCargandoDireccion] = useState(false);

  const ejecutado = useRef(false);
  const { setUser } = useAuth();

  useEffect(() => {
    if (ejecutado.current) return;
    ejecutado.current = true;

    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const { latitude, longitude } = pos.coords;
          setPosition([latitude, longitude]);
          setUbicacionPermitida(true);

          try {
            setCargandoDireccion(true);
            const res = await fetch(
              `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&addressdetails=1`,
            );
            const data = await res.json();

            if (data) {
              const dep = data.address?.state || null;
              const country = data.address?.country || null;
              let dir = data.display_name || null;

              if (dir) {
                if (dep) dir = dir.replace(new RegExp(`,?\\s*${dep}`, 'gi'), '');
                if (country) dir = dir.replace(new RegExp(`,?\\s*${country}`, 'gi'), '');
                dir = dir.replace(/,\s*$/, '');
              }

              setDireccion(dir);
              setDepartamento(dep);
              setPais(country);
            }
          } catch (error) {
            console.error('Error obteniendo dirección:', error);
          } finally {
            setCargandoDireccion(false);
          }
        },
        (error) => {
          console.warn('No se pudo obtener la ubicación:', error.message);
          setUbicacionPermitida(false);
          setPosition([0, 0]);
          setDireccion(null);
          setDepartamento(null);
          setPais(null);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 },
      );
    } else {
      console.warn('El navegador no soporta geolocalización.');
      setUbicacionPermitida(false);
      setPosition([0, 0]);
      setDireccion(null);
      setDepartamento(null);
      setPais(null);
    }
  }, []);

  const manejarEnvio = async () => {
    try {
      if (cargandoDireccion) return;

      let token = localStorage.getItem('servineo_token');

      if (!token) {
        const googleToken = sessionStorage.getItem('google_token_temp');
        if (!googleToken) return;

        const data = await enviarTokenGoogle(googleToken);
        if (data.token && data.user) {
          token = data.token;
          localStorage.setItem('servineo_token', data.token);
          localStorage.setItem('servineo_user', JSON.stringify(data.user));
          setUser(data.user);
          sessionStorage.removeItem('google_token_temp');
        } else {
          return;
        }
      }

      await enviarUbicacion(
        position?.[0] || 0,
        position?.[1] || 0,
        direccion || null,
        departamento || null,
        pais || null,
      );

      //redireccion telefono
      window.location.href = `/${locale}/signUp/registrar/telefono`;
    } catch (error) {
      console.error(error);
    }
  };

  return (
    <div style={{ position: 'relative', width: '100%' }}>
      <div
        style={{
          background: 'white',
          borderRadius: '1rem',
          boxShadow: '0 4px 15px rgba(0,0,0,0.15)',
          padding: '1.5rem',
          maxWidth: '700px',
          margin: '2rem auto',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
        }}
      >
        <h2
          style={{
            width: '100%',
            textAlign: 'left',
            fontSize: '1.4rem',
            fontWeight: '600',
            borderBottom: '1px solid #ccc',
            marginBottom: '1rem',
            paddingBottom: '0.3rem',
            color: '#222',
          }}
        >
          Ubicación
        </h2>

        <div
          style={{
            width: '100%',
            height: '60vh',
            borderRadius: '0.8rem',
            overflow: 'hidden',
            marginBottom: '1.5rem',
          }}
        >
          <MapContainer
            center={position || [-17.3895, -66.1568]}
            zoom={position ? 14 : 5}
            style={{ height: '100%', width: '100%' }}
          >
            <TileLayer
              url='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
              attribution='&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
            />
            {position && ubicacionPermitida && <MoveMapToPosition position={position} />}
            {position && ubicacionPermitida && (
              <>
                <Marker position={position} icon={customIcon}>
                  <Popup>Tu ubicación actual</Popup>
                </Marker>
                <Circle
                  center={position}
                  radius={1000}
                  pathOptions={{
                    color: '#2B6AE0',
                    fillColor: '#cce0ff',
                    fillOpacity: 0.3,
                  }}
                />
              </>
            )}
          </MapContainer>
        </div>

        <button
          style={{
            backgroundColor: '#2B6AE0',
            color: 'white',
            padding: '0.8rem 1.8rem',
            border: 'none',
            borderRadius: '0.6rem',
            fontWeight: '600',
            fontSize: '1rem',
            cursor: 'pointer',
            transition: '0.2s',
            boxShadow: '0 3px 10px rgba(43,106,224,0.3)',
          }}
          onClick={manejarEnvio}
        >
          {cargandoDireccion ? 'Obteniendo dirección...' : 'Continuar'}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/requester/profile/UserProfileSummary.tsx">
'use client';
import { useEffect, useState } from 'react';
import { MapPin, Phone, Mail, Lock } from 'lucide-react';
import { IUser } from '@/types/user';

export default function UserProfileSummary() {
  const [user, setUser] = useState<IUser | null>(null);

  useEffect(() => {
    const loadUser = () => {
      const raw = localStorage.getItem('servineo_user');
      setUser(raw ? JSON.parse(raw) : null);
    };

    loadUser();

    window.addEventListener('servineo_user_updated', loadUser);
    window.addEventListener('storage', loadUser);

    return () => {
      window.removeEventListener('servineo_user_updated', loadUser);
      window.removeEventListener('storage', loadUser);
    };
  }, []);

  const userPhoto =
    user?.photo?.trim() ||
    user?.picture?.trim() ||
    user?.url_photo?.trim() ||
    '/icons/marcador-de-posicion.png';

  return (
    <div className='rounded-2xl p-6 shadow-lg bg-white/70 backdrop-blur-xl border border-white/30 max-w-full'>
      {/* FOTO + NOMBRE */}
      <div className='flex flex-col items-center'>
        {/* CONTENEDOR DE FOTO MEJORADO */}
        <div className='w-32 h-32 rounded-full overflow-hidden shadow-xl border-4 border-white/90 bg-white'>
          <img
            src={userPhoto}
            alt={user?.name ?? 'Usuario'}
            className='w-full h-full object-cover object-center'
            onError={(e) => {
              (e.currentTarget as HTMLImageElement).src = '/es/img/icon.png';
            }}
          />
        </div>

        <h3 className='text-xl font-bold text-[#1A223F] mt-4'>{user?.name ?? 'Usuario'}</h3>

        <p className='text-sm text-gray-500'>{user?.email ?? '—'}</p>
      </div>

      {/* SEPARADOR */}
      <div className='w-full h-px bg-gray-200 my-6' />

      {/* INFORMACIÓN */}
      <div className='space-y-4 text-sm text-[#1A223F]'>
        {/* TELÉFONO */}
        <div className='flex items-center gap-3 p-2 bg-white rounded-xl shadow-inner'>
          <Phone size={18} className='text-primary' />
          <span className='flex-1'>
            {user?.telefono ?? <span className='text-gray-400'>Sin teléfono</span>}
          </span>
        </div>

        {/* UBICACIÓN 
        <div className="flex items-start gap-3 p-2 bg-white rounded-xl shadow-inner">
          <MapPin size={18} className="text-primary mt-1" />
          <span className="flex-1 leading-tight">
            {user?.ubicacion?.direccion ? (
              <>
                <span className="font-medium">{user.ubicacion.direccion}</span>
                <br />
                <span className="text-xs text-gray-400">
                  {user.ubicacion.departamento} · {user.ubicacion.pais}
                </span>
              </>
            ) : (
              <span className="text-gray-400">Sin ubicación</span>
            )}
          </span>
        </div>*/}

        {/* CONTRASEÑA */}
        <div className='flex items-center gap-3 p-2 bg-white rounded-xl shadow-inner'>
          <Lock size={18} className='text-primary' />
          <span className='flex-1'>••••••••••••</span>
        </div>
      </div>

      {/* SEPARADOR */}
      <div className='w-full h-px bg-gray-200 my-6' />

      {/* INFORMACIÓN EXTRA */}
      <div className='mt-4 p-4 rounded-xl bg-gradient-to-br from-white to-white/60 border border-white shadow-inner'>
        <strong className='block mb-1 text-primary text-sm'>¿Sabías qué?</strong>
        <p className='text-gray-600 text-sm leading-snug'>
          Mantener tu foto y ubicación actualizadas mejora las recomendaciones y tu visibilidad
          dentro de la plataforma.
        </p>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/requester/request/ChangePasswordForm.tsx">
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { cambiarContrasena } from '../../../app/redux/services/editPassword';
import { cerrarTodasSesiones } from '../../../app/redux/services/logoutService';
import { Eye, EyeOff, Loader2 } from 'lucide-react';
import { obtenerUltimoCambio } from '../../../app/redux/services/getLastChange';

// 🎯 ESQUEMA DE VALIDACIÓN CON ZOD
const changePasswordSchema = z
  .object({
    currentPassword: z
      .string()
      .min(1, 'Ingresa tu contraseña actual')
      .refine((val) => !val.includes(' '), 'No puede contener espacios'),

    newPassword: z
      .string()
      .min(8, 'Mínimo 8 caracteres')
      .regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/, {
        message: 'Debe tener mayúscula, minúscula y número',
      })
      .refine((val) => !val.includes(' '), 'No puede contener espacios'),

    confirmPassword: z.string().min(1, 'Confirma tu nueva contraseña'),
  })
  .refine((data) => data.newPassword === data.confirmPassword, {
    message: 'Las contraseñas no coinciden',
    path: ['confirmPassword'],
  })
  .refine((data) => data.currentPassword !== data.newPassword, {
    message: 'La nueva contraseña debe ser diferente a la actual',
    path: ['newPassword'],
  });

type ChangePasswordFormData = z.infer<typeof changePasswordSchema>;

type Props = {
  onCancel?: () => void;
  onSaved?: () => void;
};

export default function ChangePasswordForm({ onCancel }: Props) {
  const router = useRouter();

  // 🎯 REACT HOOK FORM + ZOD
  const {
    register,
    handleSubmit,
    reset,
    formState: { errors, isSubmitting },
    clearErrors,
  } = useForm<ChangePasswordFormData>({
    resolver: zodResolver(changePasswordSchema),
    mode: 'onChange', // Validación en tiempo real
  });

  // Estados para UI
  const [showCurrentPassword, setShowCurrentPassword] = useState(false);
  const [showNewPassword, setShowNewPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [apiError, setApiError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  const [showSuggestionModal, setShowSuggestionModal] = useState(false);
  const [ultimaModificacion, setUltimaModificacion] = useState<string>('');
  const [cargandoFecha, setCargandoFecha] = useState(true);
  const handlePaste = (e: React.ClipboardEvent) => {
    e.preventDefault();
    // Opcional: mostrar mensaje al usuario
    setApiError('Por seguridad, no se permite pegar en los campos de contraseña');
  };

  // Resto de useEffect igual...
  useEffect(() => {
    const cargarUltimoCambio = async () => {
      try {
        setCargandoFecha(true);
        const resultado = await obtenerUltimoCambio();
        setUltimaModificacion(resultado.fechaFormateada);
      } catch (error) {
        console.error('Error al cargar último cambio:', error);
        setUltimaModificacion('No disponible');
      } finally {
        setCargandoFecha(false);
      }
    };
    cargarUltimoCambio();
  }, []);

  const actualizarFecha = async () => {
    try {
      const resultado = await obtenerUltimoCambio();
      setUltimaModificacion(resultado.fechaFormateada);
    } catch (error) {
      console.error('Error al actualizar fecha:', error);
    }
  };

  // 🎯 SUBMIT HANDLER SIMPLIFICADO
  const onSubmit = async (data: ChangePasswordFormData) => {
    setApiError(null);
    setSuccess(null);

    const token = localStorage.getItem('servineo_token');
    if (!token) {
      setApiError('No hay sesión activa. Por favor, inicia sesión.');
      return;
    }

    try {
      const result = await cambiarContrasena(data);

      if (result.success) {
        setSuccess('Contraseña actualizada exitosamente');
        reset(); // Limpiar formulario
        //onSaved?.();
        await actualizarFecha();
        setTimeout(() => setShowSuggestionModal(true), 500);
      } else {
        setApiError(result.message || 'El cambio no se completó, error inesperado.');

        if (result.forceLogout) {
          return;
        }
      }
    } catch (err: unknown) {
      if (err instanceof Error) {
        console.error('Error al cambiar contraseña:', err.message);
        if (err.message.includes('NetworkError') || err.message.includes('Failed to fetch')) {
          setApiError('El cambio no se completó, error de conexión.');
        } else {
          setApiError(err.message || 'El cambio no se completó, error inesperado.');
        }
      } else {
        console.error('Error desconocido:', err);
        setApiError('El cambio no se completó, error inesperado.');
      }
    } finally {
      setTimeout(() => {
        setApiError(null);
        setSuccess(null);
      }, 10000);
    }
  };

  return (
    <div className='relative flex flex-col gap-6 rounded-lg border border-[#E5F4FB] bg-white p-6 shadow-sm transition-all duration-300'>
      <h1 className="text-2xl font-bold text-[#1A223F] mb-5 text-left">
        Cambiar Contraseña
      </h1>
      <p className='text-sm text-gray-400 mb-2'>
        Elige una contraseña segura y no la utilices en otras cuentas.
      </p>

      <form onSubmit={handleSubmit(onSubmit)} className='flex flex-col gap-4'>
        {/* Contraseña actual */}
        <div>
          <label
            htmlFor='currentPassword'
            className='block text-sm font-semibold text-[#1A223F] mb-2 text-left'
          >
            Contraseña actual
          </label>
          <div className='relative'>
            <input
              id='currentPassword'
              type={showCurrentPassword ? 'text' : 'password'}
              {...register('currentPassword')}
              placeholder='Ingresa tu contraseña actual'
              className={`w-full rounded-md border px-3 py-2 text-[#1A223F] placeholder-gray-400 focus:outline-none focus:ring-1 ${
                errors.currentPassword
                  ? 'border-red-500 focus:border-red-500 focus:ring-red-500'
                  : 'border-[#E5F4FB] bg-[#F5FAFE] focus:border-[#2BDDE0] focus:ring-[#2BDDE0]'
              }`}
              disabled={isSubmitting}
              onPaste={handlePaste}
              onChange={() => {
                clearErrors();
                setApiError(null);
              }}
            />
            <button
              type='button'
              onClick={() => setShowCurrentPassword(!showCurrentPassword)}
              className='absolute inset-y-0 right-0 flex items-center pr-3'
            >
              {showCurrentPassword ? <EyeOff size={18} /> : <Eye size={18} />}
            </button>
          </div>
          {errors.currentPassword && (
            <p className='text-sm text-red-600 mt-1'>{errors.currentPassword.message}</p>
          )}
        </div>

        {/* Nueva contraseña */}
        <div>
          <label
            htmlFor='newPassword'
            className='block text-sm font-semibold text-[#1A223F] mb-2 text-left'
          >
            Nueva contraseña
          </label>
          <div className='relative'>
            <input
              id='newPassword'
              type={showNewPassword ? 'text' : 'password'}
              {...register('newPassword')}
              placeholder='Mínimo 8 caracteres, mayúscula, minúscula, número'
              className={`w-full rounded-md border px-3 py-2 text-[#1A223F] placeholder-gray-400 focus:outline-none focus:ring-1 ${
                errors.newPassword
                  ? 'border-red-500 focus:border-red-500 focus:ring-red-500'
                  : 'border-[#E5F4FB] bg-[#F5FAFE] focus:border-[#2BDDE0] focus:ring-[#2BDDE0]'
              }`}
              disabled={isSubmitting}
              onPaste={handlePaste}
              onChange={() => {
                clearErrors();
                setApiError(null);
              }}
            />
            <button
              type='button'
              onClick={() => setShowNewPassword(!showNewPassword)}
              className='absolute inset-y-0 right-0 flex items-center pr-3'
            >
              {showNewPassword ? <EyeOff size={18} /> : <Eye size={18} />}
            </button>
          </div>
          {errors.newPassword && (
            <p className='text-sm text-red-600 mt-1'>{errors.newPassword.message}</p>
          )}
        </div>

        {/* Confirmar contraseña */}
        <div>
          <label
            htmlFor='confirmPassword'
            className='block text-sm font-semibold text-[#1A223F] mb-2 text-left'
          >
            Confirmar nueva contraseña
          </label>
          <div className='relative'>
            <input
              id='confirmPassword'
              type={showConfirmPassword ? 'text' : 'password'}
              {...register('confirmPassword')}
              placeholder='Repita su nueva contraseña'
              className={`w-full rounded-md border px-3 py-2 text-[#1A223F] placeholder-gray-400 focus:outline-none focus:ring-1 ${
                errors.confirmPassword
                  ? 'border-red-500 focus:border-red-500 focus:ring-red-500'
                  : 'border-[#E5F4FB] bg-[#F5FAFE] focus:border-[#2BDDE0] focus:ring-[#2BDDE0]'
              }`}
              disabled={isSubmitting}
              onPaste={handlePaste}
              onChange={() => {
                clearErrors();
                setApiError(null);
              }}
            />
            <button
              type='button'
              onClick={() => setShowConfirmPassword(!showConfirmPassword)}
              className='absolute inset-y-0 right-0 flex items-center pr-3'
            >
              {showConfirmPassword ? <EyeOff size={18} /> : <Eye size={18} />}
            </button>
          </div>
          {errors.confirmPassword && (
            <p className='text-sm text-red-600 mt-1'>{errors.confirmPassword.message}</p>
          )}
        </div>

        {/* Mensajes de API */}
        {apiError && (
          <div
            className={`rounded-md p-3 text-sm transition-opacity duration-1000 ease-out ${
              apiError.includes('bloqueada') ||
              apiError.includes('Demasiados intentos') ||
              apiError.includes('restantes')
                ? 'bg-red-100 border border-red-300 text-red-800'
                : 'bg-red-50 text-red-700'
            }`}
          >
            {(apiError.includes('bloqueada') || apiError.includes('Demasiados intentos')) && (
              <div className='flex items-center gap-2 mb-2'>
                <span className='text-lg'>🔒</span>
                <strong>Seguridad Activada</strong>
              </div>
            )}
            {apiError.includes('restantes') && (
              <div className='flex items-center gap-2 mb-1'>
                <span className='text-lg'>⚠️</span>
                <strong>Atención</strong>
              </div>
            )}
            {apiError}
          </div>
        )}

        {success && (
          <div className='rounded-md bg-green-50 p-3 text-sm text-green-700 transition-opacity duration-1000 ease-out flex items-center gap-2'>
            <span className='text-lg'>✅</span>
            {success}
          </div>
        )}

        {/* Resto del componente igual... */}
        <div className='mt-2 p-4 bg-gray-50 rounded-lg border border-gray-200'>
          <div className='flex items-center gap-2'>
            <span className='text-sm font-medium text-gray-700'>Última modificación:</span>
            {cargandoFecha ? (
              <div className='flex items-center gap-1'>
                <Loader2 size={14} className='animate-spin' />
                <span className='text-sm text-gray-500'>Cargando...</span>
              </div>
            ) : (
              <span className='text-sm text-gray-600'>{ultimaModificacion}</span>
            )}
          </div>
        </div>

        {/* Botones */}
        <div className='pt-4 flex justify-end gap-3'>
          <button
            type='submit'
            disabled={isSubmitting}
            className='flex items-center gap-2 rounded-md bg-[#1A223F] px-4 py-2 text-white font-semibold hover:bg-[#2B31E0] disabled:bg-[#759AE0]'
          >
            {isSubmitting ? (
              <>
                <Loader2 size={14} className='animate-spin' /> Guardando...
              </>
            ) : (
              'Cambiar contraseña'
            )}
          </button>
          <button
            type='button'
            onClick={() => (onCancel ? onCancel() : router.back())}
            disabled={isSubmitting}
            className='rounded-md bg-[#E5F4FB] px-4 py-2 text-[#1A223F] font-semibold hover:bg-[#2BDDE0]/20'
          >
            Cancelar
          </button>
        </div>
      </form>

      {/* Modal igual... */}
      {showSuggestionModal && (
        <div className='fixed inset-0 z-50 flex items-center justify-center bg-black/60'>
          <div className='bg-white w-[520px] rounded-lg shadow-lg overflow-hidden'>
            <div
              className='text-center text-white font-semibold py-4 text-lg'
              style={{
                background: 'linear-gradient(135deg, #2B31E0 0%, #1AA7ED 50%, #5E2BE0 100%)',
              }}
            >
              Sugerencia
            </div>
            <div className='p-6 text-center text-[#1A223F] text-base'>
              Servineo te recomienda cerrar todas las sesiones activas de tus dispositivos.
            </div>
            <div className='flex justify-between px-6 pb-6 gap-6'>
              <button
                onClick={() => router.push('/')}
                className='flex-1 rounded-md bg-[#E5F4FB] px-4 py-2 text-[#1A223F] font-semibold hover:bg-[#2BDDE0]/20'
              >
                No, cerrar sesiones
              </button>
              <button
                onClick={async () => {
                  try {
                    const result = await cerrarTodasSesiones();
                    console.log('✅ Resultado:', result.message);
                    localStorage.removeItem('servineo_token');
                    localStorage.removeItem('servineo_user');
                    window.location.href = '/';
                  } catch (error) {
                    console.error('❌ Error al cerrar sesiones:', error);
                    alert('No se pudo cerrar todas las sesiones. Intenta nuevamente.');
                  }
                }}
                className='flex-1 rounded-md bg-[#1A223F] px-4 py-2 text-white font-semibold hover:bg-[#2B31E0]'
              >
                Sí, cerrar sesiones
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/Components/requester/request/RequesterEditForm.tsx">
'use client';

import { useState, useEffect } from 'react';
import { Eye, EyeOff, Pencil, Loader2, Crosshair } from 'lucide-react';
import { useRouter } from 'next/navigation';
import dynamic from 'next/dynamic';
import {
  obtenerDatosUsuarioLogueado,
  actualizarDatosUsuario,
} from '../../../app/redux/services/editNumber';

const MapContainer = dynamic(() => import('react-leaflet').then((m) => m.MapContainer), {
  ssr: false,
});
const TileLayer = dynamic(() => import('react-leaflet').then((m) => m.TileLayer), { ssr: false });

type LatLng = { lat: number; lng: number };
type Ubicacion = {
  lat: number;
  lng: number;
  direccion: string;
  departamento: string;
  pais: string;
};

export default function RequesterEditForm() {
  const router = useRouter();
  const [telefono, setTelefono] = useState('');
  const [ubicacion, setUbicacion] = useState<Ubicacion>({
    lat: 0,
    lng: 0,
    direccion: '',
    departamento: '',
    pais: '',
  });
  const [latLng, setLatLng] = useState<LatLng | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [errorTelefono, setErrorTelefono] = useState<string | null>(null);
  const [showTelefono, setShowTelefono] = useState(false);
  const [isEditingTelefono, setIsEditingTelefono] = useState(false);
  const [mapReady, setMapReady] = useState(false);

  useEffect(() => {
    async function cargarDatos() {
      try {
        const userData = await obtenerDatosUsuarioLogueado();
        setTelefono(userData.telefono || '');
        setUbicacion(
          userData.ubicacion || {
            lat: 0,
            lng: 0,
            direccion: '',
            departamento: '',
            pais: '',
          },
        );

        if (userData.ubicacion?.lat && userData.ubicacion?.lng) {
          setLatLng({
            lat: userData.ubicacion.lat,
            lng: userData.ubicacion.lng,
          });
        }
      } catch (err: unknown) {
        if (err instanceof Error) setError(err.message);
        else setError('Error al cargar tus datos.');
      }
    }
    cargarDatos();
  }, []);

  useEffect(() => {
    if (typeof window !== 'undefined') {
      import('leaflet').then((L) => {
        delete (L.Icon.Default.prototype as unknown as { _getIconUrl?: string })._getIconUrl;
        L.Icon.Default.mergeOptions({
          iconRetinaUrl: '/marker-icon-2x.png',
          iconUrl: '/marker-icon.png',
          shadowUrl: '/marker-shadow.png',
        });
      });
    }
  }, []);

  function validarTelefono(valor: string): boolean {
    if (valor.length < 8 || valor.length > 15) return false;
    if (valor.startsWith('+')) return /^[+][0-9]{7,14}$/.test(valor);
    return /^[0-9]{8,15}$/.test(valor);
  }

  function handleTelefonoChange(e: React.ChangeEvent<HTMLInputElement>) {
    let valor = e.target.value;
    if (valor.startsWith('+')) valor = '+' + valor.slice(1).replace(/[^0-9]/g, '');
    else valor = valor.replace(/[^0-9]/g, '');
    setTelefono(valor);
    setErrorTelefono(null);
    setError(null);
  }

  async function fetchAddress(lat: number, lng: number): Promise<void> {
    try {
      const res = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`,
      );
      const data = await res.json();
      const { country, state, road, suburb, city, town } = data.address || {};

      setUbicacion({
        lat,
        lng,
        direccion: [road, suburb, city || town].filter(Boolean).join(', ') || '',
        departamento: state || '',
        pais: country || '',
      });
    } catch {
      setUbicacion((prev) => ({
        ...prev,
        lat,
        lng,
        direccion: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
      }));
    }
  }

  function handleGetLocation(): void {
    if (!navigator.geolocation) {
      setError('Tu navegador no soporta geolocalización');
      return;
    }
    setError(null);
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        setLatLng(coords);
        fetchAddress(coords.lat, coords.lng);
      },
      () => setError('No se pudo obtener tu ubicación'),
      { enableHighAccuracy: true },
    );
  }

  const LocationMarker = dynamic(
    async () => {
      const { useMap, useMapEvents, Marker } = await import('react-leaflet');
      const { useEffect } = await import('react');

      interface Props {
        latLng: LatLng | null;
        onChange: (coords: LatLng) => void;
      }

      const Component = ({ latLng, onChange }: Props) => {
        const map = useMap();

        useMapEvents({
          click(e) {
            const newCoords = { lat: e.latlng.lat, lng: e.latlng.lng };
            onChange(newCoords);
            map.flyTo(e.latlng, map.getZoom(), { animate: true });
          },
        });

        useEffect(() => {
          if (latLng) {
            map.flyTo([latLng.lat, latLng.lng], map.getZoom(), { animate: true });
          }
        }, [latLng, map]);

        return latLng ? <Marker position={[latLng.lat, latLng.lng]} /> : null;
      };

      return Component;
    },
    { ssr: false },
  );

  async function handleSubmit(e: React.FormEvent<HTMLFormElement>): Promise<void> {
    e.preventDefault();
    if (loading) return;
    setError(null);

    if (!validarTelefono(telefono)) {
      setError('Ingrese un número de teléfono válido');
      return;
    }

    setLoading(true);
    try {
      const result = await actualizarDatosUsuario({ telefono, ubicacion });

      if (!result.success) {
        if (result.code === 'PHONE_TAKEN') {
          setErrorTelefono('Este número ya está registrado');
          setError(null);
          setLoading(false);
          return;
        }
        throw new Error(result.message);
      }

      alert('Perfil actualizado correctamente');
      setIsEditingTelefono(false);
    } catch (err: unknown) {
      if (err instanceof Error) setError(err.message);
      else setError('Error al actualizar perfil');
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="max-w-2xl mx-auto">
      <h1 className="text-2xl font-bold text-[#1A223F] mb-5 text-left">
        Editar perfil
      </h1>

      <form
        onSubmit={handleSubmit}
        className="space-y-6 bg-white rounded-2xl p-8"
        aria-busy={loading}
      >
        <div>
          <label className="block text-sm font-semibold mb-1 text-[#1A223F] text-left">
            Número de teléfono:
          </label>
          <div className="flex items-center gap-2">
            <input
              type={showTelefono ? 'text' : 'password'}
              value={telefono}
              disabled={!isEditingTelefono}
              onChange={handleTelefonoChange}
              placeholder="+591 7xxxxxxx"
              autoComplete="tel"
              className={`flex-1 rounded-md border px-3 py-2 focus:outline-none focus:ring-2 transition text-black ${
                isEditingTelefono
                  ? 'bg-white border-[#759AE0] focus:ring-[#1AA7ED]'
                  : 'bg-[#F5FAFE] border-[#E5F4FB] cursor-not-allowed'
              }`}
            />
            <button
              type="button"
              onClick={() => setShowTelefono((p) => !p)}
              className="p-2 rounded-md border border-[#E5F4FB] bg-[#F5FAFE] hover:bg-[#E5F4FB] transition"
            >
              {showTelefono ? <EyeOff size={18} /> : <Eye size={18} />}
            </button>
            <button
              type="button"
              onClick={() => {
                setIsEditingTelefono((p) => !p);
                setErrorTelefono(null);
              }}
              className={`p-2 rounded-md border transition ${
                isEditingTelefono
                  ? 'border-[#1A223F] bg-[#E5F4FB]'
                  : 'border-[#E5F4FB] bg-[#F5FAFE] hover:bg-[#E5F4FB]'
              }`}
            >
              <Pencil size={18} />
            </button>
          </div>
          {errorTelefono && (
            <p className="text-sm text-red-600 mt-1" role="alert">
              {errorTelefono}
            </p>
          )}
        </div>

        <div>
          <label className="block text-sm font-semibold mb-1 text-[#1A223F] text-left">
            Ubicación:
          </label>
          <div className="flex items-center gap-2">
            <input
              value={ubicacion.direccion || ''}
              disabled
              placeholder="País, ciudad, departamento"
              className="flex-1 rounded-md border px-3 py-2 bg-[#F5FAFE] border-[#E5F4FB] cursor-not-allowed text-black"
            />
            <button
              type="button"
              onClick={handleGetLocation}
              className="p-2 rounded-md border border-[#E5F4FB] bg-[#F5FAFE] hover:bg-[#2BDDE0]/20 transition"
            >
              <Crosshair size={18} color="#2BDDE0" />
            </button>
          </div>
          <span className="text-xs text-[#759AE0]">
            Haz clic en el botón GPS o en el mapa para seleccionar tu ubicación
          </span>
        </div>

        <div>
          <label className="block text-sm font-semibold mb-1 text-[#1A223F]">
            Mapa
          </label>
          <div className="w-full h-64 border border-[#E5F4FB] rounded-lg overflow-hidden bg-gradient-to-br from-[#F5FAFE] to-[#E5F4FB] relative">
            <MapContainer
              center={latLng ? [latLng.lat, latLng.lng] : [-16.5, -68.15]}
              zoom={13}
              style={{ height: '100%', width: '100%' }}
              whenReady={() => setMapReady(true)}
            >
              <TileLayer
                attribution="&copy; OpenStreetMap contributors"
                url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
              />
              {mapReady && (
                <LocationMarker
                  latLng={latLng}
                  onChange={(coords: LatLng) => {
                    setLatLng(coords);
                    fetchAddress(coords.lat, coords.lng);
                  }}
                />
              )}
            </MapContainer>
            {!mapReady && (
              <span className="absolute inset-0 flex items-center justify-center text-gray-600">
                Cargando mapa...
              </span>
            )}
          </div>
        </div>

        {error && (
          <p className="text-sm text-red-600" role="alert">
            {error}
          </p>
        )}

        <div className="pt-4 flex justify-end gap-3">
          <button
            type="submit"
            disabled={loading}
            className="flex items-center gap-2 rounded-md bg-[#1A223F] px-4 py-2 text-white font-semibold hover:bg-[#2B31E0] disabled:bg-[#759AE0]"
          >
            {loading ? (
              <>
                <Loader2 size={14} className="animate-spin" /> Guardando...
              </>
            ) : (
              'Guardar'
            )}
          </button>
          <button
            type="button"
            onClick={() => router.back()}
            className="rounded-md bg-[#E5F4FB] px-4 py-2 text-[#1A223F] font-semibold hover:bg-[#2BDDE0]/20"
          >
            Cancelar
          </button>
        </div>
      </form>
    </div>
  );
}
</file>

<file path="src/Components/requester/telefono/RegistroTelefono.tsx">
'use client';

import { useState } from 'react';
import * as registroService from '@/app/redux/services/auth/registro';
import { useParams, usePathname } from 'next/navigation';

//Configuración de países
const PAISES_LATAM = [
  {
    codigo: '+591',
    pais: 'Bolivia',
    bandera: '🇧🇴',
    longitudMin: 8,
    longitudMax: 8,
    ejemplo: '71234567',
  },
  {
    codigo: '+54',
    pais: 'Argentina',
    bandera: '🇦🇷',
    longitudMin: 10,
    longitudMax: 10,
    ejemplo: '1123456789',
  },
  {
    codigo: '+56',
    pais: 'Chile',
    bandera: '🇨🇱',
    longitudMin: 9,
    longitudMax: 9,
    ejemplo: '912345678',
  },
  {
    codigo: '+57',
    pais: 'Colombia',
    bandera: '🇨🇴',
    longitudMin: 10,
    longitudMax: 10,
    ejemplo: '3001234567',
  },
  {
    codigo: '+593',
    pais: 'Ecuador',
    bandera: '🇪🇨',
    longitudMin: 9,
    longitudMax: 9,
    ejemplo: '991234567',
  },
  {
    codigo: '+51',
    pais: 'Perú',
    bandera: '🇵🇪',
    longitudMin: 9,
    longitudMax: 9,
    ejemplo: '987654321',
  },
  {
    codigo: '+52',
    pais: 'México',
    bandera: '🇲🇽',
    longitudMin: 10,
    longitudMax: 10,
    ejemplo: '5512345678',
  },
  {
    codigo: '+58',
    pais: 'Venezuela',
    bandera: '🇻🇪',
    longitudMin: 10,
    longitudMax: 10,
    ejemplo: '4121234567',
  },
  {
    codigo: '+595',
    pais: 'Paraguay',
    bandera: '🇵🇾',
    longitudMin: 9,
    longitudMax: 9,
    ejemplo: '981234567',
  },
  {
    codigo: '+598',
    pais: 'Uruguay',
    bandera: '🇺🇾',
    longitudMin: 8,
    longitudMax: 9,
    ejemplo: '91234567',
  },
  {
    codigo: '+507',
    pais: 'Panamá',
    bandera: '🇵🇦',
    longitudMin: 8,
    longitudMax: 8,
    ejemplo: '61234567',
  },
  {
    codigo: '+506',
    pais: 'Costa Rica',
    bandera: '🇨🇷',
    longitudMin: 8,
    longitudMax: 8,
    ejemplo: '87654321',
  },
  {
    codigo: '+503',
    pais: 'El Salvador',
    bandera: '🇸🇻',
    longitudMin: 8,
    longitudMax: 8,
    ejemplo: '71234567',
  },
  {
    codigo: '+502',
    pais: 'Guatemala',
    bandera: '🇬🇹',
    longitudMin: 8,
    longitudMax: 8,
    ejemplo: '51234567',
  },
  {
    codigo: '+504',
    pais: 'Honduras',
    bandera: '🇭🇳',
    longitudMin: 8,
    longitudMax: 8,
    ejemplo: '91234567',
  },
  {
    codigo: '+505',
    pais: 'Nicaragua',
    bandera: '🇳🇮',
    longitudMin: 8,
    longitudMax: 8,
    ejemplo: '81234567',
  },
];

export default function RegistroTelefono() {
  const params = useParams();
  const pathname = usePathname();

  // Detectar si viene del flujo o registro manual
  const locale = params.locale || null;
  const esRegistroManual = pathname?.includes('/signUp/registrar');

  const [phoneNumber, setPhoneNumber] = useState('');
  const [countryCode, setCountryCode] = useState('+591');
  const [cargando, setCargando] = useState(false);
  const [error, setError] = useState('');

  // Obtener configuración del país seleccionado
  const paisSeleccionado = PAISES_LATAM.find((p) => p.codigo === countryCode);

  const formatPhoneNumber = (value: string) => {
    const numbers = value.replace(/\D/g, '');
    return numbers;
  };

  const validarTelefono = () => {
    if (!paisSeleccionado) return false;

    const longitud = phoneNumber.length;

    if (longitud < paisSeleccionado.longitudMin) {
      setError(`El número debe tener al menos ${paisSeleccionado.longitudMin} dígitos`);
      return false;
    }

    if (longitud > paisSeleccionado.longitudMax) {
      setError(`El número debe tener máximo ${paisSeleccionado.longitudMax} dígitos`);
      return false;
    }

    setError('');
    return true;
  };

  const manejarEnvio = async () => {
    try {
      // Validar formato antes de enviar
      if (!validarTelefono()) {
        return;
      }

      setCargando(true);
      setError('');

      const token = localStorage.getItem('servineo_token');
      if (!token) {
        setError('No hay sesión activa');
        return;
      }

      // Enviar teléfono
      const telefonoCompleto = `${countryCode}${phoneNumber}`;
      const response = await registroService.enviarTelefono(telefonoCompleto);

      if (response.success) {
        //Redirigir según el flujo
        if (esRegistroManual) {
          window.location.href = '/'; // Registro manual
        } else if (locale) {
          window.location.href = `/${locale}`;
        } else {
          window.location.href = '/';
        }
      }
    } catch (error) {
      console.error('Error guardando teléfono:', error);

      // Manejar errores específicos
      if (error instanceof Error) {
        if (error.message.includes('409') || error.message.includes('ya está registrado')) {
          setError('El número ya está registrado, use otro');
        } else {
          setError('Error de conexión. Intente nuevamente');
        }
      } else {
        setError('Error desconocido. Intente nuevamente');
      }
    } finally {
      setCargando(false);
    }
  };

  const esTelefonoValido = phoneNumber.length >= (paisSeleccionado?.longitudMin || 8);

  return (
    <div style={{ position: 'relative', width: '100%' }}>
      <div
        style={{
          background: 'white',
          borderRadius: '1rem',
          boxShadow: '0 4px 15px rgba(0,0,0,0.15)',
          padding: '1.5rem',
          maxWidth: '500px',
          margin: '2rem auto',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
        }}
      >
        {/* Ícono */}
        <div
          style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            width: '64px',
            height: '64px',
            backgroundColor: '#E3F2FD',
            borderRadius: '50%',
            marginBottom: '1rem',
          }}
        >
          <svg
            width='32'
            height='32'
            viewBox='0 0 24 24'
            fill='none'
            stroke='#2B6AE0'
            strokeWidth='2'
            strokeLinecap='round'
            strokeLinejoin='round'
          >
            <path d='M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z' />
          </svg>
        </div>

        <h2
          style={{
            fontSize: '1.5rem',
            fontWeight: '700',
            color: '#222',
            marginBottom: '0.5rem',
            textAlign: 'center',
          }}
        >
          Un paso más
        </h2>

        <p
          style={{
            color: '#666',
            textAlign: 'center',
            marginBottom: '2rem',
            fontSize: '0.95rem',
          }}
        >
          Por favor, ingresa tu número de teléfono para completar tu registro
        </p>

        {/* Código de país */}
        <div style={{ width: '100%', marginBottom: '1rem' }}>
          <label
            style={{
              display: 'block',
              fontSize: '0.875rem',
              fontWeight: '500',
              color: '#333',
              marginBottom: '0.5rem',
            }}
          >
            País de residencia
          </label>
          <select
            value={countryCode}
            onChange={(e) => {
              setCountryCode(e.target.value);
              setPhoneNumber('');
              setError('');
            }}
            style={{
              width: '100%',
              padding: '0.75rem 1rem',
              border: '1px solid #ddd',
              borderRadius: '0.5rem',
              fontSize: '1rem',
              backgroundColor: 'white',
              cursor: 'pointer',
              outline: 'none',
            }}
          >
            {PAISES_LATAM.map((pais) => (
              <option key={pais.codigo} value={pais.codigo}>
                {pais.bandera} {pais.pais} ({pais.codigo})
              </option>
            ))}
          </select>
        </div>

        {/* Número de teléfono */}
        <div style={{ width: '100%', marginBottom: '1rem' }}>
          <label
            style={{
              display: 'block',
              fontSize: '0.875rem',
              fontWeight: '500',
              color: '#333',
              marginBottom: '0.5rem',
            }}
          >
            Número de teléfono
          </label>
          <div style={{ display: 'flex', gap: '0.5rem' }}>
            <div
              style={{
                width: '80px',
                padding: '0.75rem 1rem',
                backgroundColor: '#f5f5f5',
                border: '1px solid #ddd',
                borderRadius: '0.5rem',
                textAlign: 'center',
                fontWeight: '500',
                color: '#333',
              }}
            >
              {countryCode}
            </div>
            <input
              type='tel'
              value={phoneNumber}
              onChange={(e) => {
                setPhoneNumber(formatPhoneNumber(e.target.value));
                setError('');
              }}
              onBlur={validarTelefono}
              placeholder={paisSeleccionado?.ejemplo || '71234567'}
              maxLength={paisSeleccionado?.longitudMax || 15}
              style={{
                flex: 1,
                padding: '0.75rem 1rem',
                border: `1px solid ${error ? '#f44336' : '#ddd'}`,
                borderRadius: '0.5rem',
                fontSize: '1rem',
                outline: 'none',
              }}
            />
          </div>
          <p
            style={{
              fontSize: '0.75rem',
              color: '#999',
              marginTop: '0.25rem',
            }}
          >
            Ejemplo: {paisSeleccionado?.ejemplo} ({paisSeleccionado?.longitudMin}-
            {paisSeleccionado?.longitudMax} dígitos)
          </p>
        </div>

        {/* Mensaje de error */}
        {error && (
          <div
            style={{
              width: '100%',
              backgroundColor: '#FFEBEE',
              border: '1px solid #EF5350',
              borderRadius: '0.5rem',
              padding: '0.75rem',
              marginBottom: '1rem',
            }}
          >
            <p style={{ fontSize: '0.875rem', color: '#C62828', margin: 0 }}>⚠️ {error}</p>
          </div>
        )}

        {/* Vista previa */}
        <div
          style={{
            width: '100%',
            backgroundColor: '#E3F2FD',
            border: '1px solid #BBDEFB',
            borderRadius: '0.5rem',
            padding: '0.75rem',
            marginBottom: '1.5rem',
          }}
        >
          <p style={{ fontSize: '0.875rem', color: '#1976D2', margin: 0 }}>
            <strong>Número completo:</strong> {countryCode} {phoneNumber || '________'}
          </p>
        </div>

        {/* Botón */}
        <button
          onClick={manejarEnvio}
          disabled={cargando || !esTelefonoValido}
          style={{
            width: '100%',
            backgroundColor: cargando || !esTelefonoValido ? '#ccc' : '#2B6AE0',
            color: 'white',
            padding: '0.8rem 1.8rem',
            border: 'none',
            borderRadius: '0.6rem',
            fontWeight: '600',
            fontSize: '1rem',
            cursor: cargando || !esTelefonoValido ? 'not-allowed' : 'pointer',
            transition: '0.2s',
            boxShadow: '0 3px 10px rgba(43,106,224,0.3)',
          }}
          onMouseEnter={(e) => {
            if (!cargando && esTelefonoValido) e.currentTarget.style.backgroundColor = '#1AA7ED';
          }}
          onMouseLeave={(e) => {
            if (!cargando && esTelefonoValido) e.currentTarget.style.backgroundColor = '#2B6AE0';
          }}
        >
          {cargando ? 'Guardando...' : 'Finalizar'}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/ResultsAdvSearch/AppliedFilters.tsx">
'use client';
import React from 'react';
import { useRouter } from 'next/navigation';
import { useTranslations } from 'next-intl';
import { DB_TO_TRANSLATION_KEY } from '@/app/redux/contants';

type NoResultsMessageProps = {
  search: string;
};

export const NoResultsMessage: React.FC<NoResultsMessageProps> = ({ search }) => {
  const t = useTranslations('search');
  const trimmed = search?.trim();

  return (
    <div className='text-center py-12'>
      <p className='text-gray-500 text-xl font-roboto font-normal'>
        {t('noResults')}
        {trimmed && (
          <>
            {' '}
            {t('for')} <span className='font-bold'>&quot;{trimmed}&quot;</span>
          </>
        )}
      </p>
    </div>
  );
};

type FilterParamValue = string | string[] | number | boolean | null;

interface Props {
  params: Record<string, FilterParamValue>;
  onModify?: () => void;
}

function formatPriceString(s: string) {
  if (!s) return s;
  return s.replace(/\$\s*([0-9]+(?:\.\d+)?)/g, '$1bs');
}

export default function AppliedFilters({ params, onModify }: Props) {
  const router = useRouter();
  const t = useTranslations('search');
  const tAdv = useTranslations('advancedSearch');

  const translateDbValue = (value: string): string => {
    const translationKey = DB_TO_TRANSLATION_KEY[value as keyof typeof DB_TO_TRANSLATION_KEY];
    if (translationKey) {
      return tAdv(translationKey as Parameters<typeof tAdv>[0]);
    }
    return value;
  };

  const handleModify = () => {
    if (onModify) return onModify();
    const sp = new URLSearchParams();
    Object.entries(params).forEach(([k, val]) => {
      if (val == null) return;
      if (Array.isArray(val)) {
        val.forEach((v) => sp.append(k, String(v)));
      } else {
        sp.set(k, String(val));
      }
    });
    router.push(`/adv-search?${sp.toString()}`);
  };

  const renderTranslatedValue = (v: FilterParamValue): string | null => {
    if (v == null) return null;

    if (Array.isArray(v)) {
      const translated = v.map((item) => translateDbValue(String(item)));
      return translated.join(', ');
    }

    return translateDbValue(String(v));
  };

  return (
    <div className='w-full max-w-5xl mx-auto mt-6 px-4'>
      <div className="bg-white border rounded-lg shadow-sm p-4 flex items-center justify-between font-['Roboto'] text-sm">
        <div>
          <p className='text-sm font-semibold text-gray-700'>{t('searchPlaceholder')}</p>
          <div className='mt-2 flex flex-wrap gap-2'>
            {(() => {
              const minRaw = params['minPrice'] as FilterParamValue;
              const maxRaw = params['maxPrice'] as FilterParamValue;
              const tags: React.ReactNode[] = [];

              const hasMin = minRaw != null && minRaw !== '';
              const hasMax = maxRaw != null && maxRaw !== '';

              if (hasMin || hasMax) {
                const minN = Number(minRaw);
                const maxN = Number(maxRaw);
                const minValid = !Number.isNaN(minN);
                const maxValid = !Number.isNaN(maxN);
                let text = '';
                if (minValid && maxValid) {
                  text = `${t('price')}: ${minN}bs - ${maxN}bs`;
                } else if (minValid && !maxValid) {
                  text = `${t('price')}: ${t('moreThan')} ${minN}bs`;
                } else if (!minValid && maxValid) {
                  text = `${t('price')}: ${t('lessThan')} ${maxN}bs`;
                }

                tags.push(
                  <span
                    key='price'
                    className='inline-block bg-sky-50 text-sky-500 text-sm px-3 py-1 rounded'
                  >
                    {text}
                  </span>,
                );
              }

              Object.entries(params).forEach(([k, v]) => {
                if (k === 'minPrice' || k === 'maxPrice') return;

                if (k === 'sortBy' && typeof v === 'string') {
                  const txt =
                    v === 'recent' ? t('mostRecent') : v === 'oldest' ? t('oldest') : String(v);
                  tags.push(
                    <span
                      key={k}
                      className='inline-block bg-sky-50 text-sky-500 text-sm px-3 py-1 rounded'
                    >
                      {txt}
                    </span>,
                  );
                  return;
                }

                if (k === 'titleOnly' && v === true) {
                  tags.push(
                    <span
                      key={k}
                      className='inline-block bg-sky-50 text-sky-500 text-sm px-3 py-1 rounded'
                    >
                      {t('titleOnly')}
                    </span>,
                  );
                  return;
                }

                if (k === 'exact' && v === true) {
                  tags.push(
                    <span
                      key={k}
                      className='inline-block bg-sky-50 text-sky-500 text-sm px-3 py-1 rounded'
                    >
                      {t('exactWords')}
                    </span>,
                  );
                  return;
                }

                if (k === 'date' && typeof v === 'string') {
                  const m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                  const dateLabel = m ? `${m[3]}/${m[2]}/${m[1]}` : String(v);
                  tags.push(
                    <span
                      key={k}
                      className='inline-block bg-sky-50 text-sky-500 text-sm px-3 py-1 rounded'
                    >
                      {`${t('date')}: ${dateLabel}`}
                    </span>,
                  );
                  return;
                }

                if (k === 'rating' && (typeof v === 'number' || typeof v === 'string')) {
                  const ratingNum = typeof v === 'string' ? parseFloat(v) : v;
                  if (!Number.isNaN(ratingNum)) {
                    tags.push(
                      <span
                        key={k}
                        className='inline-block bg-sky-50 text-sky-500 text-sm px-3 py-1 rounded'
                      >
                        {`Calificación: ${ratingNum.toFixed(1)}`}
                      </span>,
                    );
                    return;
                  }
                }

                let value = renderTranslatedValue(v as FilterParamValue);
                if (!value) return;
                if (value.includes('$')) value = formatPriceString(value);

                tags.push(
                  <span
                    key={k}
                    className='inline-block bg-sky-50 text-sky-500 text-sm px-3 py-1 rounded'
                  >
                    {value}
                  </span>,
                );
              });

              return tags;
            })()}
          </div>
        </div>

        <div className='flex items-center mt-3'>
          <button
            type='button'
            onClick={handleModify}
            className='bg-[#2B6AE0] text-white hover:bg-[#2B6AE0]/90 px-4 py-2 text-sm sm:text-base font-roboto font-semibold rounded shadow transition-all duration-200'
          >
            {t('modify')}
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/SearchHeader.tsx">
'use client';

import { useState, useRef, useEffect } from 'react';
import { useTranslations } from 'next-intl';
import { useAppDispatch, useAppSelector } from '@/app/redux/hooks';
import {
  setSearchQuery,
  addRecentSearch,
  clearRecentSearches,
  selectSearchQuery,
  selectRecentSearches,
  setSidebarOpen,
  selectSidebarOpen,
  autoSelectJobType,
  clearJobTypeSelection,
  autoSelectCity,
  clearCitySelection,
} from '../app/redux/slice/filterSlice';
import { useJobTypeAutoMatch } from '@/lib/useJobTypeAutoMatch';
import { Search, Settings2, Trash2, X, Clock, FilterIcon } from 'lucide-react';

export function SearchHeader() {
  const t = useTranslations('search');
  const { findMatchingJobType, findMatchingCity } = useJobTypeAutoMatch();

  const dispatch = useAppDispatch();
  const searchQuery = useAppSelector(selectSearchQuery);
  const recentSearches = useAppSelector(selectRecentSearches);
  const sidebarOpen = useAppSelector(selectSidebarOpen);
  const [showRecent, setShowRecent] = useState(false);
  const searchRef = useRef<HTMLDivElement>(null);

  // Close dropdown when clicking outside
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (searchRef.current && !searchRef.current.contains(event.target as Node)) {
        setShowRecent(false);
      }
    }

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const handleSearchChange = (query: string) => {
    dispatch(setSearchQuery(query));

    const matchedJobType = findMatchingJobType(query);
    if (matchedJobType) {
      dispatch(autoSelectJobType(matchedJobType));
    } else {
      dispatch(clearJobTypeSelection());
    }

    const matchedCity = findMatchingCity(query);
    if (matchedCity) {
      dispatch(autoSelectCity(matchedCity));
    } else {
      dispatch(clearCitySelection());
    }
  };

  const handleSearch = (query: string) => {
    dispatch(setSearchQuery(query));
    if (query.trim()) {
      dispatch(addRecentSearch(query));
    }
    setShowRecent(false);
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (searchQuery.trim()) {
      dispatch(addRecentSearch(searchQuery));
    }
    setShowRecent(false);
  };

  return (
    <div className='space-y-3 w-full'>
      <form onSubmit={handleSubmit} className='flex items-center gap-3'>
        <button
          type='button'
          onClick={() => dispatch(setSidebarOpen(!sidebarOpen))}
          className='p-2.5 hover:bg-primary/10 rounded-lg transition-all hover:scale-110 border-2 border-border'
          title={t('openFilters')}
        >
          <FilterIcon className='w-5 h-5' />
        </button>

        <div className='flex-1 relative group' ref={searchRef}>
          <div className='relative'>
            <Search className='absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground group-focus-within:text-primary transition-colors' />
            <input
              type='text'
              placeholder={t('placeholder')}
              value={searchQuery}
              onChange={(e) => handleSearchChange(e.target.value)}
              onFocus={() => setShowRecent(true)}
              className='w-full pl-12 pr-10 py-3 border-2 border-border rounded-xl bg-card focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all shadow-sm hover:shadow-md'
            />

            {searchQuery && (
              <button
                type='button'
                onClick={() => {
                  dispatch(setSearchQuery(''));
                  dispatch(clearJobTypeSelection());
                  dispatch(clearCitySelection());
                  setShowRecent(true);
                }}
                className='absolute right-3 top-1/2 -translate-y-1/2 p-1 hover:bg-primary/10 rounded-full transition-all'
                title={t('clearSearch')}
              >
                <X className='w-4 h-4 text-muted-foreground' />
              </button>
            )}
          </div>

          {showRecent && recentSearches.length > 0 && (
            <div className='absolute z-50 w-full mt-2 bg-card border-2 border-border rounded-xl shadow-lg overflow-hidden'>
              <div className='p-3'>
                <div className='flex items-center justify-between mb-2 px-1'>
                  <p className='text-xs font-semibold text-muted-foreground uppercase tracking-wider'>
                    {t('recentSearches')}
                  </p>
                  <button
                    type='button'
                    onClick={(e) => {
                      e.stopPropagation();
                      dispatch(clearRecentSearches());
                    }}
                    className='text-xs text-destructive hover:text-destructive/80 flex items-center gap-1 transition-colors'
                  >
                    <Trash2 className='w-3 h-3' />
                    {t('clear')}
                  </button>
                </div>
                <div className='space-y-1 max-h-60 overflow-y-auto'>
                  {recentSearches.map((search, index) => (
                    <button
                      key={index}
                      type='button'
                      onClick={() => handleSearch(search)}
                      className='w-full text-left px-3 py-2 hover:bg-primary/5 rounded-lg transition-all flex items-center gap-3 text-sm text-foreground'
                    >
                      <Clock className='w-4 h-4 text-muted-foreground flex-shrink-0' />
                      <span className='truncate'>{search}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>

        <button
          type='submit'
          className='px-6 py-3 bg-primary text-primary-foreground rounded-xl hover:shadow-xl hover:shadow-primary/30 hover:scale-105 transition-all font-semibold whitespace-nowrap'
        >
          {t('buttonSearch')}
        </button>

        <button
          type='button'
          className='p-3 hover:bg-primary/10 rounded-xl transition-all hover:scale-110 border-2 border-border'
          title={t('moreFilters')}
        >
          <Settings2 className='w-5 h-5' />
        </button>
      </form>
    </div>
  );
}
</file>

<file path="src/Components/SearchHighlight.tsx">
import React from 'react';
import { highlightTextParts } from '@/Components/Common/TextHighlighter';

interface SearchHighlightProps {
  text: string;
  searchQuery: string;
  className?: string;
}

export const SearchHighlight: React.FC<SearchHighlightProps> = ({
  text,
  searchQuery,
  className = '',
}) => {
  const parts = highlightTextParts(text, searchQuery);

  return (
    <span className={className}>
      {parts.map((part, index) =>
        part.highlight ? (
          <mark key={index} className='bg-yellow-200 font-semibold px-0.5 rounded'>
            {part.text}
          </mark>
        ) : (
          <span key={index}>{part.text}</span>
        ),
      )}
    </span>
  );
};
</file>

<file path="src/Components/Shared/FilterBar.tsx">
'use client';

import { Filter, X, Sparkles } from 'lucide-react';
import { useState } from 'react';

interface FilterBarProps {
  filters: string[];
  selectedFilters: string[];
  onFilterChange: (filter: string) => void;
  onClearFilters: () => void;
  className?: string;
  disabled?: boolean;
}

export function FilterBar({
  filters,
  selectedFilters,
  onFilterChange,
  onClearFilters,
  className = '',
  disabled = false,
}: FilterBarProps) {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <div className={`relative ${className}`}>
      <button
        onClick={() => !disabled && setIsOpen(!isOpen)}
        disabled={disabled}
        className={`
          flex items-center justify-center gap-3 px-6 py-4
          bg-white/90 backdrop-blur-md
          border-2 rounded-2xl
          font-semibold text-foreground
          transition-all duration-300 ease-out
          shadow-lg
          disabled:opacity-50 disabled:cursor-not-allowed
          ${
            isOpen
              ? 'border-blue-500 shadow-[0_0_30px_rgba(59,130,246,0.3)] scale-105 bg-white'
              : 'border-blue-200 hover:border-blue-400 hover:shadow-[0_0_20px_rgba(59,130,246,0.2)] hover:scale-102'
          }
          ${disabled ? 'bg-gray-100' : ''}
        `}
      >
        <Filter
          className={`w-5 h-5 transition-all duration-300 ${
            isOpen ? 'text-blue-500 rotate-180 scale-110' : 'text-blue-600'
          }`}
        />
        <span className='text-blue-900'>Filtros</span>

        {selectedFilters.length > 0 && (
          <span className='px-3 py-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-sm font-bold rounded-full shadow-lg shadow-blue-500/50 animate-pulse'>
            {selectedFilters.length}
          </span>
        )}
      </button>

      {!disabled && isOpen && filters.length > 0 && (
        <>
          {/* Backdrop overlay */}
          <div className='fixed inset-0 z-40' onClick={() => setIsOpen(false)} />

          <div className='absolute top-full left-0 right-0 mt-3 p-6 bg-white/95 backdrop-blur-xl border-2 border-blue-300 rounded-2xl shadow-[0_0_40px_rgba(59,130,246,0.3)] z-50 animate-in fade-in slide-in-from-top-4 duration-300'>
            <div className='flex items-center justify-between mb-4'>
              <div className='flex items-center gap-2'>
                <Sparkles className='w-4 h-4 text-blue-500' />
                <h3 className='text-sm font-bold text-blue-900'>Selecciona tus filtros</h3>
              </div>
              {selectedFilters.length > 0 && (
                <button
                  onClick={onClearFilters}
                  className='flex items-center gap-1 text-xs font-semibold text-blue-600 hover:text-blue-800 transition-colors'
                >
                  <X className='w-3 h-3' />
                  Limpiar todo
                </button>
              )}
            </div>

            <div className='flex flex-wrap gap-2'>
              {filters.map((filter, index) => {
                const isSelected = selectedFilters.includes(filter);
                return (
                  <button
                    key={filter}
                    onClick={() => onFilterChange(filter)}
                    style={{ animationDelay: `${index * 50}ms` }}
                    className={`
                      px-4 py-2.5 rounded-xl text-sm font-semibold
                      transition-all duration-300 ease-out
                      animate-in fade-in slide-in-from-bottom-2
                      ${
                        isSelected
                          ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg shadow-blue-500/50 scale-105 border-2 border-blue-400'
                          : 'bg-blue-50 text-blue-700 border-2 border-blue-200 hover:border-blue-400 hover:bg-blue-100 hover:scale-105 hover:shadow-md'
                      }
                    `}
                  >
                    {filter}
                    {isSelected && (
                      <span className='ml-2 inline-block w-2 h-2 bg-white rounded-full animate-pulse' />
                    )}
                  </button>
                );
              })}
            </div>

            <div className='absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-50' />
          </div>
        </>
      )}
    </div>
  );
}
</file>

<file path="src/Components/Shared/ImageCarousel.tsx">
// src\Components\Shared\ImageCarousel.tsx
'use client';

import { useState, useEffect } from 'react';
import Image from 'next/image';
import { ChevronLeft, ChevronRight } from 'lucide-react';

interface ImageCarouselProps {
  images: string[];
  alt: string;
}

export function ImageCarousel({ images, alt }: ImageCarouselProps) {
  const [currentIndex, setCurrentIndex] = useState(0);

  // Auto-rotate images every 5 seconds
  useEffect(() => {
    if (images.length <= 1) return;

    const interval = setInterval(() => {
      setCurrentIndex((current) => (current + 1) % images.length);
    }, 5000);

    return () => clearInterval(interval);
  }, [images.length]);

  const handlePrevious = () => {
    setCurrentIndex((current) => (current - 1 + images.length) % images.length);
  };

  const handleNext = () => {
    setCurrentIndex((current) => (current + 1) % images.length);
  };

  if (!images.length) {
    return null;
  }

  return (
    <div className='relative aspect-video overflow-hidden group'>
      <Image
        src={images[currentIndex]}
        alt={`${alt} - Imagen ${currentIndex + 1}`}
        fill
        className='object-cover transition-transform duration-500 group-hover:scale-105'
        priority
      />

      {images.length > 1 && (
        <>
          {/* Navigation Buttons */}
          <button
            onClick={(e) => {
              e.stopPropagation();
              handlePrevious();
            }}
            className='absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-full bg-black/50 text-white opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/70'
            aria-label='Imagen anterior'
          >
            <ChevronLeft className='w-5 h-5' />
          </button>
          <button
            onClick={(e) => {
              e.stopPropagation();
              handleNext();
            }}
            className='absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-full bg-black/50 text-white opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/70'
            aria-label='Siguiente imagen'
          >
            <ChevronRight className='w-5 h-5' />
          </button>

          {/* Dots Indicators */}
          <div className='absolute bottom-2 left-1/2 -translate-x-1/2 flex items-center gap-1.5'>
            {images.map((_, index) => (
              <button
                key={index}
                onClick={(e) => {
                  e.stopPropagation();
                  setCurrentIndex(index);
                }}
                className={`w-1.5 h-1.5 rounded-full transition-all ${
                  index === currentIndex ? 'bg-white w-3' : 'bg-white/60 hover:bg-white/80'
                }`}
                aria-label={`Ir a imagen ${index + 1}`}
              />
            ))}
          </div>
        </>
      )}
    </div>
  );
}
</file>

<file path="src/Components/Shared/SearchBar.tsx">
'use client';

import { Search } from 'lucide-react';
import { useState } from 'react';

interface SearchBarProps {
  value: string;
  onChange: (value: string) => void;
  placeholder?: string;
  className?: string;
  disabled?: boolean;
}

export function SearchBar({
  value,
  onChange,
  placeholder = 'Buscar trabajos, ubicaciones, servicios...',
  className = '',
  disabled = false,
}: SearchBarProps) {
  const [isFocused, setIsFocused] = useState(false);

  return (
    <div className={`flex-1 relative group ${className}`}>
      <div className='absolute left-4 top-1/2 -translate-y-1/2 z-10'>
        <Search
          className={`w-5 h-5 transition-all duration-300 ${
            isFocused
              ? 'text-blue-400 scale-110 drop-shadow-[0_0_8px_rgba(59,130,246,0.8)]'
              : 'text-muted-foreground group-hover:text-blue-500'
          }`}
        />
      </div>

      {/* {isFocused && !disabled && (
        <Sparkles className="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-blue-400 animate-pulse z-10" />
      )} */}

      <input
        type='text'
        placeholder={placeholder}
        value={value}
        onChange={(e) => onChange(e.target.value)}
        onFocus={() => setIsFocused(true)}
        onBlur={() => setIsFocused(false)}
        disabled={disabled}
        className={`
          w-full pl-12 pr-12 py-4 
          bg-white/90 backdrop-blur-md
          border-2 rounded-2xl
          font-medium text-foreground placeholder:text-muted-foreground/60
          transition-all duration-300 ease-out
          shadow-lg
          disabled:opacity-50 disabled:cursor-not-allowed
          ${
            isFocused
              ? 'border-primary shadow-[0_0_30px_rgba(59,130,246,0.3)] scale-[1.02] bg-white'
              : 'border-primary hover:border-blue-300 hover:shadow-[0_0_20px_rgba(59,130,246,0.15)]'
          }
          ${disabled ? 'bg-gray-100' : ''}
        `}
      />

      {isFocused && !disabled && (
        <div className='absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-transparent via-primary to-transparent animate-pulse' />
      )}
    </div>
  );
}
</file>

<file path="src/Components/Shared/SearchDropdown.tsx">
// src/Components/shared/SearchDropdown.tsx
'use client';

import React from 'react';
import { Clock, Trash2, Star, X, ArrowUpLeft } from 'lucide-react';
import { useTranslations } from 'next-intl';

export interface SearchDropdownProps {
  isOpen: boolean;
  history: string[];
  suggestions: string[];
  highlighted: number;
  longPressedItem: string | null;
  query: string;
  onSelectItem: (item: string) => void;
  onPreviewItem: (item: string) => void;
  onDeleteItem: (item: string) => void;
  onClearHistory: () => void;
  onHighlight: React.Dispatch<React.SetStateAction<number>>;
  onLongPressStart: (item: string) => void;
  onLongPressEnd: () => void;
  onCancelDelete: () => void;
  maxVisibleHistory?: number;
  maxVisibleSuggestions?: number;
  className?: string;
}

export const SearchDropdown: React.FC<SearchDropdownProps> = ({
  isOpen,
  history,
  suggestions,
  highlighted,
  longPressedItem,
  query,
  onSelectItem,
  onPreviewItem,
  onDeleteItem,
  onClearHistory,
  onHighlight,
  onLongPressStart,
  onLongPressEnd,
  onCancelDelete,
  maxVisibleHistory = 5,
  maxVisibleSuggestions = 5,
  className = '',
}) => {
  const t = useTranslations('search');

  // Filtrar historial visible
  const visibleHistory = React.useMemo(() => {
    const q = query.trim().toLowerCase();
    if (q.length === 0) {
      return history.slice(0, maxVisibleHistory);
    }
    return history.filter((h) => h.toLowerCase().includes(q)).slice(0, maxVisibleHistory);
  }, [history, query, maxVisibleHistory]);

  const visibleSuggestions = suggestions.slice(0, maxVisibleSuggestions);

  if (!isOpen) return null;

  return (
    <div
      className={`absolute left-0 right-0 mt-2 bg-white border rounded shadow-md z-50 ${className}`}
      onMouseLeave={() => onHighlight(-1)}
      onPointerLeave={() => onHighlight(-1)}
    >
      {/* SECCIÓN DE HISTORIAL */}
      <div className='px-2 py-1 flex items-center justify-between'>
        <div className='flex items-center gap-2'>
          <Clock className='w-4 h-4 text-slate-500' />
          <span className='text-xs font-semibold uppercase text-slate-500'>
            {t('recentSearches')}
          </span>
        </div>
        <div className='w-8 flex items-center justify-center sm:justify-end sm:w-auto'>
          <button
            type='button'
            onMouseDown={(e) => e.preventDefault()}
            onClick={(e) => {
              e.stopPropagation();
              onClearHistory();
            }}
            className='mr-1 flex items-center gap-1 text-sm text-red-500 cursor-pointer px-2 py-1 rounded hover:bg-red-50 whitespace-nowrap'
            aria-label={t('clearHistory')}
          >
            <Trash2 className='w-5 h-5 sm:w-4 sm:h-4' />
            <span className='ml-1 text-sm hidden sm:inline'>{t('clearHistory')}</span>
          </button>
        </div>
      </div>

      {history.length === 0 ? (
        <div className='p-3 text-sm text-slate-500'>{t('noRecentSearches')}</div>
      ) : (
        <ul>
          {visibleHistory.map((item, idx) => (
            <li key={`history-${item}-${idx}`}>
              {longPressedItem === item ? (
                <div className='w-full flex items-center justify-between px-2 py-2 bg-red-50 border-l-4 border-red-500 min-w-0'>
                  <div className='flex-1 min-w-0 text-xs sm:text-sm text-red-700 font-medium sm:truncate'>
                    <span className='block sm:inline leading-tight'>{t('deleteSearch')}</span>
                  </div>
                  <div className='flex items-center gap-2 flex-shrink-0 ml-2'>
                    <button
                      type='button'
                      onMouseDown={(e) => e.preventDefault()}
                      onClick={() => {
                        onDeleteItem(item);
                        onCancelDelete();
                      }}
                      className='bg-red-500 text-white px-2 py-0.5 rounded text-xs sm:text-sm flex items-center gap-1 max-[420px]:px-1'
                      aria-label={`${t('delete')} ${item}`}
                    >
                      <Trash2 className='hidden max-[420px]:inline w-3.5 h-3.5 sm:w-4 sm:h-4' />
                      <span className='ml-1 max-[420px]:hidden'>{t('delete')}</span>
                    </button>
                    <button
                      type='button'
                      onMouseDown={(e) => e.preventDefault()}
                      onClick={onCancelDelete}
                      className='bg-slate-100 border border-slate-200 px-2 py-0.5 rounded text-xs sm:text-sm text-slate-700 hover:bg-slate-200 flex items-center gap-1 max-[420px]:px-1'
                      aria-label={t('cancel')}
                    >
                      <X className='hidden max-[420px]:inline w-3.5 h-3.5 sm:w-4 sm:h-4' />
                      <span className='ml-1 max-[420px]:hidden'>{t('cancel')}</span>
                    </button>
                  </div>
                </div>
              ) : (
                <div
                  role='button'
                  tabIndex={0}
                  onMouseDown={(e) => e.preventDefault()}
                  onClick={() => onSelectItem(item)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') onSelectItem(item);
                  }}
                  onMouseEnter={() => onHighlight(idx)}
                  onTouchStart={() => onLongPressStart(item)}
                  onTouchEnd={onLongPressEnd}
                  onTouchMove={onLongPressEnd}
                  onTouchCancel={onLongPressEnd}
                  className={`group w-full flex items-center justify-between gap-2 px-2 py-1 hover:bg-slate-50 focus:bg-slate-50 cursor-pointer ${
                    highlighted === idx ? 'bg-slate-50' : ''
                  }`}
                >
                  <div className='flex items-center gap-1 min-w-0 flex-1'>
                    <Clock className='w-4 h-4 text-slate-400 flex-shrink-0' />
                    <span
                      className='text-sm text-slate-700 overflow-hidden text-ellipsis whitespace-nowrap flex-1 text-left'
                      title={item}
                    >
                      {item}
                    </span>
                  </div>

                  <div className='flex items-center justify-end gap-2 flex-shrink-0'>
                    <button
                      type='button'
                      onMouseDown={(e) => e.preventDefault()}
                      onClick={(e) => {
                        e.stopPropagation();
                        onPreviewItem(item);
                      }}
                      className='2xl:hidden p-1 rounded text-slate-400'
                      aria-label={`${t('preview')} ${item}`}
                    >
                      <ArrowUpLeft className='w-4 h-4' />
                    </button>

                    <button
                      type='button'
                      onMouseDown={(e) => e.preventDefault()}
                      onClick={(e) => {
                        e.stopPropagation();
                        onDeleteItem(item);
                      }}
                      className='hidden 2xl:inline-flex opacity-0 group-hover:opacity-100 text-slate-400 hover:text-red-500 transition-opacity cursor-pointer'
                      aria-label={`${t('delete')} ${item}`}
                    >
                      <X className='w-4 h-4' />
                    </button>
                  </div>
                </div>
              )}
            </li>
          ))}
        </ul>
      )}

      {/* SECCIÓN DE SUGERENCIAS */}
      {query.trim().length > 0 && (
        <div className='mt-2'>
          <div className='px-2 py-1'>
            <div className='flex items-center gap-2'>
              <Star className='w-4 h-4 text-yellow-400' />
              <span className='text-xs font-semibold uppercase text-slate-500'>
                {t('suggestions')}
              </span>
            </div>
          </div>

          {visibleSuggestions.length === 0 ? (
            <div className='p-3 text-sm text-slate-500'>{t('noSuggestions')}</div>
          ) : (
            <ul>
              {visibleSuggestions.map((sugg, i) => {
                const combinedIndex = visibleHistory.length + i;
                return (
                  <li key={`suggestion-${sugg}-${i}`}>
                    <div
                      role='button'
                      tabIndex={0}
                      onMouseDown={(e) => e.preventDefault()}
                      onClick={() => onSelectItem(sugg)}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter') onSelectItem(sugg);
                      }}
                      onMouseEnter={() => onHighlight(combinedIndex)}
                      className={`w-full flex items-center gap-2 px-2 py-1 hover:bg-slate-50 cursor-pointer min-w-0 ${
                        highlighted === combinedIndex ? 'bg-slate-50' : ''
                      }`}
                    >
                      <Star className='w-4 h-4 text-yellow-400 flex-shrink-0' />
                      <span
                        className='text-sm text-slate-700 overflow-hidden text-ellipsis whitespace-nowrap'
                        title={sugg}
                      >
                        {sugg}
                      </span>
                    </div>
                  </li>
                );
              })}
            </ul>
          )}
        </div>
      )}
    </div>
  );
};
</file>

<file path="src/Components/Shared/TranslationButton.tsx">
'use client';
import { usePathname, useRouter } from 'next/navigation';
import { useState, useEffect } from 'react';
import { Globe, Check } from 'lucide-react';
import { useLocale } from 'next-intl';

export const TranslationButton = () => {
  const router = useRouter();
  const pathName = usePathname();
  const currentLocale = useLocale();
  const [showMenu, setShowMenu] = useState(false);
  const [isMounted, setIsMounted] = useState(false);

  useEffect(() => {
    setIsMounted(true);
  }, []);

  const toggleMenu = () => setShowMenu(!showMenu);

  const handleLanguageChange = (lang: string) => {
    const segments = pathName.split('/');
    segments[1] = lang;
    router.push(segments.join('/'));
    setShowMenu(false);
  };

  if (!isMounted) return null;

  return (
    <div className='fixed bottom-4 right-4 z-[9999]'>
      <div className='relative'>
        <button
          onClick={toggleMenu}
          className='bg-primary text-white rounded-full p-3 shadow-2xl hover:shadow-primary/50 active:scale-95 sm:hover:scale-110 transition-all duration-300 cursor-pointer touch-manipulation'
          aria-label='Cambiar idioma'
        >
          <Globe size={20} className='sm:w-6 sm:h-6' />
        </button>

        {/* Dropdown */}
        {showMenu && (
          <>
            {/* Overlay para cerrar al hacer clic fuera */}
            <div className='fixed inset-0 z-[9998]' onClick={() => setShowMenu(false)} />

            <div className='absolute bottom-full mb-2 right-0 bg-white text-gray-800 rounded-xl shadow-2xl border border-gray-200 w-40 p-2 z-[9999]'>
              <button
                onClick={() => handleLanguageChange('es')}
                className={`flex items-center justify-between w-full text-left px-3 py-2 rounded-lg transition-all text-sm ${
                  currentLocale === 'es'
                    ? 'bg-primary text-white font-semibold'
                    : 'hover:bg-gray-100 active:bg-gray-200'
                }`}
              >
                <span className='flex items-center gap-2'>
                  <span className='text-lg'>🇪🇸</span>
                  <span>Español</span>
                </span>
                {currentLocale === 'es' && <Check size={16} />}
              </button>

              <button
                onClick={() => handleLanguageChange('en')}
                className={`flex items-center justify-between w-full text-left px-3 py-2 rounded-lg transition-all text-sm ${
                  currentLocale === 'en'
                    ? 'bg-primary text-white font-semibold'
                    : 'hover:bg-gray-100 active:bg-gray-200'
                }`}
              >
                <span className='flex items-center gap-2'>
                  <span className='text-lg'>🇬🇧</span>
                  <span>English</span>
                </span>
                {currentLocale === 'en' && <Check size={16} />}
              </button>
            </div>
          </>
        )}
      </div>
    </div>
  );
};
</file>

<file path="src/Components/Statistics-panel/admin-map.tsx">
'use client';

import React, { useEffect } from 'react';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';
import { MapContainer, TileLayer, Marker, Popup, useMap } from 'react-leaflet';

// Imágenes importadas correctamente
import markerIcon2x from 'leaflet/dist/images/marker-icon-2x.png';
import markerIcon from 'leaflet/dist/images/marker-icon.png';
import markerShadow from 'leaflet/dist/images/marker-shadow.png';

export interface Appointment {
  id: string;
  fixerName: string;
  requesterName: string;
  date: string;
  status: 'booked' | 'cancelled' | string; // Agregado string por si acaso vienen otros estados
  lat: number;
  lng: number;
  service?: string;
}

// Configuración de Íconos de Leaflet
// eslint-disable-next-line @typescript-eslint/no-explicit-any
delete (L.Icon.Default.prototype as any)._getIconUrl;

L.Icon.Default.mergeOptions({
  iconUrl: markerIcon.src,
  iconRetinaUrl: markerIcon2x.src,
  shadowUrl: markerShadow.src,
});

const formatBoDate = (isoString: string) => {
  if (!isoString) return 'Fecha pendiente';
  const date = new Date(isoString);
  return new Intl.DateTimeFormat('es-BO', {
    day: '2-digit',
    month: 'long',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
  }).format(date);
};

// Componente auxiliar para ajustar el zoom
function FitBounds({ appointments }: { appointments: Appointment[] }) {
  const map = useMap(); // Ahora usamos el hook importado correctamente

  useEffect(() => {
    if (appointments.length > 0) {
      const bounds = L.latLngBounds(appointments.map((app) => [app.lat, app.lng]));
      map.fitBounds(bounds, { padding: [50, 50] });
    }
  }, [appointments, map]);

  return null;
}

// Íconos personalizados
const bookedIcon = new L.Icon({
  iconUrl:
    'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41],
});

const cancelledIcon = new L.Icon({
  iconUrl:
    'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41],
});

interface AdminMapProps {
  appointments: Appointment[];
}

const AdminMap: React.FC<AdminMapProps> = ({ appointments }) => {
  return (
    <div className='h-full w-full relative z-0'>
      <MapContainer center={[-17.39, -66.15]} zoom={13} className='h-full w-full rounded-lg'>
        <TileLayer
          url='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
          attribution='&copy; OpenStreetMap contributors'
        />
        <FitBounds appointments={appointments} />

        {appointments.map((appointment) => (
          <Marker
            key={appointment.id}
            position={[appointment.lat, appointment.lng]}
            icon={appointment.status === 'booked' ? bookedIcon : cancelledIcon}
          >
            <Popup>
              <div className='text-sm text-gray-800 min-w-[200px]'>
                <div className='mb-2 pb-1 border-b border-gray-200'>
                  <span
                    className={`font-bold text-xs uppercase ${appointment.status === 'booked' ? 'text-green-600' : 'text-red-600'}`}
                  >
                    {appointment.status === 'booked' ? '• Cita Activa' : '• Cancelada'}
                  </span>
                </div>
                <p className='mb-1'>
                  <span className='font-bold text-blue-600'>Fixer:</span> {appointment.fixerName}
                </p>
                <p className='mb-1'>
                  <span className='font-bold text-gray-600'>Requester:</span>{' '}
                  {appointment.requesterName}
                </p>
                <p className='mb-1'>
                  <span className='font-bold text-gray-600'>Fecha:</span>{' '}
                  {formatBoDate(appointment.date)}
                </p>
              </div>
            </Popup>
          </Marker>
        ))}
      </MapContainer>
    </div>
  );
};

export default AdminMap;
</file>

<file path="src/Components/Statistics-panel/Chart-bar-Label.tsx">
'use client';

import { TrendingUp } from 'lucide-react';
import {
  Bar,
  BarChart,
  CartesianGrid,
  LabelList,
  XAxis,
  Tooltip,
  ResponsiveContainer,
  YAxis,
} from 'recharts';

// Definir interfaces para TypeScript
interface ChartDataItem {
  name: string;
  value: number;
}

interface ChartBarLabelProps {
  data: ChartDataItem[];
  title?: string;
  description?: string;
  color?: string;
  dataKey?: string;
  nameKey?: string;
  trendText?: string;
  footerText?: string;
  showTrend?: boolean;
  className?: string;
  height?: number;
  barSize?: number;
}

// Custom Tooltip Component
interface TooltipProps {
  active?: boolean;
  payload?: Array<{ value: number }>;
  label?: string;
}

const CustomTooltip = ({ active, payload, label }: TooltipProps) => {
  if (active && payload && payload.length) {
    return (
      <div className='bg-white p-3 border border-gray-200 rounded-lg shadow-sm'>
        <p className='font-medium text-gray-900'>{label}</p>
        <p className='text-sm text-blue-600'>{`Value: ${payload[0].value}`}</p>
      </div>
    );
  }
  return null;
};

export function ChartBarLabel({
  data,
  title = 'Bar Chart',
  description = 'Chart data',
  color = '#2563eb',
  dataKey = 'value',
  nameKey = 'name',
  trendText = 'Trending up by 5.2% this month',
  footerText = 'Showing data statistics',
  showTrend = true,
  className = '',
  height = 300,
  barSize = 100, // Barras más delgadas
}: ChartBarLabelProps) {
  return (
    <div className={`flex flex-col border rounded-lg bg-white shadow-sm w-full ${className}`}>
      <div className='p-6 pb-0'>
        <h3 className='text-lg font-semibold'>{title}</h3>
        <p className='text-sm text-gray-500 mt-1'>{description}</p>
      </div>

      <div className='p-6'>
        <div className='w-full' style={{ height: `${height}px` }}>
          <ResponsiveContainer width='100%' height='100%'>
            <BarChart
              data={data}
              margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
              barCategoryGap='15%' // Espacio entre categorías
            >
              <CartesianGrid vertical={false} stroke='#f3f4f6' />
              <XAxis
                dataKey={nameKey}
                tickLine={false}
                axisLine={false}
                tickFormatter={(value) => (typeof value === 'string' ? value.slice(0, 10) : value)}
                tick={{ fill: '#6b7280', fontSize: 12 }}
              />
              <YAxis tickLine={false} axisLine={false} tick={{ fill: '#6b7280', fontSize: 12 }} />
              <Tooltip content={<CustomTooltip />} />
              <Bar
                dataKey={dataKey}
                fill={color}
                radius={[4, 4, 0, 0]} // Esquinas menos redondeadas
                barSize={barSize} // Control del ancho de barras
              >
                <LabelList
                  dataKey={dataKey}
                  position='top'
                  offset={8}
                  fill='#1f2937'
                  fontSize={12}
                  fontWeight={600}
                />
              </Bar>
            </BarChart>
          </ResponsiveContainer>
        </div>
      </div>

      <div className='p-6 pt-0 flex flex-col items-start gap-2 text-sm'>
        {showTrend && (
          <div className='flex gap-2 leading-none font-medium items-center'>
            {trendText} <TrendingUp className='h-4 w-4' />
          </div>
        )}
        <div className='text-gray-500 leading-none'>{footerText}</div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/Statistics-panel/Chart-pie-donut.tsx">
'use client';

import { TrendingUp } from 'lucide-react';
import { Pie, PieChart, Tooltip } from 'recharts';

interface ChartData {
  [key: string]: string | number | undefined;
  name: string;
  value: number;
  fill?: string;
}

interface ChartPieDonutProps {
  data: ChartData[];
  title?: string;
  description?: string;
}

export function ChartPieDonut({
  data,
  title = 'Estadísticas - Búsquedas',
  description = 'January - June 2024',
}: ChartPieDonutProps) {
  // Asignar colores si no vienen en los datos
  const dataWithColors = data.map((item, index) => ({
    ...item,
    fill: item.fill || ['#FFBB28', '#EF4444', '#60A5FA'][index % 3],
  }));

  return (
    <div className='flex flex-col border rounded-lg bg-white shadow-sm p-6'>
      <div className='items-center text-center mb-4'>
        <h3 className='text-lg font-semibold'>{title}</h3>
        <p className='text-sm text-gray-500 mt-1'>{description}</p>
      </div>

      <div className='flex-1 flex justify-center'>
        <PieChart width={250} height={250}>
          <Tooltip />
          <Pie
            data={dataWithColors}
            dataKey='value'
            nameKey='name'
            innerRadius={60}
            outerRadius={100}
            paddingAngle={2}
          />
        </PieChart>
      </div>

      <div className='flex justify-center gap-4 mt-4 mb-4'>
        {dataWithColors.map((item, index) => (
          <div key={index} className='flex items-center gap-2'>
            <div className='w-4 h-4 rounded-sm' style={{ backgroundColor: item.fill }} />
            <span className='text-sm capitalize'>{item.name}</span>
          </div>
        ))}
      </div>

      <div className='flex flex-col gap-2 text-sm mt-4 text-center'>
        <div className='flex items-center justify-center gap-2 font-medium'>
          Estadísticas de los usuarios <TrendingUp className='h-4 w-4' />
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/Statistics-panel/fixer-stats-table.tsx">
'use client';
import React from 'react';

interface FixerStat {
  id: string;
  name: string;
  total: number;
  active: number;
  cancelled: number;
  rescheduled: number;
  rate: string;
}

const FixerStatsTable = ({ stats }: { stats: FixerStat[] }) => {
  return (
    <div className='bg-white rounded-xl shadow border border-gray-200 overflow-hidden'>
      <div className='p-4 border-b border-gray-200'>
        <h3 className='font-bold text-gray-800'>Rendimiento por Fixer</h3>
      </div>
      <div className='overflow-x-auto'>
        <table className='w-full text-sm text-left text-gray-500'>
          <thead className='text-xs text-gray-700 uppercase bg-gray-50'>
            <tr>
              <th className='px-6 py-3'>Fixer</th>
              <th className='px-6 py-3 text-center'>Total</th>
              <th className='px-6 py-3 text-center text-green-600'>Activas</th>
              <th className='px-6 py-3 text-center text-red-600'>Canceladas</th>
              <th className='px-6 py-3 text-center text-orange-500'>Reprogramadas</th>
              <th className='px-6 py-3 text-center'>Tasa Cancelación</th>
            </tr>
          </thead>
          <tbody>
            {stats.length > 0 ? (
              stats.map((fixer) => (
                <tr key={fixer.id} className='bg-white border-b hover:bg-gray-50'>
                  <td className='px-6 py-4 font-medium text-gray-900'>{fixer.name}</td>
                  <td className='px-6 py-4 text-center'>{fixer.total}</td>
                  <td className='px-6 py-4 text-center'>{fixer.active}</td>
                  <td className='px-6 py-4 text-center'>{fixer.cancelled}</td>
                  <td className='px-6 py-4 text-center'>{fixer.rescheduled}</td>
                  <td className='px-6 py-4 text-center font-bold'>{fixer.rate}</td>
                </tr>
              ))
            ) : (
              <tr>
                <td colSpan={6} className='px-6 py-4 text-center'>
                  No hay datos disponibles
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

export default FixerStatsTable;
</file>

<file path="src/Components/Tabs/Tabs.tsx">
'use client';

import * as React from 'react';
import TabsList from './TabsList';
import TabsTrigger from './TabsTrigger';
import TabsContent from './TabsContent';

interface TabsContextValue {
  value: string;
  onValueChange: (value: string) => void;
}

const TabsContext = React.createContext<TabsContextValue | undefined>(undefined);

export const useTabs = () => {
  const context = React.useContext(TabsContext);
  if (!context) {
    throw new Error('Tabs components must be used within a Tabs provider');
  }
  return context;
};

interface TabsProps {
  value: string;
  onValueChange: (value: string) => void;
  children: React.ReactNode;
  className?: string;
}

const Tabs = ({ value, onValueChange, children, className }: TabsProps) => {
  return (
    <TabsContext.Provider value={{ value, onValueChange }}>
      <div className={className}>{children}</div>
    </TabsContext.Provider>
  );
};

export { Tabs, TabsList, TabsTrigger, TabsContent, TabsContext };
export default Tabs;
</file>

<file path="src/Components/Tabs/TabsContent.tsx">
'use client';

import type { ReactNode } from 'react';
import { useTabs } from './Tabs';

interface TabsContentProps {
  value: string;
  className?: string;
  children: ReactNode;
}

const TabsContent = ({ value, className, children }: TabsContentProps) => {
  const { value: activeTab } = useTabs();

  if (value !== activeTab) return null;

  return (
    <div
      role='tabpanel'
      className={`mt-4 ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-400 focus-visible:ring-offset-2 ${className || ''}`}
    >
      {children}
    </div>
  );
};

export default TabsContent;
</file>

<file path="src/Components/Tabs/TabsList.tsx">
import type { ReactNode } from 'react';

interface TabsListProps {
  className?: string;
  children: ReactNode;
}

const TabsList = ({ className, children }: TabsListProps) => (
  <div
    className={`inline-flex h-12 items-center justify-start rounded-lg bg-gray-100/80 p-1 text-gray-500 w-full md:w-auto overflow-x-auto ${className || ''}`}
    role='tablist'
  >
    {children}
  </div>
);

export default TabsList;
</file>

<file path="src/Components/Tabs/TabsTrigger.tsx">
'use client';

import type { ReactNode } from 'react';
import { useTabs } from './Tabs';

export interface TabsTriggerProps {
  value: string;
  className?: string;
  children: ReactNode;
}

const TabsTrigger = ({ value, className, children }: TabsTriggerProps) => {
  const { value: activeTab, onValueChange } = useTabs();
  const isActive = value === activeTab;

  return (
    <button
      type='button'
      role='tab'
      aria-selected={isActive}
      onClick={() => onValueChange(value)}
      className={`
        inline-flex items-center justify-center whitespace-nowrap rounded-md px-4 py-2 text-sm font-medium ring-offset-white transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-400 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50
        ${
          isActive
            ? 'bg-white text-gray-950 shadow-sm'
            : 'text-gray-500 hover:text-gray-900 hover:bg-gray-200/50'
        }
        ${className || ''}
      `}
    >
      {children}
    </button>
  );
};

export default TabsTrigger;
</file>

<file path="src/Components/Tour/CustomTourComponents.tsx">
'use client';

import React from 'react';

interface NextBtnProps {
  currentStep: number;
  stepsLength: number;
  setCurrentStep?: (updater: (step: number) => number) => void;
  setIsOpen?: (isOpen: boolean) => void;
  steps?: unknown[];
}

export const NextBtn = ({ ...props }: NextBtnProps) => {
  const isLastStep = props.currentStep === props.stepsLength - 1;
  if (props.currentStep === 0) return null;

  const handleClick = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.preventDefault();
    e.stopPropagation();

    if (props.setCurrentStep && props.steps) {
      if (isLastStep) {
        if (props.setIsOpen) {
          props.setIsOpen(false);
        }
        localStorage.setItem('servineoTourVisto', 'true');
      } else {
        props.setCurrentStep((s: number) => s + 1);
      }
    }
  };

  return (
    <button
      onClick={handleClick}
      type='button'
      style={{
        backgroundColor: '#2B6AE0',
        color: 'white',
        fontWeight: '700',
        padding: '10px 24px',
        borderRadius: '10px',
        fontSize: '14px',
        border: 'none',
        cursor: 'pointer',
        transition: 'all 0.2s ease',
        pointerEvents: 'auto',
        position: 'relative',
        zIndex: 1000001,
        boxShadow: '0 4px 12px rgba(43, 106, 224, 0.3)',
        whiteSpace: 'nowrap',
      }}
    >
      {isLastStep ? 'Finalizar' : 'Siguiente'}
    </button>
  );
};

interface PrevBtnProps {
  currentStep: number;
  setCurrentStep?: (updater: (step: number) => number) => void;
}

export const PrevBtn = ({ ...props }: PrevBtnProps) => {
  if (props.currentStep === 0) return null;

  const handleClick = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.preventDefault();
    e.stopPropagation();
    if (props.setCurrentStep) {
      props.setCurrentStep((s: number) => s - 1);
    }
  };

  return (
    <button
      onClick={handleClick}
      style={{
        color: '#666',
        fontWeight: '600',
        fontSize: '14px',
        padding: '10px 18px',
        border: '2px solid transparent',
        background: 'transparent',
        cursor: 'pointer',
        borderRadius: '10px',
        transition: 'all 0.2s ease',
        pointerEvents: 'auto',
        position: 'relative',
        zIndex: 1000001,
        whiteSpace: 'nowrap',
      }}
    >
      Anterior
    </button>
  );
};
</file>

<file path="src/Components/Tour/TourLogic.tsx">
'use client';

import { useEffect, useState } from 'react';
import { usePathname } from 'next/navigation';
import { useTour } from '@reactour/tour';
import { tourSteps } from './TourSteps';

export function TourLogic() {
  const pathname = usePathname();
  const { setSteps, setIsOpen, setCurrentStep, isOpen } = useTour();
  const [hasStarted, setHasStarted] = useState(false);

  useEffect(() => {
    // Asegurar que las funciones del contexto estén disponibles
    if (!setSteps || !setIsOpen || !setCurrentStep) return;

    // Filtrar pasos según dispositivo
    const isMobile = window.innerWidth < 1024;
    const filteredSteps = tourSteps.filter((step) => {
      if (isMobile) return step.selector !== '#tour-auth-buttons-desktop';
      return step.selector !== '#tour-auth-buttons-mobile';
    });

    setSteps(filteredSteps);

    // IMPORTANTE: Solo iniciar el tour si estamos en la página principal
    const isHomePage = pathname === '/' || pathname === '/es' || pathname === '/en';

    if (!isHomePage) {
      // Si no estamos en el home, no iniciar el tour
      return;
    }

    // Lógica de inicio
    const tourVisto =
      typeof window !== 'undefined' ? localStorage.getItem('servineoTourVisto') : null;
    const urlParams =
      typeof window !== 'undefined'
        ? new URLSearchParams(window.location.search)
        : new URLSearchParams();

    // Mostrar el tour solo si estamos en home y NO se ha visto antes, a menos que
    // se solicite explícitamente via ?tour=1 (para volver a verlo).
    const shouldForce = urlParams.get('tour') === '1';

    if (!tourVisto || shouldForce) {
      setCurrentStep(0);

      // Esperar a que la UI termine de montarse
      const timer = setTimeout(() => {
        setIsOpen(true);
        setHasStarted(true);
      }, 1200);

      return () => clearTimeout(timer);
    }
  }, [setSteps, setIsOpen, setCurrentStep, pathname]);

  // Guardar que se vio SOLO al cerrar el tour voluntariamente
  useEffect(() => {
    if (!isOpen && hasStarted) {
      // Guardar que el usuario vio el tour para que no se vuelva a mostrar automáticamente
      try {
        localStorage.setItem('servineoTourVisto', 'true');
      } catch (e) {
        // si localStorage no está disponible, no hacemos nada
      }
      setHasStarted(false);
    }
  }, [isOpen, hasStarted]);

  return null;
}
</file>

<file path="src/Components/Tour/TourProviderWrapper.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */

'use client';

import { TourProvider } from '@reactour/tour';
import { TourLogic } from './TourLogic';
import { tourSteps } from './TourSteps';
import { PrevBtn, NextBtn } from './CustomTourComponents';

const tourStyles = {
  popover: (base: any, state: any) => ({
    ...base,
    borderRadius: '16px',
    padding: state.current === 0 ? '20px' : '18px',
    boxShadow: '0 10px 30px rgba(0,0,0,0.15)',
    maxWidth: state.current === 0 ? '480px' : '420px',
    minWidth: '320px',
    zIndex: 100000,
    backgroundColor: '#ffffff',
    color: '#333',
    fontSize: '15px',
    textAlign: 'center', // CENTRAR TODO EL TEXTO
  }),
  maskArea: (base: any) => ({
    ...base,
    rx: 12,
    fill: 'rgba(0, 0, 0, 0.3)',
  }),
  maskWrapper: (base: any) => ({
    ...base,
    color: 'rgba(0, 0, 0, 0.3)',
  }),
  badge: (base: any) => ({
    ...base,
    display: 'none',
  }),
  controls: (base: any, state: any) => ({
    ...base,
    marginTop: state.current === 0 ? '0px' : '20px',
    display: 'flex',
    justifyContent: state.current === 0 ? 'center' : 'space-between', // Centrar en paso 0
    alignItems: 'center',
    gap: '12px',
  }),
  navigation: (base: any, state: any) => ({
    ...base,
    display: state.current === 0 ? 'none' : 'flex', // OCULTAR NAVEGACIÓN EN PASO 0
    justifyContent: 'center',
    alignItems: 'center',
    flex: 1,
    margin: '0 12px',
  }),
  dot: (base: any, state: any) => ({
    ...base,
    display: 'block', // Ya se oculta con navigation
    width: '7px',
    height: '7px',
    margin: '0 3px',
    border: 'none',
    borderRadius: '50%',
    backgroundColor: state.current ? '#2B6AE0' : '#e2e8f0',
    transform: state.current ? 'scale(1.2)' : 'scale(1)',
    transition: 'all 0.3s ease',
    boxShadow: 'none',
    cursor: 'pointer',
    padding: 0,
  }),
  close: (base: any) => ({
    ...base,
    right: 12,
    top: 12,
    color: '#999',
    width: '14px',
    height: '14px',
  }),
};

export function TourProviderWrapper({ children }: { children: React.ReactNode }) {
  return (
    <TourProvider
      steps={tourSteps}
      styles={tourStyles}
      prevButton={PrevBtn}
      nextButton={NextBtn}
      showBadge={false}
      showDots={true}
      scrollSmooth={true}
      padding={{ mask: 10, popover: [5, 10] }}
      disableInteraction={true}
    >
      <TourLogic />
      {children}
    </TourProvider>
  );
}
</file>

<file path="src/Components/Tour/TourSteps.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
/* eslint-disable react/no-unescaped-entities */

import { StepType } from '@reactour/tour';

export const tourSteps: StepType[] = [
  {
    selector: '#tour-start-point',
    content: ({ setIsOpen, setCurrentStep }: any) => (
      <div className='text-center p-2'>
        <h3 className='text-2xl font-bold text-[#2B6AE0] mb-3'>¡Hola! Bienvenido a Servineo</h3>
        <p className='text-gray-700 leading-relaxed text-base mb-5'>
          ¿Te gustaría realizar un breve recorrido para conocer las funciones principales de la
          plataforma?
        </p>
        <div className='flex justify-center gap-3'>
          <button
            onClick={() => {
              setIsOpen(false);
              localStorage.setItem('servineoTourVisto', 'true');
            }}
            className='px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100 transition text-sm'
          >
            No, gracias
          </button>
          <button
            onClick={() => setCurrentStep(1)}
            className='px-4 py-2 bg-[#2B6AE0] text-white rounded-lg font-bold hover:bg-blue-700 transition shadow-md text-sm'
          >
            Iniciar Recorrido
          </button>
        </div>
      </div>
    ),
    position: 'center',
  },
  {
    selector: '#tour-search-bar',
    content: (
      <div>
        <h4 className='font-bold text-lg mb-2 text-gray-800'>1. Búsqueda Inteligente</h4>
        <p className='text-gray-600 text-sm'>
          Escribe aquí el servicio que necesitas (ej. "Plomero") para encontrar ayuda rápidamente.
        </p>
      </div>
    ),
    position: 'bottom',
  },
  {
    selector: '#titulo-seccion-mapa',
    content: (
      <div>
        <h4 className='font-bold text-lg mb-2 text-gray-800'>2. Mapa de Fixers</h4>
        <p className='text-gray-600 text-sm'>
          Visualiza a los profesionales disponibles en tu zona en tiempo real.
        </p>
      </div>
    ),
    position: 'top',
    // ✅ Función que se ejecuta ANTES de mostrar este paso
    actionAfter: async (node: any) => {
      return new Promise<void>((resolve) => {
        // Verificar que el elemento existe
        const element = document.querySelector('#titulo-seccion-mapa');

        if (element) {
          // Hacer scroll suave hacia el elemento
          element.scrollIntoView({
            behavior: 'smooth',
            block: 'center',
            inline: 'nearest',
          });

          // Esperar 1 segundo para que termine el scroll y el mapa se cargue
          setTimeout(() => {
            resolve();
          }, 1000);
        } else {
          console.warn('Elemento #titulo-seccion-mapa no encontrado');
          resolve();
        }
      });
    },
  },
  {
    selector: '#tour-inspiration-section',
    content: (
      <div>
        <h4 className='font-bold text-lg mb-2 text-gray-800'>3. Inspírate</h4>
        <p className='text-gray-600 text-sm'>
          Mira proyectos realizados por nuestros profesionales para tomar ideas.
        </p>
      </div>
    ),
    position: 'top',
    actionAfter: async (node: any) => {
      return new Promise<void>((resolve) => {
        const element = document.querySelector('#tour-inspiration-section');
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => resolve(), 700);
        } else {
          resolve();
        }
      });
    },
  },
  {
    selector: '#tour-recent-offers',
    content: (
      <div>
        <h4 className='font-bold text-lg mb-2 text-gray-800'>4. Ofertas Recientes</h4>
        <p className='text-gray-600 text-sm'>
          Revisa las últimas solicitudes publicadas en la plataforma.
        </p>
      </div>
    ),
    position: 'top',
    actionAfter: async (node: any) => {
      return new Promise<void>((resolve) => {
        const element = document.querySelector('#tour-recent-offers');
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => resolve(), 700);
        } else {
          resolve();
        }
      });
    },
  },
  {
    selector: '#tour-services-section',
    content: (
      <div>
        <h4 className='font-bold text-lg mb-2 text-gray-800'>5. Catálogo de Servicios</h4>
        <p className='text-gray-600 text-sm'>
          Explora todas las categorías disponibles: Plomería, Electricidad, etc.
        </p>
      </div>
    ),
    position: 'top',
    actionAfter: async (node: any) => {
      return new Promise<void>((resolve) => {
        const element = document.querySelector('#tour-services-section');
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => resolve(), 700);
        } else {
          resolve();
        }
      });
    },
  },
  {
    selector: '#tour-how-it-works',
    content: (
      <div>
        <h4 className='font-bold text-lg mb-2 text-gray-800'>6. ¿Cómo funciona?</h4>
        <p className='text-gray-600 text-sm'>Entiende el proceso de contratación paso a paso.</p>
      </div>
    ),
    position: 'top',
    actionAfter: async (node: any) => {
      return new Promise<void>((resolve) => {
        const element = document.querySelector('#tour-how-it-works');
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => resolve(), 700);
        } else {
          resolve();
        }
      });
    },
  },
  {
    selector: '#tour-cta-section',
    content: (
      <div>
        <h4 className='font-bold text-lg mb-2 text-gray-800'>7. ¡Empieza Ahora!</h4>
        <p className='text-gray-600 text-sm'>
          Si no encuentras lo que buscas, contáctanos directamente aquí.
        </p>
      </div>
    ),
    position: 'top',
    actionAfter: async (node: any) => {
      return new Promise<void>((resolve) => {
        const element = document.querySelector('#tour-cta-section');
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => resolve(), 700);
        } else {
          resolve();
        }
      });
    },
  },
  {
    selector: '#footer-principal',
    content: (
      <div>
        <h4 className='font-bold text-lg mb-2 text-gray-800'>8. Información y Ayuda</h4>
        <p className='text-gray-600 text-sm'>
          Encuentra soporte, enlaces legales y la opción para{' '}
          <strong>ver esta guía nuevamente</strong>.
        </p>
      </div>
    ),
    position: 'top',
    actionAfter: async (node: any) => {
      return new Promise<void>((resolve) => {
        const element = document.querySelector('#footer-principal');
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => resolve(), 700);
        } else {
          resolve();
        }
      });
    },
  },
  {
    selector: '#tour-auth-buttons-desktop',
    content: (
      <div>
        <h4 className='font-bold text-lg mb-2 text-gray-800'>9. Tu Cuenta</h4>
        <p className='text-gray-600 text-sm'>
          Finalmente, inicia sesión o regístrate para comenzar.
        </p>
      </div>
    ),
    position: 'bottom',
    actionAfter: async () => {
      return new Promise<void>((resolve) => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        setTimeout(() => resolve(), 700);
      });
    },
  },
  {
    selector: '#tour-auth-buttons-mobile',
    content: (
      <div>
        <h4 className='font-bold text-lg mb-2 text-gray-800'>9. Tu Cuenta</h4>
        <p className='text-gray-600 text-sm'>
          Finalmente, inicia sesión o regístrate para comenzar.
        </p>
      </div>
    ),
    position: 'bottom',
    actionAfter: async () => {
      return new Promise<void>((resolve) => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        setTimeout(() => resolve(), 700);
      });
    },
  },
];
</file>

<file path="src/Components/ui/button.tsx">
import * as React from 'react';
import { Slot } from '@radix-ui/react-slot';
import { cva, type VariantProps } from 'class-variance-authority';
import { cn } from '@/app/lib/utils';

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: 'bg-primary text-primary-foreground hover:bg-primary/90',
        destructive:
          'bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60',
        outline:
          'border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50',
        secondary: 'bg-secondary text-secondary-foreground hover:bg-secondary/80',
        ghost: 'hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50',
        link: 'text-primary underline-offset-4 hover:underline',
      },
      size: {
        default: 'h-9 px-4 py-2 has-[>svg]:px-3',
        sm: 'h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5',
        lg: 'h-10 rounded-md px-6 has-[>svg]:px-4',
        icon: 'size-9',
        'icon-sm': 'size-8',
        'icon-lg': 'size-10',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  },
);

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<'button'> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean;
  }) {
  const Comp = asChild ? Slot : 'button';

  return (
    <Comp
      data-slot='button'
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  );
}

export { Button, buttonVariants };

export type ButtonProps = React.ButtonHTMLAttributes<HTMLButtonElement> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean;
  };
</file>

<file path="src/Components/ui/card.tsx">
import * as React from 'react';

import { cn } from '@/app/lib/utils';

const Card = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div
      ref={ref}
      className={cn('rounded-xl border bg-card text-card-foreground shadow', className)}
      {...props}
    />
  ),
);
Card.displayName = 'Card';

const CardHeader = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn('flex flex-col space-y-1.5 p-6', className)} {...props} />
  ),
);
CardHeader.displayName = 'CardHeader';

const CardTitle = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div
      ref={ref}
      className={cn('font-semibold leading-none tracking-tight', className)}
      {...props}
    />
  ),
);
CardTitle.displayName = 'CardTitle';

const CardDescription = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn('text-sm text-muted-foreground', className)} {...props} />
  ),
);
CardDescription.displayName = 'CardDescription';

const CardContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn('p-6 pt-0', className)} {...props} />
  ),
);
CardContent.displayName = 'CardContent';

const CardFooter = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn('flex items-center p-6 pt-0', className)} {...props} />
  ),
);
CardFooter.displayName = 'CardFooter';

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent };
</file>

<file path="src/Components/ui/dropdown-menu.tsx">
'use client';

import * as React from 'react';
import * as DropdownMenuPrimitive from '@radix-ui/react-dropdown-menu';
import { CheckIcon, ChevronRightIcon, CircleIcon } from 'lucide-react';

import { cn } from '@/app/lib/utils';

function DropdownMenu({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot='dropdown-menu' {...props} />;
}

function DropdownMenuPortal({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return <DropdownMenuPrimitive.Portal data-slot='dropdown-menu-portal' {...props} />;
}

function DropdownMenuTrigger({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return <DropdownMenuPrimitive.Trigger data-slot='dropdown-menu-trigger' {...props} />;
}

function DropdownMenuContent({
  className,
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot='dropdown-menu-content'
        sideOffset={sideOffset}
        className={cn(
          'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md',
          className,
        )}
        {...props}
      />
    </DropdownMenuPrimitive.Portal>
  );
}

function DropdownMenuGroup({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return <DropdownMenuPrimitive.Group data-slot='dropdown-menu-group' {...props} />;
}

function DropdownMenuItem({
  className,
  inset,
  variant = 'default',
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean;
  variant?: 'default' | 'destructive';
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot='dropdown-menu-item'
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  );
}

function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot='dropdown-menu-checkbox-item'
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      checked={checked}
      {...props}
    >
      <span className='pointer-events-none absolute left-2 flex size-3.5 items-center justify-center'>
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className='size-4' />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  );
}

function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return <DropdownMenuPrimitive.RadioGroup data-slot='dropdown-menu-radio-group' {...props} />;
}

function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot='dropdown-menu-radio-item'
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      <span className='pointer-events-none absolute left-2 flex size-3.5 items-center justify-center'>
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className='size-2 fill-current' />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  );
}

function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean;
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot='dropdown-menu-label'
      data-inset={inset}
      className={cn('px-2 py-1.5 text-sm font-medium data-[inset]:pl-8', className)}
      {...props}
    />
  );
}

function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot='dropdown-menu-separator'
      className={cn('bg-border -mx-1 my-1 h-px', className)}
      {...props}
    />
  );
}

function DropdownMenuShortcut({ className, ...props }: React.ComponentProps<'span'>) {
  return (
    <span
      data-slot='dropdown-menu-shortcut'
      className={cn('text-muted-foreground ml-auto text-xs tracking-widest', className)}
      {...props}
    />
  );
}

function DropdownMenuSub({ ...props }: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot='dropdown-menu-sub' {...props} />;
}

function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean;
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot='dropdown-menu-sub-trigger'
      data-inset={inset}
      className={cn(
        'focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8',
        className,
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className='ml-auto size-4' />
    </DropdownMenuPrimitive.SubTrigger>
  );
}

function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot='dropdown-menu-sub-content'
      className={cn(
        'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg',
        className,
      )}
      {...props}
    />
  );
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
};
</file>

<file path="src/Components/ui/input.tsx">
import * as React from 'react';
import { cn } from '@/app/lib/utils';

// ✅ forwardRef para compatibilidad con React Hook Form y tipado correcto
const Input = React.forwardRef<HTMLInputElement, React.InputHTMLAttributes<HTMLInputElement>>(
  ({ className, type = 'text', ...props }, ref) => {
    return (
      <input
        ref={ref}
        type={type}
        data-slot='input'
        className={cn(
          'flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50',
          className,
        )}
        {...props} // ✅ Esto pasa onChange, value, etc.
      />
    );
  },
);

Input.displayName = 'Input';

export { Input };
</file>

<file path="src/Components/ui/label.tsx">
'use client';

import * as React from 'react';
import * as LabelPrimitive from '@radix-ui/react-label';
import { cva, type VariantProps } from 'class-variance-authority';

import { cn } from '@/app/lib/utils';

const labelVariants = cva(
  'text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70',
);

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> & VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root ref={ref} className={cn(labelVariants(), className)} {...props} />
));
Label.displayName = LabelPrimitive.Root.displayName;

export { Label };
</file>

<file path="src/Components/ui/Message.tsx">
import React from 'react';

export interface MessageProps {
  isOpen: boolean;
  onClose: () => void;
  title?: string;
  message: string;
  type?: 'warning' | 'error' | 'info' | 'success';
}

export default function Message({ isOpen, onClose, title, message, type = 'info' }: MessageProps) {
  if (!isOpen) return null;

  const typeStyles = {
    warning: {
      border: 'border-yellow-500',
      icon: '⚠️',
      bgIcon: 'bg-yellow-100 text-yellow-600',
      button: 'bg-yellow-500 hover:bg-yellow-600 text-white',
    },
    error: {
      border: 'border-red-500',
      icon: '❌',
      bgIcon: 'bg-red-100 text-red-600',
      button: 'bg-red-500 hover:bg-red-600 text-white',
    },
    info: {
      border: 'border-blue-500',
      icon: 'ℹ️',
      bgIcon: 'bg-blue-100 text-blue-600',
      button: 'bg-blue-500 hover:bg-blue-600 text-white',
    },
    success: {
      border: 'border-green-500',
      icon: '✅',
      bgIcon: 'bg-green-100 text-green-600',
      button: 'bg-green-500 hover:bg-green-600 text-white',
    },
  };

  const styles = typeStyles[type];

  const getDefaultTitle = () => {
    switch (type) {
      case 'warning':
        return 'Advertencia';
      case 'error':
        return 'Error';
      case 'success':
        return 'Éxito';
      default:
        return 'Información';
    }
  };

  return (
    <div className='fixed inset-0 bg-black/30 flex items-center justify-center z-50 p-4'>
      <div
        className={`bg-white rounded-lg shadow-xl max-w-sm w-full p-6 border-l-4 ${styles.border}`}
      >
        <div className='flex items-center mb-4'>
          <div className={`rounded-full p-2 mr-3 ${styles.bgIcon}`}>{styles.icon}</div>
          <h3 className='text-lg font-semibold text-gray-900'>{title || getDefaultTitle()}</h3>
        </div>

        <p className='text-gray-700 mb-6'>{message}</p>

        <div className='flex justify-end'>
          <button
            onClick={onClose}
            className={`px-4 py-2 rounded-md font-medium transition-colors ${styles.button}`}
          >
            Entendido
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/ui/pagination.tsx">
import * as React from 'react';
import { ChevronLeft, ChevronRight, MoreHorizontal } from 'lucide-react';

import { cn } from '@/app/lib/utils';
import { ButtonProps, buttonVariants } from '@/Components/ui/button';

const Pagination = ({ className, ...props }: React.ComponentProps<'nav'>) => (
  <nav
    role='navigation'
    aria-label='pagination'
    className={cn('mx-auto flex w-full justify-center', className)}
    {...props}
  />
);
Pagination.displayName = 'Pagination';

const PaginationContent = React.forwardRef<HTMLUListElement, React.ComponentProps<'ul'>>(
  ({ className, ...props }, ref) => (
    <ul ref={ref} className={cn('flex flex-row items-center gap-1', className)} {...props} />
  ),
);
PaginationContent.displayName = 'PaginationContent';

const PaginationItem = React.forwardRef<HTMLLIElement, React.ComponentProps<'li'>>(
  ({ className, ...props }, ref) => <li ref={ref} className={cn('', className)} {...props} />,
);
PaginationItem.displayName = 'PaginationItem';

type PaginationLinkProps = {
  isActive?: boolean;
} & Pick<ButtonProps, 'size'> &
  React.ComponentProps<'a'>;

const PaginationLink = ({ className, isActive, size = 'icon', ...props }: PaginationLinkProps) => (
  <a
    aria-current={isActive ? 'page' : undefined}
    className={cn(
      buttonVariants({
        variant: isActive ? 'outline' : 'ghost',
        size,
      }),
      className,
    )}
    {...props}
  />
);
PaginationLink.displayName = 'PaginationLink';

const PaginationPrevious = ({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink
    aria-label='Go to previous page'
    size='default'
    className={cn('gap-1 pl-2.5', className)}
    {...props}
  >
    <ChevronLeft className='h-4 w-4' />
    <span>Previous</span>
  </PaginationLink>
);
PaginationPrevious.displayName = 'PaginationPrevious';

const PaginationNext = ({ className, ...props }: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink
    aria-label='Go to next page'
    size='default'
    className={cn('gap-1 pr-2.5', className)}
    {...props}
  >
    <span>Next</span>
    <ChevronRight className='h-4 w-4' />
  </PaginationLink>
);
PaginationNext.displayName = 'PaginationNext';

const PaginationEllipsis = ({ className, ...props }: React.ComponentProps<'span'>) => (
  <span
    aria-hidden
    className={cn('flex h-9 w-9 items-center justify-center', className)}
    {...props}
  >
    <MoreHorizontal className='h-4 w-4' />
    <span className='sr-only'>More pages</span>
  </span>
);
PaginationEllipsis.displayName = 'PaginationEllipsis';

export {
  Pagination,
  PaginationContent,
  PaginationLink,
  PaginationItem,
  PaginationPrevious,
  PaginationNext,
  PaginationEllipsis,
};
</file>

<file path="src/config/api.ts">
const raw = process.env.NEXT_PUBLIC_API_URL;

if (!raw) {
  throw new Error('NEXT_PUBLIC_API_URL no definida');
}

export const API_BASE_URL = raw.replace(/\/+$/, '');

export function apiUrl(path: string): string {
  return `${API_BASE_URL}/${path.replace(/^\/+/, '')}`;
}

export async function apiFetch<T = unknown>(path: string, init: RequestInit = {}): Promise<T> {
  const url = apiUrl(path);
  if (process.env.NODE_ENV !== 'production') {
    console.debug('[apiFetch]', init.method || 'GET', url);
  }
  const res = await fetch(url, {
    ...init,
    headers: {
      'Content-Type': 'application/json',
      ...(init.headers || {}),
    },
  });
  let body: unknown = null;
  const text = await res.text();
  try {
    body = text ? JSON.parse(text) : null;
  } catch {
    body = text;
  }
  if (!res.ok) {
    let msg: string | undefined;
    if (body && typeof body === 'object') {
      const b = body as Record<string, unknown>;
      const cand = b.msg || b.error;
      if (typeof cand === 'string') msg = cand;
    }
    msg = msg || res.statusText || 'Error de API';
    throw new Error(`${msg} (${res.status})`);
  }
  return body as T;
}

export function withQuery(path: string, params: Record<string, unknown>): string {
  const usp = new URLSearchParams();
  Object.entries(params).forEach(([k, v]) => {
    if (v === undefined || v === null) return;
    usp.append(k, String(v));
  });
  const q = usp.toString();
  return q ? `${path}?${q}` : path;
}
</file>

<file path="src/hooks/Appointments/useHourAppointments.ts">
import { useState, useCallback } from 'react';
import { getAppointmentsByHour, Appointment } from '../../utils/Appointments/getAppointmentsByHour';

interface UseHourRefetchProps {
  fixer_id: string;
}

export default function useHourAppointment({ fixer_id }: UseHourRefetchProps) {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const refetchHour = useCallback(
    async (date: Date, hour: number): Promise<Appointment[]> => {
      if (!fixer_id || fixer_id === '' || fixer_id === 'undefined') {
        console.warn('fixer_id no válido:', fixer_id);
        return [];
      }

      setLoading(true);
      setError(null);

      try {
        const dateString = date.toISOString().split('T')[0];
        const hourAppointments = await getAppointmentsByHour(fixer_id, dateString, hour);

        setLoading(false);
        return hourAppointments;
      } catch (err) {
        console.error('Error en refetchHour:', err);
        setError('Error al cargar la hora');
        setLoading(false);
        return [];
      }
    },
    [fixer_id],
  );

  return {
    refetchHour,
    loading,
    error,
  };
}
</file>

<file path="src/hooks/Appointments/useSixMonthsAppointments.ts">
import { useEffect, useState, useRef, useCallback } from 'react';
import { Appointment } from '@/utils/getAppointmentsByDate';
import { getSixMonthAppointments } from '@/utils/Appointments/getSixMonthAppointments';
import { getAppointmentsByHour } from '@/utils/Appointments/getAppointmentsByHour';
import { getAppointmentsDisable, Days } from '@/utils/getAppointmentsDisable';

export type DayOfWeek = keyof Days;
const DAY_MAP: { [key: number]: DayOfWeek } = {
  0: 'domingo',
  1: 'lunes',
  2: 'martes',
  3: 'miercoles',
  4: 'jueves',
  5: 'viernes',
  6: 'sabado',
};

export default function useSixMonthsAppointments(fixer_id: string, date: Date) {
  const [appointments, setAppointments] = useState<Appointment[]>([]);
  const [appointmentsDis, setAppointmentsDis] = useState<Days>({
    lunes: [],
    martes: [],
    miercoles: [],
    jueves: [],
    viernes: [],
    sabado: [],
    domingo: [],
  });
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const hasFetched = useRef(false);
  const [refreshTrigger, setRefreshTrigger] = useState(0);

  useEffect(() => {
    if (hasFetched.current && refreshTrigger === 0) {
      return;
    }

    async function fetchData() {
      if (!fixer_id || fixer_id === '' || fixer_id === 'undefined') {
        console.warn('fixer_id no válido:', fixer_id);
        setLoading(false);
        return;
      }

      setLoading(true);
      try {
        const [appointmentsData, availabilityData] = await Promise.all([
          getSixMonthAppointments(fixer_id, date.toISOString().split('T')[0]),
          getAppointmentsDisable(fixer_id),
        ]);

        setAppointments(appointmentsData);
        setAppointmentsDis(availabilityData);
        setError(null);
        hasFetched.current = true;
      } catch (err) {
        setError('Error al cargar los datos');
        console.error('Error en fetchData:', err);
        setAppointments([]);
        setAppointmentsDis({
          lunes: [],
          martes: [],
          miercoles: [],
          jueves: [],
          viernes: [],
          sabado: [],
          domingo: [],
        });
      } finally {
        setLoading(false);
      }
    }

    fetchData();
  }, [fixer_id, date, refreshTrigger]);

  const refetch = useCallback(() => {
    setRefreshTrigger((prev) => prev + 1);
  }, []);

  const refetchHour = useCallback(
    async (date: Date, hour: number) => {
      try {
        const dateString = date.toISOString().split('T')[0];
        const hourAppointments = await getAppointmentsByHour(fixer_id, dateString, hour);

        setAppointments((prevAppointments) => {
          const otherAppointments = prevAppointments.filter((apt) => {
            const aptDate = new Date(apt.starting_time);
            return !(
              aptDate.getUTCFullYear() === date.getFullYear() &&
              aptDate.getUTCMonth() === date.getMonth() &&
              aptDate.getUTCDate() === date.getDate() &&
              aptDate.getUTCHours() === hour
            );
          });

          return [...otherAppointments, ...hourAppointments];
        });

        return hourAppointments;
      } catch (err) {
        console.error('Error en refetchHour:', err);
        return [];
      }
    },
    [fixer_id],
  );

  const isHourBookedFixer = useCallback(
    (day: Date, hour: number): boolean => {
      return appointments.some((apt: Appointment) => {
        const aptDate = new Date(apt.starting_time);
        const aptState = apt.schedule_state;
        const aptCanceledFixer = apt.cancelled_fixer;
        return (
          aptDate.getUTCFullYear() === day.getFullYear() &&
          aptDate.getUTCMonth() === day.getMonth() &&
          aptDate.getUTCDate() === day.getDate() &&
          aptDate.getUTCHours() === hour &&
          aptState === 'booked' &&
          aptCanceledFixer === false
        );
      });
    },
    [appointments],
  );

  const isHourBooked = useCallback(
    (day: Date, hour: number, requester_id: string): 'self' | 'other' | 'notBooked' => {
      const appointment = appointments.find((apt: Appointment) => {
        const aptDate = new Date(apt.starting_time);
        const aptCanceledFixer = apt.cancelled_fixer;
        const aptState = apt.schedule_state;
        return (
          aptDate.getUTCFullYear() === day.getFullYear() &&
          aptDate.getUTCMonth() === day.getMonth() &&
          aptDate.getUTCDate() === day.getDate() &&
          aptDate.getUTCHours() === hour &&
          aptState === 'booked' &&
          aptCanceledFixer === false
        );
      });

      if (!appointment) return 'notBooked';
      if (appointment.id_requester === requester_id) return 'self';
      return 'other';
    },
    [appointments],
  );

  const isEnabled = useCallback(
    (day: Date, hour: number): boolean => {
      const dayOfWeek = day.getDay();
      const dayName = DAY_MAP[dayOfWeek];

      if (!appointmentsDis || !appointmentsDis[dayName]) {
        return false;
      }

      return appointmentsDis[dayName].includes(hour);
    },
    [appointmentsDis],
  );

  const isCanceled = useCallback(
    (
      day: Date,
      hour: number,
      requester_id: string,
    ): 'fixer' | 'requester' | 'otherFixer' | 'otherRequester' | 'notCancel' => {
      const appointment = appointments.find((apt: Appointment) => {
        const aptDate = new Date(apt.starting_time);
        return (
          aptDate.getUTCFullYear() === day.getFullYear() &&
          aptDate.getUTCMonth() === day.getMonth() &&
          aptDate.getUTCDate() === day.getDate() &&
          aptDate.getUTCHours() === hour
        );
      });
      if (!appointment) return 'notCancel';

      if (appointment.id_requester === requester_id) {
        if (appointment.cancelled_fixer) {
          return 'fixer';
        } else {
          if (appointment.schedule_state === 'cancelled') {
            return 'requester';
          } else {
            return 'notCancel';
          }
        }
      } else {
        if (appointment.cancelled_fixer) {
          return 'otherFixer';
        } else {
          if (appointment.schedule_state === 'cancelled') {
            return 'otherRequester';
          } else {
            return 'notCancel';
          }
        }
      }
    },
    [appointments],
  );

  return {
    isHourBookedFixer,
    isHourBooked,
    isEnabled,
    loading,
    isCanceled,
    error,
    refetch,
    refetchHour,
  };
}
</file>

<file path="src/hooks/useAppointmentsDisable.ts">
import { useEffect, useState, useCallback } from 'react';
import { getAppointmentsDisable, Days } from '@/app/lib/utils/getAppointmentsDisable';

export type DayOfWeek = keyof Days;

const DAY_MAP: { [key: number]: DayOfWeek } = {
  0: 'domingo',
  1: 'lunes',
  2: 'martes',
  3: 'miercoles',
  4: 'jueves',
  5: 'viernes',
  6: 'sabado',
};

export default function useAppointmentsDisable(fixer_id: string, date: Date) {
  const [appointmentsDis, setAppointmentsDis] = useState<Days>({
    lunes: [],
    martes: [],
    miercoles: [],
    jueves: [],
    viernes: [],
    sabado: [],
    domingo: [],
  });
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function fetchData() {
      if (!fixer_id || fixer_id === '' || fixer_id === 'undefined') {
        console.warn('fixer_id no válido:', fixer_id);
        setLoading(false);
        return;
      }

      setLoading(true);

      try {
        const [availabilityData] = await Promise.all([getAppointmentsDisable(fixer_id)]);

        setAppointmentsDis(availabilityData);
        setError(null);
      } catch (err) {
        setError('Error al cargar los datos');
        console.error('Error en fetchData:', err);
        setAppointmentsDis({
          lunes: [],
          martes: [],
          miercoles: [],
          jueves: [],
          viernes: [],
          sabado: [],
          domingo: [],
        });
      } finally {
        setLoading(false);
      }
    }

    fetchData();
  }, [fixer_id, date]);

  const isDisabledDay = useCallback(
    (day: Date): boolean => {
      const dayOfWeek = day.getDay();
      const dayName = DAY_MAP[dayOfWeek];

      return appointmentsDis[dayName].length === 24;
    },
    [appointmentsDis],
  );

  const isDisabled = useCallback(
    (day: Date, hour: number): boolean => {
      const dayOfWeek = day.getDay();
      const dayName = DAY_MAP[dayOfWeek];

      if (!appointmentsDis || !appointmentsDis[dayName]) {
        return false;
      }

      return appointmentsDis[dayName].includes(hour);
    },
    [appointmentsDis],
  );

  return {
    isDisabledDay,
    isDisabled,
    loading,
    error,
  };
}
</file>

<file path="src/hooks/useCalendarNavigation.ts">
import { useState } from 'react';

interface useCalendarNavigationProps {
  initialYear: number;
  initialMonth: number;
  initialDate: number;
  view: 'month' | 'week' | 'day';
  onChangeMonth: (m: number) => void;
  onChangeYear: (y: number) => void;
  onChangeDate: (d: number) => void;
}

interface WeekRange {
  start: Date;
  end: Date;
}

export default function useCalendarNavigation({
  initialYear,
  initialMonth,
  initialDate,
  view,
  onChangeMonth,
  onChangeYear,
  onChangeDate,
}: useCalendarNavigationProps) {
  const [year, setYear] = useState(initialYear);
  const [month, setMonth] = useState(initialMonth);
  const [date, setDate] = useState(initialDate);

  const currentDate = new Date();
  currentDate.setHours(0, 0, 0, 0);

  const updateDate = (newDate: number, newMonth: number, newYear: number) => {
    setDate(newDate);
    setMonth(newMonth);
    setYear(newYear);
    if (onChangeDate) onChangeDate(newDate);
    if (onChangeMonth) onChangeMonth(newMonth);
    if (onChangeYear) onChangeYear(newYear);
  };

  const getWeekRange = (): WeekRange => {
    const current = new Date(year, month, date);
    current.setHours(0, 0, 0, 0);

    const dayOfWeek = current.getDay();
    const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;

    const start = new Date(current);
    start.setDate(current.getDate() + diff);
    start.setHours(0, 0, 0, 0);

    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    end.setHours(23, 59, 59, 999);

    return { start, end };
  };

  const handlePrev = () => {
    if (view === 'month') {
      if (month === 0) {
        updateDate(date, 11, year - 1);
      } else {
        updateDate(date, month - 1, year);
      }
    } else if (view === 'week') {
      const current = new Date(year, month, date);
      current.setDate(current.getDate() - 7);
      updateDate(current.getDate(), current.getMonth(), current.getFullYear());
    } else if (view === 'day') {
      const current = new Date(year, month, date);
      current.setDate(current.getDate() - 1);
      updateDate(current.getDate(), current.getMonth(), current.getFullYear());
    }
  };

  const handleNext = () => {
    if (view === 'month') {
      const nextDate = new Date(year, month + 1, 1);
      const diffMonths =
        (nextDate.getFullYear() - currentDate.getFullYear()) * 12 +
        (nextDate.getMonth() - currentDate.getMonth());
      if (diffMonths > 6) return;

      if (month === 11) {
        updateDate(date, 0, year + 1);
      } else {
        updateDate(date, month + 1, year);
      }
    } else if (view === 'week') {
      const current = new Date(year, month, date);
      current.setDate(current.getDate() + 7);

      const diffTime = current.getTime() - currentDate.getTime();
      const diffMonths = diffTime / (1000 * 60 * 60 * 24 * 30.44);
      if (diffMonths > 6) return;

      updateDate(current.getDate(), current.getMonth(), current.getFullYear());
    } else if (view === 'day') {
      const current = new Date(year, month, date);
      current.setDate(current.getDate() + 1);

      const diffTime = current.getTime() - currentDate.getTime();
      const diffMonths = diffTime / (1000 * 60 * 60 * 24 * 30.44);
      if (diffMonths > 6) return;

      updateDate(current.getDate(), current.getMonth(), current.getFullYear());
    }
  };

  const handleToday = () => {
    updateDate(currentDate.getDate(), currentDate.getMonth(), currentDate.getFullYear());
  };

  const isNextDisabled = (() => {
    if (view === 'month') {
      const nextDate = new Date(year, month + 1, 1);
      const diffMonths =
        (nextDate.getFullYear() - currentDate.getFullYear()) * 12 +
        (nextDate.getMonth() - currentDate.getMonth());
      return diffMonths > 6;
    } else if (view === 'week') {
      const current = new Date(year, month, date);
      current.setDate(current.getDate() + 7);
      const diffTime = current.getTime() - currentDate.getTime();
      const diffMonths = diffTime / (1000 * 60 * 60 * 24 * 30.44);
      return diffMonths > 6;
    } else if (view === 'day') {
      const current = new Date(year, month, date);
      current.setDate(current.getDate() + 1);
      const diffTime = current.getTime() - currentDate.getTime();
      const diffMonths = diffTime / (1000 * 60 * 60 * 24 * 30.44);
      return diffMonths > 6;
    }
    return false;
  })();

  const isPrevDisabled = (() => {
    if (view === 'month') {
      const prevDate = new Date(year, month - 1, 1);
      return prevDate < new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    } else if (view === 'week') {
      const current = new Date(year, month, date);
      current.setDate(current.getDate() - 7);

      const todayWeekStart = new Date(currentDate);
      const dayOfWeek = todayWeekStart.getDay();
      const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      todayWeekStart.setDate(todayWeekStart.getDate() + diff);
      todayWeekStart.setHours(0, 0, 0, 0);

      return current < todayWeekStart;
    } else if (view === 'day') {
      const current = new Date(year, month, date);
      current.setDate(current.getDate() - 1);
      return current < currentDate;
    }
    return false;
  })();

  return {
    year,
    month,
    date,
    handleToday,
    handlePrev,
    handleNext,
    isPrevDisabled,
    isNextDisabled,
    getWeekRange,
  };
}
</file>

<file path="src/hooks/useCalendarView.ts">
import { useState } from 'react';
export default function useCalendarView() {
  const [view, setView] = useState<'month' | 'week' | 'day'>('month');
  const handleMonthView = () => setView('month');
  const handleWeekView = () => setView('week');
  const handleDayView = () => setView('day');

  return { view, handleMonthView, handleWeekView, handleDayView };
}
</file>

<file path="src/hooks/useDailyAppointments.ts">
import { useEffect, useState, useCallback } from 'react';
import { getAppointmentsByDate, Appointment } from '@/app/lib/utils/getAppointmentsByDate';
import { getAppointmentsDisable, Days } from '@/app/lib/utils/getAppointmentsDisable';

export type DayOfWeek = keyof Days;

const DAY_MAP: { [key: number]: DayOfWeek } = {
  0: 'domingo',
  1: 'lunes',
  2: 'martes',
  3: 'miercoles',
  4: 'jueves',
  5: 'viernes',
  6: 'sabado',
};

export default function useAppointmentsByDate(fixer_id: string, date: Date) {
  const [appointments, setAppointments] = useState<Appointment[]>([]);
  const [appointmentsDis, setAppointmentsDis] = useState<Days>({
    lunes: [],
    martes: [],
    miercoles: [],
    jueves: [],
    viernes: [],
    sabado: [],
    domingo: [],
  });
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function fetchData() {
      if (!fixer_id || fixer_id === '' || fixer_id === 'undefined') {
        console.warn('fixer_id no válido:', fixer_id);
        setLoading(false);
        return;
      }

      setLoading(true);

      try {
        const [appointmentsData, availabilityData] = await Promise.all([
          getAppointmentsByDate(fixer_id, date.toISOString().split('T')[0]),
          getAppointmentsDisable(fixer_id),
        ]);

        setAppointments(appointmentsData);
        setAppointmentsDis(availabilityData);
        setError(null);
      } catch (err) {
        setError('Error al cargar los datos');
        console.error('Error en fetchData:', err);
        setAppointments([]);
        setAppointmentsDis({
          lunes: [],
          martes: [],
          miercoles: [],
          jueves: [],
          viernes: [],
          sabado: [],
          domingo: [],
        });
      } finally {
        setLoading(false);
      }
    }

    fetchData();
  }, [fixer_id, date]);

  const isHourBooked = useCallback(
    (day: Date, hour: number): boolean => {
      return appointments.some((apt: Appointment) => {
        const aptDate = new Date(apt.starting_time);
        return (
          aptDate.getFullYear() === day.getFullYear() &&
          aptDate.getMonth() === day.getMonth() &&
          aptDate.getDate() === day.getDate() &&
          aptDate.getUTCHours() === hour
        );
      });
    },
    [appointments],
  );

  const isDisabled = useCallback(
    (day: Date, hour: number): boolean => {
      const dayOfWeek = day.getDay();
      const dayName = DAY_MAP[dayOfWeek];

      if (!appointmentsDis || !appointmentsDis[dayName]) {
        return false;
      }

      return appointmentsDis[dayName].includes(hour);
    },
    [appointmentsDis],
  );

  return {
    isHourBooked,
    isDisabled,
    loading,
    error,
  };
}
</file>

<file path="src/hooks/useDayUtilities.ts">
export default function useDayUtilities(date: Date) {
  const normalize = (d: Date) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const today = normalize(new Date());
  const currentDate = normalize(date);

  const isSameDay = (a: Date, b: Date) =>
    a.getDate() === b.getDate() &&
    a.getMonth() === b.getMonth() &&
    a.getFullYear() === b.getFullYear();

  const isToday = isSameDay(currentDate, today);
  const isPast = currentDate < today;

  const getColor = (count: 'full' | 'partial' | 'available' | 'disabled') => {
    if (isPast) return '';
    if (count === 'available') return 'bg-[#16A34A] ';
    if (count === 'partial') return 'bg-[#FFC857]';
    if (count === 'full') return 'bg-[#FF5F57] ';
    if (count === 'disabled') return 'bg-[#64748B]';
    return 'bg-gray-200 text-black';
  };

  const getText = (count: 'full' | 'partial' | 'available' | 'disabled') => {
    if (isPast) return '';
    if (count === 'available') return 'Disponible';
    if (count === 'partial') return 'Parc. Oc.';
    if (count === 'full') return 'Ocupado';
    if (count === 'disabled') return 'Inhabilitado';
    return '';
  };

  return { isPast, isSameDay, isToday, getColor, getText };
}
</file>

<file path="src/hooks/useFixerData.ts">
import { useState, useEffect } from 'react';
import { fixerService } from '@/services/fixerService';
import { JobWithFixers } from '@/types/fixer';

interface UseFixerDataReturn {
  jobsWithFixers: JobWithFixers[];
  loading: boolean;
  error: string | null;
  refetch: () => Promise<void>;
}

export function useFixerData(): UseFixerDataReturn {
  const [jobsWithFixers, setJobsWithFixers] = useState<JobWithFixers[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const fetchData = async () => {
    try {
      setLoading(true);
      setError(null);
      const data = await fixerService.getJobsWithFixers();
      setJobsWithFixers(data);
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Error desconocido';
      setError(errorMessage);
      console.error('Error fetching fixer data:', err);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, []);

  return {
    jobsWithFixers,
    loading,
    error,
    refetch: fetchData,
  };
}
</file>

<file path="src/hooks/useFixersByJob.ts">
import { useMemo } from 'react';

export interface Fixer {
  id: string;
  name: string;
  city: string;
  rating: number;
  avatar?: string;
}

export interface JobWithFixers {
  jobType: string;
  fixers: Fixer[];
}

export function useFixersByJob(jobs: JobWithFixers[], searchQuery: string) {
  return useMemo(() => {
    if (!searchQuery.trim()) {
      return jobs.map((job) => ({
        ...job,
        matchCount: job.fixers.length,
        filteredFixers: job.fixers,
      }));
    }

    const query = searchQuery.toLowerCase();

    return jobs
      .map((job) => {
        const filteredFixers = job.fixers.filter((fixer) =>
          fixer.name.toLowerCase().includes(query),
        );
        return {
          ...job,
          matchCount: filteredFixers.length,
          filteredFixers,
        };
      })
      .filter((job) => job.matchCount > 0);
  }, [jobs, searchQuery]);
}
</file>

<file path="src/hooks/useHourAppointments.ts">
import { useState, useCallback } from 'react';
import { getAppointmentsByHour, Appointment } from '@/app/lib/utils/getAppointmentsByHour';

interface UseHourRefetchProps {
  fixer_id: string;
}

export default function useHourAppointment({ fixer_id }: UseHourRefetchProps) {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const refetchHour = useCallback(
    async (date: Date, hour: number): Promise<Appointment[]> => {
      if (!fixer_id || fixer_id === '' || fixer_id === 'undefined') {
        console.warn('fixer_id no válido:', fixer_id);
        return [];
      }

      setLoading(true);
      setError(null);

      try {
        const dateString = date.toISOString().split('T')[0];
        const hourAppointments = await getAppointmentsByHour(fixer_id, dateString, hour);

        setLoading(false);
        return hourAppointments;
      } catch (err) {
        console.error('Error en refetchHour:', err);
        setError('Error al cargar la hora');
        setLoading(false);
        return [];
      }
    },
    [fixer_id],
  );

  return {
    refetchHour,
    loading,
    error,
  };
}
</file>

<file path="src/hooks/useMessage.ts">
import { useState, useCallback } from 'react';

type MessageType = 'warning' | 'error' | 'info' | 'success';

interface MessageConfig {
  message: string;
  type?: MessageType;
  title?: string;
  onCloseCallback?: () => void;
}

export default function useMessage() {
  const [isOpen, setIsOpen] = useState(false);
  const [message, setMessage] = useState('');
  const [type, setType] = useState<MessageType>('info');
  const [title, setTitle] = useState('');
  // Funcion agregada para ejecutar algo al cerrar el modal
  const [onCloseCallback, setOnCloseCallback] = useState<(() => void) | null>(null);

  const showMessage = useCallback((config: MessageConfig) => {
    setMessage(config.message);
    setType(config.type || 'info');
    setTitle(config.title || '');
    setOnCloseCallback(() => config.onCloseCallback || null);
    setIsOpen(true);
  }, []);

  const hideMessage = useCallback(() => {
    setIsOpen(false);

    // Ejecutar al momento de cerrar
    if (onCloseCallback) {
      onCloseCallback();
      setOnCloseCallback(null); // Limpiar el callback después de usarlo
    }
  }, [onCloseCallback]);

  return {
    showMessage,
    hideMessage,
    messageState: {
      isOpen,
      message,
      type,
      title,
      onClose: hideMessage,
    },
  };
}
</file>

<file path="src/hooks/User/useUserPermissions.ts">
// hooks/useUserPermissions.ts
import { useUserRole } from '@/utils/contexts/UserRoleContext';

export function useUserPermissions() {
  // `role` puede estar disponible en el hook pero no se usa aún — prefix con _ para evitar warning
  const { role: _role, isFixer, isRequester } = useUserRole();

  return {
    canSetAvailability: isFixer,
    canEditOwnSchedule: isFixer,
    canViewAllAppointments: isFixer,

    canRequestAppointment: isRequester,
    canViewAvailableSlots: isRequester,

    canCancelAppointment: true,
    canViewAppointmentDetails: true,
    canReceiveNotifications: true,

    getViewMode: () => (isFixer ? 'manage' : ('book' as const)),
  };
}
</file>

<file path="src/hooks/useSixMonthsAppointments.ts">
import { useEffect, useState, useRef, useCallback } from 'react';
import { Appointment } from '@/app/lib/utils/getAppointmentsByHour';
import { getSixMonthAppointments } from '@/app/lib/utils/getSixMonthAppointments';
import { getAppointmentsByHour } from '@/app/lib/utils/getAppointmentsByHour';
import { getAppointmentsDisable, Days } from '@/app/lib/utils/getAppointmentsDisable';

export type DayOfWeek = keyof Days;
const DAY_MAP: { [key: number]: DayOfWeek } = {
  0: 'domingo',
  1: 'lunes',
  2: 'martes',
  3: 'miercoles',
  4: 'jueves',
  5: 'viernes',
  6: 'sabado',
};

export default function useSixMonthsAppointments(fixer_id: string, date: Date) {
  const [appointments, setAppointments] = useState<Appointment[]>([]);
  const [appointmentsDis, setAppointmentsDis] = useState<Days>({
    lunes: [],
    martes: [],
    miercoles: [],
    jueves: [],
    viernes: [],
    sabado: [],
    domingo: [],
  });
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const hasFetched = useRef(false);
  const [refreshTrigger, setRefreshTrigger] = useState(0);

  useEffect(() => {
    if (hasFetched.current && refreshTrigger === 0) {
      return;
    }

    async function fetchData() {
      if (!fixer_id || fixer_id === '' || fixer_id === 'undefined') {
        console.warn('fixer_id no válido:', fixer_id);
        setLoading(false);
        return;
      }

      setLoading(true);
      try {
        const [appointmentsData, availabilityData] = await Promise.all([
          getSixMonthAppointments(fixer_id, date.toISOString().split('T')[0]),
          getAppointmentsDisable(fixer_id),
        ]);

        setAppointments(appointmentsData);
        setAppointmentsDis(availabilityData);
        setError(null);
        hasFetched.current = true;
      } catch (err) {
        setError('Error al cargar los datos');
        console.error('Error en fetchData:', err);
        setAppointments([]);
        setAppointmentsDis({
          lunes: [],
          martes: [],
          miercoles: [],
          jueves: [],
          viernes: [],
          sabado: [],
          domingo: [],
        });
      } finally {
        setLoading(false);
      }
    }

    fetchData();
  }, [fixer_id, date, refreshTrigger]);

  const refetch = useCallback(() => {
    setRefreshTrigger((prev) => prev + 1);
  }, []);

  const refetchHour = useCallback(
    async (date: Date, hour: number) => {
      try {
        const dateString = date.toISOString().split('T')[0];
        const hourAppointments = await getAppointmentsByHour(fixer_id, dateString, hour);

        setAppointments((prevAppointments) => {
          const otherAppointments = prevAppointments.filter((apt) => {
            const aptDate = new Date(apt.starting_time);
            return !(
              aptDate.getUTCFullYear() === date.getFullYear() &&
              aptDate.getUTCMonth() === date.getMonth() &&
              aptDate.getUTCDate() === date.getDate() &&
              aptDate.getUTCHours() === hour
            );
          });

          return [...otherAppointments, ...hourAppointments];
        });

        return hourAppointments;
      } catch (err) {
        console.error('Error en refetchHour:', err);
        return [];
      }
    },
    [fixer_id],
  );

  const isHourBookedFixer = useCallback(
    (day: Date, hour: number): boolean => {
      return appointments.some((apt: Appointment) => {
        const aptDate = new Date(apt.starting_time);
        const aptState = apt.schedule_state;
        const aptCanceledFixer = apt.cancelled_fixer;
        return (
          aptDate.getUTCFullYear() === day.getFullYear() &&
          aptDate.getUTCMonth() === day.getMonth() &&
          aptDate.getUTCDate() === day.getDate() &&
          aptDate.getUTCHours() === hour &&
          aptState === 'booked' &&
          aptCanceledFixer === false
        );
      });
    },
    [appointments],
  );

  const isHourBooked = useCallback(
    (day: Date, hour: number, requester_id: string): 'self' | 'other' | 'notBooked' => {
      const appointment = appointments.find((apt: Appointment) => {
        const aptDate = new Date(apt.starting_time);
        const aptCanceledFixer = apt.cancelled_fixer;
        const aptState = apt.schedule_state;
        return (
          aptDate.getUTCFullYear() === day.getFullYear() &&
          aptDate.getUTCMonth() === day.getMonth() &&
          aptDate.getUTCDate() === day.getDate() &&
          aptDate.getUTCHours() === hour &&
          aptState === 'booked' &&
          aptCanceledFixer === false
        );
      });

      if (!appointment) return 'notBooked';
      if (appointment.id_requester === requester_id) return 'self';
      return 'other';
    },
    [appointments],
  );

  const isEnabled = useCallback(
    (day: Date, hour: number): boolean => {
      const dayOfWeek = day.getDay();
      const dayName = DAY_MAP[dayOfWeek];

      if (!appointmentsDis || !appointmentsDis[dayName]) {
        return false;
      }

      return appointmentsDis[dayName].includes(hour);
    },
    [appointmentsDis],
  );

  const isCanceled = useCallback(
    (
      day: Date,
      hour: number,
      requester_id: string,
    ): 'fixer' | 'requester' | 'otherFixer' | 'otherRequester' | 'notCancel' => {
      const appointment = appointments.find((apt: Appointment) => {
        const aptDate = new Date(apt.starting_time);
        return (
          aptDate.getUTCFullYear() === day.getFullYear() &&
          aptDate.getUTCMonth() === day.getMonth() &&
          aptDate.getUTCDate() === day.getDate() &&
          aptDate.getUTCHours() === hour
        );
      });
      if (!appointment) return 'notCancel';

      if (appointment.id_requester === requester_id) {
        if (appointment.cancelled_fixer) {
          return 'fixer';
        } else {
          if (appointment.schedule_state === 'cancelled') {
            return 'requester';
          } else {
            return 'notCancel';
          }
        }
      } else {
        if (appointment.cancelled_fixer) {
          return 'otherFixer';
        } else {
          if (appointment.schedule_state === 'cancelled') {
            return 'otherRequester';
          } else {
            return 'notCancel';
          }
        }
      }
    },
    [appointments],
  );

  return {
    isHourBookedFixer,
    isHourBooked,
    isEnabled,
    loading,
    isCanceled,
    error,
    refetch,
    refetchHour,
  };
}
</file>

<file path="src/hooks/useUserPermissions.ts">
// hooks/useUserPermissions.ts
import { useUserRole } from '@/app/lib/utils/contexts/UserRoleContext';

export function useUserPermissions() {
  // `role` puede estar disponible en el hook pero no se usa aún — prefix con _ para evitar warning
  const { role: _role, isFixer, isRequester } = useUserRole();

  return {
    canSetAvailability: isFixer,
    canEditOwnSchedule: isFixer,
    canViewAllAppointments: isFixer,

    canRequestAppointment: isRequester,
    canViewAvailableSlots: isRequester,

    canCancelAppointment: true,
    canViewAppointmentDetails: true,
    canReceiveNotifications: true,

    getViewMode: () => (isFixer ? 'manage' : ('book' as const)),
  };
}
</file>

<file path="src/i18n/navigation.ts">
import { createNavigation } from 'next-intl/navigation';
import { routing } from './routing';

// Lightweight wrappers around Next.js' navigation
// APIs that consider the routing configuration
export const { Link, redirect, usePathname, useRouter, getPathname } = createNavigation(routing);
</file>

<file path="src/i18n/request.ts">
import { getRequestConfig } from 'next-intl/server';
import { hasLocale } from 'next-intl';
import { routing } from './routing';

export default getRequestConfig(async ({ requestLocale }) => {
  const requested = await requestLocale;
  const locale = hasLocale(routing.locales, requested) ? requested : routing.defaultLocale;

  return {
    locale,
    messages: (await import(`../../messages/${locale}.json`)).default,
  };
});
</file>

<file path="src/i18n/routing.ts">
import { defineRouting } from 'next-intl/routing';

export const routing = defineRouting({
  // A list of all locales that are supported
  locales: ['en', 'es'],
  // Used when no locale matches
  defaultLocale: 'en',
});
</file>

<file path="src/jsons/fixers.json">
[
  {
    "id": 1,
    "nombre": "Juan Perez",
    "servicio": "Plomería",
    "lat": -17.393,
    "lng": -66.156,
    "zona": "Centro - Plaza 14 de Septiembre",
    "available": true
  },
  {
    "id": 2,
    "nombre": "Maria Lopez",
    "servicio": "Electricidad",
    "lat": -17.38,
    "lng": -66.142,
    "zona": "Cala Cala",
    "available": false
  },
  {
    "id": 3,
    "nombre": "Carlos Sanchez",
    "servicio": "Carpintería",
    "lat": -17.355,
    "lng": -66.212,
    "zona": "Tiquipaya",
    "available": true
  },
  {
    "id": 4,
    "nombre": "Ana Torres",
    "servicio": "Pintura",
    "lat": -17.42,
    "lng": -66.155,
    "zona": "San Antonio",
    "available": false
  },
  {
    "id": 5,
    "nombre": "Luis Fernandez",
    "servicio": "Jardinería",
    "lat": -17.433,
    "lng": -66.182,
    "zona": "Valle Hermoso",
    "available": true
  },
  {
    "id": 6,
    "nombre": "Sofia Ramirez",
    "servicio": "Cerrajería",
    "lat": -17.35,
    "lng": -66.25,
    "zona": "Quillacollo",
    "available": false
  },
  {
    "id": 7,
    "nombre": "Diego Morales",
    "servicio": "Albañilería",
    "lat": -17.42,
    "lng": -66.17,
    "zona": "Laguna Alalay",
    "available": true
  },
  {
    "id": 8,
    "nombre": "Laura Gutierrez",
    "servicio": "Electricidad",
    "lat": -17.435,
    "lng": -66.115,
    "zona": "Pacata Alta",
    "available": false
  },
  {
    "id": 9,
    "nombre": "Pedro Rojas",
    "servicio": "Plomería",
    "lat": -17.365,
    "lng": -66.155,
    "zona": "Temporal",
    "available": true
  },
  {
    "id": 10,
    "nombre": "Valeria Castillo",
    "servicio": "Carpintería",
    "lat": -17.46,
    "lng": -66.125,
    "zona": "Sacaba",
    "available": false
  },
  {
    "id": 11,
    "nombre": "Fernando Alvarez",
    "servicio": "Pintura",
    "lat": -17.41,
    "lng": -66.21,
    "zona": "Sarcobamba",
    "available": true
  },
  {
    "id": 12,
    "nombre": "Camila Diaz",
    "servicio": "Jardinería",
    "lat": -17.46,
    "lng": -66.18,
    "zona": "Villa Pagador",
    "available": false
  },
  {
    "id": 13,
    "nombre": "Ricardo Salazar",
    "servicio": "Cerrajería",
    "lat": -17.348,
    "lng": -66.189,
    "zona": "Colcapirhua",
    "available": true
  },
  {
    "id": 14,
    "nombre": "Isabella Cruz",
    "servicio": "Electricidad",
    "lat": -17.375,
    "lng": -66.097,
    "zona": "Queru Queru",
    "available": false
  },
  {
    "id": 15,
    "nombre": "Martin Herrera",
    "servicio": "Albañilería",
    "lat": -17.33,
    "lng": -66.22,
    "zona": "Tiquipaya Norte",
    "available": true
  },
  {
    "id": 16,
    "nombre": "Patricia Vargas",
    "servicio": "Plomería",
    "lat": -17.395,
    "lng": -66.2,
    "zona": "Lacma",
    "available": false
  },
  {
    "id": 17,
    "nombre": "Jorge Medina",
    "servicio": "Pintura",
    "lat": -17.47,
    "lng": -66.16,
    "zona": "K'ara K'ara",
    "available": true
  },
  {
    "id": 18,
    "nombre": "Daniela Rivas",
    "servicio": "Electricidad",
    "lat": -17.34,
    "lng": -66.13,
    "zona": "Banda Norte",
    "available": false
  },
  {
    "id": 19,
    "nombre": "Hector Paredes",
    "servicio": "Jardinería",
    "lat": -17.44,
    "lng": -66.14,
    "zona": "Cota Cota",
    "available": true
  },
  {
    "id": 20,
    "nombre": "Monica Cabrera",
    "servicio": "Carpintería",
    "lat": -17.4,
    "lng": -66.18,
    "zona": "Temporal Sur",
    "available": false
  },
  {
    "id": 21,
    "nombre": "Alfredo Jimenez",
    "servicio": "Cerrajería",
    "lat": -17.42,
    "lng": -66.115,
    "zona": "La Maica",
    "available": true
  },
  {
    "id": 22,
    "nombre": "Gabriela Solis",
    "servicio": "Plomería",
    "lat": -17.45,
    "lng": -66.19,
    "zona": "Sudoeste",
    "available": false
  },
  {
    "id": 23,
    "nombre": "Victor Huanca",
    "servicio": "Electricidad",
    "lat": -17.37,
    "lng": -66.2,
    "zona": "Quillacollo Centro",
    "available": true
  },
  {
    "id": 24,
    "nombre": "Liliana Pinto",
    "servicio": "Pintura",
    "lat": -17.38,
    "lng": -66.17,
    "zona": "Sarcobamba Este",
    "available": false
  },
  {
    "id": 25,
    "nombre": "Marcos Flores",
    "servicio": "Limpieza",
    "lat": -17.34,
    "lng": -66.18,
    "zona": "Quillacollo Norte",
    "available": true
  },
  {
    "id": 26,
    "nombre": "Paola Montaño",
    "servicio": "Gasfitería",
    "lat": -17.43,
    "lng": -66.16,
    "zona": "Huañacota",
    "available": false
  },
  {
    "id": 27,
    "nombre": "Rodrigo Ortega",
    "servicio": "Albañilería",
    "lat": -17.45,
    "lng": -66.13,
    "zona": "Sacaba Centro",
    "available": true
  },
  {
    "id": 28,
    "nombre": "Natalia Cardenas",
    "servicio": "Limpieza",
    "lat": -17.41,
    "lng": -66.095,
    "zona": "Pacata Baja",
    "available": true
  },
  {
    "id": 29,
    "nombre": "Andres Quiroga",
    "servicio": "Gasfitería",
    "lat": -17.39,
    "lng": -66.22,
    "zona": "Queru Queru Oeste",
    "available": false
  },
  {
    "id": 30,
    "nombre": "Lorena Vargas",
    "servicio": "Electricidad",
    "lat": -17.37,
    "lng": -66.24,
    "zona": "Tiquipaya Sur",
    "available": true
  },
  {
    "id": 31,
    "nombre": "Julio Gutierrez",
    "servicio": "Carpintería",
    "lat": -17.46,
    "lng": -66.22,
    "zona": "La Tamborada",
    "available": false
  },
  {
    "id": 32,
    "nombre": "Carmen Rojas",
    "servicio": "Limpieza",
    "lat": -17.41,
    "lng": -66.23,
    "zona": "Quillacollo Sur",
    "available": true
  },
  {
    "id": 33,
    "nombre": "Oscar Perez",
    "servicio": "Pintura",
    "lat": -17.37,
    "lng": -66.26,
    "zona": "Tiquipaya Oeste",
    "available": false
  },
  {
    "id": 34,
    "nombre": "Esteban Vallejos",
    "servicio": "Cerrajería",
    "lat": -17.355,
    "lng": -66.15,
    "zona": "Cercado Norte",
    "available": true
  },
  {
    "id": 35,
    "nombre": "Mariana Suarez",
    "servicio": "Plomería",
    "lat": -17.48,
    "lng": -66.19,
    "zona": "Valle Hermoso Sur",
    "available": false
  }
]
</file>

<file path="src/jsons/jobs.json">
[
  {
    "destacado": false,
    "imagen": "/images/electricista.jpg",
    "titulo": "Instalacion electrica",
    "descripcion": "Instalacion de puntos de luz electricos",
    "categoria": "electricidad",
    "nombreFixer": "Ana",
    "apellidoFixer": "Quispe",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-10-01T10:00:00Z",
    "calificacion": 4.0,
    "telefono": 75986518,
    "activo": true,
    "precio": {
      "min": 120,
      "max": 150
    }
  },

  {
    "destacado": true,
    "imagen": "/images/limpieza.jpg",
    "titulo": "Limpieza y aseo",
    "descripcion": "Servicio de limpieza a hogares y lugares diversos",
    "categoria": "aseo",
    "nombreFixer": "Miguel",
    "apellidoFixer": "Condori",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-10-02T09:00:00Z",
    "calificacion": 4.8,
    "telefono": 75986518,
    "activo": true,
    "precio": {
      "min": 100,
      "max": 180
    }
  },
  {
    "destacado": false,
    "imagen": "/images/pintura.jpg",
    "titulo": "Pintura para casas",
    "descripcion": "Servicio de pintura para hogares o cualquier superficie",
    "categoria": "pintura",
    "nombreFixer": "Miguel",
    "apellidoFixer": "Condori",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-10-03T09:00:00Z",
    "calificacion": 4.8,
    "telefono": 75986518,
    "activo": true,
    "precio": {
      "min": 200,
      "max": 250
    }
  },
  {
    "destacado": true,
    "imagen": "/images/carpinteria2.jpg",
    "titulo": "Reparacion de muebles",
    "descripcion": "Reparacion y restauracion de muebles variados",
    "categoria": "carpinteria",
    "nombreFixer": "Daria",
    "apellidoFixer": "Atahuichi",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-10-02T09:00:00Z",
    "calificacion": 4.5,
    "telefono": 75986518,
    "activo": true,
    "precio": {
      "min": 200,
      "max": 300
    }
  },

  {
    "destacado": true,
    "imagen": "/images/tuberias.jpg",
    "titulo": "Reparacion de tuberias",
    "descripcion": "Fuga de tuberias en cocina, baño, etc.",
    "categoria": "plomeria",
    "nombreFixer": "Carlos",
    "apellidoFixer": "Mamani",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-10-07T09:00:00Z",
    "calificacion": 4.8,
    "telefono": 75986518,
    "activo": true,
    "precio": {
      "min": 50,
      "max": 80
    }
  },
  {
    "destacado": false,
    "imagen": "/images/electricista.jpg",
    "titulo": "Reparación de enchufes",
    "descripcion": "Solución de problemas en enchufes y tomacorrientes.",
    "categoria": "electricidad",
    "nombreFixer": "Luis",
    "apellidoFixer": "Gómez",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-10-08T09:00:00Z",
    "calificacion": 4.3,
    "telefono": 75986518,
    "activo": true,
    "precio": { "min": 80, "max": 120 }
  },
  {
    "destacado": true,
    "imagen": "/images/carpintero.jpg",
    "titulo": "Puertas personalizadas",
    "descripcion": "Fabricación e instalación de puertas de madera.",
    "categoria": "carpinteria",
    "nombreFixer": "Juan",
    "apellidoFixer": "Perez",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-10-09T09:00:00Z",
    "calificacion": 4.7,
    "telefono": 75986518,
    "activo": true,
    "precio": { "min": 250, "max": 350 }
  },
  {
    "destacado": false,
    "imagen": "/images/limpieza.jpg",
    "titulo": "Limpieza profunda",
    "descripcion": "Limpieza detallada de oficinas y departamentos.",
    "categoria": "aseo",
    "nombreFixer": "Maria",
    "apellidoFixer": "Lopez",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-10-10T09:00:00Z",
    "calificacion": 4.6,
    "telefono": 75986518,
    "activo": true,
    "precio": { "min": 120, "max": 200 }
  },
  {
    "destacado": true,
    "imagen": "/images/pintura.jpg",
    "titulo": "Pintura decorativa",
    "descripcion": "Diseños y acabados decorativos en paredes.",
    "categoria": "pintura",
    "nombreFixer": "Sofia",
    "apellidoFixer": "Torrez",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-10-10T09:00:00Z",
    "calificacion": 4.9,
    "telefono": 75986518,
    "activo": true,
    "precio": { "min": 220, "max": 270 }
  },
  {
    "destacado": false,
    "imagen": "/images/tuberias.jpg",
    "titulo": "Instalación de grifos",
    "descripcion": "Colocación y reparación de grifos en baños y cocinas.",
    "categoria": "plomeria",
    "nombreFixer": "Carlos",
    "apellidoFixer": "Rojas",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-10-10T09:00:00Z",
    "calificacion": 4.5,
    "telefono": 75986518,
    "activo": true,
    "precio": { "min": 60, "max": 90 }
  },
  {
    "destacado": true,
    "imagen": "/images/electricista.jpg",
    "titulo": "Instalación de lámparas",
    "descripcion": "Montaje y conexión de lámparas y focos.",
    "categoria": "electricidad",
    "nombreFixer": "Andrea",
    "apellidoFixer": "Vargas",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-10-11T09:00:00Z",
    "calificacion": 4.8,
    "telefono": 75986518,
    "activo": true,
    "precio": { "min": 100, "max": 160 }
  },
  {
    "destacado": false,
    "imagen": "/images/carpintero.jpg",
    "titulo": "Reparación de sillas",
    "descripcion": "Arreglo de sillas y muebles dañados.",
    "categoria": "carpinteria",
    "nombreFixer": "Pedro",
    "apellidoFixer": "Salazar",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-10-13T09:00:00Z",
    "calificacion": 4.2,
    "telefono": 75986518,
    "activo": true,
    "precio": { "min": 180, "max": 250 }
  },
  {
    "destacado": true,
    "imagen": "/images/limpieza.jpg",
    "titulo": "Limpieza de alfombras",
    "descripcion": "Servicio especializado en limpieza de alfombras.",
    "categoria": "aseo",
    "nombreFixer": "Lucia",
    "apellidoFixer": "Fernandez",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-10-13T09:00:00Z",
    "calificacion": 4.7,
    "telefono": 75986518,
    "activo": true,
    "precio": { "min": 130, "max": 210 }
  },
  {
    "destacado": false,
    "imagen": "/images/pintura.jpg",
    "titulo": "Pintura de techos",
    "descripcion": "Pintado y mantenimiento de techos interiores.",
    "categoria": "pintura",
    "nombreFixer": "Fernando",
    "apellidoFixer": "Aguilar",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-10-15T09:00:00Z",
    "calificacion": 4.4,
    "telefono": 75986518,
    "activo": true,
    "precio": { "min": 210, "max": 260 }
  },
  {
    "destacado": false,
    "imagen": "/images/im.jpg",
    "titulo": "Pintura de paredes",
    "descripcion": "Pintado y mantenimiento de paredes en interiores y exteriores.",
    "categoria": "pintura",
    "nombreFixer": "Mario",
    "apellidoFixer": "Perez",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-10-18T09:00:00Z",
    "calificacion": 4.4,
    "telefono": 75986518,
    "activo": true,
    "precio": { "min": 210, "max": 260 }
  },
  {
    "destacado": true,
    "imagen": "/images/carpintero.jpg",
    "titulo": "Muebles de melamina",
    "descripcion": "Construccion de muebles",
    "categoria": "carpinteria",
    "nombreFixer": "José",
    "apellidoFixer": "Perez",
    "ubicacion": "cochabamba",
    "fechaDePublicacion": "2025-11-10T10:00:00Z",
    "calificacion": 4.2,
    "telefono": 75986518,
    "activo": true,
    "precio": {
      "min": 200,
      "max": 300
    }
  }
]
</file>

<file path="src/lib/useJobTypeAutoMatch.ts">
import { DB_VALUES, JobTypeValue, CityValue } from '@/app/redux/contants';

export function useJobTypeAutoMatch() {
  const findMatchingJobType = (searchQuery: string): JobTypeValue | null => {
    if (!searchQuery.trim()) return null;

    const query = searchQuery.toLowerCase().trim();

    const exactMatch = DB_VALUES.jobTypes.find((jobType) => jobType.toLowerCase() === query);

    if (exactMatch) return exactMatch;

    const partialMatch = DB_VALUES.jobTypes.find((jobType) =>
      jobType.toLowerCase().includes(query),
    );

    return partialMatch || null;
  };

  const findMatchingCity = (searchQuery: string): CityValue | null => {
    if (!searchQuery.trim()) return null;

    const query = searchQuery.toLowerCase().trim();

    const exactMatch = DB_VALUES.cities.find((city) => city.toLowerCase() === query);

    if (exactMatch) return exactMatch;

    const partialMatch = DB_VALUES.cities.find((city) => city.toLowerCase().includes(query));

    return partialMatch || null;
  };

  return {
    findMatchingJobType,
    findMatchingCity,
    availableJobTypes: DB_VALUES.jobTypes,
    availableCities: DB_VALUES.cities,
  };
}
</file>

<file path="src/middleware.ts">
import createMiddleware from 'next-intl/middleware';
import { routing } from './i18n/routing';

export default createMiddleware({
  locales: routing.locales,
  defaultLocale: routing.defaultLocale,
  localeDetection: true,
  localeCookie: true,
});

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
};
</file>

<file path="src/services/appointments.ts">
import { apiUrl } from '@/config/api';

export interface Appointment {
  _id: string;
  id_fixer: string;
  id_requester: string;
  selected_date: { $date: string };
  current_requester_name: string;
  appointment_type: string;
  appointment_description: string;
  link_id: string;
  current_requester_phone: string;
  starting_time: { $date: string };
  finishing_time: { $date: string };
  schedule_state: string;
  display_name_location: string;
  lat: string | null;
  lon: string | null;
  cancelled_fixer: boolean;
  reprogram_reason: string;
  createdAt: { $date: string };
  updatedAt: { $date: string };
  __v: number;
}

export async function getAppointmentsByFixerId(fixerId: string): Promise<Appointment[]> {
  try {
    const res = await fetch(apiUrl(`api/appointments/fixer/${fixerId}`), {
      cache: 'no-store',
    });

    if (!res.ok) {
      throw new Error('Failed to fetch appointments');
    }

    const appointments = await res.json();

    if (process.env.NODE_ENV !== 'production') {
      console.debug(
        `[appointments] Found ${appointments.length} appointments for fixer ${fixerId}`,
      );
    }

    return appointments;
  } catch (error) {
    console.error('Error fetching appointments:', error);
    return [];
  }
}
</file>

<file path="src/services/fixerService.ts">
import { ApiResponse, Fixer, Job, JobWithFixers } from '@/types/fixer';

const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000/api';

export const fixerService = {
  /**
   * Obtener todos los trabajos con sus fixers asociados
   */
  async getJobsWithFixers(): Promise<JobWithFixers[]> {
    try {
      const response = await fetch(`${API_BASE_URL}/jobs/with-fixers`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        throw new Error(`Error: ${response.statusText}`);
      }

      const data: ApiResponse<JobWithFixers[]> = await response.json();
      return data.data || [];
    } catch (error) {
      console.error('Error fetching jobs with fixers:', error);
      throw error;
    }
  },

  /**
   * Obtener todos los trabajos
   */
  async getJobs(): Promise<Job[]> {
    try {
      const response = await fetch(`${API_BASE_URL}/jobs`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        throw new Error(`Error: ${response.statusText}`);
      }

      const data: ApiResponse<Job[]> = await response.json();
      return data.data || [];
    } catch (error) {
      console.error('Error fetching jobs:', error);
      throw error;
    }
  },

  /**
   * Obtener todos los fixers
   */
  async getFixers(): Promise<Fixer[]> {
    try {
      const response = await fetch(`${API_BASE_URL}/fixers`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        throw new Error(`Error: ${response.statusText}`);
      }

      const data: ApiResponse<Fixer[]> = await response.json();
      return data.data || [];
    } catch (error) {
      console.error('Error fetching fixers:', error);
      throw error;
    }
  },

  /**
   * Obtener fixer por ID
   */
  async getFixerById(id: string): Promise<Fixer> {
    try {
      const response = await fetch(`${API_BASE_URL}/fixers/${id}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        throw new Error(`Error: ${response.statusText}`);
      }

      const data: ApiResponse<Fixer> = await response.json();
      return data.data;
    } catch (error) {
      console.error('Error fetching fixer:', error);
      throw error;
    }
  },

  /**
   * Obtener fixers por tipo de trabajo
   */
  async getFixersByJobType(jobType: string): Promise<Fixer[]> {
    try {
      const response = await fetch(`${API_BASE_URL}/jobs/${jobType}/fixers`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        throw new Error(`Error: ${response.statusText}`);
      }

      const data: ApiResponse<Fixer[]> = await response.json();
      return data.data || [];
    } catch (error) {
      console.error('Error fetching fixers by job type:', error);
      throw error;
    }
  },
};
</file>

<file path="src/services/job-info-jobs.ts">
import { API_BASE_URL } from '@/config/api';
import type { Job } from '@/types/jobs';
import { getJobInfo } from './job-info';

const urlsForFixer = (fixerId: string) => [
  `${API_BASE_URL}/api/jobs/fixer/${encodeURIComponent(fixerId)}`, // si tienes esta ruta
  `${API_BASE_URL}/api/jobs?fixerId=${encodeURIComponent(fixerId)}`, // fallback
];

export async function getJobsByFixerId(fixerId: string): Promise<Job[]> {
  let jobs: Job[] = [];
  let fetched = false;

  for (const url of urlsForFixer(fixerId)) {
    try {
      const res = await fetch(url, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' },
      });
      if (!res.ok) {
        continue;
      }
      const data = await res.json();
      if (Array.isArray(data)) jobs = data;
      else if (data && Array.isArray(data.jobs)) jobs = data.jobs;
      else if (data && Array.isArray(data.data)) jobs = data.data;
      else jobs = [];
      fetched = true;
      break;
    } catch (err) {
      console.error('Error fetching jobs for fixer:', err);
    }
  }

  if (!fetched) return [];

  const enriched = await Promise.allSettled(
    jobs.map(async (job) => {
      try {
        const info = await getJobInfo(job._id);
        return {
          ...job,
          Ubicacion: job.Ubicacion ?? info.Ubicacion ?? 'Desconocida',
          UbicacionOriginal: info.UbicacionOriginal ?? 'Desconocida',
        } as Job;
      } catch {
        return {
          ...job,
          Ubicacion: job.Ubicacion ?? 'Desconocida',
        } as Job;
      }
    }),
  );

  return enriched
    .map((r) => (r.status === 'fulfilled' ? r.value : (r.reason ?? null)))
    .filter(Boolean) as Job[];
}
</file>

<file path="src/services/job-info.ts">
import { API_BASE_URL } from '@/config/api';
import { JobDetails } from '@/types/job';

export type JobSummary = {
  _id: string;
  title: string;
  description: string;
  createdAt: string;
  Ubicacion: string;
  UbicacionOriginal?: string;
  status: string;
};

export async function getJobInfo(jobId: string): Promise<JobSummary> {
  const res = await fetch(`${API_BASE_URL}/api/job-info/${encodeURIComponent(jobId)}`, {
    method: 'GET',
    headers: { 'Content-Type': 'application/json' },
  });

  if (!res.ok) {
    throw new Error(`getJobInfo failed: ${res.status}`);
  }

  return res.json();
}

export const getJobForFixerInfo = async (jobId: string, fixerId: string): Promise<JobDetails> => {
  const res = await fetch(
    `${API_BASE_URL}/api/job-rating-details/${encodeURIComponent(fixerId)}/${encodeURIComponent(jobId)}`,
    {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' },
    },
  );

  if (!res.ok) {
    throw new Error(`getJobForFixerInfo failed: ${res.status}`);
  }

  return res.json();
};
</file>

<file path="src/services/job-request.modal.ts">
import type { UserLocation, CreateJobRequestPayload, JobRequest } from '../types/job-request';
import { apiUrl } from '@/config/api';

export async function getUserLocation(token: string): Promise<UserLocation> {
  const userId = '68ec99ddf39c7c140f42fcfa';

  const res = await fetch(apiUrl(`api/jobrequests/${userId}/location`), {
    headers: { Authorization: `Bearer ${token}` },
  });

  if (!res.ok) {
    throw new Error('Error al cargar la ubicación');
  }

  const data = await res.json();

  return data;
}

export async function createJobRequest(
  payload: CreateJobRequestPayload,
  token: string,
): Promise<JobRequest> {
  const res = await fetch(apiUrl('api/jobrequests'), {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`,
    },
    body: JSON.stringify(payload),
  });

  const data = await res.json();
  if (!res.ok) throw new Error(data.msg || 'Error al guardar la solicitud.');

  return data as JobRequest;
}
</file>

<file path="src/services/job-requests.ts">
import { UserLocation, CreateJobRequestPayload } from '../types/job-request';
import { apiUrl } from '@/config/api';

export async function getUserLocation(token: string): Promise<UserLocation> {
  const res = await fetch(apiUrl('api/profile/location'), {
    headers: { Authorization: `Bearer ${token}` },
  });

  const data = await res.json();
  if (!res.ok) throw new Error(data.msg || 'Error al cargar la ubicación.');

  return {
    lat: data.coordinates[1],
    lng: data.coordinates[0],
  };
}

export async function createJobRequest(
  payload: CreateJobRequestPayload,
  token: string,
): Promise<unknown> {
  const res = await fetch(apiUrl('api/jobrequests'), {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`,
    },
    body: JSON.stringify(payload),
  });

  const data = await res.json();
  if (!res.ok) throw new Error(data.msg || 'Error al guardar la solicitud.');

  return data;
}
</file>

<file path="src/services/jobs.ts">
import { Job } from '@/types/job';
import { apiUrl } from '@/config/api';

export async function getJobsByFixerId(fixerId: string, init?: RequestInit): Promise<Job[]> {
  if (!fixerId) throw new Error('fixerId is required');
  const url = apiUrl(`api/fixers/${encodeURIComponent(fixerId)}/jobs`);
  if (process.env.NODE_ENV !== 'production') {
    console.debug('[jobs] GET:', url);
  }

  const res = await fetch(url, {
    cache: 'no-store',
    ...init,
    headers: {
      'Content-Type': 'application/json',
      ...(init?.headers || {}),
    },
  });

  if (!res.ok) {
    const text = await res.text().catch(() => '');
    throw new Error(`Failed to fetch jobs (${res.status}): ${text || res.statusText}`);
  }

  let data: unknown;
  try {
    data = (await res.json()) as unknown;
  } catch {
    const raw = await res.text().catch(() => '');
    throw new Error(`Invalid JSON from jobs endpoint. Body: ${raw?.slice(0, 200)}`);
  }
  const list = extractJobsArray(data);
  if (!Array.isArray(list)) {
    throw new Error('Unexpected response: expected an array of jobs');
  }
  const cleaned = list.filter((j: unknown): j is Job => isJobLike(j));
  return cleaned as Job[];
}

function extractJobsArray(payload: unknown): unknown[] | null {
  if (Array.isArray(payload)) return payload;
  if (!payload || typeof payload !== 'object') return null;

  const jobs = getArrayProp(payload, 'jobs');
  if (jobs) return jobs;

  const dataArr = getArrayProp(payload, 'data');
  if (dataArr) return dataArr;

  const dataObj = getObjectProp(payload, 'data');
  if (dataObj) {
    const nestedJobs = getArrayProp(dataObj, 'jobs');
    if (nestedJobs) return nestedJobs;
  }

  const items = getArrayProp(payload, 'items');
  if (items) return items;

  const results = getArrayProp(payload, 'results');
  if (results) return results;

  const anyTopArray = findFirstArray(payload);
  if (anyTopArray) return anyTopArray;

  const nestedObj = findFirstObject(payload);
  if (nestedObj) {
    const nestedArray = findFirstArray(nestedObj);
    if (nestedArray) return nestedArray;
  }

  return null;
}

function getArrayProp(o: unknown, key: string): unknown[] | null {
  if (!o || typeof o !== 'object') return null;
  const val = (o as Record<string, unknown>)[key];
  return Array.isArray(val) ? (val as unknown[]) : null;
}

function getObjectProp(o: unknown, key: string): Record<string, unknown> | null {
  if (!o || typeof o !== 'object') return null;
  const val = (o as Record<string, unknown>)[key];
  return val && typeof val === 'object' ? (val as Record<string, unknown>) : null;
}

function findFirstArray(o: unknown): unknown[] | null {
  if (!o || typeof o !== 'object') return null;
  for (const v of Object.values(o as Record<string, unknown>)) {
    if (Array.isArray(v)) return v as unknown[];
  }
  return null;
}

function findFirstObject(o: unknown): Record<string, unknown> | null {
  if (!o || typeof o !== 'object') return null;
  for (const v of Object.values(o as Record<string, unknown>)) {
    if (v && typeof v === 'object' && !Array.isArray(v)) return v as Record<string, unknown>;
  }
  return null;
}

function isJobLike(x: unknown): x is Job {
  if (!x || typeof x !== 'object') return false;
  const o = x as Record<string, unknown>;
  return typeof o._id === 'string' && typeof o.title === 'string';
}
</file>

<file path="src/services/promotions.ts">
import { apiUrl } from '@/config/api';
import { Promotion, CreatePromotion } from '@/types/promotion';

export async function getPromotionsByOfferId(offerId: string): Promise<Promotion[]> {
  try {
    const response = await fetch(apiUrl(`api/promotions/offer/${offerId}`), {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
      cache: 'no-store',
    });

    if (!response.ok) {
      throw new Error(`Error fetching promotions: ${response.status}`);
    }

    return await response.json();
  } catch (error) {
    console.error('Failed to get promotions', error);
    return [];
  }
}
export async function createPromotion(promotion: CreatePromotion): Promise<Promotion | null> {
  try {
    const response = await fetch(apiUrl('api/promotions'), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(promotion),
    });

    if (!response.ok) {
      throw new Error(`Error creating promotion: ${response.status}`);
    }

    return await response.json();
  } catch (error) {
    console.error('Failed to create promotion', error);
    return null;
  }
}

export async function updatePromotion(
  id: string,
  promotion: { title: string; description: string },
): Promise<Promotion | null> {
  try {
    const response = await fetch(apiUrl(`api/promotions/${id}`), {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(promotion),
    });

    if (!response.ok) {
      throw new Error(`Error updating promotion: ${response.status}`);
    }

    return await response.json();
  } catch (error) {
    console.error('Failed to update promotion', error);
    return null;
  }
}

export async function deletePromotion(id: string): Promise<boolean> {
  try {
    const response = await fetch(apiUrl(`api/promotions/${id}`), {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
    });

    return response.ok;
  } catch (error) {
    console.error('Error deleting promotion:', error);
    return false;
  }
}
</file>

<file path="src/shared/ui/ModalComponent.tsx">
interface ModalProps {
  children: React.ReactNode;
  isOpen?: boolean;
  onClose: () => void;
  Accept: () => void;
}

export const ModalComponent = ({ children, isOpen, onClose, Accept }: ModalProps) => {
  if (!isOpen) return null;

  return (
    <div
      className='fixed inset-0 flex items-center justify-center z-50 w-full h-full bg-transparent'
      aria-modal
      onClick={
        onClose ||
        (() => {
          isOpen = false;
        })
      }
    >
      <div
        className='flex flex-col gap-6 relative bg-white p-12 rounded-4xl shadow-lg'
        onClick={(e) => e.stopPropagation()}
      >
        <button
          className='absolute top-8 right-8 text-gray-600 hover:text-gray-800 cursor-pointer'
          onClick={
            onClose ||
            (() => {
              isOpen = false;
            })
          }
        >
          x
        </button>
        {children}
        <button className='bg-black p-5 text-white rounded-lg' onClick={Accept}>
          Accept
        </button>
      </div>
    </div>
  );
};
</file>

<file path="src/types/fixer-component.ts">
export interface Location {
  lat: number;
  lng: number;
  address: string;
}

export interface ComponentJobOffer {
  id: string;
  title: string;
  description: string;
  services: string[];
  price: number;
  createdAt: Date;
  city: string;
  rating: number;
  completedJobs: number;
  location: Location;
  fixerId: string;
  fixerName: string;
  tags: string[];
  whatsapp: string;
  photos: string[];
}

export interface Fixer {
  id: string;
  name: string;
  email: string;
  phone: string;
  photo: string;
  city: string;
  rating: number;
  completedJobs: number;
  services: string[];
  bio: string;
  joinDate: string;
  location?: Location | null;
  jobOffers: ComponentJobOffer[];
  paymentMethods: string[];
  whatsapp: string;
}
</file>

<file path="src/types/fixer-profile.ts">
export interface IJobOffer {
  _id: string;
  fixerId: string;
  fixerName: string;
  title: string;
  description: string;
  category: string;
  tags?: string[];
  price: number;
  city: string;
  contactPhone: string;
  photos: string[];
  rating?: number;
  status?: boolean;
  createdAt?: string;
  updatedAt?: string;
  __v?: number;
}

export interface ICertification {
  _id?: string;
  fixerId: string;
  name: string;
  institution: string;
  issueDate: string;
  expiryDate?: string;
  credentialId?: string;
  credentialUrl?: string;
  createdAt?: string;
  updatedAt?: string;
}

export interface IExperience {
  _id?: string;
  fixerId: string;
  jobTitle: string;
  jobType: string;
  organization: string;
  isCurrent: boolean;
  startDate: string;
  endDate?: string | null;
  createdAt?: string;
  updatedAt?: string;
}

export interface IPortfolioItem {
  _id?: string;
  fixerId: string;
  type: 'image' | 'video';
  url?: string;
  youtubeUrl?: string | null;
  createdAt?: string;
  updatedAt?: string;
}
</file>

<file path="src/types/fixer.ts">
export interface Fixer {
  id: string;
  name: string;
  city: string;
  rating: number;
  avatar?: string;
  description?: string;
  phone?: string;
  email?: string;
}

export interface Job {
  id: string;
  jobType: string;
  description?: string;
}

export interface JobWithFixers {
  jobType: string;
  fixers: Fixer[];
}

export interface ApiResponse<T> {
  success: boolean;
  data: T;
  message?: string;
  error?: string;
}
</file>

<file path="src/types/job-offer.ts">
export interface IUserProfile {
  user: {
    id: string;
    name: string;
    email: string;
    phone: string;
    role: 'fixer' | 'requester';
    urlPhoto?: string;
  };
  profile: {
    ci: string;
    photoUrl?: string;
    location?: {
      lat: number;
      lng: number;
      address?: string;
    } | null;
    services: Array<{
      id: string;
      name: string;
      custom?: boolean;
    }>;
    selectedServiceIds: string[];
    paymentMethods: Array<{
      type: string;
      accountInfo?: string;
    }>;
    experiences: Array<{
      id: string;
      title: string;
      description: string;
      years: number;
      images?: Array<{
        id: string;
        url: string;
        name: string;
        size: number;
        type: string;
      }>;
    }>;
    vehicle?: {
      hasVehicle?: boolean;
      type?: string;
      details?: string;
    };
    terms: {
      accepted: boolean;
      acceptedAt?: Date;
    };
    additionalInfo?: {
      bio?: string;
      languages?: string[];
      availability?: {
        monday: boolean;
        tuesday: boolean;
        wednesday: boolean;
        thursday: boolean;
        friday: boolean;
        saturday: boolean;
        sunday: boolean;
      };
      hourlyRate?: number;
    };
    status: 'pending' | 'approved' | 'rejected';
    createdAt: Date;
    updatedAt: Date;
  };
}

export interface Location {
  lat: number;
  lng: number;
  address?: string;
}
</file>

<file path="src/types/job-request.ts">
export interface AppointmentTime {
  $date: string;
}

export interface Appointment {
  _id: string;
  id_fixer: string;
  id_requester: string;
  selected_date: { $date: string };
  current_requester_name: string;
  appointment_type: string;
  appointment_description: string;
  link_id: string;
  current_requester_phone: string;
  starting_time: AppointmentTime;
  finishing_time: AppointmentTime;
  schedule_state: string;
  display_name_location: string;
  lat: string | null;
  lon: string | null;
  cancelled_fixer: boolean;
  reprogram_reason: string;
  createdAt: { $date: string };
  updatedAt: { $date: string };
  __v: number;
}

export interface UserLocation {
  lat: string;
  lng: string;
}

export interface CreateJobRequestPayload {
  title: string;
  description: string;
  location: {
    type: 'Point';
    coordinates: [string, string];
  };
  startTime: string;
  endTime: string;
  price: string | number;
  fixerId: string;
  requesterId: string;
  appointmentId?: string;
  offerId?: string;
}

export interface JobRequest {
  _id: string;
  title: string;
  description: string;
  location?: {
    type: 'Point';
    coordinates: [string, string];
  };
  startTime?: string;
  endTime?: string;
  price: number;
  requesterId: string;
  fixerId?: string;
  status: 'pending' | 'accepted' | 'in_progress' | 'completed' | 'cancelled' | 'paid';
  createdAt: string;
  updatedAt?: string;
  rating?: number;
  comment?: string;
  type?: string;
}

export interface Location {
  lat: number;
  lng: number;
}

export interface JobRequestData {
  jobMotive: string;
  jobDescription: string;
  locationOption: 'keep' | 'modify';
  startTime: string;
  endTime: string;
  suggestedRate: string;
}

export interface JobRequestModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: JobRequest) => void;
  fixerId: string;
  appointmentData?: Appointment;
  offerId?: string;
}

export interface JobRequestFormProps {
  initialLocation: Location | null;
  loading: boolean;
  onSubmit: (formData: JobRequestData, newLocation: Location | null) => void;
  onCancel: () => void;
  initialFormData?: JobRequestData;
}
</file>

<file path="src/types/job.ts">
export interface Job {
  _id: string;
  title: string;
  description: string;
  status: string;
  requesterId: string;
  fixerId: string;
  price: number;
  createdAt: string;
  rating?: number;
  comment?: string;
}

export interface JobDetails {
  title: string;
  date: string;
  rating: number;
  description: string;
  serviceType: string;
  comment: string;
  createdAt?: string;
  type?: string;
}
</file>

<file path="src/types/jobOffers.ts">
export interface JobOfferData {
  _id: string;
  fixerId: string;
  fixerName: string;
  fixerPhoto?: string;
  title: string;
  description: string;
  category: string;
  tags: string[];
  price: number;
  city: string;
  contactPhone: string;
  createdAt: string | Date;
  rating?: number;
  photos?: string[];
  imagenUrl?: string;
  allImages?: string[];
  completedJobs?: number;
  location?: string[];
  status?: boolean;
  updatedAt?: string | Date;
}

/**
 * Tipo adaptado para el modal de ofertas
 */
export interface AdaptedJobOffer {
  _id: string;
  fixerId: string;
  name: string;
  title: string;
  description: string;
  tags: string[];
  phone: string;
  photos: string[];
  services: string[];
  price: number;
  createdAt: Date;
  city: string;
}

/**
 * Utilidad para adaptar datos del backend al formato del modal
 */
export const adaptOfferToModalFormat = (offer: JobOfferData): AdaptedJobOffer | null => {
  if (!offer) return null;

  let photos: string[] = [];
  if (offer.photos && offer.photos.length > 0) {
    photos = offer.photos;
  } else if (offer.imagenUrl) {
    photos = [offer.imagenUrl];
  }

  return {
    _id: offer._id,
    fixerId: offer.fixerId,
    name: offer.fixerName,
    title: offer.title,
    description: offer.description,
    tags: offer.tags || [],
    phone: offer.contactPhone,
    photos: photos,
    services: offer.category ? [offer.category] : [],
    price: offer.price,
    createdAt: new Date(offer.createdAt || Date.now()),
    city: offer.city,
  };
};

/**
 * Utilidad para preparar imágenes de una oferta
 */
export const prepareOfferImages = (offer: JobOfferData): string[] => {
  if (offer.allImages && offer.allImages.length > 0) {
    return offer.allImages;
  }
  if (offer.photos && offer.photos.length > 0) {
    return offer.photos;
  }
  if (offer.imagenUrl) {
    return [offer.imagenUrl];
  }
  return [];
};
</file>

<file path="src/types/jobs.ts">
export type Job = {
  _id: string;
  title: string;
  description?: string;
  status?: string;
  requesterId?: string;
  fixerId?: string;
  price?: number | string;
  createdAt?: string;
  rating?: number | string;
  comment?: string;
  Ubicacion?: string;
  UbicacionOriginal?: string;
};
</file>

<file path="src/types/leaflet.d.ts">
declare namespace L {
  interface LatLng {
    lat: number;
    lng: number;
  }

  interface LeafletEvent {
    latlng: LatLng;
  }

  interface LayerOptions {
    attribution?: string;
    maxZoom?: number;
  }

  interface Layer {
    addTo(map: Map): this;
  }

  interface Marker extends Layer {
    setLatLng(latlng: LatLng): this;
  }

  type LatLngBounds = object;

  interface PanInsideBoundsOptions {
    animate?: boolean;
  }

  interface Map {
    setView(center: LatLng | [number, number], zoom: number): this;
    on(type: string, fn: (e: LeafletEvent) => void): this;
    remove(): void;
    removeLayer(layer: Layer): this;
    setMaxBounds(bounds: LatLngBounds): this;
    panInsideBounds(bounds: LatLngBounds, options?: PanInsideBoundsOptions): this;
  }

  function map(element: HTMLElement): Map;
  function tileLayer(urlTemplate: string, options?: LayerOptions): Layer;
  function marker(latlng: LatLng | [number, number]): Marker;
  function latLng(lat: number, lng: number): LatLng;
  function latLngBounds(corner1: LatLng, corner2: LatLng): LatLngBounds;
}

interface Window {
  L: typeof L;
}

declare module 'leaflet/dist/leaflet.css' {
  const content: string;
  export default content;
}
</file>

<file path="src/types/promotion.ts">
export interface Promotion {
  _id: string;
  title: string;
  description: string;
  price: number;
  offerId: string;
  fixerId: string;
  createdAt: string;
}
export interface CreatePromotion {
  title: string;
  description: string;
  offerId: string;
  price: string;
  fixerId: string;
}
</file>

<file path="src/utils/Appointments/getAppointmentsByHour.ts">
import axios from 'axios';
export interface Appointment {
  _id: string;
  id_fixer: string;
  id_requester: string;
  selected_date: string;
  current_requester_name: string;
  appointment_type: string;
  appointment_description: string;
  link_id: string;
  current_requester_phone: string;
  starting_time: string;
  finishing_time: string;
  schedule_state: string;
  display_name_location: string;
  lat: string;
  lon: string;
  cancelled_fixer: boolean;
  active: boolean;
  reprogram_reason: string;
  createdAt: string;
  updatedAt: string;
  __v: number;
}
interface ApiResponse {
  succeed: boolean;
  message: string;
  data: Appointment[];
}

export async function getAppointmentsByHour(
  fixer_id: string,
  date: string,
  hour: number,
): Promise<Appointment[]> {
  try {
    const response = await axios.get<ApiResponse>(
      'https://servineo-backend-lorem.onrender.com/api/crud_read/appointments/get_appointment_by_fixer_hour',
      {
        params: {
          fixer_id,
          date,
          hour,
        },
      },
    );

    if (response.data.message && response.data.data) {
      return response.data.data;
    } else {
      console.log('No se encontraron citas ');
      return [];
    }
  } catch (error) {
    if (axios.isAxiosError(error)) {
      console.error('Error de Axios:', {
        message: error.message,
        status: error.response?.status,
        data: error.response?.data,
      });
    } else {
      console.error('Error desconocido:', error);
    }
    return [];
  }
}
</file>

<file path="src/utils/Appointments/getSixMonthAppointments.ts">
import axios from 'axios';

export interface Appointment {
  _id: string;
  id_fixer: string;
  id_requester: string;
  selected_date: string;
  current_requester_name: string;
  appointment_type: string;
  appointment_description: string;
  link_id: string;
  current_requester_phone: string;
  starting_time: string;
  finishing_time: string;
  schedule_state: string;
  display_name_location: string;
  lat: string;
  lon: string;
  cancelled_fixer: boolean;
  active: boolean;
  reprogram_reason: string;
  createdAt: string;
  updatedAt: string;
  __v: number;
}

interface ApiResponse {
  message: string;
  appointments: Appointment[];
}

export async function getSixMonthAppointments(
  fixerId: string,
  date: string,
): Promise<Appointment[]> {
  try {
    const response = await axios.get<ApiResponse>(
      'https://servineo-backend-lorem.onrender.com/api/crud_read/schedules/get_six_months_appointments',
      {
        params: {
          fixer_id: fixerId,
          date: date,
        },
      },
    );

    if (response.data.message && response.data.appointments) {
      return response.data.appointments;
    } else {
      console.log('No se encontraron citas ');
      return [];
    }
  } catch (error) {
    if (axios.isAxiosError(error)) {
      console.error('Error de Axios:', {
        message: error.message,
        status: error.response?.status,
        data: error.response?.data,
      });
    } else {
      console.error('Error desconocido:', error);
    }
    return [];
  }
}
</file>

<file path="src/utils/contexts/AppointmentsContext/AppoinmentsContext.tsx">
'use client';
import React, { createContext, useContext, useMemo, ReactNode } from 'react';

interface AppointmentsContextType {
  isHourBookedFixer: (date: Date, hour: number) => boolean;
  isHourBooked: (date: Date, hour: number, requester_id: string) => 'self' | 'other' | 'notBooked';
  isEnabled: (date: Date, hour: number) => boolean;
  isCanceled: (
    date: Date,
    hour: number,
    requester_id: string,
  ) => 'fixer' | 'requester' | 'otherFixer' | 'otherRequester' | 'notCancel';
  getAppointmentsForDay: (
    day: number,
    month: number,
    year: number,
  ) => 'full' | 'partial' | 'available' | 'disabled';
  loading: boolean;
  refetchAll: () => void;
  refetchHour: (date: Date, hour: number) => void;
}

const AppointmentsContext = createContext<AppointmentsContextType | null>(null);

export function useAppointmentsContext() {
  const context = useContext(AppointmentsContext);
  if (!context) {
    throw new Error('useAppointmentsContext must be within AppointmentsProvider');
  }
  return context;
}

interface AppointmentsProviderProps {
  children: ReactNode;
  isHourBookedFixer: (date: Date, hour: number) => boolean;
  isHourBooked: (date: Date, hour: number, requester_id: string) => 'self' | 'other' | 'notBooked';
  isEnabled: (date: Date, hour: number) => boolean;
  isCanceled: (
    date: Date,
    hour: number,
    requester_id: string,
  ) => 'fixer' | 'requester' | 'otherFixer' | 'otherRequester' | 'notCancel';
  getAppointmentsForDay: (
    day: number,
    month: number,
    year: number,
  ) => 'full' | 'partial' | 'available' | 'disabled';
  loading: boolean;
  refetchAll: () => void;
  refetchHour: (date: Date, hour: number) => void;
}

export function AppointmentsProvider({
  children,
  isHourBookedFixer,
  isHourBooked,
  isEnabled,
  isCanceled,
  getAppointmentsForDay,
  loading,
  refetchAll,
  refetchHour,
}: AppointmentsProviderProps) {
  const value = useMemo(
    () => ({
      isHourBookedFixer,
      isHourBooked,
      isEnabled,
      isCanceled,
      getAppointmentsForDay,
      loading,
      refetchAll,
      refetchHour,
    }),
    [
      isHourBookedFixer,
      isHourBooked,
      isEnabled,
      isCanceled,
      getAppointmentsForDay,
      loading,
      refetchAll,
      refetchHour,
    ],
  );

  return <AppointmentsContext.Provider value={value}>{children}</AppointmentsContext.Provider>;
}
</file>

<file path="src/utils/contexts/DayliViewRequesterContext.tsx">
'use client';
import React, { createContext, useContext, useEffect, useState } from 'react';

type Ctx = {
  loading: boolean;
  isHourBooked: (date: Date, hour: number) => boolean;
  isOccupiedByOther: (date: Date, hour: number) => boolean;
  isDisabled: (date: Date, hour: number) => boolean;
  isCancelledByFixer: (date: Date, hour: number) => boolean;
  isCancelledByRequester: (date: Date, hour: number) => boolean;
};

const CtxObj = createContext<Ctx | null>(null);

export function useDailyAppointments(): Ctx {
  const ctx = useContext(CtxObj);
  if (!ctx) throw new Error('useAppointmentsContext must be within AppointmentsStatusProvider');
  return ctx;
}

const API_BASE = 'https://servineo-backend-lorem.onrender.com';
const pad2 = (n: number) => String(n).padStart(2, '0');
const ymdLocal = (d: Date) => `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
const sameLocalDay = (a: Date, b: Date) =>
  a.getFullYear() === b.getFullYear() &&
  a.getMonth() === b.getMonth() &&
  a.getDate() === b.getDate();

async function getJSON<T>(url: string, signal?: AbortSignal): Promise<T | null> {
  const r = await fetch(url, { headers: { Accept: 'application/json' }, signal });
  if (!r.ok) return null;
  return r.json().catch(() => null);
}

type RowDay = { starting_hour: number; schedule_state: string };
type CancelFixerResp = { cancelled_schedules_fixer?: Array<{ starting_hour: number }> };
type CancelRequesterResp = { cancelled_schedules_requester?: Array<{ starting_hour: number }> };

export interface ProviderProps {
  fixerId: string;
  requesterId: string;
  selectedDate: Date;
  children: React.ReactNode;
}

export function AppointmentsStatusProvider({
  fixerId,
  requesterId,
  selectedDate,
  children,
}: ProviderProps) {
  const [loading, setLoading] = useState(false);
  const [bookedMine, setBookedMine] = useState<Set<number>>(new Set());
  const [occupiedOthers, setOccupiedOthers] = useState<Set<number>>(new Set());
  const [cancelByFixer, setCancelByFixer] = useState<Set<number>>(new Set());
  const [cancelByRequester, setCancelByRequester] = useState<Set<number>>(new Set());

  useEffect(() => {
    let alive = true;
    const ac = new AbortController();

    async function load() {
      setLoading(true);
      try {
        const ymd = ymdLocal(selectedDate);
        const uBooked = new URL(
          `${API_BASE}/api/crud_read/schedules/get_by_fixer_current_requester_day`,
        );
        uBooked.searchParams.set('fixer_id', fixerId);
        uBooked.searchParams.set('requester_id', requesterId);
        uBooked.searchParams.set('searched_date', ymd);

        const uOccupied = new URL(
          `${API_BASE}/api/crud_read/schedules/get_by_fixer_other_requesters_day`,
        );
        uOccupied.searchParams.set('fixer_id', fixerId);
        uOccupied.searchParams.set('requester_id', requesterId);
        uOccupied.searchParams.set('searched_date', ymd);

        const uCFixer = new URL(
          `${API_BASE}/api/crud_read/schedules/get_cancelled_appointments_by_fixer_date`,
        );
        uCFixer.searchParams.set('fixer_id', fixerId);
        uCFixer.searchParams.set('requester_id', requesterId);
        uCFixer.searchParams.set('searched_date', ymd);

        const uCReq = new URL(
          `${API_BASE}/api/crud_read/schedules/get_cancelled_appointments_by_requester_date`,
        );
        uCReq.searchParams.set('fixer_id', fixerId);
        uCReq.searchParams.set('requester_id', requesterId);
        uCReq.searchParams.set('searched_date', ymd);

        const [rBooked, rOccupied, rCFixer, rCReq] = await Promise.all([
          getJSON<RowDay[]>(uBooked.toString(), ac.signal),
          getJSON<RowDay[]>(uOccupied.toString(), ac.signal),
          getJSON<CancelFixerResp>(uCFixer.toString(), ac.signal),
          getJSON<CancelRequesterResp>(uCReq.toString(), ac.signal),
        ]);

        if (!alive) return;

        setBookedMine(new Set((rBooked ?? []).map((x) => Number(x.starting_hour))));
        setOccupiedOthers(new Set((rOccupied ?? []).map((x) => Number(x.starting_hour))));
        setCancelByFixer(
          new Set((rCFixer?.cancelled_schedules_fixer ?? []).map((x) => Number(x.starting_hour))),
        );
        setCancelByRequester(
          new Set((rCReq?.cancelled_schedules_requester ?? []).map((x) => Number(x.starting_hour))),
        );
      } catch (err) {
        if (err instanceof Error && err.name === 'AbortError') {
          console.log('Requested aborted.');
          return;
        }
        console.error('Error loading appointments: ', err);
      } finally {
        if (alive) setLoading(false);
      }
    }

    load();
    return () => {
      alive = false;
      ac.abort();
    };
  }, [fixerId, requesterId, selectedDate]);

  const sameDay = (d: Date) => sameLocalDay(d, selectedDate);

  function isCancelledByFixer(date: Date, hour: number) {
    return sameDay(date) && cancelByFixer.has(hour);
  }
  function isCancelledByRequester(date: Date, hour: number) {
    return sameDay(date) && cancelByRequester.has(hour);
  }
  function isOccupiedByOther(date: Date, hour: number) {
    return sameDay(date) && occupiedOthers.has(hour);
  }
  function isHourBooked(date: Date, hour: number) {
    if (!sameDay(date)) return false;
    if (cancelByRequester.has(hour)) return false;
    if (cancelByFixer.has(hour)) return false;
    return bookedMine.has(hour);
  }
  function isDisabled(date: Date, hour: number) {
    if (!sameDay(date)) return true;
    if (occupiedOthers.has(hour)) return true;
    if (cancelByFixer.has(hour)) return true;
    return false;
  }

  const value: Ctx = {
    loading,
    isHourBooked,
    isOccupiedByOther,
    isDisabled,
    isCancelledByFixer,
    isCancelledByRequester,
  };

  return <CtxObj.Provider value={value}>{children}</CtxObj.Provider>;
}
</file>

<file path="src/utils/contexts/UserRoleContext.tsx">
'use client';

import { createContext, useContext, ReactNode } from 'react';

export type UserRole = 'fixer' | 'requester';

interface UserRoleContextType {
  role: UserRole;
  fixer_id: string;
  requester_id: string;
  currentUser_id: string;
  isFixer: boolean;
  isRequester: boolean;
}
const UserRoleContext = createContext<UserRoleContextType | undefined>(undefined);

interface UserRoleProviderProps {
  children: ReactNode;
  role: UserRole;
  fixer_id: string;
  requester_id: string;
}

export function UserRoleProvider({
  children,
  role,
  fixer_id,
  requester_id,
}: UserRoleProviderProps) {
  const currentUser_id = role === 'fixer' ? fixer_id : requester_id;

  return (
    <UserRoleContext.Provider
      value={{
        role,
        fixer_id,
        requester_id,
        currentUser_id,
        isFixer: role === 'fixer',
        isRequester: role === 'requester',
      }}
    >
      {children}
    </UserRoleContext.Provider>
  );
}

export function useUserRole() {
  const context = useContext(UserRoleContext);
  if (!context) {
    throw new Error('useUserRole must be used within UserRoleProvider');
  }
  return context;
}
</file>

<file path="src/utils/generateSlots.ts">
// lib/generateAvailableSlotsFromAPI.ts

const API = process.env.NEXT_PUBLIC_BACKEND as string;

import moment from 'moment';
import axios from 'axios';

export interface SlotEvent {
  title: string;
  start: Date;
  end: Date;
  booked: boolean;
  color?: string;
  id: string;
  cancelledByUser?: boolean;
  isBreakTime?: boolean;
  editable?: boolean;
}

export interface Schedule {
  _id: string;
  appointment_description: string;
  starting_time: string;
  finishing_time: string;
  schedule_state: string;
  display_name_location: string;
  lat: number;
  lon: number;
}

//Combinar las Schedules pautadas de todos los requesters (que seran ocupadas) y
//las del requester que esta viendo el calendario de Fixer (booked)
function combineSchedules(
  currentRequesterSchedules: Schedule[],
  otherRequesterSchedules: Schedule[],
): Schedule[] {
  // Combinar ambos arrays
  const combined = [...currentRequesterSchedules, ...otherRequesterSchedules];

  for (const schedule of currentRequesterSchedules) {
    if (schedule.schedule_state != 'cancelled') {
      schedule.schedule_state = 'booked';
    }
  }

  for (const schedule of otherRequesterSchedules) {
    schedule.schedule_state = 'occupied';
  }

  console.log('desde combinedSchedules: ', combined);
  // Ordenar por starting_time ascendente (con Z)
  combined.sort((a, b) => a.starting_time.localeCompare(b.starting_time));

  // Convertir a formato sin Z después del sort
  const schedulesWithoutZ = combined.map((schedule) => ({
    ...schedule,
    starting_time: schedule.starting_time ? schedule.starting_time.replace('Z', '') : '',
    finishing_time: schedule.finishing_time ? schedule.finishing_time.replace('Z', '') : '',
  }));

  return schedulesWithoutZ;
}
/**
 * Genera slots disponibles para horarios laborales que no tienen schedules
 * Solo genera slots para días futuros (no anteriores a hoy)
 */
function generateAvailableSlotsForMonth(month: number, year: number, fixerId: string): SlotEvent[] {
  const slots: SlotEvent[] = [];

  // Obtener el primer y último día del mes
  const startDate = new Date(year, month, 1);
  const endDate = new Date(year, month + 1, 0);

  //console.log(startDate, endDate);

  const current = new Date(startDate);
  const today = new Date();
  today.setHours(0, 0, 0, 0); // Normalizar a inicio del día

  while (current <= endDate) {
    // SOLO generar slots para días futuros (incluyendo hoy)
    if (current >= today) {
      const day = current.getDay(); // 0=domingo, 6=sábado

      // Solo días laborales (lunes a viernes)
      if (day >= 1 && day <= 5) {
        // Horario mañana: 8-12
        for (let hour = 8; hour < 12; hour++) {
          const start = new Date(current);
          start.setHours(hour, 0, 0, 0);
          const end = new Date(start);
          end.setHours(hour + 1);

          // Para el día actual, solo generar slots futuros (no horas pasadas)
          if (start > new Date()) {
            slots.push({
              title: 'Disponible',
              start,
              end,
              booked: false,
              color: '#16A34A',
              isBreakTime: false,
              id: `available-${fixerId}-${start.toISOString()}`,
            });
          }
        }

        // Horarios no Disponibles 12 - 14
        for (let hour = 12; hour < 14; hour++) {
          const start = new Date(current);
          start.setHours(hour, 0, 0, 0);
          const end = new Date(start);
          end.setHours(hour + 1);

          slots.push({
            title: 'No Disponible',
            start,
            end,
            booked: true,
            editable: false,
            color: '#64748B',
            isBreakTime: true,
            id: `occupied-${fixerId}-${start.toISOString()}`,
          });
        }

        // Horario tarde: 14-18
        for (let hour = 14; hour < 18; hour++) {
          const start = new Date(current);
          start.setHours(hour, 0, 0, 0);
          const end = new Date(start);
          end.setHours(hour + 1);

          // Para el día actual, solo generar slots futuros (no horas pasadas)
          if (start > new Date()) {
            slots.push({
              title: 'Disponible',
              start,
              end,
              booked: false,
              color: '#16A34A',
              isBreakTime: false,
              id: `available-${fixerId}-${start.toISOString()}`,
            });
          }
        }
      }
    }

    current.setDate(current.getDate() + 1);
  }

  return slots;
}

/**
 * Genera los slots de un fixer específico desde la API + slots disponibles
 */
export async function generateAvailableSlotsFromAPI(
  fixerId: string,
  requesterId: string,
  selectedDate: Date,
): Promise<SlotEvent[]> {
  const slots: SlotEvent[] = [];

  const targetDate = selectedDate || new Date();
  const currentYear = targetDate.getFullYear();
  const month = targetDate.getMonth();

  const now = new Date(); // Fecha y hora actual

  try {
    // Consultas con axios
    const [currentRequesterResponse, otherRequesterResponse] = await Promise.all([
      axios.get(`${API}/api/crud_read/schedules/get_by_fixer_current_requester_month`, {
        params: {
          fixer_id: fixerId,
          requester_id: requesterId,
          month: month + 1,
        },
      }),
      axios.get(`${API}/api/crud_read/schedules/get_by_fixer_other_requesters_month`, {
        params: {
          fixer_id: fixerId,
          requester_id: requesterId,
          month: month + 1,
        },
      }),
    ]);

    // Sin Axios
    //const currentRequesterResponse = await fetch(`${API}/api/crud_read/schedules/get_by_fixer_current_requester_month?fixer_id=${fixerId}&requester_id=${requesterId}&month=${month+1}`);
    //const otherRequesterResponse = await fetch(`${API}/api/crud_read/schedules/get_by_fixer_other_requesters_month?fixer_id=${fixerId}&requester_id=${requesterId}&month=${month+1}`);
    //const currentRequesterFixerSchedules = await currentRequesterResponse.json();
    //const otherRequesterFixerSchedules = await otherRequesterResponse.json();

    const currentRequesterFixerSchedules = currentRequesterResponse.data;
    const otherRequesterFixerSchedules = otherRequesterResponse.data;

    //console.log("Schedules del requester actual:", currentRequesterFixerSchedules);
    //console.log("Schedules de otros requesters:", otherRequesterFixerSchedules);

    const fixerSchedules: Schedule[] = combineSchedules(
      currentRequesterFixerSchedules,
      otherRequesterFixerSchedules,
    );

    // for(const schedule of fixerSchedules) {
    //   const start = moment(schedule.starting_time).toDate();
    //   const end = moment(schedule.finishing_time).toDate();

    //   console.log(schedule ,start, end);
    // }
    //console.log("Desde generateSlots:", fixerSchedules);

    // Generar todos los slots disponibles para el mes (solo futuros)
    const availableSlots = generateAvailableSlotsForMonth(month, currentYear, fixerId);
    // Procesar los schedules existentes de la API
    for (const schedule of fixerSchedules) {
      const start = moment(schedule.starting_time).toDate();
      const end = moment(schedule.finishing_time).toDate();
      const slot: SlotEvent = {
        title: 'Disponible',
        start,
        end,
        booked: false,

        id: `fixer-${fixerId}-${start.toISOString()}`,
      };
      // Determinar estado basado en el schedule
      switch (schedule.schedule_state) {
        case 'occupied':
          slot.title = 'Ocupado';
          slot.color = '#FF5F57';
          slot.booked = true;
          break;
        case 'cancelled':
          slot.title = 'Cancelado';
          slot.color = '#FF5F57';
          slot.cancelledByUser = true;
          slot.booked = true;
          break;
        case 'booked':
          slot.title = 'Reservado';
          slot.color = '#F59E0B';
          slot.booked = true;
          slot.editable = true;
          break;
        case 'available':
        default:
          slot.title = 'Disponible';
          slot.color = '#16A34A';
          break;
      }
      slots.push(slot);
    }
    // Combinar: slots de la API + slots disponibles que no están en la API
    const finalSlots: SlotEvent[] = [...slots];
    // Agregar slots disponibles que no tienen schedule en la API
    for (const availableSlot of availableSlots) {
      const exists = slots.some(
        (scheduleSlot) => scheduleSlot.start.getTime() === availableSlot.start.getTime(),
      );
      if (!exists) {
        finalSlots.push(availableSlot);
      }
    }
    const filteredSlots = finalSlots.filter((slot) => slot.start >= now);

    // Ordenar por fecha
    filteredSlots.sort((a, b) => a.start.getTime() - b.start.getTime());

    return filteredSlots;
  } catch (err) {
    console.log('Error al generar los slots para el fixer:', fixerId, selectedDate, month, err);

    throw new Error(
      'No se pudieron cargar los horarios disponibles. Por favor, intenta más tarde.',
    );
  }
}
</file>

<file path="src/utils/getAppointmentsByDate.ts">
import axios from 'axios';

export interface Appointment {
  cancelled_fixer: boolean;
  _id: string;
  id_fixer: string;
  id_requester: string;
  selected_date: string;
  current_requester_name: string;
  appointment_type: string;
  appointment_description: string;
  link_id: string;
  current_requester_phone: string;
  starting_time: string;
  finishing_time: string;
  schedule_state: string;
  display_name_location: string;
  lat: string;
  lon: string;
  active: boolean;
  reprogram_reason: string;
  createdAt: string;
  updatedAt: string;
  __v: number;
}

interface ApiResponse {
  success: boolean;
  message: string;
  accessed_appointments: Appointment[];
}

export async function getAppointmentsByDate(fixerId: string, date: string): Promise<Appointment[]> {
  try {
    const response = await axios.get<ApiResponse>(
      'https://servineo-backend-lorem.onrender.com/api/crud_read/appointments/get_appointments_date',
      {
        params: {
          id_fixer: fixerId,
          selected_date: date,
        },
      },
    );

    if (response.data.success && response.data.accessed_appointments) {
      return response.data.accessed_appointments;
    } else {
      console.log('No se encontraron citas ');
      return [];
    }
  } catch (error) {
    if (axios.isAxiosError(error)) {
      console.error('Error de Axios:', {
        message: error.message,
        status: error.response?.status,
        data: error.response?.data,
      });
    } else {
      console.error('Error desconocido:', error);
    }
    return [];
  }
}
</file>

<file path="src/utils/getAppointmentsDisable.ts">
import axios from 'axios';

export interface Days {
  lunes: number[];
  martes: number[];
  miercoles: number[];
  jueves: number[];
  viernes: number[];
  sabado: number[];
  domingo: number[];
}

interface ApiAvailability {
  message: string;
  availability: Days;
}

export async function getAppointmentsDisable(fixerId: string): Promise<Days> {
  try {
    const res = await axios.get<ApiAvailability>(
      'https://servineo-backend-lorem.onrender.com/api/crud_read/appointments/get_fixer_availability',
      {
        params: {
          fixer_id: fixerId,
        },
      },
    );

    if (res.data && res.data.availability) {
      return res.data.availability;
    } else {
      console.log('No se encontró disponibilidad');
      return {
        lunes: [],
        martes: [],
        miercoles: [],
        jueves: [],
        viernes: [],
        sabado: [],
        domingo: [],
      };
    }
  } catch (error) {
    if (axios.isAxiosError(error)) {
      console.error('Error de Axios:', {
        message: error.message,
        status: error.response?.status,
        data: error.response?.data,
      });
    } else {
      console.error('Error desconocido:', error);
    }
    return {
      lunes: [],
      martes: [],
      miercoles: [],
      jueves: [],
      viernes: [],
      sabado: [],
      domingo: [],
    };
  }
}
</file>

<file path="src/utils/getSchedulesCont.ts">
import axios from 'axios';

interface AppointmentsResponse {
  message: string;
  number_of_appointments: Record<string, Record<string, number>>;
}

export async function getSchedulesCont(
  fixer_id: string,
  month: number,
  year: number,
): Promise<Record<string, Record<string, number>>> {
  try {
    const response = await axios.get<AppointmentsResponse>(
      'https://servineo-backend-lorem.onrender.com/api/crud_read/schedules/get_number_of_appointments',
      {
        params: {
          fixer_id,
          month,
          year,
        },
      },
    );

    const data = response.data;
    const appointments = data.number_of_appointments;

    if (!appointments || typeof appointments !== 'object') {
      console.warn('No se encontraron appointments en la respuesta:', data);
      return {};
    }

    return appointments;
  } catch (error) {
    console.error('Error al obtener contador de schedules:', error);
    return {};
  }
}
</file>

<file path="src/utils/useDailyConts.ts">
import { getSchedulesCont } from '@/utils/getSchedulesCont';
import { useState, useCallback, useEffect, useRef } from 'react';
import { getAppointmentsDisable, Days } from '@/utils/getAppointmentsDisable';

interface useDailyContsProps {
  date: Date;
  fixer_id: string;
}

export type DayOfWeek = keyof Days;

const DAY_MAP: { [key: number]: DayOfWeek } = {
  0: 'domingo',
  1: 'lunes',
  2: 'martes',
  3: 'miercoles',
  4: 'jueves',
  5: 'viernes',
  6: 'sabado',
};

export default function useDailyConts({ date, fixer_id }: useDailyContsProps) {
  const [count, setCount] = useState<Record<string, Record<string, number>> | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [appointmentsDis, setAppointmentsDis] = useState<Days>({
    lunes: [],
    martes: [],
    miercoles: [],
    jueves: [],
    viernes: [],
    sabado: [],
    domingo: [],
  });

  const hasFetched = useRef(false);
  const [refreshTrigger, setRefreshTrigger] = useState(0);

  const month = date.getMonth() + 1;
  const year = date.getFullYear();

  useEffect(() => {
    if (hasFetched.current && refreshTrigger === 0) {
      return;
    }

    async function fetchData() {
      if (!fixer_id || fixer_id === '' || fixer_id === 'undefined') {
        console.warn('fixer_id no válido:', fixer_id);
        setLoading(false);
        return;
      }

      setLoading(true);
      setError(null);

      try {
        const [countData, disabledData] = await Promise.all([
          getSchedulesCont(fixer_id, month, year),
          getAppointmentsDisable(fixer_id),
        ]);

        setCount(countData);
        setAppointmentsDis(disabledData);
        setError(null);
        hasFetched.current = true;
      } catch (err) {
        console.error('Error fetching schedules:', err);
        setError('Error al cargar los datos');
        setCount(null);
        setAppointmentsDis({
          lunes: [],
          martes: [],
          miercoles: [],
          jueves: [],
          viernes: [],
          sabado: [],
          domingo: [],
        });
      } finally {
        setLoading(false);
      }
    }

    fetchData();
  }, [fixer_id, month, year, refreshTrigger]);

  const refetch = useCallback(() => {
    setRefreshTrigger((prev) => prev + 1);
  }, []);

  const getAppointmentsForDay = useCallback(
    (
      day: number,
      monthParam: number,
      yearParam: number,
    ): 'full' | 'partial' | 'available' | 'disabled' => {
      const date = new Date(yearParam, monthParam, day);
      const dayOfWeek = date.getDay();
      const dayName = DAY_MAP[dayOfWeek];

      const max = appointmentsDis[dayName].length;

      if (!count) return 'available';

      const monthStr = String(monthParam + 1).padStart(2, '0');
      const format1 = `${monthStr}-${yearParam}`;
      const monthData = count[format1];

      if (!monthData) return 'available';

      const appointmentsCont = monthData[String(day)];

      if (max === 0) {
        return 'disabled';
      } else if (appointmentsCont === undefined || appointmentsCont === 0) {
        return 'available';
      } else if (appointmentsCont >= max) {
        return 'full';
      }

      return 'partial';
    },
    [count, appointmentsDis],
  );

  return {
    count,
    loading,
    error,
    refetch,
    getAppointmentsForDay,
  };
}
</file>

<file path="tailwind.config.js">
module.exports = {
  content: ['./src/**/*.{js,ts,jsx,tsx}'],
  theme: {
    extend: {
      colors: {},
    },
  },
  plugins: [],
};
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    "src/app/ctrlC/home-tsx",
    "src/components/calendar/mobile/MobileDayliView.tsx"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="package.json">
{
  "name": "servineo-frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev --turbopack --port 3000",
    "build": "next build --turbopack",
    "start": "next start",
    "lint": "eslint",
    "format": "prettier --write .",
    "format:check": "prettier --check ."
  },
  "dependencies": {
    "@emotion/react": "^11.14.0",
    "@emotion/styled": "^11.14.1",
    "@headlessui/react": "^2.2.9",
    "@hookform/resolvers": "^5.2.2",
    "@mui/material": "^7.3.4",
    "@mui/x-date-pickers": "^8.14.0",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-label": "^2.1.8",
    "@radix-ui/react-popover": "^1.1.15",
    "@radix-ui/react-slot": "^1.2.4",
    "@react-oauth/google": "^0.12.2",
    "@reactour/tour": "^3.8.0",
    "@reduxjs/toolkit": "^2.10.1",
    "@stripe/react-stripe-js": "^5.4.1",
    "@stripe/stripe-js": "^8.5.3",
    "@types/redux-logger": "^3.0.13",
    "animate.css": "^4.1.1",
    "autoprefixer": "^10.4.22",
    "axios": "^1.13.2",
    "ci": "^2.3.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "dotenv": "^17.2.3",
    "express": "^5.1.0",
    "framer-motion": "^12.23.24",
    "i18next": "^25.7.1",
    "jspdf": "^3.0.4",
    "jwt-decode": "^4.0.0",
    "leaflet": "^1.9.4",
    "leaflet-defaulticon-compatibility": "^0.1.2",
    "lucide-react": "^0.546.0",
    "mongoose": "^9.0.0",
    "next": "15.5.4",
    "next-intl": "^4.5.5",
    "nextjs-toast-notify": "^1.57.0",
    "postcss": "^8.5.6",
    "qrcode": "^1.5.4",
    "qrcode.react": "^4.2.0",
    "react": "19.1.0",
    "react-big-calendar": "^1.19.4",
    "react-dom": "19.1.0",
    "react-google-recaptcha": "^3.1.0",
    "react-icons": "^5.5.0",
    "react-leaflet": "^5.0.0",
    "react-player": "^3.4.0",
    "react-redux": "^9.2.0",
    "recharts": "^3.4.1",
    "redux-logger": "^3.0.6",
    "sonner": "^2.0.7",
    "tailwind-merge": "^3.4.0",
    "ua-parser-js": "^2.0.6",
    "zod": "^4.1.12"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@isaacs/fs-minipass": "^4.0.1",
    "@tailwindcss/postcss": "^4.1.14",
    "@types/jspdf": "^1.3.3",
    "@types/leaflet": "^1.9.21",
    "@types/node": "^20",
    "@types/nodemailer": "^7.0.3",
    "@types/qrcode": "^1.5.6",
    "@types/qrcode.react": "^1.0.5",
    "@types/react": "^19.2.2",
    "@types/react-big-calendar": "^1.16.3",
    "@types/react-dom": "^19.2.2",
    "@types/react-google-recaptcha": "^2.1.9",
    "@types/react-redux": "^7.1.34",
    "eslint": "^9",
    "eslint-config-next": "15.5.4",
    "eslint-config-prettier": "^10.1.8",
    "eslint-plugin-prettier": "^5.5.4",
    "i": "^0.3.7",
    "npm": "^11.6.4",
    "prettier": "^3.6.2",
    "tailwindcss": "^4.1.17",
    "typescript": "5.9.3"
  }
}
</file>

<file path="public/en/fallback-image.svg">
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800" viewBox="0 0 1200 800" preserveAspectRatio="xMidYMid slice">
  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#1e3a8a"/>
      <stop offset="100%" stop-color="#0ea5e9"/>
    </linearGradient>
  </defs>
  <rect width="1200" height="800" fill="url(#bg)"/>
  <g fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="2">
    <rect x="120" y="140" width="960" height="520" rx="24"/>
    <path d="M160 600 L1040 600"/>
    <circle cx="240" cy="260" r="70"/>
    <path d="M360 540 L520 380 L640 500 L760 420 L940 560"/>
  </g>
  <g font-family="Inter, Arial, sans-serif" text-anchor="middle">
    <text x="600" y="360" font-size="64" fill="#ffffff" font-weight="700">Imagen no disponible</text>
    <text x="600" y="420" font-size="28" fill="rgba(255,255,255,0.9)">Mostrando imagen de respaldo</text>
  </g>
</svg>
</file>

<file path="public/en/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/es/fallback-image.svg">
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800" viewBox="0 0 1200 800" preserveAspectRatio="xMidYMid slice">
  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#1e3a8a"/>
      <stop offset="100%" stop-color="#0ea5e9"/>
    </linearGradient>
  </defs>
  <rect width="1200" height="800" fill="url(#bg)"/>
  <g fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="2">
    <rect x="120" y="140" width="960" height="520" rx="24"/>
    <path d="M160 600 L1040 600"/>
    <circle cx="240" cy="260" r="70"/>
    <path d="M360 540 L520 380 L640 500 L760 420 L940 560"/>
  </g>
  <g font-family="Inter, Arial, sans-serif" text-anchor="middle">
    <text x="600" y="360" font-size="64" fill="#ffffff" font-weight="700">Imagen no disponible</text>
    <text x="600" y="420" font-size="28" fill="rgba(255,255,255,0.9)">Mostrando imagen de respaldo</text>
  </g>
</svg>
</file>

<file path="public/es/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="src/app/[locale]/adminStatistic/ConditionalTopMenu.tsx">
'use client';

import { useEffect, useState } from 'react';
import { usePathname } from 'next/navigation';
import TopMenu from '@/Components/Navigation/TopMenu';

export default function ConditionalTopMenu() {
  const pathname = usePathname();
  const [shouldShow, setShouldShow] = useState(true);

  useEffect(() => {
    // Ocultar TopMenu en rutas de adminStatistic
    if (!pathname) {
      setShouldShow(true);
      return;
    }

    const normalizedPath = pathname.toLowerCase();
    // Detectar rutas de adminStatistic (con o sin locale)
    const isAdminStatisticRoute =
      normalizedPath.includes('/adminstatistic') ||
      normalizedPath.endsWith('/adminstatistic') ||
      /\/[a-z]{2}\/adminstatistic(\/)?$/i.test(normalizedPath);

    setShouldShow(!isAdminStatisticRoute);
  }, [pathname]);

  if (!shouldShow) {
    return null;
  }

  return <TopMenu />;
}
</file>

<file path="src/app/[locale]/become-fixer/page.tsx">
'use client';
import React, { useEffect, useState } from 'react';
import FixerRegisterForm from '@/Components/fixer/Fixer-register-form';
import { FixerEnableWizard } from '@/Components/fixer/Filter-eneable-wizard';

import { useTranslations } from 'next-intl';
import { useAppSelector } from '@/app/redux/hooks';
//import { RootState } from '@/app/redux/store';
import { IUser } from '@/types/user';
import { useRouter } from 'next/navigation';
import { useGetUserByIdQuery } from '@/app/redux/services/userApi';
import { setUser } from '@/app/redux/slice/userSlice';
import { useDispatch } from 'react-redux';

export default function BecomeFixerPage() {
  const t = useTranslations('becomeFixer');
  const router = useRouter();
  const dispatch = useDispatch();

  const { user: reduxUser } = useAppSelector((state) => state.user);
  const [userId, setUserId] = useState<string | null>(null);
  const [requester, setRequester] = useState<IUser | null>(null);

  // Redirigir si el usuario ya es fixer
  useEffect(() => {
    if (reduxUser?.role === 'fixer') {
      router.push('/fixer/dashboard');
    }
  }, [reduxUser, router]);

  // Obtener userId desde localStorage
  useEffect(() => {
    const token = localStorage.getItem('servineo_user');
    if (token) {
      const userData = JSON.parse(token);
      const id = userData._id || userData.id;
      setUserId(id);
    }
  }, []);

  // Consultar user por ID
  const { data: userData } = useGetUserByIdQuery(userId!, {
    skip: !userId,
  });

  // Guardar user en redux
  useEffect(() => {
    if (userData) dispatch(setUser(userData));
  }, [userData, dispatch]);

  // Valores por defecto del formulario
  const defaultValues = {
    name: reduxUser?.name || '',
    email: reduxUser?.email || '',
    phone: reduxUser?.telefono || '',
  };

  return (
    <div>
      <div className='container mx-auto max-w-4xl p-4'>
        <header className='mb-6 text-center'>
          <h1 className='text-2xl font-bold'>{t('title')}</h1>
          <p className='text-sm text-gray-500'>{t('description')}</p>
        </header>
        <section className='space-y-6'>
          {!requester ? (
            <div className='neon-border glass-panel rounded-2xl border border-gray-200 p-4 shadow-sm animate-slide-up'>
              <h2 className='mb-3 text-center text-lg font-semibold'>{t('InputData')}</h2>
              <FixerRegisterForm
                defaultValues={defaultValues}
                onSubmit={(data) => {
                  // Construir el objeto IUser con los datos del formulario y redux
                  const finalUser: IUser = {
                    _id: reduxUser?._id || 'req-guest',
                    name: data.name,
                    email: data.email,
                    telefono: data.phone,
                    url_photo: reduxUser?.url_photo || 'https://picsum.photos/80',
                    role: 'requester',
                  } as IUser;
                  setRequester(finalUser);
                }}
                submitButtonText={t('button1')}
              />
            </div>
          ) : (
            <div className='animate-fade-in'>
              <FixerEnableWizard user={requester} />
            </div>
          )}
        </section>
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/layout.tsx">
import type { Metadata } from 'next';
import { Geist, Geist_Mono } from 'next/font/google';
import '../globals.css';
import { roboto } from '../fonts';
import 'leaflet/dist/leaflet.css';
import { Providers } from '../providers';
import TopMenu from '@/Components/Navigation/TopMenu';
import { ReduxProvider } from '../redux/ReduxProvider';
import { ReactNode } from 'react';
import ConditionalTopMenu from './adminStatistic/ConditionalTopMenu';
import { notFound } from 'next/navigation';
import { NextIntlClientProvider } from 'next-intl';
import { TranslationButton } from '@/Components/Shared/TranslationButton';
import BotonesFlotantes from '@/Components/ask_for_help/contenedor';
import FooterSection from '@/Components/Home/Footer-section';
import { TourLogic } from '@/Components/Tour/TourLogic';

const geistSans = Geist({
  variable: '--font-geist-sans',
  subsets: ['latin'],
});

const geistMono = Geist_Mono({
  variable: '--font-geist-mono',
  subsets: ['latin'],
});

const messagesMap = {
  en: () => import('../../../messages/en.json').then((mod) => mod.default),
  es: () => import('../../../messages/es.json').then((mod) => mod.default),
};

export function generateStaticParams() {
  return [{ locale: 'en' }, { locale: 'es' }];
}

export const metadata: Metadata = {
  title: 'Servineo',
  description: 'Generated by create next app',
};

type Props = {
  children: ReactNode;
  params: Promise<{ locale: string }>;
};

export default async function RootLayout({ children, params }: Props) {
  const { locale } = await params;
  const validLocales = ['en', 'es'];
  if (!validLocales.includes(locale)) notFound();

  const loader = messagesMap[locale as keyof typeof messagesMap];
  if (!loader) notFound();

  const messages = await loader();

  return (
    <html lang={locale} className={`${roboto.className}`}>
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
        suppressHydrationWarning={true}
      >
        <NextIntlClientProvider locale={locale} messages={messages}>
          <Providers>
            {/* ESTA LÍNEA ES LA QUE HACE QUE LA GUÍA FUNCIONE */}
            <TourLogic />

            <div className='text-black fixed bottom-7 right-7 z-[9999]'>
              <TranslationButton />
            </div>
            <div className=''>
              <BotonesFlotantes />
            </div>
            <ConditionalTopMenu />
            {children}
            <FooterSection />
          </Providers>
        </NextIntlClientProvider>
      </body>
    </html>
  );
}
</file>

<file path="src/app/[locale]/payment/components/PaymentDemoAdaptado.tsx">
'use client';

import React, { useState } from "react";
import { loadStripe } from "@stripe/stripe-js";
import { Elements } from "@stripe/react-stripe-js";
import PaymentMethodUI from "./PaymentMethodUI";
import CardList from "./CardList";
import { createCashPayment, CreateCashPaymentDTO } from "../service/payment";
import { useRouter } from "next/navigation";
import ReCAPTCHA from 'react-google-recaptcha';
import { AnimatePresence, motion } from 'framer-motion';

const RECAPTCHA_SITE_KEY = process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY || ''; 

const stripePromise = loadStripe(
    "pk_test_51SHGq0Fp8K0s2pYx4l5z1fkIcXSouAknc9gUV6PpYKR8TjexmaC3OiJR9jNIa09e280Pa6jGVRA6ZNY7kSCCGcLt002CEmfDnU"
);

interface PaymentProps {
    amount: number;
    jobId: string;
    requesterId: string;
    fixerId: string;
    onClose: () => void;
    onPaymentSuccess?: () => void;
}

type SecurityModalTarget = 'card' | 'qr' | null;

interface PaymentResponse {
    message?: string;
    data?: {
        id?: string;
        _id?: string;
    };
    payment?: {
        id?: string;
        _id?: string;
    };
    id?: string;
    _id?: string;
}

export default function PaymentMethods({
    amount,
    jobId,
    requesterId,
    fixerId,
    onClose,
    onPaymentSuccess,
}: PaymentProps) {
    const [showCashPayment, setShowCashPayment] = useState(false);
    const [createdPaymentId, setCreatedPaymentId] = useState<string | null>(null);
    const [securityModalTarget, setSecurityModalTarget] = useState<SecurityModalTarget>(null);
    const [recaptchaToken, setRecaptchaToken] = useState<string | null>(null);

    const router = useRouter();

    const handleGoToQR = (token: string) => {
        router.push(
            `/payment/pago-qr?trabajoId=${jobId}&bookingId=TRABAJO-${jobId}&providerId=DEMO-PROVIDER&amount=${amount}&currency=BOB&recaptchaToken=${token}`
        );
    };
    
    const handleRecaptchaChange = (token: string | null) => {
        setRecaptchaToken(token);
        
        if (token && securityModalTarget === 'qr') {
            handleGoToQR(token);
            setSecurityModalTarget(null);
        }
    };
    
    const startCardFlow = () => {
        setRecaptchaToken(null);
        setSecurityModalTarget('card'); 
    };
    
    const startQrFlow = () => {
        setRecaptchaToken(null);
        setSecurityModalTarget('qr'); 
    };

    const handlePayCash = async () => {
        try {
            const payload: CreateCashPaymentDTO = {
                jobId,
                requesterId,
                fixerId,
                subTotal: amount,
                service_fee: 0,
                discount: 0,
                currency: "BOB",
                paymentMethods: "cash",
            };
            
            const resp = await createCashPayment(payload);
            const created: PaymentResponse = resp?.data || resp?.payment || resp;
            setCreatedPaymentId(created?.id || created?._id || null);
            setShowCashPayment(true);
        } catch (error) {
            const err = error as Error;
            console.error("Error creando pago en efectivo:", err);
            alert(err.message || "Error al crear pago en efectivo");
        }
    };

    return (
        <>
            {/* Overlay principal */}
            <div
                onClick={onClose}
                className="fixed inset-0 z-[10] bg-black/50 flex items-center justify-center p-4"
            >
                <div
                    onClick={(e) => e.stopPropagation()} 
                    className="bg-white rounded-2xl shadow-2xl w-full max-w-md sm:max-w-lg p-6 relative flex flex-col items-center justify-center gap-6"
                >
                    <button
                        onClick={onClose}
                        className="absolute top-3 right-3 text-gray-600 hover:text-red-500 text-3xl font-bold transition-colors"
                    >
                        ✕
                    </button>

                    <h2 className="text-2xl font-bold text-center">Seleccione su método de pago</h2>

                    <div className="w-full flex flex-col gap-4">
                        <button
                            onClick={startCardFlow}
                            className="w-full bg-[#1AA7ED] hover:bg-[#2B6AE0] text-[#F9FAFB] px-6 py-3 rounded-lg flex items-center gap-4 text-xl font-medium justify-center transition-colors"
                        >
                            <span className="text-2xl">💳</span> Tarjeta de Crédito
                        </button>

                        <button
                            onClick={startQrFlow}
                            className="w-full bg-[#1AA7ED] hover:bg-[#2B6AE0] text-[#F9FAFB] px-6 py-3 rounded-lg flex items-center gap-4 text-xl font-medium justify-center transition-colors"
                        >
                            <span className="text-2xl">⊞</span> Pago QR
                        </button>

                        <button
                            onClick={handlePayCash}
                            className="w-full bg-[#1AA7ED] hover:bg-[#2B6AE0] text-[#F9FAFB] px-6 py-3 rounded-lg flex items-center gap-4 text-xl font-medium justify-center transition-colors"
                        >
                            <span className="text-2xl">💵</span> Pago Efectivo
                        </button>
                    </div>
                </div>
            </div>

            {/* Cash Payment Modal */}
            {showCashPayment && createdPaymentId && (
                <PaymentMethodUI
                    paymentId={createdPaymentId}
                    onClose={() => setShowCashPayment(false)}
                    jobId={jobId}
                    requesterId={requesterId}
                    fixerId={fixerId}
                />
            )}
            
            {/* CARD PAYMENT MODAL */}
            {securityModalTarget === 'card' && (
                <div className="fixed inset-0 z-[1100] bg-black/60 flex items-center justify-center p-4">
                    <div
                        className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto relative"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <button
                            onClick={() => {
                                setSecurityModalTarget(null);
                                setRecaptchaToken(null);
                            }}
                            className="absolute top-3 right-3 text-gray-600 hover:text-red-500 text-3xl font-bold transition-colors"
                        >
                            ✕
                        </button>

                        <Elements stripe={stripePromise}>
                            <div className="flex flex-col items-center gap-6">
                                <h2 className="text-2xl font-bold text-center">
                                    Selecciona tu tarjeta o agrega una nueva
                                </h2>
                                
                                <div className='my-4'>
                                    <p className="text-sm text-gray-600 mb-2">Verificación de seguridad requerida:</p>
                                    <ReCAPTCHA
                                        sitekey={RECAPTCHA_SITE_KEY}
                                        onChange={handleRecaptchaChange}
                                    />
                                </div>
                                
                                <div className="w-full relative">
                                    {!recaptchaToken && (
                                        <div className="absolute inset-0 z-10 bg-white/70 flex items-center justify-center rounded-xl">
                                            <p className="text-lg font-bold text-red-600 p-4 text-center">
                                                Por favor, completa la verificación de seguridad 👆
                                            </p>
                                        </div>
                                    )}
                                    <CardList
                                        requesterId={requesterId}
                                        fixerId={fixerId}
                                        jobId={jobId}
                                        amount={amount}
                                        recaptchaToken={recaptchaToken}
                                        onPaymentSuccess={() => {
                                            setSecurityModalTarget(null);
                                            onPaymentSuccess?.(); 
                                        }}
                                    />
                                </div>
                            </div>
                        </Elements>
                    </div>
                </div>
            )}
            
            {/* QR SECURITY MODAL */}
            <AnimatePresence>
                {securityModalTarget === 'qr' && (
                     <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="fixed inset-0 z-[1100] bg-black/60 flex items-center justify-center p-4"
                     >
                        <motion.div
                            initial={{ scale: 0.8, y: 30 }}
                            animate={{ scale: 1, y: 0 }}
                            exit={{ scale: 0.8, y: 30 }}
                            onClick={(e) => e.stopPropagation()} 
                            className="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full relative text-center"
                        >
                            <button
                                onClick={() => {
                                    setSecurityModalTarget(null);
                                    setRecaptchaToken(null); 
                                }}
                                className="absolute top-3 right-3 text-gray-600 hover:text-red-500 text-3xl font-bold transition-colors"
                            >
                                ✕
                            </button>
                            <h3 className="text-xl font-bold mb-4">Verificación de Seguridad</h3>
                            <p className="text-gray-700 mb-6">Completa el reCAPTCHA para proceder al Pago QR.</p>
                            
                            <ReCAPTCHA
                                sitekey={RECAPTCHA_SITE_KEY}
                                onChange={handleRecaptchaChange}
                            />
                            
                            <button
                                onClick={() => recaptchaToken && handleGoToQR(recaptchaToken)}
                                disabled={!recaptchaToken}
                                className={`mt-6 w-full py-3 rounded-xl font-bold text-white transition-colors ${
                                    recaptchaToken ? 'bg-[#2B6AE0] hover:bg-[#1AA7ED]' : 'bg-gray-400 cursor-not-allowed'
                                }`}
                            >
                                Proceder al Pago QR
                            </button>
                            
                            {!recaptchaToken && (
                                <p className="mt-4 text-sm text-gray-500">
                                    Asegúrate de completar la verificación.
                                </p>
                            )}
                        </motion.div>
                     </motion.div>
                )}
            </AnimatePresence>
        </>
    );
}
</file>

<file path="src/app/[locale]/payment/components/PaymentMethodUI.tsx">
"use client";

import { useEffect, useState, useMemo } from "react";
import PaymentMethodCashFixer from "./PaymentMethodCashFixer";

// 1. ACTUALIZAR INTERFAZ DE PROPS
interface PaymentMethodUIProps {
  paymentId: string | null;
  jobId: string;       // <-- AÑADIDO
  requesterId: string; // <-- AÑADIDO
  fixerId: string;     // <-- AÑADIDO
  onClose: (paymentCompleted?: boolean) => void;
}

// 2. APLICAR LAS PROPS ACTUALIZADAS
export default function PaymentMethodUI({
  paymentId,
  jobId,       // <-- AÑADIDO
  requesterId, // <-- AÑADIDO
  fixerId,     // <-- AÑADIDO
  onClose,
}: PaymentMethodUIProps) {
  const [showFixerView, setShowFixerView] = useState(false);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);
  const [showNotification, setShowNotification] = useState(true);
  const [regenerating, setRegenerating] = useState(false);
  const [now, setNow] = useState<number>(Date.now());

  const [summary, setSummary] = useState<{
    id: string;
    code?: string | null;
    codeExpired?: boolean;
    status: "paid" | "pending" | "failed";
    codeExpiresAt?: string | null;
    amount: { total: number; currency: string };
  } | null>(null);

  // Actualizar 'now' cada segundo para countdown
  useEffect(() => {
    const interval = setInterval(() => setNow(Date.now()), 1000);
    return () => clearInterval(interval);
  }, []);

  // Auto-ocultar notificación después de 10 segundos (solo si NO está expirado)
  useEffect(() => {
    if (showNotification && !summary?.codeExpired) {
      const timer = setTimeout(() => {
        setShowNotification(false);
      }, 10000);
      return () => clearTimeout(timer);
    }
  }, [showNotification, summary?.codeExpired]);

  // Función para cargar summary (reutilizable)
  const loadSummary = async () => {
    if (!paymentId) {
      setErr("No hay paymentId para consultar.");
      setLoading(false);
      return;
    }
    setErr(null);
    setLoading(true);

    try {
      const timestamp = new Date().getTime();
      // --- Usamos la ruta relativa para el fetch (asumiendo rewrites) ---
      const res = await fetch(`/api/lab/payments/${paymentId}/summary?t=${timestamp}`, {
        cache: "no-store",
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(text || `HTTP ${res.status}`);
      }

      const data = await res.json();
      console.log("📦 [REQUESTER] Backend response:", data);

      const d = data?.data ?? data;

      const total =
        typeof d?.total === "number"
          ? d.total
          : typeof d?.amount?.total === "number"
            ? d.amount.total
            : NaN;

      // Detectar expiración (backend o manual)
      const backendExpired = d?.codeExpired === true;
      const manualExpired = d?.codeExpiresAt && new Date(d.codeExpiresAt) < new Date();
      const isExpired = backendExpired || manualExpired;

      console.log("⏰ [REQUESTER] Verificación expiración:", {
        backendExpired,
        manualExpired,
        isExpired,
        codeExpiresAt: d?.codeExpiresAt
      });

      const uiSummary = {
        id: String(d?.id ?? d?._id ?? paymentId),
        code: d?.code ?? null,
        codeExpired: isExpired,
        status: (d?.status ?? "pending") as "paid" | "pending" | "failed",
        codeExpiresAt: d?.codeExpiresAt ?? null,
        amount: {
          total,
          currency: d?.amount?.currency ?? d?.currency ?? "BOB",
        },
      };

      setSummary(uiSummary);

      // Si está expirado, mostrar notificación
      if (isExpired) {
        setShowNotification(true);
      }

    } catch (e: unknown) { // Tipado de 'e' como unknown
      console.error("❌ [REQUESTER] Error:", e);
      setErr(e.message || "No se pudo cargar el resumen");
    } finally {
      setLoading(false);
    }
  };

  // GET summary al montar
  useEffect(() => {
    loadSummary();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [paymentId]);

  // Verificación automática de expiración cada segundo
  useEffect(() => {
    if (!summary?.codeExpiresAt || summary.codeExpired) return;

    const checkExpiration = () => {
      const expiresMs = new Date(summary.codeExpiresAt!).getTime();
      const nowMs = Date.now();

      console.log("⏰ [REQUESTER] Auto-check expiración:", {
        expiresAt: new Date(expiresMs).toLocaleString('es-BO'),
        now: new Date(nowMs).toLocaleString('es-BO'),
        secondsLeft: ((expiresMs - nowMs) / 1000).toFixed(2),
        expired: nowMs >= expiresMs
      });

      if (nowMs >= expiresMs && !summary.codeExpired) {
        console.log("🔴 [REQUESTER] CÓDIGO EXPIRADO detectado");
        setSummary(prev => prev ? { ...prev, codeExpired: true } : null);
        setShowNotification(true);
      }
    };

    checkExpiration();
    const interval = setInterval(checkExpiration, 1000);
    return () => clearInterval(interval);
  }, [summary?.codeExpiresAt, summary?.codeExpired]);

  // Calcular tiempo restante
  const expiryInfo = useMemo(() => {
    if (!summary?.codeExpiresAt) return null;

    const expiry = new Date(summary.codeExpiresAt);
    const diffMs = expiry.getTime() - now;

    if (diffMs <= 0 || summary.codeExpired) {
      return { expired: true, hoursLeft: 0, minutesLeft: 0, secondsLeft: 0 };
    }

    const hoursLeft = Math.floor(diffMs / (1000 * 60 * 60));
    const minutesLeft = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
    const secondsLeft = Math.floor((diffMs % (1000 * 60)) / 1000);

    return { expired: false, hoursLeft, minutesLeft, secondsLeft };
  }, [summary?.codeExpiresAt, summary?.codeExpired, now]);

  // --- 3. ACTUALIZAR handleRegenerateCode ---
  // --- ACTUALIZAR handleRegenerateCode en PaymentMethodUI.tsx ---
const handleRegenerateCode = async () => {
  if (!jobId) {
    setErr("No hay jobId disponible para regenerar el código");
    return;
  }

  setErr(null);
  setRegenerating(true);

  try {
    console.log(`🔄 [REQUESTER] Regenerando código para jobId: ${jobId}`);
    
    // Usar la nueva ruta que recibe jobId como parámetro
    const res = await fetch(`/api/lab/payments/regenerate-code/${jobId}`, {
      method: "PATCH",
      headers: {
        'Content-Type': 'application/json',
      }
    });

    const responseData = await res.json();
    console.log("📦 [REQUESTER] Respuesta de regeneración:", responseData);

    if (!res.ok) {
      throw new Error(responseData.error || "Error al regenerar el código");
    }

    console.log("✅ [REQUESTER] Código regenerado exitosamente");
    console.log("🆕 Nuevo código:", responseData.data?.code);
    console.log("⏰ Nueva expiración:", responseData.data?.expiresAt);

    // Recargar summary para obtener el nuevo código y fecha de expiración
    await loadSummary();
    
    // Mostrar notificación de éxito
    setShowNotification(true);

  } catch (e: unknown) {
    console.error("❌ [REQUESTER] Error regenerando código:", e);
    setErr(e.message || "Error al regenerar el código");
  } finally {
    setRegenerating(false);
  }
};
  
  // --- (El resto de tu código: handleContinuar, handleVolver, y todo el JSX/return) ---
  // --- (No necesita cambios) ---
  const handleContinuar = () => {
    // Solo cierra si no está expirado
    if (!isExpired) {
      onClose(true); // Asume que "Continuar" significa que el pago se completó
    }
  };

  const handleVolver = async (opts?: { refresh?: boolean }) => {
    setShowFixerView(false);
    if (opts?.refresh) {
      await loadSummary();
    }
  };

  // Vista del proveedor (FIXER)
  if (showFixerView && summary) {
    return (
      <PaymentMethodCashFixer
        trabajo={{
          id: summary.id,
          monto: summary.amount.total,
        }}
        onClose={onClose}
        onBack={handleVolver}
      />
    );
  }

  // Loading state
  if (loading) {
    return (
      <div className="fixed inset-0 bg-[rgba(0,0,0,0.5)] flex items-center justify-center z-50">
        <div className="bg-[#F9FAFB] rounded-lg shadow-xl px-8 py-6">
          <div className="flex flex-col items-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#2B31E0] mb-4"></div>
            <p className="text-[#111827]">Cargando resumen…</p>
          </div>
        </div>
      </div>
    );
  }

  // Error state
  if (err && !summary) {
    return (
      <div className="fixed inset-0 bg-[rgba(0,0,0,0.5)] flex items-center justify-center z-50">
        <div className="bg-[#F9FAFB] rounded-lg shadow-xl px-8 py-6 space-y-3 max-w-md">
          <div className="text-[#EF4444] font-medium text-lg">Error</div>
          <div className="text-[#111827] text-sm">{err}</div>
          <div className="flex justify-end">
            <button
              onClick={() => onClose()}
              className="px-4 py-2 rounded-md bg-[#2BDDE0] text-[#111827] hover:bg-[#5E2BE0]"
            >
              Cerrar
            </button>
          </div>
        </div>
      </div>
    );
  }

  if (!summary) return null;

  const isExpired = expiryInfo?.expired || summary.codeExpired;

  // Vista inicial (REQUESTER)
  return (
    // Incrementado el z-index para que esté sobre el modal anterior si es necesario
    <div className="fixed inset-0 bg-[rgba(0,0,0,0.5)] flex items-center justify-center z-[1200]"> 
      <div className="bg-[#F9FAFB] w-full max-w-2xl mx-4 rounded-lg shadow-xl">
        {/* Header */}
        <div className="bg-[#2B31E0] text-[#F9FAFB] px-6 py-4 flex items-center justify-between rounded-t-lg">
          <h1 className="text-xl font-semibold">
            Método de pago Efectivo — Vista REQUESTER
          </h1>
          <button
            onClick={() => onClose()}
            className="hover:bg-[#2B6AE0] px-3 py-1 rounded text-xl transition-colors"
          >
            ✕
          </button>
        </div>

        {/* Content */}
        <div className="px-8 py-12">
          <div className="text-center mb-8">
            <h2 className="text-2xl font-bold text-[#111827]">
              Muestra este código al proveedor
            </h2>
            <h2 className="text-2xl font-bold text-[#111827]">
              para confirmar tu pago
            </h2>
          </div>

          {/* Notificación de vigencia o expiración */}
          {expiryInfo && showNotification && (
            <div className="max-w-xl mx-auto mb-8 relative">
              {isExpired ? (
                // Código expirado
                <div className="bg-red-50 border-l-4 border-[#EF4444] p-4 rounded shadow-lg">
                  <button
                    onClick={() => setShowNotification(false)}
                    className="absolute top-2 right-2 text-[#EF4444] hover:text-red-700 font-bold text-xl"
                  >
                    ×
                  </button>
                  <div className="flex items-start">
                    <div className="flex-shrink-0">
                      <svg className="h-5 w-5 text-[#EF4444] mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                      </svg>
                    </div>
                    <div className="ml-3 flex-1 pr-6">
                      <p className="text-sm font-medium text-red-800 mb-2">
                        ⚠️ Este código ha <strong>expirado</strong>
                      </p>
                      <p className="text-xs text-red-700 mb-3">
                        Por favor, genera un nuevo código para continuar con tu pago.
                      </p>
                      <button
                        onClick={handleRegenerateCode}
                        disabled={regenerating}
                        className="bg-[#EF4444] hover:bg-red-700 disabled:bg-red-400 text-white px-4 py-2 rounded text-sm font-medium transition-colors"
                      >
                        {regenerating ? "Regenerando..." : "🔄 Generar Nuevo Código"}
                      </button>
                    </div>
                  </div>
                </div>
              ) : (
                // Código vigente
                <div className="bg-blue-50 border-l-4 border-[#759AE0] p-4 rounded shadow-lg">
                  <button
                    onClick={() => setShowNotification(false)}
                    className="absolute top-2 right-2 text-[#759AE0] hover:text-blue-700 font-bold text-xl"
                  >
                    ×
                  </button>
                  <div className="flex items-start">
                    <div className="flex-shrink-0">
                      <svg className="h-5 w-5 text-[#759AE0] mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                      </svg>
                    </div>
                    <div className="ml-3 flex-1 pr-6">
                      <p className="text-sm font-medium text-blue-800 mb-1">
                        ⏰ Tiempo restante de validez
                      </p>
                      <p className="text-lg font-bold text-blue-900">
                        {expiryInfo.hoursLeft}h {expiryInfo.minutesLeft}m {expiryInfo.secondsLeft}s
                      </p>
                      {summary.codeExpiresAt && (
                        <p className="text-xs text-blue-700 mt-1">
                          Expira: {new Date(summary.codeExpiresAt).toLocaleString('es-BO', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                          })}
                        </p>
                      )}
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Campos del pago */}
          <div className="space-y-6 max-w-xl mx-auto">
            <LabeledReadOnly
              label="Código de Trabajo"
              value={isExpired ? "EXPIRADO" : (summary.code ?? "—")}
              highlight={!isExpired}
              expired={isExpired}
            />
            <LabeledReadOnly
              label="Monto a Pagar"
              value={
                Number.isFinite(summary.amount.total)
                  ? `${summary.amount.total} ${summary.amount.currency}`
                  : "—"
              }
            />
            <div className="flex items-center gap-6">
              <label className="text-lg font-semibold text-[#111827] w-48 text-left">
                Estado
              </label>
              <input
                type="text"
                value={
                  summary.status === 'paid' ? 'CONFIRMADO' :
                  summary.status === 'failed' ? 'ERROR' :
                  'PENDIENTE'
                }
                readOnly
                className="flex-1 px-4 py-3 rounded-md text-lg bg-[#E5E7EB] border border-[#D1D5DB] text-[#111827] text-center uppercase font-semibold"
              />
            </div>
          </div>

          {/* Mensajes de error */}
          {err && (
            <div className="mt-6 max-w-xl mx-auto">
              <div className="bg-red-50 border border-red-200 rounded p-3">
                <p className="text-[#EF4444] font-medium text-sm">{err}</p>
              </div>
            </div>
          )}

          {/* Botones */}
          <div className="flex justify-center gap-6 mt-12">
            <button
              onClick={handleContinuar}
              disabled={isExpired}
              className={`px-12 py-3 text-lg font-semibold rounded-md transition-colors ${
                isExpired
                  ? 'bg-[#D1D5DB] text-[#64748B] cursor-not-allowed'
                  : 'bg-[#2B31E0] hover:bg-[#2B6AE0] text-[#F9FAFB]'
              }`}
            >
              {isExpired ? 'Código Expirado' : 'Continuar'}
            </button>
            <button
              onClick={() => onClose()}
              className="px-12 py-3 bg-[#2BDDE0] text-[#111827] text-lg font-semibold rounded-md hover:bg-[#5E2BE0] transition-colors"
            >
              Volver
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ---------------- helpers UI ---------------- */

interface LabeledReadOnlyProps {
  label: string;
  value: string;
  highlight?: boolean;
  expired?: boolean;
}

function LabeledReadOnly({
  label,
  value,
  highlight = false,
  expired = false
}: LabeledReadOnlyProps) {
  return (
    <div className="flex items-center gap-6">
      <label className="text-lg font-semibold text-[#111827] w-48 text-left">
        {label}
      </label>
      <input
        type="text"
        value={value}
        readOnly
        className={`flex-1 px-4 py-3 rounded-md text-lg ${
          expired
            ? 'bg-red-50 border-2 border-[#EF4444] text-[#EF4444] font-bold text-center line-through'
            : highlight
              ? 'bg-blue-50 border-2 border-[#759AE0] text-blue-900 font-bold text-center tracking-widest'
              : 'bg-[#E5E7EB] border border-[#D1D5DB] text-[#111827]'
        }`}
      />
    </div>
  );
}
</file>

<file path="src/app/[locale]/payment/cuenta-bancaria/CuentaBancariaClient.tsx">
'use client';

import React, { useState, useEffect, FormEvent, ChangeEvent, useRef } from 'react';
import { useRouter, useSearchParams } from 'next/navigation'; 
import { ChevronLeft, Loader2, AlertCircle, CheckCircle } from 'lucide-react'; 
import ReCAPTCHA from "react-google-recaptcha"; 

// *************************************************************
// 1. CONFIGURACIÓN DE URL Y CLAVES
// *************************************************************
const BACKEND_URL = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000';

// 🟢 CONFIGURACIÓN: Usamos tu variable _MINE y limpiamos espacios (.trim())
const RECAPTCHA_SITE_KEY = (process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY_MINE || '').trim();

// ------------------------------------------------------------------
// Lógica Auxiliar y Componentes Internos
// ------------------------------------------------------------------
const isNumeric = (str: string) => /^\d+$/.test(str);

const PaymentSuccessContent = ({ fixerId, onBack }: { fixerId: string | null; onBack: () => void }) => {
    return (
        <div className="min-h-screen bg-blue-600 flex items-center justify-center p-4">
          <div className="max-w-xl mx-auto p-8 space-y-6 text-center bg-white rounded-xl shadow-2xl">
            <CheckCircle className="mx-auto h-16 w-16 text-green-500" />
            <h2 className="text-3xl font-bold text-gray-800">¡Operación Exitosa!</h2>
            <p className="text-lg text-gray-600">
              Operación completada. ID de Fixer:{' '}
              <span className="font-mono text-sm bg-gray-100 px-2 py-1 rounded">{fixerId || 'N/A'}</span>.
            </p>
            <div className="p-3 bg-blue-50 text-blue-700 rounded-lg border border-blue-200 text-sm">
              Tu cuenta bancaria ha sido actualizada.
            </div>
            <button
              onClick={onBack}
              className="w-full bg-cyan-500 hover:bg-cyan-600 text-white px-6 py-3 rounded-lg text-lg font-semibold transition-colors duration-150 shadow-md hover:shadow-lg"
            >
              Continuar al Centro de Pagos
            </button>
          </div>
        </div>
      );
};

// ------------------------------------------------------------------
// COMPONENTE PRINCIPAL (MiCuentaBancariaPage)
// ------------------------------------------------------------------
const MiCuentaBancariaPage = () => {
    const router = useRouter();
    const searchParams = useSearchParams();
    
    // --- ESTADOS DE LA LÓGICA DE NEGOCIO ---
    const [fixerId, setFixerId] = useState<string | null>(searchParams.get('fixerId')); 
    const [alreadyRegistered, setAlreadyRegistered] = useState(false);
    
    // --- ESTADOS DE UI Y ERROR ---
    const [isIdLoading, setIsIdLoading] = useState(searchParams.get('fixerId') ? false : true); 
    const isSuccessScreen = searchParams.get('status') === 'success'; 
    const [formError, setFormError] = useState<string | null>(null);
    const [loading, setLoading] = useState(false);
    const [deleteError, setDeleteError] = useState<string | null>(null);
    const [showDeleteConfirmation, setShowDeleteConfirmation] = useState(false);

    // --- ESTADOS DE FORMULARIO ---
    const [formData, setFormData] = useState({
        numeroCuenta: '',
        banco: 'Banco Nacional de Bolivia',
        nombreTitular: '',
        tipoCuenta: 'Cuenta de Ahorros', 
        identificacion: '',
        identificationSuffix: '',
    });
    const [fieldErrors, setFieldErrors] = useState({
        numeroCuenta: '',
        nombreTitular: '',
        identificacion: '',
    });

    // 🟢 ESTADOS/REFERENCIAS PARA CAPTCHA
    const [captchaToken, setCaptchaToken] = useState<string | null>(null); 
    const captchaRef = useRef<ReCAPTCHA>(null); 
    
    const handleCaptchaChange = (token: string | null) => {
        setCaptchaToken(token);
        if (token) {
            setFormError(null); 
            setDeleteError(null);
        }
    };

    useEffect(() => {
        if (!searchParams.get('fixerId')) {
            const storedId = localStorage.getItem('currentFixerId'); 
            if (storedId) {
                setFixerId(storedId);
            }
        }
        setIsIdLoading(false);
        
        if (localStorage.getItem('fix_bank_status') === 'CCB') {
            setAlreadyRegistered(true);
        } else {
            setAlreadyRegistered(false);
        }
    }, [searchParams, isSuccessScreen]);


    const validateField = (name: string, value: string) => {
        let error = '';
        if (name === 'numeroCuenta' && !isNumeric(value)) {
            error = 'La cuenta solo debe contener números.';
        }
        if (name === 'nombreTitular' && value.trim().length < 3) {
            error = 'El nombre del titular es demasiado corto.';
        }
        if (name === 'identificacion' && !isNumeric(value)) {
            error = 'La identificación solo debe contener números.';
        }
        setFieldErrors(prev => ({ ...prev, [name]: error }));
        return error === '';
    };

    const handleChange = (e: ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
        validateField(name, value);
    };

    const handleGoBack = () => {
        const id = fixerId || ''; 
        router.replace(`/payment/centro-de-pagos?fixerId=${id}`); 
    };
    
    // --- FUNCIÓN DE ELIMINACIÓN ---
    const handleDelete = async () => {
        if (!fixerId) {
            setDeleteError("Error: ID de Fixer no disponible para eliminar.");
            return;
        }

        if (!captchaToken) {
            setDeleteError("Por favor, marca la casilla 'No soy un robot' para confirmar la eliminación.");
            return;
        }

        setLoading(true);
        setDeleteError(null);
        
        try {
            const response = await fetch(`${BACKEND_URL}/api/bank-accounts/${fixerId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ "g-recaptcha-response": captchaToken }), 
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Fallo al eliminar (Status: ${response.status})`);
            }

            localStorage.setItem('fix_bank_status', 'SCB'); 
            localStorage.setItem('statusMessage', 'Cuenta bancaria eliminada exitosamente. Ahora puedes registrar una nueva.');
            
            // 🟢 CORREGIDO: Redirección con ruta completa /payment/...
            router.push(`/payment/cuenta-bancaria?fixerId=${fixerId}&status=success`);

        } catch (error: unknown) {
            console.error('Error al eliminar la cuenta:', error);
            setDeleteError(`Error al eliminar la cuenta: ${error.message || 'Error desconocido.'}`);
        } finally {
            captchaRef.current?.reset(); 
            setCaptchaToken(null);
            setLoading(false);
            setShowDeleteConfirmation(false);
        }
    };

    // --- FUNCIÓN DE REGISTRO (POST) ---
    const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        setFormError(null);

        const formIsValid = Object.keys(formData).every(key => 
            validateField(key, formData[key as keyof typeof formData])
        ) && Object.values(fieldErrors).every(err => err === '');

        if (!formIsValid) {
            setFormError("Por favor, corrige los errores en el formulario.");
            return;
        }

        if (!captchaToken) {
            setFormError("Por favor, marca la casilla 'No soy un robot'.");
            return;
        }
        
        setLoading(true);

        const cleanNombre = formData.nombreTitular.trim().replace(/\s+/g, ' '); 
        
        const dataToSend = {
            fixerId: fixerId, 
            accountNumber: formData.numeroCuenta,
            bankName: formData.banco,
            nameFixer: cleanNombre, 
            accountType: formData.tipoCuenta,
            identification:
                formData.identificacion +
                (formData.identificationSuffix ? '-' + formData.identificationSuffix.toUpperCase() : ''),
            "g-recaptcha-response": captchaToken,
        };

        try {
            const response = await fetch(`${BACKEND_URL}/api/bank-accounts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend),
            });

            if (!response.ok) {
                const errorData = await response.json(); 
                let userError = 'Error interno del servidor al registrar la cuenta bancaria.';
                
                if (errorData.message && errorData.message.includes('Duplicate account number')) {
                     userError = 'El número de cuenta bancaria ya ha sido registrado. Por favor, verifica tus datos.';
                } else if (errorData.message && errorData.message.includes('CAPTCHA')) {
                    userError = errorData.message; 
                } else if (errorData.message && errorData.message.includes('enum value')) {
                     userError = `Error de validación: El tipo de cuenta seleccionado no es válido.`;
                } else if (errorData.message) {
                    userError = errorData.message;
                }
                
                throw new Error(userError); 
            }

            localStorage.setItem('fix_bank_status', 'CCB'); 
            localStorage.setItem('statusMessage', 'Cuenta bancaria registrada exitosamente.');
            
            // 🟢 CORREGIDO: Redirección con ruta completa /payment/...
            router.push(`/payment/cuenta-bancaria?fixerId=${fixerId}&status=success`);
            
        } catch (error: unknown) {
            console.error('Error en el flujo de registro:', error);
            setFormError(`Error al procesar la solicitud: ${error.message}`);
        } finally {
            captchaRef.current?.reset(); 
            setCaptchaToken(null);
            setLoading(false);
        }
    };
    
    // --- RENDERIZADO ---

    // 1. Vista de Éxito
    if (isSuccessScreen) {
        return <PaymentSuccessContent fixerId={fixerId} onBack={handleGoBack} />;
    }
    
    // 2. Vista de Carga o sin ID
    if (isIdLoading || !fixerId) {
        return (
            <div className="min-h-screen bg-blue-600 flex items-center justify-center">
                <div className="text-white text-lg flex items-center">
                    <Loader2 className="animate-spin mr-3 h-6 w-6" />
                    {isIdLoading ? 'Cargando ID de Fixer...' : 'ID de Fixer no encontrado.'}
                </div>
            </div>
        );
    }

    // 3. Vista de Confirmación de Eliminación
    if (showDeleteConfirmation) {
        return (
            <div className="min-h-screen bg-blue-600 flex items-center justify-center p-4">
                <div className="max-w-xl mx-auto p-8 space-y-6 text-center bg-white rounded-xl shadow-2xl">
                    <h2 className="text-3xl font-bold text-red-600">
                        ¿Eliminar Cuenta Bancaria?
                    </h2>
                    <p className="text-lg text-gray-600">
                        Confirma la eliminación de la cuenta bancaria asociada a tu ID: <span className="font-mono text-sm bg-gray-100 px-2 py-1 rounded">{fixerId}</span>.
                    </p>
                    
                    <div className="flex justify-center">
                        <ReCAPTCHA
                            ref={captchaRef}
                            sitekey={RECAPTCHA_SITE_KEY}
                            onChange={handleCaptchaChange}
                        />
                    </div>

                    {deleteError && (
                          <div className="p-3 bg-red-50 border border-red-400 text-red-700 rounded-lg text-sm">
                              {deleteError}
                          </div>
                    )}
                    
                    <div className="flex justify-center space-x-4">
                        <button
                            onClick={() => {
                                setShowDeleteConfirmation(false); 
                                captchaRef.current?.reset();
                                setCaptchaToken(null);
                            }}
                            disabled={loading}
                            className="bg-gray-400 hover:bg-gray-500 disabled:opacity-50 text-white px-6 py-3 rounded-lg text-lg font-semibold transition-colors duration-150 shadow-md"
                        >
                            Cancelar
                        </button>
                        <button
                            onClick={handleDelete} 
                            disabled={loading || !captchaToken} 
                            className="bg-red-600 hover:bg-red-700 disabled:opacity-50 text-white px-6 py-3 rounded-lg text-lg font-semibold transition-colors duration-150 shadow-md"
                        >
                            {loading ? 'Eliminando...' : 'Confirmar Eliminación'}
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // 4. Vista de Cuenta Ya Registrada
    if (alreadyRegistered) {
        return (
            <div className="min-h-screen bg-blue-600 flex items-center justify-center p-4">
                <div className="max-w-xl mx-auto p-6 space-y-4 text-center bg-white rounded-xl shadow-lg">
                    <h2 className="text-2xl font-semibold text-green-600 mb-4">
                        ¡Ya tienes una cuenta registrada!
                    </h2>
                    <p className="text-gray-700 mb-6">
                        Tu cuenta bancaria ya está asociada al ID: <span className="font-mono text-sm bg-gray-100 px-2 py-1 rounded">{fixerId}</span>.
                        <br/> Si deseas registrar una nueva, primero debes eliminar la actual.
                    </p>
                    <div className="flex justify-center space-x-4">
                        <button
                            onClick={handleGoBack}
                            className="bg-cyan-500 hover:bg-cyan-600 text-white px-6 py-3 rounded-lg text-lg font-semibold transition-colors duration-150 shadow-md hover:shadow-lg"
                        >
                            Volver al Centro de Pagos
                        </button>
                        <button
                            onClick={() => {
                                setShowDeleteConfirmation(true);
                                captchaRef.current?.reset(); 
                                setCaptchaToken(null);
                            }}
                            className="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg text-lg font-semibold transition-colors duration-150 shadow-md hover:shadow-lg"
                        >
                            Eliminar Cuenta Existente
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // 5. Vista de Formulario de Registro (Default)
    return (
        <div className="min-h-screen bg-blue-600 flex flex-col font-sans">
          
          <header className="p-4 flex items-center justify-between bg-white shadow-md">
            <button
              onClick={handleGoBack}
              className="flex items-center text-gray-700 hover:text-blue-600 transition duration-150"
            >
              <ChevronLeft className="w-5 h-5 mr-1" />
              Volver al Centro de Pagos
            </button>
            <h1 className="text-xl font-bold text-gray-800">Registro de Cuenta Bancaria</h1>
            <div className="w-10"></div> 
          </header>
    
          <div className="flex-grow flex items-center justify-center p-4">
            <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
              <h2 className="text-2xl font-bold text-gray-800 mb-2">Asociar Cuenta</h2>
              <p className="text-gray-600 mb-6 border-b pb-4">
                ID de Fixer: <span className="font-mono text-sm bg-gray-100 px-2 py-1 rounded">{fixerId}</span>
              </p>
    
              <form onSubmit={handleSubmit} className="space-y-6">
                
                {/* Campo Banco */}
                <div>
                  <label htmlFor="banco" className="block text-sm font-medium text-gray-700 mb-1">
                    Banco
                  </label>
                  <select
                    id="banco"
                    name="banco"
                    value={formData.banco}
                    onChange={handleChange}
                    required
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option>Banco Nacional de Bolivia</option>
                    <option>Banco Mercantil Santa Cruz</option>
                    <option>Banco Unión</option>
                    <option>Otro Banco</option>
                  </select>
                </div>

                {/* Campo Tipo de Cuenta */}
                <div>
                  <label htmlFor="tipoCuenta" className="block text-sm font-medium text-gray-700 mb-1">
                    Tipo de Cuenta
                  </label>
                  <select
                    id="tipoCuenta"
                    name="tipoCuenta"
                    value={formData.tipoCuenta}
                    onChange={handleChange}
                    required
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option>Cuenta de Ahorros</option> 
                    <option>Cuenta Corriente</option>
                  </select>
                </div>
    
                {/* Campo Número de Cuenta */}
                <div>
                  <label htmlFor="numeroCuenta" className="block text-sm font-medium text-gray-700 mb-1">
                    Número de Cuenta <span className="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="numeroCuenta"
                    name="numeroCuenta"
                    value={formData.numeroCuenta}
                    onChange={handleChange}
                    maxLength={20}
                    required
                    className={`w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 ${fieldErrors.numeroCuenta ? 'border-red-500' : 'border-gray-300'}`}
                  />
                  {fieldErrors.numeroCuenta && <p className="text-red-500 text-xs mt-1">{fieldErrors.numeroCuenta}</p>}
                </div>
    
                {/* Campo Nombre del Titular */}
                <div>
                  <label htmlFor="nombreTitular" className="block text-sm font-medium text-gray-700 mb-1">
                    Nombre Completo del Titular <span className="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="nombreTitular"
                    name="nombreTitular"
                    value={formData.nombreTitular}
                    onChange={handleChange}
                    maxLength={100}
                    required
                    className={`w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 ${fieldErrors.nombreTitular ? 'border-red-500' : 'border-gray-300'}`}
                  />
                  {fieldErrors.nombreTitular && <p className="text-red-500 text-xs mt-1">{fieldErrors.nombreTitular}</p>}
                </div>

                {/* Campo Identificación */}
                <div className="flex space-x-2">
                    <div className="flex-grow">
                        <label htmlFor="identificacion" className="block text-sm font-medium text-gray-700 mb-1">
                            Nro. Identificación <span className="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            id="identificacion"
                            name="identificacion"
                            value={formData.identificacion}
                            onChange={handleChange}
                            maxLength={15}
                            required
                            className={`w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 ${fieldErrors.identificacion ? 'border-red-500' : 'border-gray-300'}`}
                        />
                        {fieldErrors.identificacion && <p className="text-red-500 text-xs mt-1">{fieldErrors.identificacion}</p>}
                    </div>
                    <div className="w-16">
                        <label htmlFor="identificationSuffix" className="block text-sm font-medium text-gray-700 mb-1">
                            Sufijo
                        </label>
                        <input
                            type="text"
                            id="identificationSuffix"
                            name="identificationSuffix"
                            value={formData.identificationSuffix}
                            onChange={handleChange}
                            maxLength={2}
                            placeholder="Ej: CH"
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 uppercase"
                        />
                    </div>
                </div>

                {/* 🟢 COMPONENTE CAPTCHA */}
                <div className="pt-2">
                    <ReCAPTCHA
                        ref={captchaRef}
                        sitekey={RECAPTCHA_SITE_KEY}
                        onChange={handleCaptchaChange}
                    />
                </div>

                {formError && (
                  <div className="p-3 bg-red-50 border border-red-400 text-red-700 rounded-lg text-sm transition-all duration-300">
                    <AlertCircle className="inline w-4 h-4 mr-2" />
                    {formError}
                  </div>
                )}
    
                <button
                  type="submit"
                  disabled={loading || !captchaToken} 
                  className={`w-full font-semibold py-3 rounded-lg mt-6 transition duration-150 ease-in-out shadow-lg 
                    ${loading || !captchaToken ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 text-white hover:shadow-xl'}`}
                >
                  {loading ? (
                    <span className="flex items-center justify-center">
                      <Loader2 className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" />
                      Guardando...
                    </span>
                  ) : (
                    'Guardar cuenta'
                  )}
                </button>
                
                <button
                  type="button"
                  onClick={handleGoBack}
                  className="w-full text-center text-blue-600 hover:text-blue-800 font-medium py-2 transition duration-150"
                >
                  Cancelar y Volver al Centro de Pagos
                </button>
              </form>
            </div>
          </div>
        </div>
    );
};

export default MiCuentaBancariaPage;
</file>

<file path="src/app/[locale]/payment/FixerWallet/recarga/RechargePageClient.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { CreditCard, QrCode, Building2, ArrowLeft } from 'lucide-react';
import { loadStripe } from '@stripe/stripe-js';
import { Elements } from '@stripe/react-stripe-js';
import TransferBank from './TransferBank';
import CardListFixer from './CardListFixer';
import ReCAPTCHA from 'react-google-recaptcha'; // ✅ Nombre correcto
import { AnimatePresence, motion } from 'framer-motion'; // ✨ Para animación

// ⚠️ Asegúrate de que esta clave esté definida en tu archivo .env.local
const RECAPTCHA_SITE_KEY = process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY || 'TU_CLAVE_PUBLICA_RECAPTCHA_AQUI'; 

// Stripe público
const stripePromise = loadStripe(
  'pk_test_51SHGq0Fp8K0s2pYx4l5z1fkIcXSouAknc9gUV6PpYKR8TjexmaC3OiJR9jNIa09e280Pa6jGVRA6ZNY7kSCCGcLt002CEmfDnU',
);

// Nuevo tipo para manejar el estado del modal de seguridad
type SecurityModalTarget = 'card' | 'qr' | null;

export default function FixerWalletRecharge({ userid }) {
 const router = useRouter();
 const searchParams = useSearchParams();
  const [receivedFixerId, setReceivedFixerId] = useState<string | null>(null);
 const [amount, setAmount] = useState('0.00');
 const [isFocused, setIsFocused] = useState(false);
 const [selectedMethod, setSelectedMethod] = useState<string | null>(null);
 const [showCardPayment, setShowCardPayment] = useState(false);
 const [screen, setScreen] = useState<'main' | 'transfer'>('main');

 // 🔐 Nuevos estados para la seguridad
 const [securityModalTarget, setSecurityModalTarget] = useState<SecurityModalTarget>(null); 
 const [recaptchaToken, setRecaptchaToken] = useState<string | null>(null);

 // Servineo receptor (para QR y tarjeta)
 const servineoId = '68f7c764495b9ef8a357c40b';

 useEffect(() => {
 const fixerId = searchParams.get('fixerId');
 if (fixerId) {
 setReceivedFixerId(fixerId);
 console.log('Fixer ID recibido para recarga:', fixerId);
 }
 }, [searchParams]);

 const handleQuickAmount = (value: number) => {
 setAmount(value.toFixed(2));
 };

 const handleCloseCardPayment = (paymentCompleted?: boolean) => {
 if (paymentCompleted) {
 alert('✅ Recarga realizada con éxito.');
 router.back();
 }
 setShowCardPayment(false);
 setSecurityModalTarget(null); // Limpiar el estado del modal
 setRecaptchaToken(null); // Limpiar el token de seguridad
 };

 const isValidAmount = () => {
 const num = Number(amount);
 return !isNaN(num) && num > 0;
 };

 const handleFocus = () => {
 setIsFocused(true);
 if (amount === '0.00') setAmount('');
 };

 const handleBlur = () => {
 setIsFocused(false);
 if (amount === '' || amount === '.') setAmount('0.00');
 };

 //inicio de la mejora
 const [amountError, setAmountError] = useState('');

 const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
 const value = e.target.value;

 // Permitir solo números y hasta 2 decimales
 if (!/^\d*\.?\d{0,2}$/.test(value)) return;

 // Extraer parte entera antes del punto
 const integerPart = value.split('.')[0];

 // Validar máximo 4 dígitos
 if (integerPart.length > 4) {
 setAmountError('El monto máximo permitido es de 4 dígitos.');
 return;
 }

 // Si está OK
 setAmountError('');
 setAmount(value);
 };

 //fin de la mejora

    // 🔐 Manejador que se activa cuando el usuario completa el reCAPTCHA
    const handleRecaptchaChange = (token: string | null) => {
        setRecaptchaToken(token);
        
        // Si el token es válido y el objetivo es Tarjeta, abrir el modal de tarjeta
        if (token && securityModalTarget === 'card') {
            setSelectedMethod('card');
            setShowCardPayment(true);
            setSecurityModalTarget(null); // Cerrar modal de seguridad
        } 
        // Si el token es válido y el objetivo es QR, redirigir inmediatamente
        else if (token && securityModalTarget === 'qr') {
            handleGoToQR(token);
            setSecurityModalTarget(null); // Cerrar modal de seguridad
        }
    };
    
    // 🆕 Función para iniciar el flujo de Tarjeta (Abre modal de seguridad)
    const startCardFlow = () => {
        if (!isValidAmount()) {
            alert('Por favor ingresa un monto válido mayor a cero.');
            return;
        }
        setSelectedMethod('card');
        setRecaptchaToken(null); 
        setSecurityModalTarget('card'); // Abrir el modal de seguridad con objetivo 'card'
    }
    
    // 🆕 Función para iniciar el flujo de QR (Abre modal de seguridad)
    const startQrFlow = () => {
        if (!isValidAmount()) {
            alert('Por favor ingresa un monto válido mayor a cero.');
            return;
        }
        setSelectedMethod('qr');
        setRecaptchaToken(null); 
        setSecurityModalTarget('qr'); // Abrir el modal de seguridad con objetivo 'qr'
    }
    
    // ⊞ Lógica de Redirección a Pago QR (Ahora recibe el token y redirige)
    const handleGoToQR = (token: string) => {
        const bookingId = 'recarga';
        router.push(
            `/payment/qrwallet?fixerId=${receivedFixerId}&amount=${Number(
                amount,
            )}&currency=BOB&type=wallet&providerId=${servineoId}&bookingId=${bookingId}&recaptchaToken=${token}`, // 🔑 CRÍTICO: Añadir el token a la URL
        );
    };

 // Pantalla principal
 if (screen === 'main') {
 return (
 <div className="min-h-screen bg-gray-100">
 {/* Header */}
 <div className="bg-blue-600 text-white px-6 py-4 flex items-center gap-4">
 <button onClick={() => router.back()}>
 <ArrowLeft size={24} />
 </button>
 <h1 className="text-2xl font-bold">Recargar Saldo</h1>
 </div>

 <div className="p-6 space-y-6">
 {/* Monto */}
 <div>
 <label className="block text-gray-900 font-semibold text-lg mb-2">
 Monto a recargar (Bs.)
 </label>
 <input
 type="text"
 value={amount}
 onFocus={handleFocus}
 onBlur={handleBlur}
 onChange={handleChange}
 className="w-full px-4 py-4 border-2 text-black border-gray-300 rounded-lg text-2xl font-semibold focus:border-blue-500 focus:outline-none"
 placeholder="0.00"
 />
 {/* inicio de cambios*/}
 {amountError && <p className="text-red-500 text-sm mt-1">{amountError}</p>}
 {/* fin de cambios */}
 </div>

 {/* Montos rápidos */}
 <div className="grid grid-cols-4 gap-3">
 {[20, 50, 100, 200].map((value) => (
 <button
 key={value}
 onClick={() => handleQuickAmount(value)}
 className="bg-blue-100 hover:bg-blue-200 text-blue-600 py-3 rounded-lg font-bold text-xl transition-colors"
 >
 {value}
 </button>
 ))}
 </div>

 {/* Métodos de Pago */}
 <div>
 <label className="block text-gray-900 font-semibold text-lg mb-3">Método de Pago</label>
 <div className="space-y-3">
 {/* 💳 Tarjeta */}
 <button
 onClick={startCardFlow} // 🆕 Llamar al flujo de seguridad
 className={`w-full flex items-center gap-4 p-4 rounded-xl border-2 transition-all ${
 selectedMethod === 'card'
 ? 'border-blue-600 bg-blue-50'
 : 'border-gray-300 bg-white hover:border-gray-400'
 }`}
 >
 <CreditCard size={28} className="text-gray-700" />
 <span className="text-lg font-semibold text-gray-900">Tarjeta de Crédito</span>
 </button>

 {/* ⊞ QR */}
 <button
 onClick={startQrFlow} // 🆕 Llamar al flujo de seguridad
 className={`w-full flex items-center gap-4 p-4 rounded-xl border-2 transition-all ${
 selectedMethod === 'qr'
 ? 'border-blue-600 bg-blue-50'
 : 'border-gray-300 bg-white hover:border-gray-400'
 }`}
 >
 <QrCode size={28} className="text-gray-700" />
 <span className="text-lg font-semibold text-gray-900">Pago QR</span>
 </button>

 {/* 🏦 Transferencia */}
 <button
 onClick={() => {
 if (!isValidAmount()) {
 alert('Por favor ingresa un monto válido mayor a cero.');
 return;
 }
 setSelectedMethod('transfer');
 setScreen('transfer');
 }}
 className={`w-full flex items-center gap-4 p-4 rounded-xl border-2 transition-all ${
 selectedMethod === 'transfer'
 ? 'border-blue-600 bg-blue-50'
 : 'border-gray-300 bg-white hover:border-gray-400'
 }`}
 >
 <Building2 size={28} className="text-gray-700" />
 <span className="text-lg font-semibold text-gray-900">Transferencia Bancaria</span>
 </button>
 </div>
 </div>

 {/* Botón Volver */}
 <button
 onClick={() => router.back()}
 className="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-4 rounded-xl font-bold text-lg transition-colors"
 >
 Volver
 </button>
 </div>

        {/* 🔐 MODAL DE SEGURIDAD (reCAPTCHA) */}
        <AnimatePresence>
            {securityModalTarget && (
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    className="fixed inset-0 z-[1100] bg-black/70 flex items-center justify-center p-4"
                    onClick={() => setSecurityModalTarget(null)}
                >
                    <motion.div
                        initial={{ scale: 0.8, y: 50 }}
                        animate={{ scale: 1, y: 0 }}
                        exit={{ scale: 0.8, y: 50 }}
                        onClick={(e) => e.stopPropagation()}
                        className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm relative flex flex-col items-center"
                    >
                        <h3 className="text-xl font-bold mb-4 text-gray-900 text-center">
                            Verificación de Seguridad
                        </h3>
                        <p className="text-sm text-gray-600 mb-6 text-center">
                            Por favor, confirma que no eres un robot para continuar con el pago.
                        </p>
                        
                        {/* Componente reCAPTCHA */}
                        <ReCAPTCHA
                            sitekey={RECAPTCHA_SITE_KEY}
                            onChange={handleRecaptchaChange}
                        />

                        {/* Botón de Cierre */}
                        <button
                            onClick={() => setSecurityModalTarget(null)}
                            className="mt-6 text-blue-600 hover:text-blue-800 text-sm font-semibold"
                        >
                            Cancelar
                        </button>

                    </motion.div>
                </motion.div>
            )}
        </AnimatePresence>
        
        {/* 💳 Modal Tarjeta (se abre después del reCAPTCHA si el target es 'card') */}
        {showCardPayment && (
          <div
            className="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4"
            onClick={() => handleCloseCardPayment(false)}
          >
            <div
              onClick={(e) => e.stopPropagation()}
              className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-4xl max-h-[85vh] overflow-y-auto relative"
            >
              <button
                onClick={() => handleCloseCardPayment(false)}
                className="absolute top-3 right-3 text-gray-600 hover:text-red-500 text-3xl font-bold transition-colors"
              >
                ✕
              </button>

              <Elements stripe={stripePromise}>
                <div className="flex flex-col items-center justify-center gap-6">
                  <h2 className="text-2xl font-bold text-center text-gray-900">
                    Selecciona tu tarjeta o agrega una nueva
                  </h2>

                  <CardListFixer
                    fixerId={userid}
                    amount={amount}
                    recaptchaToken={recaptchaToken} // 🔑 CRÍTICO: Pasa el token a CardListFixer
                    onRechargeSuccess={() => handleCloseCardPayment(true)}
                  />
                </div>
              </Elements>
            </div>
          </div>
        )}
      </div>
    );
  }

  // 🏦 Pantalla de transferencia bancaria
  if (screen === 'transfer') {
    return (
      <TransferBank
        fixerId={receivedFixerId!}
        amount={Number(amount)}
        servineoId={servineoId}
        onBack={() => setScreen('main')}
      />
    );
  }

  return null;
}
</file>

<file path="src/app/[locale]/payment/FixerWallet/recarga/TransferBank.tsx">
'use client';
//pasar
import React from 'react';
import { useEffect, useState } from 'react';
import BackButton from '../../components/BackButton';
import { Copy } from 'lucide-react';

interface TransferBankProps {
  fixerId: string;
  onBack: () => void;
  servineoId: string; // agregas esta prop
  amount: number;
}

interface TransferData {
  transactionNumber: string;
  accountNumber: string;
  totalAmount: number;
  status: string;
  recipientName?: string; // destinatario
}

export default function TransferBank({ fixerId, servineoId, amount }: TransferBankProps) {
  const [data, setData] = useState<TransferData | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [transferStatus, setTransferStatus] = useState<string | null>(null);

 // const BACKEND_URL_DEPLOYADO = process.env.BACKEND_URL;

  useEffect(() => {
    console.log('TransferBank useEffect triggered', { fixerId, servineoId, amount });

    async function fetchTransferData() {
      setLoading(true);
      setError(null);

      if (!fixerId || !amount || amount <= 0) {
        setError('Monto inválido para transferencia');
        setLoading(false);
        return;
      }

      try {
       const res = await fetch(`${process.env.NEXT_PUBLIC_BACKEND_URL}/api/transferencia-bancaria/intent`   , {
        //const res = await fetch('/api/transferencia-bancaria/intent'   , {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fixerId, amount, servineoId }),
        });

        console.log('Response status:', res.status);

        if (!res.ok) {
          const errData = await res.json();
          throw new Error(errData.message || 'Error al recuperar datos');
        }

        const json = await res.json();
        const intent = json.intent;
        const method = json.paymentMethod;

        if (!intent || !method) throw new Error('Datos incompletos');

        setData({
          transactionNumber: intent.paymentReference,
          accountNumber: method.accountNumber,
          totalAmount: intent.amountExpected,
          status: intent.status,
          recipientName: method.accountDisplay,
        });

        setTransferStatus(intent.status); // <-- Guardar estado aquí
      } catch (err: unknown) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    }

    fetchTransferData();
  }, [fixerId, amount, servineoId]);

  //para copiar la cuenta bancaria
  const copyToClipboard = (text: string) => {
    if (!text) return;
    navigator.clipboard
      .writeText(text)
      .then(() => {
        alert('Número de cuenta copiado al portapapeles');
      })
      .catch(() => {
        alert('No se pudo copiar el número de cuenta');
      });
  };

  // Helper para formatear moneda
  const money = (n: number) => n.toLocaleString('es-BO', { style: 'currency', currency: 'BOB' });

  if (loading) {
    return (
      <div className="min-h-screen bg-white p-6 flex items-center justify-center">
        <p className="text-center text-gray-700">Cargando información de transferencia...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white mt-16">
      <header className="bg-[#2B6AE0]">
        <div className="max-w-5xl px-6 py-6">
          <h1 className="text-5xl font-semibold text-white ">Recarga por transferencia bancaria</h1>
        </div>
      </header>

      <BackButton fallback="/payments" className="fixed bottom-4 right-4 z-50" />

      <main className="max-w-5xl mx-auto p-6">
        {/* Mostrar error si existe */}
        {error && <p className="text-red-600 mb-3 text-center font-semibold text-2xl">{error}</p>}

        {/* Mostrar cargando */}
        {loading && (
          <p className="text-center text-2xl">Cargando información de transferencia...</p>
        )}

        {/* Mostrar información aunque no haya datos (usar valores por defecto) */}
        {!loading && (
          <div className="flex flex-col items-center justify-center">
            <section className="w-full max-w-4xl">
              <h2 className="text-4xl font-semibold mb-6 text-black text-center">
                Información de pago
              </h2>

              <div className="my-2">
                <hr className="w-full max-w-5xl border-t-2 border-[#2B6AE0] mx-auto" />
              </div>

              <dl className="space-y-6 text-black">
                {/* Destinatario */}
                <div className="flex flex-col md:flex-row items-start md:items-center min-h-8 px-6">

                  <dt className="text-2xl font-medium w-44">Destinatario:</dt>
                  <dd className="text-2xl leading-tight flex-grow text-right">
                    {data?.recipientName || data?.transactionNumber
                      ? data.recipientName || 'Servineo.Cop'
                      : '—'}
                  </dd>
                </div>

                {/* Número de Transacción */}
                <div className="flex flex-col md:flex-row items-start md:items-center min-h-8 px-6">

                  <dt className="text-2xl font-medium w-44 whitespace-nowrap">
                    N° de Transacción:
                  </dt>
                  <dd className="text-2xl leading-tight flex-grow text-right">
                    {data?.transactionNumber || 'XXXXXXXXXX'}
                  </dd>
                </div>

                {/* Número de cuenta */}
                <div className="flex flex-col md:flex-row items-start md:items-center min-h-8 px-6">

                  <dt className="text-2xl font-medium w-44 whitespace-nowrap">
                    Número de cuenta para la transferencia:
                  </dt>
                  <dd className="text-2xl leading-tight flex-grow text-right">
                    {data?.accountNumber || 'XXXXXXXXXX'}
                  </dd>

                  <button
                    onClick={() => copyToClipboard(data?.accountNumber || '')}
                    aria-label="Copiar número de cuenta"
                    title="Copiar número de cuenta"
                    type="button"
                    className="ml-4 text-gray-600 hover:text-blue-600 transition-colors"
                  >
                    <Copy size={24} />
                  </button>
                </div>

                {/* Total */}
                <div className="flex items-center min-h-8 px-6">
                  <dt className="text-2xl font-semibold w-44">Total:</dt>
                  <dd className="text-2xl font-semibold leading-tight flex-grow text-right">
                    {amount
                      ? money(amount)
                      : data?.totalAmount
                        ? money(data.totalAmount)
                        : 'XX,XXX.XX Bs.'}
                  </dd>
                </div>

                {/* Separador */}
                <div className="my-2">
                  <hr className="w-full max-w-5xl border-t-2 border-[#2B6AE0] mx-auto" />
                </div>

                {/* Estado */}
                <div className="flex items-center min-h-8 px-6 mt-6">
                  <dt className="text-2xl font-medium w-44">Estado:</dt>
                  <dd className="text-2xl leading-tight flex-grow text-right">
                    {transferStatus ? transferStatus.toUpperCase() : '—'}
                  </dd>
                </div>

                {/* Separador final */}
                <div className="my-7">
                  <hr className="w-full max-w-5xl border-t-2 border-[#2B6AE0] mx-auto" />
                </div>
              </dl>
            </section>
          </div>
        )}

        {/* Botón Volver fijo abajo */}
        <div className="fixed bottom-4 right-4 z-50">
          <button
            onClick={() => window.history.back()}
            className="bg-blue-600 text-white py-4 px-8 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-colors"
          >
            ← Volver
          </button>
        </div>
      </main>
    </div>
  );
}
</file>

<file path="src/app/[locale]/payment/Pagos-Fisico/page.tsx">
'use client';
// app/payment/Pagos-Fisico/page.tsx
// Página principal de gestión de trabajos y pagos

import React, { useState, useEffect } from 'react';
import { Briefcase, DollarSign, CheckCircle, Clock, AlertCircle, Loader2 } from 'lucide-react';
import { Trabajo } from '../../../../utils/types';
import { getFixerId, fetchAllFixerJobs } from '../../../../utils/paymentapi';
import PaymentMethodCashFixer from '../../../../Components/payment/PaymentMethodCashFixer';

export default function TrabajosYPagos() {
  const [trabajos, setTrabajos] = useState<Trabajo[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [selectedTrabajo, setSelectedTrabajo] = useState<Trabajo | null>(null);
  const [showPaymentModal, setShowPaymentModal] = useState(false);
  const [fixerId, setFixerId] = useState('');

  // Obtener Fixer ID al montar
  useEffect(() => {
    const id = getFixerId();
    setFixerId(id);
  }, []);

  // Cargar trabajos cuando tenemos el fixerId
  useEffect(() => {
    if (fixerId) {
      fetchTrabajos();
    }
  }, [fixerId]);

  // Función para cargar trabajos
  const fetchTrabajos = async () => {
    if (!fixerId || fixerId.trim() === '') {
      console.error('❌ No hay fixerId disponible');
      setError('No se pudo obtener el Fixer ID');
      setLoading(false);
      return;
    }

    setLoading(true);
    setError(null);
    
    console.log('📋 Cargando trabajos para fixerId:', fixerId);

    try {
      const trabajosData = await fetchAllFixerJobs(fixerId);
      
      console.log('🎯 Trabajos cargados:', trabajosData);
      setTrabajos(trabajosData);
      
      if (trabajosData.length === 0) {
        setError('No se encontraron trabajos para este fixer.');
      }
    } catch (err: unknown) {
      console.error('❌ Error completo:', err);
      const errorMessage = err.message || 'Error al cargar trabajos';
      setError(errorMessage);
      
      // Trabajos de ejemplo en caso de error
      setTrabajos([
        { 
          jobId: "ERR-001", 
          titulo: "Pago Ejemplo 1", 
          descripcion: "Error al cargar, mostrando ejemplo", 
          totalPagar: 100.00, 
          paymentStatus: "pending", 
          fecha: "2025-11-10" 
        },
      ]);
    } finally {
      setLoading(false);
    }
  };

  // Abrir modal de pago
  const handleOpenPayment = (trabajo: Trabajo) => {
    console.log('💳 Abriendo modal para:', trabajo);
    setSelectedTrabajo(trabajo);
    setShowPaymentModal(true);
  };

  // Cerrar modal de pago
  const handleClosePayment = (completed?: boolean) => {
    console.log('🔒 Cerrando modal. Completado:', completed);
    setShowPaymentModal(false);
    setSelectedTrabajo(null);
    if (completed) fetchTrabajos();
  };

  // Calcular estadísticas
  const totalTrabajos = trabajos.length;
  const trabajosPagados = trabajos.filter(t => t.paymentStatus === 'paid').length;
  const trabajosPendientes = trabajos.filter(t => t.paymentStatus === 'pending').length;

  // Loading state
  if (loading) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="animate-spin text-blue-600 mx-auto mb-4" size={48} />
          <p className="text-gray-600">Cargando trabajos...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <div className="bg-blue-600 text-white px-6 py-4 shadow-md">
        <div className="max-w-6xl mx-auto">
          <h1 className="text-2xl font-bold">Gestión de Trabajos y Pagos</h1>
          <p className="text-blue-200 text-sm mt-1">Fixer ID: {fixerId}</p>
        </div>
      </div>

      <div className="max-w-6xl mx-auto px-4 py-6">
        {/* Alert de error */}
        {error && (
          <div className="mb-6 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
            <p className="text-yellow-800">{error}</p>
          </div>
        )}

        {/* Cards de estadísticas */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          {/* Total */}
          <div className="bg-white rounded-lg shadow p-4">
            <div className="flex items-center gap-3">
              <div className="bg-blue-100 p-3 rounded-lg">
                <Briefcase className="text-blue-600" size={24} />
              </div>
              <div>
                <p className="text-sm text-gray-600">Total</p>
                <p className="text-2xl font-bold">{totalTrabajos}</p>
              </div>
            </div>
          </div>

          {/* Pagados */}
          <div className="bg-white rounded-lg shadow p-4">
            <div className="flex items-center gap-3">
              <div className="bg-green-100 p-3 rounded-lg">
                <CheckCircle className="text-green-600" size={24} />
              </div>
              <div>
                <p className="text-sm text-gray-600">Pagados</p>
                <p className="text-2xl font-bold">{trabajosPagados}</p>
              </div>
            </div>
          </div>

          {/* Pendientes */}
          <div className="bg-white rounded-lg shadow p-4">
            <div className="flex items-center gap-3">
              <div className="bg-yellow-100 p-3 rounded-lg">
                <Clock className="text-yellow-600" size={24} />
              </div>
              <div>
                <p className="text-sm text-gray-600">Pendientes</p>
                <p className="text-2xl font-bold">{trabajosPendientes}</p>
              </div>
            </div>
          </div>
        </div>

        {/* Lista de trabajos */}
        <div className="bg-white rounded-lg shadow">
          <div className="px-6 py-4 border-b">
            <h2 className="text-xl font-semibold">Lista de Trabajos</h2>
          </div>

          <div className="divide-y">
            {trabajos.length === 0 ? (
              <div className="px-6 py-12 text-center text-gray-500">
                <AlertCircle className="mx-auto mb-3" size={48} />
                <p>No hay trabajos registrados</p>
              </div>
            ) : (
              trabajos.map((trabajo) => (
                <div 
                  key={trabajo.jobId} 
                  className="px-6 py-5 hover:bg-gray-50 transition-colors"
                >
                  <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                    {/* Información del trabajo */}
                    <div className="flex-1">
                      <div className="flex items-center gap-3 mb-2">
                        <h3 className="text-lg font-semibold">{trabajo.titulo}</h3>
                        <span className={`inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium ${
                          trabajo.paymentStatus === 'paid' 
                            ? 'bg-green-100 text-green-800' 
                            : trabajo.paymentStatus === 'failed'
                            ? 'bg-red-100 text-red-800'
                            : 'bg-yellow-100 text-yellow-800'
                        }`}>
                          {trabajo.paymentStatus === 'paid' ? (
                            <>
                              <CheckCircle size={16} />
                              Pagado
                            </>
                          ) : trabajo.paymentStatus === 'failed' ? (
                            <>
                              <AlertCircle size={16} />
                              Error
                            </>
                          ) : (
                            <>
                              <Clock size={16} />
                              Pendiente
                            </>
                          )}
                        </span>
                      </div>
                      
                      <p className="text-sm text-gray-600 mb-2">{trabajo.descripcion}</p>
                      
                      <div className="flex items-center gap-2 text-sm text-gray-500">
                        <span className="font-mono bg-gray-100 px-2 py-1 rounded">
                          {trabajo.jobId}
                        </span>
                        <span>•</span>
                        <span>{trabajo.fecha}</span>
                      </div>
                    </div>

                    {/* Monto y acciones */}
                    <div className="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                      <div className="flex items-center gap-2">
                        <DollarSign className="text-gray-400" size={20} />
                        <span className="text-2xl font-bold">
                          Bs. {trabajo.totalPagar.toFixed(2)}
                        </span>
                      </div>
                      
                      {trabajo.paymentStatus === 'pending' ? (
                        <button
                          onClick={() => handleOpenPayment(trabajo)}
                          className="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-sm hover:shadow-md transition-all"
                        >
                          💰 Confirmar Pago
                        </button>
                      ) : trabajo.paymentStatus === 'paid' ? (
                        <button 
                          disabled 
                          className="px-6 py-2.5 bg-gray-200 text-gray-500 font-semibold rounded-lg cursor-not-allowed"
                        >
                          ✓ Pagado
                        </button>
                      ) : (
                        <button 
                          disabled 
                          className="px-6 py-2.5 bg-red-200 text-red-500 font-semibold rounded-lg cursor-not-allowed"
                        >
                          ✕ Error
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      </div>

      {/* Modal de pago */}
      {showPaymentModal && selectedTrabajo && (
        <PaymentMethodCashFixer
          trabajo={selectedTrabajo}
          onClose={handleClosePayment}
          onBack={() => setShowPaymentModal(false)}
        />
      )}
    </div>
  );
}
</file>

<file path="src/app/[locale]/payment/trabajos/TrabajosList.tsx">
import { useEffect, useState } from "react";
import LoadingFallback from "./LoadingFallback";
import PaymentMethods from "@/app/[locale]/payment/components/PaymentDemoAdaptado";

// Define el tipo de Job
interface Job {
  _id: string;
  title: string;
  description: string;
  fixerId: string;
  status: string;
  type: string;
  price: number;
  comment?: string;
}

// Define el tipo de props
interface TrabajosListProps {
  userId: string;
}

export default function TrabajosList({ userId }: TrabajosListProps) {
  const [jobs, setJobs] = useState<Job[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedJob, setSelectedJob] = useState<Job | null>(null);

  useEffect(() => {
    const fetchJobs = async () => {
      try {
        console.log("📡 Obteniendo trabajos para el usuario:", userId);
        const res = await fetch(`${process.env.NEXT_PUBLIC_BACKEND_URL}/api/jobs?userId=${userId}`);
        if (!res.ok) throw new Error("Error al obtener trabajos");
        const data = await res.json();
        console.log("✅ Trabajos recibidos:", data);
        setJobs(data);
      } catch (err) {
        console.error("❌ Error:", err);
      } finally {
        setLoading(false);
      }
    };

    fetchJobs();
  }, [userId]);

  if (loading) return <LoadingFallback />;

  if (jobs.length === 0)
    return (
      <div className="min-h-screen flex items-center justify-center text-gray-600">
        No hay trabajos registrados para este usuario.
      </div>
    );

  return (
    <div className="min-h-screen bg-gray-100 pt-20 px-4 flex flex-col items-center">
      {/* Header */}
      <header className="fixed top-0 left-0 w-full bg-gradient-to-r from-cyan-400 to-blue-500 text-white py-4 shadow-md z-10 text-center">
        <h1 className="text-2xl font-bold">Mis Trabajos</h1>
      </header>

      <div className="w-full max-w-3xl mt-6">
        <ul className="space-y-4">
          {jobs.map((job) => {
            const status = job.status.toLowerCase();
            const isPending = status === "pending";
            const isPaid = status === "pagado";

            return (
              <li
                key={job._id}
                className={`p-5 rounded-2xl border transition shadow-sm hover:shadow-lg ${
                  isPending ? "border-red-300 bg-red-50" : "border-gray-200 bg-white"
                }`}
              >
                <h2 className="text-lg font-semibold text-gray-800">{job.title}</h2>
                <p className="text-gray-600">{job.description}</p>
                <p className="text-gray-600">
                  <span className="font-semibold text-gray-700">FixerID:</span> {job.fixerId}
                </p>
                <p className="mt-1">
                  <span className="font-semibold text-gray-700">Estado:</span>{" "}
                  <span
                    className={`font-medium ${
                      isPaid
                        ? "text-green-600"
                        : isPending
                        ? "text-red-600"
                        : "text-yellow-600"
                    }`}
                  >
                    {job.status}
                  </span>
                </p>

                <p className="text-sm text-gray-500 mt-1">
                  Tipo: {job.type} | Precio: Bs{job.price}
                </p>

                {job.comment && (
                  <p className="text-sm text-gray-400 mt-1">
                    Comentario: &quot;{job.comment}&quot;
                  </p>
                )}

                {/* Botón de pagar si está pendiente */}
                {isPending && (
                  <button
                    onClick={() => setSelectedJob(job)}
                    className="mt-4 px-5 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 active:scale-95 transition"
                  >
                    Pagar
                  </button>
                )}
              </li>
            );
          })}
        </ul>
      </div>

      {/* Mostrar el modal de métodos de pago si hay un trabajo seleccionado */}
      {selectedJob && (
        <PaymentMethods
          amount={selectedJob.price}
          jobId={selectedJob._id}
          requesterId={userId}
          fixerId={selectedJob.fixerId}
          onClose={() => setSelectedJob(null)}
          onPaymentSuccess={async () => {
            const res = await fetch(`/api/jobs?userId=${userId}`);
            const data = await res.json();
            setJobs(data);
            setSelectedJob(null);
          }}
        />
      )}
    </div>
  );
}
</file>

<file path="src/app/[locale]/requesterEdit/page.tsx">
'use client';

import { useState, useEffect, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import {
  ArrowLeft,
  UserPen,
  ShieldCheck,
  KeyRound,
  Smartphone,
  ScanFace,
  Layers,
  Menu,
  X
} from 'lucide-react';
import { useAuth } from '@/app/lib/hooks/usoAutentificacion';
import AccountLoginSettings from './linkAccounts/page';
import DispositivosVinculados from './dispositivosVinculados/dispositivosVinculados';
import RequesterEditForm from '@/Components/requester/request/RequesterEditForm';
import ChangePasswordForm from '@/Components/requester/request/ChangePasswordForm';
import Image from 'next/image';
import { useTranslations } from 'next-intl';

export default function ConfiguracionPage() {
  const t = useTranslations('ConfiguracionPage');
  const { user } = useAuth();
  const router = useRouter();

  const [seccionActiva, setSeccionActiva] = useState('inicio');
  const [profileLoading, setProfileLoading] = useState(false);
  const [profileError, setProfileError] = useState<string | null>(null);

  // mobile drawer state
  const [mobileOpen, setMobileOpen] = useState(false);

  type SafeUser = { name?: string; email?: string; url_photo?: string };
  const safeUser = (user as SafeUser) ?? null;

  function getInitials(name: string) {
    const clean = (name || '').trim();
    if (!clean) return 'U';
    const parts = clean.split(/\s+/);
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
  }

  const loadProfileData = useCallback(async () => {
    if (!user) return;

    setProfileLoading(true);
    setProfileError(null);

    try {
      // fetch datos si necesitas
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : t('errors.loadProfile');
      setProfileError(message);
    } finally {
      setProfileLoading(false);
    }
  }, [user, t]);

  useEffect(() => {
    if (seccionActiva === 'perfil') {
      loadProfileData();
    }
  }, [seccionActiva, loadProfileData]);

  const handlePasswordCancel = () => setSeccionActiva('inicio');
  const handlePasswordSaved = () => setTimeout(() => setSeccionActiva('inicio'), 1500);

  const closeMobile = () => setMobileOpen(false);

  const renderContenido = () => {
    switch (seccionActiva) {
      case 'perfil':
        return (
          <div className='max-w-4xl w-full'>
            <h2 className='text-2xl font-bold text-center mb-8 text-gray-800'>
              {t('sections.editProfile')}
            </h2>
            <div className='bg-white rounded-2xl shadow-lg p-4 sm:p-6 border border-gray-200'>
              <RequesterEditForm />
            </div>
          </div>
        );

      case 'password':
        return (
          <div className='max-w-2xl w-full'>
            <h2 className='text-2xl font-bold text-center mb-8 text-gray-800'>
              {t('sections.changePassword')}
            </h2>
            <div className='bg-white rounded-2xl shadow-lg p-4 sm:p-6 border border-gray-200'>
              <ChangePasswordForm onCancel={handlePasswordCancel} onSaved={handlePasswordSaved} />
            </div>
          </div>
        );

      case 'dispositivos':
        return (
          <div className='max-w-4xl w-full'>
            <h2 className='text-xl font-semibold text-center mb-4'>Dispositivos Vinculados</h2>
            <DispositivosVinculados />
          </div>
        );

      case 'seguridad':
        return (
          <div className='max-w-4xl w-full'>
            <h2 className='text-xl font-semibold text-center mb-2'>{t('sections.security')}</h2>
            <p className='text-sm text-center text-gray-600 mb-8'>{t('sections.securityDescription')}</p>

            {/* responsive cards: column on xs, row wrap on sm+ */}
            <div className='flex flex-col sm:flex-row sm:flex-wrap gap-4 justify-center items-stretch'>
              <div className='w-full sm:w-auto'>
                <button
                  onClick={() => setSeccionActiva('password')}
                  className='flex items-center gap-3 px-4 py-3 sm:px-6 sm:py-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-lg transition-transform duration-200 bg-white cursor-pointer w-full min-w-[220px]'
                >
                  <KeyRound className='w-7 h-7 text-blue-600 flex-shrink-0' />
                  <span className='font-medium text-left'>{t('security.changePassword')}</span>
                </button>
              </div>

              <div className='w-full sm:w-auto'>
                <button
                  onClick={() => setSeccionActiva('dispositivos')}
                  className='flex items-center gap-3 px-4 py-3 sm:px-6 sm:py-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-lg transition-transform duration-200 bg-white cursor-pointer w-full min-w-[220px]'
                >
                  <Smartphone className='w-6 h-6 text-blue-600 flex-shrink-0' />
                  <span className='font-medium text-left'>{t('security.linkedDevices')}</span>
                </button>
              </div>

              <div className='w-full sm:w-auto'>
                <button
                  onClick={() => router.push('/requesterEdit/Seguridad/Authenticator/')}
                  className='flex items-center gap-3 px-4 py-3 sm:px-6 sm:py-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-lg transition-transform duration-200 bg-white cursor-pointer w-full min-w-[220px]'
                >
                  <ScanFace className='w-6 h-6 text-blue-600 flex-shrink-0' />
                  <span className='font-medium text-left'>Authenticator</span>
                </button>
              </div>
            </div>
          </div>
        );

      case 'cuentas':
        return <AccountLoginSettings token={localStorage.getItem('servineo_token') ?? ''} />;

      default:
        return (
          <div className='flex flex-col items-center justify-top flex-1 mt-6 sm:mt-10 px-4 sm:px-0'>
            {safeUser ? (
              <>
                <div className='mb-4'>
                  {safeUser.url_photo ? (
                    <Image
                      src={safeUser.url_photo}
                      alt={t('welcome.profilePhoto')}
                      width={112}
                      height={112}
                      className='w-24 sm:w-28 h-24 sm:h-28 rounded-full border-4 border-blue-100 object-cover mb-4 shadow-sm'
                    />
                  ) : (
                    <div className='w-24 sm:w-28 h-24 sm:h-28 rounded-full bg-blue-100 flex items-center justify-center text-2xl font-semibold text-blue-700 mb-4 shadow-sm border-4 border-blue-200'>
                      {getInitials(safeUser.name ?? safeUser.email ?? '')}
                    </div>
                  )}
                </div>
                <h2 className='text-xl sm:text-2xl font-semibold mb-2 text-gray-800'>
                  {t('welcome.title', { name: safeUser.name ?? t('welcome.defaultName') })}
                  <span className='text-blue-600'> {safeUser.name ?? 'Usuario'}</span>
                </h2>
                <p className='text-gray-600 max-w-md text-center mt-2 px-2'>
                  {t('welcome.description')}
                </p>
              </>
            ) : (
              <p className='text-gray-600'>{t('welcome.loginRequired')}</p>
            )}
          </div>
        );
    }
  };

  return (
    <div className='font-sans flex flex-col min-h-screen bg-gray-50 text-gray-800'>
      {/* mobile top bar - photo and user name removed as requested */}
      <header className='md:hidden flex items-center justify-between px-4 py-3 bg-white shadow-sm sticky top-0 z-30'>
        <div className='flex items-center gap-3'>
          <button
            onClick={() => router.back()}
            className='flex items-center justify-center w-9 h-9 rounded-full bg-blue-50 hover:bg-blue-100 text-blue-600'
            aria-label='Volver'
          >
            <ArrowLeft className='w-4 h-4' />
          </button>

          {/* Only keep the small "Configuración" label (no photo, no user name) */}
          <div className='text-sm'>
            <div className='text-xs text-gray-500'>Configuración</div>
          </div>
        </div>

        <div className='flex items-center gap-2'>
          <button
            onClick={() => setMobileOpen(true)}
            className='p-2 rounded-md bg-blue-50 hover:bg-blue-100 text-blue-600'
            aria-label='Abrir menú'
          >
            <Menu className='w-5 h-5' />
          </button>
        </div>
      </header>

      <div className='flex flex-1'>
        {/* desktop sidebar */}
        <aside className='hidden md:flex md:w-64 lg:w-56 bg-white p-6 flex-col justify-between relative shadow-md'>
          <div>
            <div className='flex items-center justify-between mb-4'>
              <h2 className='text-lg font-semibold text-gray-800 flex items-center gap-2'>
                <button
                  onClick={() => router.back()}
                  className='flex items-center justify-center w-8 h-8 rounded-full bg-blue-50 hover:bg-blue-100 text-blue-600'
                >
                  <ArrowLeft className='w-4 h-4' />
                </button>
                {t('title')}
              </h2>
            </div>

            <nav className='space-y-2'>
              <button
                onClick={() => setSeccionActiva('perfil')}
                className={`flex items-center gap-2 w-full px-3 py-2 rounded-lg text-left transition-all duration-200 ${
                  seccionActiva === 'perfil'
                    ? 'bg-blue-100 text-blue-600 font-semibold'
                    : 'hover:bg-blue-50 hover:text-blue-600'
                }`}
              >
                <UserPen className='w-6 h-6 text-blue-600' />
                {t('navigation.editProfile')}
              </button>

              <button
                onClick={() => setSeccionActiva('seguridad')}
                className={`flex items-center gap-2 w-full px-3 py-2 rounded-lg text-left transition-all duration-200 ${
                  seccionActiva === 'seguridad' || seccionActiva === 'password'
                    ? 'bg-blue-100 text-blue-600 font-semibold'
                    : 'hover:bg-blue-50 hover:text-blue-600'
                }`}
              >
                <ShieldCheck className='w-7 h-7 text-blue-600' />
                {t('navigation.security')}
              </button>

              <button
                onClick={() => setSeccionActiva('cuentas')}
                className={`flex items-center gap-2 w-full px-3 py-2 rounded-lg text-left transition-all duration-200 ${
                  seccionActiva === 'cuentas'
                    ? 'bg-blue-100 text-blue-600 font-semibold'
                    : 'hover:bg-blue-50 hover:text-blue-600'
                }`}
              >
                <Layers className='w-7 h-7 text-blue-600' />
                {t('navigation.linkedAccounts')}
              </button>
            </nav>
          </div>
        </aside>

        {/* mobile drawer */}
        {mobileOpen && (
          <div className='fixed inset-0 z-50 md:hidden'>
            <div className='absolute inset-0 bg-black/40' onClick={closeMobile} />
            <div className='absolute left-0 top-0 bottom-0 w-72 bg-white p-4 shadow-lg overflow-auto'>
              <div className='flex items-center justify-between mb-4'>
                <div className='text-lg font-semibold'>{t('title')}</div>
                <button onClick={closeMobile} className='p-2 rounded-md bg-blue-50 hover:bg-blue-100 text-blue-600' aria-label='Cerrar'>
                  <X className='w-4 h-4' />
                </button>
              </div>

              <nav className='space-y-2'>
                <button
                  onClick={() => {
                    setSeccionActiva('perfil');
                    closeMobile();
                  }}
                  className={`flex items-center gap-3 w-full px-3 py-2 rounded-lg text-left transition-all duration-200 ${
                    seccionActiva === 'perfil' ? 'bg-blue-100 text-blue-600 font-semibold' : 'hover:bg-blue-50'
                  }`}
                >
                  <UserPen className='w-5 h-5 text-blue-600' />
                  <span> {t('navigation.editProfile')} </span>
                </button>

                <button
                  onClick={() => {
                    setSeccionActiva('seguridad');
                    closeMobile();
                  }}
                  className={`flex items-center gap-3 w-full px-3 py-2 rounded-lg text-left transition-all duration-200 ${
                    seccionActiva === 'seguridad' || seccionActiva === 'password'
                      ? 'bg-blue-100 text-blue-600 font-semibold'
                      : 'hover:bg-blue-50'
                  }`}
                >
                  <ShieldCheck className='w-5 h-5 text-blue-600' />
                  <span> {t('navigation.security')} </span>
                </button>

                <button
                  onClick={() => {
                    setSeccionActiva('cuentas');
                    closeMobile();
                  }}
                  className={`flex items-center gap-3 w-full px-3 py-2 rounded-lg text-left transition-all duration-200 ${
                    seccionActiva === 'cuentas' ? 'bg-blue-100 text-blue-600 font-semibold' : 'hover:bg-blue-50'
                  }`}
                >
                  <Layers className='w-5 h-5 text-blue-600' />
                  <span> {t('navigation.linkedAccounts')} </span>
                </button>
              </nav>
            </div>
          </div>
        )}

        {/* main content */}
        <main className='flex-1 flex flex-col items-center text-center p-4 md:p-8 relative'>
          <div className='w-full max-w-screen-lg'>{renderContenido()}</div>
        </main>
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/signUp/registrar/registrarFoto/page.tsx">
'use client';

import { useState } from 'react';
import { Trash2 } from 'lucide-react';
import Image from 'next/image';
import { useRouter } from 'next/navigation';
import { getUserIdFromToken } from '../Registrardecoder/getID';
import NotificationModal from '@/Components/Modal-notifications';

export default function FotoPerfil() {
  const router = useRouter();
  const [archivo, setArchivo] = useState<File | null>(null);
  const [fotoPreview, setFotoPreview] = useState<string | null>(null);
  const [cargando, setCargando] = useState(false);

  const [notification, setNotification] = useState({
    isOpen: false,
    type: 'info' as 'success' | 'error' | 'info' | 'warning',
    title: '',
    message: '',
  });

  const handleNotify = (notif: {
    type: 'success' | 'error' | 'info' | 'warning';
    title: string;
    message: string;
  }) => setNotification({ isOpen: true, ...notif });

  const handleCloseNotification = () => setNotification((prev) => ({ ...prev, isOpen: false }));

  const BASE_URL = `${process.env.NEXT_PUBLIC_API_URL}/api/signUp`;

  const manejarCambio = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setArchivo(file);
      setFotoPreview(URL.createObjectURL(file));
    }
  };

  const eliminarFoto = () => {
    setArchivo(null);
    setFotoPreview(null);
  };

  const continuar = async () => {
    if (!archivo) {
      return handleNotify({
        type: 'error',
        title: 'Foto no seleccionada',
        message: 'Primero selecciona una foto',
      });
    }

    const usuarioId = getUserIdFromToken();
    if (!usuarioId) {
      return handleNotify({
        type: 'error',
        title: 'Usuario no encontrado',
        message: 'No se encontró el ID del usuario',
      });
    }

    try {
      setCargando(true);

      const formData = new FormData();
      formData.append('foto', archivo);
      formData.append('usuarioId', usuarioId);

      const response = await fetch(`${BASE_URL}/registrar/foto`, {
        method: 'PUT',
        body: formData,
      });

      const data = await response.json();

      if (response.ok && data.success) {
        // 🔥 Guardar token actualizado con la foto nueva
        if (data.token) {
          localStorage.setItem('servineo_token', data.token);
        }

        handleNotify({
          type: 'success',
          title: '¡Éxito!',
          message: 'Foto actualizada correctamente',
        });

        setTimeout(() => router.push('/signUp/registrar/registrarUbicacion'), 1000);
      } else {
        handleNotify({
          type: 'error',
          title: 'Error',
          message: data.message || 'Error al subir la foto',
        });
      }
    } catch (error) {
      console.error('Error al subir la foto:', error);
      handleNotify({
        type: 'error',
        title: 'Error de conexión',
        message: 'No se pudo conectar con el servidor',
      });
    } finally {
      setCargando(false);
    }
  };

  return (
    <>
      <NotificationModal
        isOpen={notification.isOpen}
        onClose={handleCloseNotification}
        type={notification.type}
        title={notification.title}
        message={notification.message}
        autoClose
        autoCloseDelay={3000}
      />

      <section className='flex justify-center items-center min-h-screen bg-gradient-to-b from-white to-blue-50 animate-fadeInUp relative'>
        <div className='w-full max-w-sm bg-white/90 backdrop-blur-xl border border-blue-100 rounded-3xl shadow-xl p-10 transition-all duration-300 hover:shadow-2xl hover:scale-[1.01] relative z-10'>
          <h1 className='text-3xl font-bold text-center mb-2 bg-gradient-to-r from-primary/80 to-primary/60 bg-clip-text text-transparent'>
            Foto de perfil
          </h1>
          <p className='text-center text-gray-600 mb-8 text-sm'>Sube una foto para tu perfil</p>

          {/* Imagen */}
          <div className='flex flex-col items-center gap-4'>
            <div className='w-32 h-32 rounded-full overflow-hidden bg-muted border border-blue-100 shadow-lg'>
              {fotoPreview ? (
                <Image
                  src={fotoPreview}
                  alt='Foto de perfil'
                  width={128}
                  height={128}
                  className='w-full h-full object-cover rounded-full'
                />
              ) : (
                <svg
                  className='w-full h-full text-gray-300'
                  fill='currentColor'
                  viewBox='0 0 24 24'
                >
                  <path
                    d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 
                    1.79-4 4 1.79 4 4 4zm0 2c-2.67 
                    0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'
                  />
                </svg>
              )}
            </div>

            <input
              id='input-foto'
              type='file'
              accept='image/*'
              className='hidden'
              onChange={manejarCambio}
            />

            <div className='flex gap-2 mt-3'>
              <label
                htmlFor='input-foto'
                className='px-4 py-2 bg-primary text-primary-foreground rounded-full cursor-pointer hover:opacity-90 transition'
              >
                {fotoPreview ? 'Cambiar foto' : 'Subir foto'}
              </label>

              {fotoPreview && (
                <button
                  onClick={eliminarFoto}
                  className='p-2 bg-red-500 text-white rounded-full hover:opacity-90 transition'
                >
                  <Trash2 size={18} />
                </button>
              )}
            </div>
          </div>

          {/* Botón continuar */}
          <div className='flex justify-center gap-4 mt-10'>
            <button
              onClick={continuar}
              disabled={!archivo || cargando}
              className={`px-5 py-2 rounded-full transition ${
                archivo
                  ? 'bg-primary text-primary-foreground hover:opacity-90'
                  : 'bg-gray-300 text-gray-500 cursor-not-allowed'
              }`}
            >
              {cargando ? 'Subiendo...' : 'Continuar'}
            </button>
          </div>
        </div>
      </section>
    </>
  );
}
</file>

<file path="src/app/[locale]/user-admin/components/chartsSection.tsx">
'use client';
import { useState, useEffect } from 'react';
import { adminAPI } from '../lib/api';
import styles from '../styles/admin.module.css';

interface ChartData {
  _id: { hour?: number; year?: number; month?: number; day?: number };
  count: number;
}

export default function ChartsSection() {
  const [startChartData, setStartChartData] = useState<ChartData[]>([]);
  const [endChartData, setEndChartData] = useState<ChartData[]>([]);
  const [loading, setLoading] = useState(true);
  const [dateRange, setDateRange] = useState({
    start: new Date().toISOString().split('T')[0], // Hoy
    end: new Date().toISOString().split('T')[0], // Hoy
  });

  // Carga inicial. Se desactiva exhaustiveness porque `loadCharts` está definida abajo
   
  useEffect(() => {
    loadCharts();
  }, []);

  const loadCharts = async () => {
    try {
      const token = localStorage.getItem('adminToken');
      if (!token) return;

      setLoading(true);

      // Cargar ambos gráficos en paralelo
      const [startData, endData] = await Promise.all([
        adminAPI.getSessionStartChart(token, dateRange.start, dateRange.end),
        adminAPI.getSessionEndChart(token, dateRange.start, dateRange.end),
      ]);

      if (startData.success) setStartChartData(startData.data);
      if (endData.success) setEndChartData(endData.data);
    } catch (error) {
      console.error('Error loading charts:', error);
    } finally {
      setLoading(false);
    }
  };

  const formatChartLabel = (item: ChartData) => {
    if (item._id.hour !== undefined) {
      return `${item._id.hour}:00`;
    } else {
      return `${item._id.day}/${item._id.month}/${item._id.year}`;
    }
  };

  return (
    <div className={styles.chartsSection}>
      <div className={styles.chartsHeader}>
        <h3>📈 Gráficos de Sesiones</h3>
        <div className={styles.dateControls}>
          <input
            type='date'
            value={dateRange.start}
            onChange={(e) => setDateRange({ ...dateRange, start: e.target.value })}
          />
          <span>a</span>
          <input
            type='date'
            value={dateRange.end}
            onChange={(e) => setDateRange({ ...dateRange, end: e.target.value })}
          />
          <button onClick={loadCharts}>Actualizar</button>
        </div>
      </div>

      {loading ? (
        <div className={styles.loading}>Cargando gráficos...</div>
      ) : (
        <div className={styles.chartsGrid}>
          <div className={styles.chartCard}>
            <h4>Inicios de Sesión</h4>
            <div className={styles.chartData}>
              {startChartData.length > 0 ? (
                startChartData.map((item, index) => (
                  <div key={index} className={styles.chartBar}>
                    <div className={styles.barLabel}>{formatChartLabel(item)}</div>
                    <div
                      className={styles.barValue}
                      style={{ width: `${Math.min(item.count * 5, 100)}%` }}
                    >
                      <span>{item.count}</span>
                    </div>
                  </div>
                ))
              ) : (
                <p>No hay datos para este rango</p>
              )}
            </div>
            <div className={styles.chartStats}>
              <span>Total: {startChartData.reduce((sum, item) => sum + item.count, 0)}</span>
            </div>
          </div>

          <div className={styles.chartCard}>
            <h4>Cierres de Sesión</h4>
            <div className={styles.chartData}>
              {endChartData.length > 0 ? (
                endChartData.map((item, index) => (
                  <div key={index} className={styles.chartBar}>
                    <div className={styles.barLabel}>{formatChartLabel(item)}</div>
                    <div
                      className={styles.barValue}
                      style={{ width: `${Math.min(item.count * 5, 100)}%` }}
                    >
                      <span>{item.count}</span>
                    </div>
                  </div>
                ))
              ) : (
                <p>No hay datos para este rango</p>
              )}
            </div>
            <div className={styles.chartStats}>
              <span>Total: {endChartData.reduce((sum, item) => sum + item.count, 0)}</span>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/app/lib/constants/sortOptions.ts">
export const SORT_OPTIONS = {
  DESTACADOS: 'rating',
  RECIENTES: 'recent',
  ANTIGUOS: 'oldest',
  NOMBRE_ASC: 'name_asc',
  NOMBRE_DESC: 'name_desc',
  CONTACTO_ASC: 'contact_asc',
  CONTACTO_DESC: 'contact_desc',
} as const;

export const SORT_TRANSLATION_KEYS = {
  rating: 'sortBy.featured',
  recent: 'sortBy.mostRecent',
  oldest: 'sortBy.oldest',
  name_asc: 'sortBy.nameAZ',
  name_desc: 'sortBy.nameZA',
  contact_asc: 'sortBy.contactAsc',
  contact_desc: 'sortBy.contactDesc',
} as const;

export const sortMap: Record<string, string> = {
  Destacados: SORT_OPTIONS.DESTACADOS,
  'Los más recientes': SORT_OPTIONS.RECIENTES,
  'Los más antiguos': SORT_OPTIONS.ANTIGUOS,
  'Nombre A-Z': SORT_OPTIONS.NOMBRE_ASC,
  'Nombre Z-A': SORT_OPTIONS.NOMBRE_DESC,
  'Num de contacto asc': SORT_OPTIONS.CONTACTO_ASC,
  'Num de contacto desc': SORT_OPTIONS.CONTACTO_DESC,
};

export const sortMapInverse: Record<string, string> = Object.fromEntries(
  Object.entries(sortMap).map(([key, value]) => [value, key]),
);

export const getSortValue = (backendValue: string): string => {
  return backendValue || SORT_OPTIONS.RECIENTES;
};
// funcion helper 
export const getSortDisplayName = (backendValue: string): string => {
  return sortMapInverse[backendValue] || 'Los más recientes';
};
</file>

<file path="src/app/lib/utils/translate/dictionary.ts">
// src/app/services/translation/dictionary.service.ts

// Diccionario extenso de términos comunes en búsquedas de trabajos
const translationDictionary: { [key: string]: { en: string; es: string } } = {
  // Profesiones/Oficios - TODOS en minúscula
  electricista: { en: 'electrician', es: 'electricista' },
  electrician: { en: 'electrician', es: 'electricista' }, // ⭐ INVERSA
  plomero: { en: 'plumber', es: 'plomero' },
  plomeros: { en: 'plumbers', es: 'plomeros' },
  plumber: { en: 'plumber', es: 'plomero' }, // ⭐ INVERSA
  plumbers: { en: 'plumbers', es: 'plomeros' },
  fontanero: { en: 'plumber', es: 'fontanero' },
  gasfitero: { en: 'plumber', es: 'gasfitero' },
  plomeria: { en: 'plumbing', es: 'plomeria' },
  plumbing: { en: 'plumbing', es: 'plomeria' }, // ⭐ INVERSA
  carpintero: { en: 'carpenter', es: 'carpintero' },
  carpenter: { en: 'carpenter', es: 'carpintero' }, // ⭐ INVERSA
  carpintería: { en: 'carpentry', es: 'carpintería' },
  carpentry: { en: 'carpentry', es: 'carpintería' }, // ⭐ INVERSA
  especializado: { en: 'specialized', es: 'especializado' },
  specialized: { en: 'specialized', es: 'especializado' }, // ⭐ INVERSA
  pintor: { en: 'painter', es: 'pintor' },
  painter: { en: 'painter', es: 'pintor' }, // ⭐ INVERSA
  albañil: { en: 'mason', es: 'albañil' },
  mason: { en: 'mason', es: 'albañil' }, // ⭐ INVERSA
  jardinero: { en: 'gardener', es: 'jardinero' },
  gardener: { en: 'gardener', es: 'jardinero' }, // ⭐ INVERSA
  mecánico: { en: 'mechanic', es: 'mecánico' },
  mechanic: { en: 'mechanic', es: 'mecánico' }, // ⭐ INVERSA
  cerrajero: { en: 'locksmith', es: 'cerrajero' },
  locksmith: { en: 'locksmith', es: 'cerrajero' }, // ⭐ INVERSA
  técnico: { en: 'technician', es: 'técnico' },
  technician: { en: 'technician', es: 'técnico' }, // ⭐ INVERSA
  reparación: { en: 'repair', es: 'reparación' },
  repair: { en: 'repair', es: 'reparación' }, // ⭐ INVERSA
  instalación: { en: 'installation', es: 'instalación' },
  installation: { en: 'installation', es: 'instalación' }, // ⭐ INVERSA
  mantenimiento: { en: 'maintenance', es: 'mantenimiento' },
  maintenance: { en: 'maintenance', es: 'mantenimiento' }, // ⭐ INVERSA

  // Electrodomésticos y tecnología
  electrodomésticos: { en: 'appliances', es: 'electrodomésticos' },
  appliances: { en: 'appliances', es: 'electrodomésticos' }, // ⭐ INVERSA
  refrigerador: { en: 'refrigerator', es: 'refrigerador' },
  refrigerator: { en: 'refrigerator', es: 'refrigerador' }, // ⭐ INVERSA
  lavadora: { en: 'washing machine', es: 'lavadora' },
  'washing machine': { en: 'washing machine', es: 'lavadora' }, // ⭐ INVERSA
  secadora: { en: 'dryer', es: 'secadora' },
  dryer: { en: 'dryer', es: 'secadora' }, // ⭐ INVERSA
  televisor: { en: 'television', es: 'televisor' },
  television: { en: 'television', es: 'televisor' }, // ⭐ INVERSA
  computadora: { en: 'computer', es: 'computadora' },
  computer: { en: 'computer', es: 'computadora' }, // ⭐ INVERSA
  celular: { en: 'cell phone', es: 'celular' },
  'cell phone': { en: 'cell phone', es: 'celular' }, // ⭐ INVERSA
  tablet: { en: 'tablet', es: 'tablet' },
  // Nuevas palabras para agregar al diccionario

techero: { en: 'roofer', es: 'techero' },

mecanico: { en: 'mechanic', es: 'mecanico' },

muros: { en: 'walls', es: 'muros' },
walls: { en: 'walls', es: 'muros' },

negocio: { en: 'business', es: 'negocio' },
business: { en: 'business', es: 'negocio' },

experiencia: { en: 'experience', es: 'experiencia' },
experience: { en: 'experience', es: 'experiencia' },

tecnica: { en: 'technique', es: 'tecnica' },
técnica: { en: 'technique', es: 'técnica' },
technique: { en: 'technique', es: 'tecnica' },

trabajos: { en: 'jobs', es: 'trabajos' },
jobs: { en: 'jobs', es: 'trabajos' },

avanzado: { en: 'advanced', es: 'avanzado' },
advanced: { en: 'advanced', es: 'avanzado' },

hogares: { en: 'homes', es: 'hogares' },
homes: { en: 'homes', es: 'hogares' },

consulta: { en: 'consultation', es: 'consulta' },
consultation: { en: 'consultation', es: 'consulta' },

paredes: { en: 'walls', es: 'paredes' },

electrodomesticos: { en: 'appliances', es: 'electrodomesticos' },

potosi: { en: 'potosi', es: 'potosi' },

tecnico: { en: 'technician', es: 'tecnico' },

tuberia: { en: 'pipe', es: 'tuberia' },
tubería: { en: 'pipe', es: 'tubería' },
pipe: { en: 'pipe', es: 'tuberia' },

reparador: { en: 'repairman', es: 'reparador' },
repairman: { en: 'repairman', es: 'reparador' },

latinoamerica: { en: 'latin america', es: 'latinoamerica' },
latinoamérica: { en: 'latin america', es: 'latinoamérica' },
'latin america': { en: 'latin america', es: 'latinoamerica' },

garaje: { en: 'garage', es: 'garaje' },
garage: { en: 'garage', es: 'garaje' },

cochera: { en: 'garage', es: 'cochera' },

velero: { en: 'sailboat', es: 'velero' },
sailboat: { en: 'sailboat', es: 'velero' },

vasos: { en: 'glasses', es: 'vasos' },
glasses: { en: 'glasses', es: 'vasos' },

maestro: { en: 'master', es: 'maestro' },
master: { en: 'master', es: 'maestro' },

chambeador: { en: 'worker', es: 'chambeador' },
worker: { en: 'worker', es: 'chambeador' },

guante: { en: 'glove', es: 'guante' },
glove: { en: 'glove', es: 'guante' },

manopla: { en: 'mitten', es: 'manopla' },
mitten: { en: 'mitten', es: 'manopla' },

mañana: { en: 'tomorrow', es: 'mañana' },
tomorrow: { en: 'tomorrow', es: 'mañana' },

diablo: { en: 'devil', es: 'diablo' },
devil: { en: 'devil', es: 'diablo' },

electrico: { en: 'electric', es: 'electrico' },
eléctrico: { en: 'electric', es: 'eléctrico' },

bateria: { en: 'battery', es: 'bateria' },
batería: { en: 'battery', es: 'batería' },
battery: { en: 'battery', es: 'bateria' },

horno: { en: 'oven', es: 'horno' },
oven: { en: 'oven', es: 'horno' },

pan: { en: 'bread', es: 'pan' },
bread: { en: 'bread', es: 'pan' },

piña: { en: 'pineapple', es: 'piña' },
pineapple: { en: 'pineapple', es: 'piña' },

copa: { en: 'cup', es: 'copa' },
cup: { en: 'cup', es: 'copa' },

cañon: { en: 'canyon', es: 'cañon' },
cañón: { en: 'canyon', es: 'cañón' },
canyon: { en: 'canyon', es: 'cañon' },

mapa: { en: 'map', es: 'mapa' },
map: { en: 'map', es: 'mapa' },

vuelo: { en: 'flight', es: 'vuelo' },
flight: { en: 'flight', es: 'vuelo' },

vidrieria: { en: 'glasswork', es: 'vidrieria' },
vidrería: { en: 'glasswork', es: 'vidrería' },
glasswork: { en: 'glasswork', es: 'vidrieria' },

texturas: { en: 'textures', es: 'texturas' },
textures: { en: 'textures', es: 'texturas' },

blanco: { en: 'white', es: 'blanco' },
white: { en: 'white', es: 'blanco' },

mesero: { en: 'waiter', es: 'mesero' },
waiter: { en: 'waiter', es: 'mesero' },

ingeniero: { en: 'engineer', es: 'ingeniero' },
engineer: { en: 'engineer', es: 'ingeniero' },

sanista: { en: 'plumber', es: 'sanista' },

repara: { en: 'repairs', es: 'repara' },
repairs: { en: 'repairs', es: 'repara' },

soleado: { en: 'sunny', es: 'soleado' },
sunny: { en: 'sunny', es: 'soleado' },

calor: { en: 'heat', es: 'calor' },
heat: { en: 'heat', es: 'calor' },

frio: { en: 'cold', es: 'frio' },
frío: { en: 'cold', es: 'frío' },
cold: { en: 'cold', es: 'frio' },

japon: { en: 'japan', es: 'japon' },
japón: { en: 'japan', es: 'japón' },
japan: { en: 'japan', es: 'japon' },

papa: { en: 'potato', es: 'papa' },
potato: { en: 'potato', es: 'papa' },

jamon: { en: 'ham', es: 'jamon' },
jamón: { en: 'ham', es: 'jamón' },
ham: { en: 'ham', es: 'jamon' },

cometa: { en: 'kite', es: 'cometa' },
kite: { en: 'kite', es: 'cometa' },

poder: { en: 'power', es: 'poder' },
power: { en: 'power', es: 'poder' },

techista: { en: 'roofer', es: 'techista' },

fallo: { en: 'failure', es: 'fallo' },
failure: { en: 'failure', es: 'fallo' },

nadie: { en: 'nobody', es: 'nadie' },
nobody: { en: 'nobody', es: 'nadie' },

cine: { en: 'cinema', es: 'cine' },
cinema: { en: 'cinema', es: 'cine' },

accion: { en: 'action', es: 'accion' },
acción: { en: 'action', es: 'acción' },
action: { en: 'action', es: 'accion' },

pais: { en: 'country', es: 'pais' },
país: { en: 'country', es: 'país' },
country: { en: 'country', es: 'pais' },

minero: { en: 'miner', es: 'minero' },
miner: { en: 'miner', es: 'minero' },

valor: { en: 'value', es: 'valor' },
value: { en: 'value', es: 'valor' },

dinero: { en: 'money', es: 'dinero' },
money: { en: 'money', es: 'dinero' },

vidrios: { en: 'glass', es: 'vidrios' },

cuento: { en: 'story', es: 'cuento' },
story: { en: 'story', es: 'cuento' },

desagüe: { en: 'drain', es: 'desagüe' },
desague: { en: 'drain', es: 'desague' },
drain: { en: 'drain', es: 'desagüe' },

cuartos: { en: 'rooms', es: 'cuartos' },
rooms: { en: 'rooms', es: 'cuartos' },

clean: { en: 'clean', es: 'limpio' },
limpio: { en: 'clean', es: 'limpio' },

diseño: { en: 'design', es: 'diseño' },
design: { en: 'design', es: 'diseño' },

glassworker: { en: 'glassworker', es: 'vidriero' },

cerrajeria: { en: 'locksmithing', es: 'cerrajeria' },
cerrajería: { en: 'locksmithing', es: 'cerrajería' },
locksmithing: { en: 'locksmithing', es: 'cerrajeria' },

pisos: { en: 'floors', es: 'pisos' },
floors: { en: 'floors', es: 'pisos' },

luces: { en: 'lights', es: 'luces' },
lights: { en: 'lights', es: 'luces' },

extensiones: { en: 'extensions', es: 'extensiones' },
extensions: { en: 'extensions', es: 'extensiones' },

paneles: { en: 'panels', es: 'paneles' },
panels: { en: 'panels', es: 'paneles' },

terreno: { en: 'land', es: 'terreno' },
land: { en: 'land', es: 'terreno' },

terrenos: { en: 'lands', es: 'terrenos' },
lands: { en: 'lands', es: 'terrenos' },

musica: { en: 'music', es: 'musica' },
música: { en: 'music', es: 'música' },
music: { en: 'music', es: 'musica' },

plantas: { en: 'plants', es: 'plantas' },
plants: { en: 'plants', es: 'plantas' },

reparaciones: { en: 'repairs', es: 'reparaciones' },

manejo: { en: 'handling', es: 'manejo' },
handling: { en: 'handling', es: 'manejo' },

bienvenido: { en: 'welcome', es: 'bienvenido' },
welcome: { en: 'welcome', es: 'bienvenido' },

automaticos: { en: 'automatic', es: 'automaticos' },

hormigon: { en: 'concrete', es: 'hormigon' },

baño: { en: 'bathroom', es: 'baño' },
bathroom: { en: 'bathroom', es: 'baño' },

cable: { en: 'cable', es: 'cable' },

fonteneria: { en: 'plumbing', es: 'fonteneria' },
fontanería: { en: 'plumbing', es: 'fontanería' },

techos: { en: 'roofs', es: 'techos' },
roofs: { en: 'roofs', es: 'techos' },

levantamiento: { en: 'survey', es: 'levantamiento' },
survey: { en: 'survey', es: 'levantamiento' },

dinamica: { en: 'dynamic', es: 'dinamica' },
dinámica: { en: 'dynamic', es: 'dinámica' },
dynamic: { en: 'dynamic', es: 'dinamica' },

muebles: { en: 'furniture', es: 'muebles' },
furniture: { en: 'furniture', es: 'muebles' },

interiores: { en: 'interiors', es: 'interiores' },
interiors: { en: 'interiors', es: 'interiores' },

prueba: { en: 'test', es: 'prueba' },
test: { en: 'test', es: 'prueba' },

ruido: { en: 'noise', es: 'ruido' },
noise: { en: 'noise', es: 'ruido' },

instalaciones: { en: 'facilities', es: 'instalaciones' },
facilities: { en: 'facilities', es: 'instalaciones' },

gamer: { en: 'gamer', es: 'gamer' },

filtro: { en: 'filter', es: 'filtro' },
filter: { en: 'filter', es: 'filtro' },

pintores: { en: 'painters', es: 'pintores' },
painters: { en: 'painters', es: 'pintores' },

linux: { en: 'linux', es: 'linux' },

cesped: { en: 'lawn', es: 'cesped' },
césped: { en: 'lawn', es: 'césped' },
lawn: { en: 'lawn', es: 'cesped' },

jardineria: { en: 'gardening', es: 'jardineria' },

carpinteria: { en: 'carpentry', es: 'carpinteria' },

patineta: { en: 'skateboard', es: 'patineta' },
skateboard: { en: 'skateboard', es: 'patineta' },

techeria: { en: 'roofing', es: 'techeria' },
techería: { en: 'roofing', es: 'techería' },
roofing: { en: 'roofing', es: 'techeria' },

pulidor: { en: 'polisher', es: 'pulidor' },
polisher: { en: 'polisher', es: 'pulidor' },

flores: { en: 'flowers', es: 'flores' },
flowers: { en: 'flowers', es: 'flores' },

puertas: { en: 'doors', es: 'puertas' },
doors: { en: 'doors', es: 'puertas' },

auto: { en: 'car', es: 'auto' },

poda: { en: 'pruning', es: 'poda' },
pruning: { en: 'pruning', es: 'poda' },

carpiteria: { en: 'carpentry', es: 'carpiteria' },

tarija: { en: 'tarija', es: 'tarija' },

constructor: { en: 'builder', es: 'constructor' },
builder: { en: 'builder', es: 'constructor' },

casas: { en: 'houses', es: 'casas' },
houses: { en: 'houses', es: 'casas' },
  // Servicios del hogar
  limpieza: { en: 'cleaning', es: 'limpieza' },
  cleaning: { en: 'cleaning', es: 'limpieza' }, // ⭐ INVERSA
  jardinería: { en: 'gardening', es: 'jardinería' },
  gardening: { en: 'gardening', es: 'jardinería' }, // ⭐ INVERSA
  pintura: { en: 'painting', es: 'pintura' },
  painting: { en: 'painting', es: 'pintura' }, // ⭐ INVERSA
  construcción: { en: 'construction', es: 'construcción' },
  construction: { en: 'construction', es: 'construcción' }, // ⭐ INVERSA
  reformas: { en: 'renovations', es: 'reformas' },
  renovations: { en: 'renovations', es: 'reformas' }, // ⭐ INVERSA
  remodelación: { en: 'remodeling', es: 'remodelación' },
  remodeling: { en: 'remodeling', es: 'remodelación' }, // ⭐ INVERSA

  // Términos de búsqueda comunes
  casa: { en: 'house', es: 'casa' },
  house: { en: 'house', es: 'casa' }, // ⭐ INVERSA
  apartamento: { en: 'apartment', es: 'apartamento' },
  apartment: { en: 'apartment', es: 'apartamento' }, // ⭐ INVERSA
  oficina: { en: 'office', es: 'oficina' },
  office: { en: 'office', es: 'oficina' }, // ⭐ INVERSA
  local: { en: 'premises', es: 'local' },
  premises: { en: 'premises', es: 'local' }, // ⭐ INVERSA
  emergencia: { en: 'emergency', es: 'emergencia' },
  emergency: { en: 'emergency', es: 'emergencia' }, // ⭐ INVERSA
  urgente: { en: 'urgent', es: 'urgente' },
  urgent: { en: 'urgent', es: 'urgente' }, // ⭐ INVERSA
  profesional: { en: 'professional', es: 'profesional' },
  professional: { en: 'professional', es: 'profesional' }, // ⭐ INVERSA
  calificado: { en: 'qualified', es: 'calificado' },
  qualified: { en: 'qualified', es: 'calificado' }, // ⭐ INVERSA
  experto: { en: 'expert', es: 'experto' },
  expert: { en: 'expert', es: 'experto' }, // ⭐ INVERSA

  // Términos técnicos
  electrical: { en: 'electrical', es: 'eléctrico' }, // ⭐ INVERSA
  hidráulico: { en: 'hydraulic', es: 'hidráulico' },
  hydraulic: { en: 'hydraulic', es: 'hidráulico' }, // ⭐ INVERSA
  sanitario: { en: 'sanitary', es: 'sanitario' },
  sanitary: { en: 'sanitary', es: 'sanitario' }, // ⭐ INVERSA
  estructura: { en: 'structure', es: 'estructura' },
  structure: { en: 'structure', es: 'estructura' }, // ⭐ INVERSA
  cimientos: { en: 'foundations', es: 'cimientos' },
  foundations: { en: 'foundations', es: 'cimientos' }, // ⭐ INVERSA

  // Términos generales
  presupuesto: { en: 'budget', es: 'presupuesto' },
  budget: { en: 'budget', es: 'presupuesto' }, // ⭐ INVERSA
  cotización: { en: 'quote', es: 'cotización' },
  quote: { en: 'quote', es: 'cotización' }, // ⭐ INVERSA
  garantía: { en: 'warranty', es: 'garantía' },
  warranty: { en: 'warranty', es: 'garantía' }, // ⭐ INVERSA
  calidad: { en: 'quality', es: 'calidad' },
  quality: { en: 'quality', es: 'calidad' }, // ⭐ INVERSA
  servicio: { en: 'service', es: 'servicio' },
  service: { en: 'service', es: 'servicio' }, // ⭐ INVERSA

  // Términos específicos
  car: { en: 'car', es: 'car' },
  carp: { en: 'carp', es: 'carp' },
  carlo: { en: 'carlo', es: 'carlo' },
  carlos: { en: 'carlos', es: 'carlos' },
  electric: { en: 'electric', es: 'electric' },
  elec: { en: 'elec', es: 'elec' },
  electronic: { en: 'electronic', es: 'electronic' },
  electronics: { en: 'electronics', es: 'electronics' },
  en: { en: 'on', es: 'en' },
  on: { en: 'on', es: 'en' }, // ⭐ INVERSA
  de: { en: 'the', es: 'de' },
  the: { en: 'the', es: 'de' }, // ⭐ INVERSA (cuidado con esto)
  canaletas: { en: 'gutters', es: 'canaletas' },
  gutters: { en: 'gutters', es: 'canaletas' }, // ⭐ INVERSA
  automatico: { en: 'automatic', es: 'automatico' },
  automatic: { en: 'automatic', es: 'automatico' }, // ⭐ INVERSA
  automáticos: { en: 'automatics', es: 'automatico' },
  automatics: { en: 'automatics', es: 'automatico' }, // ⭐ INVERSA
  hogar: { en: 'house', es: 'hogar' },
  hola: { en: 'hello', es: 'hola' },
  hello: { en: 'hello', es: 'hola' }, // ⭐ INVERSA
  hormigón: { en: 'concrete', es: 'hormigon' },
  concrete: { en: 'concrete', es: 'hormigon' },
  bricklayer: { en: 'bricklayer', es: 'albañil' },

  techador: { en: 'roofer', es: 'techador' },
  roofer: { en: 'roofer', es: 'techador' },

  yesero: { en: 'plasterer', es: 'yesero' },
  plasterer: { en: 'plasterer', es: 'yesero' },

  vidriero: { en: 'glazier', es: 'vidriero' },
  glazier: { en: 'glazier', es: 'vidriero' },

  soldador: { en: 'welder', es: 'soldador' },
  welder: { en: 'welder', es: 'soldador' },

  gasista: { en: 'gas fitter', es: 'gasista' },
  'gas fitter': { en: 'gas fitter', es: 'gasista' },

  decorador: { en: 'decorator', es: 'decorador' },
  decorator: { en: 'decorator', es: 'decorador' },

  limpiador: { en: 'cleaner', es: 'limpiador' },
  cleaner: { en: 'cleaner', es: 'limpiador' },

  desarrollador: { en: 'developer', es: 'desarrollador' },
  developer: { en: 'developer', es: 'desarrollador' },

  chofer: { en: 'driver', es: 'chofer' },
  driver: { en: 'driver', es: 'chofer' },

  profesor: { en: 'teacher', es: 'profesor' },
  teacher: { en: 'teacher', es: 'profesor' },

  'ingeniero civil': { en: 'civil engineer', es: 'ingeniero civil' },
  'civil engineer': { en: 'civil engineer', es: 'ingeniero civil' },

  // ======= AMBIENTES =======
  home: { en: 'home', es: 'hogar' },

  negocios: { en: 'businesses', es: 'negocios' },
  businesses: { en: 'businesses', es: 'negocios' },

  obras: { en: 'works', es: 'obras' },
  works: { en: 'works', es: 'obras' },

  remodelaciones: { en: 'remodeling', es: 'remodelaciones' },

  muro: { en: 'wall', es: 'muro' },
  wall: { en: 'wall', es: 'muro' },

  exterior: { en: 'exterior', es: 'exterior' },
  interior: { en: 'interior', es: 'interior' },

  agua: { en: 'water', es: 'agua' },
  water: { en: 'water', es: 'agua' },

  electricidad: { en: 'electricity', es: 'electricidad' },
  electricity: { en: 'electricity', es: 'electricidad' },

  madera: { en: 'wood', es: 'madera' },
  wood: { en: 'wood', es: 'madera' },

  metal: { en: 'metal', es: 'metal' },

  piso: { en: 'floor', es: 'piso' },
  floor: { en: 'floor', es: 'piso' },

  techo: { en: 'roof', es: 'techo' },
  roof: { en: 'roof', es: 'techo' },

  ventana: { en: 'window', es: 'ventana' },
  window: { en: 'window', es: 'ventana' },

  puerta: { en: 'door', es: 'puerta' },
  door: { en: 'door', es: 'puerta' },

  ducha: { en: 'shower', es: 'ducha' },
  shower: { en: 'shower', es: 'ducha' },

  parrillas: { en: 'grills', es: 'parrillas' },
  grills: { en: 'grills', es: 'parrillas' },

  hornos: { en: 'ovens', es: 'hornos' },
  ovens: { en: 'ovens', es: 'hornos' },

  // ======= PALABRAS GENERALES =======
  trabajo: { en: 'job', es: 'trabajo' },
  adiós: { en: 'goodbye', es: 'adiós' },
  goodbye: { en: 'goodbye', es: 'adiós' },
  buenas: { en: 'hello', es: 'buenas' },

  // ======= LUGARES (NO SE TRADUCEN) =======
  cochabamba: { en: 'cochabamba', es: 'cochabamba' },
  'la paz': { en: 'la paz', es: 'la paz' },
  'santa cruz': { en: 'santa cruz', es: 'santa cruz' },
  oruro: { en: 'oruro', es: 'oruro' },
  potosí: { en: 'potosí', es: 'potosí' },
  beni: { en: 'beni', es: 'beni' },
  pando: { en: 'pando', es: 'pando' },
  chuquisaca: { en: 'chuquisaca', es: 'chuquisaca' },
  perú: { en: 'peru', es: 'perú' },
};

function preserveCapitalization(original: string, translation: string): string {
  if (original === original.toUpperCase()) {
    return translation.toUpperCase();
  } else if (original[0] === original[0].toUpperCase()) {
    return translation.charAt(0).toUpperCase() + translation.slice(1);
  } else {
    return translation;
  }
}

/**
 * Traduce un array de sugerencias usando el diccionario
 */
export function translateSuggestions(suggestions: string[], targetLang: 'en' | 'es'): string[] {
  if (suggestions.length === 0) {
    return suggestions;
  }

  console.log(`🔍 Translating ${suggestions.length} suggestions to ${targetLang}`);
  console.log(`🔍 Original suggestions:`, suggestions);

  const translated = suggestions.map((suggestion) =>
    translateWithDictionary(suggestion, targetLang),
  );

  console.log(`🔍 Translated suggestions:`, translated);
  return translated;
}

/**
 * Traduce un texto individual usando el diccionario
 */
export function translateWithDictionary(text: string, targetLang: 'en' | 'es'): string {
  console.log(`🔍 Attempting to translate: "${text}" to ${targetLang}`);

  const normalizedText = text.toLowerCase().trim();

  // 1. Búsqueda EXACTA
  const exactKey = Object.keys(translationDictionary).find(
    (key) => key.toLowerCase() === normalizedText,
  );

  if (exactKey) {
    const translation = translationDictionary[exactKey][targetLang];
    console.log(`✅ Exact dictionary match: "${text}" -> "${translation}"`);
    return preserveCapitalization(text, translation);
  }

  console.log(`❌ No exact match for: "${text}" (normalized: "${normalizedText}")`);

  // 2. Búsqueda por PALABRAS CONTENIDAS
  let translatedText = text;
  let foundAnyMatch = false;

  const sortedKeys = Object.keys(translationDictionary).sort((a, b) => b.length - a.length);

  for (const dictKey of sortedKeys) {
    const regex = new RegExp(`\\b${dictKey}\\b`, 'gi');
    if (regex.test(text)) {
      foundAnyMatch = true;
      translatedText = translatedText.replace(regex, (match) => {
        const translation = translationDictionary[dictKey][targetLang];
        console.log(`🔄 Partial match: "${match}" -> "${translation}" in "${text}"`);
        return preserveCapitalization(match, translation);
      });
    }
  }

  if (foundAnyMatch) {
    console.log(`✅ Final translated: "${text}" -> "${translatedText}"`);
    return translatedText;
  }

  console.log(`❌ No dictionary translation for: "${text}"`);
  return text;
}
</file>

<file path="src/app/lib/validations/Job-offer-Schemas.ts">
import { z } from 'zod';

// === 1. ESQUEMA DE VALIDACIÓN (Formulario) ===
// Validamos solo lo que el usuario escribe. Las imágenes se validan aparte en el componente.
export const jobOfferSchema = z.object({
  title: z
    .string()
    .min(5, { message: 'El título debe tener al menos 5 caracteres' })
    .max(80, { message: 'El título es muy largo' }),
  description: z
    .string()
    .min(20, { message: 'La descripción debe ser detallada (mínimo 20 letras)' }),
  category: z.string().min(1, { message: 'Selecciona una categoría válida' }),
  price: z.coerce.number().positive({ message: 'El precio debe ser mayor a 0' }),
  city: z.string().min(1, { message: 'Selecciona una ciudad' }),
  contactPhone: z
    .string()
    .regex(/^[0-9+ ]{8,15}$/, { message: 'Ingresa un número de teléfono válido' }),
  tags: z
    .array(z.string())
    .min(1, { message: 'Debes agregar al menos una etiqueta' })
    .max(5, { message: 'Máximo 5 etiquetas' }),
});

export const certificationSchema = z.object({
  name: z.string().min(3, { message: 'El nombre debe tener al menos 3 caracteres' }),
  institution: z.string().min(2, { message: 'La institución es requerida' }),
  issueDate: z.string().refine((val) => !isNaN(Date.parse(val)), { message: 'Fecha inválida' }),
  expiryDate: z.string().optional(), // Puede no tener vencimiento
  credentialId: z.string().optional(),
  credentialUrl: z
    .string()
    .url({ message: 'Debe ser una URL válida (https://...)' })
    .optional()
    .or(z.literal('')),
});

// Tipo inferido para usar en useForm
export type JobOfferFormData = z.infer<typeof jobOfferSchema>;
export type CertificationFormData = z.infer<typeof certificationSchema>;

// esto no deveria esta aqui lo vamos a cambiar
// === 2. INTERFAZ DE RESPUESTA DE LA API (Backend Mongoose) ===
// Esta interfaz coincide con el JSON que mostraste anteriormente
export interface IJobOffer {
  _id: string;
  fixerId: string;
  fixerName: string;
  title: string;
  description: string;
  category: string;
  tags: string[];
  price: number;
  city: string;
  contactPhone: string;
  photos: string[]; // URLs que vienen del back
  rating: number;
  createdAt: string;
  updatedAt: string;
  __v?: number;
}

// para no crear varios archivos aqui creare para las offertas su category

export const jobCategories = [
  { value: 'Albañil', label: 'Albañil' },
  { value: 'Electricista', label: 'Electricista' },
  { value: 'Fontanero', label: 'Fontanero' },
  { value: 'Carpintero', label: 'Carpintero' },
  { value: 'Pintor', label: 'Pintor' },
  { value: 'Jardinero', label: 'Jardinería' },
  { value: 'Vidriero', label: 'Vidriero' },
  { value: 'Yesero', label: 'Yesero' },
  { value: 'Decorador', label: 'Decorador' },
  { value: 'Techador', label: 'Techador' },
  { value: 'Pulidor', label: 'Pulidor' },
  { value: 'Cerrajero', label: 'Cerrajero' },
  { value: 'soldador', label: 'Soldador' },
  //si van a umentar mas sacar del modelo offfer.model.ts
];

export const boliviaCities = [{ value: 'Cochabamba', label: 'Cochabamba' }];
</file>

<file path="src/app/Mapa/FixerMaker.tsx">
'use client';

import { Marker, Popup, Tooltip } from 'react-leaflet';
import L from 'leaflet';
import Image from 'next/image';
import { Fixer } from '@/Components/interface/Fixer_Interface';
import { getServiceStyle } from '@/app/Mapa/serviceStyles';
import { useRouter } from 'next/navigation';

interface FixerMarkerProps {
  fixer: Fixer;
}

const palette = {
  popupBg: '#FFFFFF',
  popupShadow: '0 6px 18px rgba(0,0,0,0.2)',
  buttonBg: '#2B6AE0',       // color principal para ambos botones
  buttonHover: '#3B7BDD',    // hover para ambos botones
  buttonText: '#FFFFFF',
  iconBorderBusy: '#ff4444',
  textColor: '#2B6AE0',
};

// Estilos reutilizables
const popupTextStyle = {
  fontFamily: "'Roboto', sans-serif",
  fontWeight: 600,
  textAlign: 'center' as const,
};

export default function FixerMarker({ fixer }: FixerMarkerProps) {
  const router = useRouter();
  const style = getServiceStyle(fixer.servicio);

  // Marker personalizado con divIcon
  const icon = L.divIcon({
    className: 'custom-marker',
    html: `
      <div style="
        width: 50px;
        height: 50px;
        border-radius: 8%;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        overflow: hidden;
        border: 0px solid ${fixer.available ? style.color : palette.iconBorderBusy};
        ${fixer.available ? '' : 'opacity:0.7;'}
      ">
        <img src="${style.iconUrl}"
             style="
               width:46px;
               height:46px;
               border-radius:50%;
               object-fit:cover;
               border: 3.5px solid ${fixer.available ? style.color : palette.iconBorderBusy};
             " />
      </div>
    `,
    iconSize: [50, 50],
    iconAnchor: [25, 50],
    popupAnchor: [0, -50],
  });

  return (
    <Marker position={[fixer.lat, fixer.lng]} icon={icon}>
      {/* Tooltip */}
      <Tooltip direction='top' offset={[0, -25]} opacity={1} permanent={false}>
        <div
          style={{
            ...popupTextStyle,
            padding: '6px 12px',
            borderRadius: '14px',
            backgroundColor: palette.popupBg,
            boxShadow: palette.popupShadow,
            minWidth: '140px',
            color: palette.textColor,
            fontSize: '13px',
          }}
        >
          <div>{fixer.servicio}</div>
          <div style={{ fontSize: '12px', marginTop: '2px' }}>
            {fixer.nombre} - {fixer.available ? 'Disponible' : 'No disponible'}
          </div>
        </div>
      </Tooltip>

      {/* Popup */}
      <Popup closeButton autoClose={false}>
        <div
          style={{
            padding: '16px 20px',
            borderRadius: '22px',
            backgroundColor: palette.popupBg,
            boxShadow: palette.popupShadow,
            minWidth: '240px',
            fontFamily: "'Roboto', sans-serif",
          }}
        >
          <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
            {/* Imagen optimizada con next/image */}
            <Image
              src={style.iconUrl}
              alt={`${fixer.nombre} avatar`}
              width={46}
              height={46}
              style={{
                borderRadius: '50%',
                objectFit: 'cover',
                width: '46px',
                height: '46px',
                border: `4px solid ${fixer.available ? style.color : palette.iconBorderBusy}`,
                opacity: fixer.available ? 1 : 0.7,
              }}
            />

            <div style={{ flex: 1 }}>
              <h3 style={{ margin: 0, color: palette.textColor, fontSize: '15px', fontWeight: 700 }}>
                {fixer.servicio}
              </h3>
              <span style={{ fontSize: '13px', color: palette.textColor }}>
                {fixer.nombre} - {fixer.available ? 'Disponible' : 'No disponible'}
              </span>
            </div>
          </div>

          <div style={{ display: 'flex', gap: '8px' }}>
            {/* Botón WhatsApp */}
            <a
              href={fixer.available ? `https://wa.me/591${fixer.id}` : '#'}
              target='_blank'
              rel='noreferrer'
              style={{
                flex: 1,
                padding: '8px 0',
                background: fixer.available ? palette.buttonBg : '#ccc',
                color: palette.buttonText,
                borderRadius: '12px',
                fontWeight: 600,
                fontSize: '13px',
                textAlign: 'center',
                textDecoration: 'none',
                pointerEvents: fixer.available ? 'auto' : 'none',
                transition: 'background 0.3s',
                fontFamily: "'Roboto', sans-serif",
              }}
              onMouseOver={(e) => {
                if (fixer.available) e.currentTarget.style.background = palette.buttonHover;
              }}
              onMouseOut={(e) => {
                if (fixer.available) e.currentTarget.style.background = palette.buttonBg;
              }}
            >
              WhatsApp
            </a>

            {/* Botón Ver perfil */}
            <button
              style={{
                flex: 1,
                padding: '8px 0',
                background: fixer.available ? palette.buttonBg : '#ccc',
                color: palette.buttonText,
                borderRadius: '12px',
                fontWeight: 600,
                fontSize: '13px',
                cursor: fixer.available ? 'pointer' : 'not-allowed',
                border: 'none',
                transition: 'background 0.3s',
                fontFamily: "'Roboto', sans-serif",
              }}
              onMouseOver={(e) => {
                if (fixer.available) e.currentTarget.style.background = palette.buttonHover;
              }}
              onMouseOut={(e) => {
                if (fixer.available) e.currentTarget.style.background = palette.buttonBg;
              }}
              onClick={() => {
                if (fixer.available) router.push(`/fixer/${fixer.id}`);
              }}
            >
              Ver perfil
            </button>
          </div>
        </div>
      </Popup>
    </Marker>
  );
}
</file>

<file path="src/app/Mapa/ResetMapButton.tsx">
'use client';
import { useState } from 'react';

interface ResetMapButtonProps {
  onReset: () => void;
  isOnline?: boolean; // opcional
}

export default function ResetMapButton({ onReset, isOnline = true }: ResetMapButtonProps) {
  const [showMessage, setShowMessage] = useState(false);

  const palette = {
    whatsappBg: '#2B6AE0',
    whatsappHover: '#3B7BDD',
    buttonText: '#FFFFFF',
  };

  const handleClick = () => {
    if (!isOnline) {
      setShowMessage(true);
      setTimeout(() => setShowMessage(false), 3000);
      return;
    }

    onReset();
  };

  return (
    <>
      <button
        onClick={handleClick}
        style={{
          background: palette.whatsappBg,
          color: palette.buttonText,
          borderRadius: '12px',
          fontWeight: 600,
          fontSize: '13px',
          textAlign: 'center',
          padding: '8px 0',
          flex: 1,
          border: 'none',
          cursor: 'pointer',
          transition: 'background 0.3s',
          fontFamily: "'Roboto', sans-serif",
        }}
        onMouseOver={(e) => {
          e.currentTarget.style.background = palette.whatsappHover;
        }}
        onMouseOut={(e) => {
          e.currentTarget.style.background = palette.whatsappBg;
        }}
        className='absolute top-3 right-3 z-[1000] w-[160px]'
      >
        🔄 Reiniciar Mapa
      </button>

      {showMessage && (
        <div
          className='absolute top-16 left-1/2 -translate-x-1/2 z-[1000] text-white font-bold px-6 py-3 rounded-xl shadow-lg text-center transition-all duration-700 ease-in-out'
          style={{
            pointerEvents: 'none',
            backgroundColor: '#E74C3C',
            transform: showMessage ? 'translateY(0)' : 'translateY(-20px)',
            opacity: showMessage ? 1 : 0,
          }}
        >
          ⚠️ Sin conexión..
        </div>
      )}
    </>
  );
}
</file>

<file path="src/app/Mapa/serviceStyles.ts">
export interface ServiceStyle {
  color: string;
  iconUrl: string;
}

export const serviceStyles: Record<string, ServiceStyle> = {
  plomería: { color: '#00C851', iconUrl: '/herrami.jpg' },
  electricidad: { color: '#ffbb33', iconUrl: '/herrami.jpg' },
  carpintería: { color: '#33b5e5', iconUrl: '/herrami.jpg' },
  pintura: { color: '#ff4444', iconUrl: '/herrami.jpg' },
  jardinería: { color: '#2BDDE0', iconUrl: '/herrami.jpg' },
  cerrajería: { color: '#aa66cc', iconUrl: '/herrami.jpg' },
  albañilería: { color: '#ff8800', iconUrl: '/herrami.jpg' },
  limpieza: { color: '#00bfa5', iconUrl: '/herrami.jpg' },
  gasfitería: { color: '#0099cc', iconUrl: '/herrami.jpg' },
  otros: { color: '#2B31E0', iconUrl: '/herrami.jpg' },
};

export function getServiceStyle(service: string): ServiceStyle {
  return serviceStyles[service.toLowerCase()] || serviceStyles.otros;
}



/*export interface ServiceStyle {
  color: string;
  iconUrl: string;
}
export const serviceStyles: Record<string, ServiceStyle> = {
  plomería: { color: '#00C851', iconUrl: '/Plomeria.webp' },
  electricidad: { color: '#ffbb33', iconUrl: '/Electricistas.webp' },
  carpintería: { color: '#33b5e5', iconUrl: '/Carpinteria.webp' },
  pintura: { color: '#ff4444', iconUrl: '/Pintura.webp' },
  jardinería: { color: '#2BDDE0', iconUrl: '/Jardineria.png' },
  cerrajería: { color: '#aa66cc', iconUrl: '/Cerrajeria.png' },
  albañilería: { color: '#ff8800', iconUrl: '/Albañileria.png' },
  limpieza: { color: '#00bfa5', iconUrl: '/Limpieza.webp' },
  gasfitería: { color: '#0099cc', iconUrl: '/Gasfiteria.png' },
  otros: { color: '#2B31E0', iconUrl: '/avatar.png' },
};

export function getServiceStyle(service: string): ServiceStyle {
  return serviceStyles[service.toLowerCase()] || serviceStyles.otros;
}
*/
</file>

<file path="src/app/redux/services/services/api.ts">
const BASE_URL = process.env.NEXT_PUBLIC_API_URL;
const CLIENT_BASE = '/api/controlC/cliente';

export interface AuthProvider {
  provider: 'email' | 'google' | 'discord' | 'github';
  providerId?: string;
  email?: string;
  token?: string;
}

interface APIResponse {
  success?: boolean;
  message?: string;
  client?: {
    authProviders: AuthProvider[];
  };
}

export interface Client {
  id: string;
  email: string;
  name?: string;
  authProviders: AuthProvider[];
}

export async function obtenerMetodosCliente(): Promise<AuthProvider[]> {
  const token = localStorage.getItem('servineo_token');
  if (!token) throw new Error('No se encontró token de autenticación.');

  try {
    const res = await fetch(`${BASE_URL}${CLIENT_BASE}/profile`, {
      method: 'GET',
      headers: { Authorization: `Bearer ${token}` },
    });

    const data: APIResponse = await res.json().catch(() => ({ client: { authProviders: [] } }));

    if (!res.ok) throw new Error(data.message || 'Error al cargar métodos de login.');

    return data.client?.authProviders || [];
  } catch (error) {
    console.error('Error obtenerMetodosCliente:', error);
    throw error;
  }
}

export async function desvincularMetodo(provider: string): Promise<AuthProvider[]> {
  const token = localStorage.getItem('servineo_token');
  if (!token) throw new Error('No se encontró token de autenticación.');

  try {
    const res = await fetch(`${BASE_URL}${CLIENT_BASE}/unlink`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ provider }),
    });

    const data: APIResponse = await res.json().catch(() => ({ client: { authProviders: [] } }));

    if (!res.ok) throw new Error(data.message || 'Error al desvincular método.');

    return data.client?.authProviders || [];
  } catch (error) {
    console.error('Error desvincularMetodo:', error);
    throw error;
  }
}

export interface VincularResultado {
  success: boolean;
  message: string;
  client?: Client;
}

export async function vincularCorreoContrasena(
  token: string,
  email: string,
  password: string,
): Promise<VincularResultado> {
  try {
    const res = await fetch(
      `${process.env.NEXT_PUBLIC_API_URL}/api/controlC/cliente/link-email-password`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ email, password }),
      },
    );

    const data = await res.json();
    if (!res.ok) throw new Error(data.message || 'Error al vincular método');

    return { success: true, message: 'Método vinculado correctamente', client: data.client };
  } catch (err: unknown) {
    const message = err instanceof Error ? err.message : String(err);
    return { success: false, message };
  }
}

export interface GitHubLinkResult {
  success: boolean;
  client?: Client;
  message?: string;
}

export function vincularGitHub(
  token: string,
  onSuccess?: (client: Client) => void,
  onError?: (msg: string) => void,
) {
  const state = encodeURIComponent(JSON.stringify({ mode: 'link', token }));

  const popup = window.open(
    `${process.env.NEXT_PUBLIC_API_URL}/auth/github?state=${state}`,
    'GitHubLink',
    'width=600,height=700',
  );

  if (!popup) {
    onError?.('No se pudo abrir la ventana de GitHub');
    return;
  }

  const handleMessage = (event: MessageEvent) => {
    if (event.origin !== process.env.NEXT_PUBLIC_API_URL) return;

    const data = event.data;

    if (data.type === 'GITHUB_LINK_SUCCESS') {
      onSuccess?.(data.client);
      popup.close();
      window.removeEventListener('message', handleMessage);
    } else if (data.type === 'GITHUB_LINK_ERROR') {
      onError?.(data.message || 'Error al vincular cuenta GitHub');
      popup.close();
      window.removeEventListener('message', handleMessage);
    }
  };

  window.addEventListener('message', handleMessage);
}

export interface GoogleLinkResult {
  success: boolean;
  client?: Client;
  message?: string;
}

export async function vincularGoogle(
  tokenUsuario: string,
  tokenGoogle: string,
): Promise<GoogleLinkResult> {
  try {
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/controlC/cliente/link-google`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${tokenUsuario}`,
      },
      body: JSON.stringify({ tokenGoogle }),
    });

    const data = await res.json();

    if (!res.ok) {
      return { success: false, message: data.message || 'Error al vincular Google' };
    }

    return {
      success: true,
      message: 'Cuenta de Google vinculada correctamente',
      client: data.client,
    };
  } catch (err: unknown) {
    const message = err instanceof Error ? err.message : 'Error al vincular Google';
    return { success: false, message };
  }
}

export interface DiscordLinkResult {
  success: boolean;
  client?: Client;
  message?: string;
}

export function vincularDiscord(
  token: string,
  onSuccess?: (client: Client) => void,
  onError?: (msg: string) => void,
) {
  const state = encodeURIComponent(JSON.stringify({ mode: 'link', token }));

  const baseUrl = BASE_URL;
  const finalUrl = `${baseUrl}/auth/discord?state=${state}`;

  const popup = window.open(finalUrl, 'DiscordLink', 'width=600,height=700');

  const allowedOrigin = BASE_URL;

  const handleMessage = (event: MessageEvent) => {
    if (event.origin !== allowedOrigin) return;

    if (event.data.type === 'DISCORD_LINK_SUCCESS') {
      onSuccess?.(event.data.client);
      popup?.close();
      window.removeEventListener('message', handleMessage);
    } else if (event.data.type === 'DISCORD_LINK_ERROR') {
      onError?.(event.data.message);
      popup?.close();
      window.removeEventListener('message', handleMessage);
    }
  };

  window.addEventListener('message', handleMessage);
}
</file>

<file path="src/app/redux/slice/jobOfert.ts">
// src\app\redux\slice\jobOfert.ts
import { createSlice, PayloadAction } from '@reduxjs/toolkit';
import { FilterState, JobOffersState } from '../features/jobOffers/types';

const getDefaultState = (): JobOffersState => ({
  loading: false,
  error: null,
  filters: {
    range: [],
    city: [],
    category: [],
  },
  sortBy: 'recent',
  search: '',
  date: null,
  rating: null,
  titleOnly: false,
  exact: false,
  paginaActual: 1,
  registrosPorPagina: 10,
  totalRegistros: 0,
  preservedTotalRegistros: 0,
  totalPages: 0,
  paginaciones: {
    offers: {
      paginaActual: 1,
      registrosPorPagina: 10,
      totalRegistros: 0,
      totalPages: 0,
    },
  },
  shouldPersist: true,
});

const initialState: JobOffersState = getDefaultState();

const jobOffersSlice = createSlice({
  name: 'jobOffers',
  initialState,
  reducers: {
    setSearch: (state, action: PayloadAction<string>) => {
      state.search = action.payload;
      // if (state.shouldPersist) {
      //   saveToStorage(STORAGE_KEYS.SEARCH, action.payload);
      // }
    },

    setFilters: (state, action: PayloadAction<FilterState>) => {
      state.filters = action.payload;
      // if (state.shouldPersist) {
      //   saveToStorage(STORAGE_KEYS.FILTERS, action.payload);
      // }
    },

    setTitleOnly: (state, action: PayloadAction<boolean>) => {
      state.titleOnly = action.payload;
      // if (state.shouldPersist) {
      //   saveToStorage(STORAGE_KEYS.TITLE_ONLY, action.payload);
      // }
    },

    setExact: (state, action: PayloadAction<boolean>) => {
      state.exact = action.payload;
      // if (state.shouldPersist) {
      //   saveToStorage(STORAGE_KEYS.EXACT, action.payload);
      // }
    },

    setSortBy: (state, action: PayloadAction<string>) => {
      state.sortBy = action.payload;
      // if (state.shouldPersist) {
      //   saveToStorage(STORAGE_KEYS.SORT, action.payload);
      // }
    },

    setDate: (state, action: PayloadAction<string | null>) => {
      state.date = action.payload;
      // if (state.shouldPersist) {
      //   saveToStorage(STORAGE_KEYS.DATE, action.payload);
      // }
    },

    setRating: (state, action: PayloadAction<number | null>) => {
      state.rating = action.payload;
      // if (state.shouldPersist) {
      //   saveToStorage(STORAGE_KEYS.RATING, action.payload);
      // }
    },

    setRegistrosPorPagina: (state, action: PayloadAction<number>) => {
      state.registrosPorPagina = action.payload;
      state.paginaActual = 1;

      if (!state.paginaciones['offers']) {
        state.paginaciones['offers'] = {
          paginaActual: 1,
          registrosPorPagina: action.payload,
          totalRegistros: 0,
          totalPages: 0,
        };
      } else {
        state.paginaciones['offers'].registrosPorPagina = action.payload;
        state.paginaciones['offers'].paginaActual = 1;
      }
    },

    setPaginaActual: (state, action: PayloadAction<number>) => {
      state.paginaActual = action.payload;

      if (!state.paginaciones['offers']) {
        state.paginaciones['offers'] = {
          paginaActual: action.payload,
          registrosPorPagina: state.registrosPorPagina,
          totalRegistros: 0,
          totalPages: 0,
        };
      } else {
        state.paginaciones['offers'].paginaActual = action.payload;
      }
    },

    updatePagination: (
      state,
      action: PayloadAction<{
        total: number;
        page: number;
        limit: number;
        totalPages: number;
        listKey?: string;
        isInitialSearch?: boolean;
      }>,
    ) => {
      const {
        total,
        page,
        limit,
        totalPages,
        listKey = 'offers',
      } = action.payload;

      if (!state.paginaciones[listKey]) {
        state.paginaciones[listKey] = {
          paginaActual: 1,
          registrosPorPagina: 10,
          totalRegistros: 0,
          totalPages: 0,
        };
      }

      state.paginaciones[listKey].paginaActual = page;
      state.paginaciones[listKey].registrosPorPagina = limit;
      state.paginaciones[listKey].totalRegistros = total;
      state.paginaciones[listKey].totalPages = totalPages;

      const totalToUse = state.preservedTotalRegistros > 0 ? state.preservedTotalRegistros : total;

      state.paginaActual = page;
      state.registrosPorPagina = limit;
      state.totalRegistros = totalToUse;
      state.totalPages = totalPages;
    },

    // Limpiar filtros sin persistir
    resetFilters: (state) => {
      const defaultState = getDefaultState();
      state.filters = defaultState.filters;
      state.sortBy = defaultState.sortBy;
      state.search = defaultState.search;
      state.date = defaultState.date;
      state.rating = defaultState.rating;
      state.titleOnly = defaultState.titleOnly;
      state.exact = defaultState.exact;
      state.paginaActual = 1;
      state.preservedTotalRegistros = 0;
      state.shouldPersist = false; // Desactivar persistencia temporalmente
      state.totalRegistros = 0;
      state.totalPages = 0;

      // Limpiar localStorage explícitamente
      // clearJobOffersStorage();

      if (!state.paginaciones['offers']) {
        state.paginaciones['offers'] = {
          paginaActual: 1,
          registrosPorPagina: state.registrosPorPagina,
          totalRegistros: 0,
          totalPages: 0,
        };
      } else {
        state.paginaciones['offers'].paginaActual = 1;
      }
    },

    // Reactivar persistencia
    enablePersistence: (state) => {
      state.shouldPersist = true;
    },

    resetPagination: (state) => {
      state.paginaActual = 1;

      if (!state.paginaciones['offers']) {
        state.paginaciones['offers'] = {
          paginaActual: 1,
          registrosPorPagina: state.registrosPorPagina,
          totalRegistros: 0,
          totalPages: 0,
        };
      } else {
        state.paginaciones['offers'].paginaActual = 1;
      }
    },

    restoreSavedState: (
      state,
      action: PayloadAction<{
        search: string;
        filters: FilterState;
        sortBy: string;
        paginaActual: number;
        registrosPorPagina: number;
        titleOnly: boolean;
        exact: boolean;
        date: string | null;
        rating: number | null;
        totalRegistros?: number;
        totalPages?: number;
        preservedTotalRegistros?: number;
      }>,
    ) => {
      const restored = action.payload;
      state.search = restored.search;
      state.filters = restored.filters;
      state.sortBy = restored.sortBy;
      state.paginaActual = restored.paginaActual;
      state.registrosPorPagina = restored.registrosPorPagina;
      state.titleOnly = restored.titleOnly;
      state.exact = restored.exact;
      state.date = restored.date;
      state.rating = restored.rating;

      if (restored.totalRegistros !== undefined) {
        state.totalRegistros = restored.totalRegistros;
      }
      if (restored.totalPages !== undefined) {
        state.totalPages = restored.totalPages;
      }
      if (restored.preservedTotalRegistros !== undefined) {
        state.preservedTotalRegistros = restored.preservedTotalRegistros;
      }
      state.shouldPersist = true;

      if (!state.paginaciones['offers']) {
        state.paginaciones['offers'] = {
          paginaActual: restored.paginaActual,
          registrosPorPagina: restored.registrosPorPagina,
          totalRegistros: restored.totalRegistros || 0,
          totalPages: restored.totalPages || 0,
        };
      } else {
        state.paginaciones['offers'].totalRegistros = restored.totalRegistros || 0;
        state.paginaciones['offers'].totalPages = restored.totalPages || 0;
      }
    },

    setLoading: (state, action: PayloadAction<boolean>) => {
      state.loading = action.payload;
    },

    setError: (state, action: PayloadAction<string | null>) => {
      state.error = action.payload;
    },
  },
});

export const {
  setSearch,
  setFilters,
  setTitleOnly,
  setExact,
  setSortBy,
  setDate,
  setRating,
  setRegistrosPorPagina,
  setPaginaActual,
  updatePagination,
  resetFilters,
  enablePersistence,
  resetPagination,
  restoreSavedState,
  setLoading,
  setError,
} = jobOffersSlice.actions;

export default jobOffersSlice.reducer;
</file>

<file path="src/Components/Adv-search/DateFilterSelector.tsx">
'use client';
import React, { useRef, useEffect, useState, useCallback } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Calendar, ChevronDown } from 'lucide-react';
import { useTranslations } from 'next-intl';
import CalendarComponent from './CalendarComponent';

interface Props {
  selectedFilter: string;
  selectedDate: Date | null;
  onChange: (filter: string, date?: Date | null) => void;
  onCalendarToggle?: (isOpen: boolean) => void;
  clearSignal?: number;
}

const DateFilterSelector: React.FC<Props> = ({
  selectedFilter,
  selectedDate,
  onChange,
  onCalendarToggle,
  clearSignal,
}) => {
  const t = useTranslations('advancedSearch.date');
  const [showCalendar, setShowCalendar] = useState(false);
  const [day, setDay] = useState('');
  const [month, setMonth] = useState('');
  const [year, setYear] = useState('');

  const calendarContainerRef = useRef<HTMLDivElement>(null);
  const pathname = usePathname();
  const router = useRouter();
  // keep previous clear signal to detect changes
  const prevClearRef = useRef<number | undefined>(undefined);

  // 🔄 Sincronizar selectedDate (prop) → estados locales (day, month, year)
  useEffect(() => {
    if (selectedDate) {
      setDay(String(selectedDate.getDate()).padStart(2, '0'));
      setMonth(String(selectedDate.getMonth() + 1).padStart(2, '0'));
      setYear(String(selectedDate.getFullYear()));
    } else {
      // Solo limpiamos si el filtro no es 'specific' o si la fecha es null
      if (selectedFilter !== 'specific') {
        setDay('');
        setMonth('');
        setYear('');
      }
    }
  }, [selectedDate, selectedFilter]);

  // 🛠️ Función de validación de fecha
  const isValidDate = useCallback((): boolean => {
    if (day.length !== 2 || month.length !== 2 || year.length !== 4) return false;
    const d = Number(day);
    const m = Number(month);
    const y = Number(year);
    if (d < 1 || d > 31 || m < 1 || m > 12 || y < 1000) return false;

    // Comprueba si la fecha es válida (ej: evita 30/02)
    const dt = new Date(y, m - 1, d);
    return dt.getDate() === d && dt.getMonth() === m - 1 && dt.getFullYear() === y;
  }, [day, month, year]);

  // 🔗 Mantener la URL en sincronía y notificar al padre sobre cambios de fecha manuales
  useEffect(() => {
    if (typeof window === 'undefined') return;

    // Solo si el filtro es 'specific' y hay una entrada completa.
    if (
      selectedFilter !== 'specific' ||
      day.length !== 2 ||
      month.length !== 2 ||
      year.length !== 4
    ) {
      // Limpiar URL si no estamos en 'specific' o si la entrada está incompleta
      const sp = new URLSearchParams(window.location.search);
      if (sp.has('date') && selectedFilter !== 'specific') {
        sp.delete('date');
        const qs = sp.toString();
        const target = qs ? `${pathname}?${qs}` : pathname;
        router.replace(target, { scroll: false });
      } else if (
        selectedFilter === 'specific' &&
        (day.length !== 2 || month.length !== 2 || year.length !== 4)
      ) {
        // Asegurarse de que el padre sabe que la fecha es inválida/incompleta
        onChange('specific', null);
      }
      return;
    }

    // Usar setTimeout para evitar llamadas excesivas al router durante la escritura
    const handler = setTimeout(() => {
      const sp = new URLSearchParams(window.location.search);
      const dateIsValid = isValidDate();

      if (dateIsValid) {
        const iso = `${year}-${month}-${day}`;
        sp.set('date', iso);
        const newDate = new Date(Number(year), Number(month) - 1, Number(day));

        // Notificar al padre solo si la fecha válida actual es diferente a la almacenada.
        if (!selectedDate || newDate.getTime() !== selectedDate.getTime()) {
          onChange('specific', newDate);
        }
      } else {
        sp.delete('date');
        // Notificar al padre que la fecha es inválida
        onChange('specific', null);
      }

      const qs = sp.toString();
      const target = qs ? `${pathname}?${qs}` : pathname;
      // Usar replace con { scroll: false } para evitar desplazamiento al cambiar la URL
      router.replace(target, { scroll: false });
    }, 250); // Debounce de 250ms

    return () => clearTimeout(handler);
  }, [day, month, year, selectedFilter, pathname, router, isValidDate, onChange, selectedDate]);

  // 🖱️ Detectar clics fuera del calendario para cerrarlo
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        showCalendar &&
        calendarContainerRef.current &&
        !calendarContainerRef.current.contains(event.target as Node)
      ) {
        setShowCalendar(false);
        onCalendarToggle?.(false);
      }
    };

    if (showCalendar) {
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [showCalendar, onCalendarToggle]);

  // 🔁 Cuando el parent solicita limpiar (clearSignal cambia), limpiar inputs y la query 'date'
  useEffect(() => {
    if (typeof window === 'undefined') return;
    if (clearSignal == null) return;

    // ignore initial undefined
    if (prevClearRef.current === clearSignal) return;
    prevClearRef.current = clearSignal;

    // Clear local inputs
    setDay('');
    setMonth('');
    setYear('');

    // Notify parent that specific date is cleared
    try {
      onChange('specific', null);
    } catch {
      /* noop */
    }

    // Remove date from URL if present
    try {
      const sp = new URLSearchParams(window.location.search);
      if (sp.has('date')) {
        sp.delete('date');
        const qs = sp.toString();
        const target = qs ? `${pathname}?${qs}` : pathname;
        router.replace(target, { scroll: false });
      }
    } catch {
      /* noop */
    }
  }, [clearSignal, onChange, pathname, router]);

  // 🗓️ Manejadores de calendario
  const handleDateSelect = (date: Date) => {
    setShowCalendar(false);
    onCalendarToggle?.(false);
    // La sincronización de estados (day, month, year) y URL ocurre via el useEffect
    onChange('specific', date);
  };

  const handleCalendarToggle = () => {
    const newShowCalendar = !showCalendar;
    setShowCalendar(newShowCalendar);
    onCalendarToggle?.(newShowCalendar);
  };

  // 🎨 Determinar clase de borde según la validación (funcionalidad del segundo código)
  const inputBorderClass =
    selectedFilter === 'specific'
      ? day && month && year
        ? isValidDate()
          ? 'border-green-500 ring-2 ring-green-500 ring-opacity-20'
          : 'border-red-500 ring-2 ring-red-500 ring-opacity-20'
        : 'border-gray-300 focus:ring-[#2B6AE0]'
      : 'border-gray-300';

  return (
    <div>
      <h3 className='text-base mb-2'>{t('label')}</h3>

      <div className='bg-white rounded-lg border border-gray-300 p-4 space-y-3 w-fit'>
        {/* Opciones de radio: Los más recientes y Los más antiguos */}
        {['recent', 'oldest'].map((filter) => (
          <label
            key={filter}
            className='flex items-center gap-2 text-sm cursor-pointer hover:text-[#2B31E0] transition-colors'
          >
            <input
              type='radio'
              name='dateFilter'
              value={filter}
              checked={selectedFilter === filter}
              onChange={() => onChange(filter, null)}
              className='w-4 h-4 cursor-pointer flex-shrink-0 text-[#2B6AE0] rounded-full border-gray-300 focus:ring-[#2B6AE0]'
            />
            <span className='text-gray-700 whitespace-nowrap'>{t(`filters.${filter}`)}</span>
          </label>
        ))}

        {/* Opción de fecha específica */}
        <div className='space-y-2'>
          <label className='flex items-center gap-2 text-sm cursor-pointer hover:text-[#2B31E0] transition-colors'>
            <input
              type='radio'
              name='dateFilter'
              value='specific'
              checked={selectedFilter === 'specific'}
              onChange={() => onChange('specific', null)}
              className='w-4 h-4 cursor-pointer flex-shrink-0 text-[#2B6AE0] rounded-full border-gray-300 focus:ring-[#2B6AE0]'
            />
            <span className='text-gray-700 font-medium whitespace-nowrap'>
              {t('filters.specific')}
            </span>
          </label>

          {/* Inputs de fecha y botón de calendario - solo visible cuando "specific" está seleccionado */}
          {selectedFilter === 'specific' && (
            <div className='flex flex-col gap-1 ml-6'>
              <div className='flex items-center gap-2'>
                {/* Día */}
                <input
                  type='text'
                  value={day}
                  onChange={(e) => setDay(e.target.value.replace(/\D/g, '').slice(0, 2))}
                  placeholder='DD'
                  maxLength={2}
                  className={`w-12 px-2 py-2 border rounded-lg text-sm font-mono text-center bg-white focus:outline-none focus:ring-2 transition-all ${inputBorderClass}`}
                />

                <span className='text-gray-500 text-xl flex items-center justify-center h-full'>
                  /
                </span>

                {/* Mes */}
                <input
                  type='text'
                  value={month}
                  onChange={(e) => setMonth(e.target.value.replace(/\D/g, '').slice(0, 2))}
                  placeholder='MM'
                  maxLength={2}
                  className={`w-12 px-2 py-2 border rounded-lg text-sm font-mono text-center bg-white focus:outline-none focus:ring-2 transition-all ${inputBorderClass}`}
                />

                <span className='text-gray-500 text-xl flex items-center justify-center h-full'>
                  /
                </span>

                {/* Año */}
                <input
                  type='text'
                  value={year}
                  onChange={(e) => setYear(e.target.value.replace(/\D/g, '').slice(0, 4))}
                  placeholder='AAAA'
                  maxLength={4}
                  className={`w-20 px-2 py-2 border rounded-lg text-sm font-mono text-center bg-white focus:outline-none focus:ring-2 transition-all ${inputBorderClass}`}
                />

                {/* Calendario */}
                <div className='relative' ref={calendarContainerRef}>
                  <button
                    type='button'
                    onClick={handleCalendarToggle}
                    className='flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 transition-colors'
                  >
                    <Calendar size={18} className='text-gray-600' />
                    <ChevronDown size={16} className='text-gray-500' />
                  </button>

                  {/* Calendario desplegable */}
                  {showCalendar && (
                    <div className='absolute z-50 mt-2 -left-100'>
                      <CalendarComponent
                        selectedDate={selectedDate || new Date()}
                        onDateSelect={handleDateSelect}
                        onClose={() => {
                          setShowCalendar(false);
                          onCalendarToggle?.(false);
                        }}
                      />
                    </div>
                  )}
                </div>
              </div>

              {/* Mensaje de fecha inválida */}
              {day.length === 2 && month.length === 2 && year.length === 4 && !isValidDate() && (
                <p className='text-red-500 text-sm'>Fecha inválida</p>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default DateFilterSelector;
</file>

<file path="src/Components/Home/Hero-section.tsx">
'use client';
import { useState } from 'react';
import { useRouter } from 'next/navigation';
import StatCard from '../Common/StatCard';
import { useTranslations } from 'next-intl';
import { SearchBar } from './Searchbar-section';

type HeroSectionProps = {
  isFixer?: boolean;
};

export default function HeroSection({ isFixer = false }: HeroSectionProps) {
  const t = useTranslations('HeroSection');
  const router = useRouter();
  const [searchText, setSearchText] = useState('');

  const handleSearch = (query: string) => {
    const trimmedSearch = query.trim();
    if (trimmedSearch) {
      router.push(`/job-offer-list?search=${encodeURIComponent(trimmedSearch)}`);
    } else {
      router.push('/job-offer-list');
    }
  };

  const handleTagClick = (tag: string) => {
    router.push(`/job-offer-list?search=${encodeURIComponent(tag)}`);
  };

  const titleText = isFixer ? 'Haz crecer tu trabajo con nosotros' : t('title');
  const subtitleText = isFixer
    ? 'Recibe solicitudes de reparación y mantenimiento de personas cerca de ti'
    : t('subtitle');
  const placeholderText = isFixer ? 'Busca solicitudes de trabajo' : t('placeholder');

  return (
    <section
      id='tour-hero-section'
      className='relative w-full pt-28 pb-16 px-4 md:px-12 text-center bg-gradient-to-br from-primary/5 via-white to-primary/10 overflow-hidden'
    >
      {/* Decoraciones de fondo */}
      <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMCAwaDIwdjIwSDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTAgMGgyMHYyMEgweiIgZmlsbD0iIzAwMCIgZmlsbC1vcGFjaXR5PSIwLjA1IiBmaWxsLXJ1bGU9ImV2ZW5vZGQiLz48L3N2Zz4=')] opacity-5" />
      <div className='absolute -top-24 -right-24 w-96 h-96 bg-primary/20 rounded-full mix-blend-multiply filter blur-3xl animate-[pulse_8s_ease-in-out_infinite]' />
      <div className='absolute -bottom-24 -left-24 w-96 h-96 bg-primary/20 rounded-full mix-blend-multiply filter blur-3xl animate-[pulse_8s_ease-in-out_infinite] animation-delay-2000' />

      {/* Contenido */}
      <div className='max-w-6xl mx-auto relative z-10'>
        {/* Título */}
        <h1 className='text-4xl md:text-6xl font-bold mb-6 bg-gradient-to-r from-primary to-primary/80 bg-clip-text text-transparent drop-shadow-sm'>
          {titleText}
        </h1>

        {/* Subtítulo */}
        <p className='text-lg md:text-xl text-gray-700 mb-12 max-w-3xl mx-auto font-medium'>
          {subtitleText}
        </p>

        {/* Barra de búsqueda: SOLO si NO es fixer */}
        {!isFixer && (
          <div className='mb-10 max-w-2xl mx-auto' id='tour-search-bar'>
            <SearchBar
              value={searchText}
              onChange={setSearchText}
              placeholder={placeholderText}
              onSearch={handleSearch}
              showButton={true}
              buttonText={t('search')}
            />
          </div>
        )}

        {/* Búsquedas populares: SOLO para usuario normal */}
        {!isFixer && (
          <div className='mb-16'>
            <div className='flex flex-col md:flex-row justify-center items-center space-y-4 md:space-y-0 md:space-x-4 mb-6'>
              <span className='font-semibold text-gray-700 text-lg'>{t('a')}</span>
              <div className='flex flex-wrap justify-center gap-2'>
                {['Plomero', 'Electricista', 'Pintor', 'Carpintero'].map((tag) => (
                  <button
                    key={tag}
                    type='button'
                    onClick={() => handleTagClick(tag)}
                    className='px-4 py-2 text-sm bg-white border border-gray-200 text-gray-800 rounded-full hover:bg-primary/10 hover:text-primary hover:border-primary/30 transition-all duration-300 shadow-sm hover:shadow'
                  >
                    {tag}
                  </button>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* Stats: cambian según rol */}
        <div id='tour-stats-section' className='grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-16'>
          {isFixer ? (
            <>
              <StatCard number='24/7' text='Soporte disponible' />
              <StatCard number='100%' text='Pago seguro' />
              <StatCard number='10+' text='Categorías de servicios' />
            </>
          ) : (
            <>
              <StatCard number='1,000+' text={t('professional')} />
              <StatCard number='5,000+' text={t('Projects completed')} />
              <StatCard number='4.8 ★' text={t('Overall grade')} />
            </>
          )}
        </div>
      </div>
    </section>
  );
}
</file>

<file path="src/Components/Home/MapSection.tsx">
'use client';
import React, { useEffect, useState } from 'react';
import dynamic from 'next/dynamic';

// Import dinámico para Next.js (evitar SSR con mapas)
const Map = dynamic(() => import('@/app/Mapa/Map'), { ssr: false });

export default function MapSection() {
  const [isMounted, setIsMounted] = useState(false);

  useEffect(() => {
    setIsMounted(true);
  }, []);

  return (
    <section className='w-full py-16 px-4 bg-gray-50 scroll-mt-24'>
      <div className='max-w-7xl mx-auto'>
        <div className='text-center mb-8'>
          <h2 className='text-3xl md:text-4xl font-bold text-gray-800 mb-4'>
            Encuentra Servicios Cerca de Ti 
          </h2>
             <p className='text-gray-600 text-lg md:text-xl'>
  Conecta rápidamente con profesionales y servicios en tu zona
</p>
        </div>

        {/* Contenedor del mapa */}
        <div
          id='titulo-seccion-mapa'
          className='h-[60vh] w-full bg-gray-100 rounded-xl overflow-visible relative shadow-sm border border-gray-200'
        >
          {isMounted && <Map />}
        </div>
      </div>
    </section>
  );
}
</file>

<file path="src/Components/Job-offers/Pagination/Paginacion.tsx">
'use client';
import React, { useState, useEffect } from 'react';
import { useTranslations } from 'next-intl';
import { ChevronLeft, ChevronRight } from 'lucide-react';

interface PaginacionProps {
  paginaActual: number;
  totalRegistros: number;
  registrosPorPagina: number;
  onChange: (numero: number) => void;
}

const Paginacion: React.FC<PaginacionProps> = ({
  paginaActual,
  totalRegistros,
  registrosPorPagina,
  onChange,
}) => {
  const t = useTranslations('pagination');
  const [mounted, setMounted] = useState(false);
  const [delta, setDelta] = useState(2);
  const [maxSinEllipsis, setMaxSinEllipsis] = useState(10);

  useEffect(() => {
    setMounted(true);
    
    const calculateDelta = () => {
      const width = window.innerWidth;
      
      // Ajustar delta y máximo sin ellipsis según el ancho de pantalla
      if (width < 480) {
        setDelta(1); // Móvil muy pequeño
        setMaxSinEllipsis(5); // Mostrar max 5 páginas sin ellipsis
      } else if (width < 640) {
        setDelta(2); // Móvil
        setMaxSinEllipsis(7); // Mostrar max 7 páginas sin ellipsis
      } else if (width < 768) {
        setDelta(3); // Móvil grande / Tablet pequeña
        setMaxSinEllipsis(9);
      } else if (width < 1024) {
        setDelta(4); // Tablet
        setMaxSinEllipsis(11);
      } else if (width < 1280) {
        setDelta(5); // Desktop pequeño
        setMaxSinEllipsis(13);
      } else {
        setDelta(6); // Desktop grande
        setMaxSinEllipsis(15);
      }
    };
    
    calculateDelta();
    window.addEventListener('resize', calculateDelta);
    
    return () => window.removeEventListener('resize', calculateDelta);
  }, []);

  const totalPaginas = Math.max(Math.ceil(totalRegistros / registrosPorPagina), 1);
  const registrosMostrados = paginaActual * registrosPorPagina;
  const yaLlegoAlFinal = registrosMostrados >= totalRegistros;

  // Función para generar el array de páginas con ellipsis responsive
  const generarPaginas = () => {
    const paginas: (number | string)[] = [];
    
    // Si el total de páginas cabe sin ellipsis según el tamaño de pantalla
    if (totalPaginas <= maxSinEllipsis) {
      for (let i = 1; i <= totalPaginas; i++) {
        paginas.push(i);
      }
      return paginas;
    }
    
    // Si hay muchas páginas, usar ellipsis
    paginas.push(1);

    // Determinar si necesitamos ellipsis al inicio
    const startPage = Math.max(2, paginaActual - delta);
    if (startPage > 2) {
      paginas.push('start-ellipsis');
    }

    // Páginas alrededor de la actual
    const endPage = Math.min(totalPaginas - 1, paginaActual + delta);
    for (let i = startPage; i <= endPage; i++) {
      paginas.push(i);
    }

    // Determinar si necesitamos ellipsis al final
    if (endPage < totalPaginas - 1) {
      paginas.push('end-ellipsis');
    }

    // Siempre mostrar la última página
    if (totalPaginas > 1) {
      paginas.push(totalPaginas);
    }

    return paginas;
  };

  const paginas = generarPaginas();

  // Evitar problemas de hidratación
  if (!mounted) {
    return (
      <div className='flex items-center gap-1 sm:gap-2 mt-4 w-full px-2 justify-center'>
        <div className='h-8 sm:h-10 px-2 sm:px-3 bg-gray-200 rounded animate-pulse min-w-[100px]'></div>
      </div>
    );
  }

  return (
    <div className='flex items-center gap-1 sm:gap-2 mt-4 w-full px-2 sm:px-4 justify-center'>
      {/* Botón Anterior */}
      {paginaActual > 1 && (
        <button
          onClick={() => onChange(paginaActual - 1)}
          className='h-8 sm:h-10 px-2 sm:px-3 text-sm sm:text-base rounded bg-gray-200 hover:bg-blue-500 hover:text-white transition-colors duration-200 flex items-center justify-center gap-1 shrink-0'
          aria-label={t('previous')}
        >
          <ChevronLeft className='w-4 h-4 sm:w-5 sm:h-5' />
          <span className='hidden sm:inline whitespace-nowrap'>{t('previous')}</span>
        </button>
      )}

      {/* Botones de páginas */}
      {paginas.map((num, index) => {
        if (num === 'start-ellipsis' || num === 'end-ellipsis') {
          return (
            <div
              key={`${num}-${index}`}
              className='h-8 sm:h-10 px-1 sm:px-2 text-gray-500 text-sm sm:text-base flex items-center justify-center shrink-0'
            >
              ...
            </div>
          );
        }

        return (
          <button
            key={num}
            onClick={() => onChange(num as number)}
            className={`h-8 sm:h-10 px-2 sm:px-3 text-sm sm:text-base rounded transition-colors duration-200 min-w-[32px] sm:min-w-[40px] flex items-center justify-center shrink-0 ${
              num === paginaActual
                ? 'bg-blue-600 text-white font-semibold'
                : 'bg-gray-200 hover:bg-blue-500 hover:text-white'
            }`}
            aria-label={`${t('page')} ${num}`}
            aria-current={num === paginaActual ? 'page' : undefined}
          >
            {num}
          </button>
        );
      })}

      {/* Botón Siguiente */}
      {!yaLlegoAlFinal && (
        <button
          onClick={() => onChange(Math.min(paginaActual + 1, totalPaginas))}
          disabled={paginaActual === totalPaginas}
          className={`h-8 sm:h-10 px-2 sm:px-3 text-sm sm:text-base rounded transition-colors duration-200 flex items-center justify-center gap-1 shrink-0 ${
            paginaActual === totalPaginas
              ? 'bg-gray-300 cursor-not-allowed text-gray-500'
              : 'bg-gray-200 hover:bg-blue-500 hover:text-white'
          }`}
          aria-label={t('next')}
        >
          <span className='hidden sm:inline whitespace-nowrap'>{t('next')}</span>
          <ChevronRight className='w-4 h-4 sm:w-5 sm:h-5' />
        </button>
      )}
    </div>
  );
};

export default Paginacion;
</file>

<file path="src/Components/payment/CentroPagos.tsx">
// servineo-frontend/src/Components/payment/CentroPagos.tsx
'use client';
import { useRouter } from 'next/navigation';
import React, { useState, useEffect } from 'react';
import { useSearchParams } from 'next/navigation'; 
import { Wallet, Building2, FileText, ChevronRight, Loader2, AlertCircle } from 'lucide-react';
import RecentEarningsModal from './RecentEarningsModal';
import { showToast } from "nextjs-toast-notify";

// --- Constantes Mock ---
const MOCK_FIXER_ID = "690c1a08f32ebc5be9c5707c";
const MOCK_WALLET_ID = "6917ca234f50d0d44bff1173";

// --- Interfaz para los datos ---
interface FixerData {
  saldoActual: number;
  totalGanado: number;
  trabajosCompletados: number;
  fixerId?: string;
  isTestData?: boolean;

  lowBalanceAlert?: {
    type: 'none' | 'low' | 'critical';
  };

  lowBalanceInfo?: {
    balance: number;
    currency: string;
    lowBalanceThreshold: number;
    lastLowBalanceNotification?: string | Date;

    flags?: {
      needsLowAlert?: boolean;
      needsCriticalAlert?: boolean;
      cooldownUntil?: string | Date | null;
      updatedAt?: string | Date | null;
    };

    toast?: {
      shouldShow: boolean;
      level: 'low' | 'critical' | 'none';
      message: string;
    };
  };
}

const CentroDePagos = () => {
  const router = useRouter();
  const searchParams = useSearchParams(); 

  const fixerIdFromUrl = searchParams.get('fixerId');

  const [fixerData, setFixerData] = useState<FixerData | null>(null); 
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [showEarningsModal, setShowEarningsModal] = useState(false);
  
  useEffect(() => {
    if (fixerIdFromUrl) {
      fetchFixerData(fixerIdFromUrl);
    } else {
      setError("No se especificó un ID de Fixer.");
      setLoading(false);
    }
  }, [fixerIdFromUrl]);

  
  useEffect(() => {
    const toastInfo = fixerData?.lowBalanceInfo?.toast;
    console.log("🎯 Toast info en front:", toastInfo);

    if (!toastInfo) return;

    const { level, message, shouldShow } = toastInfo;

    const baseOptions = {
      duration: 8000,
      position: "top-center" as const,
      transition: "bounceIn" as const,
      sound: false,
      progress: true,
    };

    if (shouldShow && level === "critical") {
      showToast.error(
        message || "Tu saldo está en negativo o en un estado crítico. Te recomendamos recargar tu billetera.",
        baseOptions
      );
      return;
    }

    if (shouldShow && level === "low") {
      showToast.warning(
        message || "Tu saldo está bajo. Te recomendamos recargar tu billetera.",
        baseOptions
      );
      return;
    }

    if (level === "none") {
      showToast.success(
        message || "Tu billetera está saludable. Puedes seguir recibiendo pagos sin problema.",
        baseOptions
      );
    }
  
  }, [
    fixerData?.lowBalanceInfo?.toast?.shouldShow ?? null,
    fixerData?.lowBalanceInfo?.toast?.level ?? null,
  ]);

  const fetchFixerData = async (fixerId: string) => {
    setLoading(true);
    setError(null);
    
    const BACKEND_URL = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000';
    
    try {
      console.log(`🔍 Intentando conectar a: ${BACKEND_URL}/api/fixer/payment-center/${fixerId}`);
      
      const response = await fetch(`${BACKEND_URL}/api/fixer/payment-center/${fixerId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      });
      
      console.log('📡 Response status:', response.status);
      
      if (!response.ok) {
        const errData = await response.json();
        throw new Error(errData.error || `Error ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      console.log('✅ Datos recibidos:', result);
      
      if (result.success && result.data) {
        setFixerData(result.data);
      } else {
        throw new Error(result.error || 'Error desconocido');
      }
    } catch (err: unknown) {
      console.error('❌ Error fetching fixer data:', err);
      setError(err.message || 'Error desconocido');
      
      console.log('⚠️ Usando datos de prueba');
      setFixerData({
        saldoActual: 13.00,
        totalGanado: 15420.00,
        trabajosCompletados: 23,
        fixerId: fixerId, 
        isTestData: true 
      });
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="animate-spin text-blue-600 mx-auto mb-4" size={48} />
          <p className="text-gray-600">Cargando información...</p>
        </div>
      </div>
    );
  }
  
  if (error || !fixerData) {
     return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div className="text-center bg-white p-8 rounded-lg shadow-md">
          <AlertCircle className="text-red-500 mx-auto mb-4" size={48} />
          <h2 className="text-xl font-bold text-gray-800 mb-2">Error al cargar</h2>
          <p className="text-gray-600">{error || "No se pudieron cargar los datos."}</p>
          <button
            onClick={() => router.push('/')}
            className="mt-6 bg-blue-600 text-white font-semibold py-2 px-6 rounded-xl hover:bg-blue-700 transition-colors"
          >
            Volver al Inicio
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100">
      <div className="bg-blue-600 text-white px-6 py-4 shadow-md">
        <h1 className="text-xl font-bold">Centro de Pagos</h1>
      </div>

      <div className="max-w-3xl mx-auto px-4"> 
        <div className="flex justify-end pt-4">
          <button
            onClick={() => setShowEarningsModal(true)}
            className="font-['Roboto'] inline-flex items-center justify-center px-5 py-2 rounded-lg bg-[#2c6ef7] text-white font-semibold shadow-sm transition-colors hover:bg-[#1f5ad6] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c6ef7]"
          >
            Mis Ganancias
          </button>
        </div>

        {fixerData?.isTestData && (
          <div className="mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded-r-lg">
            <div className="flex items-center gap-2">
              <AlertCircle className="text-yellow-600" size={20} />
              <p className="text-sm text-yellow-800">
                Mostrando datos de prueba. No se encontró información del fixer.
              </p>
            </div>
          </div>
        )}

        <div className="pt-6 pb-4">
          <div className="bg-blue-600 rounded-2xl p-4 sm:p-6 shadow-xl text-white">
            
            <div className="flex flex-col sm:flex-row items-center gap-4 mb-6">
              <Wallet size={44} className="opacity-90 flex-shrink-0" />
              <div>
                <span className="text-sm opacity-90">Saldo Actual</span>
                <h2 className="text-3xl sm:text-4xl font-bold">
                  Bs. {fixerData?.saldoActual?.toFixed(2) || '0.00'}
                </h2>
              </div>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div className="bg-[#759ae0] rounded-xl p-4">
                <p className="text-xs text-white opacity-75 mb-1">Total Ganado</p>
                <p className="text-xl font-bold text-white">
                  Bs. {fixerData?.totalGanado?.toFixed(2) || '0.00'}
                </p>
              </div>
              <div className="bg-[#759ae0] rounded-xl p-4">
                <p className="text-xs text-white opacity-75 mb-1">Trabajos Completados</p>
                <p className="text-3xl font-bold text-white">
                  {fixerData?.trabajosCompletados || 0}
                </p>
              </div>
            </div>
          </div>
        </div>

        <div className="pb-6">
          <h3 className="text-base font-semibold text-gray-600 mb-3">Acciones Rápidas</h3>

          <div>
            <button
              onClick={() => router.push(`/payment/FixerWallet?fixerId=${fixerIdFromUrl}`)}
              disabled={!fixerIdFromUrl}
              className="w-full bg-white rounded-2xl p-4 shadow-sm hover:shadow-md transition-shadow flex items-center gap-4 group disabled:opacity-50"
            >
              <div className="bg-blue-100 p-3 rounded-xl group-hover:bg-blue-200 transition-colors">
                <Wallet className="text-blue-600" size={28} />
              </div>
              <div className="flex-1 text-left">
                <h4 className="font-bold text-gray-800 text-base">Fixer Wallet</h4>
                <p className="text-sm text-gray-500">Ver saldo, recargar y revisar movimientos</p>
              </div>
              <ChevronRight className="text-gray-400 group-hover:text-blue-600 transition-colors" size={24} />
            </button>

            <div className="h-4" /> 

            <button 
              onClick={() => router.push(`/payment/cuenta-bancaria?fixerId=${fixerIdFromUrl}`)} 
              disabled={!fixerIdFromUrl}
              className="w-full bg-white rounded-2xl p-4 shadow-sm hover:shadow-md transition-shadow flex items-center gap-4 group disabled:opacity-50"
            >
              <div className="bg-cyan-100 p-3 rounded-xl group-hover:bg-cyan-200 transition-colors">
                <Building2 className="text-cyan-600" size={28} />
              </div>
              <div className="flex-1 text-left">
                <h4 className="font-bold text-gray-800 text-base">Mi cuenta bancaria</h4>
                <p className="text-sm text-gray-500">Administración de la cuenta bancaria</p>
              </div>
              <ChevronRight className="text-gray-400 group-hover:text-cyan-600 transition-colors" size={24} />
            </button>

            <div className="h-4" />

            <button 
              onClick={() => router.push('/payment/facturas')} 
              className="w-full bg-white rounded-2xl p-4 shadow-sm hover:shadow-md transition-shadow flex items-center gap-4 group"
            >
              <div className="bg-blue-100 p-3 rounded-xl group-hover:bg-blue-200 transition-colors">
                <FileText className="text-blue-600" size={28} />
              </div>
              <div className="flex-1 text-left">
                <h4 className="font-bold text-gray-800 text-base">Mis Facturas</h4>
                <p className="text-sm text-gray-500">Ver registro de facturas</p>
              </div>
              <ChevronRight className="text-gray-400 group-hover:text-blue-600 transition-colors" size={24} />
            </button>
          </div>
        </div>

        {error && !fixerData?.isTestData && (
          <div className="pb-6">
            <button
              onClick={() => fetchFixerData(fixerIdFromUrl || '')}
              className="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700 transition-colors"
            >
              Reintentar carga
            </button>
          </div>
        )}

      </div> 

      {showEarningsModal && fixerIdFromUrl && (
        <RecentEarningsModal
          onClose={() => setShowEarningsModal(false)}
          fixerId={fixerIdFromUrl}
        />
      )}
    </div>
  );
};

export default CentroDePagos;
</file>

<file path="src/Components/payment/HistoryClient.tsx">
// src/app/payment/pages/FixerWallet/historial/HistoryPageClient.tsx
"use client";

import React, { useState, useEffect, useMemo } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { ArrowLeft, Wallet, TrendingUp, TrendingDown, Calendar, Loader2, AlertCircle } from 'lucide-react';

// --- Interfaces (SIN CAMBIOS) ---
interface Transaction {
  _id: string;
  type: string; // 'deposit' o 'commission'
  amount: number;
  description: string;
  method?: string;
  createdAt: string; 
  jobId?: string;
  status?: string; // Status es opcional aquí
}

interface FilterSettings {
  fromDate: string;
  toDate: string;
  type: string[]; 
}

export default function FixerWalletHistory() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [receivedFixerId, setReceivedFixerId] = useState<string | null>(null);

  // --- Estados de Filtros (SIN CAMBIOS) ---
  const [showFilterModal, setShowFilterModal] = useState(false);
  const [isFiltered, setIsFiltered] = useState(false);
  const [filterSettings, setFilterSettings] = useState<FilterSettings>({
    fromDate: '',
    toDate: '',
    type: [], 
  });
  
  // --- Estados de Datos (SIN CAMBIOS) ---
  const [walletData, setWalletData] = useState<{ balance: number } | null>(null);
  const [allTransactions, setAllTransactions] = useState<Transaction[]>([]);
  const [filteredTransactions, setFilteredTransactions] = useState<Transaction[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // --- Carga de Datos Reales (SIN CAMBIOS) ---
  useEffect(() => {
    const fixerId = searchParams.get('fixerId');
    if (fixerId) {
      setReceivedFixerId(fixerId);
      fetchHistoryData(fixerId); 
    } else {
      setError("No se proporcionó un ID de Fixer.");
      setLoading(false);
    }
  }, [searchParams]);

  const fetchHistoryData = async (fixerId: string) => {
    setLoading(true);
    setError(null);
    const BACKEND_URL = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000';
    
    try {
      const res = await fetch(`${BACKEND_URL}/api/fixer/payment-center/${fixerId}`);
      if (!res.ok) {
        const errData = await res.json();
        throw new Error(errData.error || "Error al cargar los datos");
      }

      const result = await res.json();
      if (result.success && result.data) {
        setWalletData({ balance: result.data.saldoActual });
        setAllTransactions(result.data.transactions || []);
        setFilteredTransactions(result.data.transactions || []);
      } else {
        throw new Error(result.error || "No se pudieron cargar los datos.");
      }
    } catch (err: unknown) {
      setError(err.message || "Un error inesperado ocurrió.");
    } finally {
      setLoading(false);
    }
  };
  
  // --- Lógica de Filtro (SIN CAMBIOS) ---
  useEffect(() => {
    let tempTxs = [...allTransactions];

    if (filterSettings.type.length > 0) {
      tempTxs = tempTxs.filter(tx => filterSettings.type.includes(tx.type));
    }
    // Usamos 'T00:00:00' para 'fromDate' para que la comparación sea en la zona local
    if (filterSettings.fromDate) {
      try {
        const from = new Date(filterSettings.fromDate + 'T00:00:00'); 
        tempTxs = tempTxs.filter(tx => new Date(tx.createdAt) >= from);
      } catch (e) { console.error("Fecha 'desde' inválida:", filterSettings.fromDate); }
    }
    // Usamos 'T23:59:59' para 'toDate' para incluir el día completo
    if (filterSettings.toDate) {
      try {
        const to = new Date(filterSettings.toDate + 'T23:59:59');
        tempTxs = tempTxs.filter(tx => new Date(tx.createdAt) <= to);
      } catch (e) { console.error("Fecha 'hasta' inválida:", filterSettings.toDate); }
    }

    setFilteredTransactions(tempTxs);
  }, [filterSettings, allTransactions]);
  
  // --- Funciones de helper (SIN CAMBIOS) ---
  const handleApplyFilter = (newFilters: FilterSettings) => {
    setFilterSettings(newFilters);
    const active = newFilters.fromDate !== '' || newFilters.toDate !== '' || newFilters.type.length > 0;
    setIsFiltered(active);
    setShowFilterModal(false);
  };
  const clearFilter = () => {
    setFilterSettings({ fromDate: '', toDate: '', type: [] });
    setIsFiltered(false);
  };
  const formatCurrency = (value: number) => {
    return `Bs. ${Math.abs(value).toFixed(2)}`;
  };


  // --- (Estados de Carga y Error SIN CAMBIOS) ---
  if (loading) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
         <Loader2 className="animate-spin text-blue-600" size={48} />
      </div>
    );
  }
  if (error) {
     return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
        {/* ... (Error UI) ... */}
        <div className="text-center bg-white p-8 rounded-lg shadow-md max-w-sm">
          <AlertCircle className="text-red-500 mx-auto mb-4" size={48} />
          <h2 className="text-xl font-bold text-gray-800 mb-2">Error al cargar el Historial</h2>
          <p className="text-gray-600 mb-6">{error}</p>
          <button
            onClick={() => router.back()}
            className="mt-6 bg-blue-600 text-white font-semibold py-2 px-6 rounded-xl hover:bg-blue-700 transition-colors"
          >
            Volver
          </button>
        </div>
      </div>
    );
  }

  // --- PANTALLA PRINCIPAL (SIN CAMBIOS) ---
  return (
    <>
      <div className="min-h-screen bg-gray-100">
        {/* Header */}
        <div className="bg-blue-600 text-white px-6 py-4 flex items-center gap-4">
          <button onClick={() => router.back()}>
            <ArrowLeft size={24} />
          </button>
          <h1 className="text-2xl font-bold">Historial de Movimientos</h1>
        </div>

        <div className="max-w-3xl mx-auto px-4">
          {/* Balance Card */}
          <div className="p-6">
            <div className="bg-white rounded-2xl p-5 shadow-sm flex items-center justify-between">
              <div>
                <p className="text-gray-600 text-sm mb-1">Saldo Actual</p>
                <p className="text-blue-600 text-3xl font-bold">
                  Bs. {walletData?.balance?.toFixed(2) || '0.00'}
                </p>
              </div>
              <Wallet size={32} className="text-blue-600 opacity-70" />
            </div>
          </div>

          {/* Todos los movimientos */}
          <div className="px-6 pb-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-gray-700 font-semibold text-lg">Todos los Movimientos</h2>
              
              {isFiltered ? (
                <button
                  onClick={clearFilter}
                  className="text-red-500 font-semibold text-sm"
                >
                  Eliminar Filtro
                </button>
              ) : (
                <button
                  onClick={() => setShowFilterModal(true)}
                  className="text-blue-600 font-semibold text-sm"
                >
                  Añadir Filtro
                </button>
              )}
            </div>
            
            {/* --- LISTA FILTRADA --- */}
            <div className="space-y-3">
              {filteredTransactions.length > 0 ? (
                filteredTransactions.map((tx) => (
                  <div key={tx._id} className="bg-white rounded-xl p-4 shadow-sm flex items-center gap-4">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ${
                      tx.amount > 0 ? 'bg-green-100' : 'bg-red-100'
                    }`}>
                      {tx.amount > 0 ? (
                        <TrendingUp className="text-green-600" size={20} />
                      ) : (
                        <TrendingDown className="text-red-600" size={20} />
                      )}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-semibold text-gray-900 truncate">
                        {tx.description}
                      </p>
                      <p className="text-sm text-gray-500">
                        {new Date(tx.createdAt).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}
                      </p>
                    </div>
                    <p className={`font-bold text-lg whitespace-nowrap ${
                      tx.amount > 0 ? 'text-green-600' : 'text-red-600'
                    }`}>
                      {tx.amount > 0 ? '+' : ''}{formatCurrency(tx.amount)}
                    </p>
                  </div>
                ))
              ) : (
                <div className="bg-white rounded-xl p-4 shadow-sm text-center text-gray-500 py-10">
                  <p>No se encontraron movimientos que coincidan con su filtro.</p>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* --- MODAL DE FILTRO (Aquí están las correcciones) --- */}
      {showFilterModal && (
        <FilterModal
          onClose={() => setShowFilterModal(false)}
          onApply={handleApplyFilter}
          currentFilters={filterSettings}
        />
      )}
    </>
  );
}


// ===================================================================
// --- Componente del Modal de Filtro (CORREGIDO) ---
// ===================================================================
// Componente del Modal de Filtro - VALIDACION MIENTRAS ESCRIBE
interface FilterModalProps {
  onClose: () => void;
  onApply: (settings: FilterSettings) => void;
  currentFilters: FilterSettings;
}

function FilterModal({ onClose, onApply, currentFilters }: FilterModalProps) {
  // Convertir YYYY-MM-DD a MM/DD/YYYY para mostrar
  const formatToDisplay = (isoDate: string): string => {
    if (!isoDate) return '';
    const [year, month, day] = isoDate.split('-');
    return `${month}/${day}/${year}`;
  };

  // Convertir MM/DD/YYYY a YYYY-MM-DD para guardar
  const formatToISO = (displayDate: string): string => {
    if (!displayDate || displayDate.length !== 10) return '';
    const parts = displayDate.split('/');
    if (parts.length !== 3) return '';
    const [month, day, year] = parts;
    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
  };

  const [fromDateDisplay, setFromDateDisplay] = useState(formatToDisplay(currentFilters.fromDate));
  const [toDateDisplay, setToDateDisplay] = useState(formatToDisplay(currentFilters.toDate));
  const [selectedTypes, setSelectedTypes] = useState<string[]>(currentFilters.type);
  const [dateError, setDateError] = useState<string | null>(null);

  const isValidDate = (month: number, day: number, year: number): boolean => {
    if (month < 1 || month > 12) return false;
    if (day < 1 || day > 31) return false;
    if (year < 1900 || year > 2100) return false;

    const d = new Date(year, month - 1, day);
    return (
      d.getFullYear() === year &&
      d.getMonth() + 1 === month &&
      d.getDate() === day
    );
  };

  const validateDateString = (dateStr: string, fieldName: string): string | null => {
    if (!dateStr) return null;
    
    if (dateStr.length !== 10) {
      return `La fecha "${fieldName}" esta incompleta. Use formato MM/DD/YYYY`;
    }

    const parts = dateStr.split('/');
    if (parts.length !== 3) {
      return `La fecha "${fieldName}" tiene formato incorrecto`;
    }

    const month = parseInt(parts[0], 10);
    const day = parseInt(parts[1], 10);
    const year = parseInt(parts[2], 10);

    if (isNaN(month) || isNaN(day) || isNaN(year)) {
      return `La fecha "${fieldName}" contiene valores no numericos`;
    }

    if (!isValidDate(month, day, year)) {
      if (month === 2 && day > 29) {
        return `Fecha invalida: Febrero solo tiene hasta 29 dias`;
      } else if ([4, 6, 9, 11].includes(month) && day > 30) {
        return `Fecha invalida: Este mes solo tiene 30 dias`;
      } else if (day > 31) {
        return `Fecha invalida: Ningun mes tiene mas de 31 dias`;
      } else if (month < 1 || month > 12) {
        return `Fecha invalida: El mes debe estar entre 01 y 12`;
      }
      return `La fecha "${fieldName}" no existe en el calendario`;
    }

    return null;
  };

  const handleTextInput = (
    value: string,
    setter: (val: string) => void,
    fieldName: string
  ) => {
    // Permitir solo numeros y /
    let cleaned = value.replace(/[^\d/]/g, '');
    
    // Auto-agregar / despues de MM y DD
    if (cleaned.length === 2 && !cleaned.includes('/')) {
      cleaned = cleaned + '/';
    } else if (cleaned.length === 5 && cleaned.split('/').length === 2) {
      cleaned = cleaned + '/';
    }
    
    // Limitar a 10 caracteres
    if (cleaned.length > 10) {
      cleaned = cleaned.substring(0, 10);
    }

    setter(cleaned);

    // Validar si esta completo
    if (cleaned.length === 10) {
      const error = validateDateString(cleaned, fieldName);
      console.log(`Validando ${cleaned}: ${error || 'VALIDA'}`);
      setDateError(error);
    } else {
      setDateError(null);
    }
  };

  const handleDatePickerChange = (
    e: React.ChangeEvent<HTMLInputElement>,
    setter: (val: string) => void,
    pickerSetter: (val: boolean) => void
  ) => {
    const isoDate = e.target.value;
    if (isoDate) {
      const displayDate = formatToDisplay(isoDate);
      setter(displayDate);
      pickerSetter(false);
      setDateError(null);
    }
  };

  const handleSubmit = () => {
    const fromError = validateDateString(fromDateDisplay, 'Desde');
    if (fromError) {
      setDateError(fromError);
      return;
    }
    
    const toError = validateDateString(toDateDisplay, 'Hasta');
    if (toError) {
      setDateError(toError);
      return;
    }

    const fromISO = formatToISO(fromDateDisplay);
    const toISO = formatToISO(toDateDisplay);

    if (fromISO && toISO) {
      const fromDateObj = new Date(fromISO + 'T00:00:00');
      const toDateObj = new Date(toISO + 'T00:00:00');
      
      if (fromDateObj > toDateObj) {
        setDateError("La fecha 'Desde' no puede ser posterior a 'Hasta'");
        return;
      }
    }
    
    if (!fromDateDisplay && !toDateDisplay && selectedTypes.length === 0) {
      setDateError("Selecciona al menos un criterio de filtro");
      return;
    }
    
    setDateError(null);
    onApply({ 
      fromDate: fromISO, 
      toDate: toISO, 
      type: selectedTypes 
    });
  };

  const handleTypeChange = (value: string) => {
    setSelectedTypes(prev => 
      prev.includes(value) ? prev.filter(t => t !== value) : [...prev, value]
    );
  };

  const hasError = (dateDisplay: string): boolean => {
    return dateDisplay.length === 10 && validateDateString(dateDisplay, '') !== null;
  };

  return (
    <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4">
      <div className="bg-white w-full max-w-md rounded-2xl shadow-xl relative overflow-hidden">
        
        <div className="bg-blue-600 text-white px-6 py-4 flex items-center justify-between">
          <h2 className="text-xl font-bold">Añadir Filtro</h2>
          <button onClick={onClose} className="text-white hover:text-gray-200">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>

        <div className="p-6">
          <h2 className="text-xl font-bold text-center text-gray-800 mb-6">
            Seleccione los campos para que se añada un filtro
          </h2>
          
          <div className="space-y-5">
            {/* Campo Desde */}
            <div className="flex items-center gap-4">
              <label className="w-16 font-semibold text-gray-700">Desde</label>
              <div className="relative flex-1">
                <input 
                  type="text"
                  placeholder="MM/DD/YYYY"
                  value={fromDateDisplay}
                  onChange={(e) => handleTextInput(e.target.value, setFromDateDisplay, 'Desde')}
                  maxLength={10}
                  className={`w-full p-3 pr-10 border-2 rounded-lg focus:outline-none focus:ring-2 ${
                    hasError(fromDateDisplay)
                      ? 'border-red-500 bg-red-50 focus:ring-red-500'
                      : 'border-gray-300 focus:ring-blue-500'
                  }`}
                />
                <input
                  type="date"
                  onChange={(e) => {
                    if (e.target.value) {
                      const displayDate = formatToDisplay(e.target.value);
                      setFromDateDisplay(displayDate);
                      setDateError(null);
                    }
                  }}
                  className="absolute right-2 top-1/2 -translate-y-1/2 opacity-0 w-8 h-8 cursor-pointer"
                  title="Abrir calendario"
                />
                <Calendar 
                  size={20} 
                  className={`absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none ${
                    hasError(fromDateDisplay) ? 'text-red-400' : 'text-gray-400'
                  }`} 
                />
              </div>
            </div>

            {/* Campo Hasta */}
            <div className="flex items-center gap-4">
              <label className="w-16 font-semibold text-gray-700">Hasta</label>
              <div className="relative flex-1">
                <input 
                  type="text"
                  placeholder="MM/DD/YYYY"
                  value={toDateDisplay}
                  onChange={(e) => handleTextInput(e.target.value, setToDateDisplay, 'Hasta')}
                  onFocus={() => setShowToPicker(false)}
                  maxLength={10}
                  className={`w-full p-3 pr-10 border-2 rounded-lg focus:outline-none focus:ring-2 ${
                    hasError(toDateDisplay)
                      ? 'border-red-500 bg-red-50 focus:ring-red-500'
                      : 'border-gray-300 focus:ring-blue-500'
                  }`}
                />
                <input
                  type="date"
                  onChange={(e) => {
                    if (e.target.value) {
                      const displayDate = formatToDisplay(e.target.value);
                      setToDateDisplay(displayDate);
                      setDateError(null);
                    }
                  }}
                  className="absolute right-2 top-1/2 -translate-y-1/2 opacity-0 w-8 h-8 cursor-pointer"
                  title="Abrir calendario"
                />
                <Calendar 
                  size={20} 
                  className={`absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none ${
                    hasError(toDateDisplay) ? 'text-red-400' : 'text-gray-400'
                  }`} 
                />
              </div>
            </div>
            
            <div className="flex items-start gap-4">
              <label className="w-16 font-semibold text-gray-700 pt-2">Incluir</label>
              <div className="flex-1 flex flex-col gap-2 pt-2">
                <label className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input 
                    type="checkbox" 
                    value="deposit"
                    checked={selectedTypes.includes('deposit')}
                    onChange={() => handleTypeChange('deposit')}
                    className="w-5 h-5 accent-blue-600"
                  />
                  <span className="font-medium text-gray-700">Recargas</span>
                </label>
                <label className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input 
                    type="checkbox" 
                    value="commission"
                    checked={selectedTypes.includes('commission')}
                    onChange={() => handleTypeChange('commission')}
                    className="w-5 h-5 accent-blue-600"
                  />
                  <span className="font-medium text-gray-700">Comisiones</span>
                </label>
              </div>
            </div>

            {dateError && (
              <div className="bg-red-50 border-2 border-red-400 rounded-lg p-4 flex gap-3">
                <AlertCircle className="text-red-600 flex-shrink-0" size={24} />
                <div>
                  <p className="text-red-800 font-bold text-sm">¡Error!</p>
                  <p className="text-red-700 text-sm">{dateError}</p>
                </div>
              </div>
            )}
            
            <div className="flex gap-4 pt-4"> 
              <button
                onClick={handleSubmit}
                disabled={!!dateError}
                className={`flex-1 px-6 py-3 rounded-lg font-semibold text-white ${
                  dateError
                    ? 'bg-gray-300 cursor-not-allowed'
                    : 'bg-blue-600 hover:bg-blue-700'
                }`}
              >
                Añadir Filtro
              </button>
              <button onClick={onClose} className="flex-1 px-6 py-3 rounded-lg font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200">
                Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/payment/PaymentMethodCashFixer.tsx">
'use client';
// src/Components/payment/PaymentMethodCashFixer.tsx
// Modal principal para confirmación de pagos en efectivo

import React, { useState, useEffect, useMemo } from 'react';
import { PaymentMethodCashFixerProps, Message, PaymentSummary } from '../../utils/types';
import { 
  fetchPaymentSummary, 
  confirmPayment, 
  isValidObjectId,
  formatTime,
  formatTimeWithHours 
} from '../../utils/paymentapi';
import PaymentSuccessModal from './PaymentSuccessModal';

export default function PaymentMethodCashFixer({ 
  trabajo, 
  onClose, 
  onBack 
}: PaymentMethodCashFixerProps) {
  const [codigoIngresado, setCodigoIngresado] = useState("");
  const [loading, setLoading] = useState(true);
  const [patching, setPatching] = useState(false);
  const [mainMessage, setMainMessage] = useState<Message | null>(null);
  const [showSuccessModal, setShowSuccessModal] = useState(false);
  const [summary, setSummary] = useState<PaymentSummary | null>(null);

  // Intentos y bloqueo
  const [remainingAttempts, setRemainingAttempts] = useState<number | null>(null);
  const [unlockAtISO, setUnlockAtISO] = useState<string | null>(null);
  const [now, setNow] = useState(Date.now());
  const [wasLocked, setWasLocked] = useState(false);

  // Expiración de Código
  const [codeExpired, setCodeExpired] = useState(false);
  const [codeExpiresAt, setCodeExpiresAt] = useState<string | null>(null);

  // Cálculo de tiempo restante para desbloqueo
  const msLeft = useMemo(() => {
    if (!unlockAtISO) return 0;
    const unlockMs = new Date(unlockAtISO).getTime();
    return Math.max(0, unlockMs - now);
  }, [unlockAtISO, now]);

  // Cálculo de tiempo hasta expiración
  const msUntilExpiration = useMemo(() => {
    if (!codeExpiresAt) return 0;
    const expiresMs = new Date(codeExpiresAt).getTime();
    return Math.max(0, expiresMs - now);
  }, [codeExpiresAt, now]);

  // Timer para actualizar tiempo actual
  useEffect(() => {
    if (!unlockAtISO && !codeExpiresAt) return;
    const t = setInterval(() => setNow(Date.now()), 1000);
    return () => clearInterval(t);
  }, [unlockAtISO, codeExpiresAt]);

  const minutesLeft = Math.floor(msLeft / 60000);
  const secondsLeft = Math.floor((msLeft % 60000) / 1000);

  const hoursUntilExpiration = Math.floor(msUntilExpiration / 3600000);
  const minutesUntilExpiration = Math.floor((msUntilExpiration % 3600000) / 60000);
  const secondsUntilExpiration = Math.floor((msUntilExpiration % 60000) / 1000);

  const locked = !!unlockAtISO && msLeft > 0;

  // Detectar cuando se desbloquea
  useEffect(() => {
    if (wasLocked && !locked && unlockAtISO) {
      console.log("🔓 Cuenta desbloqueada");
      setMainMessage({
        type: 'success',
        text: '🔓 El periodo de bloqueo de 10 minutos ha finalizado. Ya puedes intentar nuevamente.'
      });
      setUnlockAtISO(null);
      setTimeout(() => setMainMessage(null), 5000);
    }
    if (locked) setWasLocked(true);
  }, [locked, unlockAtISO, wasLocked]);

  // Manejo de cambio de código
  const handleCodigoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value.toUpperCase();
    const filtered = value.replace(/[^A-Z0-9]/g, '').slice(0, 6);
    setCodigoIngresado(filtered);
  };

  // Cargar resumen del pago
  async function loadSummary() {
    if (!trabajo?.jobId) {
      setMainMessage({ type: 'error', text: 'No hay paymentId para consultar.' });
      setLoading(false);
      return;
    }

    setMainMessage(null);
    setRemainingAttempts(null);
    setUnlockAtISO(null);
    setLoading(true);
    console.log('🔍 Cargando summary para:', trabajo.jobId);

    try {
      const isObjectId = isValidObjectId(trabajo.jobId);
      
      if (isObjectId) {
        const data = await fetchPaymentSummary(trabajo.jobId);

        // Verificar expiración
        if (data.codeExpired && !codeExpired) {
          console.log("🔴 CÓDIGO EXPIRADO detectado");
          setCodeExpired(true);
          setMainMessage({
            type: 'warning',
            text: '⏱️ El código ha expirado. Solicite al cliente que genere un nuevo código desde su vista para continuar con el pago.'
          });
        } else if (!data.codeExpired && codeExpired) {
          console.log("✅ Código renovado");
          setCodeExpired(false);
          setMainMessage(null);
        }

        if (data.codeExpiresAt) {
          setCodeExpiresAt(data.codeExpiresAt);
        }

        setSummary(data);
      } else {
        // Simulación para IDs no válidos
        await new Promise(r => setTimeout(r, 500));
        setSummary({
          id: trabajo.jobId,
          code: null,
          status: trabajo.paymentStatus || "pending",
          amount: { total: trabajo.totalPagar || 0, currency: "BOB" },
        });
      }
    } catch (e: unknown) {
      console.error('❌ Error:', e);
      setMainMessage({ type: 'error', text: e.message });
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    loadSummary();
  }, [trabajo?.jobId]);

  // Verificación automática de expiración
  useEffect(() => {
    if (!codeExpiresAt || codeExpired) return;

    const checkExpiration = () => {
      const expiresMs = new Date(codeExpiresAt).getTime();
      const nowMs = Date.now();

      if (nowMs >= expiresMs && !codeExpired) {
        console.log("🔴 CÓDIGO EXPIRADO detectado por auto-check");
        setCodeExpired(true);
        setMainMessage({
          type: 'warning',
          text: '⏱️ El código ha expirado. Solicite al cliente que genere un nuevo código desde su vista para continuar con el pago.'
        });
      }
    };

    checkExpiration();
    const interval = setInterval(checkExpiration, 1000);
    return () => clearInterval(interval);
  }, [codeExpiresAt, codeExpired]);

  // Confirmar pago
  const handleContinuar = async () => {
    if (!summary) return;

    const code = codigoIngresado.trim();
    if (!code) {
      setMainMessage({ type: 'error', text: 'Por favor, ingrese el código de 6 caracteres.' });
      return;
    }
    if (code.length !== 6) {
      setMainMessage({ type: 'error', text: 'El código debe tener exactamente 6 caracteres.' });
      return;
    }

    setMainMessage(null);
    setRemainingAttempts(null);
    setUnlockAtISO(null);
    setPatching(true);

    try {
      const isObjectId = isValidObjectId(summary.id);
      
      if (isObjectId) {
        const { res, resp } = await confirmPayment(summary.id, code);
        
        if (res.ok) {
          console.log("✅ Pago confirmado exitosamente");
          setShowSuccessModal(true);
          await loadSummary();
          setCodigoIngresado('');
          return;
        }
        
        // Manejo de errores específicos
        if (res.status === 429) {
          if (resp.unlocksAt) setUnlockAtISO(String(resp.unlocksAt));
          else if (resp.waitMinutes) {
            const unlockDate = new Date(Date.now() + Number(resp.waitMinutes) * 60000);
            setUnlockAtISO(unlockDate.toISOString());
          }
          setMainMessage({ 
            type: 'error', 
            text: '🔒 Has superado el número máximo de intentos (3). La cuenta está bloqueada temporalmente por 10 minutos.' 
          });
          return;
        }
        
        if (res.status === 401) {
          const attempts = Number(resp.remainingAttempts);
          if (!Number.isNaN(attempts)) {
            setRemainingAttempts(attempts);
            setMainMessage({
              type: 'error',
              text: `❌ Código inválido. Te quedan ${attempts} intento${attempts !== 1 ? 's' : ''}.`
            });
          } else {
            setMainMessage({ type: 'error', text: '❌ Código inválido.' });
          }
          return;
        }
        
        if (res.status === 410) {
          setCodeExpired(true);
          setMainMessage({
            type: 'warning',
            text: '⏱️ El código ha expirado. Solicite al cliente que genere un nuevo código.'
          });
          return;
        }
        
        if (res.status === 404) {
          setMainMessage({ type: 'error', text: 'Pago no encontrado' });
          return;
        }
        
        if (res.status === 409) {
          setMainMessage({ type: 'error', text: 'El pago ya fue procesado' });
          return;
        }
        
        setMainMessage({ type: 'error', text: resp?.error || `Error ${res.status}` });
      } else {
        // Simulación
        await new Promise(r => setTimeout(r, 1000));
        setShowSuccessModal(true);
        setCodigoIngresado('');
      }
    } catch (e: unknown) {
      setMainMessage({ type: 'error', text: e.message });
    } finally {
      setPatching(false);
    }
  };

  // Renderizado condicional: Modal de éxito
  if (showSuccessModal) {
    return (
      <PaymentSuccessModal 
        onClose={() => { 
          setShowSuccessModal(false); 
          onClose(true); 
        }} 
      />
    );
  }

  // Renderizado condicional: Loading
  if (loading) {
    return (
      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div className="bg-[#F9FAFB] rounded-lg shadow-xl px-8 py-6">
          <div className="flex flex-col items-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#2B31E0] mb-4"></div>
            <p className="text-[#111827]">Cargando datos del pago…</p>
          </div>
        </div>
      </div>
    );
  }

  if (!summary) return null;

  // Componente de mensaje (alerta)
  const MessageAlert = ({ message }: { message: Message }) => (
    <div className="mb-6 max-w-xl mx-auto">
      <div className={`border-l-4 p-4 rounded ${
        message.type === 'error' ? 'bg-red-50 border-[#EF4444]' :
        message.type === 'warning' ? 'bg-amber-50 border-[#F59E0B]' :
        message.type === 'success' ? 'bg-green-50 border-[#16A34A]' :
        'bg-blue-50 border-[#759AE0]'
      }`}>
        <div className="flex items-start">
          <div className="flex-shrink-0">
            <svg className={`h-5 w-5 mt-0.5 ${
              message.type === 'error' ? 'text-[#EF4444]' :
              message.type === 'warning' ? 'text-[#F59E0B]' :
              message.type === 'success' ? 'text-[#16A34A]' :
              'text-[#759AE0]'
            }`} viewBox="0 0 20 20" fill="currentColor">
              {message.type === 'success' ? (
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
              ) : message.type === 'error' ? (
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
              ) : (
                <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
              )}
            </svg>
          </div>
          <div className="ml-3 flex-1">
            <p className={`text-sm font-medium ${
              message.type === 'error' ? 'text-red-800' :
              message.type === 'warning' ? 'text-amber-800' :
              message.type === 'success' ? 'text-green-800' :
              'text-blue-800'
            }`}>
              {message.text}
            </p>
          </div>
        </div>
      </div>
    </div>
  );

  // Renderizado principal
  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-[#F9FAFB] w-full max-w-2xl rounded-lg shadow-xl max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="bg-[#2B31E0] text-[#F9FAFB] px-6 py-4 flex items-center justify-between rounded-t-lg">
          <h1 className="text-xl font-semibold">Método de pago Efectivo — Vista FIXER</h1>
          <button 
            onClick={() => onClose()} 
            className="hover:bg-[#2B6AE0] px-3 py-1 rounded text-xl transition-colors"
          >
            ✕
          </button>
        </div>

        {/* Body */}
        <div className="px-8 py-12">
          <h2 className="text-2xl font-bold text-[#111827] text-center mb-12">
            Confirmación del pago recibido
          </h2>

          {/* Mensajes */}
          {mainMessage && <MessageAlert message={mainMessage} />}

          {/* Bloqueo temporal */}
          {locked && (
            <div className="mb-6 max-w-xl mx-auto">
              <div className="bg-red-50 border border-[#EF4444] rounded p-3">
                <p className="text-red-700 text-sm font-medium text-center">
                  🔒 Cuenta bloqueada. Intenta en: <b className="text-lg">
                    {minutesLeft > 0 ? `${minutesLeft}m ` : ""}{secondsLeft}s
                  </b>
                </p>
              </div>
            </div>
          )}

          {/* Temporizador de expiración */}
          {!codeExpired && codeExpiresAt && msUntilExpiration > 0 && (
            <div className="mb-6 max-w-xl mx-auto">
              <div className="bg-blue-50 border border-[#759AE0] rounded p-3">
                <p className="text-blue-700 text-sm text-center">
                  ⏰ Código válido por: <b>
                    {hoursUntilExpiration > 0 && `${hoursUntilExpiration}h `}
                    {minutesUntilExpiration}m {secondsUntilExpiration}s
                  </b>
                </p>
              </div>
            </div>
          )}

          {/* Formulario */}
          <div className="space-y-6 max-w-xl mx-auto">
            <div className="flex items-center gap-6">
              <label className="text-lg font-semibold text-[#111827] w-48 text-left">
                Código de Trabajo
              </label>
              <input
                type="text"
                value={codigoIngresado}
                onChange={handleCodigoChange}
                placeholder="CODIGO"
                disabled={patching || locked || codeExpired}
                maxLength={6}
                className="flex-1 px-4 py-3 bg-white disabled:bg-[#E5E7EB] border-2 border-[#759AE0] rounded-md text-[#111827] text-lg focus:outline-none focus:ring-2 focus:ring-[#759AE0] disabled:cursor-not-allowed uppercase"
              />
            </div>

            <div className="flex items-center gap-6">
              <label className="text-lg font-semibold text-[#111827] w-48 text-left">
                Monto a Cobrar
              </label>
              <input
                type="text"
                value={`${summary.amount.total.toFixed(2)} ${summary.amount.currency}`}
                readOnly
                className="flex-1 px-4 py-3 bg-[#E5E7EB] border border-[#D1D5DB] rounded-md text-[#111827] text-lg"
              />
            </div>

            <div className="flex items-center gap-6">
              <label className="text-lg font-semibold text-[#111827] w-48 text-left">
                Estado
              </label>
              <input
                type="text"
                value={
                  summary.status === 'paid' ? 'CONFIRMADO' : 
                  summary.status === 'failed' ? 'ERROR' : 
                  'PENDIENTE'
                }
                readOnly
                className="flex-1 px-4 py-3 bg-[#E5E7EB] border border-[#D1D5DB] rounded-md text-[#111827] text-lg"
              />
            </div>
          </div>

          {/* Botones */}
          <div className="flex justify-center gap-6 mt-12">
            <button
              onClick={handleContinuar}
              disabled={!codigoIngresado || patching || locked || codeExpired}
              className={`px-12 py-3 text-lg font-semibold rounded-md transition-colors ${
                !codigoIngresado || patching || locked || codeExpired
                  ? "bg-[#D1D5DB] text-[#64748B] cursor-not-allowed"
                  : "bg-[#2B31E0] hover:bg-[#2B6AE0] text-[#F9FAFB]"
              }`}
            >
              {patching ? "Confirmando…" : 
               locked ? "Bloqueado" : 
               codeExpired ? "Código Expirado" : 
               "Confirmar Pago Recibido"}
            </button>
            <button
              onClick={() => onBack({ refresh: true })}
              disabled={patching}
              className="px-12 py-3 bg-[#2BDDE0] text-[#111827] text-lg font-semibold rounded-md hover:bg-[#5E2BE0] transition-colors disabled:opacity-60"
            >
              Volver
            </button>
          </div>

          {/* ID del pago */}
          <div className="mt-6 text-center text-sm text-gray-500">
            ID pago: <span className="font-mono text-[#64748B]">{summary.id}</span>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/payment/PayWithQr.tsx">
"use client";

import { useEffect, useState } from "react";
import BackButton from "./BackButton";

// Tipos
type PaymentStatus = "pending" | "under_review" | "confirmed" | "rejected" | "expired";

type Intent = {
  _id: string;
  bookingId: string;
  providerId: string;
  amountExpected: number;
  currency: string;
  paymentReference: string;
  status: PaymentStatus;
  deadlineAt?: string;
  createdAt?: string;
};

type PaymentMethod = {
  qrImageUrl?: string;
  accountDisplay?: string;
};

// URL del backend
const BACKEND_URL =
  process.env.NEXT_PUBLIC_API_BASE_URL ||
  process.env.NEXT_PUBLIC_BACKEND_URL ||
  "http://localhost:8000";

export default function PayWithQr() {
  const [intent, setIntent] = useState<Intent | null>(null);
  const [method, setMethod] = useState<PaymentMethod | null>(null);
  const [loading, setLoading] = useState(true);

  // error “duro” (cuando de verdad no se puede generar el pago)
  const [error, setError] = useState<string | null>(null);
  // aviso de negocio (por ejemplo: NO_QR)
  const [warning, setWarning] = useState<string | null>(null);

  // Para la demo usamos valores fijos (los mismos que ya está pasando el modal)
  const bookingId = "TEST-BOOKING-1";
  const providerId = "DEMO-PROVIDER";
  const amount = 215; // BOB
  const currency = "BOB";

  // Helper para formatear moneda
  const money = (n: number) =>
    n.toLocaleString("es-BO", { style: "currency", currency });

  // Estado para la imagen del QR
  const [imgSrc, setImgSrc] = useState<string | null>(null);

  const toDriveThumb = (url: string) => {
    const m = url.match(/id=([^&]+)/);
    return m ? `https://drive.google.com/thumbnail?id=${m[1]}&sz=w512` : url;
  };

  const fallbackQR = `https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodeURIComponent(
    "Servineo QR"
  )}`;

  useEffect(() => {
    (async () => {
      try {
        setLoading(true);
        setError(null);
        setWarning(null);

        const payload = { bookingId, providerId, amount, currency };
        console.log("→ POST /api/payments/intent payload =", payload);
        console.log("BACKEND_URL =", BACKEND_URL);

        const res = await fetch(`${BACKEND_URL}/api/payments/intent`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        console.log("← status", res.status);
        console.log("← body", data);

        if (!res.ok) {
          // Respuesta 5xx / 4xx -> error duro
          const msg =
            data?.message || data?.error || `Error HTTP ${res.status}`;
          throw new Error(msg);
        }

        // Éxito -> limpiamos error duro
        setError(null);
        setIntent(data.intent || null);
        setMethod(data.paymentMethod || null);

        // Si el backend mandara un código de negocio
        if (data.error === "NO_QR") {
          setWarning("El proveedor no tiene QR configurado.");
        } else {
          setWarning(null);
        }
      } catch (e: unknown) {
        console.error("❌ Error creando intent:", e);
        setError(
          e?.message === "SERVER_ERROR"
            ? "Ocurrió un problema al generar el pago. Intenta nuevamente."
            : e?.message || "Error al conectar con el servidor."
        );
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  // Actualizar imagen del QR cuando llegue el método
  useEffect(() => {
    if (method?.qrImageUrl) {
      setImgSrc(method.qrImageUrl);
    } else {
      setImgSrc(null);
    }
  }, [method]);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <p>Cargando…</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white">
      {/* Barra superior */}
      <header className="bg-[#2B6AE0]">
        <div className="max-w-5xl px-6 py-6">
          <h1 className="text-5xl font-semibold text-white">Pagos con QR</h1>
        </div>
      </header>

      <BackButton
        fallback="/payment"
        className="fixed bottom-4 right-4 z-50"
      />

      <main className="max-w-5xl mx-auto p-6">
        {/* Mensajes */}
        {warning && (
          <p className="text-center text-red-500 font-semibold mb-3">
            {warning}
          </p>
        )}

        {/* Solo mostramos el error “duro” si NO tenemos intent */}
        {error && !intent && (
          <p className="text-center text-red-500 font-semibold mb-3">
            {error}
          </p>
        )}

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
          {/* COLUMNA IZQUIERDA: Información de pago */}
          <section className="md:-ml-35">
            <h2 className="text-4xl font-semibold mb-3 text-black">
              Información de pago
            </h2>

            <div className="my-2">
              <hr className="w-150 border-t-2 border-[#2B6AE0]" />
            </div>

            <dl className="space-y-6 text-black">
              {/* Destinatario */}
              <div className="relative min-h-8">
                <dt className="text-2xl font-medium inline-block w-[200px] text-left">
                  Destinatario:
                </dt>
                <dd className="text-2xl leading-tight absolute top-0.5 left-[280px]">
                  {method?.accountDisplay || "—"}
                </dd>
              </div>

              {/* Número de Transacción */}
              <div className="relative min-h-8">
                <dt className="text-2xl font-medium inline-block w-[220px] text-left">
                  Nro de Transacción:
                </dt>
                <dd className="text-2xl leading-tight absolute top-0.5 left-[280px]">
                  {intent?.paymentReference || "—"}
                </dd>
              </div>

              {/* Subtotal */}
              <div className="relative min-h-8">
                <dt className="text-2xl font-medium inline-block w-[200px] text-left">
                  Sub Total:
                </dt>
                <dd className="text-2xl leading-tight absolute top-0 left-[280px]">
                  {intent
                    ? money(Math.round(intent.amountExpected * 0.97))
                    : "—"}
                </dd>
              </div>

              {/* Comisión */}
              <div className="relative min-h-8">
                <dt className="text-2xl font-medium inline-block w-[160px] text-left">
                  Comisión:
                </dt>
                <dd className="text-2xl leading-tight absolute top-0 left-[280px]">
                  {intent
                    ? money(Math.round(intent.amountExpected * 0.03))
                    : "—"}
                </dd>
              </div>

              {/* Total */}
              <div className="relative min-h-8">
                <dt className="text-2xl font-semibold inline-block w-[160px] text-left">
                  Total:
                </dt>
                <dd className="text-2xl font-semibold leading-tight absolute top-0 left-[280px]">
                  {intent ? money(intent.amountExpected) : "—"}
                </dd>
              </div>

              <div className="my-5">
                <hr className="w-150 border-t-2 border-[#2B6AE0]" />
              </div>

              {/* Estado */}
              <div className="relative min-h-8">
                <dt className="text-2xl font-medium inline-block w-[160px] text-left">
                  Estado:
                </dt>
                <dd className="text-2xl leading-tight absolute top-0 left-0 translate-x-[280px]">
                  {intent?.status ? intent.status.toUpperCase() : "—"}
                </dd>
              </div>

              <div className="my-6">
                <hr className="w-150 border-t-2 border-[#2B6AE0]" />
              </div>
            </dl>
          </section>

          {/* COLUMNA DERECHA: QR */}
          <aside className="bg-[#759AE0] rounded-xl p-5 md:justify-self-end w-full md:w-[420px] md:ml-16 md:self-center">
            <h3 className="text-2xl font-semibold text-gray-900 mb-4 text-center">
              Escanea el código QR
            </h3>

            <div className="h-64 w-full rounded-lg bg-gray-200 flex items-center justify-center">
              {imgSrc ? (
                <img
                  src={imgSrc}
                  alt="QR de pago"
                  className="max-h-60 object-contain"
                  referrerPolicy="no-referrer"
                  onError={() => {
                    if (
                      imgSrc.includes("drive.google.com") &&
                      !imgSrc.includes("/thumbnail")
                    ) {
                      setImgSrc(toDriveThumb(imgSrc));
                    } else {
                      setImgSrc(fallbackQR);
                    }
                  }}
                />
              ) : (
                <img
                  src={fallbackQR}
                  alt="QR de pago (fallback)"
                  className="max-h-60 object-contain"
                />
              )}
            </div>
          </aside>
        </div>
      </main>
    </div>
  );
}
</file>

<file path="src/Components/payment/RecentEarningsModal.tsx">
//src/Components/payment/RecentEarningsModal.tsx
'use client';
import React, { useState, useEffect } from 'react';
import { Filter, Loader2, AlertCircle } from 'lucide-react';
import EarningsFilterModal from './EarningsFilterModal';

type Props = {
  onClose: () => void;
  fixerId?: string;
};

export default function RecentEarningsModal({ onClose, fixerId: propFixerId }: Props) {
  const [fixerId, setFixerId] = useState<string | null>(null);
  const [showFilterModal, setShowFilterModal] = useState(false);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [currentData, setCurrentData] = useState<{ label: string; value: number }[]>([]);
  const [currentTotal, setCurrentTotal] = useState(0);

  useEffect(() => {
    console.log("🔍 Intentando obtener fixerId...");
    
    if (propFixerId) {
      console.log("✅ fixerId obtenido de props:", propFixerId);
      setFixerId(propFixerId);
      return;
    }
    
    if (typeof window !== 'undefined') {
      try {
        const reduxState = (window as unknown).__REDUX_DEVTOOLS_EXTENSION__?.store?.getState?.();
        if (reduxState?.fixer?.id || reduxState?.fixer?._id) {
          const id = reduxState.fixer.id || reduxState.fixer._id;
          console.log("✅ fixerId obtenido de Redux:", id);
          setFixerId(id);
          return;
        }

        if (reduxState?.user?.id || reduxState?.user?._id) {
          const id = reduxState.user.id || reduxState.user._id;
          console.log("✅ fixerId obtenido de Redux user:", id);
          setFixerId(id);
          return;
        }
        
        const possibleKeys = ['user', 'fixer', 'auth', 'userData'];
        for (const key of possibleKeys) {
          const stored = localStorage.getItem(key);
          if (stored) {
            try {
              const data = JSON.parse(stored);
              const id = data.id || data._id || data.fixerId || data.userId;
              if (id) {
                console.log(`✅ fixerId obtenido de localStorage.${key}:`, id);
                setFixerId(id);
                return;
              }
            } catch (e) {
              // Continuar
            }
          }
        }
        
        console.error("❌ No se encontró fixerId en ningún lugar");
        setError("No se pudo obtener tu ID de usuario");
        setLoading(false);
      } catch (error) {
        console.error("❌ Error al obtener fixerId:", error);
        setError("Error al obtener información de usuario");
        setLoading(false);
      }
    }
  }, [propFixerId]);
  
  const getDefaultDates = () => {
    const to = new Date();
    const from = new Date();
    from.setDate(from.getDate() - 6);
    
    return {
      from: from.toISOString().split('T')[0],
      to: to.toISOString().split('T')[0],
    };
  };

  const [dateRange, setDateRange] = useState(getDefaultDates());

  const formatDateLabel = (dateStr: string): string => {
    const date = new Date(dateStr + 'T00:00:00');
    const day = date.getDate();
    const month = date.toLocaleDateString('es-ES', { month: 'short' });
    return `${day} ${month}`;
  };

  const fetchEarnings = async (from: string, to: string) => {
    setLoading(true);
    setError(null);
    
    const BACKEND_URL = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000';
    
    try {
      const url = `${BACKEND_URL}/api/lab/earnings/${fixerId}?fromDate=${from}&toDate=${to}`;
      console.log("📊 Cargando ganancias desde:", url);
      
      const res = await fetch(url);
      
      if (!res.ok) {
        let errorMessage = "Error al cargar ganancias";
        try {
          const errData = await res.json();
          errorMessage = errData.error || errData.message || errorMessage;
        } catch (parseError) {
          // Ignorar
        }
        throw new Error(errorMessage);
      }

      const result = await res.json();
      console.log("📦 Datos recibidos:", result);
      
      if (result.success && result.data) {
        const transformedData = result.data.earningsByDay.map((item: unknown) => ({
          label: formatDateLabel(item.date),
          value: item.total
        }));
        
        console.log("✅ Datos transformados:", transformedData);
        
        setCurrentData(transformedData);
        setCurrentTotal(result.data.totalEarnings);
      } else {
        throw new Error("Estructura de datos incorrecta del servidor");
      }
    } catch (err: unknown) {
      console.error("❌ Error:", err);
      setError(err.message || "Error inesperado al cargar datos");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (fixerId) {
      fetchEarnings(dateRange.from, dateRange.to);
    }
  }, [fixerId]);

  if (!fixerId) {
    return (
      <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
        <div className="bg-white rounded-2xl shadow-2xl w-[90%] max-w-3xl p-8">
          <div className="text-center">
            <AlertCircle className="text-red-500 mx-auto mb-4" size={48} />
            <h3 className="text-xl font-bold text-gray-800 mb-2">Sesión no encontrada</h3>
            <p className="text-gray-600 mb-4">
              No pudimos obtener tu información de usuario. Por favor, inicia sesión nuevamente.
            </p>
            <button
              onClick={onClose}
              className="px-6 py-2 bg-[#2c6ef7] hover:bg-[#1f5ad6] text-white font-semibold rounded-lg transition-colors"
            >
              Cerrar
            </button>
          </div>
        </div>
      </div>
    );
  }

  const handleApplyFilter = async (from: string, to: string) => {
    setDateRange({ from, to });
    await fetchEarnings(from, to);
    setShowFilterModal(false);
  };

  const limitedData = currentData.slice(0, 7);
  const maxVal = Math.max(...limitedData.map((d) => d.value), 1);
  
  const calculateYAxis = (max: number) => {
    let step: number;
    
    if (max <= 10) {
      step = 2;
    } else if (max <= 25) {
      step = 5;
    } else if (max <= 50) {
      step = 10;
    } else if (max <= 100) {
      step = 20;
    } else if (max <= 250) {
      step = 50;
    } else if (max <= 500) {
      step = 100;
    } else if (max <= 1000) {
      step = 200;
    } else {
      step = 500;
    }
    
    const maxTick = Math.ceil(max / step) * step;
    
    const ticks = [];
    for (let i = 0; i <= maxTick; i += step) {
      ticks.push(i);
    }
    
    console.log("📐 Eje Y:", { max, step, maxTick, ticks });
    
    return { step, maxTick, ticks };
  };
  
  const { maxTick, ticks: yTicks } = calculateYAxis(maxVal);
  const isEmpty = !limitedData.length || limitedData.every((d) => d.value === 0);

  if (loading) {
    return (
      <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
        <div className="bg-white rounded-2xl shadow-2xl w-[90%] max-w-3xl p-12">
          <div className="flex flex-col items-center justify-center">
            <Loader2 className="animate-spin text-[#2c6ef7] mb-4" size={48} />
            <p className="text-lg text-gray-600">Cargando tus ganancias...</p>
          </div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
        <div className="bg-white rounded-2xl shadow-2xl w-[90%] max-w-3xl p-8">
          <div className="text-center">
            <AlertCircle className="text-red-500 mx-auto mb-4" size={48} />
            <h3 className="text-xl font-bold text-gray-800 mb-2">Error al cargar ganancias</h3>
            <p className="text-gray-600 mb-4">{error}</p>
            <div className="flex gap-3 justify-center">
              <button
                onClick={() => fetchEarnings(dateRange.from, dateRange.to)}
                className="px-6 py-2 bg-[#2c6ef7] hover:bg-[#1f5ad6] text-white font-semibold rounded-lg transition-colors"
              >
                Reintentar
              </button>
              <button
                onClick={onClose}
                className="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg transition-colors"
              >
                Cerrar
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <>
      <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
        <div className="bg-white rounded-2xl shadow-2xl w-[90%] max-w-3xl p-6 relative font-['Roboto']">
          <div className="flex justify-between items-start mb-4">
            <h2 className="text-2xl sm:text-3xl font-semibold text-gray-700">Tus Ingresos Recientes</h2>
            
            <div className="flex items-center gap-3">
              <div className="bg-[#2c6ef7] text-white px-4 py-2 rounded-md text-lg font-semibold">
                Ganancias: {currentTotal}
              </div>
              
              <button
                onClick={() => setShowFilterModal(true)}
                className="flex items-center gap-2 px-5 py-2 bg-[#2c6ef7] hover:bg-[#1f5ad6] text-white font-semibold rounded-md shadow-sm transition-colors"
              >
                <Filter size={18} />
                Filtros
              </button>
            </div>
          </div>

          {isEmpty ? (
            <div className="bg-[#f3f5fb] border border-[#d6dcf2] rounded-xl p-10 text-center shadow-inner">
              <p className="text-xl sm:text-2xl font-semibold text-[#2c6ef7] mb-10">
                Aun no tienes transacciones completadas en este período
              </p>
              <div className="flex justify-center gap-3">
                <button
                  onClick={() => setShowFilterModal(true)}
                  className="px-8 py-3 bg-[#2c6ef7] hover:bg-[#1f5ad6] text-white font-semibold rounded-lg shadow-sm transition-colors"
                >
                  Cambiar Fechas
                </button>
                <button
                  onClick={onClose}
                  className="px-8 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg shadow-sm transition-colors"
                >
                  Cerrar
                </button>
              </div>
            </div>
          ) : (
            <div className="relative bg-white border border-gray-200 rounded-lg p-6">
              <div className="absolute left-3 top-1/2 -translate-y-1/2 -rotate-90 origin-left text-sm font-semibold text-gray-700">
                Ganancias (Bs)
              </div>
              <div className="ml-12">
                <div className="relative" style={{ height: '352px' }}>
                  {/* Contenedor del gráfico */}
                  <div className="absolute left-0 right-0" style={{ top: 0, bottom: '32px', transform: 'translateY(-15px)' }}>
                    {/* Líneas del eje Y */}
                    {yTicks.map((tick) => {
                      const bottomPct = (tick / maxTick) * 100;
                      return (
                        <div
                          key={tick}
                          className="absolute left-0 right-0 flex items-center"
                          style={{ bottom: `${bottomPct}%` }}
                        >
                          <span className="text-sm font-medium text-gray-600 w-12 -ml-14 text-right">{tick}</span>
                          <div className="flex-1 border-t border-gray-300" />
                        </div>
                      );
                    })}

                    {/* Barras */}
                    <div className="absolute inset-0 flex items-end justify-around gap-4" style={{ transform: 'translateY(-10px)' }}>
                      {limitedData.map((item, index) => {
                        const heightPx = (item.value / maxTick) * 100;
                        console.log(`📊 ${item.label}: ${item.value}Bs / ${maxTick} = ${heightPx.toFixed(1)}%`);
                        
                        return (
                          <div key={index} className="flex items-end group relative" style={{ width: '80px', height: '100%' }}>
                            <div className="absolute bottom-full mb-3 hidden group-hover:block bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap z-10 shadow-lg">
                              <p className="font-bold text-base">Bs. {item.value.toFixed(2)}</p>
                              <p className="text-xs opacity-80">{item.label}</p>
                            </div>
                            
                            <div
                              className="w-full bg-gradient-to-t from-[#2c6ef7] to-[#4d8aff] rounded-t-lg transition-all hover:from-[#1f5ad6] hover:to-[#3d7aef] shadow-md hover:shadow-lg cursor-pointer"
                              style={{ 
                                height: `${heightPx}%`,
                                minHeight: heightPx > 0 ? '3px' : '0'
                              }}
                            />
                          </div>
                        );
                      })}
                    </div>
                  </div>
                  
                  {/* Etiquetas de fechas */}
                  <div className="absolute left-0 right-0 flex justify-around gap-4" style={{ bottom: '-8px', height: '32px', paddingTop: '8px' }}>
                    {limitedData.map((item, index) => (
                      <div key={`label-${index}`} style={{ width: '80px' }} className="flex justify-center">
                        <span className="text-sm font-bold text-gray-800">{item.label}</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}

          <div className="flex justify-center mt-6">
            <button
              onClick={onClose}
              className="px-8 py-3 bg-[#2c6ef7] hover:bg-[#1f5ad6] text-white font-semibold rounded-lg shadow-sm transition-colors"
            >
              Aceptar
            </button>
          </div>
        </div>
      </div>

      {showFilterModal && (
        <EarningsFilterModal
          currentFrom={dateRange.from}
          currentTo={dateRange.to}
          onApply={handleApplyFilter}
          onClose={() => setShowFilterModal(false)}
        />
      )}
    </>
  );
}
</file>

<file path="src/Components/payment/WalletDashboardClient.tsx">
// src/app/payment/pages/FixerWallet/WalletDashboardClient.tsx
"use client";

import { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import Link from 'next/link';
import { Wallet, TrendingUp, TrendingDown, Loader2, AlertCircle } from 'lucide-react';

// --- Interfaces para los datos ---
interface WalletData {
  balance: number;
  currency: string;
}

interface Transaction {
  _id: string;
  type: string;
  amount: number;
  description: string;
  jobId?: string;
  createdAt: string;
}

export default function FixerWalletDashboard() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [receivedFixerId, setReceivedFixerId] = useState<string | null>(null);
  
  // --- Estados para datos reales ---
  const [walletData, setWalletData] = useState<WalletData | null>(null);
  const [transactions, setTransactions] = useState<Transaction[]>([]); 
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    // Lee el fixerId de la URL
    const fixerId = searchParams.get('fixerId');
    if (fixerId) {
      setReceivedFixerId(fixerId);
      console.log("Fixer ID Recibido en Wallet:", fixerId);
      fetchWalletData(fixerId); 
    } else {
      console.warn("No se recibió fixerId en la URL.");
      setError("No se proporcionó un ID de Fixer.");
      setLoading(false);
    }
  }, [searchParams]);
  
  // --- FUNCIÓN DE FETCH CORREGIDA ---
  const fetchWalletData = async (fixerId: string) => {
    setLoading(true);
    setError(null);
    
    // 🟢 CORRECCIÓN: Usar variable de entorno para que funcione en Vercel y Render
    const BACKEND_URL = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000';

    try {
      console.log(`📡 Conectando a: ${BACKEND_URL}/api/fixer/payment-center/${fixerId}`);

      // 🟢 Usamos la URL dinámica
      const res = await fetch(`${BACKEND_URL}/api/fixer/payment-center/${fixerId}`);
      
      if (!res.ok) {
        // Intentamos leer el error JSON, si falla devolvemos un objeto vacío
        const errData = await res.json().catch(() => ({}));
        throw new Error(errData.error || `Error ${res.status}: No se pudo conectar al servidor`);
      }
      
      const result = await res.json();

      if (result.success && result.data) {
        // Establece el saldo de la wallet
        setWalletData({
          balance: result.data.saldoActual,
          currency: "BOB"
        });
        
        // Cargar transacciones
        setTransactions(result.data.transactions?.slice(0, 3) || []);

      } else {
        throw new Error(result.error || 'No se pudieron cargar los datos.');
      }
      
    } catch (err: unknown) {
      console.error("Error fetching wallet data:", err);
      setError(err.message || "Un error inesperado ocurrió.");
    } finally {
      setLoading(false);
    }
  };

  const formatCurrency = (value: number) => {
    return `Bs. ${Math.abs(value).toFixed(2)}`;
  };

  // --- ESTADO DE CARGA ---
  if (loading) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
         <Loader2 className="animate-spin text-blue-600" size={48} />
      </div>
    );
  }
  
  // --- ESTADO DE ERROR ---
  if (error) {
     return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div className="text-center bg-white p-8 rounded-lg shadow-md max-w-sm">
          <AlertCircle className="text-red-500 mx-auto mb-4" size={48} />
          <h2 className="text-xl font-bold text-gray-800 mb-2">Error al cargar la Billetera</h2>
          <p className="text-gray-600 mb-6 text-sm">{error}</p>
          <button
            onClick={() => router.push('/')}
            className="mt-6 bg-blue-600 text-white font-semibold py-2 px-6 rounded-xl hover:bg-blue-700 transition-colors"
          >
            Volver al Inicio
          </button>
        </div>
      </div>
    );
  }

  // --- PANTALLA PRINCIPAL (con datos) ---
  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <div className="bg-blue-600 text-white px-6 py-4">
        <h1 className="text-2xl font-bold">Fixer Wallet</h1>
      </div>

      {/* --- Contenedor principal --- */}
      <div className="max-w-3xl mx-auto px-4">

        {/* Balance Card */}
        <div className="pt-6 pb-4">
          <div className="bg-blue-600 rounded-2xl p-6 text-white shadow-lg">
            <div className="flex items-center gap-2 mb-2">
              <Wallet size={20} />
              <span className="text-sm opacity-90">Saldo Actual</span>
            </div>
            <div className="text-5xl font-bold mb-6">
              Bs. {walletData?.balance?.toFixed(2) || '0.00'}
            </div>
            
            <Link
              href={`/payment/FixerWallet/recarga?fixerId=${receivedFixerId}`}
              className="w-full block text-center bg-white text-blue-600 py-3 rounded-xl font-semibold hover:bg-gray-100 transition-colors"
            >
              Recargar Saldo
            </Link>
          </div>
        </div>

        {/* Movimientos Recientes */}
        <div className="pb-6">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-gray-600 font-semibold text-lg">Movimientos Recientes</h2>
            
            <Link
              href={`/payment/historial?fixerId=${receivedFixerId}`}
              className="text-blue-600 font-semibold"
            >
              Ver todo
            </Link>
          </div>

          <div className="space-y-3">
            {transactions.length > 0 ? (
              transactions.map((tx) => (
                <div key={tx._id} className="bg-white rounded-xl p-4 shadow-sm flex items-center gap-4">
                  <div className={`w-12 h-12 rounded-full flex items-center justify-center ${
                    tx.amount > 0 ? 'bg-green-100' : 'bg-red-100'
                  }`}>
                    {tx.amount > 0 ? (
                      <TrendingUp className="text-green-600" size={24} />
                    ) : (
                      <TrendingDown className="text-red-600" size={24} />
                    )}
                  </div>
                  <div className="flex-1">
                    <p className="font-semibold text-gray-900">{tx.description}</p>
                    <p className="text-sm text-gray-500">
                      {new Date(tx.createdAt).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}
                    </p>
                  </div>
                  <div className={`font-bold text-lg ${
                    tx.amount > 0 ? 'text-green-600' : 'text-red-600'
                  }`}>
                    {tx.amount > 0 ? '+' : ''}{formatCurrency(tx.amount)}
                  </div>
                </div>
              ))
            ) : (
              <div className="bg-white rounded-xl p-4 shadow-sm text-center text-gray-500">
                <p>No se encontraron movimientos recientes.</p>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/Components/Shared/Navbar.tsx">
'use client';

import Link from 'next/link';
import { useTranslations, useLocale } from 'next-intl';
import { Briefcase, UserCog, ClipboardList } from 'lucide-react';
import { usePathname, useRouter } from 'next/navigation';
import { useAppDispatch } from '@/app/redux/hooks';
import { resetFilters } from '@/app/redux/slice/jobOfert';

export function Navbar() {
  const t = useTranslations('navbar');
  const locale = useLocale();
  const pathname = usePathname();
  const router = useRouter();
  const dispatch = useAppDispatch();

  const isActive = (path: string) => pathname === `/${locale}${path}`;

  const handleJobOffersClick = (e: React.MouseEvent<HTMLAnchorElement>) => {
    e.preventDefault();
    dispatch(resetFilters());
    router.push('/job-offer-list');
  };

  return (
    <nav className='sticky top-0 z-50 w-full bg-white/80 backdrop-blur-lg border-b border-blue-100 shadow-sm'>
      <div className='container mx-auto px-4'>
        <div className='flex items-center justify-between h-16'>

          {/* NAV LINKS distribuidos a lo largo */}
          <div className='flex items-center w-full justify-between'>

            <Link
              href={`/${locale}/become-fixer`}
              className={`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg transition-all duration-300 ${
                isActive('/fixers-by-job')
                  ? 'bg-primary text-white shadow-lg shadow-blue-500/30'
                  : 'text-blue-900 hover:bg-blue-50'
              }`}
            >
              <ClipboardList className='w-4 h-4' />
              <span className='font-medium text-center'>{t('a')}</span>
            </Link>

            <Link
              href='/become-fixer'
              className={`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg transition-all duration-300 ${
                isActive('/become-fixer')
                  ? 'bg-primary text-white shadow-lg shadow-blue-500/30'
                  : 'text-blue-900 hover:bg-blue-50'
              }`}
            >
              <UserCog className='w-4 h-4' />
              <span className='font-medium text-center'>{t('becomeFixer')}</span>
            </Link>

            <Link
              href={`/${locale}/fixer/my-offers`}
              className={`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg transition-all duration-300 ${
                isActive('/fixer/my-offers')
                  ? 'bg-primary text-white shadow-lg shadow-blue-500/30'
                  : 'text-blue-900 hover:bg-blue-50'
              }`}
            >
              <ClipboardList className='w-4 h-4' />
              <span className='font-medium text-center'>{t('myOffers')}</span>
            </Link>

          </div>
        </div>
      </div>
    </nav>
  );
}
</file>

<file path="src/utils/paymentapi.ts">
// src/utils/paymentapi.ts
// Funciones de API y utilidades para el sistema de pagos

import { PaymentSummary, PaymentResponse, FetchFixerJobsResult, Trabajo } from './types';

const API_BASE = (process.env.NEXT_PUBLIC_API_URL || '').replace(/\/$/, '');

/**
 * Construye URL completa con base del API
 */
export const withBase = (path: string): string => `${API_BASE}${path}`;

/**
 * Valida si un string es un ObjectId de MongoDB válido
 */
export const isValidObjectId = (id: string): boolean => {
  return /^[a-fA-F0-9]{24}$/.test(id);
};

/**
 * Obtiene el Fixer ID del usuario autenticado desde servineo_user
 */
export const getFixerId = (): string => {
  // Solo en el cliente (browser)
  if (typeof window === 'undefined') {
    console.warn('⚠️ getFixerId llamado en el servidor');
    return '';
  }

  try {
    const userStr = localStorage.getItem('servineo_user');
    
    if (!userStr) {
      console.error('❌ No se encontró servineo_user en localStorage. Usuario no autenticado.');
      return '';
    }
    
    const user = JSON.parse(userStr);
    
    // Intenta obtener el fixerId de diferentes posibles campos
    const fixerId = user?.fixerId || user?.fixer_id || user?.id || '';
    
    if (!fixerId) {
      console.error('❌ El objeto user no contiene fixerId:', user);
      return '';
    }
    
    console.log('✅ Fixer ID obtenido desde servineo_user:', fixerId);
    return fixerId;
    
  } catch (error) {
    console.error('❌ Error al parsear servineo_user:', error);
    return '';
  }
};

/**
 * Obtiene el usuario completo desde localStorage
 */
export const getUser = (): Record<string, unknown> | null => {
  if (typeof window === 'undefined') return null;
  
  try {
    const userStr = localStorage.getItem('servineo_user');
    return userStr ? JSON.parse(userStr) : null;
  } catch (error) {
    console.error('Error parseando servineo_user:', error);
    return null;
  }
};

/**
 * Obtiene el token de autenticación
 */
export const getToken = (): string | null => {
  if (typeof window === 'undefined') return null;
  return localStorage.getItem('servineo_token');
};

/**
 * Verifica si el usuario está autenticado
 */
export const isAuthenticated = (): boolean => {
  return !!(getToken() && getUser());
};

/**
 * Obtiene el resumen de un pago
 */
export const fetchPaymentSummary = async (jobId: string): Promise<PaymentSummary> => {
  const url = withBase(`/api/lab/payments/${jobId}/summary?t=${Date.now()}`);
  console.log('🔗 Llamando API:', url);
  
  const res = await fetch(url, { cache: 'no-store' });
  console.log('📥 Status:', res.status);
  
  if (!res.ok) throw new Error(`Error ${res.status}`);
  
  const data = await res.json();
  console.log('✅ Datos:', data);
  
  const d = data?.data ?? data;

  const total = typeof d?.total === "number" 
    ? d.total 
    : typeof d?.amount?.total === "number" 
    ? d.amount.total 
    : 0;

  // Detectar código expirado
  const backendExpired = d?.codeExpired === true;
  const manualExpired = d?.codeExpiresAt && new Date(d.codeExpiresAt) < new Date();
  const isExpired = backendExpired || manualExpired;

  console.log("⏰ Verificación expiración:", {
    backendExpired,
    codeExpiresAt: d?.codeExpiresAt,
    manualExpired,
    isExpired
  });

  return {
    id: String(d?.id ?? jobId),
    code: d?.code ?? null,
    status: d?.status ?? 'pending',
    amount: {
      total,
      currency: d?.currency ?? d?.amount?.currency ?? 'BOB',
    },
    codeExpired: isExpired,
    codeExpiresAt: d?.codeExpiresAt,
    createdAt: d?.createdAt,
  };
};

/**
 * Confirma un pago con código
 */
export const confirmPayment = async (
  paymentId: string, 
  code: string
): Promise<PaymentResponse> => {
  const res = await fetch(withBase(`/api/lab/payments/${paymentId}/confirm`), {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ code }),
  });
  
  const resp = await res.json().catch(() => ({}));
  
  return { res, resp };
};

/**
 * Obtiene trabajos de un fixer por estado (CON TIMEOUT)
 */
export const fetchFixerJobs = async (
  fixerId: string, 
  status: 'pending' | 'paid'
): Promise<FetchFixerJobsResult> => {
  const url = withBase(`/api/lab/payments/by-fixer/${fixerId}/summary?status=${status}`);
  console.log(`🌐 Llamando API [${status}]:`, url);
  
  try {
    // Timeout de 10 segundos
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000);
    
    const res = await fetch(url, { 
      cache: 'no-store',
      signal: controller.signal 
    });
    
    clearTimeout(timeoutId);
    
    console.log(`📡 Respuesta [${status}]: Status ${res.status}`);
    
    if (!res.ok) {
      console.warn(`⚠️ API respondió con error ${res.status} para ${status}`);
      return { data: [] };
    }
    
    const data = await res.json();
    console.log(`✅ Datos [${status}]:`, data);
    return data;
  } catch (error: unknown) {
    if (error.name === 'AbortError') {
      console.error(`⏱️ Timeout en API [${status}]`);
    } else {
      console.error(`❌ Error en fetch [${status}]:`, error);
    }
    return { data: [] };
  }
};

/**
 * Obtiene todos los trabajos (pendientes y pagados) de un fixer
 */
export const fetchAllFixerJobs = async (fixerId: string): Promise<Trabajo[]> => {
  console.log('🔍 fetchAllFixerJobs llamado con fixerId:', fixerId);
  
  if (!fixerId || fixerId.trim() === '') {
    console.error('❌ FixerId está vacío');
    throw new Error('FixerId no puede estar vacío');
  }
  
  const isValidId = isValidObjectId(fixerId);
  console.log('🔑 ¿ID válido?', isValidId);
  
  if (isValidId) {
    console.log('✅ ID válido, consultando API...');
    
    try {
      // Timeout global de 15 segundos
      const timeoutPromise = new Promise<never>((_, reject) => {
        setTimeout(() => reject(new Error('Timeout: La API tardó más de 15 segundos')), 15000);
      });

      const fetchPromise = Promise.all([
        fetchFixerJobs(fixerId, 'pending'),
        fetchFixerJobs(fixerId, 'paid'),
      ]);

      const [pending, paid] = await Promise.race([fetchPromise, timeoutPromise]);

      console.log('📦 Respuesta pending:', pending);
      console.log('📦 Respuesta paid:', paid);
      console.log(`✅ Encontrados: ${pending.data.length} pendientes, ${paid.data.length} pagados`);

      const pendingArray = Array.isArray(pending?.data) ? pending.data : [];
      const paidArray = Array.isArray(paid?.data) ? paid.data : [];

      // Si no hay datos, mostrar mensaje específico
      if (pendingArray.length === 0 && paidArray.length === 0) {
        console.log('⚠️ No se encontraron trabajos en el API');
        return [];
      }

      const mapped = [...pendingArray, ...paidArray].map(x => {
        // Manejo seguro de amount - puede venir como objeto o directamente como número
        const total = typeof x.amount === 'object' && x.amount !== null
          ? (x.amount.total || 0)
          : typeof x.amount === 'number'
          ? x.amount
          : typeof x.total === 'number'
          ? x.total
          : 0;

        return {
          jobId: String(x.id),
          titulo: `Pago #${String(x.id).slice(-6).toUpperCase()}`,
          descripcion: `Monto: Bs. ${total.toFixed(2)}`,
          totalPagar: total,
          paymentStatus: x.status || 'pending',
          fecha: x.createdAt 
            ? new Date(x.createdAt).toISOString().slice(0, 10) 
            : new Date().toISOString().slice(0, 10),
        };
      });

      console.log('✅ Trabajos mapeados:', mapped);
      return mapped;
    } catch (error: unknown) {
      console.error('❌ Error en fetchAllFixerJobs:', error);
      
      // Si es timeout o error de red, devolver datos de ejemplo
      if (error.message.includes('Timeout') || error.message.includes('fetch')) {
        console.log('⚠️ Usando datos de ejemplo debido a error de conexión');
        return [
          { 
            jobId: "DEMO-001", 
            titulo: "Pago Demo 1 (Error de API)", 
            descripcion: "No se pudo conectar al servidor", 
            totalPagar: 150.00, 
            paymentStatus: "pending", 
            fecha: new Date().toISOString().slice(0, 10)
          },
        ];
      }
      
      throw error;
    }
  } else {
    console.log('⚠️ ID inválido, usando datos simulados');
    await new Promise(r => setTimeout(r, 1000));
    
    return [
      { 
        jobId: "SIM-001", 
        titulo: "Pago Simulado 1", 
        descripcion: "Trabajo de prueba", 
        totalPagar: 250.00, 
        paymentStatus: "pending", 
        fecha: "2025-11-08" 
      },
      { 
        jobId: "SIM-002", 
        titulo: "Pago Simulado 2", 
        descripcion: "Trabajo completado", 
        totalPagar: 180.50, 
        paymentStatus: "paid", 
        fecha: "2025-11-07" 
      },
    ];
  }
};

/**
 * Formatea tiempo en mm:ss
 */
export const formatTime = (milliseconds: number): string => {
  const minutes = Math.floor(milliseconds / 60000);
  const seconds = Math.floor((milliseconds % 60000) / 1000);
  
  if (minutes > 0) {
    return `${minutes}m ${seconds}s`;
  }
  return `${seconds}s`;
};

/**
 * Formatea tiempo en hh:mm:ss
 */
export const formatTimeWithHours = (milliseconds: number): string => {
  const hours = Math.floor(milliseconds / 3600000);
  const minutes = Math.floor((milliseconds % 3600000) / 60000);
  const seconds = Math.floor((milliseconds % 60000) / 1000);
  
  if (hours > 0) {
    return `${hours}h ${minutes}m ${seconds}s`;
  }
  return `${minutes}m ${seconds}s`;
};
</file>

<file path="src/utils/types.ts">
// src/utils/types.ts
// Tipos e interfaces centralizadas para el sistema de pagos

export type PaymentStatus = 'pending' | 'paid' | 'failed';
export type MessageType = 'error' | 'warning' | 'success' | 'info';

export interface Trabajo {
  jobId: string;
  titulo: string;
  descripcion: string;
  totalPagar: number;
  paymentStatus: PaymentStatus;
  fecha: string;
}

export interface PaymentAmount {
  total: number;
  currency: string;
}

export interface PaymentSummary {
  id: string;
  code: string | null;
  status: PaymentStatus;
  amount: PaymentAmount;
  codeExpired?: boolean;
  codeExpiresAt?: string;
  createdAt?: string;
}

export interface Message {
  type: MessageType;
  text: string;
}

export interface PaymentResponse {
  res: Response;
  resp: {
    error?: string;
    remainingAttempts?: number;
    unlocksAt?: string;
    waitMinutes?: number;
    [key: string]: unknown;
  };
}

export interface PaymentMethodCashFixerProps {
  trabajo: Trabajo;
  onClose: (completed?: boolean) => void;
  onBack: (options?: { refresh?: boolean }) => void;
}

export interface PaymentSuccessModalProps {
  onClose: () => void;
}

export interface JobCardProps {
  trabajo: Trabajo;
  onOpenPayment: (trabajo: Trabajo) => void;
}

export interface FetchFixerJobsResult {
  data: PaymentSummary[];
}
</file>

<file path="src/app/[locale]/adv-search/page.tsx">
'use client';

import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { ResultsCounter } from '@/Components/Adv-search/ResultsCounter';
import { InputOnlySearch } from '@/Components/Job-offers/Search/InputOnlySearch';
import { SearchCheckboxes } from '@/Components/Adv-search/SearchCheckboxes';
import { HelpButton } from '@/Components/Adv-search/HelpButton';
import DropdownList from '@/Components/Adv-search/DropdownList';
import useSyncUrlParamsAdv from '@/app/redux/features/adv-search/useSyncUrlParams';
import useAdvSearchLogic from '@/app/redux/features/adv-search/useAdvSearchLogic';
import PriceRangeList from '@/Components/Adv-search/PriceRangeList';
import DateFilterSelector from '@/Components/Adv-search/DateFilterSelector';
import CalificacionEstrella from '@/Components/Adv-search/CalificacionEstrella';
import ButtonAplicarBus from '@/Components/Adv-search/ButtonAplicarBus';
import ClearButton from '@/Components/Adv-search/ClearButton';
import { useTranslations } from 'next-intl';
import { DB_VALUES } from '@/app/redux/contants';

function AdvancedSearchPage() {
  const t = useTranslations('advancedSearch');
  const [isCalendarOpen, setIsCalendarOpen] = useState(false);

  const FIXER_RANGES = [
    [
      { dbValue: DB_VALUES.ranges[0], label: t('fixerName.ranges.ac') },
      { dbValue: DB_VALUES.ranges[1], label: t('fixerName.ranges.df') },
      { dbValue: DB_VALUES.ranges[2], label: t('fixerName.ranges.gi') },
      { dbValue: DB_VALUES.ranges[3], label: t('fixerName.ranges.jl') },
      { dbValue: DB_VALUES.ranges[4], label: t('fixerName.ranges.mn') },
    ],
    [
      { dbValue: DB_VALUES.ranges[5], label: t('fixerName.ranges.oq') },
      { dbValue: DB_VALUES.ranges[6], label: t('fixerName.ranges.rt') },
      { dbValue: DB_VALUES.ranges[7], label: t('fixerName.ranges.uw') },
      { dbValue: DB_VALUES.ranges[8], label: t('fixerName.ranges.xz') },
    ],
  ];

  const CITIES = DB_VALUES.cities.map((dbValue, index) => ({
    dbValue,
    label: t(
      `city.options.${['beni', 'chuquisaca', 'cochabamba', 'laPaz', 'oruro', 'pando', 'potosi', 'santaCruz', 'tarija'][index]}`,
    ),
  }));

  const JOBS = DB_VALUES.jobTypes.map((dbValue, index) => ({
    dbValue,
    label: t(
      `jobType.options.${['mason', 'carpenter', 'locksmith', 'decorator', 'electrician', 'plumber', 'fumigator', 'installer', 'gardener', 'cleaner', 'mechanic', 'assembler', 'painter', 'polisher', 'welder', 'roofer', 'glazier', 'plasterer'][index]}`,
    ),
  }));

  const {
    // state
    searchQuery,
    titleOnly,
    exactWords,
    openSections,
    selectedRanges,
    selectedCity,
    selectedJobs,
    selectedTags,
    selectedPriceKey,
    loading,
    resultsCount,
    storeLoading,
    clearSignal,
    skipSyncRef,
    // handlers
    setSearchQuery,
    setTitleOnly,
    setExactWords,
    toggleSection,
    handleRangeChange,
    handleCityChange,
    handleJobChange,
    handleDropdownChange,
    handlePriceRangeChange,
    handleSearch,
    setClearSignal,
    updateSearchOnStateChange,
    setSelectedRanges,
    setSelectedCity,
    setSelectedJobs,
    setSelectedCategories,
    setSelectedPriceRanges,
    setResultsCount,
    // date filter state from hook
    selectedDateFilter,
    setSelectedDateFilter,
    selectedSpecificDate,
    setSelectedSpecificDate,
    // rating
    selectedRating,
    setSelectedRating,
    fetchGlobalTotal,
  } = useAdvSearchLogic();

  const router = useRouter();

  // Close advanced search and go back to jobOfert when user presses Escape
  useEffect(() => {
    const onKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        router.push('/job-offer-list');
      }
    };

    window.addEventListener('keydown', onKeyDown);
    return () => window.removeEventListener('keydown', onKeyDown);
  }, [router]);

  // compute min/max from selectedPriceKey (kept local for URL sync)
  const _priceNormalized = (selectedPriceKey || '').replace(/[$€£,]/g, '');
  const _priceMatches = _priceNormalized.match(/-?\d+(?:\.\d+)?/g) || [];
  const _minPrice = _priceMatches[0] ? Number(_priceMatches[0]) : null;
  const _maxPrice = _priceMatches[1] ? Number(_priceMatches[1]) : null;

  // include date and sort selection so the URL keeps the date param set by the selector
  let advDate: string | null = null;
  if (selectedDateFilter === 'specific' && selectedSpecificDate) {
    const y = selectedSpecificDate.getFullYear();
    const m = String(selectedSpecificDate.getMonth() + 1).padStart(2, '0');
    const d = String(selectedSpecificDate.getDate()).padStart(2, '0');
    advDate = `${y}-${m}-${d}`;
  }
  const advSort =
    selectedDateFilter === 'recent' ? 'recent' : selectedDateFilter === 'oldest' ? 'oldest' : null;

  useSyncUrlParamsAdv({
    search: searchQuery,
    filters: {
      range: selectedRanges,
      city: selectedCity,
      category: selectedJobs,
      tags: selectedTags,
      minPrice: _minPrice,
      maxPrice: _maxPrice,
    },
    date: advDate,
    rating: selectedRating,
    sortBy: advSort,
    titleOnly,
    exact: exactWords,
    skipSyncRef,
  });

  return (
    <>
      <HelpButton />

      <main
        className={`pt-20 lg:pt-24 px-4 sm:px-6 md:px-12 lg:px-24 transition-all duration-300 ${isCalendarOpen ? 'pb-96' : 'pb-12'}`}
      >
        <h1 className='text-center text-xl sm:text-2xl md:text-3xl font-bold mb-8 mt-4'>
          {t('pageTitle')}
        </h1>

        <div className='max-w-7xl mx-auto'>
          <div className='w-full sm:w-[700px] mx-auto'>
            <div className='mb-3'>
              <ResultsCounter total={resultsCount ?? 0} loading={storeLoading ?? loading} />
            </div>

            <div className='mb-4'>
              <InputOnlySearch onSearch={handleSearch} onValueChange={(v) => setSearchQuery(v)} />
            </div>

            <div className='mb-6'>
              <SearchCheckboxes
                titleOnly={titleOnly}
                setTitleOnly={(val) => {
                  setTitleOnly(val);
                  setTimeout(() => updateSearchOnStateChange({ newTitleOnly: val }), 0);
                }}
                exactWords={exactWords}
                setExactWords={(val) => {
                  setExactWords(val);
                  setTimeout(() => updateSearchOnStateChange({ newExactWords: val }), 0);
                }}
              />
            </div>

            <div className='bg-[#2B6AE0] text-white px-4 py-2 text-sm font-bold mb-6 rounded-lg text-left'>
              {t('selectableParams')}
            </div>

            {/* Filtro: Nombre de Fixer */}
            <div className='mb-6'>
              <h3 className='text-base mb-2'>{t('fixerName.label')}</h3>
              <div
                className={`bg-gray-100 text-gray-500 px-4 py-2 text-sm cursor-pointer hover:bg-gray-200 transition-colors flex justify-between items-center 
                  ${
                    openSections.fixer
                      ? 'rounded-t-lg border border-b-0 border-gray-300'
                      : 'rounded-lg border border-gray-300'
                  }`}
                onClick={() => toggleSection('fixer')}
              >
                <span className='truncate'>{t('fixerName.placeholder')}</span>
                <svg
                  xmlns='http://www.w3.org/2000/svg'
                  className={`h-4 w-4 transform transition-transform duration-200 ${openSections.fixer ? 'rotate-180' : 'rotate-0'}`}
                  fill='none'
                  viewBox='0 0 24 24'
                  stroke='currentColor'
                  strokeWidth='2'
                >
                  <path strokeLinecap='round' strokeLinejoin='round' d='M19 9l-7 7-7-7' />
                </svg>
              </div>

              {openSections.fixer && (
                <div className='bg-white border border-t-0 border-gray-300 p-4 rounded-b-lg shadow-sm'>
                  <div className='grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4'>
                    {FIXER_RANGES.flat().map((range) => (
                      <label
                        key={range.dbValue}
                        className='flex items-center gap-2 text-sm cursor-pointer hover:text-[#2B31E0] transition-colors'
                      >
                        <input
                          type='checkbox'
                          className='w-4 h-4 cursor-pointer flex-shrink-0 text-[#2B6AE0] rounded border-gray-300 focus:ring-[#2B6AE0]'
                          checked={selectedRanges.includes(range.dbValue)}
                          onChange={() => handleRangeChange(range.dbValue)}
                        />
                        <span className='truncate'>{range.label}</span>
                      </label>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Filtro: Ciudad */}
            <div className='mb-6'>
              <h3 className='text-base mb-2'>{t('city.label')}</h3>
              <div
                className={`bg-gray-100 text-gray-500 px-4 py-2 text-sm cursor-pointer hover:bg-gray-200 transition-colors flex justify-between items-center 
                  ${
                    openSections.ciudad
                      ? 'rounded-t-lg border border-b-0 border-gray-300'
                      : 'rounded-lg border border-gray-300'
                  }`}
                onClick={() => toggleSection('ciudad')}
              >
                <span className='truncate'>{t('city.placeholder')}</span>
                <svg
                  xmlns='http://www.w3.org/2000/svg'
                  className={`h-4 w-4 transform transition-transform duration-200 ${openSections.ciudad ? 'rotate-180' : 'rotate-0'}`}
                  fill='none'
                  viewBox='0 0 24 24'
                  stroke='currentColor'
                  strokeWidth='2'
                >
                  <path strokeLinecap='round' strokeLinejoin='round' d='M19 9l-7 7-7-7' />
                </svg>
              </div>

              {openSections.ciudad && (
                <div className='bg-white border border-t-0 border-gray-300 p-4 rounded-b-lg shadow-sm max-h-[200px] overflow-y-auto'>
                  <div className='grid grid-cols-2 sm:grid-cols-3 gap-4'>
                    {CITIES.map((city) => (
                      <label
                        key={city.dbValue}
                        className='flex items-center gap-2 text-sm cursor-pointer hover:text-[#2B31E0] transition-colors'
                      >
                        <input
                          type='checkbox'
                          className='w-4 h-4 cursor-pointer flex-shrink-0 text-[#2B6AE0] rounded border-gray-300 focus:ring-[#2B6AE0]'
                          checked={selectedCity.includes(city.dbValue)}
                          onChange={() => handleCityChange(city.dbValue)}
                        />
                        <span className='truncate'>{city.label}</span>
                      </label>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Filtro: Tipo de Trabajo */}
            <div className='mb-6'>
              <h3 className='text-base mb-2'>{t('jobType.label')}</h3>
              <div
                className={`bg-gray-100 text-gray-500 px-4 py-2 text-sm cursor-pointer hover:bg-gray-200 transition-colors flex justify-between items-center 
                  ${
                    openSections.trabajo
                      ? 'rounded-t-lg border border-b-0 border-gray-300'
                      : 'rounded-lg border border-gray-300'
                  }`}
                onClick={() => toggleSection('trabajo')}
              >
                <span className='truncate'>{t('jobType.placeholder')}</span>
                <svg
                  xmlns='http://www.w3.org/2000/svg'
                  className={`h-4 w-4 transform transition-transform duration-200 ${openSections.trabajo ? 'rotate-180' : 'rotate-0'}`}
                  fill='none'
                  viewBox='0 0 24 24'
                  stroke='currentColor'
                  strokeWidth='2'
                >
                  <path strokeLinecap='round' strokeLinejoin='round' d='M19 9l-7 7-7-7' />
                </svg>
              </div>

              {openSections.trabajo && (
                <div className='bg-white border border-t-0 border-gray-300 p-4 rounded-b-lg shadow-sm max-h-[200px] overflow-y-auto'>
                  <div className='grid grid-cols-2 sm:grid-cols-3 gap-4'>
                    {JOBS.map((job) => (
                      <label
                        key={job.dbValue}
                        className='flex items-center gap-2 text-sm cursor-pointer hover:text-[#2B31E0] transition-colors'
                      >
                        <input
                          type='checkbox'
                          className='w-4 h-4 cursor-pointer flex-shrink-0 text-[#2B6AE0] rounded border-gray-300 focus:ring-[#2B6AE0]'
                          checked={selectedJobs.includes(job.dbValue)}
                          onChange={() => handleJobChange(job.dbValue)}
                        />
                        <span className='truncate'>{job.label}</span>
                      </label>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Filtro: Etiquetas */}
            <div className='mb-6'>
              <h3 className='text-base mb-2'>{t('tags.label')}</h3>

              <div
                className={`bg-gray-100 text-gray-500 px-4 py-2 text-sm cursor-pointer hover:bg-gray-200 transition-colors flex justify-between items-center 
                  ${
                    openSections.categorias
                      ? 'rounded-t-lg border border-b-0 border-gray-300'
                      : 'rounded-lg border border-gray-300'
                  }`}
                onClick={() => toggleSection('categorias')}
              >
                <span className='truncate'>{t('tags.placeholder')}</span>
                <svg
                  xmlns='http://www.w3.org/2000/svg'
                  className={`h-4 w-4 transform transition-transform duration-200 ${openSections.categorias ? 'rotate-180' : 'rotate-0'}`}
                  fill='none'
                  viewBox='0 0 24 24'
                  stroke='currentColor'
                  strokeWidth='2'
                >
                  <path strokeLinecap='round' strokeLinejoin='round' d='M19 9l-7 7-7-7' />
                </svg>
              </div>

              {openSections.categorias && (
                <div className='bg-white border border-t-0 border-gray-300 rounded-b-lg shadow-sm'>
                  <DropdownList
                    onFilterChange={handleDropdownChange}
                    clearSignal={clearSignal}
                    searchQuery={searchQuery}
                    categoryFilters={selectedJobs}
                  />
                </div>
              )}
            </div>

            {/* Filtro: Precio */}
            <div className='mb-6'>
              <h3 className='text-base mb-2'>{t('price.label')}</h3>

              <div
                className={`bg-gray-100 text-gray-500 px-4 py-2 text-sm cursor-pointer hover:bg-gray-200 transition-colors flex justify-between items-center 
                  ${
                    openSections.precio
                      ? 'rounded-t-lg border border-b-0 border-gray-300'
                      : 'rounded-lg border border-gray-300'
                  }`}
                onClick={() => toggleSection('precio')}
              >
                <span className='truncate'>{t('price.placeholder')}</span>
                <svg
                  xmlns='http://www.w3.org/2000/svg'
                  className={`h-4 w-4 transform transition-transform duration-200 ${openSections.precio ? 'rotate-180' : 'rotate-0'}`}
                  fill='none'
                  viewBox='0 0 24 24'
                  stroke='currentColor'
                  strokeWidth='2'
                >
                  <path strokeLinecap='round' strokeLinejoin='round' d='M19 9l-7 7-7-7' />
                </svg>
              </div>

              {openSections.precio && (
                <div className='bg-white border border-t-0 border-gray-300 rounded-b-lg shadow-sm'>
                  <PriceRangeList
                    onFilterChange={handlePriceRangeChange}
                    clearSignal={clearSignal}
                  />
                </div>
              )}
            </div>

            {/* Filtro de Fecha y Calificación */}
            <div className='mb-6 flex flex-col md:flex-row gap-6 items-start'>
              <div className='shrink-0 order-2 md:order-1 w-full md:w-auto'>
                <DateFilterSelector
                  selectedFilter={selectedDateFilter}
                  selectedDate={selectedSpecificDate}
                  onChange={(f, d) => {
                    setSelectedDateFilter(f);
                    setSelectedSpecificDate(d ?? null);
                  }}
                  onCalendarToggle={setIsCalendarOpen}
                  clearSignal={clearSignal}
                />
              </div>
              <div className='shrink-0 order-1 md:order-2 w-full md:w-auto'>
                <CalificacionEstrella value={selectedRating} onChange={setSelectedRating} />
              </div>
            </div>

            {/* Botones: Aplicar Búsqueda y Limpiar Datos */}
            <div className='flex justify-center items-center gap-4 mt-8'>
              <ButtonAplicarBus
                onClick={() => handleSearch(searchQuery)}
                loading={storeLoading ?? loading}
              />
              <ClearButton
                onClick={() => {
                  setSearchQuery('');
                  setSelectedRanges([]);
                  setSelectedCity([]);
                  setSelectedJobs([]);
                  setSelectedCategories([]);
                  setSelectedPriceRanges([]);
                  setTitleOnly(false);
                  setExactWords(false);
                  setResultsCount(null);
                  setSelectedDateFilter('specific');
                  setSelectedSpecificDate(null);
                  setSelectedRating(null);
                  setClearSignal((s) => s + 1);
                  try {
                    window.sessionStorage.removeItem('advSearch_state');
                    window.sessionStorage.removeItem('fromAdv');
                    window.sessionStorage.removeItem('appliedFilters');
                  } catch {
                    /* noop */
                  }
                  fetchGlobalTotal();
                }}
              />
            </div>
          </div>
        </div>
      </main>
    </>
  );
}

export default AdvancedSearchPage;
</file>

<file path="src/app/[locale]/ask-for-help/centro_de_ayuda/page.tsx">
'use client';

import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { useTranslations, useLocale } from 'next-intl';
import { Search, HelpCircle, Users } from 'lucide-react';

interface Suggestion {
  id: number;
  title: string;
  url: string;
}

const CentroDeAyuda: React.FC = () => {
  const router = useRouter();
  const t = useTranslations('helpCenter');
  const locale = useLocale();

  const [searchTerm, setSearchTerm] = useState('');
  const [suggestions, setSuggestions] = useState<Suggestion[]>([]);
  const [message, setMessage] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isSearching, setIsSearching] = useState(false);

  /** Muestra un mensaje temporal */
  const showMessage = useCallback((msg: string) => {
    setMessage(msg);
    const timeoutId = setTimeout(() => setMessage(''), 5000);
    return () => clearTimeout(timeoutId);
  }, []);

  /** Redirección centralizada */
  const handleRedirect = useCallback(
    (target: string, url: string | null = null) => {
      let finalUrl: string;

      switch (target) {
        case 'Preguntas Frecuentes sobre Servineo':
        case 'Preguntas Frecuentes (FAQ)':
        case 'Frequently Asked Questions (FAQ)':
          finalUrl = `/${locale}/ask-for-help/preguntas-frecuentes`;
          break;
        case 'Foro de Usuarios':
        case 'User Forum':
          finalUrl = `/${locale}/ask-for-help/foro-usuario`;
          break;
        case 'Home':
          finalUrl = `/${locale}`;
          break;
        case 'Perfil':
        case 'Profile':
          finalUrl = `/${locale}/perfil`;
          break;
        default:
          finalUrl = url || `/${locale}/${target.toLowerCase().replace(/\s/g, '-')}`;
      }

      if (typeof window !== 'undefined') {
        router.push(finalUrl);
      } else {
        console.log(`[REDIRECCIÓN SIMULADA] → ${finalUrl}`);
        showMessage(t('messages.navigating', { url: finalUrl }));
      }
    },
    [router, showMessage, locale, t],
  );

  /** Ejecuta búsqueda */
  const handleSearchSubmit = useCallback(
    (
      event?: React.MouseEvent<HTMLElement> | React.KeyboardEvent<HTMLInputElement>,
      customQuery?: string,
    ) => {
      if (event && 'preventDefault' in event) event.preventDefault();

      const query = customQuery || searchTerm.trim();

      if (!query) {
        setIsSearching(false);
        showMessage(t('messages.emptySearch'));
        return;
      }

      setSuggestions([]);
      setIsSearching(true);
      setIsLoading(true);

      showMessage(t('messages.searching', { query }));

      setTimeout(() => {
        setIsLoading(false);

        if (query.toLowerCase().includes('pago') || query.toLowerCase().includes('payment')) {
          setSuggestions([
            { id: 1, title: t('suggestions.paymentProblems'), url: '/ayuda/pago-problemas' },
            { id: 2, title: t('suggestions.paymentMethods'), url: '/ayuda/metodos-pago' },
          ]);
        } else if (
          query.toLowerCase().includes('faq') ||
          query.toLowerCase().includes('pregunta') ||
          query.toLowerCase().includes('question')
        ) {
          setSuggestions([
            {
              id: 99,
              title: t('sections.faq.title'),
              url: `/${locale}/ask-for-help/preguntas-frecuentes`,
            },
          ]);
        } else {
          setSuggestions([]);
          showMessage(t('messages.noResults', { query }));
        }
      }, 600);
    },
    [searchTerm, showMessage, t, locale],
  );

  /** Click sobre sugerencia */
  const handleSuggestionClick = useCallback(
    (suggestion: Suggestion) => {
      setSearchTerm(suggestion.title);
      setSuggestions([]);
      handleSearchSubmit(undefined, suggestion.title);
    },
    [handleSearchSubmit],
  );

  /** Autocompletado */
  useEffect(() => {
    const query = searchTerm.trim().toLowerCase();
    setIsSearching(false);

    if (query.length < 2) {
      setSuggestions([]);
      if (isLoading) setIsLoading(false);
      return;
    }

    const simSuggestions: Suggestion[] = [
      { id: 10, title: t('suggestions.paymentProblems'), url: '/ayuda/pago-problemas' },
      { id: 11, title: t('suggestions.resetPassword'), url: '/ayuda/restablecer' },
      { id: 12, title: t('suggestions.billing'), url: '/ayuda/facturacion' },
      {
        id: 13,
        title: t('suggestions.support'),
        url: `/${locale}/ask-for-help/preguntas-frecuentes`,
      },
      {
        id: 14,
        title: t('sections.faq.title'),
        url: `/${locale}/ask-for-help/preguntas-frecuentes`,
      },
    ];

    const filtered = simSuggestions.filter((s) => s.title.toLowerCase().includes(query));

    const handler = setTimeout(() => setSuggestions(filtered), 150);
    return () => clearTimeout(handler);
  }, [searchTerm, isLoading, t, locale]);

  /** Control de visibilidad */
  const normalizedQuery = searchTerm.trim().toLowerCase();

  const isFAQVisible = useMemo(() => {
    return (
      !isSearching &&
      (normalizedQuery.length === 0 ||
        ['pre', 'frec', 'faq', 'duda', 'pregunt', 'question', 'freq'].some((k) =>
          normalizedQuery.includes(k),
        ))
    );
  }, [normalizedQuery, isSearching]);

  const isForumVisible = useMemo(() => {
    return (
      !isSearching &&
      (normalizedQuery.length === 0 ||
        [
          'foro',
          'comunidad',
          'usuario',
          'usuarios',
          'duda',
          'ayuda',
          'forum',
          'community',
          'user',
        ].some((k) => normalizedQuery.includes(k)))
    );
  }, [normalizedQuery, isSearching]);

  const isResultsVisible = useMemo(() => isSearching && !isLoading, [isSearching, isLoading]);

  return (
    <div className='min-h-screen bg-gray-50 py-8 font-sans antialiased'>
      <div className='container mx-auto px-4 max-w-5xl'>
        {/* HEADER */}
        <div className='bg-white rounded-xl shadow-lg p-8 mb-8 relative'>
          <div className='flex flex-col items-center text-center'>
            <h1 className='text-4xl font-bold text-gray-900 mb-3'>{t('title')}</h1>
            <p className='text-gray-600 text-lg max-w-2xl'>{t('subtitle')}</p>
          </div>
        </div>

        {/* CONTENIDO PRINCIPAL */}
        <div className='bg-white rounded-xl shadow-lg p-6'>
          {/* Buscador */}
          <section className='relative mb-6'>
            <div className='relative'>
              <button
                className='absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 p-1 rounded-full transition z-20'
                onClick={() => handleSearchSubmit()}
                aria-label={t('search.button')}
              >
                {isLoading ? (
                  <svg
                    className='animate-spin h-5 w-5 text-blue-500'
                    xmlns='http://www.w3.org/2000/svg'
                    fill='none'
                    viewBox='0 0 24 24'
                  >
                    <circle
                      className='opacity-25'
                      cx='12'
                      cy='12'
                      r='10'
                      stroke='currentColor'
                      strokeWidth='4'
                    ></circle>
                    <path
                      className='opacity-75'
                      fill='currentColor'
                      d='M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z'
                    ></path>
                  </svg>
                ) : (
                  <Search className='h-5 w-5 hover:text-blue-600 transition' />
                )}
              </button>

              <input
                type='text'
                placeholder={t('search.placeholder')}
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                onKeyDown={(e) => {
                  if (e.key === 'Enter') handleSearchSubmit(e);
                }}
                className='w-full pl-12 pr-10 py-3 border-2 border-border rounded-xl bg-card focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all shadow-sm hover:shadow-md'
              />
            </div>

            {/* Sugerencias */}
            {searchTerm.length >= 2 && suggestions.length > 0 && !isSearching && (
              <div className='absolute z-10 mt-2 left-0 right-0'>
                <ul className='bg-white border border-gray-200 rounded-xl shadow-xl max-h-60 overflow-y-auto divide-y divide-gray-100'>
                  {suggestions.map((s) => (
                    <li
                      key={s.id}
                      onClick={() => handleSuggestionClick(s)}
                      className='px-4 py-3 cursor-pointer text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition duration-150'
                    >
                      <p className='font-semibold truncate'>{s.title}</p>
                      <p className='text-xs text-gray-400 truncate'>{s.url}</p>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </section>

          {/* Mensaje */}
          {message && (
            <div className='mb-4 p-3 bg-blue-100 text-blue-800 border border-blue-200 rounded-lg text-sm font-medium transition-opacity duration-300'>
              {message}
            </div>
          )}

          {/* Contenido */}
          <main className='pt-0'>
            {isResultsVisible && (
              <div className='mb-6'>
                <h2 className='text-2xl font-bold mb-4 text-gray-800'>
                  {t('results.title', { query: searchTerm })}
                </h2>
                {suggestions.length > 0 ? (
                  <div className='space-y-3'>
                    {suggestions.map((r) => (
                      <div
                        key={r.id}
                        onClick={() => handleRedirect(r.title, r.url)}
                        className='p-4 bg-gray-50 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100 transition'
                      >
                        <p className='font-semibold text-blue-600'>{r.title}</p>
                        <p className='text-sm text-gray-500 truncate'>{r.url}</p>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className='text-center p-10 bg-gray-50 rounded-lg text-gray-500'>
                    <Search className='h-8 w-8 mx-auto mb-3' />
                    <p>{t('results.empty')}</p>
                  </div>
                )}
              </div>
            )}

            {/* Secciones por defecto */}
            {(!isSearching || isLoading) && (
              <div className='space-y-4'>
                {isFAQVisible && (
                  <button
                    onClick={() => handleRedirect(t('sections.faq.title'))}
                    className='w-full flex items-center p-4 bg-white border border-gray-200 rounded-xl shadow-md hover:shadow-lg hover:scale-[1.01] duration-200 text-left hover:bg-blue-50'
                  >
                    <div className='p-3 mr-4 rounded-full bg-blue-100 text-blue-600'>
                      <HelpCircle className='h-6 w-6' />
                    </div>
                    <div>
                      <h2 className='text-lg font-semibold text-gray-800'>
                        {t('sections.faq.title')}
                      </h2>
                      <p className='text-sm text-gray-500'>{t('sections.faq.description')}</p>
                    </div>
                  </button>
                )}

                {isForumVisible && (
                  <button
                    onClick={() => handleRedirect(t('sections.forum.title'))}
                    className='w-full flex items-center p-4 bg-white border border-gray-200 rounded-xl shadow-md hover:shadow-lg hover:scale-[1.01] duration-200 text-left hover:bg-blue-50'
                  >
                    <div className='p-3 mr-4 rounded-full bg-blue-100 text-blue-600'>
                      <Users className='h-6 w-6' />
                    </div>
                    <div>
                      <h2 className='text-lg font-semibold text-gray-800'>
                        {t('sections.forum.title')}
                      </h2>
                      <p className='text-sm text-gray-500'>{t('sections.forum.description')}</p>
                    </div>
                  </button>
                )}

                {!isFAQVisible && !isForumVisible && normalizedQuery.length > 0 && (
                  <p className='text-center text-gray-500 py-4'>
                    {t('messages.noCategories', { query: searchTerm })}
                  </p>
                )}
              </div>
            )}
          </main>
        </div>
      </div>
    </div>
  );
};

export default CentroDeAyuda;
</file>

<file path="src/app/[locale]/ask-for-help/preguntas-frecuentes/page.tsx">
'use client';

import React from 'react';
import { useRouter } from 'next/navigation';
import { useTranslations } from 'next-intl';
import { FAQSearch } from '@/Components/ask_for_help/FAQSearch';
import { FAQCategoryFilter } from '@/Components/ask_for_help/FAQCategoryFilter';
import { FAQList } from '@/Components/ask_for_help/FAQList';
//import { FAQContact } from '@/Components/ask_for_help/FAQContact';
import { useFAQ } from '@/Components/ask_for_help/useFAQ';

export default function PreguntasFrecuentesPage() {
  const router = useRouter();
  const t = useTranslations('faq');

  const { faqs, loading, error, selectedCategory, searchFAQs, filterByCategory } = useFAQ();

  return (
    <div className='min-h-screen bg-gray-50 py-8'>
      <div className='container mx-auto px-4 max-w-5xl'>
        {/* Header */}
        <div className='bg-white rounded-xl shadow-lg p-8 mb-8 relative'>
          {/* 🔙 Icono de volver atrás */}
          <button
            onClick={() => router.back()}
            className='absolute top-6 left-6 text-2xl text-gray-600 hover:text-gray-800 transition'
            aria-label={t('backButton')}
          >
            ←
          </button>

          <h1 className='text-4xl font-bold text-gray-900 mb-3 text-center'>{t('title')}</h1>
          <p className='text-gray-600 text-lg text-center'>{t('subtitle')}</p>
        </div>

        {/* Content */}
        <div className='bg-white rounded-xl shadow-lg p-8'>
          <FAQSearch onSearch={searchFAQs} />

          <FAQCategoryFilter
            selectedCategory={selectedCategory}
            onCategoryChange={filterByCategory}
          />

          {/* Error State */}
          {error && (
            <div className='bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6 flex items-center gap-2'>
              <span className='text-xl'>⚠️</span>
              <span className='font-medium'>{error}</span>
            </div>
          )}

          <FAQList faqs={faqs} loading={loading} />
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/app/[locale]/job-offer-list/page.tsx">
'use client';

import React, { useEffect, useRef, useState, useCallback, useMemo } from 'react';
import { useLogClickMutation } from '../../redux/services/activityApi';
import { useLogSearchMutation, useUpdateFiltersMutation } from '../../redux/services/searchApi';
import {
  SearchBar,
  NoResultsMessage,
  FilterButton,
  FilterDrawer,
  Paginacion,
  PaginationInfo,
  PaginationSelector,
  SortCard,
} from '@/Components/Job-offers';

import { useAppDispatch, useAppSelector } from '@/app/redux/hooks';
import {
  setSearch,
  setFilters,
  setSortBy,
  setRegistrosPorPagina,
  resetPagination,
  setRating,
  setPaginaActual,
  resetFilters,
  enablePersistence,
} from '@/app/redux/slice/jobOfert';
import { STORAGE_KEYS } from '@/app/redux/features/jobOffers/storage';
import type { FilterState } from '@/app/redux/features/jobOffers/types';
import { getSortValue } from '../../lib/constants/sortOptions';
import {
  useJobOffers,
  useInitialUrlParams,
  useSyncUrlParams,
} from '@/app/redux/features/jobOffers/jobOffersHooks';
import { JobOfferModal } from '@/Components/Job-offers/Job-offer-modal';
import { JobOffersView, type ViewMode } from '@/Components/Job-offers/JobOffersView';
import { ViewModeToggle } from '@/Components/Job-offers/ViewModeToggle';
import { useTranslations } from 'next-intl';
import type { JobOfferData, AdaptedJobOffer } from '@/types/jobOffers';

const SCROLL_POSITION_KEY = 'jobOffers_scrollPosition';

export default function JobOffersPage() {
  const t = useTranslations('jobOffers');
  const dispatch = useAppDispatch();

  useInitialUrlParams();

  const { offers, total, isLoading } = useJobOffers();

  const {
    sortBy,
    search,
    paginaActual,
    totalPages,
    registrosPorPagina,
    error: reduxError,
    filters,
    rating,
  } = useAppSelector((state) => state.jobOfert);

  useSyncUrlParams();

  const [userId, setUserId] = useState<string>('');
  const [userRole, setUserRole] = useState<string>('visitor');

  useEffect(() => {
    if (typeof window !== 'undefined') {
      const storedUser = localStorage.getItem('servineo_user');
      if (storedUser) {
        try {
          const userObj = JSON.parse(storedUser);
          console.log('User object from localStorage:', userObj);
          const id = userObj.id || userObj._id || userObj.userId || '';
          const role = userObj.role || 'visitor';
          setUserId(id);
          setUserRole(role);
          console.log('Extracted user ID:', id, 'Role:', role);
        } catch (error) {
          console.error('Error parsing user from localStorage:', error);
          setUserRole('visitor');
        }
      } else {
        console.warn('No servineo_user found in localStorage');
        setUserRole('visitor');
      }
    }
  }, []);

  const [logSearch] = useLogSearchMutation();
  const [updateFilters] = useUpdateFiltersMutation();
  const [logClick] = useLogClickMutation();

  const previousSearchQueryRef = useRef<string>('');
  const previousFiltersRef = useRef<FilterState>(filters);
  const isInitialMountRef = useRef<boolean>(true);
  const filterCounterRef = useRef<number>(1);
  const stickyRef = useRef<HTMLDivElement | null>(null);
  const scrollRestoredRef = useRef(false);
  const pageBeforeFilter = useRef<number>(1);
  const hasActiveFilters = useRef<boolean>(false);

  // Ref para almacenar el número real de resultados basado en la paginación
  const actualSearchCountRef = useRef<number>(0);

  // Ref para verificar si ya hemos enviado la búsqueda con el conteo correcto
  const hasSentSearchRef = useRef<boolean>(false);

  const [isDrawerOpen, setIsDrawerOpen] = useState(false);
  const [viewMode, setViewMode] = useState<ViewMode>('list');
  const [selectedOffer, setSelectedOffer] = useState<AdaptedJobOffer | null>(null);
  const [isModalOpen, setIsModalOpen] = useState(false);

  // Función para calcular el número de resultados basado en la paginación
  const calculateSearchCount = useCallback(() => {
    // El total de useJobOffers ya está filtrado por búsqueda y filtros
    // Asegurar que no estemos en estado de carga y que total sea un número válido
    if (!isLoading && typeof total === 'number' && total >= 0) {
      return total;
    }
    return 0;
  }, [isLoading, total]);

  // Función para convertir "De (A-C)" a "A-C"
  const formatRangeValue = useCallback((range: string): string => {
    // Remover "De (" del inicio y ")" del final, luego extraer solo el rango
    if (range.startsWith('De (')) {
      return range.replace('De (', '').replace(')', '');
    }
    return range;
  }, []);

  const getFixerNameValue = useCallback((): string => {
    // Usar filters.range directamente para obtener los rangos aplicados
    if (!filters.range || filters.range.length === 0) {
      return 'not_applied';
    }

    // Convertir cada rango de "De (A-C)" a "A-C" y unirlos
    const formattedRanges = filters.range.map(formatRangeValue);
    return formattedRanges.join(', ');
  }, [filters, formatRangeValue]);

  const getCityValue = useCallback((): string => {
    if (!filters.city || (Array.isArray(filters.city) && filters.city.length === 0)) {
      return 'not_applied';
    }
    if (Array.isArray(filters.city)) {
      return filters.city.join(', ');
    }
    return filters.city;
  }, [filters]);

  const getJobTypeValue = useCallback((): string => {
    if (!filters.category || filters.category.length === 0) {
      return 'not_applied';
    }
    return filters.category.join(', ');
  }, [filters]);

  const adaptJobOffer = useCallback((offer: JobOfferData): AdaptedJobOffer => {
    return {
      _id: offer._id,
      fixerId: offer.fixerId,
      name: offer.fixerName,
      title: offer.title,
      description: offer.description,
      tags: offer.tags || [],
      phone: offer.contactPhone,
      photos: offer.photos || [],
      services: offer.category ? [offer.category] : [],
      price: offer.price,
      createdAt: offer.createdAt instanceof Date ? offer.createdAt : new Date(offer.createdAt),
      city: offer.city,
    };
  }, []);

  // Función para enviar una búsqueda pendiente
  const sendPendingSearch = useCallback(async () => {
    // Verificar que no se haya enviado ya y que haya una query
    if (!previousSearchQueryRef.current || hasSentSearchRef.current) {
      return;
    }

    // Marcar como enviado inmediatamente para evitar duplicados
    hasSentSearchRef.current = true;

    // Usar el conteo actualizado de resultados desde el ref
    const searchCount = actualSearchCountRef.current;
    const query = previousSearchQueryRef.current;

    // Obtener los valores actuales de los filtros en el momento de enviar
    const fixerNameValue = getFixerNameValue();
    const cityValue = getCityValue();
    const jobTypeValue = getJobTypeValue();

    const searchData = {
      user_type: userRole,
      search_query: query,
      search_type: 'search_box',
      filters: {
        filter_1: {
          fixer_name: fixerNameValue,
          city: cityValue,
          job_type: jobTypeValue,
          search_count: searchCount, // Usar el conteo actualizado
        },
      },
    };

    try {
      console.log('=== REGISTRANDO BÚSQUEDA ===');
      console.log('Búsqueda:', query);
      console.log('Filtros aplicados:', {
        fixer_name: fixerNameValue,
        city: cityValue,
        job_type: jobTypeValue,
      });
      console.log('Resultados encontrados:', searchCount);
      console.log('Datos completos:', JSON.stringify(searchData, null, 2));
      await logSearch(searchData).unwrap();
      console.log('✓ Búsqueda registrada exitosamente');
    } catch (error) {
      console.error('✗ Error al registrar búsqueda:', error);
      // Si hay error, permitir reintento
      hasSentSearchRef.current = false;
    }
  }, [userRole, logSearch, getFixerNameValue, getCityValue, getJobTypeValue]);

  // Efecto único para registrar la búsqueda cuando los resultados estén listos
  useEffect(() => {
    // Solo registrar si:
    // 1. No está cargando
    // 2. Hay una búsqueda pendiente (previousSearchQueryRef no está vacío)
    // 3. Aún no se ha enviado (hasSentSearchRef es false)
    // 4. Los resultados están disponibles (total no es undefined/null)
    if (
      !isLoading &&
      previousSearchQueryRef.current &&
      !hasSentSearchRef.current &&
      total !== undefined &&
      total !== null
    ) {
      const currentCount = calculateSearchCount();

      // Actualizar el conteo actual
      actualSearchCountRef.current = currentCount;

      // Pequeño delay para asegurar que el conteo esté estable
      const timeoutId = setTimeout(async () => {
        // Verificar nuevamente que no se haya enviado mientras esperábamos
        // y que el total siga siendo válido
        if (
          !hasSentSearchRef.current &&
          previousSearchQueryRef.current &&
          total !== undefined &&
          total !== null
        ) {
          const finalCount = calculateSearchCount();
          actualSearchCountRef.current = finalCount;

          console.log('Registrando búsqueda - Conteo final:', finalCount, 'Total:', total);
          await sendPendingSearch();
        }
      }, 500);

      return () => clearTimeout(timeoutId);
    }
  }, [isLoading, calculateSearchCount, total, sendPendingSearch, offers]);

  const handleSearchSubmit = useCallback(
    (query: string) => {
      scrollRestoredRef.current = true;
      window.scrollTo({ top: 0, behavior: 'smooth' });

      // Siempre actualizar la búsqueda, incluso si no cambió, para registrar el clic
      const trimmedQuery = query.trim();
      dispatch(setSearch(trimmedQuery));
      dispatch(resetPagination());

      filterCounterRef.current = 1;

      // Resetear el flag para permitir registrar la búsqueda cuando los resultados estén listos
      previousSearchQueryRef.current = trimmedQuery;
      hasSentSearchRef.current = false;

      console.log('Búsqueda iniciada:', trimmedQuery, 'Esperando resultados...');
      // La búsqueda se registrará automáticamente cuando los resultados estén listos en el useEffect
    },
    [dispatch],
  );

  // Ref para rastrear si hay un cambio de filtros pendiente de registrar
  const pendingFilterChangeRef = useRef<boolean>(false);

  // Efecto para detectar cambios en filtros
  useEffect(() => {
    if (isInitialMountRef.current) {
      isInitialMountRef.current = false;
      previousFiltersRef.current = { ...filters };
      return;
    }

    const currentFilters = filters as unknown as Record<string, unknown>;
    const previousFilters = previousFiltersRef.current as unknown as Record<string, unknown>;

    const compareFilterValues = (
      prev: Record<string, unknown>,
      curr: Record<string, unknown>,
      key: string,
    ) => {
      const prevValue = prev[key];
      const currValue = curr[key];

      if (Array.isArray(prevValue) && Array.isArray(currValue)) {
        return JSON.stringify([...prevValue].sort()) !== JSON.stringify([...currValue].sort());
      }

      return prevValue !== currValue;
    };

    // Solo detectar cambios en los filtros relevantes
    const filterKeys = ['city', 'category', 'range'];
    const filtersChanged = filterKeys.some((key) =>
      compareFilterValues(previousFilters, currentFilters, key),
    );

    if (filtersChanged) {
      // Actualizar los filtros previos
      previousFiltersRef.current = { ...filters };

      // Marcar que hay un cambio de filtros pendiente
      pendingFilterChangeRef.current = true;

      console.log('=== CAMBIO DE FILTROS DETECTADO ===');
      console.log('Filtros anteriores:', previousFilters);
      console.log('Filtros nuevos:', currentFilters);
    }
  }, [filters]);

  // Efecto separado para enviar los filtros cuando los resultados estén listos
  useEffect(() => {
    // Solo proceder si hay un cambio de filtros pendiente
    if (!pendingFilterChangeRef.current) {
      return;
    }

    // Si está cargando, esperar a que termine
    if (isLoading) {
      console.log('Esperando a que termine la carga antes de registrar filtros...');
      return;
    }

    // Si el total no está disponible, esperar
    if (total === undefined || total === null) {
      console.log('Esperando total antes de registrar filtros...', { total });
      return;
    }

    // Verificar si hay búsqueda asociada (necesaria para actualizar filtros)
    const searchQuery = previousSearchQueryRef.current || search || '';

    if (!searchQuery || searchQuery.trim() === '') {
      console.log('⚠ No hay búsqueda asociada para actualizar filtros');
      pendingFilterChangeRef.current = false;
      return;
    }

    // Usar un delay para asegurar que los datos estén completamente actualizados
    // después de que termine la carga
    const timeoutId = setTimeout(async () => {
      // Verificar nuevamente antes de enviar
      if (isLoading || total === undefined || total === null) {
        console.log('Cancelando envío - estado no válido:', { isLoading, total });
        return;
      }

      // Marcar como procesado antes de enviar para evitar duplicados
      pendingFilterChangeRef.current = false;

      filterCounterRef.current++;

      // Calcular el conteo actual basado en el total de resultados
      // Este total ya refleja los filtros aplicados
      const searchCount = calculateSearchCount();

      // Obtener los valores de los filtros actuales en el momento exacto de enviar
      const fixerNameValue = getFixerNameValue();
      const cityValue = getCityValue();
      const jobTypeValue = getJobTypeValue();

      console.log('=== REGISTRANDO FILTROS ===');
      console.log('Búsqueda asociada:', searchQuery);
      console.log('Filtros aplicados:', {
        fixer_name: fixerNameValue,
        city: cityValue,
        job_type: jobTypeValue,
      });
      console.log('Estado actual:', {
        searchCount,
        total,
        isLoading,
        offersCount: Array.isArray(offers) ? offers.length : 0,
      });

      const filterData = {
        filters: {
          fixer_name: fixerNameValue,
          city: cityValue,
          job_type: jobTypeValue,
          search_count: searchCount, // Registrar el número real de resultados filtrados
        },
      };

      try {
        console.log(
          `📤 Enviando FILTRO para búsqueda: "${searchQuery}"`,
          JSON.stringify(filterData, null, 2),
        );

        await updateFilters(filterData).unwrap();
        console.log(`✅ Filtro registrado exitosamente. Resultados encontrados: ${searchCount}`);
      } catch (error) {
        console.error('❌ Error al registrar filtro:', error);
        // Reintentar si hay error
        pendingFilterChangeRef.current = true;
      }
    }, 800); // Delay suficiente para asegurar que los resultados estén completamente actualizados

    return () => clearTimeout(timeoutId);
  }, [
    filters,
    search,
    total,
    isLoading,
    offers,
    updateFilters,
    calculateSearchCount,
    getFixerNameValue,
    getCityValue,
    getJobTypeValue,
  ]);

  const handleCardClick = useCallback(
    async (offer: JobOfferData) => {
      const adaptedOffer = adaptJobOffer(offer);
      setSelectedOffer(adaptedOffer);
      setIsModalOpen(true);

      if (!userId) {
        console.warn('User ID no disponible, no se registró el click');
        return;
      }

      const activityData = {
        userId: userId,
        date: new Date().toISOString(),
        role: userRole,
        type: 'click',
        metadata: {
          button: 'job_offer',
          jobTitle: adaptedOffer.title || 'Sin título',
          jobId: adaptedOffer._id,
        },
        timestamp: new Date().toISOString(),
      };

      try {
        await logClick(activityData).unwrap();
        console.log('Click registrado:', adaptedOffer.title);
      } catch (error) {
        console.error('Error al registrar clic:', error);
      }
    },
    [userId, userRole, logClick, adaptJobOffer],
  );

  // Resto del código permanece igual...
  useEffect(() => {
    if (!isLoading && totalPages > 0) {
      const params = new URLSearchParams(window.location.search);
      const pageParam = Number(params.get('page') || 1);

      let correctedPage = pageParam;

      if (pageParam < 1 || isNaN(pageParam)) {
        correctedPage = 1;
      } else if (pageParam > totalPages) {
        correctedPage = totalPages;
      }

      if (correctedPage !== pageParam) {
        params.set('page', correctedPage.toString());
        window.history.replaceState(null, '', `${window.location.pathname}?${params.toString()}`);
        dispatch(setPaginaActual(correctedPage));
      }
    }
  }, [isLoading, totalPages, dispatch]);

  useEffect(() => {
    if (typeof window !== 'undefined') {
      const params = new URLSearchParams(window.location.search);

      if (params.toString() === '' && search !== '') {
        let hasSavedSearch = false;
        try {
          hasSavedSearch = !!window.localStorage.getItem(STORAGE_KEYS.SEARCH);
        } catch (e) {
          hasSavedSearch = false;
          console.error('Error accessing localStorage:', e);
        }

        if (!hasSavedSearch) {
          console.log('Navegación directa detectada, limpiando búsqueda guardada');
          dispatch(setSearch(''));
          previousSearchQueryRef.current = '';
        }
      }
    }
  }, [dispatch, search]);

  useEffect(() => {
    const saveScrollPosition = () => {
      try {
        sessionStorage.setItem(SCROLL_POSITION_KEY, window.scrollY.toString());
      } catch {}
    };

    window.addEventListener('beforeunload', saveScrollPosition);
    return () => {
      window.removeEventListener('beforeunload', saveScrollPosition);
    };
  }, []);

  useEffect(() => {
    if (!isLoading && Array.isArray(offers) && offers.length > 0 && !scrollRestoredRef.current) {
      try {
        const savedPosition = sessionStorage.getItem(SCROLL_POSITION_KEY);
        if (savedPosition) {
          const position = parseInt(savedPosition, 10);
          if (!isNaN(position)) {
            setTimeout(() => {
              window.scrollTo(0, position);
              scrollRestoredRef.current = true;
              sessionStorage.removeItem(SCROLL_POSITION_KEY);
            }, 100);
          }
        }
      } catch {}
    }
  }, [isLoading, offers]);

  useEffect(() => {
    if (typeof window === 'undefined') return;

    const update = () => {
      const hdr = document.querySelector('header');
      const h = hdr ? (hdr as HTMLElement).getBoundingClientRect().height : 0;
      if (stickyRef.current) {
        stickyRef.current.style.top = `${h}px`;
        stickyRef.current.style.zIndex = '40';
      }
    };

    update();
    window.addEventListener('resize', update);

    const hdrEl = document.querySelector('header');
    const mo = hdrEl ? new MutationObserver(update) : null;
    if (mo && hdrEl) mo.observe(hdrEl, { attributes: true, childList: true, subtree: true });

    return () => {
      window.removeEventListener('resize', update);
      if (mo) mo.disconnect();
    };
  }, []);

  const handleCloseModal = useCallback(() => {
    setIsModalOpen(false);
  }, []);

  const handleRegistrosPorPaginaChange = useCallback(
    (valor: number) => {
      scrollRestoredRef.current = true;
      window.scrollTo({ top: 0, behavior: 'smooth' });
      dispatch(setRegistrosPorPagina(valor));
    },
    [dispatch],
  );

  const handleFiltersApply = useCallback(
    (appliedFilters: FilterState) => {
      scrollRestoredRef.current = true;
      window.scrollTo({ top: 0, behavior: 'smooth' });

      const hasFilters =
        appliedFilters.range.length > 0 ||
        (Array.isArray(appliedFilters.city)
          ? appliedFilters.city.length > 0
          : !!appliedFilters.city) ||
        appliedFilters.category.length > 0;

      if (hasFilters && !hasActiveFilters.current) {
        pageBeforeFilter.current = paginaActual;
        hasActiveFilters.current = true;
      }

      if (!hasFilters) {
        hasActiveFilters.current = false;
      }

      dispatch(setFilters(appliedFilters));
      dispatch(resetPagination());
    },
    [dispatch, paginaActual],
  );

  const handleSortChange = useCallback(
    (option: string) => {
      scrollRestoredRef.current = true;
      window.scrollTo({ top: 0, behavior: 'smooth' });
      const backendSort = getSortValue(option);
      // Cuando se cambia el orden, resetear la paginación a la página 1
      dispatch(setSortBy(backendSort));
      dispatch(resetPagination());
    },
    [dispatch],
  );

  const handleResetFilters = useCallback(() => {
    const pageToRestore = hasActiveFilters.current ? pageBeforeFilter.current : 1;
    hasActiveFilters.current = false;

    dispatch(resetFilters());

    setTimeout(() => {
      dispatch(enablePersistence());
      dispatch(setPaginaActual(pageToRestore));
    }, 0);
  }, [dispatch]);

  const handlePageChange = useCallback(
    (newPage: number) => {
      scrollRestoredRef.current = true;
      window.scrollTo({ top: 0, behavior: 'smooth' });
      dispatch(setPaginaActual(newPage));
    },
    [dispatch],
  );

  const handleRatingChange = useCallback(
    (rating: number | null) => {
      scrollRestoredRef.current = true;
      window.scrollTo({ top: 0, behavior: 'smooth' });

      const hasRatingFilter = rating != null;
      if (hasRatingFilter && !hasActiveFilters.current) {
        pageBeforeFilter.current = paginaActual;
        hasActiveFilters.current = true;
      }

      if (!hasRatingFilter) {
        hasActiveFilters.current = false;
      }

      dispatch(setRating(rating));
      dispatch(resetPagination());
    },
    [dispatch, paginaActual],
  );

  const toggleDrawer = useCallback(() => setIsDrawerOpen((prev) => !prev), []);

  const handleViewModeChange = useCallback((mode: ViewMode) => {
    setViewMode(mode);
  }, []);

  const processedOffers = useMemo(() => {
    return offers;
  }, [offers]);

  return (
    <>
      <h1 className='mt-20 sm:mt-24 md:mt-28 lg:mt-32 mb-0 text-center text-xl sm:text-2xl md:text-3xl font-bold pt-3 px-3'>
        {t('pageTitle')}
      </h1>

      <div
        ref={stickyRef}
        className={`w-full mx-auto px-3 sm:px-4 md:px-6 lg:max-w-5xl sticky top-0 bg-white py-3 shadow-md ${
          isDrawerOpen ? 'z-10' : 'z-50'
        }`}
      >
        <div className='flex gap-2'>
          <FilterButton onClick={toggleDrawer} />
          <SearchBar onSearch={handleSearchSubmit} />
        </div>

        {!isLoading && Array.isArray(offers) && offers.length > 0 && (
          <div className='flex flex-col gap-2 mt-2'>
            <div className='flex justify-between items-center gap-2'>
              <div className='w-auto'>
                <SortCard value={sortBy} onSelect={handleSortChange} />
              </div>

              {/* Mobile view toggle */}
              <ViewModeToggle
                viewMode={viewMode}
                onChange={handleViewModeChange}
                variant='mobile'
                className='flex lg:hidden'
              />

              {/* Desktop view toggle */}
              <ViewModeToggle
                viewMode={viewMode}
                onChange={handleViewModeChange}
                variant='desktop'
                className='hidden lg:flex absolute left-1/2 transform -translate-x-1/2'
              />

              <div className='hidden lg:block w-auto'>
                <PaginationSelector
                  registrosPorPagina={registrosPorPagina}
                  onChange={handleRegistrosPorPaginaChange}
                />
              </div>
            </div>

            <div className='flex justify-center lg:hidden'>
              <PaginationSelector
                registrosPorPagina={registrosPorPagina}
                onChange={handleRegistrosPorPaginaChange}
              />
            </div>
          </div>
        )}
      </div>

      <main className='px-4 sm:px-6 md:px-12 lg:px-24'>
        {reduxError && (
          <div className='text-red-500 text-center mb-4 p-3 bg-red-100 rounded'>{reduxError}</div>
        )}

        {isLoading && (
          <div className='text-blue-500 text-center mb-4 p-3 bg-blue-100 rounded'>
            {t('loading', { default: 'Cargando ofertas...' })}
          </div>
        )}

        <FilterDrawer
          isOpen={isDrawerOpen}
          onClose={() => setIsDrawerOpen(false)}
          onFiltersApply={handleFiltersApply}
          onRatingChange={handleRatingChange}
          onReset={handleResetFilters}
        />

        {!isLoading && Array.isArray(offers) && offers.length > 0 && (
          <div className='w-full max-w-5xl mx-auto mb-4'>
            <div className='flex justify-center'>
              <PaginationInfo
                paginaActual={paginaActual}
                registrosPorPagina={registrosPorPagina}
                totalRegistros={total}
              />
            </div>
          </div>
        )}

        <div className='w-full max-w-5xl mx-auto'>
          {!isLoading && Array.isArray(offers) && offers.length > 0 ? (
            <JobOffersView
              offers={processedOffers}
              viewMode={viewMode}
              onOfferClick={handleCardClick}
              search={search}
            />
          ) : !isLoading ? (
            <NoResultsMessage search={search} />
          ) : null}
        </div>

        {!isLoading && Array.isArray(offers) && offers.length > 0 && viewMode !== 'map' && (
          <div className='mt-8 mb-24 flex justify-center'>
            <Paginacion
              paginaActual={paginaActual}
              registrosPorPagina={registrosPorPagina}
              totalRegistros={total}
              onChange={handlePageChange}
            />
          </div>
        )}
      </main>

      <JobOfferModal offer={selectedOffer} isOpen={isModalOpen} onClose={handleCloseModal} />
    </>
  );
}
</file>

<file path="src/app/[locale]/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { useSelector } from 'react-redux';
import { useTranslations } from 'next-intl';
import HeroSection from '@/Components/Home/Hero-section';
import ServicesSection from '@/Components/Home/Services-section';
import HowItWorksSection from '@/Components/Home/HowItWorks-section';
import CTASection from '@/Components/Home/CTA-section';
import InspirationSection from '@/Components/Home/Inspiration-section';
import RecentOffersSection from '@/Components/Home/RecentOffer-secction';
import MapSection from '@/Components/Home/MapSection';
import { IUser } from '@/types/user';

interface RootState {
  user: {
    user: IUser | null;
    loading: boolean;
    isAuthenticated: boolean;
  };
}

export default function Home() {
  const { user, loading } = useSelector((state: RootState) => state.user);
  const [authReady, setAuthReady] = useState(false);
  const t = useTranslations('home');

  useEffect(() => {
    if (!loading) setAuthReady(true);
  }, [loading]);

  if (!authReady) return null;

  const isFixer = user?.role === 'fixer';

  return (
    <div className='min-h-screen bg-white relative'>
      <div
        id='tour-start-point'
        className='absolute top-0 left-0 w-1 h-1 opacity-0 pointer-events-none'
      />

      {/* Hero cambia según el rol */}
      <HeroSection isFixer={isFixer} />

      <section className={isFixer ? 'bg-white' : 'py-16 px-4 bg-white'}>
        <div className='max-w-7xl mx-auto'>
          {/* Mapa e inspiración solo para requesters */}
          {!isFixer && (
            <>
              {/* ✅ USAR MapSection en lugar del código anterior */}
              <MapSection />

              <InspirationSection />
            </>
          )}
          <RecentOffersSection />
        </div>
      </section>

      <ServicesSection
        showHero={false}
        showAllServices={false}
        showCTA={false}
        title='Servicios Disponibles'
        subtitle='Encuentra el profesional perfecto para cualquier trabajo en tu hogar'
      />

      {!isFixer && (
        <>
          <HowItWorksSection />
          <CTASection />
        </>
      )}
    </div>
  );
}
</file>

<file path="src/app/[locale]/payment/components/CardList.tsx">
'use client';
import { useEffect, useState } from 'react';
import AddCardModal from './AddCardModal';
import { motion, AnimatePresence } from 'framer-motion';

// --- INICIO DE LA CORRECCIÓN ---

// 1. Definir la interfaz para las props del componente
interface CardListProps {
  requesterId: string;
  fixerId: string;
  jobId: string;
  amount: number;
  onPaymentSuccess: () => void;
  // 🔑 CAMBIO 1: Añadir el token de reCAPTCHA a las props
  recaptchaToken: string | null;
}

// 2. Definir un tipo para la estructura de una tarjeta (basado en el uso)
interface Card {
  _id: string;
  brand?: string;
  last4: string;
  expMonth: string | number;
  expYear: string | number;
  cardholderName?: string;
  isDefault?: boolean;
}

// 3. Definir un tipo para el payload de onCardAdded
interface CardAddedPayload {
  payment: {
    _id: string;
    amount: number;
    card: { _id: string } | null;
  };
  cardSaved: boolean;
}

// --- FIN DE LA CORRECCIÓN ---

// 4. Aplicar la interfaz CardListProps a las props
export default function CardList({
  requesterId,
  fixerId,
  jobId,
  amount,
  onPaymentSuccess,
  // 🔑 CAMBIO 2: Desestructurar el token
  recaptchaToken,
}: CardListProps) {
  // 5. Aplicar el tipo Card al estado 'cards' y 'confirmModal'
  const [cards, setCards] = useState<Card[]>([]);
  const [showModal, setShowModal] = useState(false);
  const [processingCardId, setProcessingCardId] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState('');
  const [confirmModal, setConfirmModal] = useState<Card | null>(null); // card a pagar

  const fetchCards = async () => {
    try {
      const res = await fetch(
        `${process.env.NEXT_PUBLIC_BACKEND_URL}/api/cards?userId=${requesterId}`,
      );
      if (!res.ok) throw new Error('Error fetching cards');
      const data = await res.json();
      setCards(data);
    } catch (err) {
      console.error(err);
    }
  };

  useEffect(() => {
    fetchCards();
  }, []); // El array vacío está bien si fetchCards no depende de props
  // 6. Aplicar el tipo al payload de 'handleCardAdded'

  const handleCardAdded = async ({ payment, cardSaved }: CardAddedPayload) => {
    await fetchCards();
    setShowModal(false);

    const message = cardSaved
      ? `✅ Transacción exitosa y tarjeta guardada (${payment.amount} BOB)`
      : `✅ Transacción exitosa (${payment.amount} BOB)`;

    showSuccessModal(message, onPaymentSuccess);
  }; // 7. Aplicar el tipo Card a la función 'confirmPay'

  const confirmPay = (card: Card) => {
    if (!recaptchaToken) {
      // 🛑 Verificación de seguridad adicional
      alert('Por favor, completa la verificación de seguridad (reCAPTCHA) primero.');
      return;
    }
    setConfirmModal(card);
  }; // 8. Aplicar el tipo Card a la función 'handlePayWithCard'

  const handlePayWithCard = async (card: Card) => {
    if (processingCardId) return;
    // 🛑 Verificación crítica: Asegurarse de que el token esté presente
    if (!recaptchaToken) {
      alert('Error de seguridad: Token de verificación faltante. Inténtalo de nuevo.');
      setConfirmModal(null);
      return;
    }

    setProcessingCardId(card._id);
    setConfirmModal(null);

    try {
      const paymentRes = await fetch(`${process.env.NEXT_PUBLIC_BACKEND_URL}/api/createpayment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          requesterId,
          fixerId,
          jobId,
          cardId: card._id,
          amount,
          // 🔑 CAMBIO 3: Incluir el token en el payload
          recaptchaToken: recaptchaToken,
        }),
      });

      const paymentData = await paymentRes.json();

      // Si la respuesta no es OK, el backend podría estar enviando un error de Captcha.
      if (!paymentRes.ok) {
        // Asume que el backend devuelve un mensaje de error legible.
        throw new Error(paymentData?.error || 'Error desconocido al procesar el pago.');
      } // 💡 Actualizar tarjetas si es necesario

      await fetchCards(); // ✅ Llamar al callback real para refrescar trabajos

      onPaymentSuccess?.();
    } catch (err: unknown) {
      console.error(err);
      alert(`Error al procesar el pago: ${err.message || 'Error desconocido'}`);
    } finally {
      setProcessingCardId(null);
    }
  }; // 9. Tipar los parámetros de 'showSuccessModal'

  const showSuccessModal = (msg: string, onComplete: () => void) => {
    setSuccessMessage(msg);
    setTimeout(() => {
      setSuccessMessage('');
      onComplete?.();
    }, 2500); // 2.5 segundos
  }; // 🎨 Paleta más realista y oscura

  const cardBackgrounds: { [key: string]: string } = {
    // Tipar el objeto
    visa: 'from-blue-950 via-blue-800 to-blue-700',
    mastercard: 'from-red-900 via-orange-800 to-yellow-700',
    amex: 'from-cyan-900 via-teal-800 to-teal-700',
    default: 'from-gray-800 via-gray-700 to-gray-600',
  };

  const getCardBackground = (brand: string | undefined) => {
    // Tipar 'brand'
    const key = brand?.toLowerCase() || 'default';
    return cardBackgrounds[key] || cardBackgrounds.default;
  };

  return (
    <div className='min-h-screen bg-[#D1D5DB] p-10 text-black relative'>
           {' '}
      <div className='flex justify-between items-center gap-3 mb-10'>
                <h1 className='text-3xl font-extrabold'> Mis Tarjetas Guardadas</h1>       {' '}
        <motion.button
          whileTap={{ scale: 0.95 }}
          onClick={() => setShowModal(true)}
          className='px-6 py-3 bg-[#2B6AE0] rounded-xl shadow-lg hover:bg-[#2BDDE0] transition-all font-semibold flex items-center gap-2'
        >
                    Agregar➕        {' '}
        </motion.button>
             {' '}
      </div>
           {' '}
      {cards.length === 0 ? (
        <p className='text-center text-gray-400'>No tienes tarjetas guardadas.</p>
      ) : (
        <div className='grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10'>
                   {' '}
          {cards.map((card, index) => (
            <motion.div
              key={card._id}
              initial={{ rotateY: 10, rotateX: 8, y: 10, opacity: 0 }}
              animate={{ rotateY: 0, rotateX: 0, y: 0, opacity: 1 }}
              transition={{ type: 'spring', stiffness: 120, damping: 10, delay: index * 0.1 }}
              whileHover={{
                rotateY: 8,
                y: -5,
                boxShadow: '0px 8px 25px rgba(0,0,0,0.3)',
              }} // He quitado getCardBackground para simplificar, puedes añadirlo si quieres
              className={`relative rounded-2xl shadow-2xl p-6 text-black bg-[#1AA7ED]`}
            >
                            {/* Reflejo */}             {' '}
              <div className='absolute inset-0 bg-gradient-to-tr from-white/10 to-transparent rounded-2xl pointer-events-none'></div>
                            {/* Logo */}             {' '}
              <div className='flex justify-between items-center mb-6'>
                               {' '}
                <p className='text-lg font-semibold tracking-wide uppercase'>{card.brand}</p>
                               {' '}
                <img
                  src={
                    card.brand?.toLowerCase() === 'visa'
                      ? 'https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg'
                      : card.brand?.toLowerCase() === 'mastercard'
                        ? 'https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg'
                        : 'https://upload.wikimedia.org/wikipedia/commons/f/fd/Generic-credit-card-icon.svg'
                  }
                  alt='brand'
                  className='h-6 w-auto'
                />
              </div>
              {/* Número */}
              <div className='text-2xl tracking-widest font-mono mb-4'>
                **** **** **** {card.last4}
              </div>
              {/* Exp y titular */}
              <div className='flex justify-between text-sm opacity-90'>
                <div>
                  <p className='uppercase'>Expira</p>
                  <p className='font-semibold'>
                    {card.expMonth}/{card.expYear}
                  </p>
                </div>
                <div className='text-right'>
                  <p className='uppercase'>Titular</p>
                  <p className='font-semibold truncate w-32'>{card.cardholderName || 'usuario'}</p>
                </div>
              </div>
              {card.isDefault && (
                <div className='absolute top-2 right-2 text-black bg-[#2BDDE0] px-2 py-1 text-xs rounded-full shadow'>
                  Predeterminada
                </div>
              )}
              {/* Botón pagar */}
              <motion.button
                whileTap={{ scale: 0.95 }}
                onClick={() => confirmPay(card)}
                disabled={processingCardId === card._id || !recaptchaToken} // 🛑 Deshabilitar si no hay token
                className={`mt-6 w-full py-2 rounded-xl font-bold text-white shadow-lg ${
                  processingCardId === card._id || !recaptchaToken // 🛑 Aplicar estilo deshabilitado
                    ? 'bg-gray-500 cursor-not-allowed' // Cambié el color para mayor claridad
                    : 'bg-[#2B6AE0] hover:bg-[#2BDDE0]'
                }`}
              >
                {processingCardId === card._id ? 'Procesando...' : `Pagar ${amount} BOB`}
              </motion.button>
              {!recaptchaToken && (
                <p className='text-xs text-red-700 mt-2 font-semibold'>
                  Completa el Captcha antes de pagar.
                </p>
              )}
            </motion.div>
          ))}
        </div>
      )}
      {/* Modal agregar tarjeta */}
      {showModal && (
        <AddCardModal
          userId={requesterId}
          fixerId={fixerId}
          jobId={jobId}
          amount={amount}
          // 🛑 NOTA: Debes agregar el recaptchaToken aquí también si el modal AddCardModal llama a createpayment
          // recaptchaToken={recaptchaToken}
          onClose={() => setShowModal(false)}
          onCardAdded={handleCardAdded}
        />
      )}
      {/* Modal de confirmación */}
      <AnimatePresence>
        {confirmModal && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className='fixed inset-0 flex justify-center items-center bg-black/60 backdrop-blur-sm z-50'
          >
            <motion.div
              initial={{ scale: 0.8, y: 30 }}
              animate={{ scale: 1, y: 0 }}
              exit={{ scale: 0.8, y: 30 }}
              className='bg-[#2B6AE0] p-8 rounded-2xl shadow-2xl text-center max-w-sm w-full'
            >
              <h2 className='text-xl font-bold mb-4'>⚠️ Confirmar Pago</h2>
              <p className='text-black mb-6'>
                ¿Seguro que deseas pagar{' '}
                <span className='font-bold text-[#2BDDE0]'>{amount} BOB </span>
                con la tarjeta terminada en <span className='font-bold'>{confirmModal.last4}</span>?
              </p>
              <div className='flex justify-center gap-4'>
                <button
                  onClick={() => setConfirmModal(null)}
                  className='px-5 py-2 bg-[#D1D5DB] rounded-xl hover:bg-[#2BDDE0] transition'
                >
                  Cancelar
                </button>
                <button
                  onClick={() => handlePayWithCard(confirmModal)}
                  className='px-5 py-2 bg-[#D1D5DB] rounded-xl hover:bg-[#2BDDE0] transition font-semibold'
                >
                  Confirmar Pago
                </button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>
      {/* Modal éxito */}
      <AnimatePresence>
        {successMessage && (
          <motion.div
            initial={{ opacity: 0, scale: 0.8, y: 50 }}
            animate={{ opacity: 1, scale: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.8, y: 50 }}
            className='fixed inset-0 flex justify-center items-center bg-black/40 backdrop-blur-sm z-50'
          >
            <div className='bg-[#2B6AE0] text-black px-10 py-6 rounded-2xl shadow-xl text-center'>
              <h2 className='text-xl font-bold mb-3'>✅ ¡Transacción Exitosa!</h2>
              <p className='text-black'>{successMessage}</p>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}
</file>

<file path="src/app/[locale]/payment/service/payment.ts">
// --- Types compartidos UI ---
export type Status = "paid" | "pending" | "failed";

// La UI siempre consumirá este shape uniforme
export type UISummary = {
  id: string;
  status: Status;
  code?: string | null;
  expiresAt?: string | null;
  amount: {
    total: number;
    currency: string;
  };
};

// --- Tipo para los datos que llegan del backend (flexible) ---
type BackendPaymentData = {
  id?: string;
  _id?: string;
  status?: string;
  code?: string;
  expiresAt?: string;
  total?: number;
  amount?: {
    total?: number;
    currency?: string;
  };
  currency?: string;
  [key: string]: unknown; // Para permitir otras propiedades
};

// --- Helper base: SIEMPRE rutas relativas para pasar por el proxy /api ---
async function apiFetch<T = unknown>(
  path: string,
  init?: RequestInit & { json?: unknown }
): Promise<T> {
  const opts: RequestInit = {
    cache: "no-store",
    ...init,
    headers: { "Content-Type": "application/json", ...(init?.headers || {}) },
  };
  if (init?.json !== undefined) {
    opts.body = JSON.stringify(init.json);
  }

  const res = await fetch(`/api${path}`, opts);

  if (!res.ok) {
    const raw = await res.text().catch(() => "");
    let msg = raw;
    const ct = res.headers.get("content-type") || "";
    if (ct.includes("application/json")) {
      try {
        const j = JSON.parse(raw);
        msg = j?.error || j?.message || raw || `HTTP ${res.status}`;
      } catch {}
    }
    throw new Error(`${msg || "Request failed"} (HTTP ${res.status})`);
  }

  const ct = res.headers.get("content-type") || "";
  return ct.includes("application/json") ? res.json() : ({} as T);
}

// --- Normalizador: adapta cualquier backend a UISummary uniforme ---
function normalizeSummary(d: BackendPaymentData | null | undefined): UISummary {
  if (!d) {
    return {
      id: "",
      status: "pending" as Status,
      code: null,
      expiresAt: null,
      amount: {
        total: 0,
        currency: "BOB",
      },
    };
  }

  const total =
    typeof d.total === "number"
      ? d.total
      : typeof d.amount?.total === "number"
      ? d.amount.total
      : 0;

  return {
    id: String(d.id ?? d._id ?? ""),
    status: (d.status ?? "pending") as Status,
    code: d.code ?? null,
    expiresAt: d.expiresAt ?? null,
    amount: {
      total,
      currency: d.amount?.currency ?? d.currency ?? "BOB",
    },
  };
}

// --- DTO de creación (cash) ---
export type CreateCashPaymentDTO = {
  jobId: string;
  payerId?: string;
  requesterId?: string;
  fixerId?: string;
  subTotal: number;
  service_fee?: number;
  discount?: number;
  currency?: "BOB" | "USD";
  paymentMethods?: "cash" | "qr" | "card";
  commissionRate?: number;
};

// --- POST: crear pago (cash) ---
export async function createCashPayment(input: CreateCashPaymentDTO) {
  const payload = {
    jobId: input.jobId,
    ...(input.requesterId ? { requesterId: input.requesterId } : {}),
    ...(input.fixerId ? { fixerId: input.fixerId } : {}),
    ...(input.payerId ? { payerId: input.payerId } : {}),
    subTotal: input.subTotal,
    service_fee: input.service_fee ?? 0,
    discount: input.discount ?? 0,
    currency: input.currency ?? "BOB",
    paymentMethods: input.paymentMethods ?? "cash",
    commissionRate: input.commissionRate ?? 0.1,
  };

  return apiFetch<{ message: string; data: BackendPaymentData }>(`/lab/payments`, {
    method: "POST",
    json: payload,
  });
}

// --- GET: summary por ID ---
export async function getPaymentSummaryById(id: string): Promise<UISummary> {
  const r = await apiFetch<{ data?: BackendPaymentData } | BackendPaymentData>(`/lab/payments/${id}/summary`);
  const data = 'data' in r ? r.data : r;
  return normalizeSummary(data);
}

// --- GET: último summary por jobId ---
export async function getLastPaymentSummaryByJob(jobId: string): Promise<UISummary> {
  const r = await apiFetch<{ data?: BackendPaymentData } | BackendPaymentData>(`/lab/payments/by-job/${jobId}/summary`);
  const data = 'data' in r ? r.data : r;
  return normalizeSummary(data);
}

// --- PATCH: confirmar pago ---
export async function confirmPayment(id: string, code: string) {
  return apiFetch<{ 
    message: string; 
    data: { 
      id: string; 
      total: number; 
      status: Status; 
      paidAt?: string 
    } 
  }>(
    `/lab/payments/${id}/confirm`,
    { method: "PATCH", json: { code } }
  );
}
</file>

<file path="src/app/[locale]/signUp/page.tsx">
'use client';
import { useState } from 'react';
import Link from 'next/link';
import RegistroGoogle from './registrar/registroServicios/registroGoogle';
import RegistroForm from './registrar/registroServicios/page';
import GithubButton from '@/Components/requester/botonRegistro/buttonGithub';
import DiscordButton from '@/Components/requester/botonRegistro/buttonDiscord';
import ReCaptchaForm from '@/Components/requester/botonRegistro/recaptcha';
import NotificationModal from '@/Components/Modal-notifications';
import { useTranslations } from 'next-intl';
export default function SignUp() {
  const t = useTranslations('SignUpRegister');
   const [captchaValid, setCaptchaValid] = useState(false);
  const [notification, setNotification] = useState({
    isOpen: false,
    type: 'info' as 'success' | 'error' | 'info' | 'warning',
    title: '',
    message: '',
  });

  const handleNotify = (notif: {
    type: 'success' | 'error' | 'info' | 'warning';
    title: string;
    message: string;
  }) => {
    setNotification({ isOpen: true, ...notif });
  };

  const handleCloseNotification = () => setNotification((prev) => ({ ...prev, isOpen: false }));

  return (
    <>
      <NotificationModal
        isOpen={notification.isOpen}
        onClose={handleCloseNotification}
        type={notification.type}
        title={notification.title}
        message={notification.message}
        autoClose
        autoCloseDelay={3000}
      />

      <section className='flex justify-center items-center min-h-screen bg-gradient-to-b from-white to-blue-50 animate-fadeInUp relative'>
        <div className='w-full max-w-sm bg-white/90 backdrop-blur-xl border border-blue-100 rounded-3xl shadow-xl p-10 transition-all duration-300 hover:shadow-2xl hover:scale-[1.01] relative z-10'>
          <h1 className='text-3xl font-bold text-center mb-2 bg-gradient-to-r from-primary/80 to-primary/60 bg-clip-text text-transparent'>
            {t('title')}
          </h1>
          <p className='text-center text-gray-600 mb-8 text-sm'>{t('mode')}</p>
          <RegistroForm captchaValid={captchaValid} onNotify={handleNotify} />

          <div className='flex items-center my-6'>
            <div className='flex-1 h-px bg-gray-300' />
            <span className='px-3 text-gray-400 text-sm'>{t('separator')}</span>
            <div className='flex-1 h-px bg-gray-300' />
          </div>

          <div className='flex flex-col items-center space-y-3 mt-3'>
            <RegistroGoogle onNotify={handleNotify} captchaValid={captchaValid} />
            <GithubButton onNotify={handleNotify} captchaValid={captchaValid} />

            <DiscordButton onNotify={handleNotify} captchaValid={captchaValid} />
          </div>
          <div className='mt-5'>
            <ReCaptchaForm onVerified={(success) => setCaptchaValid(success)} />
          </div>

          <div className='flex items-start mt-5 text-sm text-gray-600'>
            <input
              type='checkbox'
              className='mt-1 mr-2 accent-blue-500 focus:ring-2 focus:ring-blue-300 rounded'
            />
            <p>
              {t('terms.text')}{' '}
              <Link
                href='signUp/registrar/Terminosycondiciones'
                className='text-blue-500 hover:text-blue-400 font-semibold hover:underline transition'
              >
                {t('terms.link')}
              </Link>
              .
            </p>
          </div>

          <p className='mt-6 text-center text-gray-700 text-sm'>
            {t('login.text')}{' '}
            <Link
              href='login'
              className='text-blue-500 hover:text-blue-400 font-semibold hover:underline transition'
            >
              {t('login.link')}
            </Link>
          </p>
        </div>
      </section>
    </>
  );
}
</file>

<file path="src/app/[locale]/tracking-appointments/page.tsx">
'use client';

import React, { useState } from 'react';
import dynamic from 'next/dynamic';
import { useTranslations } from 'next-intl';

import {
  useGetMapLocationsQuery,
  useGetTrackingMetricsQuery,
  useGetFixerStatsQuery,
} from '@/app/redux/services/trackingAppointmentsApi';

import FixerStatsTable from '@/Components/Statistics-panel/fixer-stats-table';
import MetricsCards from '@/Components/Statistics-panel/metrics-cards';

// 1. Definimos la interfaz de lo que viene de la API
interface ApiAppointment {
  _id: string;
  lat: string | number;
  lon: string | number;
  fixerName?: string;
  requesterName?: string;
  current_requester_name?: string;
  date?: string;
  starting_time?: string;
  status?: string;
  schedule_state?: string;
}

// 2. Definimos la interfaz de lo que usa el Mapa (debe coincidir con admin-map)
interface MappedAppointment {
  id: string;
  fixerName: string;
  requesterName: string;
  date: string;
  status: string;
  lat: number;
  lng: number;
  service: string;
}

// Importación dinámica correcta (esto asegura que Leaflet no rompa el SSR)
const AdminMap = dynamic(() => import('@/Components/Statistics-panel/admin-map'), {
  ssr: false,
  loading: () => (
    <div className='h-full w-full bg-gray-100 flex items-center justify-center text-gray-500 animate-pulse'>
      {/* El texto se traduce en el componente padre */}
      <span id='map-loading-text'></span>
    </div>
  ),
});

const StatisticsPage: React.FC = () => {
  const t = useTranslations('tracking');

  const [startDate, setStartDate] = useState('');
  const [endDate, setEndDate] = useState('');

  const { data: metrics = { total: 0, active: 0, cancelled: 0 } } = useGetTrackingMetricsQuery({
    startDate,
    endDate,
  });

  const { data: rawMapData = [], isLoading: loadingMap } = useGetMapLocationsQuery();

  const { data: fixerStats = [] } = useGetFixerStatsQuery();

  // Actualizar el texto del loading después del montaje
  React.useEffect(() => {
    const loadingElement = document.getElementById('map-loading-text');
    if (loadingElement) {
      loadingElement.textContent = t('map.loading');
    }
  }, [t]);

  const filteredAppointments = React.useMemo(() => {
    if (!rawMapData) return [];

    return (
      (rawMapData as ApiAppointment[]) // Aseguramos el tipo de entrada
        .map(
          (app): MappedAppointment => ({
            id: app._id,
            fixerName: app.fixerName || t('map.unknown'),
            requesterName: app.requesterName || app.current_requester_name || t('map.client'),
            date: app.date || app.starting_time || '',
            status: app.status || app.schedule_state || 'unknown',
            lat: Number(app.lat),
            lng: Number(app.lon),
            service: '',
          }),
        )
        // Ahora 'app' ya es de tipo MappedAppointment, así que TS sabe que lat y lng son números
        .filter((app) => !isNaN(app.lat) && !isNaN(app.lng))
        // Filtro de fechas
        .filter((app) => {
          if (!startDate || !endDate) return true;
          const appointmentDate = new Date(app.date);
          const start = new Date(startDate);
          const end = new Date(endDate);
          end.setHours(23, 59, 59);
          return appointmentDate >= start && appointmentDate <= end;
        })
    );
  }, [rawMapData, startDate, endDate, t]);

  return (
    <div className='w-full min-h-screen bg-gray-50 pb-10'>
      <div className='max-w-7xl mx-auto px-6 py-8 flex flex-col gap-8'>
        {/* 1. ENCABEZADO Y FILTROS */}
        <div className='bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex flex-col md:flex-row justify-between items-center gap-4'>
          <div>
            <h1 className='text-2xl font-bold text-gray-800'>{t('title')}</h1>
            <p className='text-gray-500 text-sm'>{t('subtitle')}</p>
          </div>

          <div className='flex flex-wrap gap-3 items-end'>
            <div>
              <label className='text-xs text-gray-500 block mb-1 font-medium'>
                {t('filters.from')}
              </label>
              <input
                type='date'
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
                className='border border-gray-300 rounded-lg px-3 py-1.5 text-sm outline-none focus:ring-2 focus:ring-blue-500'
              />
            </div>
            <div>
              <label className='text-xs text-gray-500 block mb-1 font-medium'>
                {t('filters.to')}
              </label>
              <input
                type='date'
                value={endDate}
                onChange={(e) => setEndDate(e.target.value)}
                className='border border-gray-300 rounded-lg px-3 py-1.5 text-sm outline-none focus:ring-2 focus:ring-blue-500'
              />
            </div>
          </div>
        </div>

        {/* 2. FILA SUPERIOR: MAPA (75%) + MÉTRICAS (25%) */}
        <div className='grid grid-cols-1 lg:grid-cols-4 gap-6 lg:h-[550px]'>
          {/* MAPA */}
          <div className='lg:col-span-3 bg-white rounded-xl shadow border border-gray-200 overflow-hidden relative z-0 h-[400px] lg:h-full'>
            {loadingMap ? (
              <div className='h-full w-full flex items-center justify-center text-gray-500'>
                {t('map.loadingData')}
              </div>
            ) : filteredAppointments.length > 0 ? (
              <AdminMap appointments={filteredAppointments} />
            ) : (
              <div className='h-full w-full flex flex-col items-center justify-center text-gray-400'>
                <p>{t('map.noAppointments')}</p>
              </div>
            )}
          </div>

          {/* COLUMNA DERECHA: MÉTRICAS */}
          <div className='lg:col-span-1 h-full flex flex-col gap-6'>
            <div className='shrink-0'>
              <MetricsCards metrics={metrics} />
            </div>
          </div>
        </div>

        <div className='w-full'>
          <FixerStatsTable stats={fixerStats} />
        </div>
      </div>
    </div>
  );
};

export default StatisticsPage;
</file>

<file path="src/app/[locale]/user-admin/components/adminLogin.tsx">
'use client';
import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useTranslations, useLocale } from 'next-intl';
import styles from '../styles/admin.module.css';
import { adminAPI } from '../lib/api';

// Definir tipo para la respuesta de Google Token Client
interface GoogleTokenResponse {
  access_token?: string;
  error?: string;
  credential?: string;
}

// Definir tipo para el callback de Google
type GoogleTokenCallback = (response: GoogleTokenResponse) => void;

// Extender la interfaz Window para incluir Google
declare global {
  interface Window {
    google?: {
      accounts: {
        oauth2: {
          initTokenClient: (config: {
            client_id: string;
            scope: string;
            callback: GoogleTokenCallback;
          }) => {
            requestAccessToken: () => void;
          };
        };
      };
    };
  }
}

export default function AdminLogin() {
  const t = useTranslations('adminLogin');
  const locale = useLocale();

  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [googleLoading, setGoogleLoading] = useState(false);
  const router = useRouter();

  // Función para login con Google
  const handleGoogleLogin = async () => {
    setGoogleLoading(true);

    try {
      // Cargar Google API
      await loadGoogleScript();

      // Inicializar Google Auth
      const google = window.google;
      const client = google?.accounts?.oauth2?.initTokenClient;

      if (!client) {
        throw new Error(t('errors.googleApiNotAvailable'));
      }

      const clientId = process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID;

      if (!clientId) {
        throw new Error(t('errors.googleClientIdNotConfigured'));
      }
      // Solicitar token
      client({
        client_id: clientId,
        scope: 'email profile',
        callback: async (response: GoogleTokenResponse) => {
          if (response.error) {
            console.error('Google auth error:', response);
            alert(t('errors.googleLoginError'));
            setGoogleLoading(false);
            return;
          }

          if (!response.credential) {
            console.error('No credential received from Google');
            alert(t('errors.noCredential'));
            setGoogleLoading(false);
            return;
          }

          try {
            // Enviar token al backend
            const data = await adminAPI.loginWithGoogle(response.credential);

            if (data.success) {
              localStorage.setItem('adminToken', data.token);
              localStorage.setItem('adminUser', JSON.stringify(data.user));
              router.push(`/${locale}/user-admin/dashboard`);
            } else {
              alert(data.message || t('errors.googleLoginError'));
            }
          } catch (error) {
            console.error('Google login error:', error);
            alert(t('errors.googleLoginError'));
          } finally {
            setGoogleLoading(false);
          }
        },
      }).requestAccessToken();
    } catch (error) {
      console.error('Google login error:', error);
      alert(t('errors.googleLoginError'));
      setGoogleLoading(false);
    }
  };

  // Función para cargar script de Google
  const loadGoogleScript = (): Promise<boolean> => {
    return new Promise((resolve, reject) => {
      if (window.google) {
        resolve(true);
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://accounts.google.com/gsi/client';
      script.async = true;
      script.defer = true;
      script.onload = () => resolve(true);
      script.onerror = () => reject(new Error('Failed to load Google script'));
      document.head.appendChild(script);
    });
  };

  // Login normal
  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      const data = await adminAPI.login({ email, password });

      if (data.success) {
        localStorage.setItem('adminToken', data.token);
        localStorage.setItem('adminUser', JSON.stringify(data.user));
        router.push(`/${locale}/user-admin/dashboard`);
      } else {
        alert(data.message || t('errors.incorrectCredentials'));
      }
    } catch (error) {
      console.error('Login error:', error);
      alert(t('errors.serverError'));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className={styles.adminLoginContainer}>
      <div className={styles.loginHeader}>
        <h1 className={styles.logo}>{t('logo')}</h1>
        <p className={styles.subtitle}>{t('subtitle')}</p>
        <h2 className={styles.welcome}>{t('welcome')}</h2>
      </div>

      <form onSubmit={handleLogin} className={styles.loginForm}>
        <div className={styles.inputGroup}>
          <label htmlFor='email'>{t('form.emailLabel')}</label>
          <input
            type='email'
            id='email'
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder={t('form.emailPlaceholder')}
            required
          />
        </div>

        <div className={styles.inputGroup}>
          <label htmlFor='password'>{t('form.passwordLabel')}</label>
          <input
            type='password'
            id='password'
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            placeholder='••••••••'
            required
          />
        </div>

        <button type='submit' className={styles.loginButton} disabled={loading}>
          {loading ? t('form.signingIn') : t('form.signInButton')}
        </button>

        <div className={styles.divider}>
          <span>{t('form.or')}</span>
        </div>

        {/*NUEVO: Botón de Google */}
        <button
          type='button'
          onClick={handleGoogleLogin}
          className={styles.googleButton}
          disabled={googleLoading}
        >
          {googleLoading ? t('form.connecting') : t('form.googleButton')}
        </button>
      </form>
    </div>
  );
}
</file>

<file path="src/app/redux/services/twofactor.ts">
// src/app/redux/services/twofactor.ts
const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';

function getAuthToken(): string | null {
  if (typeof window === 'undefined') return null;
  return localStorage.getItem('servineo_token');
}

type ApiResponse = Record<string, unknown>;

type ApiError = Error & {
  status?: number;
  data?: ApiResponse;
  // campos adicionales que usamos más abajo
  locked?: boolean;
  lockedUntil?: string;
  retryAfterSeconds?: number;
  attemptsLeft?: number;
  attempts?: number;
};

async function fetchWithAuth(endpoint: string, options: RequestInit = {}): Promise<ApiResponse> {
  const token = getAuthToken();

  const headers: Record<string, string> = {
    'Content-Type': 'application/json',
    ...((options.headers as Record<string, string>) || {}),
  };

  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }

  const url = `${API_BASE}/api/controlC/2fa${endpoint}`;

  const response = await fetch(url, {
    ...options,
    headers,
  });

  let data: ApiResponse = {};
  try {
    // intentamos parsear JSON; si no hay body válido, dejamos {}
    // (algunos endpoints pueden no devolver JSON)
    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment
    data = (await response.json()) as ApiResponse;
  } catch {
    // ignoramos fallo en parseo — mantenemos data = {}
  }

  if (!response.ok) {
    const error = new Error((data?.message as string) || `HTTP ${response.status}`) as ApiError;
    error.status = response.status;
    error.data = data;
    throw error;
  }

  return data;
}

// -----------------------------
// GENERAR QR
// -----------------------------
export async function generateQr(): Promise<ApiResponse> {
  return fetchWithAuth('/generate', { method: 'POST' });
}

// -----------------------------
// VERIFICAR TOKEN (AQUÍ ERA EL CAMBIO IMPORTANTE)
// -----------------------------
export async function verifyToken(token: string): Promise<ApiResponse> {
  try {
    return await fetchWithAuth('/verify', {
      method: 'POST',
      body: JSON.stringify({ token }),
    });
  } catch (err: unknown) {
    const apiErr = err as ApiError;
    const status = apiErr?.status;
    const data = (apiErr?.data as ApiResponse) ?? {};

    // ------------------------------------------------------
    // 💥 SI EL BACKEND INDICA BLOQUEO (423)
    // ------------------------------------------------------
    if (status === 423) {
      const e = new Error((data?.message as string) || 'Cuenta bloqueada temporalmente.') as ApiError;
      e.locked = true;
      e.lockedUntil = (data?.lockedUntil as string) ?? undefined;
      e.retryAfterSeconds = (data?.retryAfterSeconds as number) ?? undefined;
      throw e;
    }

    // ------------------------------------------------------
    // ❌ TOKEN INCORRECTO, PERO NO BLOQUEADO (400)
    // Back devuelve:
    // { message: "Token inválido", attemptsLeft, attempts }
    // ------------------------------------------------------
    if (status === 400) {
      const e = new Error((data?.message as string) || 'Token inválido') as ApiError;
      e.attemptsLeft = (data?.attemptsLeft as number) ?? undefined;
      e.attempts = (data?.attempts as number) ?? undefined;
      throw e;
    }

    // ------------------------------------------------------
    // ⚠️ Otros errores
    // ------------------------------------------------------
    const e = new Error((data?.message as string) || 'Error verificando código') as ApiError;
    throw e;
  }
}

// -----------------------------
// DESHABILITAR 2FA
// -----------------------------
export async function disable2fa(): Promise<ApiResponse> {
  return fetchWithAuth('/disable', { method: 'POST' });
}
</file>

<file path="src/Components/requester/Authenticator/VerifyTokenModal.tsx">
'use client';
import React, { useEffect, useState } from 'react';

interface Props {
  open: boolean;
  onClose: () => void;
  onVerify: (token: string) => Promise<void> | void;
  loading?: boolean;
}

export default function VerifyTokenModal({ open, onClose, onVerify, loading }: Props) {
  const [code, setCode] = useState('');
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  const [shake, setShake] = useState(false);

  // NUEVO: intentos restantes y mensaje de bloqueo
  const [attemptsLeft, setAttemptsLeft] = useState<number | null>(null);
  const [lockedInfo, setLockedInfo] = useState<string | null>(null);

  useEffect(() => {
    if (open) {
      setCode('');
      setErrorMsg(null);
      setShake(false);
      setAttemptsLeft(null);
      setLockedInfo(null);
    } else {
      setCode('');
      setErrorMsg(null);
      setShake(false);
      setAttemptsLeft(null);
      setLockedInfo(null);
    }
  }, [open]);

  if (!open) return null;

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const onlyDigits = e.target.value.replace(/\D/g, '');
    setCode(onlyDigits.slice(0, 6));
    if (errorMsg) setErrorMsg(null);
    if (attemptsLeft !== null) setAttemptsLeft(null);
    if (lockedInfo) setLockedInfo(null);
  };

  // helper: segundos restantes desde ISO string
  function secondsUntil(iso?: string | null) {
    if (!iso) return null;
    const diff = Math.ceil((new Date(iso).getTime() - Date.now()) / 1000);
    return diff > 0 ? diff : 0;
  }

  const handleSubmit = async (e?: React.FormEvent) => {
    if (e) e.preventDefault();
    if (code.length !== 6) {
      setErrorMsg('El código debe tener exactamente 6 dígitos.');
      setShake(true);
      setTimeout(() => setShake(false), 400);
      return;
    }

    try {
      // onVerify debe llamar a verifyToken (fetch) y lanzar errores enriquecidos
      await onVerify(code.trim());
    } catch (err: unknown) {
      // Limpio estados anteriores
      setAttemptsLeft(null);
      setLockedInfo(null);

      // Mensaje por defecto
      let msg = 'Código incorrecto o expirado. Intenta nuevamente.';

      /**
       * Normalizamos el error recibido en un objeto con propiedades opcionales.
       * No usamos `any`. Usamos `unknown` y lo casteamos a un tipo seguro.
       */
      const e = err as
        | (Record<string, unknown> & {
            message?: string;
            status?: number;
            data?: Record<string, unknown> | null;
            // campos que puede incluir tu backend/enriquecimiento
            locked?: boolean;
            lockedUntil?: string;
            retryAfterSeconds?: number;
            attemptsLeft?: number;
            attempts?: number;
          });

      // LOCKED (423 en backend -> err.locked true)
      if (e?.locked) {
        const retrySeconds =
          (typeof e.retryAfterSeconds === 'number' && e.retryAfterSeconds) ??
          secondsUntil((e.lockedUntil as string | undefined) ?? null);
        const minutes = retrySeconds ? Math.ceil(retrySeconds / 60) : null;

        msg = (e?.message as string) || 'Tu cuenta está temporalmente bloqueada por demasiados intentos.';
        setLockedInfo(
          minutes
            ? `Podrás volver a intentar en aproximadamente ${minutes} minuto(s).`
            : retrySeconds
            ? `Podrás volver a intentar en aproximadamente ${retrySeconds} segundos.`
            : null
        );
      }
      // TOKEN INVÁLIDO (pero no bloqueado): attemptsLeft presente
      else if (typeof e?.attemptsLeft === 'number') {
        msg = (e?.message as string) || 'Token inválido.';
        setAttemptsLeft(e.attemptsLeft ?? null);
      }
      // Posible compatibilidad: err.status + err.data (si tu fetchWithAuth dejó data)
      else if (typeof e?.status === 'number' && e?.data) {
        const status = e.status;
        const data = e.data as Record<string, unknown> | null;

        if (status === 423) {
          const retrySeconds =
            (typeof data?.retryAfterSeconds === 'number' && (data.retryAfterSeconds as number)) ??
            secondsUntil((data?.lockedUntil as string | undefined) ?? null);
          const minutes = retrySeconds ? Math.ceil(retrySeconds / 60) : null;
          msg = (data?.message as string) || 'Tu cuenta está temporalmente bloqueada.';
          setLockedInfo(
            minutes
              ? `Podrás volver a intentar en aproximadamente ${minutes} minuto(s).`
              : retrySeconds
              ? `Podrás volver a intentar en aproximadamente ${retrySeconds} segundos.`
              : null
          );
        } else if (status === 400 && typeof (data?.attemptsLeft as unknown) === 'number') {
          msg = (data?.message as string) || 'Token inválido.';
          setAttemptsLeft((data?.attemptsLeft as number) ?? null);
        } else {
          msg = (data?.message as string) || e?.message || msg;
        }
      }
      // Fallback: usar err.message si existe
      else if (typeof e?.message === 'string') {
        msg = e.message;
      }

      setErrorMsg(msg);
      setShake(true);
      setTimeout(() => setShake(false), 400);
    }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
      <form
        onSubmit={handleSubmit}
        className={`bg-white rounded-lg w-[420px] p-6 shadow-lg border transition-all duration-300 ${
          shake ? 'animate-shake border-red-400' : ''
        }`}
      >
        <h3 className="text-lg font-semibold mb-2">Ingresa el código de autenticador</h3>
        <p className="text-sm text-gray-600 mb-4">Introduce los 6 dígitos que muestra tu app de autenticación.</p>

        <input
          autoFocus
          inputMode="numeric"
          pattern="[0-9]*"
          value={code}
          onChange={handleChange}
          className={`w-full p-2 border rounded mb-2 font-mono text-lg text-center tracking-widest transition-all ${
            errorMsg ? 'border-red-500 bg-red-50' : 'border-gray-300'
          }`}
          placeholder="••••••"
        />

        {errorMsg && (
          <div className="text-red-600 text-sm mb-1 text-center font-medium">{errorMsg}</div>
        )}

        {/* NUEVO: intentos restantes */}
        {attemptsLeft !== null && attemptsLeft >= 0 && (
          <div className="text-xs text-center text-red-500 mb-1">
            Intentos restantes: <span className="font-semibold">{attemptsLeft}</span>
          </div>
        )}

        {/* NUEVO: info de bloqueo */}
        {lockedInfo && (
          <div className="text-xs text-center text-red-500 mb-2">{lockedInfo}</div>
        )}

        <div className="flex justify-end gap-3 mt-2">
          <button
            type="button"
            onClick={() => {
              setCode('');
              setErrorMsg(null);
              setAttemptsLeft(null);
              setLockedInfo(null);
              onClose();
            }}
            className="px-3 py-2 rounded border text-sm bg-white text-gray-700"
            disabled={loading}
          >
            Cancelar
          </button>
          <button type="submit" className="px-4 py-2 rounded text-sm bg-indigo-600 text-white" disabled={loading}>
            {loading ? 'Verificando...' : 'Verificar'}
          </button>
        </div>
      </form>

      <style jsx>{`
        @keyframes shake {
          0%,
          100% {
            transform: translateX(0);
          }
          25% {
            transform: translateX(-5px);
          }
          50% {
            transform: translateX(5px);
          }
          75% {
            transform: translateX(-4px);
          }
        }
        .animate-shake {
          animation: shake 0.4s ease-in-out;
        }
      `}</style>
    </div>
  );
}
</file>

<file path="src/Components/Statistics-panel/metrics-cards.tsx">
import React from 'react';
import { useTranslations } from 'next-intl';

interface Metrics {
  total: number;
  active: number;
  cancelled: number;
}

interface MetricsCardsProps {
  metrics: Metrics;
}

const MetricsCards: React.FC<MetricsCardsProps> = ({ metrics }) => {
  const t = useTranslations('tracking.metrics');
  const { total, active, cancelled } = metrics;

  return (
    <div className='flex flex-col gap-4'>
      <div className='bg-white shadow-sm rounded p-4 border-l-4 border-blue-500'>
        <h3 className='text-lg font-semibold text-gray-800'>{t('total')}</h3>
        <p className='text-2xl font-bold text-blue-600'>{total}</p>
      </div>
      <div className='bg-white shadow-sm rounded p-4 border-l-4 border-green-500'>
        <h3 className='text-lg font-semibold text-gray-800'>{t('scheduled')}</h3>
        <p className='text-2xl font-bold text-green-600'>{active}</p>
      </div>
      <div className='bg-white shadow-sm rounded p-4 border-l-4 border-red-500'>
        <h3 className='text-lg font-semibold text-gray-800'>{t('cancelled')}</h3>
        <p className='text-2xl font-bold text-red-600'>{cancelled}</p>
      </div>
    </div>
  );
};

export default MetricsCards;
</file>

<file path="src/types/user.ts">
export interface IUser {
  _id?: string;
  id?: string;
  name: string;
  email: string;
  url_photo?: string;
  role: 'requester' | 'fixer' | 'admin';

  authProviders?: Array<{
    provider: string;
    providerId: string;
    password?: string;
  }>;

  telefono?: string;

  ubicacion?: {
    lat?: number;
    lng?: number;
    direccion?: string;
    departamento?: string;
    pais?: string;
  };

  ci?: string;
  servicios?: string[];

  vehiculo?: {
    hasVehiculo?: boolean;
    tipoVehiculo?: string;
  };

  fixerProfile?: string;
  acceptTerms?: boolean;

  metodoPago?: {
    hasEfectivo?: boolean;
    qr?: boolean;
    tarjetaCredito?: boolean;
  };

  experience?: {
    descripcion?: string;
  };

  workLocation?: {
    lat?: number;
    lng?: number;
    direccion?: string;
    departamento?: string;
    pais?: string;
  };
  description?: string;
  createdAt?: string;
  updatedAt?: string;
}
</file>

<file path="src/app/[locale]/adminStatistic/page.tsx">
'use client';
import { useState, useEffect } from 'react';
import { useRouter, useParams } from 'next/navigation';
import { useTranslations } from 'next-intl';
import { ChartPieDonut } from '@/Components/Statistics-panel/Chart-pie-donut';
import { ChartBarLabel } from '@/Components/Statistics-panel/Chart-bar-Label';
import { useGetStatisticsQuery } from '@/app/redux/services/dashboardApi';
import { Button } from '@/Components/ui/button';

export default function Page() {
  const t = useTranslations('dashboard');

  const [selectedPeriod, setSelectedPeriod] = useState<'semanal' | 'mensual' | 'anual'>('mensual');
  const router = useRouter();
  const params = useParams();
  const locale = (params?.locale as string) || 'es';

  // Usar el hook de Redux para obtener los datos
  const { data, error, isLoading, refetch } = useGetStatisticsQuery(selectedPeriod);

  const handleBackToDashboard = () => {
    //router.push(`/${locale}/user-admin/dashboard`);
    router.push(`https://servineo-frontend-bytes-bandidos.vercel.app/user-admin/dashboard`);
  };

  // Refetch cuando cambie el período
  useEffect(() => {
    refetch();
  }, [selectedPeriod, refetch]);

  // Transformar los datos del backend al formato que esperan los componentes
  const transformFilterData = (filterData: Record<string, number> | undefined) => {
    if (!filterData) return [];
    return Object.entries(filterData).map(([name, value]) => ({
      name,
      value: value as number,
    }));
  };

  // Datos para los gráficos
  const monthlyData = data ? transformFilterData(data.filter_statistics?.fixer_name) : [];
  const tradesData = data ? transformFilterData(data.filter_statistics?.city) : [];
  const productsData = data ? transformFilterData(data.filter_statistics?.job_type) : [];
  const pieData = data ? transformFilterData(data.user_type_statistics) : [];

  // Mostrar loading mientras se cargan los datos
  if (isLoading) {
    return (
      <main className='flex min-h-screen flex-col items-center justify-center p-4'>
        <div className='text-lg'>{t('loading')}</div>
      </main>
    );
  }

  // Mostrar error si hay algún problema
  if (error) {
    return (
      <main className='flex min-h-screen flex-col items-center justify-center p-4'>
        <div className='text-lg text-red-500'>{t('error')}</div>
      </main>
    );
  }

  return (
    <main className='flex min-h-screen flex-col items-center p-4 pt-8'>
      {/* Botón de regreso en la parte superior izquierda */}
      <div className='w-full max-w-7xl mb-6 flex justify-start items-center'>
        <Button
          onClick={handleBackToDashboard}
          variant='outline'
          className='flex items-center gap-2 hover:bg-gray-50 transition-colors duration-200 min-w-[160px]'
          aria-label='Volver al Dashboard'
        >
          <svg
            xmlns='http://www.w3.org/2000/svg'
            className='h-5 w-5'
            viewBox='0 0 20 20'
            fill='currentColor'
          >
            <path
              fillRule='evenodd'
              d='M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z'
              clipRule='evenodd'
            />
          </svg>
          Volver al Dashboard
        </Button>
      </div>

      {/* Contenedor del dropdown del período */}
      <div className='w-full max-w-4xl mb-6 flex justify-center items-center'>
        <div className='relative'>
          <select
            value={selectedPeriod}
            onChange={(e) => setSelectedPeriod(e.target.value as 'semanal' | 'mensual' | 'anual')}
            className='appearance-none bg-white border border-gray-300 rounded-md px-4 py-2 pr-8 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
          >
            <option value='semanal'>{t('periods.weekly')}</option>
            <option value='mensual'>{t('periods.monthly')}</option>
            <option value='anual'>{t('periods.yearly')}</option>
          </select>
          <div className='pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700'>
            <svg className='h-4 w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'>
              <path d='M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z' />
            </svg>
          </div>
        </div>
      </div>

      {/* Información del período */}
      {data && (
        <div className='w-full max-w-4xl mb-4 text-center'>
          <h2 className='text-xl font-semibold'>
            {t('periodLabel')}:{' '}
            {selectedPeriod === 'semanal'
              ? t('periods.weekly')
              : selectedPeriod === 'mensual'
                ? t('periods.monthly')
                : t('periods.yearly')}
          </h2>
          <p className='text-gray-600'>
            {t('totalSearches')}: {data.count}
          </p>
        </div>
      )}

      {/* Contenedor principal de gráficos */}
      <div className='w-full max-w-4xl space-y-6'>
        {/* Gráfico de donut para tipos de usuario */}
        {pieData.length > 0 && (
          <ChartPieDonut
            data={pieData}
            title={t('charts.userDistribution.title')}
            description={t('charts.userDistribution.description')}
          />
        )}

        {/* Gráfico de rangos de fixers */}
        {monthlyData.length > 0 && (
          <ChartBarLabel
            data={monthlyData}
            title={t('charts.fixerRanges.title')}
            description={t('charts.fixerRanges.description')}
            color='#2563eb'
            trendText={t('charts.filterStats')}
            footerText={t('charts.showingTotal')}
            barSize={90}
          />
        )}

        {/* Gráfico de ciudades */}
        {tradesData.length > 0 && (
          <ChartBarLabel
            data={tradesData}
            title={t('charts.cities.title')}
            description={t('charts.cities.description')}
            color='#10b981'
            trendText={t('charts.filterStats')}
            footerText={t('charts.showingTotal')}
            barSize={70}
          />
        )}

        {/* Gráfico de tipos de trabajo */}
        {productsData.length > 0 && (
          <ChartBarLabel
            data={productsData}
            title={t('charts.jobTypes.title')}
            description={t('charts.jobTypes.description')}
            color='#f59e0b'
            trendText={t('charts.filterStats')}
            footerText={t('charts.showingTotal')}
            barSize={70}
          />
        )}

        {/* Mensaje si no hay datos */}
        {!data && !isLoading && !error && (
          <div className='text-center text-gray-500'>{t('noData')}</div>
        )}
      </div>
    </main>
  );
}
</file>

<file path="src/app/components/NotificationSystem.tsx">
"use client";

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useRouter } from 'next/navigation';

const BellIcon = ({ className }: { className?: string }) => (
  <svg
    className={className}
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
  >
    <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" />
    <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" />
  </svg>
);

const FilterIcon = ({ className }: { className?: string }) => (
  <svg
    className={className}
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
  >
    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
  </svg>
);

const SpinnerIcon = ({ className }: { className?: string }) => (
  <svg
    className={`animate-spin ${className}`}
    xmlns="http://www.w3.org/2000/svg"
    fill="none"
    viewBox="0 0 24 24"
  >
    <circle
      className="opacity-25"
      cx="12"
      cy="12"
      r="10"
      stroke="currentColor"
      strokeWidth="4"
    ></circle>
    <path
      className="opacity-75"
      fill="currentColor"
      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
    ></path>
  </svg>
);

// Skeleton Loader Component
const SkeletonLoader = () => (
  <div className="p-4 space-y-4">
    {[1, 2, 3].map((i) => (
      <div key={i} className="animate-pulse">
        <div className="flex items-start gap-3">
          <div className="flex-shrink-0 w-2 h-2 rounded-full bg-gray-300 mt-2"></div>
          <div className="flex-1 space-y-2">
            <div className="flex items-center justify-between">
              <div className="h-4 bg-gray-300 rounded w-20"></div>
              <div className="h-3 bg-gray-300 rounded w-16"></div>
            </div>
            <div className="h-4 bg-gray-300 rounded w-full"></div>
            <div className="h-4 bg-gray-300 rounded w-3/4"></div>
          </div>
        </div>
      </div>
    ))}
  </div>
);

type NotificationType = 'todos' | 'whatsapp' | 'email' | 'citas' | 'ofertas_promociones' | 'billetera' | 'no_leidas';

interface INotification {
  _id: string;
  appointment_id?: string;
  recipient_phone?: string;
  notification_type?: 'whatsapp' | 'email' | 'citas' | 'ofertas' | 'billetera';
  message_content?: string;
  send_status?: string;
  error_details?: string | null;
  createdAt?: string;
  updatedAt?: string;
  __v?: number;
  users_id?: string;
  tipo?: string;
  estado?: string;
  creado?: string;
  siguiente?: string;
  saldo?: number;
  leido?: boolean;
  action_url?: string; // URL para redirección
}

const NOTIFICATIONS_PER_PAGE = 20;
const POLLING_INTERVAL = 5000; // 5 segundos para actualizaciones en tiempo real
const SKELETON_DELAY = 300; // ms antes de mostrar skeleton
const JOB_OFFERS_ROUTE = '/es/job-offer-list?sort=recent&page=1&limit=10';

const isSaldoNotification = (notification: INotification): boolean => {
  const tipoLower = notification.tipo?.toLowerCase() ?? '';
  return tipoLower.includes('saldo');
};

const filterNotificationsByRole = (
  notifications: INotification[],
  role: 'fixer' | 'requester'
): INotification[] =>
  notifications.filter((notification) => {
    const tipoLower = notification.tipo?.trim().toLowerCase();

    if (role === 'requester') {
      return !isSaldoNotification(notification) && notification.saldo === undefined;
    }

    if (tipoLower === 'desconexion 2 dias') {
      return false;
    }

    return true;
  });

interface NotificationSystemProps {
  userId?: string;
  userName?: string;
  isAuthenticated?: boolean;
  userRole?: 'fixer' | 'requester'; // NUEVO: rol del usuario
}

const normalizeApiBase = (rawBase?: string | null): string => {
  const fallback = 'http://localhost:8000';
  const sanitized = (rawBase && rawBase.trim()) || fallback;
  const withoutTrailingSlash = sanitized.replace(/\/+$/, '');
  if (withoutTrailingSlash.endsWith('/api')) {
    return withoutTrailingSlash;
  }
  return `${withoutTrailingSlash}/api`;
};

const API_BASE_URL = normalizeApiBase(process.env.NEXT_PUBLIC_API_URL);
const NOTIFICATIONS_API_URL = `${API_BASE_URL}/notifications`;
const OFFERS_COUNT_API_URL = `${API_BASE_URL}/offers/count-since`;
const PROMOTIONS_COUNT_API_URL = `${API_BASE_URL}/promotions/count-since`;

// Función para enmascarar datos sensibles
const maskSensitiveData = (text: string | undefined): string => {
  if (!text) return '';
  
  // Si parece un número de tarjeta (16 dígitos) o teléfono largo
  const cardPattern = /(\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?)(\d{4})/;
  const phonePattern = /(\d{4}[\s-]?\d{4}[\s-]?)(\d{4})/;
  
  if (cardPattern.test(text)) {
    return text.replace(cardPattern, '**** **** **** $2');
  }
  
  if (phonePattern.test(text) && text.length > 8) {
    const last4 = text.slice(-4);
    return `****${last4}`;
  }
  
  // Si contiene números de más de 8 dígitos, enmascarar
  if (/\d{9,}/.test(text)) {
    return text.replace(/\d(?=\d{4})/g, '*');
  }
  
  return text;
}

export default function NotificationSystem({ userId, userName, isAuthenticated, userRole = 'requester' }: NotificationSystemProps) {
  const API_URL = NOTIFICATIONS_API_URL;
  const [offersCountMap, setOffersCountMap] = useState<{ [key: string]: number }>({});
  const [promotionsCountMap, setPromotionsCountMap] = useState<{ [key: string]: number }>({});
  const router = useRouter();
  const [isOpen, setIsOpen] = useState(false);
  const [notifications, setNotifications] = useState<INotification[]>([]);
  const [unreadCount, setUnreadCount] = useState(0);
  const [filter, setFilter] = useState<NotificationType>(() => {
    if (typeof window !== 'undefined') {
      const saved = localStorage.getItem('notification_filter');
      return (saved as NotificationType) || 'todos';
    }
    return 'todos';
  });
  const [loading, setLoading] = useState(false);
  const [loadingMore, setLoadingMore] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [readNotifications, setReadNotifications] = useState<Set<string>>(
    new Set()
  );
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const [showSkeleton, setShowSkeleton] = useState(false);
  const [isOnline, setIsOnline] = useState(true);
  const [pendingSync, setPendingSync] = useState<INotification[]>([]);
  const [hasLoadedOnce, setHasLoadedOnce] = useState(false);
  const [authToken, setAuthToken] = useState<string | null>(null);
  const canRequestProtectedData = Boolean(authToken && userId);
  const displayName = userName?.split(' ')[0] ?? userId ?? (userRole === 'fixer' ? 'fixer' : 'requester');
  const showLoginPrompt = !canRequestProtectedData;
  const storageKey = useCallback(
    (base: string) => (userId ? `${base}_${userId}` : `${base}_anonymous`),
    [userId]
  );

  const modalRef = useRef<HTMLDivElement>(null);
  const listRef = useRef<HTMLDivElement>(null);
  const observerTarget = useRef<HTMLDivElement>(null);
  const loadingTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const pollingIntervalRef = useRef<NodeJS.Timeout | null>(null);

  // Cargar estado persistido al montar
  useEffect(() => {
        if (typeof window !== 'undefined') {
          localStorage.setItem(storageKey('cached_notifications'), JSON.stringify(notifications));
        }

    setReadNotifications(new Set());
    setNotifications([]);
    setUnreadCount(0);
    setPage(1);

    let loadedReadNotifications = new Set<string>();

    const savedRead = localStorage.getItem(storageKey('read_notifications'));
    if (savedRead) {
      try {
        const readIds = JSON.parse(savedRead);
        loadedReadNotifications = new Set(readIds);
        setReadNotifications(loadedReadNotifications);
      } catch (e) {
        console.error('Error loading read notifications:', e);
      }
    }

    const savedNotifications = localStorage.getItem(storageKey('cached_notifications'));
    if (savedNotifications) {
      try {
        const cached = JSON.parse(savedNotifications);
        setNotifications(filterNotificationsByRole(cached, userRole));
      } catch (e) {
        console.error('Error loading cached notifications:', e);
      }
    }

    const savedPage = localStorage.getItem(storageKey('notification_page'));
    if (savedPage) {
      setPage(parseInt(savedPage, 10));
    }
  }, [storageKey, userRole]);

  useEffect(() => {
    setNotifications((prev) => {
      const filtered = filterNotificationsByRole(prev, userRole);
      if (filtered.length === prev.length) {
        let isSame = true;
        for (let i = 0; i < filtered.length; i += 1) {
          if (filtered[i] !== prev[i]) {
            isSame = false;
            break;
          }
        }
        if (isSame) {
          return prev;
        }
      }
      return filtered;
    });
  }, [userRole]);

  useEffect(() => {
    if (typeof window === 'undefined') {
      return;
    }

    try {
      const token = localStorage.getItem('servineo_token');
      setAuthToken(token);
    } catch (error) {
      console.error('Error al recuperar el token de autenticación:', error);
      setAuthToken(null);
    }
  }, [userId, isAuthenticated]);

  const timeAgo = (dateString: string): string => {
    const date = new Date(dateString);
    const seconds = Math.floor((new Date().getTime() - date.getTime()) / 1000);
    let interval = seconds / 31536000;
    if (interval > 1) return `hace ${Math.floor(interval)} años`;
    interval = seconds / 2592000;
    if (interval > 1) return `hace ${Math.floor(interval)} meses`;
    interval = seconds / 86400;
    if (interval > 1) return `hace ${Math.floor(interval)} días`;
    interval = seconds / 3600;
    if (interval > 1) return `hace ${Math.floor(interval)} horas`;
    interval = seconds / 60;
    if (interval > 1) return `hace ${Math.floor(interval)} min`;
    return `hace ${Math.floor(seconds)} seg`;
  };

  const authorizedFetch = useCallback(
    async (input: RequestInfo | URL, init: RequestInit = {}) => {
      if (!authToken) {
        throw new Error('AUTH_REQUIRED');
      }

      const headers = new Headers(init.headers || {});
      headers.set('Authorization', `Bearer ${authToken}`);

      return fetch(input, {
        ...init,
        headers,
      });
    },
    [authToken]
  );

  const syncPendingNotifications = useCallback(async () => {
    setPendingSync((currentPending) => {
      if (currentPending.length === 0 || !isOnline || !canRequestProtectedData) {
        return currentPending;
      }

      (async () => {
        try {
          for (const notification of currentPending) {
            await authorizedFetch(API_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(notification),
            });
          }
          setPendingSync([]);
        } catch (err) {
          console.error('Error syncing notifications:', err);
        }
      })();

      return currentPending;
    });
  }, [isOnline, canRequestProtectedData, authorizedFetch, API_URL]);

  // Detectar estado de conexión
  useEffect(() => {
    const handleOnline = () => {
      setIsOnline(true);
    };
    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    setIsOnline(navigator.onLine);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  // Sincronizar cuando vuelve la conexión
  useEffect(() => {
    if (isOnline) {
      syncPendingNotifications();
    }
  }, [isOnline, syncPendingNotifications]);

  useEffect(() => {
    if (!canRequestProtectedData) {
      setNotifications([]);
      setUnreadCount(0);
      setHasLoadedOnce(false);
      setError(null);
    }
  }, [canRequestProtectedData]);

  // Guardar estado en localStorage
  useEffect(() => {
    if (typeof window !== 'undefined') {
      localStorage.setItem('notification_filter', filter);
      localStorage.setItem(storageKey('read_notifications'), JSON.stringify(Array.from(readNotifications)));
      localStorage.setItem(storageKey('notification_page'), page.toString());
      if (notifications.length > 0) {
        localStorage.setItem(storageKey('cached_notifications'), JSON.stringify(notifications));
      } else {
        localStorage.removeItem(storageKey('cached_notifications'));
      }
    }
  }, [filter, readNotifications, page, notifications, storageKey]);

  // Función para cargar solo el contador de notificaciones no leídas según el filtro activo
  const fetchUnreadCount = useCallback(async (currentFilter: string = filter) => {
    if (!canRequestProtectedData) {
      setUnreadCount(0);
      return;
    }

    try {
      const response = await authorizedFetch(API_URL);
      if (!response.ok) {
        throw new Error('Error al cargar notificaciones');
      }

      const data: INotification[] = await response.json();
      const sanitizedData = filterNotificationsByRole(data, userRole);

      // Aplicar filtro si no es 'todos'
      let filteredData = sanitizedData;
        if (currentFilter !== 'todos' && currentFilter !== 'no_leidas') {
          if (currentFilter === 'ofertas_promociones') {
            // Solo para requester
            if (userRole === 'requester') {
              filteredData = sanitizedData.filter((n) => {
                if (!n.tipo || typeof n.tipo !== 'string') return false;
                const tipoLower = n.tipo.trim().toLowerCase();
                return tipoLower === 'oferta' || tipoLower === 'desconexion 2 dias';
              });
            } else {
              filteredData = [];
            }
        } else if (currentFilter === 'billetera') {
          // Solo para fixer
          if (userRole === 'fixer') {
            filteredData = sanitizedData.filter((n) => n.tipo === 'billetera' || n.saldo !== undefined || isSaldoNotification(n));
          } else {
            filteredData = [];
          }
        } else {
          filteredData = sanitizedData.filter((n) => {
            if (currentFilter === 'citas' && n.appointment_id) return true;
            if (n.notification_type) {
              return n.notification_type === currentFilter;
            }
            if (n.tipo) {
              return n.tipo === currentFilter;
            }
            return false;
          });
        }
      }

      // Calcular el total de notificaciones NO LEÍDAS según el filtro
      const totalUnreadCount = filteredData.filter((n) => 
        !(n.leido || readNotifications.has(n._id))
      ).length;
      setUnreadCount(totalUnreadCount);
    } catch (err: unknown) {
      console.error('Error fetching unread count:', err);
      if (typeof window !== 'undefined') {
        const cached = localStorage.getItem(storageKey('cached_notifications'));
        if (cached) {
          try {
            const cachedData: INotification[] = JSON.parse(cached);
            const sanitizedCached = filterNotificationsByRole(cachedData, userRole);
            let filteredCached = sanitizedCached;
            if (currentFilter !== 'todos' && currentFilter !== 'no_leidas') {
              filteredCached = sanitizedCached.filter((n: INotification) => {
                if (currentFilter === 'citas' && n.appointment_id) return true;
                if (currentFilter === 'ofertas_promociones' && userRole === 'requester') {
                  if (!n.tipo || typeof n.tipo !== 'string') return false;
                  const tipoLower = n.tipo.trim().toLowerCase();
                  return tipoLower === 'oferta' || tipoLower === 'desconexion 2 dias';
                }
                if (currentFilter === 'billetera' && userRole === 'fixer') return n.tipo === 'billetera' || n.saldo !== undefined || isSaldoNotification(n);
                if (n.notification_type) {
                  return n.notification_type === currentFilter;
                }
                if (n.tipo) {
                  return n.tipo === currentFilter;
                }
                return false;
              });
            }
            setUnreadCount(filteredCached.filter((n: INotification) => 
              !(n.leido || readNotifications.has(n._id))
            ).length);
          } catch (e) {
            console.error('Error loading cached count:', e);
          }
        }
      }
    }
  }, [readNotifications, filter, authorizedFetch, canRequestProtectedData, API_URL, userRole, storageKey]);

  const fetchNotifications = useCallback(
    async (
      currentFilter: string,
      currentPage: number = 1,
      append: boolean = false
    ) => {
      if (!canRequestProtectedData) {
        setNotifications([]);
        setUnreadCount(0);
        setLoading(false);
        setLoadingMore(false);
        setShowSkeleton(false);
        return;
      }

      if (append) {
        setLoadingMore(true);
      } else {
        setLoading(true);
        setError(null);
        loadingTimeoutRef.current = setTimeout(() => {
          setShowSkeleton(true);
        }, SKELETON_DELAY);
      }

      try {
        const response = await authorizedFetch(API_URL);
        if (!response.ok) {
          throw new Error('Error al cargar notificaciones');
        }

        const data: INotification[] = await response.json();
        const sanitizedData = filterNotificationsByRole(data, userRole);

        let filteredData = sanitizedData;
        if (currentFilter !== 'todos') {
          if (currentFilter === 'no_leidas') {
            filteredData = sanitizedData.filter((n) => 
              !(n.leido || readNotifications.has(n._id))
            );
          } else {
            filteredData = sanitizedData.filter((n) => {
              if (currentFilter === 'citas' && n.appointment_id) return true;
              if (currentFilter === 'ofertas_promociones' && userRole === 'requester') {
                if (n.tipo && typeof n.tipo === 'string') {
                  const tipoLower = n.tipo.trim().toLowerCase();
                  if (tipoLower === 'oferta' || tipoLower === 'desconexion 2 dias') return true;
                }
              }
              if (currentFilter === 'billetera' && userRole === 'fixer') {
                return n.tipo === 'billetera' || n.saldo !== undefined || isSaldoNotification(n);
              }
              if (n.notification_type) {
                return n.notification_type === currentFilter;
              }
              if (n.tipo) {
                return n.tipo === currentFilter;
              }
              return false;
            });
          }
        }

        const sortedData = filteredData.sort((a, b) => {
          const dateA = a.createdAt
            ? new Date(a.createdAt).getTime()
            : a.creado
              ? new Date(a.creado).getTime()
              : 0;
          const dateB = b.createdAt
            ? new Date(b.createdAt).getTime()
            : b.creado
              ? new Date(b.creado).getTime()
              : 0;
          return dateB - dateA;
        });

        if (!append) {
          const totalUnreadCount = sortedData.filter((n) => 
            !(n.leido || readNotifications.has(n._id))
          ).length;
          setUnreadCount(totalUnreadCount);
        }

        const startIndex = 0;
        const endIndex = currentPage * NOTIFICATIONS_PER_PAGE;
        const paginatedData = sortedData.slice(startIndex, endIndex);

        if (append) {
          setNotifications((prev) => {
            const existingIds = new Set(prev.map((n) => n._id));
            const newNotifications = paginatedData.filter(
              (n) => !existingIds.has(n._id)
            );
            return [...prev, ...newNotifications];
          });
        } else {
          setNotifications(paginatedData);
        }

        setHasMore(endIndex < sortedData.length);
        setPage(currentPage);

        if (typeof window !== 'undefined') {
          localStorage.setItem(storageKey('cached_notifications'), JSON.stringify(paginatedData));
        }
      } catch (err: unknown) {
        const message = err instanceof Error ? err.message : String(err);
        setError(message || 'Error al cargar notificaciones');
        console.error('Error fetching notifications:', err);
        
        if (typeof window !== 'undefined') {
          const cached = localStorage.getItem(storageKey('cached_notifications'));
          if (cached) {
            try {
              const cachedData = JSON.parse(cached);
              setNotifications(filterNotificationsByRole(cachedData, userRole));
            } catch (e) {
              console.error('Error loading cached data:', e);
            }
          }
        }
      } finally {
        if (loadingTimeoutRef.current) {
          clearTimeout(loadingTimeoutRef.current);
          loadingTimeoutRef.current = null;
        }
        setLoading(false);
        setLoadingMore(false);
        setShowSkeleton(false);
      }
    },
    [readNotifications, authorizedFetch, canRequestProtectedData, API_URL, userRole, storageKey]
  );

  const loadMore = useCallback(() => {
    if (!loadingMore && hasMore) {
      fetchNotifications(filter, page + 1, true);
    }
  }, [filter, page, loadingMore, hasMore, fetchNotifications]);

  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        if (entries[0].isIntersecting && hasMore && !loadingMore) {
          loadMore();
        }
      },
      { threshold: 0.1 }
    );

    const currentTarget = observerTarget.current;
    if (currentTarget) {
      observer.observe(currentTarget);
    }

    return () => {
      if (currentTarget) {
        observer.unobserve(currentTarget);
      }
    };
  }, [hasMore, loadingMore, loadMore]);

  useEffect(() => {
    fetchUnreadCount(filter);
  }, [fetchUnreadCount, filter]);

  useEffect(() => {
    fetchUnreadCount(filter);
  }, [readNotifications, filter, fetchUnreadCount]);

  useEffect(() => {
    if (isOpen && !hasLoadedOnce && canRequestProtectedData) {
      fetchNotifications(filter, 1, false);
      setHasLoadedOnce(true);
    }
  }, [isOpen, filter, fetchNotifications, hasLoadedOnce, canRequestProtectedData]);

  useEffect(() => {
    if (!isOpen || notifications.length === 0) return;
    notifications.forEach((notification) => {
      const tipoLower = notification.tipo?.trim().toLowerCase();
      const fechaCreacion = notification.creado || notification.createdAt;
      if ((tipoLower === 'oferta' || tipoLower === 'desconexion 2 dias') && fechaCreacion && userRole === 'requester') {
        if (offersCountMap[notification._id] === undefined) {
          fetch(`${OFFERS_COUNT_API_URL}?date=${encodeURIComponent(fechaCreacion)}`)
            .then((res) => res.json())
            .then((data) => {
              if (data.success && typeof data.count === 'number') {
                setOffersCountMap((prev) => ({ ...prev, [notification._id]: data.count }));
              } else {
                setOffersCountMap((prev) => ({ ...prev, [notification._id]: 0 }));
              }
            })
            .catch(() => {
              setOffersCountMap((prev) => ({ ...prev, [notification._id]: 0 }));
            });
        }
      }
    });
  }, [isOpen, notifications, offersCountMap, userRole]);

  useEffect(() => {
    if (!isOpen || notifications.length === 0) return;
    notifications.forEach((notification) => {
      const tipoLower = notification.tipo?.trim().toLowerCase();
      const fechaCreacion = notification.creado || notification.createdAt;
      if (tipoLower === 'desconexion 2 dias' && fechaCreacion && userRole === 'requester') {
        if (promotionsCountMap[notification._id] === undefined) {
          fetch(`${PROMOTIONS_COUNT_API_URL}?date=${encodeURIComponent(fechaCreacion)}`)
            .then((res) => res.json())
            .then((data) => {
              if (data.success && typeof data.count === 'number') {
                setPromotionsCountMap((prev) => ({ ...prev, [notification._id]: data.count }));
              } else {
                setPromotionsCountMap((prev) => ({ ...prev, [notification._id]: 0 }));
              }
            })
            .catch(() => {
              setPromotionsCountMap((prev) => ({ ...prev, [notification._id]: 0 }));
            });
        }
      }
    });
  }, [isOpen, notifications, promotionsCountMap, userRole]);


  const handleMarkAsRead = async (notification: INotification) => {
    if (!canRequestProtectedData) {
      return;
    }

    if (notification.leido || readNotifications.has(notification._id)) {
      handleNotificationClick(notification);
      return;
    }

    setReadNotifications((prev) => new Set(prev).add(notification._id));
    setNotifications((prev) =>
      prev.map((n) =>
        n._id === notification._id ? { ...n, leido: true } : n
      )
    );

    try {
      const response = await authorizedFetch(`${API_URL}/${notification._id}/leido`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        throw new Error('Error al marcar notificación como leída');
      }
    } catch (err: unknown) {
      console.error('Error al marcar notificación como leída:', err);
      if (!isOnline) {
        setPendingSync((prev) => [...prev, notification]);
      }
    }

    if (notification.action_url || notification.appointment_id) {
      handleNotificationClick(notification);
    }
  };

  const handleNotificationClick = (notification: INotification) => {
    if (notification.action_url) {
      router.push(notification.action_url);
      setIsOpen(false);
      return;
    }

    if (notification.appointment_id) {
      router.push(`/calendar`);
      setIsOpen(false);
      return;
    }

    if (notification.tipo && typeof notification.tipo === 'string' && userRole === 'requester') {
      const tipoLower = notification.tipo.trim().toLowerCase();
      if (tipoLower === 'oferta' || tipoLower === 'desconexion 2 dias' || filter === 'ofertas_promociones') {
        router.push(JOB_OFFERS_ROUTE);
        setIsOpen(false);
        return;
      }
    }
    if (filter === 'ofertas_promociones' && userRole === 'requester') {
      router.push(JOB_OFFERS_ROUTE);
      setIsOpen(false);
      return;
    }

    if ((notification.tipo === 'billetera' || notification.notification_type === 'billetera' || notification.saldo !== undefined || isSaldoNotification(notification)) && userRole === 'fixer') {
      router.push('/calendar');
      setIsOpen(false);
      return;
    }
  };

  useEffect(() => {
    const handleEscape = (event: KeyboardEvent) => {
      if (event.key === 'Escape' && isOpen) {
        setIsOpen(false);
      }
    };

    if (isOpen) {
      document.addEventListener('keydown', handleEscape);
      return () => document.removeEventListener('keydown', handleEscape);
    }
  }, [isOpen]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        modalRef.current &&
        !modalRef.current.contains(event.target as Node)
      ) {
        setIsOpen(false);
      }
    };
    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside);
    }
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isOpen]);

  // Filtrar opciones del select según el rol del usuario
  const availableFilters = userRole === 'fixer'
    ? ['todos', 'no_leidas', 'whatsapp', 'email', 'citas', 'billetera'] // sin ofertas_promociones
    : ['todos', 'no_leidas', 'whatsapp', 'email', 'citas', 'ofertas_promociones']; // sin billetera

  return (
    <div className="relative">
      <button
        onClick={() => {
          setIsOpen((prev) => {
            if (!prev) {
              setHasLoadedOnce(false);
            }
            return !prev;
          });
        }}
        className="relative p-2 rounded-full text-gray-700 hover:text-blue-600 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
        aria-label="Notificaciones"
        aria-expanded={isOpen}
        aria-haspopup="true"
        role="button"
        tabIndex={0}
      >
        <BellIcon className="w-6 h-6" />
        {unreadCount > 0 && (
          <span
            className="absolute top-0 right-0 block h-5 w-5 rounded-full bg-red-600 text-white text-xs flex items-center justify-center ring-2 ring-white font-bold"
            aria-label={`${unreadCount} notificaciones no leídas`}
          >
            {unreadCount > 99 ? '99+' : unreadCount}
          </span>
        )}
      </button>

      {isOpen && (
        <div
          className="fixed inset-0 z-50 sm:absolute sm:inset-auto sm:top-full sm:left-0 sm:-translate-x-[65%] sm:mt-2 pointer-events-none"
          role="dialog"
          aria-modal="true"
          aria-label="Panel de notificaciones"
        >
          <div className="fixed inset-0 bg-black bg-opacity-50 sm:hidden pointer-events-auto" onClick={() => setIsOpen(false)} />
          
          <div
            ref={modalRef}
            className="fixed bottom-0 left-0 right-0 sm:absolute sm:bottom-auto sm:left-0 sm:-translate-x-[65%] bg-white rounded-t-2xl sm:rounded-lg shadow-xl w-full sm:w-96 max-w-full sm:max-w-md max-h-[85vh] sm:max-h-[80vh] flex flex-col pointer-events-auto border-t sm:border border-gray-200"
          >
            <div className="flex items-center justify-between p-4 sm:p-4 border-b border-gray-200 bg-gray-50">
              <div className="absolute top-2 left-1/2 transform -translate-x-1/2 w-12 h-1 bg-gray-300 rounded-full sm:hidden" />
              
              <h2 className="text-lg font-semibold text-gray-900 mt-2 sm:mt-0">
                Notificaciones
              </h2>
              <button
                onClick={() => setIsOpen(false)}
                className="text-gray-400 hover:text-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded mt-2 sm:mt-0"
                aria-label="Cerrar panel de notificaciones"
                tabIndex={0}
              >
                <svg
                  className="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>

            <div className="p-3 sm:p-4 border-b border-gray-200 bg-white">
              <div className="relative">
                <label
                  htmlFor="notification-filter"
                  className="flex items-center gap-2 text-xs sm:text-sm font-medium text-gray-700 mb-2"
                >
                  <FilterIcon className="w-4 h-4 text-gray-500" />
                  Filtrar por tipo
                </label>
                <select
                  id="notification-filter"
                  value={filter}
                  onChange={(e) => {
                    setFilter(e.target.value as NotificationType);
                    setPage(1);
                    setHasMore(true);
                    setHasLoadedOnce(false);
                    fetchUnreadCount(e.target.value);
                  }}
                  disabled={showLoginPrompt}
                  className="w-full px-3 py-2.5 sm:py-2 rounded-md border border-gray-300 bg-white text-sm font-medium text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none cursor-pointer disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed"
                  aria-label="Filtrar notificaciones por tipo"
                >
                  <option value="todos">Todos</option>
                  <option value="no_leidas">No leídas</option>
                  <option value="whatsapp">WhatsApp</option>
                  <option value="email">Email</option>
                  <option value="citas">Citas</option>
                  {userRole === 'requester' && <option value="ofertas_promociones">Ofertas y Promociones</option>}
                  {userRole === 'fixer' && <option value="billetera">Billetera</option>}
                </select>
                <div className="absolute right-3 top-8 sm:top-9 pointer-events-none">
                  <svg
                    className="w-5 h-5 text-gray-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </div>
              </div>
            </div>

            <div
              ref={listRef}
              className="flex-1 overflow-y-auto"
              role="list"
              aria-label="Lista de notificaciones"
            >
              {showLoginPrompt ? (
                <div className="p-8 sm:p-8 text-center text-gray-600">
                  <BellIcon className="w-12 h-12 mx-auto mb-4 text-gray-300" />
                  <p className="text-base sm:text-lg font-semibold text-primary">INICIAR SESION ANTES</p>
                  <p className="text-sm sm:text-base text-gray-500 mt-2">
                    Necesitas iniciar sesión para ver tus notificaciones personalizadas.
                  </p>
                </div>
              ) : (
                <>
                  {error && (
                    <div className="p-4 text-center text-red-600 text-sm" role="alert">
                      {error}
                    </div>
                  )}

                  {showSkeleton && loading && !loadingMore && (
                    <SkeletonLoader />
                  )}

                  {!loading && !showSkeleton && notifications.length === 0 && (
                    <div className="p-8 sm:p-8 text-center text-gray-500">
                      <BellIcon className="w-12 h-12 mx-auto mb-2 text-gray-300" />
                      <p className="text-sm sm:text-base">No hay notificaciones</p>
                    </div>
                  )}

                  {notifications.map((notification) => {
                const isRead = notification.leido || readNotifications.has(notification._id);
                const tipoLower = notification.tipo?.trim().toLowerCase();
                
                // Para "desconexion 2 dias", crear AMBAS notificaciones (oferta y promociones) SOLO SI ES REQUESTER
                if (tipoLower === 'desconexion 2 dias' && userRole === 'requester') {
                  const nombre = displayName;
                  const fechaCreacion = notification.creado || notification.createdAt;
                  let cantidad = offersCountMap[notification._id];
                  if (cantidad === undefined) cantidad = 0;
                  if (cantidad === null) cantidad = 0;
                  let cantidadPromos = promotionsCountMap?.[notification._id];
                  if (cantidadPromos === undefined) cantidadPromos = 0;
                  if (cantidadPromos === null) cantidadPromos = 0;
                  
                  return (
                    <React.Fragment key={notification._id}>
                      {/* Notificación de OFERTAS */}
                      <div
                        onClick={() => handleMarkAsRead(notification)}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            handleMarkAsRead(notification);
                          }
                        }}
                        className={`p-3 sm:p-4 border-b border-gray-100 cursor-pointer transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                          isRead ? 'bg-white hover:bg-gray-50' : 'bg-blue-50 hover:bg-blue-100'
                        }`}
                        role="listitem"
                        tabIndex={0}
                        aria-label={`Notificación personalizada para ofertas: ${nombre}`}
                      >
                        <div className="flex items-start gap-2 sm:gap-3">
                          <div className={`flex-shrink-0 w-2 h-2 rounded-full mt-1.5 sm:mt-2 ${isRead ? 'bg-gray-300' : 'bg-blue-600'}`} aria-hidden="true" />
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center justify-between mb-1 gap-2">
                              <span className="text-[10px] sm:text-xs font-medium px-1.5 sm:px-2 py-0.5 rounded flex-shrink-0 bg-orange-100 text-orange-800">OFERTA</span>
                              <span className="text-[10px] sm:text-xs text-gray-500 flex-shrink-0">
                                {fechaCreacion ? timeAgo(fechaCreacion) : 'Fecha no disponible'}
                              </span>
                            </div>
                            <p className={`text-xs sm:text-sm ${isRead ? 'text-gray-700' : 'text-gray-900 font-medium'}`}>
                              Hola {nombre}
                            </p>
                            <p className={`text-xs sm:text-sm ${isRead ? 'text-gray-700' : 'text-gray-900 font-medium'}`}>
                              {cantidad} nuevos trabajos públicos desde tu última visita
                            </p>
                          </div>
                        </div>
                      </div>
                      
                      {/* Notificación de PROMOCIONES */}
                      <div
                        onClick={() => handleMarkAsRead(notification)}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            handleMarkAsRead(notification);
                          }
                        }}
                        className={`p-3 sm:p-4 border-b border-gray-100 cursor-pointer transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                          isRead ? 'bg-white hover:bg-gray-50' : 'bg-blue-50 hover:bg-blue-100'
                        }`}
                        role="listitem"
                        tabIndex={0}
                        aria-label={`Notificación personalizada para promociones: ${nombre}`}
                      >
                        <div className="flex items-start gap-2 sm:gap-3">
                          <div className={`flex-shrink-0 w-2 h-2 rounded-full mt-1.5 sm:mt-2 ${isRead ? 'bg-gray-300' : 'bg-blue-600'}`} aria-hidden="true" />
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center justify-between mb-1 gap-2">
                              <span className="text-[10px] sm:text-xs font-medium px-1.5 sm:px-2 py-0.5 rounded flex-shrink-0 bg-green-100 text-green-800">PROMOCIONES</span>
                              <span className="text-[10px] sm:text-xs text-gray-500 flex-shrink-0">
                                {fechaCreacion ? timeAgo(fechaCreacion) : 'Fecha no disponible'}
                              </span>
                            </div>
                            <p className={`text-xs sm:text-sm ${isRead ? 'text-gray-700' : 'text-gray-900 font-medium'}`}>
                              Hola {nombre}
                            </p>
                            <p className={`text-xs sm:text-sm ${isRead ? 'text-gray-700' : 'text-gray-900 font-medium'}`}>
                              {cantidadPromos} nuevas promociones desde tu última visita
                            </p>
                          </div>
                        </div>
                      </div>
                    </React.Fragment>
                  );
                }
                
                // Para notificaciones de tipo "oferta" individuales SOLO SI ES REQUESTER
                if ((tipoLower === 'oferta' || filter === 'ofertas_promociones') && userRole === 'requester') {
                  const nombre = displayName;
                  const fechaCreacion = notification.creado || notification.createdAt;
                  let cantidad = offersCountMap[notification._id];
                  if (cantidad === undefined) cantidad = 0;
                  if (cantidad === null) cantidad = 0;
                  
                  return (
                    <div
                      key={notification._id}
                      onClick={() => handleMarkAsRead(notification)}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                          e.preventDefault();
                          handleMarkAsRead(notification);
                        }
                      }}
                      className={`p-3 sm:p-4 border-b border-gray-100 cursor-pointer transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        isRead ? 'bg-white hover:bg-gray-50' : 'bg-blue-50 hover:bg-blue-100'
                      }`}
                      role="listitem"
                      tabIndex={0}
                      aria-label={`Notificación personalizada para ofertas: ${nombre}`}
                    >
                      <div className="flex items-start gap-2 sm:gap-3">
                        <div className={`flex-shrink-0 w-2 h-2 rounded-full mt-1.5 sm:mt-2 ${isRead ? 'bg-gray-300' : 'bg-blue-600'}`} aria-hidden="true" />
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center justify-between mb-1 gap-2">
                            <span className="text-[10px] sm:text-xs font-medium px-1.5 sm:px-2 py-0.5 rounded flex-shrink-0 bg-orange-100 text-orange-800">OFERTA</span>
                            <span className="text-[10px] sm:text-xs text-gray-500 flex-shrink-0">
                              {fechaCreacion ? timeAgo(fechaCreacion) : 'Fecha no disponible'}
                            </span>
                          </div>
                          <p className={`text-xs sm:text-sm ${isRead ? 'text-gray-700' : 'text-gray-900 font-medium'}`}>
                            Hola {nombre}
                          </p>
                          <p className={`text-xs sm:text-sm ${isRead ? 'text-gray-700' : 'text-gray-900 font-medium'}`}>
                            {cantidad} nuevos trabajos públicos desde tu última visita
                          </p>
                        </div>
                      </div>
                    </div>
                  );
                }

                // Para notificaciones de billetera SOLO SI ES FIXER
                if ((notification.tipo === 'billetera' || notification.saldo !== undefined || isSaldoNotification(notification)) && userRole === 'fixer') {
                  return (
                    <div
                      key={notification._id}
                      onClick={() => handleMarkAsRead(notification)}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                          e.preventDefault();
                          handleMarkAsRead(notification);
                        }
                      }}
                      className={`p-3 sm:p-4 border-b border-gray-100 cursor-pointer transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        isRead ? 'bg-white hover:bg-gray-50' : 'bg-blue-50 hover:bg-blue-100'
                      }`}
                      role="listitem"
                      tabIndex={0}
                      aria-label={`Notificación de billetera`}
                    >
                      <div className="flex items-start gap-2 sm:gap-3">
                        <div className={`flex-shrink-0 w-2 h-2 rounded-full mt-1.5 sm:mt-2 ${isRead ? 'bg-gray-300' : 'bg-blue-600'}`} aria-hidden="true" />
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center justify-between mb-1 gap-2">
                            <span className="text-[10px] sm:text-xs font-medium px-1.5 sm:px-2 py-0.5 rounded flex-shrink-0 bg-yellow-100 text-yellow-800">BILLETERA</span>
                            <span className="text-[10px] sm:text-xs text-gray-500 flex-shrink-0">
                              {notification.createdAt ? timeAgo(notification.createdAt) : notification.creado ? timeAgo(notification.creado) : 'Fecha no disponible'}
                            </span>
                          </div>
                          <p className={`text-xs sm:text-sm ${isRead ? 'text-gray-700' : 'text-gray-900 font-medium'}`}>
                            {notification.message_content || `Tipo: ${notification.tipo}`}
                          </p>
                          {notification.saldo !== undefined && (
                            <p className="text-[10px] sm:text-xs text-gray-600 mt-1">
                              Saldo: {maskSensitiveData(notification.saldo.toString())}
                            </p>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                }

                // Notificaciones genéricas para todos
                return (
                  <div
                    key={notification._id}
                    onClick={() => handleMarkAsRead(notification)}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        handleMarkAsRead(notification);
                      }
                    }}
                    className={`p-3 sm:p-4 border-b border-gray-100 cursor-pointer transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                      isRead
                        ? 'bg-white hover:bg-gray-50'
                        : 'bg-blue-50 hover:bg-blue-100'
                    }`}
                    role="listitem"
                    tabIndex={0}
                    aria-label={`Notificación ${isRead ? 'leída' : 'no leída'}: ${notification.message_content || notification.tipo || 'Sin contenido'}`}
                  >
                    <div className="flex items-start gap-2 sm:gap-3">
                      <div
                        className={`flex-shrink-0 w-2 h-2 rounded-full mt-1.5 sm:mt-2 ${
                          isRead ? 'bg-gray-300' : 'bg-blue-600'
                        }`}
                        aria-hidden="true"
                      />
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center justify-between mb-1 gap-2">
                          <span
                            className={`text-[10px] sm:text-xs font-medium px-1.5 sm:px-2 py-0.5 rounded flex-shrink-0 ${
                              notification.notification_type === 'whatsapp'
                                ? 'bg-green-100 text-green-800'
                                : notification.notification_type === 'email'
                                  ? 'bg-blue-100 text-blue-800'
                                  : notification.notification_type === 'citas' || notification.appointment_id
                                    ? 'bg-purple-100 text-purple-800'
                                    : notification.tipo
                                      ? 'bg-purple-100 text-purple-800'
                                      : 'bg-gray-100 text-gray-800'
                            }`}
                          >
                            {notification.notification_type
                              ? notification.notification_type.toUpperCase()
                              : notification.tipo
                                ? notification.tipo.toUpperCase()
                                : 'NOTIFICACIÓN'}
                          </span>
                          <span className="text-[10px] sm:text-xs text-gray-500 flex-shrink-0">
                            {notification.createdAt
                              ? timeAgo(notification.createdAt)
                              : notification.creado
                                ? timeAgo(notification.creado)
                                : 'Fecha no disponible'}
                          </span>
                        </div>
                        {notification.message_content ? (
                          <p
                            className={`text-xs sm:text-sm ${
                              isRead ? 'text-gray-700' : 'text-gray-900 font-medium'
                            } line-clamp-3`}
                          >
                            {maskSensitiveData(notification.message_content)}
                          </p>
                        ) : notification.tipo ? (
                          <div className="text-xs sm:text-sm">
                            <p
                              className={`${
                                isRead ? 'text-gray-700' : 'text-gray-900 font-medium'
                              }`}
                            >
                              Tipo: {notification.tipo}
                            </p>
                            {notification.estado && (
                              <p className="text-[10px] sm:text-xs text-gray-600 mt-1">
                                Estado: {notification.estado}
                              </p>
                            )}
                          </div>
                        ) : (
                          <p
                            className={`text-xs sm:text-sm ${
                              isRead ? 'text-gray-700' : 'text-gray-900 font-medium'
                            }`}
                          >
                            Notificación sin contenido
                          </p>
                        )}
                        {notification.recipient_phone && (
                          <p className="text-[10px] sm:text-xs text-gray-500 mt-1">
                            Tel: {maskSensitiveData(notification.recipient_phone)}
                          </p>
                        )}
                      </div>
                    </div>
                  </div>
                );
                  })}

                  {loadingMore && (
                    <div className="p-4 text-center">
                      <SpinnerIcon className="w-6 h-6 mx-auto text-blue-600" />
                    </div>
                  )}

                  {hasMore && !loadingMore && (
                    <div ref={observerTarget} className="h-4" aria-hidden="true" />
                  )}
                </>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/Components/fixer/dashboard/JobOffersSection.tsx">
'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { Plus, Briefcase, Upload, X } from 'lucide-react';
import { PillButton } from '../Pill-button';
import { Modal } from '@/Components/Modal';
import NotificationModal from '@/Components/Modal-notifications';
import { JobOfferCard } from '@/Components/Job-offers/JobOfferCard';
import Image from 'next/image';
import { boliviaCities } from '@/app/lib/validations/Job-offer-Schemas';
import { useTranslations } from 'next-intl';
import { useAppSelector } from '@/app/redux/hooks';
import {
  useGetJobsByFixerQuery,
  useCreateJobMutation,
  useUpdateJobMutation,
  useDeleteJobMutation,
} from '@/app/redux/services/jobApi';

import {
  jobOfferSchema,
  jobCategories,
  type JobOfferFormData,
  type IJobOffer,
} from '@/app/lib/validations/Job-offer-Schemas';
import type { JobOfferData } from '@/types/jobOffers';

interface NotificationState {
  isOpen: boolean;
  type: 'success' | 'error' | 'info' | 'warning';
  title: string;
  message: string;
  onConfirm?: () => void;
}

export function JobOffersSection({ readOnly = false }: { readOnly?: boolean }) {
  const t = useTranslations('JobOffersSection');
  const { user } = useAppSelector((state) => state.user);
  const userId = user?._id || '';

  const { data: apiOffers, isLoading } = useGetJobsByFixerQuery(userId, { skip: !userId });
  const [createJob, { isLoading: isCreating }] = useCreateJobMutation();
  const [updateJob, { isLoading: isUpdating }] = useUpdateJobMutation();
  const [deleteJob] = useDeleteJobMutation();

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingOffer, setEditingOffer] = useState<IJobOffer | null>(null);
  const [selectedImages, setSelectedImages] = useState<File[]>([]);
  const [previewUrls, setPreviewUrls] = useState<string[]>([]);

  const [notify, setNotify] = useState<NotificationState>({
    isOpen: false,
    type: 'info',
    title: '',
    message: '',
  });

  const {
    register,
    handleSubmit,
    reset,
    setValue,
    watch,
    formState: { errors },
  } = useForm({
    resolver: zodResolver(jobOfferSchema),
    defaultValues: {
      price: 0,
      city: 'Cochabamba',
      contactPhone: user?.telefono || '',
      title: '',
      description: '',
      category: '',
      tags: [] as string[],
    },
  });

  const currentTags = watch('tags') || [];

  const showNotify = (
    type: NotificationState['type'],
    title: string,
    message: string,
    onConfirm?: () => void,
  ) => {
    setNotify({ isOpen: true, type, title, message, onConfirm });
  };

  const handleAddTag = (e: React.ChangeEvent<HTMLSelectElement>) => {
    const value = e.target.value;
    if (!value) return;

    if (!currentTags.includes(value) && currentTags.length < 5) {
      setValue('tags', [...currentTags, value], { shouldValidate: true });
    }

    e.target.value = '';
  };

  const removeTag = (tagToRemove: string) => {
    const newTags = currentTags.filter((t) => t !== tagToRemove);
    setValue('tags', newTags, { shouldValidate: true });
  };

  const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    if (selectedImages.length + files.length > 5) {
      showNotify('warning', t('notifications.imageLimit'), t('notifications.imageLimitMessage'));
      return;
    }
    const newFiles: File[] = [];
    files.forEach((file) => {
      if (file.size > 5 * 1024 * 1024) {
        showNotify('error', t('notifications.imageTooBig'), t('notifications.imageSizeMessage').replace('{fileName}', file.name));
      } else {
        newFiles.push(file);
      }
    });
    const newPreviews = newFiles.map((file) => URL.createObjectURL(file));
    setSelectedImages((prev) => [...prev, ...newFiles]);
    setPreviewUrls((prev) => [...prev, ...newPreviews]);
  };

  const removeImage = (index: number) => {
    setSelectedImages((prev) => prev.filter((_, i) => i !== index));
    if (previewUrls[index].startsWith('blob:')) {
      URL.revokeObjectURL(previewUrls[index]);
    }
    setPreviewUrls((prev) => prev.filter((_, i) => i !== index));
  };

  const handleOpenModal = (offer?: IJobOffer) => {
    if (readOnly) return;

    if (offer) {
      setEditingOffer(offer);
      setValue('title', offer.title);
      setValue('description', offer.description);
      setValue('category', offer.category);
      setValue('price', offer.price);
      setValue('city', offer.city);
      setValue('contactPhone', offer.contactPhone);
      setValue('tags', offer.tags && offer.tags.length > 0 ? offer.tags : [offer.category]);

      setPreviewUrls(offer.photos || []);
      setSelectedImages([]);
    } else {
      setEditingOffer(null);
      reset({
        title: '',
        description: '',
        price: 0,
        category: '',
        city: 'Cochabamba',
        contactPhone: user?.telefono || '',
        tags: [],
      });
      setPreviewUrls([]);
      setSelectedImages([]);
    }
    setIsModalOpen(true);
  };

  const handleCloseModal = () => {
    setIsModalOpen(false);
    setEditingOffer(null);
    setSelectedImages([]);
    setPreviewUrls([]);
    reset();
  };

  const onSubmit = async (data: JobOfferFormData) => {
    if (!user?._id) return showNotify('error', t('notifications.error'), t('notifications.noUser'));

    if (!editingOffer && selectedImages.length === 0) {
      return showNotify('warning', t('notifications.imageLimit'), t('notifications.noImages'));
    }

    try {
      const formData = new FormData();
      formData.append('fixerId', user._id);
      formData.append('fixerName', user.name || 'Usuario');
      formData.append('title', data.title);
      formData.append('description', data.description);
      formData.append('category', data.category);
      formData.append('price', data.price.toString());
      formData.append('city', data.city);
      formData.append('contactPhone', data.contactPhone);
      formData.append('tags', JSON.stringify(data.tags));
      formData.append('rating', editingOffer ? editingOffer.rating.toString() : '5');

      selectedImages.forEach((file) => formData.append('photos', file));

      if (editingOffer) {
        await updateJob({ jobId: editingOffer._id, formData }).unwrap();
        showNotify('success', t('notifications.updated'), t('notifications.updateSuccess'));
      } else {
        await createJob(formData).unwrap();
        showNotify('success', t('notifications.published'), t('notifications.createSuccess'));
      }
      handleCloseModal();
    } catch (error: unknown) {
      console.error(error);
      showNotify('error', t('notifications.error'), t('notifications.errorMessage'));
    }
  };

  const confirmDelete = (jobId: string) => {
    if (!userId) return;
    showNotify('warning', t('notifications.deleteTitle'), t('notifications.deleteMessage'), async () => {
      try {
        await deleteJob({ jobId, fixerId: userId }).unwrap();
        setTimeout(() => showNotify('success', t('notifications.deleted'), t('notifications.deleteSuccess')), 300);
      } catch (error: unknown) {
        showNotify('error', t('notifications.error'), t('notifications.deleteError'));
        console.error(error);
      }
    });
  };

  const mapToCardData = (offer: IJobOffer): JobOfferData => ({
    _id: offer._id,
    fixerId: offer.fixerId,
    fixerName: offer.fixerName,
    title: offer.title,
    description: offer.description,
    category: offer.category,
    tags: offer.tags || [],
    price: offer.price,
    city: offer.city,
    contactPhone: offer.contactPhone,
    createdAt: offer.createdAt,
    rating: offer.rating,
    photos: offer.photos || [],
    allImages: offer.photos || [],
    imagenUrl: offer.photos?.[0] || ''
  });

  const isSubmitting = isCreating || isUpdating;

  if (isLoading) return <div className='p-10 text-center animate-pulse'>{t('loading')}</div>;

  return (
    <div className='space-y-6'>
      {/* Header */}
      <div className='flex items-center justify-between'>
        <h2 className='text-xl font-semibold text-gray-900 flex items-center gap-2'>
          <Briefcase className='h-5 w-5 text-blue-600' />
          {readOnly ? t('titles.jobOffers') : t('titles.myJobOffers')}
        </h2>
        {!readOnly && (
          <PillButton
            onClick={() => handleOpenModal()}
            className='bg-primary text-white hover:bg-blue-800 flex items-center gap-2'
          >
            <Plus className='h-4 w-4' />
            {t('buttons.newOffer')}
          </PillButton>
        )}
      </div>

      {/* Grid */}
      <div className='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'>
        {apiOffers?.map((offer) => (
          <JobOfferCard
            key={offer._id}
            offer={mapToCardData(offer as IJobOffer)}
            onEdit={
              !readOnly
                ? () =>
                    handleOpenModal({
                      ...offer,
                      tags: offer.tags || [],
                      _id: offer._id || '',
                    } as IJobOffer)
                : undefined
            }
            onDelete={!readOnly ? () => confirmDelete(offer._id!) : undefined}
            readOnly={readOnly}
            className='h-full'
          />
        ))}
        {(!apiOffers || apiOffers.length === 0) && (
          <div className='col-span-full py-12 text-center text-gray-400 bg-gray-50 rounded-xl border border-dashed'>
            {t('empty')}
          </div>
        )}
      </div>

      {/* Modal Formulario */}
      <Modal
        open={isModalOpen}
        onClose={handleCloseModal}
        size='lg'
        closeOnOverlayClick={!isSubmitting}
        className='rounded-2xl border-primary border-2'
      >
        <Modal.Header className='text-center text-primary'>
          {editingOffer ? t('modal.editTitle') : t('modal.newTitle')}
        </Modal.Header>

        <Modal.Body>
          <form id='offerForm' onSubmit={handleSubmit(onSubmit)} className='space-y-4'>
            {/* Título */}
            <div>
              <label className='block text-sm font-medium text-gray-700 mb-1'>
                {t('form.title.label')}
              </label>
              <input
                {...register('title')}
                className='w-full rounded-lg border-primary border focus:outline-none py-2 px-3'
                placeholder={t('form.title.placeholder')}
              />
              {errors.title && (
                <p className='text-red-500 text-xs mt-1'>{errors.title.message as string}</p>
              )}
            </div>

            {/* Categoría */}
            <div>
              <label className='block text-sm font-medium text-gray-700 mb-1'>
                {t('form.category.label')}
              </label>
              <select
                {...register('category')}
                className='w-full rounded-lg border-primary border focus:outline-none py-2 px-3 bg-white'
              >
                <option value=''>{t('form.category.select')}</option>
                {jobCategories.map((cat) => (
                  <option key={cat.value} value={cat.value}>
                    {cat.label}
                  </option>
                ))}
              </select>
              {errors.category && (
                <p className='text-red-500 text-xs mt-1'>{errors.category.message as string}</p>
              )}
            </div>

            {/* Sección de Tags */}
            <div>
              <label className='block text-sm font-medium text-gray-700 mb-2'>
                {t('form.tags.label')}
              </label>

              <div className='flex flex-wrap gap-2 mb-2 min-h-[32px] p-2 bg-gray-50 rounded-lg border border-dashed border-gray-300'>
                {currentTags.map((tag) => (
                  <span
                    key={tag}
                    className='inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-primary border border-blue-200 shadow-sm animate-fade-in'
                  >
                    {tag}
                    <button
                      type='button'
                      onClick={() => removeTag(tag)}
                      className='hover:text-red-500 focus:outline-none ml-1 p-0.5 rounded-full hover:bg-white/50 transition-colors'
                    >
                      <X size={12} />
                    </button>
                  </span>
                ))}
                {currentTags.length === 0 && (
                  <span className='text-xs text-gray-400 italic self-center'>
                    {t('form.tags.empty')}
                  </span>
                )}
              </div>

              <select
                onChange={handleAddTag}
                className='w-full rounded-lg border-primary border focus:outline-none bg-white py-2 px-3 cursor-pointer'
                disabled={currentTags.length >= 5}
                defaultValue=''
              >
                <option value='' disabled>
                  {currentTags.length >= 5 ? t('form.tags.limitReached') : t('form.tags.addTag')}
                </option>
                {jobCategories.map((cat) => (
                  <option
                    key={cat.value}
                    value={cat.value}
                    disabled={currentTags.includes(cat.value)}
                  >
                    {cat.label} {currentTags.includes(cat.value) ? t('form.tags.alreadyAdded') : ''}
                  </option>
                ))}
              </select>

              {errors.tags && (
                <p className='text-red-500 text-xs mt-1'>{errors.tags.message as string}</p>
              )}
            </div>

            {/* Descripción */}
            <div>
              <label className='block text-sm font-medium text-gray-700 mb-1'>
                {t('form.description.label')}
              </label>
              <textarea
                {...register('description')}
                rows={4}
                className='w-full rounded-lg border-primary border focus:outline-none py-2 px-3'
                placeholder={t('form.description.placeholder')}
              />
              {errors.description && (
                <p className='text-red-500 text-xs mt-1'>{errors.description.message as string}</p>
              )}
            </div>

            {/* Precio y Ciudad */}
            <div className='grid grid-cols-2 gap-4'>
              <div>
                <label className='block text-sm font-medium text-gray-700 mb-1'>
                  {t('form.price.label')}
                </label>
                <input
                  type='number'
                  {...register('price')}
                  className='w-full rounded-lg border-primary border focus:outline-none py-2 px-3'
                />
                {errors.price && (
                  <p className='text-red-500 text-xs mt-1'>{errors.price.message as string}</p>
                )}
              </div>
              <div>
                <label className='block text-sm font-medium text-gray-700 mb-1'>
                  {t('form.city.label')}
                </label>
                <select
                  {...register('city')}
                  className='w-full rounded-lg border-primary border focus:outline-none py-2 px-3 bg-white'
                >
                  {boliviaCities.map((city) => (
                    <option key={city.value} value={city.value}>
                      {city.label}
                    </option>
                  ))}
                </select>
                {errors.city && (
                  <p className='text-red-500 text-xs mt-1'>{errors.city.message as string}</p>
                )}
              </div>
            </div>

            {/* Teléfono */}
            <div>
              <label className='block text-sm font-medium text-gray-700 mb-1'>
                {t('form.contactPhone.label')}
              </label>
              <input
                {...register('contactPhone')}
                className='w-full rounded-lg border-primary border focus:outline-none py-2 px-3'
              />
              {errors.contactPhone && (
                <p className='text-red-500 text-xs mt-1'>{errors.contactPhone.message as string}</p>
              )}
            </div>

            {/* Imágenes */}
            <div>
              <label className='block text-sm font-medium text-gray-700 mb-2'>
                {t('form.images.label')}
              </label>
              <div className='grid grid-cols-4 gap-2 mb-2'>
                {previewUrls.map((url, idx) => (
                  <div key={idx} className='relative aspect-square group'>
                    <Image
                      src={url}
                      className='w-full h-full object-cover rounded-lg border'
                      alt='preview'
                      width={100}
                      height={100}
                    />
                    <button
                      type='button'
                      onClick={() => removeImage(idx)}
                      className='absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity'
                    >
                      <X size={14} />
                    </button>
                  </div>
                ))}
                {previewUrls.length < 5 && (
                  <label className='flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg aspect-square cursor-pointer hover:bg-gray-50 transition-colors'>
                    <Upload className='text-gray-400' />
                    <input
                      type='file'
                      className='hidden'
                      accept='image/*'
                      multiple
                      onChange={handleImageChange}
                    />
                  </label>
                )}
              </div>
            </div>
          </form>
        </Modal.Body>

        <Modal.Footer>
          <div className='flex justify-end gap-2'>
            <button
              type='button'
              onClick={handleCloseModal}
              className='border border-primary py-2 px-4 rounded-2xl text-primary hover:text-white hover:bg-primary transition-colors'
            >
              {t('buttons.cancel')}
            </button>
            <PillButton
              type='submit'
              form='offerForm'
              className='bg-primary text-white hover:bg-blue-800'
              disabled={isSubmitting}
            >
              {isSubmitting ? t('buttons.saving') : t('buttons.save')}
            </PillButton>
          </div>
        </Modal.Footer>
      </Modal>

      <NotificationModal
        isOpen={notify.isOpen}
        onClose={() => setNotify((prev) => ({ ...prev, isOpen: false }))}
        type={notify.type}
        title={notify.title}
        message={notify.message}
        onConfirm={notify.onConfirm}
        confirmText={t('confirmButton')}
        autoClose={!notify.onConfirm}
      />
    </div>
  );
}
</file>

<file path="src/Components/Home/Footer-section.tsx">
'use client';

import Link from 'next/link';
import { useRouter, usePathname } from 'next/navigation';
import { useTranslations, useLocale } from 'next-intl';
import { Facebook, Instagram, Twitter, Mail, Phone, MapPin } from 'lucide-react';

interface FooterSectionProps {
  onRestartTour?: () => void;
}

export default function FooterSection({ onRestartTour }: FooterSectionProps = {}) {
  const router = useRouter();
  const pathname = usePathname();
  const t = useTranslations('footer');
  const locale = useLocale();

  const handleRestartTour = () => {
    // Borrar la flag de que ya vio el tour
    localStorage.removeItem('servineoTourVisto');

    // Si NO estamos en el home, redirigir primero
    if (pathname !== '/' && !pathname.endsWith('/es') && !pathname.endsWith('/en')) {
      // Redirigir al home y la recarga automática activará el tour
      router.push('/');
    } else {
      localStorage.removeItem('servineoTourVisto');
      window.location.reload();
    }
  };

  const empresaLinks = [
    { name: t('company.aboutUs'), path: `/${locale}/info/about` },
    { name: t('company.workWithUs'), path: `/${locale}/info/join` },
    { name: t('company.testimonials'), path: `/${locale}/info/testimonials` },
    { name: t('company.support'), path: `/${locale}/info/support` },
    { name: t('company.whyServineo'), path: `/${locale}/por-que-servineo` },
    { name: t('company.howItWorks'), path: `/${locale}/howUseServineo` },
  ];

  const legalLinks = [
    { name: t('legal.privacy'), path: `/${locale}/info/privacy` },
    { name: t('legal.terms'), path: `/${locale}/info/terms` },
    { name: t('legal.cookies'), path: `/${locale}/info/cookies` },
  ];

  const exploreLinks = [
    { name: t('explore.services'), path: `/${locale}/servicios` },
    { name: t('explore.offerServices'), path: `/${locale}/info/reparador` },
    { name: t('explore.jobOffers'), path: `/${locale}/job-offer-list` },
  ];

  return (
    <footer
      id='footer-principal'
      className="bg-[#0D1B3E] text-white font-['Roboto']"
      role='contentinfo'
      aria-label={t('ariaLabels.footer')}
    >
      <div className='max-w-7xl mx-auto px-6 py-8 space-y-6'>
        <a href='#main-content' className='sr-only focus:not-sr-only'>
          {t('skipToMain')}
        </a>

        <div className='text-center' aria-labelledby='footer-servineo-heading'>
          <h2 id='footer-servineo-heading' className='text-4xl font-bold mb-4 text-[#1AA7ED]'>
            Servineo
          </h2>
          <p className='text-white max-w-3xl mx-auto leading-relaxed text-lg'>{t('description')}</p>
        </div>

        <div
          className='grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8 text-base text-center sm:text-left'
          role='navigation'
          aria-label={t('ariaLabels.footerLinks')}
        >
          <div>
            <h3 className='text-xl font-semibold text-[#1AA7ED] mb-2'>{t('explore.title')}</h3>
            <ul className='space-y-1 mt-1'>
              {exploreLinks.map((link, i) => (
                <li key={i}>
                  <Link
                    href={link.path}
                    className='footerLink hover:text-[#1AA7ED] transition-colors'
                  >
                    {link.name}
                  </Link>
                </li>
              ))}
            </ul>
          </div>

          <div aria-labelledby='empresa-heading'>
            <h3 id='empresa-heading' className='text-xl font-semibold text-[#1AA7ED] mb-2'>
              {t('company.title')}
            </h3>
            <ul className='space-y-1 mt-1' role='list'>
              {empresaLinks.map((link, i) => (
                <li key={i}>
                  <Link
                    href={link.path}
                    className='footerLink hover:text-[#1AA7ED] transition-colors'
                  >
                    {link.name}
                  </Link>
                </li>
              ))}
              <li>
                <button
                  onClick={handleRestartTour}
                  className='footerLink text-left w-full sm:w-auto cursor-pointer hover:text-[#1AA7ED] transition-colors bg-transparent border-none p-0'
                >
                  {t('company.restartTour')}
                </button>
              </li>
            </ul>
          </div>

          <div aria-labelledby='legal-heading'>
            <h3 id='legal-heading' className='text-xl font-semibold text-[#1AA7ED] mb-2'>
              {t('legal.title')}
            </h3>
            <ul className='space-y-1 mt-1' role='list'>
              {legalLinks.map((link, i) => (
                <li key={i} role='listitem'>
                  <Link
                    href={link.path}
                    className='footerLink hover:text-[#1AA7ED] transition-colors'
                  >
                    {link.name}
                  </Link>
                </li>
              ))}
            </ul>
          </div>

          <div aria-labelledby='contacto-heading'>
            <h3 id='contacto-heading' className='text-xl font-semibold text-[#1AA7ED] mb-2'>
              {t('contact.title')}
            </h3>
            <div className='space-y-2 mt-1 text-white flex flex-col items-center sm:items-start'>
              <div className='flex items-center' aria-label={t('contact.location')}>
                <MapPin
                  className='h-5 w-5 text-blue-400 mr-2 transition-all duration-300 group-hover:text-[#1AA7ED] group-hover:drop-shadow-[0_0_8px_var(--secondary)]'
                  aria-hidden='true'
                />
                <a
                  href='https://maps.app.goo.gl/PwgW3ERYuFQMEoNT7'
                  target='_blank'
                  rel='noopener noreferrer'
                  className='footerLink'
                  aria-label={t('ariaLabels.viewLocation')}
                >
                  Cochabamba, Bolivia
                </a>
              </div>
              <div className='flex items-center' aria-label={t('ariaLabels.whatsapp')}>
                <Phone className='h-5 w-5 text-blue-400 mr-2' aria-hidden='true' />
                <a
                  href='https://wa.me/59175139742?text=Hola%2C%20me%20gustaria%20recibir%20informacion%20sobre%20los%20servicios%20que%20ofrece%20SERVINEO.%20Muchas%20gracias.'
                  target='_blank'
                  rel='noopener noreferrer'
                  className='footerLink'
                  aria-label={t('ariaLabels.sendWhatsApp')}
                >
                  +591 751-39742
                </a>
              </div>
              <div className='flex items-center' aria-label={t('ariaLabels.email')}>
                <Mail className='h-5 w-5 text-blue-400 mr-2' aria-hidden='true' />
                <a
                  href='mailto:servineo.serviciostecnicos@gmail.com?subject=Solicitud%20de%20informacion&body=Hola,%20me%20gustaria%20recibir%20informacion%20sobre%20los%20servicios%20que%20ofrece%20SERVINEO.%20Muchas%20gracias.'
                  className='footerLink'
                  aria-label={t('ariaLabels.sendEmail')}
                >
                  servineo@gmail.com
                </a>
              </div>
            </div>
          </div>
        </div>

        <div className='flex flex-col sm:flex-row sm:items-center sm:justify-between gap-6 border-t border-gray-700 pt-6'>
          <div className='flex items-center justify-center sm:justify-start gap-4'>
            <h3 className='text-xl font-semibold text-[#1AA7ED]'>{t('social.title')}</h3>
            <div
              className='flex flex-row gap-6'
              role='list'
              aria-label={t('ariaLabels.socialMedia')}
            >
              <a
                href='https://www.facebook.com/profile.php?id=61584421344788'
                target='_blank'
                rel='noopener noreferrer'
                className='text-gray-400 hover:text-[#1AA7ED] transition-colors'
                aria-label={t('ariaLabels.facebook')}
              >
                <Facebook className='h-6 w-6' aria-hidden='true' />
              </a>
              <a
                href='https://www.instagram.com/servineoserviciostecnicos?igsh=amR3YWtvczFuaTd2'
                target='_blank'
                rel='noopener noreferrer'
                className='text-gray-400 hover:text-[#1AA7ED] transition-colors'
                aria-label={t('ariaLabels.instagram')}
              >
                <Instagram className='h-6 w-6' aria-hidden='true' />
              </a>
              <a
                href='https://x.com/ServineoSTG?t=SUKbiRR3mEqFgE4vaViXvw&s=09'
                target='_blank'
                rel='noopener noreferrer'
                className='text-gray-400 hover:text-[#1AA7ED] transition-colors'
                aria-label={t('ariaLabels.twitter')}
              >
                <Twitter className='h-6 w-6' aria-hidden='true' />
              </a>
            </div>
          </div>

          <div className='flex items-center justify-center sm:justify-end gap-2'>
            <div className='w-2.5 h-2.5 bg-green-500 rounded-full' aria-hidden='true' />
            <span>Sistema operativo</span>
          </div>
        </div>

        <div className='border-t border-gray-700' role='separator' aria-hidden='true' />

        <div
          className='flex flex-col sm:flex-row items-center justify-between gap-4 text-white text-sm pt-8'
          aria-label={t('ariaLabels.copyright')}
        >
          <div>{t('copyright')}</div>
          <div className='flex items-center space-x-4'>
            <span>{t('madeWith')}</span>
            <div className='flex items-center space-x-2'>
              <div className='w-2.5 h-2.5 bg-green-500 rounded-full' aria-hidden='true' />
              <span>{t('operational')}</span>
            </div>
          </div>
        </div>
      </div>
    </footer>
  );
}
</file>

<file path="src/Components/HowUseServineo/Title.tsx">
'use client';

import 'animate.css';
import Link from 'next/link';
import React, { useEffect, useState } from 'react';
import dynamic from 'next/dynamic';
import { FaArrowDown } from 'react-icons/fa6';
import { Play } from 'lucide-react';
import * as Popover from '@radix-ui/react-popover';
import { useTranslations } from 'next-intl';
import { useRouter, usePathname } from 'next/navigation';

const ReactPlayer = dynamic(() => import('react-player'), { ssr: false });
const subtitle = 'Estos son los pasos que debe seguir para\npoder usar nuestra plataforma facilmente';

export const Title = () => {

  const t = useTranslations("HowUseServineoTitle");

  const [playing, setPlaying] = useState(false);
  const [audioAllowed, setAudioAllowed] = useState(false);
  const [open, setOpen] = useState(false);
  const [showPauseScreen, setShowPauseScreen] = useState(true);
  const [isClient, setIsClient] = useState(false);

  const [checkPause, setCheckPause] = useState(false);

  useEffect(() => {
    setIsClient(true);
  }, []);

  const handleAllowAudio = async () => {
    setAudioAllowed(true);
    setOpen(false);
  };

  const handleNoAudio = () => {
    setOpen(false);
    setAudioAllowed(false);
    setCheckPause(true);
  };

  const handlePlayPause = () => {
    if (audioAllowed === false) {
      if (checkPause === true) {
        setPlaying(!playing);
        setShowPauseScreen(!showPauseScreen);
      } else {
        setOpen(true);
      }
      //return;
    } else {
      //setAudioAllowed(!audioAllowed);
      setPlaying(!playing);
      setShowPauseScreen(!showPauseScreen);
    }
  };

  // ... dentro de tu componente ...
  const router = useRouter();
  const pathname = usePathname();

  const handleRestartTour = () => {
    // 1. Borramos la flag del tour visto
    localStorage.removeItem('servineoTourVisto');

    // 2. La lógica de redirección
    if (pathname !== '/' && !pathname.endsWith('/es') && !pathname.endsWith('/en')) {
      router.push('/');
    } else {
      window.location.reload();
    }
  };

  return (
    <div>
      <div className='flex flex-col items-center min-h-screen gap-[10px] bg-gradient-to-b from-[#2B6AE0] to-[#2B31E0]'>
        <div>
          <h1 className='text-center text-[60px] text-white mt-[40px]'> { t("title") } </h1>
        </div>

        <div>
          <h3 className='text-white mb-[24px] whitespace-pre-line'> {t("subtitle")} </h3>
        </div>

        {/*popover*/}
        <Popover.Root open={open}>
          <Popover.Trigger asChild>
            <button>{audioAllowed ? '' : ''}</button>
          </Popover.Trigger>
          <Popover.Portal>
            <Popover.Content className='bg-white p-4 rounded-xl shadow-md max-w-sm text-center w-auto h-auto animate__animated animate__fadeInDown'>
              <p className='mb-2 font-semibold'>¿Deseas activar el sonido?</p>
              <p className='text-sm text-gray-500 mb-3'>
                Activa el sonido para una mejor experiencia visual y auditiva.
              </p>
              <div className='flex justify-center gap-2'>
                <button
                  className='cursor-pointer gap-[3px] bg-[#2B6EA0] hover:bg-[#2B31E0] duration-150 text-white h-9 w-40 rounded-[8px]'
                  onClick={handleAllowAudio}
                >
                  Sí, activar
                </button>
                <button
                  className='cursor-pointer gap-[3px] bg-[#2B6EA0] hover:bg-[#2B31E0] duration-150 text-white h-9 w-40 rounded-[8px]'
                  onClick={handleNoAudio}
                >
                  No
                </button>
              </div>
            </Popover.Content>
          </Popover.Portal>
        </Popover.Root>
        {/* */}

        {/* contenedor del video */}
        <div className='relative w-full max-w-3xl aspect-video rounded-2xl overflow-hidden shadow-lg mb-[30px]'>
          {isClient && (
            <ReactPlayer
              src='/videos/SERVINEO_TUTORIAL.mp4'
              playing={playing}
              muted={audioAllowed ? false : true}
              controls
              height='100%'
              width='100%'
              style={{ position: 'absolute', top: 0, left: 0, objectFit: 'cover' }}
            />
          )}

          {showPauseScreen === true && (
            <div className='absolute inset-0 flex items-center justify-center bg-black/30 cursor-pointer transition-opacity duration-300'>
              <button>
                <Play
                  onClick={handlePlayPause}
                  className='cursor-pointer text-white drop-shadow-lg transition-transform duration-300 hover:scale-130'
                  size={64}
                  color='white'
                />
              </button>
            </div>
          )}
        </div>
        {/* */}

        <div className='mb-[30px]'>
          <span className='text-white text-[18px]'>
            {t("guide")}{" "}
            <button
              onClick={handleRestartTour}
              className='text-white font-bold decoration-2 hover:text-gray-200 bg-transparent border-none cursor-pointer p-0 inline font-inherit'
            >
              {t("guideLink")}
            </button>
          </span>
        </div>

        <div className='flex flex-col items-center mb-[30px] text-[25px] gap-[10px]'>
          <span className='text-white'> {t("fingOut")} </span>
          <FaArrowDown
            className='animate__animated animate__shakeY animate__slower animate__infinite'
            color='white'
          />
        </div>
      </div>
    </div>
  );
};
</file>

<file path="src/Components/payment/InvoiceList.tsx">
// src/Components/payment/InvoiceList.tsx
import { useRouter } from 'next/navigation';
import React, { useState, useEffect, useCallback } from 'react';
import {
  ChevronRight,
  Search,
  Loader2,
  ArrowLeft,
  ArrowDownUp,
  Calendar,
  FileText,
  Users,
} from 'lucide-react';

// === FUNCIÓN DE UTILIDAD: Obtiene el ID del usuario desde localStorage ===
const getRequesterId = () => {
  // Es vital chequear window !== 'undefined' para Next.js (lado del cliente)
  const userJson =
    typeof window !== 'undefined' ? localStorage.getItem('servineo_user') : null;

  if (userJson) {
    try {
      const userData = JSON.parse(userJson);
      return userData.id; // Retorna el ID
    } catch (e) {
      console.error('Error al parsear datos de usuario:', e);
      return null;
    }
  }
  return null;
};
// =======================================================================

export interface BackendInvoice {
  id: string;
  transactionId: string;
  requesterName: string;
  date: string;
  total: number;
  currency: string;
  status: string;
  requesterId: string;
}

export interface Invoice {
  _id: string;
  requesterId: string;
  'Company Name': string;
  'Tax ID': string;
  'Requester Name': string;
  'Job Type': string;
  'Transaction ID': string;
  Date: string;
  'Payment Method': string;
  Status: string;
  Subtotal: number;
  Commission: number;
  IVA: number;
  Total: number;
}

const API_URL = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000';

const fetchInvoices = async (): Promise<Invoice[]> => {
  // === MODIFICACIÓN CLAVE: Obtener el ID y agregarlo a la URL ===
  const requesterId = getRequesterId();
  if (!requesterId) {
    console.warn('Usuario no autenticado. No se puede cargar facturas.');
    // Devolvemos vacío si no hay ID, previniendo la llamada al backend
    return [];
  }

  try {
    // La URL ahora incluye el ID como Query Parameter (requesterId=...)
    const urlWithId = `${API_URL}/api/v1/invoices?requesterId=${requesterId}`;
    const response = await fetch(urlWithId);

    if (!response.ok) {
      const errorBody = await response.text();
      throw new Error(
        `HTTP error! status: ${response.status}. Response: ${errorBody}`
      );
    }
    const { data: backendData } = await response.json();

    return (backendData as BackendInvoice[]).map((item) => ({
      _id: item.id,
      'Transaction ID': item.transactionId,
      'Company Name': item.requesterName || 'N/A',
      Date: item.date,
      Total: item.total,
      Status: item.status,
      requesterId: item.requesterId || item.id,
      'Tax ID': 'N/A',
      'Requester Name': item.requesterName || 'N/A',
      'Job Type': 'Pago General',
      'Payment Method': 'Desconocido',
      Subtotal: item.total || 0,
      Commission: 0,
      IVA: 0,
    }));
  } catch (error) {
    console.error('Error al obtener facturas desde el backend:', error);
    return [];
  }
};

const InvoiceList = () => {
  const router = useRouter();
  const [invoices, setInvoices] = useState<Invoice[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [sortDirection, setSortDirection] = useState<'desc' | 'asc'>('desc');

  const parseDate = (dateString: string) => {
    const date = new Date(dateString);
    return isNaN(date.getTime()) ? new Date(0) : date;
  };

  useEffect(() => {
    const loadData = async () => {
      setLoading(true);
      const data = await fetchInvoices();
      const sorted = [...data].sort(
        (a, b) => parseDate(b.Date).getTime() - parseDate(a.Date).getTime()
      );
      setInvoices(sorted);
      setLoading(false);
    };
    loadData();
  }, []);

  const toggleSortDirection = useCallback(() => {
    setSortDirection((prev) => (prev === 'desc' ? 'asc' : 'desc'));
  }, []);

  const formatDate = (isoDate: string) => {
    const date = parseDate(isoDate);
    if (date.getTime() === 0) return 'Fecha Inválida';
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  };

  const searchedInvoices = invoices.filter((invoice) => {
    const query = searchQuery.toLowerCase();
    return (
      (invoice['Company Name'] || '').toLowerCase().includes(query) ||
      (invoice['Job Type'] || '').toLowerCase().includes(query) ||
      (invoice['Transaction ID'] || '').includes(query)
    );
  });

  const finalFilteredInvoices = [...searchedInvoices].sort((a, b) => {
    const dateA = parseDate(a.Date).getTime();
    const dateB = parseDate(b.Date).getTime();
    return sortDirection === 'desc' ? dateB - dateA : dateA - dateB;
  });

  const handleInvoiceClick = (invoiceId: string) =>
    router.push(`/detalleFactura/${invoiceId}`);

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center font-sans">
        <Loader2 className="animate-spin text-indigo-600 mx-auto" size={48} />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100 font-sans pt-16 sm:pt-20 pb-8 px-4 sm:px-6">
      <div className="max-w-3xl mx-auto bg-white rounded-3xl shadow-2xl p-4 sm:p-6 md:p-8">
        <div className="flex justify-between items-center mb-6 border-b pb-4">
          <h1 className="text-3xl font-extrabold text-gray-800 truncate">
            Facturación Reciente
          </h1>
          <button
            onClick={() => router.back()}
            className="flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105"
            title="Volver a la página anterior"
          >
            <ArrowLeft className="w-5 h-5 mr-1" />
            Volver
          </button>
        </div>

        <div className="mb-8">
          <div className="flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0">
            <div className="relative flex-grow">
              <input
                type="text"
                placeholder="Buscar cliente, servicio o ID..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full pl-4 pr-12 py-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-inner text-sm"
              />
              <Search
                className="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400"
                size={20}
              />
            </div>

            <button
              onClick={toggleSortDirection}
              className={`flex items-center justify-center font-bold text-sm px-4 rounded-xl transition-all duration-300 flex-shrink-0 shadow-md ${
                sortDirection === 'desc'
                  ? 'bg-indigo-500 hover:bg-indigo-600 text-white'
                  : 'bg-white border border-indigo-500 text-indigo-600 hover:bg-indigo-50'
              }`}
              title={`Ordenar por fecha: ${
                sortDirection === 'desc'
                  ? 'Más recientes primero'
                  : 'Más antiguas primero'
              }`}
            >
              <ArrowDownUp
                className={`w-4 h-4 mr-2 transition-transform ${
                  sortDirection === 'desc' ? 'rotate-180' : 'rotate-0'
                }`}
              />
              Fecha
            </button>
          </div>
        </div>

        <div className="space-y-4">
          {finalFilteredInvoices.length > 0 ? (
            finalFilteredInvoices.map((invoice) => (
              <button
                key={invoice._id}
                onClick={() => handleInvoiceClick(invoice._id)}
                className="w-full text-left bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5 border border-gray-200 focus:outline-none focus:ring-4 focus:ring-indigo-300"
              >
                <div className="flex flex-col md:flex-row md:items-start gap-4 md:gap-6">
                  <div className="flex-1 min-w-0 p-4 border-b md:border-b-0 md:border-r border-dashed border-gray-200">
                    <div className="flex items-center mb-1">
                      <Users className="w-5 h-5 text-indigo-500 mr-2" />
                      <h4 className="font-bold text-lg text-gray-800 truncate">
                        {invoice['Company Name']}
                      </h4>
                    </div>
                    <p className="text-sm text-gray-600 mb-2 ml-7 leading-tight break-words">
                      {invoice['Job Type']}
                    </p>
                    <div className="flex items-center text-xs text-gray-700 mt-2 gap-4 ml-7">
                      <span className="flex items-center">
                        <Calendar className="w-3 h-3 mr-1 text-gray-500" />
                        {formatDate(invoice.Date)}
                      </span>
                      <span className="flex items-center">
                        <FileText className="w-3 h-3 mr-1 text-gray-500" />
                        ID: {invoice['Transaction ID']}
                      </span>
                    </div>
                  </div>

                  <div className="flex justify-between md:flex-col md:items-end gap-2 md:gap-4 p-4 w-full md:w-auto">
                    <div className="text-right flex flex-col items-center md:items-end">
                      <div className="flex items-center bg-emerald-100 text-emerald-700 font-extrabold py-2 px-4 rounded-full shadow-inner transform scale-95">
                        <span className="text-xl">
                          {(invoice.Total ?? 0).toFixed(2).replace('.', ',')}
                        </span>
                      </div>
                      <span className="text-xs text-emerald-600 font-semibold mt-1">
                        Bs.
                      </span>
                    </div>
                    <ChevronRight className="text-indigo-400 w-6 h-6 md:mt-2" />
                  </div>
                </div>
              </button>
            ))
          ) : (
            <p className="text-center text-gray-500 py-10">
              No se encontraron facturas con esa búsqueda.
            </p>
          )}
        </div>
      </div>
    </div>
  );
};

export default InvoiceList;
</file>

<file path="src/Components/Home/Searchbar-section.tsx">
// src/Components/Home/Searchbar-section.tsx
'use client';

import { Search, X } from 'lucide-react';
import { useState, useEffect, useRef, useCallback, useMemo } from 'react';
import { useRouter, usePathname } from 'next/navigation';
import { useSearchHistory } from '@/app/redux/features/searchHistory/useSearchHistory';
import { useSearchSuggestions } from '@/app/redux/features/searchHistory/useSearchSuggestions';
import { useSearchKeyboard } from '@/app/redux/features/searchHistory/useSearchKeyboard';
import { useSearchTouch } from '@/app/redux/features/searchHistory/useSearchTouch';
import { SearchDropdown } from '@/Components/Shared/SearchDropdown';
import { validateSearch } from '@/app/lib/validations/search.validator';

interface SearchBarProps {
  value: string;
  onChange: (value: string) => void;
  placeholder?: string;
  className?: string;
  disabled?: boolean;
  onSearch?: (query: string) => void;
  showButton?: boolean;
  buttonText?: string;
}

export function SearchBar({
  value,
  onChange,
  placeholder = 'Buscar trabajos, ubicaciones, servicios...',
  className = '',
  disabled = false,
  onSearch,
  showButton = false,
  buttonText = 'Buscar',
}: SearchBarProps) {
  const router = useRouter();
  const pathname = usePathname();

  // Estado local
  const [isFocused, setIsFocused] = useState(false);
  const [isOpen, setIsOpen] = useState(false);
  const [highlighted, setHighlighted] = useState<number>(-1);
  const [longPressedItem, setLongPressedItem] = useState<string | null>(null);
  const [previewValue, setPreviewValue] = useState<string | null>(null);
  const [error, setError] = useState<string | undefined>();

  const containerRef = useRef<HTMLDivElement | null>(null);
  const inputRef = useRef<HTMLInputElement | null>(null);
  const currentLanguage = useMemo(() => {
    const pathSegments = (pathname || '').split('/').filter(Boolean);
    const langSegment = pathSegments[0];
    return ['en', 'es'].includes(langSegment) ? langSegment : 'es';
  }, [pathname]);

  // Hooks personalizados para historial y sugerencias
  const { history, addToHistory, removeFromHistory, clearHistory } = useSearchHistory({
    useBackend: true,
  });

  const { suggestions } = useSearchSuggestions(value, {
    enabled: value.trim().length > 0,
    minLength: 1,
    debounceMs: 300,
    maxResults: 6,
    language: currentLanguage,
  });

  // Función para realizar la búsqueda con redirección
  const performSearch = useCallback(
    (query: string) => {
      const trimmedQuery = query.trim();

      if (trimmedQuery) {
        if (onSearch) {
          onSearch(trimmedQuery);
        } else {
          router.push(`/job-offer-list?search=${encodeURIComponent(trimmedQuery)}`);
        }
      } else {
        if (onSearch) {
          onSearch('');
        } else {
          router.push('/job-offer-list');
        }
      }
    },
    [router, onSearch],
  );

  // Filtrar elementos visibles con useMemo
  const visibleHistory = useMemo(() => {
    const q = value.trim().toLowerCase();
    if (q.length === 0) {
      return history.slice(0, 5);
    }
    return history.filter((h) => h.toLowerCase().includes(q)).slice(0, 5);
  }, [history, value]);

  const visibleSuggestions = useMemo(() => {
    return suggestions.slice(0, 5);
  }, [suggestions]);

  const visibleCombined = useMemo(() => {
    return [...visibleHistory, ...visibleSuggestions];
  }, [visibleHistory, visibleSuggestions]);

  // Seleccionar item (historial o sugerencia)
  const selectItem = useCallback(
    (item: string) => {
      onChange(item);
      addToHistory(item);
      setIsOpen(false);
      setHighlighted(-1);
      setPreviewValue(null);
      performSearch(item);
    },
    [onChange, addToHistory, performSearch],
  );

  // Preview item (llenar input sin buscar)
  const previewItem = useCallback(
    (item: string) => {
      onChange(item);
      setPreviewValue(null);
      setIsOpen(true);
      setHighlighted(-1);
      inputRef.current?.focus();
    },
    [onChange],
  );

  // Ejecutar búsqueda
  const handleSearch = useCallback(() => {
    const searchValue = previewValue ?? value;
    const trimmed = searchValue.trim();
    if (error) return;
    if (trimmed) {
      addToHistory(trimmed);
      setIsOpen(false);
      setHighlighted(-1);
      setPreviewValue(null);
      performSearch(trimmed);
    }
  }, [value, previewValue, addToHistory, performSearch, error]);

  // Hook de navegación por teclado
  const { handleKeyDown } = useSearchKeyboard({
    isOpen,
    highlighted,
    combinedItems: visibleCombined,
    onSelect: selectItem,
    onSearch: handleSearch,
    onClose: () => {
      setIsOpen(false);
      setHighlighted(-1);
      setPreviewValue(null);
    },
    setHighlighted,
    setPreviewValue,
    enablePreview: typeof window !== 'undefined' && window.innerWidth >= 640,
  });

  // Hook de gestos táctiles (long press)
  const { handleTouchStart, handleTouchEnd, handlePointerDown, handlePointerUp } = useSearchTouch(
    (item) => setLongPressedItem(item),
    600,
  );

  // Manejar cambios en el input
  const handleInputChange = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      let newValue = e.target.value;
      if (newValue.length > 100) {
        newValue = newValue.slice(0, 100);
        setError('Límite máximo de 100 caracteres.');
        onChange(newValue);
        return;
      }
      onChange(newValue);
      setPreviewValue(null);
      setHighlighted(-1);
      const { isValid, error } = validateSearch(newValue);
      setError(isValid ? undefined : error);
    },
    [onChange],
  );

  // Click fuera para cerrar dropdown
  useEffect(() => {
    const onDocClick = (ev: MouseEvent) => {
      if (!containerRef.current) return;
      if (ev.target instanceof Node && !containerRef.current.contains(ev.target)) {
        setIsOpen(false);
        setHighlighted(-1);
        setPreviewValue(null);
      }
    };
    document.addEventListener('mousedown', onDocClick);
    return () => document.removeEventListener('mousedown', onDocClick);
  }, []);

  return (
    <div className={`relative ${className}`} ref={containerRef}>
      <div className='relative'>
        {/* Icono de búsqueda */}
        <div className='absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none'>
          <Search className='h-5 w-5 text-gray-400' />
        </div>

        {/* Input de búsqueda */}
        <input
          ref={inputRef}
          type='text'
          placeholder={placeholder}
          value={previewValue ?? value}
          onChange={handleInputChange}
          onFocus={() => {
            setIsFocused(true);
            setIsOpen(true);
          }}
          onBlur={() => {
            setIsFocused(false);
            setTimeout(() => {
              if (!containerRef.current?.contains(document.activeElement)) {
                setIsOpen(false);
                setPreviewValue(null);
              }
            }, 200);
          }}
          onKeyDown={handleKeyDown}
          disabled={disabled}
          className={`
            block w-full pl-10 ${showButton ? 'pr-32' : 'pr-3'} py-4 
            border border-gray-300 rounded-xl 
            shadow-sm 
            focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary 
            text-lg
            disabled:opacity-50 disabled:cursor-not-allowed
            ${error ? 'border-red-500' : ''}
            ${disabled ? 'bg-gray-100' : 'bg-white'}
          `}
        />

        {/* Botón de búsqueda (opcional) */}
        {showButton && (
          <button
            type='button'
            onClick={handleSearch}
            disabled={disabled}
            className='absolute right-1.5 top-1.5 px-6 py-2.5 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors disabled:opacity-50'
          >
            {buttonText}
          </button>
        )}
      </div>

      {/* Dropdown unificado */}
      <SearchDropdown
        isOpen={isOpen && !disabled}
        history={visibleHistory}
        suggestions={visibleSuggestions}
        highlighted={highlighted}
        longPressedItem={longPressedItem}
        query={value}
        onSelectItem={selectItem}
        onPreviewItem={previewItem}
        onDeleteItem={removeFromHistory}
        onClearHistory={async () => {
          await clearHistory();
          setIsOpen(true);
        }}
        onHighlight={setHighlighted}
        onLongPressStart={(item) => {
          const touchHandler = handleTouchStart(item);
          touchHandler();
          const pointerHandler = handlePointerDown(item);
          return pointerHandler;
        }}
        onLongPressEnd={() => {
          handleTouchEnd();
          handlePointerUp();
        }}
        onCancelDelete={() => setLongPressedItem(null)}
        maxVisibleHistory={5}
        maxVisibleSuggestions={5}
        className='border border-gray-200 rounded-xl shadow-xl mt-2'
      />

      {/* Mensaje de error */}
      <div className='min-h-5 mt-1 pl-4'>
        {error && <p className='text-red-500 text-sm leading-4 text-left'>{error}</p>}
      </div>
    </div>
  );
}
</file>

<file path="src/Components/Navigation/TopMenu.tsx">
'use client';

import { useState, useEffect, useRef } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { useRouter, usePathname } from 'next/navigation';
import { useTranslations, useLocale } from 'next-intl';
import { Wrench, UserCircle, ClipboardList, HelpCircle, Calendar, Wallet, Briefcase } from 'lucide-react';
import { useGetUserByIdQuery } from '@/app/redux/services/userApi';
import { skipToken } from '@reduxjs/toolkit/query';
import { useDispatch, useSelector } from 'react-redux';
import { setUser } from '@/app/redux/slice/userSlice';
import { resetFilters } from '@/app/redux/slice/jobOfert';
import { IUser } from '@/types/user';
import NotificationSystem from '@/app/components/NotificationSystem';

interface UserState {
  user: IUser | null;
  isAuthenticated: boolean;
  loading: boolean;
}

interface RootState {
  user: { user: IUser | null };
}

export default function TopMenu() {
  const t = useTranslations();
  const locale = useLocale();

  const localeDefault = (es: string, en: string) => (locale === 'es' ? es : en);

  const resolveT = (key: string, fallbackKey?: string, fallbackText?: string) => {
    try {
      if (fallbackKey) return t(fallbackKey);
    } catch {}
    return fallbackText ?? localeDefault('Iniciar Sesión', 'Log in');
  };
  
  const dispatch = useDispatch();
  const router = useRouter();
  const pathname = usePathname();

  const user = useSelector((state: RootState) => state.user.user);

  // UI state
  const [scrolled, setScrolled] = useState(false);
  const [accountOpen, setAccountOpen] = useState(false);
  const [profileMenuOpen, setProfileMenuOpen] = useState(false);
  const [userId, setUserId] = useState<string | null>(null);
  const [currentPath, setCurrentPath] = useState<string>(
    typeof window !== 'undefined' ? window.location.pathname : '',
  );
  const [isLogged, setIsLogged] = useState<boolean>(() =>
    typeof window !== 'undefined' ? Boolean(localStorage.getItem('servineo_token')) : false,
  );

  // Refs
  const dropdownRef = useRef<HTMLDivElement | null>(null);
  const logoRef = useRef<HTMLButtonElement | null>(null);
  const mobileMenuRef = useRef<HTMLDivElement | null>(null);
  const profileButtonRef = useRef<HTMLButtonElement | null>(null);
  const [isClient, setIsClient] = useState(false);

  useEffect(() => {
    setIsClient(true);
  }, []);

  // NAV items
  const navItems =
    user?.role === 'fixer'
      ? [
          { name: 'Servicios', href: '/servicios', icon: <Wrench className='h-5 w-5' /> },
          {
            name: 'Ofertas de trabajo',
            href: '/job-offer-list',
            icon: <ClipboardList className='h-5 w-5' />,
          },
          {
            name: 'Agenda',
            href: '/agenda',
            icon: <Calendar className='h-5 w-5' />,
          },
          {
            name: 'Ayuda',
            href: '/ask-for-help/centro_de_ayuda',
            icon: <HelpCircle className='h-5 w-5' />,
          },
        ]
      : [
          { name: 'Servicios', href: '/servicios', icon: <Wrench className='h-5 w-5' /> },
          {
            name: 'Ofertas de trabajo',
            href: '/job-offer-list',
            icon: <ClipboardList className='h-5 w-5' />,
          },
          {
            name: 'Ayuda',
            href: '/ask-for-help/centro_de_ayuda',
            icon: <HelpCircle className='h-5 w-5' />,
          },
        ];

  /* ---------- Helpers ---------- */

  const getPhoto = (u?: IUser | null): string => {
    if (!u) return '/es/img/icon.png';
    const sources: (string | undefined)[] = [u.photo, u.picture, u.url_photo];
    const valid = sources.find((src) => typeof src === 'string' && src.trim().length > 0);
    return valid ?? '/es/img/icon.png';
  };

  const userPhoto = getPhoto(user);

  const goToCentroDePagos = () => {
    const id = user?._id || user?.id || userId;
    if (id) {
      router.push(`/payment/centro-de-pagos?fixerId=${id}`);
      setProfileMenuOpen(false);
      setAccountOpen(false);
    } else {
      console.error('No se encontró el ID del fixer para ir al Centro de Pagos');
    }
  };

  const goToMisTrabajos = () => {
    router.push('/payment/trabajos');
    setProfileMenuOpen(false);
    setAccountOpen(false);
  };

  const goToConfirmarPagos = () => {
    router.push('/payment/Pagos-Fisico');
    setProfileMenuOpen(false);
    setAccountOpen(false);
  };

  /* ---------- Effects ---------- */

  useEffect(() => {
    const onScroll = () => setScrolled(window.scrollY > 10);
    window.addEventListener('scroll', onScroll);
    return () => window.removeEventListener('scroll', onScroll);
  }, []);

  useEffect(() => {
    if (typeof window !== 'undefined') setCurrentPath(window.location.pathname);
  }, [pathname]);

  useEffect(() => {
    if (typeof window === 'undefined') return;

    try {
      const raw = localStorage.getItem('servineo_user');
      const token = localStorage.getItem('servineo_token');

      if (raw && raw !== 'undefined') {
        const parsed: IUser = JSON.parse(raw);

        const normalized: IUser = {
          ...parsed,
          photo: parsed.photo || parsed.picture || parsed.url_photo || '',
          picture: parsed.picture || parsed.photo || parsed.url_photo || '',
          url_photo: parsed.url_photo || parsed.photo || parsed.picture || '',
        };

        dispatch(setUser(normalized));
        setIsLogged(Boolean(token));
        setUserId(normalized._id || normalized.id || null);
      } else {
        dispatch(setUser(null));
        setIsLogged(false);
        setUserId(null);
      }
    } catch {
      localStorage.removeItem('servineo_user');
      dispatch(setUser(null));
      setIsLogged(false);
    }
  }, [dispatch]);

  useEffect(() => {
    const sync = () => {
      try {
        const raw = localStorage.getItem('servineo_user');
        const token = localStorage.getItem('servineo_token');

        if (raw && raw !== 'undefined') {
          const parsed: IUser = JSON.parse(raw);

          const normalized: IUser = {
            ...parsed,
            photo: parsed.photo || parsed.picture || parsed.url_photo,
            picture: parsed.picture || parsed.photo || parsed.url_photo,
            url_photo: parsed.url_photo || parsed.photo || parsed.picture,
          };

          dispatch(setUser(normalized));
          setIsLogged(Boolean(token));
          setUserId(normalized._id || normalized.id || null);
        } else {
          dispatch(setUser(null));
          setIsLogged(false);
          setUserId(null);
        }
      } catch {
        dispatch(setUser(null));
        setIsLogged(false);
        setUserId(null);
      }
    };

    window.addEventListener('storage', sync);
    window.addEventListener('servineo_user_updated', sync);

    return () => {
      window.removeEventListener('storage', sync);
      window.removeEventListener('servineo_user_updated', sync);
    };
  }, [dispatch]);

  useEffect(() => {
    let timer: ReturnType<typeof setTimeout> | null = null;
    const logoutOnIdle = () => {
      try {
        const raw = localStorage.getItem('servineo_user');
        const email = raw ? (JSON.parse(raw)?.email ?? '') : '';
        if (email) sessionStorage.setItem('prefill_email', email);
      } catch {}
      localStorage.removeItem('servineo_token');
      localStorage.removeItem('servineo_user');
      dispatch(setUser(null));
      sessionStorage.setItem('session_expired', '1');
      const emailParam = sessionStorage.getItem('prefill_email')
        ? `&email=${encodeURIComponent(sessionStorage.getItem('prefill_email') || '')}`
        : '';
      router.push(`/login?expired=1${emailParam}`);
    };

    const resetTimer = () => {
      if (timer) clearTimeout(timer);
      timer = setTimeout(logoutOnIdle, 15 * 60 * 1000);
    };

    const events = ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'] as const;
    events.forEach((ev) => window.addEventListener(ev, resetTimer));

    resetTimer();
    return () => {
      if (timer) clearTimeout(timer);
      events.forEach((ev) => window.removeEventListener(ev, resetTimer));
    };
  }, [dispatch, router]);

  useEffect(() => {
    const handleOutside = (e: MouseEvent) => {
      if (
        profileMenuOpen &&
        dropdownRef.current &&
        !dropdownRef.current.contains(e.target as Node) &&
        !profileButtonRef.current?.contains(e.target as Node)
      ) {
        setProfileMenuOpen(false);
      }
    };

    document.addEventListener('click', handleOutside);
    return () => document.removeEventListener('click', handleOutside);
  }, [profileMenuOpen]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (mobileMenuRef.current && !mobileMenuRef.current.contains(event.target as Node)) {
        setAccountOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  // Fetch user data by ID
  const { data: fetchedUser } = useGetUserByIdQuery(userId ?? skipToken);

  useEffect(() => {
    if (fetchedUser) {
      dispatch(setUser(fetchedUser as IUser));
      setIsLogged(true);
    }
  }, [fetchedUser, dispatch]);

  // Logout function with job offers cleanup
  const logout = () => {
    localStorage.removeItem('servineo_token');
    localStorage.removeItem('servineo_user');
    
    // Limpiar estado y persistencia de job offers al cerrar sesión
    try {
      dispatch(resetFilters());
    } catch (e) {
      // no bloquear logout si falla el dispatch
      console.error('Error resetting job offers state on logout', e);
    }
    
    try {
      // Eliminar query string para evitar que se restaure search/page desde la URL
      const path = window.location.pathname;
      window.history.replaceState(null, '', path);
    } catch (e) {
      // ignore
    }
    
    window.location.reload();
  };

  const handleLogoClick = () => {
    if (typeof window === 'undefined') return;
    if (window.location.pathname === '/') {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
      router.push('/');
    }
  };

  const doLogout = () => {
    try {
      const raw = localStorage.getItem('servineo_user');
      const email = raw ? (JSON.parse(raw)?.email ?? '') : '';
      if (email) sessionStorage.setItem('prefill_email', email);
    } catch {}
    
    // Usar la función logout que incluye limpieza de filtros
    logout();
  };

  /* ---------- Render ---------- */
  return (
    <>
      {/* DESKTOP HEADER */}
      <header
        className={`hidden lg:block fixed top-0 left-0 right-0 z-50 transition-all duration-300 ${
          scrolled ? 'bg-white shadow-md' : 'bg-white'
        } border-b border-gray-100`}
        role='banner'
      >
        <div className='w-full max-w-8xl mx-auto px-4 flex justify-between items-center h-20'>
          <button
            ref={logoRef}
            onClick={handleLogoClick}
            className='flex items-center gap-2 group transition-transform duration-300 hover:scale-105 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[var(--color-primary)]'
            aria-label='Ir al inicio'
          >
            <div className='relative overflow-hidden rounded-full shadow-md'>
              <Image
                src='/es/img/icon.png'
                alt='Logo de Servineo'
                width={40}
                height={40}
                className='transition-transform duration-300 group-hover:scale-110'
              />
            </div>
            <span
              className='text-xl sm:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-[var(--color-primary)] to-[var(--color-primary)]'
              style={{ fontFamily: 'var(--font-sans)' }}
            >
              Servineo
            </span>
          </button>

          <nav className='flex gap-6' role='navigation' aria-label='Menú principal'>
            {navItems.map((item) => (
              <Link
                key={item.name}
                href={item.href}
                className={`font-medium relative after:absolute after:bottom-0 after:left-0 after:h-0.5 after:bg-[var(--color-primary)] after:transition-all
                  ${currentPath === item.href ? 'text-[var(--color-primary)] after:w-full' : 'text-gray-900 hover:text-[var(--color-primary)] after:w-0 hover:after:w-full'}`}
                >
                  {item.name}
                </Link>
              ))}
            </nav>
          <div className='flex items-center gap-8'>
            <NotificationSystem
              userId={userId || undefined}
              userName={user?.name}
              isAuthenticated={isLogged}
              userRole={user?.role as 'fixer' | 'requester'}

            />

            {isLogged ? (
              <div className='relative'>
                <button
                  ref={profileButtonRef}
                  onClick={() => setProfileMenuOpen((v) => !v)}
                  className='flex items-center gap-2 cursor-pointer ml-[-20px] px-3 py-1 border border-gray-300 bg-white rounded-xl transition'
                >
                  <img
                    src={userPhoto}
                    alt={user?.name ?? 'Usuario'}
                    className='w-10 h-10 rounded-full object-cover border'
                    onError={(e) => {
                      (e.currentTarget as HTMLImageElement).src = '/es/img/icon.png';
                    }}
                  />
                  <span className='font-medium text-gray-700 hover:text-primary'>
                    {user?.name ?? fetchedUser?.name ?? 'Usuario'}
                  </span>
                </button>

                {profileMenuOpen && (
                  <div
                    ref={dropdownRef}
                    className={`profileMenu ${profileMenuOpen ? 'show' : ''}`}
                    role='dialog'
                    aria-label='Menu de usuario'
                  >
                    <div className='menuHeader'>
                      <strong>Mi cuenta</strong>
                      <button
                        className='closeBtn'
                        onClick={() => setProfileMenuOpen(false)}
                        aria-label='Cerrar menu'
                      >
                        ✕
                      </button>
                    </div>

                    <img className='profilePreview' src={userPhoto} alt={user?.name ?? 'Usuario'} />

                    <div className='menuLabel'>
                      {user?.name ?? fetchedUser?.name ?? 'Sin nombre'}
                    </div>
                    <div className='menuLabel'>
                      {user?.email ?? fetchedUser?.email ?? 'Sin email'}
                    </div>
                    <div className='menuLabel'>
                      {user?.telefono ?? fetchedUser?.telefono ?? 'Sin teléfono'}
                    </div>

                    <hr style={{ margin: '8px 0', opacity: 0.3 }} />

                    {user?.role === 'fixer' ? (
                      <>
                        <Link
                          href='/fixer/dashboard'
                          onMouseDown={(e) => e.stopPropagation()}
                          onClick={() => setProfileMenuOpen(false)}
                          className='flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium bg-[var(--color-primary)] text-white hover:opacity-90 transition-opacity'
                        >
                          <UserCircle className='h-4 w-4' />
                          Perfil de Fixer
                        </Link>

                        <button
                          onMouseDown={(e) => e.stopPropagation()}
                          onClick={goToCentroDePagos}
                          className='menuItem w-full text-left'
                        >
                          <Wallet className='h-4 w-4 inline mr-2' />
                          Centro de Pagos
                        </button>

                        <button
                          onMouseDown={(e) => e.stopPropagation()}
                          onClick={goToConfirmarPagos}
                          className='menuItem w-full text-left'
                        >
                          <ClipboardList className='h-4 w-4 inline mr-2' />
                          Confirmar Pagos
                        </button>
                      </>
                    ) : (
                      <>
                        <button
                          onMouseDown={(e) => e.stopPropagation()}
                          onClick={(e) => {
                            e.stopPropagation();
                            setProfileMenuOpen(false);
                            router.push('/requesterEdit/perfil');
                          }}
                          className='menuItem'
                        >
                          Editar perfil
                        </button>

                        <button
                          onMouseDown={(e) => e.stopPropagation()}
                          onClick={goToMisTrabajos}
                          className='menuItem w-full text-left'
                        >
                          <Briefcase className='h-4 w-4 inline mr-2' />
                          Mis Trabajos
                        </button>

                        <button
                          onMouseDown={(e) => e.stopPropagation()}
                          onClick={(e) => {
                            e.stopPropagation();
                            setProfileMenuOpen(false);
                            router.push('/become-fixer');
                          }}
                          className='menuItem'
                        >
                          Convertirse en Fixer
                        </button>
                      </>
                    )}

                    <button
                      onMouseDown={(e) => e.stopPropagation()}
                      onClick={(e) => {
                        e.stopPropagation();
                        doLogout();
                      }}
                      className={`menuItem logoutBtn`}
                    >
                      Cerrar sesión
                    </button>
                  </div>
                )}
              </div>
            ) : (
              <>
                <Link
                  href='/login'
                  className='text-gray-700 hover:text-primary px-4 py-2 rounded-md text-sm font-medium transition-colors'
                >
                  {resolveT('buttons.login', 'navigation.login', 'Iniciar Sesión')}
                </Link>
                <Link
                  href='/signUp'
                  className='bg-primary text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-primary/90 transition-colors'
                >
                  {resolveT('buttons.register', 'navigation.register', 'Regístrate')}
                </Link>
              </>
            )}
          </div>
        </div>
      </header>

      {/* MOBILE/TABLET HEADER */}
      <div className='lg:hidden'>
        <div className='flex items-center justify-between px-3 py-4 border-b border-gray-200 bg-white/95 backdrop-blur-sm fixed top-0 left-0 right-0 z-50'>
          <button onClick={handleLogoClick} className='flex items-center gap-2 min-w-0'>
            <div className='relative overflow-hidden rounded-full shadow-md shrink-0'>
              <Image src='/es/img/icon.png' alt='Servineo' width={32} height={32} />
            </div>
            <span className='text-lg sm:text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-[var(--color-primary)] to-[var(--color-primary)] truncate max-w-[130px]'>
              Servineo
            </span>
          </button>

          {/* Auth Buttons */}
          <div className='flex items-center gap-2 flex-nowrap'>
            <NotificationSystem 
              userId={userId || undefined}
              userName={user?.name}
              isAuthenticated={isLogged}
              userRole={user?.role as 'fixer' | 'requester'}
            />
            {!isLogged ? (
              <>
                <Link
                  href='/login'
                  className='px-3 py-2 rounded-md text-[var(--color-primary)] font-medium text-[11px] sm:text-sm hover:opacity-90 transition-opacity whitespace-nowrap'
                >
                  Iniciar sesión
                </Link>
                <Link
                  href='/signUp'
                  className='px-3 py-2 rounded-md bg-[var(--color-primary)] text-white font-medium text-[11px] sm:text-sm hover:opacity-90 transition-opacity whitespace-nowrap'
                >
                  Registrarse
                </Link>
              </>
            ) : (
              <button
                onClick={() => setAccountOpen(!accountOpen)}
                className='flex items-center gap-2 cursor-pointer px-3 py-1 border border-gray-300 bg-white rounded-xl transition'
              >
                <span className='text-gray-700 font-medium'>{user?.name}</span>
              </button>
            )}
          </div>
        </div>

        <nav className='fixed bottom-0 left-0 right-0 h-16 border-t border-gray-200 bg-white/95 backdrop-blur-sm flex justify-around items-center z-50'>
          {navItems.map((item) => (
            <button
              key={item.name}
              onClick={() => (window.location.href = item.href)}
              className={`flex flex-col items-center text-[11px] px-1 py-1 ${
                currentPath === item.href
                  ? 'text-[var(--color-primary)]'
                  : 'text-gray-900 hover:text-[var(--color-primary)]'
              }`}
            >
              {item.icon}
              <span className='mt-1'>{item.name}</span>
            </button>
          ))}
        </nav>

        <div className='h-16' />
        <div className='h-16' />
      </div>

      <div className='hidden lg:block h-20' />
    </>
  );
}
</file>

<file path="messages/en.json">
{
  "HeroSection": {
    "title": "Find the perfect professional ",
    "subtitle": "We connect your home with verified experts in your city.",
    "placeholder": "what service do you need?",
    "search": "Search",
    "a": "Popular searches:",
    "professional": "professionals",
    "Projects completed": "Projects completed",
    "Overall grade": "Overall grade"
  },
  "Categories": {
    "Todos": "All",
    "Albañil": "Mason",
    "Carpintero": "Carpenter",
    "Cerrajero": "Locksmith",
    "Decorador": "Decorator",
    "Electricista": "Electrician",
    "Fontanero": "Plumber",
    "Fumigador": "Fumigator",
    "Instalador": "Installer",
    "Jardinero": "Gardener",
    "Limpiador": "Cleaner",
    "Mecánico": "Mechanic",
    "Montador": "Assembler",
    "Pintor": "Painter",
    "Pulidor": "Polisher",
    "Soldador": "Welder",
    "Techador": "Roofer",
    "Vidriero": "Glazier",
    "Yesero": "Plasterer",
    "Plomería": "Plumber"
  },
  "jobOffers": {
    "pageTitle": "Job Offers",
    "available": "available",
    "backToHome": "Home",
    "loading": "Loading offers...",
    "error": "An error occurred while loading offers",
    "viewModes": {
      "list": "List",
      "map": "Map",
      "grid": "Grid"
    },
    "emptyState": {
      "title": "No offers found",
      "description": "There are no offers matching your current search or filters."
    },
    "map": {
      "loading": "Loading map...",
      "yourLocation": "Your location",
      "jobOffers": "Job offers",
      "radius": "Radius: ~1km",
      "mapDetails": "Map details",
      "availableOffers": {
        "singular": "available offer",
        "plural": "available offers"
      },
      "distance": "away"
    }
  },
  "search": {
    "placeholder": "What service do you need?",
    "buttonSearch": "Search",
    "openFilters": "Open filters",
    "clearSearch": "Clear search",
    "moreFilters": "More filters",
    "recentSearches": "Recent searches",
    "clear": "Clear",
    "clearHistory": "Clear history",
    "noRecentSearches": "No recent searches yet",
    "deleteSearch": "Delete search",
    "delete": "Delete",
    "cancel": "Cancel",
    "preview": "Preview",
    "suggestions": "Suggestions",
    "noSuggestions": "No suggestions",
    "noResults": "No results found",
    "advancedSearch": "Advanced Search",
    "goToAdvancedSearch": "Go to advanced search",
    "searchPlaceholder": "Search:",
    "for": "for",
    "price": "Price",
    "moreThan": "More than",
    "lessThan": "Less than",
    "mostRecent": "Most recent",
    "oldest": "Oldest",
    "titleOnly": "Search only in job title",
    "exactWords": "Exact words",
    "date": "Date",
    "modify": "Modify",
    "resultsCountLabel": "RESULTS COUNT:"
  },
  "advancedSearch": {
    "pageTitle": "Advanced Search",
    "resultsCounter": {
      "loading": "Loading...",
      "results": "results",
      "noResults": "No results found"
    },
    "searchInput": {
      "placeholder": "What service do you need?",
      "buttonSearch": "Search"
    },
    "checkboxes": {
      "titleOnly": "Search only in job title",
      "exactWords": "Exact words"
    },
    "selectableParams": "Selectable Parameters:",
    "fixerName": {
      "label": "Fixer Name:",
      "placeholder": "Select Name Ranges",
      "ranges": {
        "ac": "From (A-C)",
        "df": "From (D-F)",
        "gi": "From (G-I)",
        "jl": "From (J-L)",
        "mn": "From (M-Ñ)",
        "oq": "From (O-Q)",
        "rt": "From (R-T)",
        "uw": "From (U-W)",
        "xz": "From (X-Z)"
      }
    },
    "city": {
      "label": "City:",
      "placeholder": "Select City",
      "options": {
        "beni": "Beni",
        "chuquisaca": "Chuquisaca",
        "cochabamba": "Cochabamba",
        "laPaz": "La Paz",
        "oruro": "Oruro",
        "pando": "Pando",
        "potosi": "Potosí",
        "santaCruz": "Santa Cruz",
        "tarija": "Tarija"
      }
    },
    "jobType": {
      "label": "Job Type:",
      "placeholder": "Select Job Type",
      "options": {
        "mason": "Mason",
        "carpenter": "Carpenter",
        "locksmith": "Locksmith",
        "decorator": "Decorator",
        "electrician": "Electrician",
        "plumber": "Plumber",
        "fumigator": "Fumigator",
        "installer": "Installer",
        "gardener": "Gardener",
        "cleaner": "Cleaner",
        "mechanic": "Mechanic",
        "assembler": "Assembler",
        "painter": "Painter",
        "polisher": "Polisher",
        "welder": "Welder",
        "roofer": "Roofer",
        "glazier": "Glazier",
        "plasterer": "Plasterer"
      }
    },
    "tags": {
      "label": "Tags:",
      "placeholder": "Select tags"
    },
    "price": {
      "label": "Price:",
      "placeholder": "Select Price Ranges"
    },
    "date": {
      "label": "Date:",
      "filters": {
        "specific": "Specific date",
        "recent": "Most recent",
        "oldest": "Oldest"
      },
      "selectDate": "Select a date"
    },
    "rating": {
      "label": "Rating:",
      "stars": "stars or more"
    },
    "buttons": {
      "applySearch": "Apply Search",
      "clearData": "Clear Data",
      "searching": "Searching..."
    },
    "help": {
      "buttonText": "Help",
      "tooltip": "Advanced Search Guide",
      "step1": "Go to the search bar and fill in the field with the service you need to search for in a personalized way.",
      "step2": "Depending on the entered text, you can search only in the job offer title or by exact word in the title and description.",
      "step3": "Select the fixer name filter according to your requirements.",
      "step4": "Select the city of interest to filter the results.",
      "step5": "Select the job type. Example: if you select \"Painter\", painter results will be displayed.",
      "step6": "Click on the price component and select the desired range.",
      "step7": "In the job type section, select and according to your choice the respective tags will be displayed.",
      "step8": "Select publication date: most recent, oldest or specific date using the calendar.",
      "step9": "Select rating range (1-5 stars). Clicking on a star shows subranges (1-9).",
      "step10": "Click on \"Apply Search\" to display results with all selected filters.",
      "step11": "Use the \"Clear Data\" button to clear all filters and return to the initial state.",
      "step12": "You can exit advanced search at any time by pressing the \"ESC\" key."
    }
  },
  "resultsAdvSearch": {
    "pageTitle": "Advanced Search Results",
    "noResults": "No results found",
    "loading": "Loading results...",
    "loadingFallback": "Loading results..."
  },
  "filtersPanel": {
    "filters": "Filters",
    "resetButton": {
      "desktop": "Reset",
      "mobile": "Reset Filters"
    },
    "fixerName": "Fixer Name",
    "city": "City",
    "jobCategory": "Job Type"
  },
  "pagination": {
    "show": "Show:",
    "perPage": "per page",
    "previous": "Previous",
    "next": "Next",
    "showingResults": "Showing {start} - {end} of {total} results",
    "page": "Page"
  },
  "cardJob": {
    "imageAlt": "Image {current} of {total}",
    "fixerPhotoAlt": "Profile photo of {name}",
    "fixerDefaultAlt": "User profile photo",
    "prevImage": "Previous image",
    "nextImage": "Next image",
    "contactWhatsApp": "Contact via WhatsApp",
    "searchResults": "Search results",
    "noResults": "No results found",
    "defaultUserName": "User"
  },
  "calendar": {
    "months": {
      "january": "January",
      "february": "February",
      "march": "March",
      "april": "April",
      "may": "May",
      "june": "June",
      "july": "July",
      "august": "August",
      "september": "September",
      "october": "October",
      "november": "November",
      "december": "December"
    },
    "daysShort": {
      "monday": "M",
      "tuesday": "T",
      "wednesday": "W",
      "thursday": "T",
      "friday": "F",
      "saturday": "S",
      "sunday": "S"
    },
    "daysAbbrev": {
      "sunday": "Sun.",
      "monday": "Mon.",
      "tuesday": "Tue.",
      "wednesday": "Wed.",
      "thursday": "Thu.",
      "friday": "Fri.",
      "saturday": "Sat."
    },
    "navigation": {
      "previousMonth": "Previous month",
      "nextMonth": "Next month",
      "of": "of"
    },
    "buttons": {
      "cancel": "Cancel",
      "accept": "Accept"
    }
  },
  "sortBy": {
    "featured": "Featured",
    "mostRecent": "Most Recent",
    "oldest": "Oldest",
    "nameAZ": "Name A-Z",
    "nameZA": "Name Z-A",
    "contactAsc": "Contact number asc",
    "contactDesc": "Contact number desc"
  },
  "navigation": {
    "home": "Home",
    "jobOffers": "Job Offers",
    "login": "Sign In",
    "register": "Sign Up",
    "logo": "LOGO"
  },
  "cta": {
    "footerTitle": "Ready to find the ideal professional?",
    "footerSubtitle": "Join thousands of people who have already found the perfect professional for their needs",
    "footerButton": "Sign up for free",
    "footerButtonView": "View services"
  },
  "HowItWorks": {
    "question": "How does it work?",
    "questionResponse": "Find and hire the ideal professional in simple steps",
    "HowItWorksSearch": "Search",
    "HowItWorksSearchDescription": "Find the service you need",
    "HowItWorksCompare": "Compare",
    "HowItWorksCompareDescription": "Review profiles and ratings",
    "HowItWorksContact": "Contact",
    "HowItWorksContactDescription": "Talk directly with professionals",
    "HowItWorksRate": "Rate",
    "HowItWorksRateDescription": "Share your experience"
  },
  "Inspiration": {
    "insTitle": "Inspiration for your home",
    "insDescription": "Discover ideas and projects carried out by our expert professionals"
  },
  "Map": {
    "mapTitle": "Find services near you",
    "mapDescription": "Explore available professionals in your area",
    "mapInteractive": "Interactive map here"
  },
  "RecentOffer": {
    "recOfTitle": "Recent Offers",
    "recOfDescription": "Discover the latest published offers",
    "viewAll": "View all →",
    "filterByCategory": "Filter by category",
    "noOffersAvailable": "No offers available",
    "noOffersCategory": "No offers found for this category",
    "closeModal": "Close"
  },
  "Services": {
    "serTitle": "Our Services",
    "serDescription": "Find the perfect service for your needs",
    "name services": "Plumbing",
    "Description": "Plumbing repairs and installations"
  },
  "becomeFixer": {
    "title": "Become a Fixer",
    "description": "Complete your registration and enable your account as a Fixer",
    "InputData": "Initial Data",
    "button1": "Continue",
    "completeName": "Full Name",
    "eMail": "Email",
    "phone": "Phone",
    "digits": "digits",
    "fields": {
      "name": {
        "label": "Full Name",
        "placeholder": "Enter your full name"
      },
      "email": {
        "label": "Email",
        "placeholder": "email@example.com"
      },
      "phone": {
        "label": "Phone",
        "placeholder": "+591 70123456"
      }
    },
    "buttons": {
      "submit": "Register",
      "submitting": "Registering..."
    }
  },
  "myOffers": {
    "newOffer": "New Offer",
    "noOffers": {
      "title": "You have no published offers",
      "description": "Create your first job offer so clients can find and contact you",
      "createFirst": "Create First Offer"
    },
    "actions": {
      "edit": "Edit",
      "delete": "Delete",
      "saveChanges": "Save Changes",
      "publishOffer": "Publish Offer"
    },
    "notifications": {
      "offerDeleted": {
        "title": "Offer deleted",
        "message": "The offer was successfully deleted"
      },
      "offerUpdated": {
        "title": "Offer updated",
        "message": "The offer was successfully updated"
      },
      "offerCreated": {
        "title": "Offer created",
        "message": "The offer was successfully created"
      },
      "error": {
        "title": "Error",
        "deleteMessage": "Could not delete the offer. Please try again.",
        "formMessage": "There was an error processing the form. Please try again."
      }
    },
    "confirmDelete": {
      "title": "Delete offer?",
      "message": "This action cannot be undone. Are you sure you want to delete this offer?",
      "confirm": "Delete",
      "cancel": "Cancel"
    }
  },
  "fixerProfile": {
    "tabs": {
      "home": "Home",
      "services": "Services",
      "reviews": "Reviews",
      "gallery": "Gallery"
    },
    "actions": {
      "contact": "Contact",
      "writeReview": "Write review",
      "viewAll": "View all"
    },
    "about": {
      "title": "About",
      "noDescription": "This professional has not yet added a description.",
      "experience": "Experience",
      "years": "years",
      "completedJobs": "completed jobs"
    },
    "services": {
      "title": "Services",
      "myServices": "My Services",
      "description": "Professional service specialized in"
    },
    "recentJobs": {
      "title": "Recent Jobs"
    },
    "reviews": {
      "title": "Reviews",
      "new": "New",
      "satisfied": "Satisfied Customer",
      "ago": "",
      "week": "week ago",
      "weeks": "weeks ago",
      "sampleReview": "Excellent service, very professional and punctual. The work was impeccable."
    },
    "gallery": {
      "title": "Work Gallery",
      "noPhotos": {
        "title": "No photos yet",
        "description": "This professional has not yet shared photos of their work."
      },
      "workLabel": "Work"
    },
    "profile": {
      "edit": "Edit profile",
      "title2": "Work Statistics",
      "save": "Save",
      "contactWhatsApp": "Contact via WhatsApp",
      "completedJobs": "completed jobs",
      "new": "New",
      "aboutMe": {
        "title": "About me",
        "placeholder": "Tell us about yourself and your services...",
        "noDescription": "This professional has not yet added a description."
      },
      "contactInfo": {
        "title": "Contact information",
        "phonePlaceholder": "Phone number",
        "whatsappPlaceholder": "WhatsApp (optional)"
      },
      "myServices": {
        "title": "My Services",
        "manage": "Manage",
        "noServices": "No services added yet"
      },
      "paymentMethods": {
        "title": "Payment methods"
      }
    }
  },
  "statistics": {
    "jobs": {
      "title": "Job Statistics",
      "loading": "Loading statistics...",
      "error": "Error loading data or data unavailable.",
      "noLogs": "No job status logs found.",
      "status": {
        "completed": "Completed",
        "inProgress": "In Progress",
        "pending": "Pending"
      },
      "jobs": "jobs",
      "total": "Total"
    }
  },
  "jobOfferModal": {
    "closeModal": "Close modal",
    "noImage": "No image available",
    "description": "Description",
    "servicesOffered": "Services Offered",
    "gallery": "Work Gallery",
    "photo": "Photo",
    "contactInfo": "Contact Information",
    "whatsapp": "WhatsApp",
    "city": "City",
    "contactButton": "Contact via WhatsApp",
    "contactWhatsApp": "Contact via WhatsApp",
    "scheduleAppointment": "Schedule Appointment",
    "share": "Share"
  },
  "navbar": {
    "logo": "Logo",
    "jobOffers": "Job Offers",
    "becomeFixer": "Become a Fixer",
    "myOffers": "My Offers",
    "a": "Fixers by job"
  },
  "Mock_Fixer": {
    "role": "Professional Plumber",
    "about": "Residential and commercial plumbing specialist with over 10 years of experience. I guarantee clean and long-lasting work.",
    "reviews": "124 reviews",
    "featuredOffers": "Featured Offers",
    "tabs": {
      "summary": "Summary",
      "offers": "Offers",
      "experience": "Experience",
      "certifications": "Certifications",
      "portfolio": "Portfolio",
      "statistics": "Statistics"
    }
  },
  "Login": {
    "title": "Log in",
    "mode": "Requester mode",
    "separator": "or",
    "form": {
      "email": {
        "label": "Email",
        "placeholder": "Enter your email"
      },
      "password": {
        "label": "Password",
        "placeholder": "Enter your password"
      }
    },
    "links": {
      "forgotPassword": "Forgot your password?",
      "noAccount": "Don't have an account?",
      "register": "Sign up"
    },
    "buttons": {
      "login": "Log in",
      "loading": "Logging in..."
    },
    "aria": {
      "showPassword": "Show password",
      "hidePassword": "Hide password"
    },
    "errors": {
      "invalidEmail": "Please enter a valid email",
      "passwordMinLength": "Password must be at least 6 characters",
      "invalidCredentials": "Invalid credentials or server error",
      "loginError": "Login error",
      "connectionError": "Could not connect to the server",
      "connectionErrorTitle": "Connection error",
      "googleError": "Google error"
    },
    "success": {
      "title": "Login successful",
      "welcome": "Welcome, {name}!"
    }
  },
  "SignUp": {
    "title": "Create account",
    "subtitle": "Join our community",
    "form": {
      "name": {
        "label": "Full name",
        "placeholder": "Enter your full name"
      },
      "email": {
        "label": "Email",
        "placeholder": "Enter your email"
      },
      "password": {
        "label": "Password",
        "placeholder": "Enter your password"
      },
      "confirmPassword": {
        "label": "Confirm password",
        "placeholder": "Confirm your password"
      },
      "terms": {
        "text": "I agree to the",
        "link": "terms and conditions"
      }
    },
    "buttons": {
      "register": "Create account",
      "loading": "Creating account..."
    },
    "links": {
      "haveAccount": "Already have an account?",
      "login": "Log in"
    },
    "errors": {
      "nameMinLength": "Name must be at least 2 characters",
      "invalidEmail": "Please enter a valid email",
      "passwordMinLength": "Password must be at least 6 characters",
      "passwordsMatch": "Passwords do not match",
      "termsRequired": "You must accept the terms and conditions",
      "registrationError": "Registration error",
      "connectionError": "Could not connect to the server"
    },
    "success": {
      "title": "Registration successful",
      "message": "Your account has been created successfully"
    }
  },
  "Calendar": {
    "fixer": "Fixer",
    "viewCalendar": "View Calendar",
    "profileInfo": "Profile Information",
    "previousExperience": "Previous Experience",
    "experienceDescription": "Information about previous experiences and jobs...",
    "reviews": "Reviews",
    "reviewsDescription": "Customer reviews and comments..."
  },
  "AdvSearch": {
    "pageTitle": "Search Results",
    "noResults": "No results found",
    "loading": "Loading...",
    "loadingFallback": "Loading search results..."
  },
  "VincularCorreo": {
    "title": "Email and password",
    "subtitle": "Link your account with credentials",
    "form": {
      "email": {
        "placeholder": "Email address"
      },
      "password": {
        "placeholder": "Password"
      },
      "repeatPassword": {
        "placeholder": "Repeat password"
      }
    },
    "buttons": {
      "link": "Link",
      "cancel": "Cancel",
      "confirm": "Confirm Link",
      "linking": "Linking..."
    },
    "errors": {
      "invalidEmail": "Must be a valid email address.",
      "passwordMinLength": "Password must be at least 8 characters.",
      "passwordUppercase": "Must contain at least one uppercase letter.",
      "passwordLowercase": "Must contain at least one lowercase letter.",
      "passwordNumber": "Must contain at least one number.",
      "passwordSymbol": "Must contain at least one symbol.",
      "passwordsMatch": "Passwords do not match."
    },
    "toasts": {
      "formErrors": "Please correct the form errors."
    },
    "success": {
      "message": "Link successful."
    }
  },
  "VincularDiscord": {
    "title": "Discord",
    "subtitle": "Link your Discord account",
    "buttons": {
      "link": "Link",
      "linking": "Linking..."
    }
  },
  "VincularGithub": {
    "title": "GitHub",
    "subtitle": "Link your GitHub account",
    "buttons": {
      "link": "Link",
      "linking": "Linking..."
    },
    "errors": {
      "noSession": "No active session to link account"
    },
    "success": {
      "message": "GitHub account linked successfully"
    }
  },
  "VincularGoogle": {
    "title": "Google",
    "subtitle": "Link your Google account",
    "buttons": {
      "link": "Link",
      "linking": "Linking..."
    },
    "errors": {
      "emptyToken": "Empty Google token",
      "noSession": "No active session to link account",
      "loginError": "Error logging in with Google"
    }
  },
  "AccountLoginSettings": {
    "title": "Linked Accounts Settings",
    "linkedAccounts": {
      "title": "Linked Accounts ({count})"
    },
    "availableMethods": {
      "title": "Available Methods ({count})",
      "allLinked": "All methods are currently linked."
    },
    "status": {
      "active": "Active"
    },
    "buttons": {
      "unlink": "Unlink"
    },
    "confirmUnlink": "Unlink {provider}?",
    "errors": {
      "loadMethods": "Error loading methods",
      "minimumMethods": "You must have at least one active method.",
      "linkError": "Error linking {provider} method: {error}",
      "unlinkError": "Error unlinking {provider} method: {error}",
      "unknown": "Unknown"
    }
  },
  "ConfiguracionPage": {
    "title": "Settings",
    "loading": {
      "profile": "Loading profile data..."
    },
    "errors": {
      "loadTitle": "Load Error",
      "loadMessage": "Could not load profile: {error}",
      "loadProfile": "Error loading profile data."
    },
    "buttons": {
      "retry": "Retry Load"
    },
    "sections": {
      "editProfile": "Edit Profile",
      "changePassword": "Change Password",
      "security": "Security"
    },
    "security": {
      "description": "Options and recommendations to help you protect your account",
      "changePassword": "Change password",
      "linkedDevices": "Linked devices"
    },
    "welcome": {
      "profilePhoto": "Profile photo",
      "title": "Welcome, {name}",
      "defaultName": "User",
      "description": "Manage your information, privacy and security to improve your experience in Servineo.",
      "loginRequired": "Log in to see your settings."
    },
    "navigation": {
      "editProfile": "Edit Profile",
      "security": "Security",
      "linkedAccounts": "Linked accounts"
    }
  },
  "RegistroGoogle": {
    "errors": {
      "noToken": {
        "title": "Token not received",
        "message": "Google token was not received."
      },
      "authError": {
        "title": "Error",
        "defaultMessage": "Error authenticating with Google."
      },
      "connection": {
        "title": "Connection Error",
        "defaultMessage": "Could not connect to the server. Please try again."
      }
    },
    "welcome": {
      "title": "Welcome",
      "message": "First time on Servineo. Complete your profile to continue."
    },
    "success": {
      "loginTitle": "Login successful",
      "loginMessage": "Welcome back, {name}",
      "defaultName": "user"
    }
  },
  "CalendarPage": {
    "closeButton": "Close",
    "titles": {
      "myCalendar": "My Calendar",
      "fixerCalendar": "{fixerName}'s Calendar"
    },
    "buttons": {
      "modifyAvailability": "Modify Availability",
      "cancelAppointments": "Cancel Appointments"
    }
  },
  "CloseSessionPage": {
    "backButton": "Back",
    "title": "Session Management",
    "description": "Manage your connected devices and log out of sessions on other devices to keep your account secure.",
    "loading": "Loading devices...",
    "important": "Important",
    "warnings": {
      "deviceLimit": "You have reached the limit of 3 connected devices.",
      "closeSessionsWarning": "When closing sessions, all devices except the current one will be disconnected. You will need to log in again on other devices."
    },
    "stats": {
      "activeSessions": "Active sessions",
      "otherDevices": "Other devices",
      "currentDevice": "Current device"
    },
    "buttons": {
      "closeOtherSessions": "Log out of sessions on other devices",
      "closingSessions": "Logging out..."
    },
    "noOtherSessions": "There are no other active sessions. Only this device is connected.",
    "activeSessions": {
      "title": "Active Sessions ({count})",
      "noDevices": "No connected devices.",
      "thisDevice": "This device"
    },
    "confirmation": {
      "title": "Log out of sessions?",
      "message": "This action will log out all active sessions on other devices ({count} {sessions}).",
      "sessionSingular": "session",
      "sessionPlural": "sessions",
      "cancel": "Cancel",
      "closing": "Logging out...",
      "confirm": "Yes, log out sessions"
    }
  },
  "SignUpRegister": {
    "title": "Sign Up",
    "mode": "Requester mode",
    "separator": "or continue with",
    "terms": {
      "text": "By signing up you accept the",
      "link": "terms of use"
    },
    "login": {
      "text": "Already have an account?",
      "link": "Log in"
    }
  },
  "CertificationsSection": {
    "titles": {
      "certifications": "Certifications",
      "myCertifications": "My Certifications"
    },
    "buttons": {
    "addCertification": "Add Certification",
    "cancel": "Cancel",
    "save": "Save",
    "saving": "Saving...",
    "delete": "Delete"
    },
    "card": {
      "issued": "Issued",
      "expires": "Expires",
      "viewCredential": "View credential"
    },
    "tooltips": {
      "edit": "Edit",
      "delete": "Delete"
    },
    "modal": {
      "editTitle": "Edit Certification",
      "newTitle": "New Certification"
    },
    "form": {
      "optional": "optional",
      "name": {
        "label": "Certification Name",
        "placeholder": "Ex: Electrical Technician",
        "required": "Name is required"
      },
      "institution": {
        "label": "Issuing Institution",
        "placeholder": "Ex: INFOCAL",
        "required": "Institution is required"
      },
      "issueDate": {
        "label": "Issue Date"
      },
      "expiryDate": {
        "label": "Expiry Date"
      },
      "credentialId": {
        "label": "Credential ID",
        "placeholder": "Optional",
        "label2": "URL credential"
      },
      "credentialUrl": {
        "label": "Credential URL",
        "placeholder": "https://..."
      }
    },
    "empty": "No certifications added yet",
    "loading": "Loading certifications...",
    "errors": {
      "noFixerProfile": "No fixer profile found",
      "saveError": "Error saving certification",
      "deleteError": "Error deleting certification",
      "loadError": "Error loading certifications"
    },
    "notifications": {
      "success": "Success",
      "error": "Error",
      "createSuccess": "Certification added successfully",
      "updateSuccess": "Certification updated successfully",
      "deleteTitle": "Delete Certification",
      "deleteMessage": "Are you sure you want to delete this certification?",
      "deleteSuccessTitle": "Deleted",
      "deleteSuccess": "Certification deleted successfully"
    },
    "deleteConfirmation": "Are you sure you want to delete this certification?"
  },
  "ExperienceSection": {
    "titles": {
      "experience": "Work Experience",
      "myExperience": "My Work Experience"
    },
    "buttons": {
      "addExperience": "Add Experience",
      "cancel": "Cancel",
      "save": "Save",
      "saving": "Saving..."
    },
    "card": {
      "present": "Present"
    },
    "tooltips": {
      "edit": "Edit",
      "delete": "Delete"
    },
    "modal": {
      "editTitle": "Edit Experience",
      "newTitle": "New Experience"
    },
    "form": {
      "jobTitle": {
        "label": "Job Title",
        "placeholder": "Ex: Senior Plumber",
        "required": "Job title is required"
      },
      "organization": {
        "label": "Company / Organization",
        "placeholder": "Ex: General Services Inc.",
        "required": "Company is required"
      },
      "jobType": {
        "label": "Employment Type",
        "select": "Select an option...",
        "required": "Employment type is required",
        "options": {
          "fullTime": "Full Time",
          "partTime": "Part Time",
          "contract": "Contract",
          "freelance": "Freelance"
        }
      },
      "startDate": {
        "label": "Start Date",
        "required": "Start date is required"
      },
      "endDate": {
        "label": "End Date"
      },
      "isCurrent": {
        "label": "I currently work here"
      }
    },
    "loading": "Loading experiences...",
    "errors": {
      "loadError": "Error loading experiences"
    },
    "empty": {
      "readOnly": "No work experience added yet",
      "editable": "No work experience. Start by adding your first position!"
    },
    "notifications": {
      "success": "Success",
      "error": "Error",
      "createSuccess": "Experience added successfully",
      "updateSuccess": "Experience updated successfully",
      "deleteTitle": "Delete Experience",
      "deleteMessage": "Are you sure you want to delete this experience?",
      "deleteSuccessTitle": "Deleted",
      "deleteSuccess": "Experience deleted successfully",
      "genericError": "An error occurred. Please try again."
    },
    "deleteConfirmation": "Are you sure you want to delete this experience?"
  },
    "JobOffersSection": {
    "titles": {
      "jobOffers": "Job Offers",
      "myJobOffers": "My Job Offers"
    },
    "buttons": {
      "newOffer": "New Offer",
      "cancel": "Cancel",
      "save": "Save",
      "saving": "Saving..."
    },
    "card": {
      "defaultTitle": "No title",
      "defaultCategory": "General"
    },
    "modal": {
      "editTitle": "Edit Offer",
      "newTitle": "New Offer"
    },
    "form": {
      "defaultCity": "Cochabamba",
      "title": {
        "label": "Title",
        "placeholder": "Enter offer title"
      },
      "category": {
        "label": "Category",
        "select": "Select...",
        "required": "Select a category",
        "options": {
          "plumbing": "Plumbing",
          "electricity": "Electricity",
          "carpentry": "Carpentry",
          "painting": "Painting"
        }
      },
      "tags": {
        "label": "Tags (max 5)",
        "empty": "No tags selected",
        "addTag": "Add Tag",
        "limitReached": "Maximum tags reached (5)",
        "alreadyAdded": " (already added)"
      },
      "description": {
        "label": "Description",
        "placeholder": "Describe your service...",
        "required": "Description is required"
      },
      "price": {
        "label": "Price (Bs.)"
      },
      "city": {
        "label": "City"
      },
      "contactPhone": {
        "label": "Contact Phone"
      },
      "images": {
        "label": "Images"
      }
    },
    "loading": "Loading offers...",
    "empty": "No offers published yet.",
    "notifications": {
      "noUser": "User not identified.",
      "noImages": "You must upload at least one photo.",
      "imageLimit": "Limit exceeded",
      "imageLimitMessage": "You can only upload up to 5 images.",
      "imageTooBig": "Image too large",
      "imageSizeMessage": "The image {fileName} exceeds 5MB.",
      "updated": "Updated",
      "updateSuccess": "Offer updated successfully.",
      "published": "Published",
      "createSuccess": "Offer created successfully.",
      "error": "Error",
      "errorMessage": "Error processing the request.",
      "deleteTitle": "Delete offer?",
      "deleteMessage": "This action cannot be undone.",
      "deleted": "Deleted",
      "deleteSuccess": "Offer deleted.",
      "deleteError": "Could not delete the offer."
    },
    "confirmButton": "Confirm",
    "deleteConfirmation": "Are you sure you want to delete this offer?"
  },
  "PortfolioSection": {
    "titles": {
      "portfolio": "Portfolio",
      "myPortfolio": "My Portfolio"
    },
    "buttons": {
      "video": "Video",
      "image": "Image",
      "cancel": "Cancel",
      "save": "Save"
    },
    "image": {
      "alt": "Portfolio item",
      "placeholder": "https://placehold.co/300x300?text=No+Image"
    },
    "tooltips": {
      "delete": "Delete"
    },
    "modal": {
      "addImage": "Add Image",
      "addVideo": "Add Video"
    },
    "form": {
      "imageUrl": {
        "label": "Image URL",
        "placeholder": "https://...",
        "required": "URL is required"
      },
      "youtubeUrl": {
        "label": "YouTube URL",
        "placeholder": "https://www.youtube.com/watch?v=...",
        "required": "URL is required"
      },
      "thumbnailUrl": {
        "label": "Thumbnail URL (Optional)",
        "placeholder": "Will try to extract automatically"
      }
    },
    "deleteConfirmation": "Are you sure you want to delete this item?",
    "emptyState": "Empty portfolio"
  },
  "RegistroForm": {
    "fields": {
      "nombre": {
        "label": "First Name",
        "placeholder": "Enter your first name"
      },
      "apellido": {
        "label": "Last Name",
        "placeholder": "Enter your last name"
      },
      "email": {
        "label": "Email",
        "placeholder": "name@domain.com"
      },
      "password": {
        "label": "Password",
        "placeholder": "Enter your password"
      },
      "confirmarPassword": {
        "label": "Confirm Password",
        "placeholder": "Confirm your password"
      }
    },
    "validation": {
      "nombre": {
        "min": "First name must be at least 3 characters",
        "max": "First name cannot exceed 50 characters",
        "regex": "Only letters and spaces are allowed"
      },
      "apellido": {
        "min": "Last name must be at least 3 characters",
        "max": "Last name cannot exceed 50 characters",
        "regex": "Only letters and spaces are allowed"
      },
      "email": {
        "invalid": "Invalid email address"
      },
      "password": {
        "min": "Must be at least 8 characters"
      },
      "confirmarPassword": {
        "match": "Passwords do not match"
      }
    },
    "buttons": {
      "generatePassword": "Generate secure password",
      "submit": "Join",
      "submitting": "Registering..."
    },
    "aria": {
      "showPassword": "Show password",
      "hidePassword": "Hide password"
    },
    "tooltips": {
      "passwordCopy": "Will be automatically copied to clipboard"
    },
    "notifications": {
      "passwordGenerated": {
        "title": "Password Generated",
        "message": "A secure password has been generated and copied to your clipboard."
      },
      "validationError": {
        "title": "Incomplete or Incorrect Data",
        "message": "Please review the highlighted fields to continue."
      },
      "success": {
        "title": "Registration Successful",
        "message": "Welcome, {name}. Your account has been created successfully.",
        "toast": "Account created successfully! Welcome, {name}."
      },
      "error": {
        "title": "Registration Error",
        "message": "Unable to complete registration."
      }
    }
  },
  "TerminosPage": {
    "title": "Servero Terms and Conditions of Use",
    "section1": {
      "title": "1. ACCEPTANCE OF TERMS",
      "content": "By accessing and using the Servero application, the user agrees to comply with these Terms and Conditions. If you do not agree with them, you must refrain from using the platform."
    },
    "section2": {
      "title": "2. USE OF SERVICE",
      "content1": "Servineo is a digital platform that connects users with independent service providers (e.g., electricians, plumbers, masons, painters, among others). The user acknowledges that Servero does not directly provide services, but acts solely as a digital intermediary.",
      "content2": "Each user is responsible for the truthfulness of the information they provide. It is prohibited to use the platform for illicit, fraudulent purposes or purposes contrary to public order."
    },
    "section3": {
      "title": "3. PRIVACY",
      "content": "Personal information provided by the user will be treated in accordance with Servero's Privacy Policy. Data will be used solely for the operation of the application, account management, and connection between requesters and fixers. Servero is committed to protecting user information but is not responsible for unauthorized access resulting from the user's own negligence (e.g., sharing passwords)."
    },
    "section4": {
      "title": "4. INTELLECTUAL PROPERTY",
      "content": "All rights to the Servero name, logos, design, interface, and application content belong to Servero's owners. Users may not copy, modify, distribute, or use for commercial purposes any element of the platform without express authorization."
    },
    "section5": {
      "title": "5. LIMITATION OF LIABILITY",
      "content": "Servineo does not guarantee the quality, compliance, or suitability of services offered by providers registered on the platform. Responsibility for the execution of work rests exclusively with the providers and users who hire them. Servero is not responsible for damages, losses, or conflicts that may arise between users and providers."
    },
    "section6": {
      "title": "6. TERMINATION",
      "content": "Servero reserves the right to suspend or cancel the account of any user who violates these Terms and Conditions or misuses the application."
    },
    "section7": {
      "title": "7. APPLICABLE LAW",
      "content": "These Terms and Conditions are governed by the laws in force in the Plurinational State of Bolivia. In case of dispute, the parties submit to the jurisdiction of the competent courts in said country."
    },
    "section8": {
      "title": "8. CONTACT",
      "content": "For inquiries, complaints, or suggestions, users can contact the Servero team via email:"
    }
  },
  "TopMenu": {
    "nav": {
      "home": "Home",
      "jobOffers": "Job Offers",
      "help": "Help"
    },
    "buttons": {
      "login": "Log In",
      "register": "Sign Up",
      "myAccount": "My Account",
      "becomeFixer": "Become a Fixer",
      "fixerProfile": "Fixer Profile"
    },
    "dropdown": {
      "editProfile": "Edit Profile",
      "logout": "Log Out"
    }
  },
  "helpCenter": {
    "title": "Help Center",
    "subtitle": "Find quick answers, guides and participate in the community to solve your doubts about Servineo.",
    "search": {
      "placeholder": "Search for help on Servineo...",
      "button": "Run search"
    },
    "messages": {
      "emptySearch": "Please enter a search term.",
      "searching": "Simulated search for: \"{query}\".",
      "noResults": "No results found for \"{query}\".",
      "navigating": "Simulating navigation to: {url}",
      "noCategories": "No categories found matching \"{query}\"."
    },
    "suggestions": {
      "paymentProblems": "Problems with my payment",
      "paymentMethods": "Accepted payment methods",
      "resetPassword": "Reset password",
      "billing": "Billing information",
      "support": "Support contact"
    },
    "sections": {
      "faq": {
        "title": "Frequently Asked Questions (FAQ)",
        "description": "Quick answers to common questions."
      },
      "forum": {
        "title": "User Forum",
        "description": "Share your questions and help other users"
      }
    },
    "results": {
      "title": "Results for \"{query}\"",
      "empty": "No results found."
    }
  },
  "faq": {
    "title": "Frequently Asked Questions",
    "subtitle": "Find quick answers to the most common questions about Servineo",
    "backButton": "Go back"
  },
  "tracking": {
    "title": "Appointment Tracking",
    "subtitle": "Activity monitoring and geographic coverage",
    "filters": {
      "from": "From",
      "to": "To"
    },
    "map": {
      "loading": "Loading Map...",
      "loadingData": "Loading data...",
      "noAppointments": "No geolocated appointments",
      "unknown": "Unknown",
      "client": "Client"
    },
    "metrics": {
      "total": "Total Appointments",
      "scheduled": "Scheduled Appointments",
      "cancelled": "Cancelled Appointments"
    }
  },
  "dashboard": {
    "loading": "Loading statistics...",
    "error": "Error loading statistics",
    "periods": {
      "weekly": "Weekly",
      "monthly": "Monthly",
      "yearly": "Yearly"
    },
    "periodLabel": "Period",
    "totalSearches": "Total searches",
    "noData": "No data available for the selected period",
    "charts": {
      "userDistribution": {
        "title": "User Distribution",
        "description": "Types of users who performed searches"
      },
      "fixerRanges": {
        "title": "Fixer Name Ranges",
        "description": "Searches by name letter range"
      },
      "cities": {
        "title": "Cities",
        "description": "Searches by city"
      },
      "jobTypes": {
        "title": "Job Types",
        "description": "Searches by job type"
      },
      "filterStats": "Filter statistics",
      "showingTotal": "Showing total searches"
    }
  },
  "adminLogin": {
    "logo": "SERVINEO",
    "subtitle": "Admin Login",
    "welcome": "Welcome back, Admin",
    "form": {
      "emailLabel": "Email address",
      "emailPlaceholder": "admin@servineo.com",
      "passwordLabel": "Password",
      "signInButton": "Sign In as Admin",
      "signingIn": "Signing In...",
      "or": "or",
      "googleButton": "Sign in with Google",
      "connecting": "Connecting..."
    },
    "errors": {
      "googleApiNotAvailable": "Google API not available",
      "googleClientIdNotConfigured": "Google Client ID not configured",
      "googleLoginError": "Error with Google Login",
      "noCredential": "Error: No credential received from Google",
      "incorrectCredentials": "Incorrect credentials",
      "serverError": "Server error"
    }
  },
  "footer": {
    "skipToMain": "Skip to main content",
    "description": "The leading platform to connect homes with qualified professionals in Cochabamba. Guaranteed quality and reliable service.",
    "explore": {
      "title": "Explore SERVINEO",
      "services": "Services",
      "offerServices": "Offer your services",
      "jobOffers": "Job Offers"
    },
    "company": {
      "title": "Company",
      "aboutUs": "About us",
      "workWithUs": "Work with us",
      "testimonials": "Testimonials",
      "support": "Support",
      "whyServineo": "Why Servineo?",
      "howItWorks": "How Servineo works",
      "restartTour": "View guide again"
    },
    "legal": {
      "title": "Legal",
      "privacy": "Privacy policy",
      "terms": "User agreements",
      "cookies": "Cookie policy"
    },
    "contact": {
      "title": "Contact us",
      "location": "Location: Cochabamba, Bolivia"
    },
    "social": {
      "title": "Follow us"
    },
    "copyright": "© 2024 Servineo. All rights reserved.",
    "madeWith": "Made with ❤️ in Cochabamba",
    "operational": "System operational",
    "ariaLabels": {
      "footer": "Servineo footer",
      "footerLinks": "Footer links",
      "viewLocation": "View location on Google Maps: Cochabamba, Bolivia",
      "whatsapp": "WhatsApp number",
      "sendWhatsApp": "Send WhatsApp message to +591 75139742",
      "email": "Contact email",
      "sendEmail": "Send email to servineo.serviciostecnicos@gmail.com",
      "socialMedia": "Servineo social media",
      "facebook": "Visit Servineo Facebook",
      "instagram": "Visit Servineo Instagram",
      "twitter": "Visit Servineo X (formerly Twitter)",
      "copyright": "Credits and copyright"
    }
  },
  "home": {
    "mapSection": {
      "title": "Find Services Near You",
      "subtitle": "Explore available professionals in your area"
    }
  },
  "HowUseServineoTitle": {
    "title": "How Servineo Works",
    "subtitle": "Those are the steps you should\nfollow to use easily our platform",
    "guide":"Need a more immersive experience? Try our",
    "guideLink": "interactive guide",
    "fingOut": "Find out"
  },
  "Pasos": {
    "title": "Follow these steps to hire",
    "subtitle": "Follow these steps to hire the ideal professional for your needs quickly and easily.",
    "step1": {
      "title": "Browse and search",
      "description": "Explore our wide variety of services and use the search bar to find the service you need."
    },
    "step2": {
      "title": "Contact the fixer",
      "description": "Get in touch with the fixer through WhatsApp to discuss your needs and get a personalized quote."
    },
    "step3": {
      "title": "Coordinate yours services",
      "description": "Coordinate with your fixer to ensure the service meets your needs and choose an offer before sending the fixer the required information."
    },
    "step4": {
      "title": "Approve and contact",
      "description": "Receive the service and leave your comments about the quality of the service."
    },
    "button": "View services"
  },
  "Consejos": {
    "title": "Tips for better use",
    "subtitle": "Perfect your use of the platform\nhere are some tips",
    "tip1": {
      "title": "Filters",
      "description": "Apply search filters, keywords, or check our map to see if there are fixers near your location."
    },
    "tip2": {
      "title": "Ratings and reviews",
      "description": "Check other people's ratings and reviews to learn more about how a particular fixer performs."
    },
    "tip3": {
      "title": "Comunication",
      "description": "Contact the fixer for more details about the service and to clarify any doubts you may have."
    }
  },
  "CategoriasPopulares": {
    "title": "Popular Categories",
    "subtitle": "Don't know where to start?",
    "subtitle2": "Explore our most popular categories",
    "card1": {
      "name": "Plumbing",
      "description": "Plumbing repairs and installations"
    },
    "card2": {
      "name": "Electricity",
      "description": "Electrical installations and repairs"
    }, 
    "card3": {
      "name": "Carpentry",
      "description": "Woodwork and furniture projects"
    },
    "card4": {
      "name": "Cleaning",
      "description": "Professional cleaning services"
    },
    "card5": {
      "name": "Gardening",
      "description": "Garden care and maintenance"
    },
    "card6": {
      "name": "Painting",
      "description": "Residential painting services"
    },
    "card7": {
      "name": "Moving",
      "description": "Moving and transportation services"
    },
    "card8": {
      "name": "Technology",
      "description": "Tech equipment repair"
    },
    "demand": "in demand",
    "button": "View professionals",
    "button2": "View all categories"
  },
  "Accordion": {
    "title": "Frecuently Asked Questions",
    "section1": {
      "question": "How does Servineo work?",
      "answer": "Servineo connects homes with qualified professionals in Cochabamba. Post your need, receive quotes from verified fixers, and choose the best one for the job."
    },
    "section2": {
      "question": "What types of services do you offer?",
      "answer": "We offer plumbing, electricity, carpentry, painting, cleaning, gardening, welding, masonry, and many more home services."
    },
    "section3": {
      "question": "How are fixers verified?",
      "answer": "All our fixers go through a verification process that includes document review, interviews, and evaluation of previous experience."
    },
    "section4": {
      "question": "What guarantee do you offer?",
      "answer": "We offer a 30-day guarantee on all work performed. If you are not satisfied, our support team will help you resolve any issue."
    },
    "section5": {
      "question": "How are payments made?",
      "answer": "Payments are 100% secure through our platform. You only release payment when the work is completed and you are satisfied with the result."
    }
  }
}
</file>

<file path="messages/es.json">
{
  "HeroSection": {
    "title": "Encuentra el profesional perfecto",
    "subtitle": "Conectamos tu hogar con expertos verificados en tu ciudad",
    "placeholder": "¿Que servicio necesitas?",
    "search": "Buscar",
    "a": "Búsquedas populares:",
    "professional": "profesionales",
    "Projects completed": "Trabajos completados",
    "Overall grade": "Calificación Promedio"
  },
  "Categories": {
    "Todos": "Todos",
    "Albañil": "Albañil",
    "Carpintero": "Carpintero",
    "Cerrajero": "Cerrajero",
    "Decorador": "Decorador",
    "Electricista": "Electricista",
    "Fontanero": "Fontanero",
    "Fumigador": "Fumigador",
    "Instalador": "Instalador",
    "Jardinero": "Jardinero",
    "Limpiador": "Limpiador",
    "Mecánico": "Mecánico",
    "Montador": "Montador",
    "Pintor": "Pintor",
    "Pulidor": "Pulidor",
    "Soldador": "Soldador",
    "Techador": "Techador",
    "Vidriero": "Vidriero",
    "Yesero": "Yesero",
    "Plomería": "Plomería"
  },
  "jobOffers": {
    "pageTitle": "Ofertas de Trabajo",
    "available": "disponibles",
    "backToHome": "Inicio",
    "loading": "Cargando ofertas...",
    "error": "Ocurrió un error al cargar las ofertas",
    "viewModes": {
      "list": "Lista",
      "map": "Mapa",
      "grid": "Cuadrícula"
    },
    "emptyState": {
      "title": "No se encontraron ofertas",
      "description": "No hay ofertas que coincidan con tu búsqueda o filtros actuales."
    },
    "map": {
      "loading": "Cargando mapa...",
      "yourLocation": "Tu ubicación",
      "jobOffers": "Ofertas de trabajo",
      "radius": "Radio: ~1km",
      "mapDetails": "Detalles del mapa",
      "availableOffers": {
        "singular": "oferta disponible",
        "plural": "ofertas disponibles"
      },
      "distance": "de distancia"
    }
  },
  "search": {
    "placeholder": "¿Qué servicio necesitas?",
    "buttonSearch": "Buscar",
    "openFilters": "Abrir filtros",
    "clearSearch": "Limpiar búsqueda",
    "moreFilters": "Más filtros",
    "recentSearches": "Búsquedas recientes",
    "clear": "Borrar",
    "clearHistory": "Borrar historial",
    "noRecentSearches": "Aún no hay búsquedas recientes",
    "deleteSearch": "Eliminar búsqueda",
    "delete": "Eliminar",
    "cancel": "Cancelar",
    "preview": "Previsualizar",
    "suggestions": "Sugerencias",
    "noSuggestions": "No hay sugerencias",
    "noResults": "No se encontraron resultados",
    "advancedSearch": "Advanced search",
    "goToAdvancedSearch": "Go to advanced search",
    "searchPlaceholder": "Búsqueda:",
    "for": "para",
    "price": "Precio",
    "moreThan": "Más de",
    "lessThan": "Menos de",
    "mostRecent": "Los más recientes",
    "oldest": "Los más antiguos",
    "titleOnly": "Buscar solo en el título de la Oferta de Trabajo",
    "exactWords": "Palabras Exactas",
    "date": "Fecha",
    "modify": "Modificar",
    "resultsCountLabel": "CANTIDAD DE RESULTADOS:"
  },
  "advancedSearch": {
    "pageTitle": "Búsqueda Avanzada",
    "resultsCounter": {
      "loading": "Cargando...",
      "results": "resultados",
      "noResults": "No se encontraron resultados"
    },
    "searchInput": {
      "placeholder": "¿Qué servicio necesitas?",
      "buttonSearch": "Buscar"
    },
    "checkboxes": {
      "titleOnly": "Buscar solo en el título de la Oferta de Trabajo",
      "exactWords": "Palabras Exactas"
    },
    "selectableParams": "Parámetros Seleccionables:",
    "fixerName": {
      "label": "Nombre del fixer:",
      "placeholder": "Seleccionar Rangos de Nombre",
      "ranges": {
        "ac": "De (A-C)",
        "df": "De (D-F)",
        "gi": "De (G-I)",
        "jl": "De (J-L)",
        "mn": "De (M-Ñ)",
        "oq": "De (O-Q)",
        "rt": "De (R-T)",
        "uw": "De (U-W)",
        "xz": "De (X-Z)"
      }
    },
    "city": {
      "label": "Ciudad:",
      "placeholder": "Seleccionar Ciudad",
      "options": {
        "beni": "Beni",
        "chuquisaca": "Chuquisaca",
        "cochabamba": "Cochabamba",
        "laPaz": "La Paz",
        "oruro": "Oruro",
        "pando": "Pando",
        "potosi": "Potosí",
        "santaCruz": "Santa Cruz",
        "tarija": "Tarija"
      }
    },
    "jobType": {
      "label": "Tipo de Trabajo:",
      "placeholder": "Seleccionar Tipo de Trabajo",
      "options": {
        "mason": "Albañil",
        "carpenter": "Carpintero",
        "locksmith": "Cerrajero",
        "decorator": "Decorador",
        "electrician": "Electricista",
        "plumber": "Fontanero",
        "fumigator": "Fumigador",
        "installer": "Instalador",
        "gardener": "Jardinero",
        "cleaner": "Limpiador",
        "mechanic": "Mecánico",
        "assembler": "Montador",
        "painter": "Pintor",
        "polisher": "Pulidor",
        "welder": "Soldador",
        "roofer": "Techador",
        "glazier": "Vidriero",
        "plasterer": "Yesero"
      }
    },
    "tags": {
      "label": "Etiquetas:",
      "placeholder": "Seleccionar etiquetas"
    },
    "price": {
      "label": "Precio:",
      "placeholder": "Seleccionar Rangos de Precio"
    },
    "date": {
      "label": "Fecha:",
      "filters": {
        "specific": "Fecha específica",
        "recent": "Los más recientes",
        "oldest": "Los más antiguos"
      },
      "selectDate": "Seleccionar una fecha"
    },
    "rating": {
      "label": "Calificación:",
      "stars": "estrellas o más"
    },
    "buttons": {
      "applySearch": "Aplicar Búsqueda",
      "clearData": "Limpiar Datos",
      "searching": "Buscando..."
    },
    "help": {
      "buttonText": "Ayuda",
      "tooltip": "Guía de Búsqueda Avanzada",
      "step1": "Dirigirse a la barra de búsqueda y llenar en el campo el servicio que necesita buscar de manera personalizada.",
      "step2": "Según el texto ingresado, puede buscar solo en el título de la oferta de trabajo o por palabra exacta en el título y la descripción.",
      "step3": "Seleccionar el filtrado de nombre de fixer de acuerdo a lo que se requiera.",
      "step4": "Seleccionar la ciudad de interés para filtrar los resultados.",
      "step5": "Seleccionar el tipo de trabajo. Ejemplo: si selecciona \"Pintor\", se mostrarán resultados de pintores.",
      "step6": "Hacer click en el componente de precio y seleccionar el rango deseado.",
      "step7": "En la sección de tipo de trabajo, seleccionar y de acuerdo a su elección se mostrarán las respectivas etiquetas.",
      "step8": "Seleccionar fecha de publicación: más recientes, más antiguos o fecha específica mediante el calendario.",
      "step9": "Seleccionar rango de calificación (1-5 estrellas). Al hacer click en una estrella muestra subrangos (1-9).",
      "step10": "Hacer click en \"Aplicar búsqueda\" para mostrar resultados con todos los filtros seleccionados.",
      "step11": "Usar el botón \"Limpiar datos\" para borrar todos los filtros y volver al estado inicial.",
      "step12": "Puedes salir de la búsqueda avanzada en cualquier momento presionando la tecla \"ESC\"."
    }
  },
  "resultsAdvSearch": {
    "pageTitle": "Resultados de Búsqueda Avanzada",
    "noResults": "No se encontraron resultados",
    "loading": "Cargando resultados...",
    "loadingFallback": "Cargando resultados..."
  },
  "cardJob": {
    "imageAlt": "Imagen {current} de {total}",
    "fixerPhotoAlt": "Foto de perfil de {name}",
    "fixerDefaultAlt": "Foto de perfil del usuario",
    "prevImage": "Imagen anterior",
    "nextImage": "Imagen siguiente",
    "contactWhatsApp": "Contactar por WhatsApp",
    "searchResults": "Resultados de la búsqueda",
    "noResults": "No se encontraron resultados",
    "defaultUserName": "Usuario"
  },
  "calendar": {
    "months": {
      "january": "enero",
      "february": "febrero",
      "march": "marzo",
      "april": "abril",
      "may": "mayo",
      "june": "junio",
      "july": "julio",
      "august": "agosto",
      "september": "septiembre",
      "october": "octubre",
      "november": "noviembre",
      "december": "diciembre"
    },
    "daysShort": {
      "monday": "L",
      "tuesday": "M",
      "wednesday": "X",
      "thursday": "J",
      "friday": "V",
      "saturday": "S",
      "sunday": "D"
    },
    "daysAbbrev": {
      "sunday": "dom.",
      "monday": "lun.",
      "tuesday": "mar.",
      "wednesday": "mié.",
      "thursday": "jue.",
      "friday": "vie.",
      "saturday": "sáb."
    },
    "navigation": {
      "previousMonth": "Mes anterior",
      "nextMonth": "Mes siguiente",
      "of": "de"
    },
    "buttons": {
      "cancel": "Cancelar",
      "accept": "Aceptar"
    }
  },
  "filtersPanel": {
    "filters": "Filtros",
    "resetButton": {
      "desktop": "Resetear",
      "mobile": "Resetear Filtros"
    },
    "fixerName": "Nombre de Fixer",
    "city": "Ciudad",
    "jobCategory": "Tipo de Trabajo"
  },
  "pagination": {
    "show": "Mostrar:",
    "perPage": "por página",
    "previous": "Anterior",
    "next": "Siguiente",
    "showingResults": "Mostrando {start} - {end} de {total} resultados",
    "page": "Página"
  },
  "sortBy": {
    "featured": "Destacados",
    "mostRecent": "Los más recientes",
    "oldest": "Los más antiguos",
    "nameAZ": "Nombre A-Z",
    "nameZA": "Nombre Z-A",
    "contactAsc": "Num de contacto asc",
    "contactDesc": "Num de contacto desc"
  },
  "navigation": {
    "home": "Inicio",
    "jobOffers": "Ofertas de Trabajo",
    "login": "Iniciar Sesión",
    "register": "Regístrate",
    "logo": "LOGO"
  },
  "cta": {
    "footerTitle": "¿Listo para encontrar al profesional ideal?",
    "footerSubtitle": "Únete a miles de personas que ya encontraron al profesional perfecto para sus necesidades",
    "footerButton": "Registrarse gratis",
    "footerButtonView": "Ver servicios"
  },
  "HowItWorks": {
    "question": "¿Cómo funciona?",
    "questionResponse": "Encuentra y contrata al profesional ideal en simples pasos",
    "HowItWorksSearch": "Busca",
    "HowItWorksSearchDescription": "Encuentra el servicio que necesitas",
    "HowItWorksCompare": "Compara",
    "HowItWorksCompareDescription": "Revisa perfiles y calificaciones",
    "HowItWorksContact": "Contacta",
    "HowItWorksContactDescription": "Habla directamente con los profesionales",
    "HowItWorksRate": "Califica",
    "HowItWorksRateDescription": "Comparte tu experiencia"
  },
  "Inspiration": {
    "insTitle": "Inspiración para tu hogar",
    "insDescription": "Descubre ideas y proyectos realizados por nuestros profesionales expertos"
  },
  "Map": {
    "mapTitle": "Encuentra servicios cerca de ti",
    "mapDescription": "Explora los profesionales disponibles en tu zona",
    "mapInteractive": "Mapa interactivo aqui"
  },
  "RecentOffer": {
    "recOfTitle": "Ofertas Recientes",
    "recOfDescription": "Descubre las últimas ofertas publicadas",
    "viewAll": "Ver todas",
    "filterByCategory": "Filtrar por categoría",
    "noOffersAvailable": "No hay ofertas disponibles",
    "noOffersCategory": "No se encontraron ofertas para esta categoría",
    "closeModal": "Cerrar"
  },
  "Services": {
    "serTitle": "Nuestros Servicios",
    "serDescription": "Encuentra el servicio perfecto para tus necesidades",
    "name services": "Plomería",
    "Description": "Reparaciones e instalaciones de fontanería"
  },
  "becomeFixer": {
    "title": "Conviértete en un Fixer",
    "description": "Completa tu registro y habilita tu cuenta como FIXER",
    "InputData": "Datos iniciales",
    "button1": "Continuar",
    "completeName": "Nombre completo",
    "eMail": "Correo Electrónico",
    "phone": "Teléfono",
    "digits": "dígitos",
    "fields": {
      "name": {
        "label": "Nombre completo",
        "placeholder": "Ingrese su nombre completo"
      },
      "email": {
        "label": "Correo Electrónico",
        "placeholder": "correo@ejemplo.com"
      },
      "phone": {
        "label": "Teléfono",
        "placeholder": "+591 70123456"
      }
    },
    "buttons": {
      "submit": "Registrar",
      "submitting": "Registrando..."
    }
  },
  "myOffers": {
    "newOffer": "Nueva Oferta",
    "noOffers": {
      "title": "No tienes ofertas publicadas",
      "description": "Crea tu primera oferta de trabajo para que los clientes puedan encontrarte y contactarte",
      "createFirst": "Crear Primera Oferta"
    },
    "actions": {
      "edit": "Editar",
      "delete": "Eliminar",
      "saveChanges": "Guardar Cambios",
      "publishOffer": "Publicar Oferta"
    },
    "notifications": {
      "offerDeleted": {
        "title": "Oferta eliminada",
        "message": "La oferta se eliminó correctamente"
      },
      "offerUpdated": {
        "title": "Oferta actualizada",
        "message": "La oferta se actualizó correctamente"
      },
      "offerCreated": {
        "title": "Oferta creada",
        "message": "La oferta se creó correctamente"
      },
      "error": {
        "title": "Error",
        "deleteMessage": "No se pudo eliminar la oferta. Por favor, intenta de nuevo.",
        "formMessage": "Hubo un error al procesar el formulario. Por favor, intenta de nuevo."
      }
    },
    "confirmDelete": {
      "title": "¿Eliminar oferta?",
      "message": "Esta acción no se puede deshacer. ¿Estás seguro de que quieres eliminar esta oferta?",
      "confirm": "Eliminar",
      "cancel": "Cancelar"
    }
  },
  "fixerProfile": {
    "tabs": {
      "home": "Inicio",
      "services": "Servicios",
      "reviews": "Reseñas",
      "gallery": "Galería"
    },
    "actions": {
      "contact": "Contactar",
      "writeReview": "Escribir reseña",
      "viewAll": "Ver todos"
    },
    "about": {
      "title": "Acerca de",
      "noDescription": "Este profesional aún no ha agregado una descripción.",
      "experience": "Experiencia",
      "years": "años",
      "completedJobs": "trabajos realizados"
    },
    "services": {
      "title": "Servicios",
      "myServices": "Mis Servicios",
      "description": "Servicio profesional especializado en"
    },
    "recentJobs": {
      "title": "Trabajos Recientes"
    },
    "reviews": {
      "title": "Reseñas",
      "new": "Nuevo",
      "satisfied": "Cliente Satisfecho",
      "ago": "Hace",
      "week": "semana",
      "weeks": "semanas",
      "sampleReview": "Excelente servicio, muy profesional y puntual. El trabajo quedó impecable."
    },
    "gallery": {
      "title": "Galería de Trabajos",
      "noPhotos": {
        "title": "Aún no hay fotos",
        "description": "Este profesional aún no ha compartido fotos de sus trabajos."
      },
      "workLabel": "Trabajo"
    },
    "profile": {
      "edit": "Editar perfil",
      "title2": "Estadisticas de trabajo",
      "save": "Guardar",
      "contactWhatsApp": "Contactar por WhatsApp",
      "completedJobs": "trabajos realizados",
      "new": "Nuevo",
      "aboutMe": {
        "title": "Acerca de mí",
        "placeholder": "Cuéntanos sobre ti y tus servicios...",
        "noDescription": "Este profesional aún no ha agregado una descripción."
      },
      "contactInfo": {
        "title": "Información de contacto",
        "phonePlaceholder": "Número de teléfono",
        "whatsappPlaceholder": "WhatsApp (opcional)"
      },
      "myServices": {
        "title": "Mis Servicios",
        "manage": "Gestionar",
        "noServices": "Aún no se han agregado servicios"
      },
      "paymentMethods": {
        "title": "Métodos de pago"
      }
    }
  },
  "statistics": {
    "jobs": {
      "title": "Estadísticas de trabajos",
      "loading": "Cargando estadísticas...",
      "error": "Error al cargar datos o datos no disponibles.",
      "noLogs": "No se encontraron logs de estado de trabajos.",
      "status": {
        "completed": "Completados",
        "inProgress": "En proceso",
        "pending": "Pendientes"
      },
      "jobs": "trabajos",
      "total": "Total"
    }
  },
  "jobOfferModal": {
    "closeModal": "Cerrar modal",
    "noImage": "Sin imagen disponible",
    "description": "Descripción",
    "servicesOffered": "Servicios Ofrecidos",
    "gallery": "Galería de Trabajos",
    "photo": "Foto",
    "contactInfo": "Información de Contacto",
    "whatsapp": "WhatsApp",
    "city": "Ciudad",
    "contactButton": "Contactar por WhatsApp",
    "contactWhatsApp": "Contactar por WhatsApp",
    "scheduleAppointment": "Agendar Cita",
    "share": "Compartir"
  },
  "navbar": {
    "logo": "Logo",
    "jobOffers": "Ofertas de Trabajo",
    "becomeFixer": "Convertirse en Fixer",
    "myOffers": "Mis Ofertas",
    "a": "fixers por trabajo"
  },
  "Mock_Fixer": {
    "role": "Plomero Profesional",
    "about": "Especialista en plomería residencial y comercial con más de 10 años de experiencia. Garantizo un trabajo limpio y duradero.",
    "reviews": "124 reseñas",
    "featuredOffers": "Ofertas Destacadas",
    "tabs": {
      "summary": "Resumen",
      "offers": "Ofertas",
      "experience": "Experiencia",
      "certifications": "Certificaciones",
      "portfolio": "Portafolio",
      "statistics": "Estadísticas"
    }
  },
  "Login": {
    "title": "Iniciar sesión",
    "mode": "Modo solicitante",
    "separator": "o",
    "form": {
      "email": {
        "label": "Email",
        "placeholder": "Ingrese su correo electrónico"
      },
      "password": {
        "label": "Contraseña",
        "placeholder": "Ingrese su contraseña"
      }
    },
    "links": {
      "forgotPassword": "¿Olvidó su contraseña?",
      "noAccount": "¿No tiene una cuenta?",
      "register": "Regístrate"
    },
    "buttons": {
      "login": "Iniciar Sesión",
      "loading": "Iniciando sesión..."
    },
    "aria": {
      "showPassword": "Mostrar contraseña",
      "hidePassword": "Ocultar contraseña"
    },
    "errors": {
      "invalidEmail": "Por favor ingrese un correo electrónico válido",
      "passwordMinLength": "La contraseña debe tener al menos 6 caracteres",
      "invalidCredentials": "Credenciales inválidas o error del servidor",
      "loginError": "Error de inicio de sesión",
      "connectionError": "No se pudo conectar al servidor",
      "connectionErrorTitle": "Error de conexión",
      "googleError": "Error de Google"
    },
    "success": {
      "title": "Inicio de sesión exitoso",
      "welcome": "¡Bienvenido, {name}!"
    }
  },
  "SignUp": {
    "title": "Crear cuenta",
    "subtitle": "Únete a nuestra comunidad",
    "form": {
      "name": {
        "label": "Nombre completo",
        "placeholder": "Ingrese su nombre completo"
      },
      "email": {
        "label": "Correo electrónico",
        "placeholder": "Ingrese su correo"
      },
      "password": {
        "label": "Contraseña",
        "placeholder": "Ingrese su contraseña"
      },
      "confirmPassword": {
        "label": "Confirmar contraseña",
        "placeholder": "Confirme su contraseña"
      },
      "terms": {
        "text": "Acepto los",
        "link": "términos y condiciones"
      }
    },
    "buttons": {
      "register": "Crear cuenta",
      "loading": "Creando cuenta..."
    },
    "links": {
      "haveAccount": "¿Ya tienes una cuenta?",
      "login": "Iniciar sesión"
    },
    "errors": {
      "nameMinLength": "El nombre debe tener al menos 2 caracteres",
      "invalidEmail": "Debe ingresar un correo válido",
      "passwordMinLength": "La contraseña debe tener al menos 6 caracteres",
      "passwordsMatch": "Las contraseñas no coinciden",
      "termsRequired": "Debes aceptar los términos y condiciones",
      "registrationError": "Error en el registro",
      "connectionError": "No se pudo conectar con el servidor"
    },
    "success": {
      "title": "Registro exitoso",
      "message": "Tu cuenta ha sido creada exitosamente"
    }
  },
  "Calendar": {
    "fixer": "Fixer",
    "viewCalendar": "Ver Calendario",
    "profileInfo": "Información de Perfil",
    "previousExperience": "Experiencia Previa",
    "experienceDescription": "Información sobre experiencias y trabajos anteriores...",
    "reviews": "Reseñas",
    "reviewsDescription": "Reseñas y comentarios de clientes..."
  },
  "AdvSearch": {
    "pageTitle": "Resultados de Búsqueda",
    "noResults": "No se encontraron resultados",
    "loading": "Cargando...",
    "loadingFallback": "Cargando resultados de búsqueda..."
  },
  "VincularCorreo": {
    "title": "Correo y contraseña",
    "subtitle": "Vincula tu cuenta con credenciales",
    "form": {
      "email": {
        "placeholder": "Correo electrónico"
      },
      "password": {
        "placeholder": "Contraseña"
      },
      "repeatPassword": {
        "placeholder": "Repetir contraseña"
      }
    },
    "buttons": {
      "link": "Vincular",
      "cancel": "Cancelar",
      "confirm": "Confirmar Vinculación",
      "linking": "Vinculando..."
    },
    "errors": {
      "invalidEmail": "Debe ser un correo electrónico válido.",
      "passwordMinLength": "La contraseña debe tener al menos 8 caracteres.",
      "passwordUppercase": "Debe contener al menos una letra mayúscula.",
      "passwordLowercase": "Debe contener al menos una letra minúscula.",
      "passwordNumber": "Debe contener al menos un número.",
      "passwordSymbol": "Debe contener al menos un símbolo.",
      "passwordsMatch": "Las contraseñas no coinciden."
    },
    "toasts": {
      "formErrors": "Por favor, corrige los errores del formulario."
    },
    "success": {
      "message": "Vinculación exitosa."
    }
  },
  "VincularDiscord": {
    "title": "Discord",
    "subtitle": "Vincula tu cuenta de Discord",
    "buttons": {
      "link": "Vincular",
      "linking": "Vinculando..."
    }
  },
  "VincularGithub": {
    "title": "GitHub",
    "subtitle": "Vincula tu cuenta de GitHub",
    "buttons": {
      "link": "Vincular",
      "linking": "Vinculando..."
    },
    "errors": {
      "noSession": "No hay sesión activa para vincular cuenta"
    },
    "success": {
      "message": "Cuenta de GitHub vinculada con éxito"
    }
  },
  "VincularGoogle": {
    "title": "Google",
    "subtitle": "Vincula tu cuenta de Google",
    "buttons": {
      "link": "Vincular",
      "linking": "Vinculando..."
    },
    "errors": {
      "emptyToken": "Token de Google vacío",
      "noSession": "No hay sesión activa para vincular cuenta",
      "loginError": "Error al iniciar sesión con Google"
    }
  },
  "AccountLoginSettings": {
    "title": "Configuración de Cuentas Vinculadas",
    "linkedAccounts": {
      "title": "Cuentas Vinculadas ({count})"
    },
    "availableMethods": {
      "title": "Métodos Disponibles ({count})",
      "allLinked": "Todos los métodos están actualmente vinculados."
    },
    "status": {
      "active": "Activo"
    },
    "buttons": {
      "unlink": "Desvincular"
    },
    "confirmUnlink": "¿Desvincular {provider}?",
    "errors": {
      "loadMethods": "Error al cargar métodos",
      "minimumMethods": "Debes tener al menos un método activo.",
      "linkError": "Error al vincular el método {provider}: {error}",
      "unlinkError": "Error al desvincular método {provider}: {error}",
      "unknown": "Desconocido"
    }
  },
  "ConfiguracionPage": {
    "title": "Configuración",
    "loading": {
      "profile": "Cargando datos del perfil..."
    },
    "errors": {
      "loadTitle": "Error de Carga",
      "loadMessage": "No se pudo cargar el perfil: {error}",
      "loadProfile": "Error al cargar los datos del perfil."
    },
    "buttons": {
      "retry": "Reintentar Carga"
    },
    "sections": {
      "editProfile": "Editar Perfil",
      "changePassword": "Cambiar Contraseña",
      "security": "Seguridad"
    },
    "security": {
      "description": "Opciones y recomendaciones que te ayudan a proteger tu cuenta",
      "changePassword": "Cambiar contraseña",
      "linkedDevices": "Dispositivos vinculados"
    },
    "welcome": {
      "profilePhoto": "Foto de perfil",
      "title": "Te damos la bienvenida, {name}",
      "defaultName": "Usuario",
      "description": "Gestiona tu información, privacidad y seguridad para mejorar tu experiencia en Servineo.",
      "loginRequired": "Inicia sesión para ver tus configuraciones."
    },
    "navigation": {
      "editProfile": "Editar Perfil",
      "security": "Seguridad",
      "linkedAccounts": "Cuentas vinculadas"
    }
  },
  "RegistroGoogle": {
    "errors": {
      "noToken": {
        "title": "Token no recibido",
        "message": "No se recibió el token de Google."
      },
      "authError": {
        "title": "Error",
        "defaultMessage": "Error al autenticar con Google."
      },
      "connection": {
        "title": "Error de conexión",
        "defaultMessage": "No se pudo conectar con el servidor. Intenta nuevamente."
      }
    },
    "welcome": {
      "title": "Bienvenido",
      "message": "Primera vez en Servineo. Completa tu perfil para continuar."
    },
    "success": {
      "loginTitle": "Inicio de sesión exitoso",
      "loginMessage": "Bienvenido nuevamente, {name}",
      "defaultName": "usuario"
    }
  },
  "CalendarPage": {
    "closeButton": "Cerrar",
    "titles": {
      "myCalendar": "Mi Calendario",
      "fixerCalendar": "Calendario de {fixerName}"
    },
    "buttons": {
      "modifyAvailability": "Modificar Disponibilidad",
      "cancelAppointments": "Cancelar Citas"
    }
  },
  "CloseSessionPage": {
    "backButton": "Volver",
    "title": "Gestión de Sesiones",
    "description": "Administra tus dispositivos conectados y cierra sesiones en otros dispositivos para mantener tu cuenta segura.",
    "loading": "Cargando dispositivos...",
    "important": "Importante",
    "warnings": {
      "deviceLimit": "Has alcanzado el límite de 3 dispositivos conectados.",
      "closeSessionsWarning": "Al cerrar sesiones, se desconectarán todos los dispositivos excepto el actual. Deberás volver a iniciar sesión en los demás dispositivos."
    },
    "stats": {
      "activeSessions": "Sesiones activas",
      "otherDevices": "Otros dispositivos",
      "currentDevice": "Dispositivo actual"
    },
    "buttons": {
      "closeOtherSessions": "Cerrar sesiones en otros dispositivos",
      "closingSessions": "Cerrando sesiones..."
    },
    "noOtherSessions": "No hay otras sesiones activas. Solo este dispositivo está conectado.",
    "activeSessions": {
      "title": "Sesiones Activas ({count})",
      "noDevices": "No hay dispositivos conectados.",
      "thisDevice": "Este dispositivo"
    },
    "confirmation": {
      "title": "¿Cerrar sesiones?",
      "message": "Esta acción cerrará todas las sesiones activas en otros dispositivos ({count} {sessions}).",
      "sessionSingular": "sesión",
      "sessionPlural": "sesiones",
      "cancel": "Cancelar",
      "closing": "Cerrando...",
      "confirm": "Sí, cerrar sesiones"
    }
  },
  "SignUpRegister": {
    "title": "Regístrate",
    "mode": "Modo requester",
    "separator": "o continúa con",
    "terms": {
      "text": "Al registrarte aceptas los",
      "link": "términos de uso"
    },
    "login": {
      "text": "¿Ya tienes cuenta?",
      "link": "Inicia sesión"
    }
  },
  "CertificationsSection": {
    "optional": "opcional",
    "titles": {
      "certifications": "Certificaciones",
      "myCertifications": "Mis Certificaciones"
    },
    "buttons": {
      "addCertification": "Agregar Certificación",
      "cancel": "Cancelar",
      "save": "Guardar",
      "saving": "Guardando...",
      "delete": "Eliminar"
    },
    "card": {
      "issued": "Emitido",
      "expires": "Vence",
      "viewCredential": "Ver credencial"
    },
    "tooltips": {
      "edit": "Editar",
      "delete": "Eliminar"
    },
    "modal": {
      "editTitle": "Editar Certificación",
      "newTitle": "Nueva Certificación"
    },
    "form": {
      "name": {
        "label": "Nombre de la Certificación",
        "placeholder": "Ej: Técnico Electricista",
        "required": "El nombre es requerido"
      },
      "institution": {
        "label": "Institución Emisora",
        "placeholder": "Ej: INFOCAL",
        "required": "La institución es requerida"
      },
      "issueDate": {
        "label": "Fecha de Emisión"
      },
      "expiryDate": {
        "label": "Fecha de Vencimiento"
      },
      "credentialId": {
        "label": "ID de la Credencial",
        "placeholder": "Opcional",
        "label2": "URL de la credencial"
      },
      "credentialUrl": {
        "label": "URL Credencial",
        "placeholder": "https://..."
      }
    },
    "empty": "Sin certificaciones agregadas aún",
    "loading": "Cargando certificaciones...",
    "errors": {
      "noFixerProfile": "Perfil de técnico no encontrado",
      "saveError": "Error al guardar certificación",
      "deleteError": "Error al eliminar certificación",
      "loadError": "Error al cargar certificaciones"
    },
    "notifications": {
      "success": "Éxito",
      "error": "Error",
      "createSuccess": "Certificación agregada exitosamente",
      "updateSuccess": "Certificación actualizada exitosamente",
      "deleteTitle": "Eliminar Certificación",
      "deleteMessage": "¿Estás seguro de que deseas eliminar esta certificación?",
      "deleteSuccessTitle": "Eliminada",
      "deleteSuccess": "Certificación eliminada exitosamente"
    },
    "deleteConfirmation": "¿Estás seguro de eliminar esta certificación?"
  },
  "ExperienceSection": {
    "titles": {
      "experience": "Experiencia Laboral",
      "myExperience": "Mi Experiencia Laboral"
    },
    "buttons": {
      "addCertification": "Agregar Certificación",
      "cancel": "Cancelar",
      "save": "Guardar",
      "saving": "Guardando...",
      "delete": "Eliminar",
      "addExperience": "Add Experience"  
    },
    "card": {
      "present": "Presente"
    },
    "tooltips": {
      "edit": "Editar",
      "delete": "Eliminar"
    },
    "modal": {
      "editTitle": "Editar Experiencia",
      "newTitle": "Nueva Experiencia"
    },
    "form": {
      "optional": "(opcional)",
      "jobTitle": {
        "label": "Cargo / Título",
        "placeholder": "Ej: Plomero Senior",
        "required": "El cargo es requerido"
      },
      "organization": {
        "label": "Empresa / Organización",
        "placeholder": "Ej: Servicios Generales S.A.",
        "required": "La empresa es requerida"
      },
      "jobType": {
        "label": "Tipo de Empleo",
        "select": "Selecciona una opción...",
        "required": "El tipo de empleo es requerido",
        "options": {
          "fullTime": "Tiempo completo",
          "partTime": "Medio tiempo",
          "contract": "Contrato",
          "freelance": "Freelance"
        }
      },
      "startDate": {
        "label": "Fecha de Inicio",
        "required": "La fecha de inicio es requerida"
      },
      "endDate": {
        "label": "Fecha de Fin"
      },
      "isCurrent": {
        "label": "Actualmente trabajo aquí"
      }
    },
    "loading": "Cargando experiencias...",
    "errors": {
      "loadError": "Error al cargar experiencias"
    },
    "empty": {
      "readOnly": "Sin experiencia laboral agregada aún",
      "editable": "Sin experiencia laboral. ¡Comienza agregando tu primer puesto!"
    },
    "notifications": {
      "success": "Éxito",
      "error": "Error",
      "createSuccess": "Experiencia agregada exitosamente",
      "updateSuccess": "Experiencia actualizada exitosamente",
      "deleteTitle": "Eliminar Experiencia",
      "deleteMessage": "¿Estás seguro de que deseas eliminar esta experiencia?",
      "deleteSuccessTitle": "Eliminada",
      "deleteSuccess": "Experiencia eliminada exitosamente",
      "genericError": "Ocurrió un error. Por favor intenta de nuevo."
    },
    "deleteConfirmation": "¿Estás seguro de eliminar esta experiencia?"
  },
    "JobOffersSection": {
    "titles": {
      "jobOffers": "Ofertas de Trabajo",
      "myJobOffers": "Mis Ofertas de Trabajo"
    },
    "buttons": {
      "newOffer": "Nueva Oferta",
      "cancel": "Cancelar",
      "save": "Guardar",
      "saving": "Guardando..."
    },
    "card": {
      "defaultTitle": "Sin título",
      "defaultCategory": "General"
    },
    "modal": {
      "editTitle": "Editar Oferta",
      "newTitle": "Nueva Oferta"
    },
    "form": {
      "defaultCity": "Cochabamba",
      "title": {
        "label": "Título",
        "placeholder": "Ingresa el título de la oferta"
      },
      "category": {
        "label": "Categoría",
        "select": "Seleccionar...",
        "required": "Selecciona una categoría",
        "options": {
          "plumbing": "Plomería",
          "electricity": "Electricidad",
          "carpentry": "Carpintería",
          "painting": "Pintura"
        }
      },
      "tags": {
        "label": "Etiquetas (máximo 5)",
        "empty": "Sin etiquetas seleccionadas",
        "addTag": "Agregar Etiqueta",
        "limitReached": "Máximo de etiquetas alcanzado (5)",
        "alreadyAdded": " (ya agregada)"
      },
      "description": {
        "label": "Descripción",
        "placeholder": "Describe tu servicio...",
        "required": "La descripción es requerida"
      },
      "price": {
        "label": "Precio (Bs.)"
      },
      "city": {
        "label": "Ciudad"
      },
      "contactPhone": {
        "label": "Teléfono de Contacto"
      },
      "images": {
        "label": "Imágenes"
      }
    },
    "loading": "Cargando ofertas...",
    "empty": "No hay ofertas publicadas aún.",
    "notifications": {
      "noUser": "No se identificó al usuario.",
      "noImages": "Debes subir al menos una foto.",
      "imageLimit": "Límite excedido",
      "imageLimitMessage": "Solo puedes subir hasta 5 imágenes.",
      "imageTooBig": "Imagen muy pesada",
      "imageSizeMessage": "La imagen {fileName} excede 5MB.",
      "updated": "Actualizado",
      "updateSuccess": "Oferta actualizada correctamente.",
      "published": "Publicado",
      "createSuccess": "Oferta creada correctamente.",
      "error": "Error",
      "errorMessage": "Error al procesar la solicitud.",
      "deleteTitle": "¿Eliminar oferta?",
      "deleteMessage": "Esta acción no se puede deshacer.",
      "deleted": "Eliminado",
      "deleteSuccess": "Oferta eliminada.",
      "deleteError": "No se pudo eliminar la oferta."
    },
    "confirmButton": "Confirmar",
    "deleteConfirmation": "¿Estás seguro de eliminar esta oferta?"
  },
  "PortfolioSection": {
    "titles": {
      "portfolio": "Portafolio",
      "myPortfolio": "Mi Portafolio"
    },
    "buttons": {
      "video": "Video",
      "image": "Imagen",
      "cancel": "Cancelar",
      "save": "Guardar"
    },
    "image": {
      "alt": "Elemento del portafolio",
      "placeholder": "https://placehold.co/300x300?text=Sin+Imagen"
    },
    "tooltips": {
      "delete": "Eliminar"
    },
    "modal": {
      "addImage": "Agregar Imagen",
      "addVideo": "Agregar Video"
    },
    "form": {
      "imageUrl": {
        "label": "URL de la Imagen",
        "placeholder": "https://...",
        "required": "La URL es requerida"
      },
      "youtubeUrl": {
        "label": "URL de YouTube",
        "placeholder": "https://www.youtube.com/watch?v=...",
        "required": "La URL es requerida"
      },
      "thumbnailUrl": {
        "label": "URL de Miniatura (Opcional)",
        "placeholder": "Se intentará extraer automáticamente"
      }
    },
    "deleteConfirmation": "¿Estás seguro de eliminar este elemento?",
    "emptyState": "portfolio vacio"
  },
  "RegistroForm": {
    "fields": {
      "nombre": {
        "label": "Nombre",
        "placeholder": "Ingresa tu nombre"
      },
      "apellido": {
        "label": "Apellido",
        "placeholder": "Ingresa tu apellido"
      },
      "email": {
        "label": "Correo electrónico",
        "placeholder": "nombre@dominio.com"
      },
      "password": {
        "label": "Contraseña",
        "placeholder": "Ingresa tu contraseña"
      },
      "confirmarPassword": {
        "label": "Confirmar contraseña",
        "placeholder": "Confirma tu contraseña"
      }
    },
    "validation": {
      "nombre": {
        "min": "El nombre debe tener al menos 3 caracteres",
        "max": "El nombre no puede tener más de 50 caracteres",
        "regex": "Solo se permiten letras y espacios"
      },
      "apellido": {
        "min": "El apellido debe tener al menos 3 caracteres",
        "max": "El apellido no puede tener más de 50 caracteres",
        "regex": "Solo se permiten letras y espacios"
      },
      "email": {
        "invalid": "Correo electrónico inválido"
      },
      "password": {
        "min": "Debe tener al menos 8 caracteres"
      },
      "confirmarPassword": {
        "match": "Las contraseñas no coinciden"
      }
    },
    "buttons": {
      "generatePassword": "Generar contraseña segura",
      "submit": "Únete",
      "submitting": "Registrando..."
    },
    "aria": {
      "showPassword": "Mostrar contraseña",
      "hidePassword": "Ocultar contraseña"
    },
    "tooltips": {
      "passwordCopy": "Se copiará automáticamente al portapapeles"
    },
    "notifications": {
      "passwordGenerated": {
        "title": "Contraseña generada",
        "message": "La contraseña segura ha sido generada y copiada al portapapeles."
      },
      "validationError": {
        "title": "Datos incompletos o incorrectos",
        "message": "Revisa los campos marcados para continuar."
      },
      "success": {
        "title": "Registro exitoso",
        "message": "Bienvenido, {name}. Tu cuenta ha sido creada correctamente.",
        "toast": "¡Cuenta creada exitosamente! Bienvenido, {name}."
      },
      "error": {
        "title": "Error en el registro",
        "message": "No fue posible completar el registro."
      }
    }
  },
  "TerminosPage": {
    "title": "Términos y Condiciones de Uso de Servero",
    "section1": {
      "title": "1. ACEPTACIÓN DE TÉRMINOS",
      "content": "Al acceder y utilizar la aplicación Servero, el usuario acepta cumplir con los presentes Términos y Condiciones. Si no está de acuerdo con ellos, deberá abstenerse de usar la plataforma."
    },
    "section2": {
      "title": "2. USO DEL SERVICIO",
      "content1": "Servineo es una plataforma digital que conecta a usuarios con proveedores independientes de servicios (ejemplo: electricistas, plomeros, albañiles, pintores, entre otros). El usuario reconoce que Servero no presta directamente los servicios, sino que actúa únicamente como intermediario digital.",
      "content2": "Cada usuario es responsable de la veracidad de la información que proporciona. Queda prohibido usar la plataforma para fines ilícitos, fraudulentos o contrarios al orden público."
    },
    "section3": {
      "title": "3. PRIVACIDAD",
      "content": "La información personal proporcionada por el usuario será tratada conforme a la Política de Privacidad de Servero. Los datos serán utilizados únicamente para el funcionamiento de la aplicación, la gestión de cuentas y la conexión entre requesters y fixers. Servero se compromete a proteger la información del usuario, pero no se responsabiliza por accesos no autorizados derivados de negligencia del propio usuario (ejemplo: compartir contraseñas)."
    },
    "section4": {
      "title": "4. PROPIEDAD INTELECTUAL",
      "content": "Todos los derechos sobre el nombre Servero, logotipos, diseño, interfaz y contenidos de la aplicación pertenecen a los titulares de Servero. El usuario no podrá copiar, modificar, distribuir ni usar con fines comerciales ningún elemento de la plataforma sin autorización expresa."
    },
    "section5": {
      "title": "5. LIMITACIÓN DE RESPONSABILIDAD",
      "content": "Servineo no garantiza la calidad, cumplimiento o idoneidad de los servicios ofrecidos por los proveedores registrados en la plataforma. La responsabilidad por la ejecución de los trabajos recae exclusivamente en los proveedores y los usuarios que los contraten. Servero no se hace responsable por daños, pérdidas o conflictos que puedan surgir entre usuarios y proveedores."
    },
    "section6": {
      "title": "6. TERMINACIÓN",
      "content": "Servero se reserva el derecho de suspender o cancelar la cuenta de cualquier usuario que incumpla estos Términos y Condiciones o que haga un uso indebido de la aplicación."
    },
    "section7": {
      "title": "7. LEY APLICABLE",
      "content": "Estos Términos y Condiciones se rigen por las leyes vigentes en el Estado Plurinacional de Bolivia. En caso de controversia, las partes se someten a la jurisdicción de los tribunales competentes en dicho país."
    },
    "section8": {
      "title": "8. CONTACTO",
      "content": "Para consultas, reclamos o sugerencias, los usuarios pueden comunicarse con el equipo de Servero a través del correo electrónico:"
    }
  },
  "TopMenu": {
    "nav": {
      "home": "Inicio",
      "jobOffers": "Ofertas de trabajo",
      "help": "Ayuda"
    },
    "buttons": {
      "login": "Iniciar Sesión",
      "register": "Regístrate",
      "myAccount": "Mi cuenta",
      "becomeFixer": "Convertir a Fixer",
      "fixerProfile": "Perfil de Fixer"
    },
    "dropdown": {
      "editProfile": "Editar perfil",
      "logout": "Cerrar sesión"
    }
  },
  "helpCenter": {
    "title": "Centro de Ayuda",
    "subtitle": "Encuentra respuestas rápidas, guías y participa en la comunidad para resolver tus dudas sobre Servineo.",
    "search": {
      "placeholder": "Buscar ayuda en Servineo...",
      "button": "Ejecutar búsqueda"
    },
    "messages": {
      "emptySearch": "Por favor, ingresa un término de búsqueda.",
      "searching": "Búsqueda simulada para: \"{query}\".",
      "noResults": "No se encontraron resultados para \"{query}\".",
      "navigating": "Simulando navegación a: {url}",
      "noCategories": "No se encontraron categorías que coincidan con \"{query}\"."
    },
    "suggestions": {
      "paymentProblems": "Problemas con mi pago",
      "paymentMethods": "Métodos de pago aceptados",
      "resetPassword": "Restablecer contraseña",
      "billing": "Información de facturación",
      "support": "Contacto de soporte"
    },
    "sections": {
      "faq": {
        "title": "Preguntas Frecuentes (FAQ)",
        "description": "Respuestas rápidas a las dudas comunes."
      },
      "forum": {
        "title": "Foro de Usuarios",
        "description": "Comparte tus dudas y ayuda a otros usuarios"
      }
    },
    "results": {
      "title": "Resultados para \"{query}\"",
      "empty": "No se encontraron resultados."
    }
  },
  "faq": {
    "title": "Preguntas Frecuentes",
    "subtitle": "Encuentra respuestas rápidas a las dudas más comunes sobre Servineo",
    "backButton": "Volver atrás"
  },
  "tracking": {
    "title": "Tracking de Citas",
    "subtitle": "Monitoreo de actividad y cobertura geográfica",
    "filters": {
      "from": "Desde",
      "to": "Hasta"
    },
    "map": {
      "loading": "Cargando Mapa...",
      "loadingData": "Cargando datos...",
      "noAppointments": "No hay citas geolocalizadas",
      "unknown": "Desconocido",
      "client": "Cliente"
    },
    "metrics": {
      "total": "Total Citas",
      "scheduled": "Citas Agendadas",
      "cancelled": "Citas Canceladas"
    }
  },
  "dashboard": {
    "loading": "Cargando estadísticas...",
    "error": "Error al cargar las estadísticas",
    "periods": {
      "weekly": "Semanal",
      "monthly": "Mensual",
      "yearly": "Anual"
    },
    "periodLabel": "Período",
    "totalSearches": "Total de búsquedas",
    "noData": "No hay datos disponibles para el período seleccionado",
    "charts": {
      "userDistribution": {
        "title": "Distribución de usuarios",
        "description": "Tipos de usuarios que realizaron búsquedas"
      },
      "fixerRanges": {
        "title": "Rangos de nombres de fixers",
        "description": "Búsquedas por rango de letras del nombre"
      },
      "cities": {
        "title": "Ciudades",
        "description": "Búsquedas por ciudad"
      },
      "jobTypes": {
        "title": "Tipos de trabajo",
        "description": "Búsquedas por tipo de trabajo"
      },
      "filterStats": "Estadísticas de este filtro",
      "showingTotal": "Mostrando búsquedas totales"
    }
  },
  "adminLogin": {
    "logo": "SERVINEO",
    "subtitle": "Admin Login",
    "welcome": "Bienvenido de nuevo, Admin",
    "form": {
      "emailLabel": "Correo electrónico",
      "emailPlaceholder": "admin@servineo.com",
      "passwordLabel": "Contraseña",
      "signInButton": "Iniciar sesión como Admin",
      "signingIn": "Iniciando sesión...",
      "or": "o",
      "googleButton": "Iniciar sesión con Google",
      "connecting": "Conectando..."
    },
    "errors": {
      "googleApiNotAvailable": "Google API no disponible",
      "googleClientIdNotConfigured": "Google Client ID no configurado",
      "googleLoginError": "Error con Google Login",
      "noCredential": "Error: No se recibió credencial de Google",
      "incorrectCredentials": "Credenciales incorrectas",
      "serverError": "Error del servidor"
    }
  },
  "footer": {
    "skipToMain": "Saltar al contenido principal",
    "description": "La plataforma líder para conectar hogares con profesionales calificados en Cochabamba. Calidad garantizada y servicio confiable.",
    "explore": {
      "title": "Exploremos SERVINEO",
      "services": "Servicios",
      "offerServices": "Ofrece tus servicios",
      "jobOffers": "Ofertas de trabajo"
    },
    "company": {
      "title": "Empresa",
      "aboutUs": "Sobre nosotros",
      "workWithUs": "Trabaja con nosotros",
      "testimonials": "Testimonios",
      "support": "Apoyo",
      "whyServineo": "¿Por qué Servineo?",
      "howItWorks": "Cómo funciona Servineo",
      "restartTour": "Ver guía nuevamente"
    },
    "legal": {
      "title": "Legal",
      "privacy": "Política de privacidad",
      "terms": "Acuerdos de usuario",
      "cookies": "Política de cookies"
    },
    "contact": {
      "title": "Contáctanos",
      "location": "Ubicación: Cochabamba, Bolivia"
    },
    "social": {
      "title": "Síguenos"
    },
    "copyright": "© 2024 Servineo. Todos los derechos reservados.",
    "madeWith": "Hecho con ❤️ en Cochabamba",
    "operational": "Sistema operativo",
    "ariaLabels": {
      "footer": "Pie de página de Servineo",
      "footerLinks": "Enlaces del pie de página",
      "viewLocation": "Ver ubicación en Google Maps: Cochabamba, Bolivia",
      "whatsapp": "Número de WhatsApp",
      "sendWhatsApp": "Enviar mensaje por WhatsApp al +591 75139742",
      "email": "Correo electrónico de contacto",
      "sendEmail": "Enviar correo electrónico a servineo.serviciostecnicos@gmail.com",
      "socialMedia": "Redes sociales de Servineo",
      "facebook": "Visitar Facebook de Servineo",
      "instagram": "Visitar Instagram de Servineo",
      "twitter": "Visitar X (antes Twitter) de Servineo",
      "copyright": "Créditos y derechos de autor"
    }
  },
  "home": {
    "mapSection": {
      "title": "Encuentra Servicios Cerca de Ti",
      "subtitle": "Explora los profesionales disponibles en tu zona"
    }
  },
  "HowUseServineoTitle": {
    "title": "Cómo funciona Servineo",
    "subtitle": "Estos son los pasos que debe seguir para\npoder usar nuestra plataforma facilmente",
    "guide":"¿Necesitas una experiancia mas inmersiva? prueba nuestra",
    "guideLink": "guia interactiva",
    "fingOut": "Descúbrelo"
  },
  "Pasos": {
    "title": "Sigue estos pasos para contratar",
    "subtitle": "Encuentra el fixer que tenga las habilidades que necesitas,\npuedes empezar con estos pasos",
    "step1": {
      "title": "Navega y busca",
      "description": "Explora nuestros servicios utilizando la barra de búsqueda, filtros por categorías y palabras claves para encontrar lo que buscas."
    },
    "step2": {
      "title": "Contacta",
      "description": "Comunícate con el fixer directamente mediante su número telefónico para poder saber más sobre el servicio o coordinar el trabajo."
    },
    "step3": {
      "title": "Coordina tu servicio",
      "description": "Coordina con tu fixer para que el servicio sea lo que tu busca y elige una oferta antes de enviar los datos necesitados por el fixer."
    },
    "step4": {
      "title": "Aprueba y contacta",
      "description": "Recibe el servicio y deja tus comentarios sobre la calidad del servicio."
    },
    "button": "Ver servicios"
  },
  "Consejos": {
    "title": "Consejos para un mejor uso",
    "subtitle": "Perfecciona tu uso sobre la plataforma,\naqui tenemos algunos consejos",
    "tip1": {
      "title": "Filtros",
      "description": "Aplica los filtros de búsqueda, palabras claves o consulta nuestro mapa si hay fixers cercanos a tu ubicación."
    },
    "tip2": {
      "title": "Calificaciones y reseñas",
      "description": "Consulta las calificaciones y opiniones de otras personas para saber mas sobre el desempeño de cierto fixer."
    },
    "tip3": {
      "title": "Comunicación",
      "description": "Comunícate con el fixer para tener más detalles del servicio y aclarar las dudas que tengas."
    }
  },
  "CategoriasPopulares": {
    "title": "Categorías Populares",
    "subtitle": "¿No sabes por donde comenzar?",
    "subtitle2": "Explora nuestras categorías más populares",
    "card1": {
      "name": "Plomería",
      "description": "Reparaciones e instalaciones de fontanería"
    },
    "card2": {
      "name": "Electricidad",
      "description": "Instalaciones y reparaciones eléctricas"
    }, 
    "card3": {
      "name": "Carpintería",
      "description": "Trabajos en madera y muebles"
    },
    "card4": {
      "name": "Limpieza",
      "description": "Servicios de limpieza profesional"
    },
    "card5": {
      "name": "Jardinería",
      "description": "Cuidado y mantenimiento de jardines"
    },
    "card6": {
      "name": "Pintura",
      "description": "Servicios de pintura residencial"
    },
    "card7": {
      "name": "Mudanzas",
      "description": "Servicios de mudanza y transporte"
    },
    "card8": {
      "name": "Tecnología",
      "description": "Reparación de equipos tecnológicos"
    },
    "demand": "de demanda",
    "button": "Ver profesionales",
    "button2": "Ver todas las categorias"
  },
  "Accordion": {
    "title": "Preguntas Frecuentes",
    "section1": {
      "question": "¿Cómo funciona Servineo?",
      "answer":"Servineo conecta hogares con profesionales calificados en Cochabamba. Publica tu necesidad, recibe cotizaciones de fixers verificados y elige al mejor para el trabajo."
    },
    "section2": {
      "question": "¿Qué tipos de servicios ofrecen?",
      "answer":"Ofrecemos plomería, electricidad, carpintería, pintura, limpieza, jardinería, soldadura, albañilería y muchos servicios más para el hogar."
    },
    "section3":{
      "question": "¿Cómo se verifican los fixers?",
      "answer": "Todos nuestros fixers pasan por un proceso de verificación que incluye revisión de documentos, entrevistas y evaluación de experiencia previa."
    },
    "section4":{
      "question": "¿Qué garantía ofrecen?",
      "answer": "Ofrecemos garantía de 30 días en todos los trabajos realizados. Si no estás satisfecho, nuestro equipo de soporte te ayudará a resolver cualquier problema."
    },
    "section5":{
      "question": "¿Cómo se realizan los pagos?",
      "answer": "Los pagos son 100% seguros a través de nuestra plataforma. Solo liberas el pago cuando el trabajo esté completado y estés satisfecho con el resultado."
    }
  }
}
</file>

</files>
